//>>built
define("dojox/drawing/Drawing",["dojo","./defaults","./manager/_registry","./manager/keys","./manager/Mouse","./manager/Canvas","./manager/Undo","./manager/Anchors","./manager/Stencil","./manager/StencilUI","./util/common"],function(dojo,defaults,registry,keys,Mouse,Canvas,Undo,Anchors,Stencil,StencilUI,utilCommon){return dojo.declare("dojox.drawing.Drawing",[],{ready:!1,mode:"",width:0,height:0,constructor:function(props,node){var def=dojo.attr(node,"defaults");this.defaults=def?"string"==typeof def?dojo.getObject(def):def:defaults,this.id=node.id||dijit.getUniqueId("dojox_drawing_Drawing"),registry.register(this,"drawing"),this.mode=(props.mode||dojo.attr(node,"mode")||"").toLowerCase();var box=dojo.contentBox(node);this.width=props.width||box.w,this.height=props.height||box.h,utilCommon.register(this),this.mouse=new Mouse({util:utilCommon,keys:keys,id:"ui"==this.mode?"MUI":"mse"}),this.mouse.setEventMode(this.mode),this.tools={},this.stencilTypes={},this.stencilTypeMap={},this.srcRefNode=node,this.domNode=node,props.plugins?this.plugins=eval(props.plugins):this.plugins=[],this.widgetId=this.id,dojo.attr(this.domNode,"widgetId",this.widgetId),dijit&&dijit.registry?dijit.registry.add(this):(dijit.registry={objs:{},add:function(e){this.objs[e.id]=e}},dijit.byId=function(e){return dijit.registry.objs[e]},dijit.registry.add(this));var stencils=registry.getRegistered("stencil");for(var nm in stencils)this.registerTool(stencils[nm].name);var tools=registry.getRegistered("tool");for(nm in tools)this.registerTool(tools[nm].name);var plugs=registry.getRegistered("plugin");for(nm in plugs)this.registerTool(plugs[nm].name);this._createCanvas()},_createCanvas:function(){this.canvas=new Canvas({srcRefNode:this.domNode,util:utilCommon,mouse:this.mouse,width:this.width,height:this.height,callback:dojo.hitch(this,"onSurfaceReady")}),this.initPlugins()},resize:function(e){e&&dojo.style(this.domNode,{width:e.w+"px",height:e.h+"px"}),this.canvas?e&&this.canvas.resize(e.w,e.h):this._createCanvas()},startup:function(){},getShapeProps:function(e,t){var i=e.stencilType,a="ui"==this.mode||"ui"==t;return dojo.mixin({container:a&&!i?this.canvas.overlay.createGroup():this.canvas.surface.createGroup(),util:utilCommon,keys:keys,mouse:this.mouse,drawing:this,drawingType:a&&!i?"ui":"stencil",style:this.defaults.copy()},e||{})},addPlugin:function(e){this.plugins.push(e),this.canvas.surfaceReady&&this.initPlugins()},initPlugins:function(){if(this.canvas&&this.canvas.surfaceReady)dojo.forEach(this.plugins,function(e,t){var i=dojo.mixin({util:utilCommon,keys:keys,mouse:this.mouse,drawing:this,stencils:this.stencils,anchors:this.anchors,canvas:this.canvas},e.options||{});this.registerTool(e.name,dojo.getObject(e.name));try{this.plugins[t]=new this.tools[e.name](i)}catch(a){}},this),this.plugins=[],this.mouse.setCanvas();else var e=dojo.connect(this,"onSurfaceReady",this,function(){dojo.disconnect(e),this.initPlugins()})},onSurfaceReady:function(){if(this.ready=!0,this.mouse.init(this.canvas.domNode),this.undo=new Undo({keys:keys}),this.anchors=new Anchors({drawing:this,mouse:this.mouse,undo:this.undo,util:utilCommon}),"ui"==this.mode?this.uiStencils=new StencilUI({canvas:this.canvas,surface:this.canvas.surface,mouse:this.mouse,keys:keys}):(this.stencils=new Stencil({canvas:this.canvas,surface:this.canvas.surface,mouse:this.mouse,undo:this.undo,keys:keys,anchors:this.anchors}),this.uiStencils=new StencilUI({canvas:this.canvas,surface:this.canvas.surface,mouse:this.mouse,keys:keys})),"silverlight"==dojox.gfx.renderer)try{new dojox.drawing.plugins.drawing.Silverlight({util:utilCommon,mouse:this.mouse,stencils:this.stencils,anchors:this.anchors,canvas:this.canvas})}catch(e){throw new Error("Attempted to install the Silverlight plugin, but it was not found.")}dojo.forEach(this.plugins,function(e){e.onSurfaceReady&&e.onSurfaceReady()})},addUI:function(e,t){if(!this.ready){var i=dojo.connect(this,"onSurfaceReady",this,function(){dojo.disconnect(i),this.addUI(e,t)});return!1}if(!t||t.data||t.points||(t={data:t}),!this.stencilTypes[e])return null;var a=this.uiStencils.register(new this.stencilTypes[e](this.getShapeProps(t,"ui")));return a},addStencil:function(e,t){if(!this.ready){var i=dojo.connect(this,"onSurfaceReady",this,function(){dojo.disconnect(i),this.addStencil(e,t)});return!1}!t||t.data||t.points||(t={data:t});var a=this.stencils.register(new this.stencilTypes[e](this.getShapeProps(t)));return this.currentStencil&&this.currentStencil.moveToFront(),a},removeStencil:function(e){this.stencils.unregister(e),e.destroy()},removeAll:function(){this.stencils.removeAll()},selectAll:function(){this.stencils.selectAll()},toSelected:function(e){this.stencils.toSelected.apply(this.stencils,arguments)},exporter:function(){return this.stencils.exporter()},importer:function(e){dojo.forEach(e,function(e){this.addStencil(e.type,e)},this)},changeDefaults:function(e,t){if(void 0!=t&&t)for(var i in e)this.defaults[i]=e[i];else for(var i in e)for(var a in e[i])this.defaults[i][a]=e[i][a];void 0==this.currentStencil||this.currentStencil.created&&!this.defaults.clickMode||(this.unSetTool(),this.setTool(this.currentType))},onRenderStencil:function(e){this.stencils.register(e),this.unSetTool(),this.defaults.clickMode?this.defaults.clickable=!0:this.setTool(this.currentType)},onDeleteStencil:function(e){this.stencils.unregister(e)},registerTool:function(e){if(!this.tools[e]){var t=dojo.getObject(e);this.tools[e]=t;var i=utilCommon.abbr(e);this.stencilTypes[i]=t,this.stencilTypeMap[i]=e}},getConstructor:function(e){return this.stencilTypes[e]},setTool:function(e){if("ui"!=this.mode)if(this.canvas&&this.canvas.surface){this.currentStencil&&this.unSetTool(),this.currentType=this.tools[e]?e:this.stencilTypeMap[e];try{this.currentStencil=new this.tools[this.currentType]({container:this.canvas.surface.createGroup(),util:utilCommon,mouse:this.mouse,keys:keys}),this.defaults.clickMode&&(this.defaults.clickable=!1),this.currentStencil.connect(this.currentStencil,"onRender",this,"onRenderStencil"),this.currentStencil.connect(this.currentStencil,"destroy",this,"onDeleteStencil")}catch(t){}}else var i=dojo.connect(this,"onSurfaceReady",this,function(){dojo.disconnect(i),this.setTool(e)})},set:function(e,t){},get:function(e){},unSetTool:function(){this.currentStencil.created||this.currentStencil.destroy()}})});//# sourceMappingURL=Drawing.js.map