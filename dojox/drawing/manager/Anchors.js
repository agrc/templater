//>>built
define("dojox/drawing/manager/Anchors",["dojo","../util/oo","../defaults"],function(e,t,a){var i=t.declare(function(t){this.defaults=a.copy(),this.mouse=t.mouse,this.point=t.point,this.pointIdx=t.pointIdx,this.util=t.util,this.id=t.id||this.util.uid("anchor"),this.org=e.mixin({},this.point),this.stencil=t.stencil,this.stencil.anchorPositionCheck&&(this.anchorPositionCheck=e.hitch(this.stencil,this.stencil.anchorPositionCheck)),this.stencil.anchorConstrain&&(this.anchorConstrain=e.hitch(this.stencil,this.stencil.anchorConstrain)),this._zCon=e.connect(this.mouse,"setZoom",this,"render"),this.render(),this.connectMouse()},{y_anchor:null,x_anchor:null,render:function(){this.shape&&this.shape.removeShape();var e=this.defaults.anchors,t=this.mouse.zoom,a=e.width*t,i=e.size*t,r=i/2,o={width:a,style:e.style,color:e.color,cap:e.cap},n={x:this.point.x-r,y:this.point.y-r,width:i,height:i};this.shape=this.stencil.container.createRect(n).setStroke(o).setFill(e.fill),this.shape.setTransform({dx:0,dy:0}),this.util.attr(this,"drawingType","anchor"),this.util.attr(this,"id",this.id)},onRenderStencil:function(e){},onTransformPoint:function(e){},onAnchorDown:function(e){this.selected=e.id==this.id},onAnchorUp:function(e){this.selected=!1,this.stencil.onTransformEnd(this)},onAnchorDrag:function(e){if(this.selected){var t,a,i,r,o=(this.shape.getTransform(),this.shape.getParent().getParent().getTransform()),n=this.defaults.anchors.marginZero,d=o.dx+this.org.x,s=o.dy+this.org.y,l=e.x-d,m=e.y-s,u=this.defaults.anchors.minSize,h=this.anchorPositionCheck(l,m,this);if(h.x<0)for(;this.anchorPositionCheck(l,m,this).x<0;)this.shape.getParent().getParent().applyTransform({dx:2,dy:0});if(h.y<0)for(;this.anchorPositionCheck(l,m,this).y<0;)this.shape.getParent().getParent().applyTransform({dx:0,dy:2});this.y_anchor?this.org.y>this.y_anchor.org.y?(i=this.y_anchor.point.y+u-this.org.y,r=1/0,m<i&&(m=i)):(i=-s+n,r=this.y_anchor.point.y-u-this.org.y,m<i?m=i:m>r&&(m=r)):(i=-s+n,m<i&&(m=i)),this.x_anchor?this.org.x>this.x_anchor.org.x?(t=this.x_anchor.point.x+u-this.org.x,a=1/0,l<t&&(l=t)):(t=-d+n,a=this.x_anchor.point.x-u-this.org.x,l<t?l=t:l>a&&(l=a)):(t=-d+n,l<t&&(l=t));var f=this.anchorConstrain(l,m);null!=f&&(l=f.x,m=f.y),this.shape.setTransform({dx:l,dy:m}),this.linkedAnchor&&this.linkedAnchor.shape.setTransform({dx:l,dy:m}),this.onTransformPoint(this)}},anchorConstrain:function(e,t){return null},anchorPositionCheck:function(e,t,a){return{x:1,y:1}},setPoint:function(e){this.shape.applyTransform(e)},connectMouse:function(){this._mouseHandle=this.mouse.register(this)},disconnectMouse:function(){this.mouse.unregister(this._mouseHandle)},reset:function(e){},destroy:function(){e.disconnect(this._zCon),this.disconnectMouse(),this.shape.removeShape()}});return t.declare(function(e){this.mouse=e.mouse,this.undo=e.undo,this.util=e.util,this.drawing=e.drawing,this.items={}},{onAddAnchor:function(e){},onReset:function(e){var t=this.util.byId("drawing").stencils;t.onDeselect(e),t.onSelect(e)},onRenderStencil:function(){for(var t in this.items)e.forEach(this.items[t].anchors,function(e){e.shape.moveToFront()})},onTransformPoint:function(t){var a=this.items[t.stencil.id].anchors,i=this.items[t.stencil.id].item,r=[];e.forEach(a,function(e,a){t.id==e.id||"group"!=t.stencil.anchorType||(t.org.y==e.org.y?e.setPoint({dx:0,dy:t.shape.getTransform().dy-e.shape.getTransform().dy}):t.org.x==e.org.x&&e.setPoint({dx:t.shape.getTransform().dx-e.shape.getTransform().dx,dy:0}),e.shape.moveToFront());var i=e.shape.getTransform();r.push({x:i.dx+e.org.x,y:i.dy+e.org.y}),e.point.t&&(r[r.length-1].t=e.point.t)},this),i.setPoints(r),i.onTransform(t),this.onRenderStencil()},onAnchorUp:function(e){},onAnchorDown:function(e){},onAnchorDrag:function(e){},onChangeStyle:function(t){for(var a in this.items)e.forEach(this.items[a].anchors,function(e){e.shape.moveToFront()})},add:function(t){if(this.items[t.id]={item:t,anchors:[]},"none"!=t.anchorType){var a=t.points;if(e.forEach(a,function(a,r){if(!a.noAnchor){0==r||t.points.length;var o=new i({stencil:t,point:a,pointIdx:r,mouse:this.mouse,util:this.util});this.items[t.id]._cons=[e.connect(o,"onRenderStencil",this,"onRenderStencil"),e.connect(o,"reset",this,"onReset"),e.connect(o,"onAnchorUp",this,"onAnchorUp"),e.connect(o,"onAnchorDown",this,"onAnchorDown"),e.connect(o,"onAnchorDrag",this,"onAnchorDrag"),e.connect(o,"onTransformPoint",this,"onTransformPoint"),e.connect(t,"onChangeStyle",this,"onChangeStyle")],this.items[t.id].anchors.push(o),this.onAddAnchor(o)}},this),"path"==t.shortType){var r=a[0],o=a[a.length-1],n=this.items[t.id].anchors;r.x==o.x&&r.y==o.y&&(n[0].linkedAnchor=n[n.length-1],n[n.length-1].linkedAnchor=n[0])}"group"==t.anchorType&&e.forEach(this.items[t.id].anchors,function(a){e.forEach(this.items[t.id].anchors,function(e){a.id!=e.id&&(a.org.y==e.org.y?a.x_anchor=e:a.org.x==e.org.x&&(a.y_anchor=e))},this)},this)}},remove:function(t){this.items[t.id]&&(e.forEach(this.items[t.id].anchors,function(e){e.destroy()}),e.forEach(this.items[t.id]._cons,e.disconnect,e),this.items[t.id].anchors=null,delete this.items[t.id])}})});//# sourceMappingURL=Anchors.js.map