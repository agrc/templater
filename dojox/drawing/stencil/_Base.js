//>>built
define("dojox/drawing/stencil/_Base",["dojo","dojo/fx/easing","../util/oo","../annotations/BoxShadow","../annotations/Angle","../annotations/Label","../defaults"],function(e,t,i,a,r,o,n){var s=i.declare(function(t){e.mixin(this,t),this.style=t.style||n.copy(),t.stencil&&(this.stencil=t.stencil,this.util=t.stencil.util,this.mouse=t.stencil.mouse,this.container=t.stencil.container,this.style=t.stencil.style);var i=/Line|Vector|Axes|Arrow/,a=/Text/;if(this.shortType=this.util.abbr(this.type),this.isText=a.test(this.type),this.isLine=i.test(this.type),this.renderHit=this.style.renderHitLayer,!this.renderHit&&this.style.renderHitLines&&this.isLine&&(this.renderHit=!0),!this.renderHit&&this.style.useSelectedStyle){this.useSelectedStyle=!0,this.selCopy=e.clone(this.style.selected);for(var o in this.style.norm)void 0===this.style.selected[o]&&(this.style.selected[o]=this.style.norm[o]);this.textSelected=e.clone(this.style.text),this.textSelected.color=this.style.selected.fill}if(this.angleSnap=this.style.angleSnap||1,this.marginZero=t.marginZero||this.style.anchors.marginZero,this.id=t.id||this.util.uid(this.type),this._cons=[],this.annotation||this.subShape||this.util.attr(this.container,"id",this.id),this.connect(this,"onBeforeRender","preventNegativePos"),this._offX=this.mouse.origin.x,this._offY=this.mouse.origin.y,this.isText){if(this.align=t.align||this.align,this.valign=t.valign||this.valign,t.data&&t.data.makeFit){var s=this.makeFit(t.data.text,t.data.width);this.textSize=this.style.text.size=s.size,this._lineHeight=s.box.h}else this.textSize=parseInt(this.style.text.size,10),this._lineHeight=1.4*this.textSize;this.deleteEmptyCreate=void 0!==t.deleteEmptyCreate?t.deleteEmptyCreate:this.style.text.deleteEmptyCreate,this.deleteEmptyModify=void 0!==t.deleteEmptyModify?t.deleteEmptyModify:this.style.text.deleteEmptyModify}this.attr(t.data),this.noBaseRender||(t.points?(t.data&&t.data.closePath===!1&&(this.closePath=!1),this.setPoints(t.points),this.connect(this,"render",this,"onRender",!0),this.baseRender&&this.enabled&&this.render(),t.label&&this.setLabel(t.label),t.shadow&&this.addShadow(t.shadow)):t.data?(t.data.width=t.data.width?t.data.width:this.style.text.minWidth,t.data.height=t.data.height?t.data.height:this._lineHeight,this.setData(t.data),this.connect(this,"render",this,"onRender",!0),this.baseRender&&this.enabled&&this.render(t.data.text),this.baseRender&&t.label&&this.setLabel(t.label),this.baseRender&&t.shadow&&this.addShadow(t.shadow)):this.draws&&(this.points=[],this.data={},this.connectMouse(),this._postRenderCon=e.connect(this,"render",this,"_onPostRender")),this.showAngle&&(this.angleLabel=new r({stencil:this})),this.enabled||(this.disable(),this.moveToBack(),this.render(t.data.text)))},{type:"dojox.drawing.stencil",minimumSize:10,enabled:!0,drawingType:"stencil",setData:function(e){this.data=e,this.points=this.dataToPoints()},setPoints:function(e){this.points=e,this.pointsToData&&(this.data=this.pointsToData())},onDelete:function(e){},onBeforeRender:function(e){},onModify:function(e){},onChangeData:function(e){},onChangeText:function(e){},onRender:function(t){this._postRenderCon=e.connect(this,"render",this,"_onPostRender"),this.created=!0,this.disconnectMouse(),this.shape?this.shape.superClass=this:this.container.superClass=this,this._setNodeAtts(this)},onChangeStyle:function(e){this._isBeingModified=!0,this.enabled?(this.style.current=this.style.norm,this.style.currentHit=this.style.hitNorm,this.style.currentText=this.style.text):(this.style.current=this.style.disabled,this.style.currentText=this.style.textDisabled,this.style.currentHit=this.style.hitNorm),this.selected?(this.useSelectedStyle&&(this.style.current=this.style.selected,this.style.currentText=this.textSelected),this.style.currentHit=this.style.hitSelected):this.highlighted&&(this.style.currentHit=this.style.hitHighlighted),this.render()},animate:function(i,a){var r,o,n=i.d||i.duration||1e3,s=i.ms||20,d=i.ease||t.linear,l=(i.steps,(new Date).getTime()),h=0,u=!0;e.isArray(i.start)?(r=i.start,o=i.end):e.isObject(i.start)&&(r=i.start,o=i.end,u=!1);var m=setInterval(e.hitch(this,function(){var t=(new Date).getTime()-l,i=d(1-t/n);if(t>n||h++>100)return void clearInterval(m);if(u){var a=[];e.forEach(r,function(e,t){var n={x:(o[t].x-r[t].x)*i+r[t].x,y:(o[t].y-r[t].y)*i+r[t].y};a.push(n)}),this.setPoints(a),this.render()}else{var s={};for(var c in r)s[c]=(o[c]-r[c])*i+r[c];this.attr(s)}}),s)},attr:function(t,i){var a,r,o,n=this.enabled?this.style.norm:this.style.disabled,s=this.enabled?this.style.text:this.style.textDisabled,d=this.textSelected||{},l=e.toJson(n),h=e.toJson(s),u={x:!0,y:!0,r:!0,height:!0,width:!0,radius:!0,angle:!0},m=!1;"object"!=typeof t?(a={},a[t]=i):a=e.clone(t),a.width&&(o=a.width,delete a.width);for(r in a)r in n&&(n[r]=a[r]),r in s&&(s[r]=a[r]),r in d&&(d[r]=a[r]),r in u&&(u[r]=a[r],m=!0,"radius"==r&&void 0===a.angle?a.angle=u.angle=this.getAngle():"angle"==r&&void 0===a.radius&&(a.radius=u.radius=this.getRadius())),"text"==r&&this.setText(a.text),"label"==r&&this.setLabel(a.label);if(void 0!==a.borderWidth&&(n.width=a.borderWidth),this.useSelectedStyle){for(r in this.style.norm)void 0===this.selCopy[r]&&(this.style.selected[r]=this.style.norm[r]);this.textSelected.color=this.style.selected.color}if(this.created){if(void 0!==a.x||void 0!==a.y){var c=this.getBounds(!0),f={dx:0,dy:0};for(r in a)"x"!=r&&"y"!=r&&"r"!=r||(f["d"+r]=a[r]-c[r]);this.transformPoints(f)}var y=this.points;void 0!==a.angle?this.dataToPoints({x:this.data.x1,y:this.data.y1,angle:a.angle,radius:a.radius}):void 0!==o&&(y[1].x=y[2].x=y[0].x+o,this.pointsToData(y)),void 0!==a.height&&void 0===a.angle&&(y[2].y=y[3].y=y[0].y+a.height,this.pointsToData(y)),void 0!==a.r&&(this.data.r=Math.max(0,a.r)),(m||h!=e.toJson(s)||l!=e.toJson(n))&&this.onChangeStyle(this),a.width=o,void 0!=a.cosphi&&(this.data?this.data.cosphi=a.cosphi:this.data={cosphi:a.cosphi},this.style.zAxis=0!=a.cosphi)}},exporter:function(){var t=this.type.substring(this.type.lastIndexOf(".")+1).charAt(0).toLowerCase()+this.type.substring(this.type.lastIndexOf(".")+2),i=e.clone(this.style.norm);i.borderWidth=i.width,delete i.width,"path"==t?i.points=this.points:i=e.mixin(i,this.data),i.type=t,this.isText&&(i.text=this.getText(),i=e.mixin(i,this.style.text),delete i.minWidth,delete i.deleteEmptyCreate,delete i.deleteEmptyModify);var a=this.getLabel();return a&&(i.label=a),i},disable:function(){this.enabled=!1,this.renderHit=!1,this.onChangeStyle(this)},enable:function(){this.enabled=!0,this.renderHit=!0,this.onChangeStyle(this)},select:function(){this.selected=!0,this.onChangeStyle(this)},deselect:function(t){t?setTimeout(e.hitch(this,function(){this.selected=!1,this.onChangeStyle(this)}),200):(this.selected=!1,this.onChangeStyle(this))},_toggleSelected:function(){this.selected&&(this.deselect(),setTimeout(e.hitch(this,"select"),0))},highlight:function(){this.highlighted=!0,this.onChangeStyle(this)},unhighlight:function(){this.highlighted=!1,this.onChangeStyle(this)},moveToFront:function(){this.container&&this.container.moveToFront()},moveToBack:function(){this.container&&this.container.moveToBack()},onTransformBegin:function(e){this._isBeingModified=!0},onTransformEnd:function(e){this._isBeingModified=!1,this.onModify(this)},onTransform:function(e){this._isBeingModified||this.onTransformBegin(),this.setPoints(this.points),this.render()},transformPoints:function(t){if(t.dx||t.dy){var i=e.clone(this.points),a=!1;if(e.forEach(this.points,function(e){e.x+=t.dx,e.y+=t.dy,(e.x<this.marginZero||e.y<this.marginZero)&&(a=!0)}),a)return void(this.points=i);this.onTransform(),this.onTransformEnd()}},applyTransform:function(e){this.transformPoints(e)},setTransform:function(e){this.attr({x:e.dx,y:e.dy})},getTransform:function(){return this.selected?this.container.getParent().getTransform():{dx:0,dy:0}},addShadow:function(e){e=e===!0?{}:e,e.stencil=this,this.shadow=new a(e)},removeShadow:function(){this.shadow.destroy()},setLabel:function(e){this._label?void 0!=e&&this._label.setLabel(e):this._label=new o.Label({text:e,util:this.util,mouse:this.mouse,stencil:this,annotation:!0,container:this.container,labelPosition:this.labelPosition})},getLabel:function(){return this._label?this._label.getText():null},getAngle:function(){var e=this.pointsToData(),t={start:{x:e.x1,y:e.y1},x:e.x2,y:e.y2},i=this.util.angle(t,this.angleSnap);return 0>i?i=360+i:i,i},getRadius:function(){var e=this.getBounds(!0),t={start:{x:e.x1,y:e.y1},x:e.x2,y:e.y2};return this.util.length(t)},getBounds:function(e){var t,i,a,r,o=this.points;return 2==o.length?(e?(t=o[0].x,i=o[0].y,a=o[1].x,r=o[1].y):(t=o[0].x<o[1].x?o[0].x:o[1].x,i=o[0].y<o[1].y?o[0].y:o[1].y,a=o[0].x<o[1].x?o[1].x:o[0].x,r=o[0].y<o[1].y?o[1].y:o[0].y),{x1:t,y1:i,x2:a,y2:r,x:t,y:i,w:a-t,h:r-i}):{x1:o[0].x,y1:o[0].y,x2:o[2].x,y2:o[2].y,x:o[0].x,y:o[0].y,w:o[2].x-o[0].x,h:o[2].y-o[0].y}},preventNegativePos:function(){if(!this._isBeingModified&&this.points&&this.points.length){if("dojox.drawing.tools.custom.Axes"==this.type){var t=this.marginZero,i=this.marginZero;e.forEach(this.points,function(e){t=Math.min(e.y,t)}),e.forEach(this.points,function(e){i=Math.min(e.x,i)}),t<this.marginZero&&e.forEach(this.points,function(e,i){e.y=e.y+(this.marginZero-t)},this),i<this.marginZero&&e.forEach(this.points,function(e){e.x+=this.marginZero-i},this)}else e.forEach(this.points,function(e){e.x=e.x<0?this.marginZero:e.x,e.y=e.y<0?this.marginZero:e.y});this.setPoints(this.points)}},_onPostRender:function(t){this._isBeingModified?(this.onModify(this),this._isBeingModified=!1):!this.created,this.editMode||this.selected||!this._prevData||e.toJson(this._prevData)==e.toJson(this.data)?this._prevData||this.isText&&!this.getText()||(this._prevData=e.clone(this.data)):(this.onChangeData(this),this._prevData=e.clone(this.data))},_setNodeAtts:function(e){var t=!this.enabled||this.annotation&&"label"!=this.drawingType?"":this.drawingType;this.util.attr(e,"drawingType",t)},destroy:function(){this.destroyed||((this.data||this.points&&this.points.length)&&this.onDelete(this),this.disconnectMouse(),this.disconnect(this._cons),e.disconnect(this._postRenderCon),this.remove(this.shape,this.hit),this.destroyed=!0)},remove:function(){var e=arguments;if(!e.length){if(!this.shape)return;e=[this.shape]}for(var t=0;t<e.length;t++)e[t]&&e[t].removeShape()},connectMult:function(){arguments.length>1?this._cons.push(this.connect.apply(this,arguments)):e.isArray(arguments[0][0])?e.forEach(arguments[0],function(e){this._cons.push(this.connect.apply(this,e))},this):this._cons.push(this.connect.apply(this,arguments[0]))},connect:function(t,i,a,r,o){var n;if("object"!=typeof t)a?(r=a,a=i,i=t,t=this):(r=i,i=t,t=a=this);else if(r){if(o)return n=e.connect(t,i,function(t){e.hitch(a,r)(t),e.disconnect(n)}),this._cons.push(n),n}else r=a,a=this;return n=e.connect(t,i,a,r),this._cons.push(n),n},disconnect:function(t){t&&(e.isArray(t)||(t=[t]),e.forEach(t,e.disconnect,e))},connectMouse:function(){this._mouseHandle=this.mouse.register(this)},disconnectMouse:function(){this.mouse.unregister(this._mouseHandle)},render:function(){},dataToPoints:function(e){},pointsToData:function(e){},onDown:function(t){this._downOnCanvas=!0,e.disconnect(this._postRenderCon),this._postRenderCon=null},onMove:function(e){},onDrag:function(e){},onUp:function(e){}});return e.setObject("dojox.drawing.stencil._Base",s),s});//# sourceMappingURL=_Base.js.map