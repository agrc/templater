//>>built
define("dojox/drawing/tools/TextBlock",["dojo","dijit/registry","../util/oo","../manager/_registry","../stencil/Text"],function(e,t,a,i,r){var o;e.addOnLoad(function(){(o=e.byId("conEdit"))&&o.parentNode.removeChild(o)});var n=a.declare(r,function(t){if(t.data){var a=t.data,i=a.text?this.typesetter(a.text):a.text,r=a.width?"auto"==a.width?"auto":Math.max(a.width,this.style.text.minWidth):this.style.text.minWidth,o=this._lineHeight;if(i&&"auto"==r){var n=this.measureText(this.cleanText(i,!1),r);r=n.w,o=n.h}else this._text="";this.points=[{x:a.x,y:a.y},{x:a.x+r,y:a.y},{x:a.x+r,y:a.y+o},{x:a.x,y:a.y+o}],a.showEmpty||i?(this.editMode=!0,e.disconnect(this._postRenderCon),this._postRenderCon=null,this.connect(this,"render",this,"onRender",!0),a.showEmpty?(this._text=i||"",this.edit()):i&&a.editMode?(this._text="",this.edit()):i&&this.render(i),setTimeout(e.hitch(this,function(){this.editMode=!1}),100)):this.render()}else this.connectMouse(),this._postRenderCon=e.connect(this,"render",this,"_onPostRender")},{draws:!0,baseRender:!1,type:"dojox.drawing.tools.TextBlock",_caretStart:0,_caretEnd:0,_blockExec:!1,selectOnExec:!0,showEmpty:!1,onDrag:function(t){this.parentNode||this.showParent(t);var a=this._startdrag,i=t.page;this._box.left=a.x<i.x?a.x:i.x,this._box.top=a.y,this._box.width=(a.x<i.x?i.x-a.x:a.x-i.x)+this.style.text.pad,e.style(this.parentNode,this._box.toPx())},onUp:function(t){if(this._downOnCanvas){this._downOnCanvas=!1;var a=e.connect(this,"render",this,function(){e.disconnect(a),this.onRender(this)});this.editMode=!0,this.showParent(t),this.created=!0,this.createTextField(),this.connectTextField()}},showParent:function(t){if(!this.parentNode){var a=t.pageX||10,i=t.pageY||10;this.parentNode=e.doc.createElement("div"),this.parentNode.id=this.id;var r=this.style.textMode.create;this._box={left:a,top:i,width:t.width||1,height:t.height&&t.height>8?t.height:this._lineHeight,border:r.width+"px "+r.style+" "+r.color,position:"absolute",zIndex:500,toPx:function(){var e={};for(var t in this)e[t]="number"==typeof this[t]&&"zIndex"!=t?this[t]+"px":this[t];return e}},e.style(this.parentNode,this._box),document.body.appendChild(this.parentNode)}},createTextField:function(t){var a=this.style.textMode.edit;return this._box.border=a.width+"px "+a.style+" "+a.color,this._box.height="auto",this._box.width=Math.max(this._box.width,this.style.text.minWidth*this.mouse.zoom),e.style(this.parentNode,this._box.toPx()),this.parentNode.appendChild(o),e.style(o,{height:t?"auto":this._lineHeight+"px",fontSize:this.textSize/this.mouse.zoom+"px",fontFamily:this.style.text.family}),o.innerHTML=t||"",o},connectTextField:function(){if(!this._textConnected){var a=t.byId("greekPalette"),i=void 0!=a;i&&e.mixin(a,{_pushChangeTo:o,_textBlock:this}),this._textConnected=!0,this._dropMode=!1,this.mouse.setEventMode("TEXT"),this.keys.editMode(!0);var r,n,d,l,s=this,m=!1,u=function(){s._dropMode||(e.forEach([r,n,d,l],function(t){e.disconnect(t)}),s._textConnected=!1,s.keys.editMode(!1),s.mouse.setEventMode(),s.execText())};r=e.connect(o,"keyup",this,function(t){e.trim(o.innerHTML)&&!m?(e.style(o,"height","auto"),m=!0):e.trim(o.innerHTML).length<2&&m&&(e.style(o,"height",this._lineHeight+"px"),m=!1),this._blockExec?t.keyCode==e.keys.SPACE&&(e.stopEvent(t),i&&a.onCancel()):13!=t.keyCode&&27!=t.keyCode||(e.stopEvent(t),u())}),n=e.connect(o,"keydown",this,function(t){if(13!=t.keyCode&&27!=t.keyCode||e.stopEvent(t),220==t.keyCode){if(!i)return;e.stopEvent(t),this.getSelection(o),this.insertText(o,"\\"),this._dropMode=!0,this._blockExec=!0,a.show({around:this.parentNode,orient:{BL:"TL"}})}if(this._dropMode)switch(t.keyCode){case e.keys.UP_ARROW:case e.keys.DOWN_ARROW:case e.keys.LEFT_ARROW:case e.keys.RIGHT_ARROW:e.stopEvent(t),a._navigateByArrow(t);break;case e.keys.ENTER:e.stopEvent(t),a._onCellClick(t);break;case e.keys.BACKSPACE:case e.keys.DELETE:e.stopEvent(t),a.onCancel()}else this._blockExec=!1}),d=e.connect(document,"mouseup",this,function(t){this._onAnchor||"conEdit"==t.target.id?"conEdit"==t.target.id&&""==o.innerHTML&&(o.blur(),setTimeout(function(){o.focus()},200)):(e.stopEvent(t),u())}),this.createAnchors(),l=e.connect(this.mouse,"setZoom",this,function(e){u()}),o.focus(),this.onDown=function(){},this.onDrag=function(){},setTimeout(e.hitch(this,function(){o.focus(),this.onUp=function(){!s._onAnchor&&this.parentNode&&(s.disconnectMouse(),u(),s.onUp=function(){})}}),500)}},execText:function(){var t=e.marginBox(this.parentNode),a=Math.max(t.w,this.style.text.minWidth),i=this.cleanText(o.innerHTML,!0);o.innerHTML="",o.blur(),this.destroyAnchors(),i=this.typesetter(i);var r=this.measureText(i,a),n=this.mouse.scrollOffset(),d=this.mouse.origin,l=this._box.left+n.left-d.x,s=this._box.top+n.top-d.y;l*=this.mouse.zoom,s*=this.mouse.zoom,a*=this.mouse.zoom,r.h*=this.mouse.zoom,this.points=[{x:l,y:s},{x:l+a,y:s},{x:l+a,y:s+r.h},{x:l,y:s+r.h}],this.editMode=!1,r.text||(this._text="",this._textArray=[]),this.render(r.text),this.onChangeText(this.getText())},edit:function(){this.editMode=!0;var e=this.getText()||"";if(!this.parentNode&&this.points){var t=this.pointsToData(),a=this.mouse.scrollOffset(),i=this.mouse.origin,r={pageX:t.x/this.mouse.zoom-a.left+i.x,pageY:t.y/this.mouse.zoom-a.top+i.y,width:t.width/this.mouse.zoom,height:t.height/this.mouse.zoom};this.remove(this.shape,this.hit),this.showParent(r),this.createTextField(e.replace("/n"," ")),this.connectTextField(),e&&this.setSelection(o,"end")}},cleanText:function(t,a){var i=function(e){var t={"&lt;":"<","&gt;":">","&amp;":"&"};for(var a in t)e=e.replace(new RegExp(a,"gi"),t[a]);return e};return a&&e.forEach(["<br>","<br/>","<br />","\\n","\\r"],function(e){t=t.replace(new RegExp(e,"gi")," ")}),t=t.replace(/&nbsp;/g," "),t=i(t),t=e.trim(t),t=t.replace(/\s{2,}/g," ")},measureText:function(t,a){var i="(<br\\s*/*>)|(\\n)|(\\r)";this.showParent({width:a||"auto",height:"auto"}),this.createTextField(t);var r="",n=o;n.innerHTML="X";var d=e.marginBox(n).h;if(n.innerHTML=t,!a||new RegExp(i,"gi").test(t))r=t.replace(new RegExp(i,"gi"),"\n"),n.innerHTML=t.replace(new RegExp(i,"gi"),"<br/>");else if(e.marginBox(n).h==d)r=t;else{var l=t.split(" "),s=[[]],m=0;for(n.innerHTML="";l.length;){var u=l.shift();n.innerHTML+=u+" ",e.marginBox(n).h>d&&(m++,s[m]=[],n.innerHTML=u+" "),s[m].push(u)}e.forEach(s,function(e,t){s[t]=e.join(" ")}),r=s.join("\n"),n.innerHTML=r.replace("\n","<br/>")}var h=e.marginBox(n);return o.parentNode.removeChild(o),e.destroy(this.parentNode),this.parentNode=null,{h:h.h,w:h.w,text:r}},_downOnCanvas:!1,onDown:function(t){this._startdrag={x:t.pageX,y:t.pageY},e.disconnect(this._postRenderCon),this._postRenderCon=null,this._downOnCanvas=!0},createAnchors:function(){this._anchors={};var t=this,a=this.style.anchors,i=a.width,r=a.size-2*i,n=a.size-2*i,d=a.size/2*-1+"px",l={position:"absolute",width:r+"px",height:n+"px",backgroundColor:a.fill,border:i+"px "+a.style+" "+a.color};e.isIE&&(l.paddingLeft=r+"px",l.fontSize=r+"px");for(var s=[{top:d,left:d},{top:d,right:d},{bottom:d,right:d},{bottom:d,left:d}],m=0;m<4;m++){var u=0==m||3==m,h=this.util.uid(u?"left_anchor":"right_anchor"),f=e.create("div",{id:h},this.parentNode);e.style(f,e.mixin(e.clone(l),s[m]));var c,y,v,c=e.connect(f,"mousedown",this,function(a){u=a.target.id.indexOf("left")>-1,t._onAnchor=!0;var i=a.pageX,r=this._box.width;e.stopEvent(a),y=e.connect(document,"mousemove",this,function(t){var a=t.pageX;u?(this._box.left=a,this._box.width=r+i-a):this._box.width=a+r-i,e.style(this.parentNode,this._box.toPx())}),v=e.connect(document,"mouseup",this,function(a){i=this._box.left,r=this._box.width,e.disconnect(y),e.disconnect(v),t._onAnchor=!1,o.focus(),e.stopEvent(a)})});this._anchors[h]={a:f,cons:[c]}}},destroyAnchors:function(){for(var t in this._anchors)e.forEach(this._anchors[t].con,e.disconnect,e),e.destroy(this._anchors[t].a)},setSavedCaret:function(e){this._caretStart=this._caretEnd=e},getSavedCaret:function(){return{start:this._caretStart,end:this._caretEnd}},insertText:function(e,t){var a,i=e.innerHTML,r=this.getSavedCaret();i=i.replace(/&nbsp;/g," "),a=i.substr(0,r.start)+t+i.substr(r.end),a=this.cleanText(a,!0),this.setSavedCaret(Math.min(a.length,r.end+t.length)),e.innerHTML=a,this.setSelection(e,"stored")},getSelection:function(t){if(e.doc.selection){var a=e.doc.selection.createRange(),i=e.body().createTextRange();i.moveToElementText(t);var r=i.duplicate();i.moveToBookmark(a.getBookmark()),r.setEndPoint("EndToStart",i),this._caretStart=r.text.length,this._caretEnd=r.text.length+a.text.length}else this._caretStart=e.global.getSelection().getRangeAt(t).startOffset,this._caretEnd=e.global.getSelection().getRangeAt(t).endOffset},setSelection:function(t,a){if(e.doc.selection){var i=e.body().createTextRange();switch(i.moveToElementText(t),a){case"end":i.collapse(!1);break;case"beg":i.collapse();break;case"all":i.collapse(),i.moveStart("character",0),i.moveEnd("character",t.text.length);break;case"stored":i.collapse();var r=this._caretStart-this._caretEnd;i.moveStart("character",this._caretStart),i.moveEnd("character",r)}i.select()}else{var o=function(e,t){t=t||[];for(var a=0;a<e.childNodes.length;a++){var i=e.childNodes[a];3==i.nodeType?t.push(i):i.tagName&&"img"==i.tagName.toLowerCase()&&t.push(i),i.childNodes&&i.childNodes.length&&o(i,t)}return t};t.focus();var n=e.global.getSelection();n.removeAllRanges();var d=e.doc.createRange(),l=o(t);switch(a){case"end":d.setStart(l[l.length-1],l[l.length-1].textContent.length),d.setEnd(l[l.length-1],l[l.length-1].textContent.length);break;case"beg":d.setStart(l[0],0),d.setEnd(l[0],0);break;case"all":d.setStart(l[0],0),d.setEnd(l[l.length-1],l[l.length-1].textContent.length);break;case"stored":d.setStart(l[0],this._caretStart),d.setEnd(l[0],this._caretEnd)}n.addRange(d)}}});return e.setObject("dojox.drawing.tools.TextBlock",n),n.setup={name:"dojox.drawing.tools.TextBlock",tooltip:"Text Tool",iconClass:"iconText"},i.register(n.setup,"tool"),n});//# sourceMappingURL=TextBlock.js.map