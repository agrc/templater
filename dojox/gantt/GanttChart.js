//>>built
define("dojox/gantt/GanttChart",["./GanttProjectItem","./GanttResourceItem","./GanttProjectControl","./GanttTaskControl","./GanttTaskItem","./TabMenu","dijit/Tooltip","dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/date/locale","dojo/request","dojo/request/util","dojo/on","dojo/dom","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/dom-attr","dojo/dom-geometry","dojo/keys","dojo/has","dojo/_base/window","dojo/json","dojo/domReady!"],function(e,t,i,a,n,r,o,s,l,d,h,u,c,m,f,p,g,y,v,b,k,M,x,w){return s("dojox.gantt.GanttChart",[],{constructor:function(e,t){this.resourceChartHeight=void 0!==e.resourceChartHeight?e.resourceChartHeight:!1,this.withResource=void 0!==e.withResource?e.withResource:!0,this.correctError=void 0!==e.autoCorrectError?e.autoCorrectError:!1,this.isShowConMenu=this.isContentEditable=!e.readOnly,this.withTaskId=void 0!==e.withTaskId?e.withTaskId:!e.readOnly,this.animation=void 0!==e.animation?e.animation:!0,this.saveProgramPath=e.saveProgramPath||"saveGanttData.php",this.dataFilePath=e.dataFilePath||"gantt_default.json",this.contentHeight=e.height||400,this.contentWidth=e.width||600,this.content=f.byId(t),this.scrollBarWidth=18,this.panelTimeHeight=102,this.maxWidthPanelNames=150,this.maxWidthTaskNames=150,this.minWorkLength=8,this.heightTaskItem=12,this.heightTaskItemExtra=11,this.pixelsPerDay=24,this.hsPerDay=8,this.pixelsPerWorkHour=this.pixelsPerDay/this.hsPerDay,this.pixelsPerHour=this.pixelsPerDay/24,this.countDays=0,this.totalDays=0,this.startDate=null,this.initialPos=0,this.contentDataHeight=0,this.panelTimeExpandDelta=20,this.divTimeInfo=null,this.panelNames=null,this.panelTime=null,this.contentData=null,this.tabMenu=null,this.project=[],this.arrProjects=[],this.xmlLoader=null,this.isMoving=!1,this.isResizing=!1,this.animationNodes=[],this.scale=1,this.tempDayInPixels=0,this.resource=null,this.months=h.getNames("months","wide"),this._events=[]},getProject:function(e){return l.filter(this.arrProjects,function(t){return t.project.id==e},this)[0]},checkPosPreviousTask:function(e,t){var i=this.getWidthOnDuration(e.duration),a=this.getPosOnDate(e.startTime),n=this.getPosOnDate(t.startTime);return n>=i+a},correctPosPreviousTask:function(e,t,i){var a=new Date(e.startTime);if(a.setHours(a.getHours()+e.duration/this.hsPerDay*24),a.getHours()>0&&(a.setHours(0),a.setDate(a.getDate()+1)),i?i.setStartTime(a,!0):t.startTime=a,t.parentTask&&!this.checkPosParentTask(t.parentTask,t)){var n=new Date(t.parentTask.startTime);n.setHours(n.getHours()+t.parentTask.duration/this.hsPerDay*24),t.duration=parseInt(parseInt((n-t.startTime)/36e5)*this.hsPerDay/24)}},correctPosParentTask:function(e,t){t.previousTask?this.correctPosPreviousTask(t.previousTask,t):(e.startTime>t.startTime&&(t.startTime=new Date(e.startTime)),this.checkPosParentTask(e,t)||(t.duration=e.duration))},checkPosParentTaskInTree:function(e){for(var t=!1,i=0;i<e.cldTasks.length;i++){var a=e.cldTasks[i];if(!this.checkPosParentTask(e,a)){if(!this.correctError)return!0;this.correctPosParentTask(e,a)}if(e.startTime>a.startTime){if(!this.correctError)return!0;this.correctPosParentTask(e,a)}a.cldTasks.length>0&&(t=this.checkPosParentTaskInTree(a))}return t},setPreviousTask:function(e){for(var t=!1,i=0;i<e.parentTasks.length;i++){var a=e.parentTasks[i];if(a.previousTaskId){if(a.previousTask=e.getTaskById(a.previousTaskId),!a.previousTask&&!this.correctError)return!0;a.previousTask.cldPreTasks.push(a)}if(a.previousTask&&!this.checkPosPreviousTask(a.previousTask,a)){if(!this.correctError)return!0;this.correctPosPreviousTask(a.previousTask,a)}t=this.setPreviousTaskInTree(a)}return t},setPreviousTaskInTree:function(e){for(var t=!1,i=0;i<e.cldTasks.length;i++){var a=e.cldTasks[i];if(a.previousTaskId){if(a.previousTask=e.project.getTaskById(a.previousTaskId),!a.previousTask&&!this.correctError)return!0;if(!this.checkPosPreviousTask(a.previousTask,a)){if(!this.correctError)return!0;this.correctPosPreviousTask(a.previousTask,a)}a.previousTask.cldPreTasks.push(a)}a.cldTasks.length>0&&(t=this.setPreviousTaskInTree(a))}return t},checkPosParentTask:function(e,t){var i=this.getWidthOnDuration(e.duration),a=this.getPosOnDate(e.startTime),n=this.getPosOnDate(t.startTime),r=this.getWidthOnDuration(t.duration);return i+a>=n+r},addProject:function(e){this.project.push(e)},deleteProject:function(t){var a=this.getProject(t);if(a){if(a.arrTasks.length>0)for(;a.arrTasks.length>0;)a.deleteChildTask(a.arrTasks[0]);var n=this.heightTaskItemExtra+this.heightTaskItem;if(a.nextProject&&a.shiftNextProject(a,-n),this.project=l.filter(this.project,function(e){return e.id!=a.project.id},this),a.previousProject&&a.nextProject){var r=a.previousProject;r.nextProject=a.nextProject}if(a.previousProject&&!a.nextProject){var r=a.previousProject;r.nextProject=null}if(!a.previousProject&&a.nextProject){var o=a.nextProject;o.previousProject=null}for(var s=0;s<this.arrProjects.length;s++)this.arrProjects[s].project.id==t&&this.arrProjects.splice(s,1);if(a.projectItem[0].parentNode.removeChild(a.projectItem[0]),a.descrProject.parentNode.removeChild(a.descrProject),a.projectNameItem.parentNode.removeChild(a.projectNameItem),this.contentDataHeight-=this.heightTaskItemExtra+this.heightTaskItem,0==this.project.length){var d=new Date(this.startDate),h=new Date(d.setDate(d.getDate()+1)),u=new e({id:1,name:"New Project",startDate:h});this.project.push(u);var a=new i(this,u);a.create(),this.arrProjects.push(a),this.contentDataHeight+=this.heightTaskItemExtra+this.heightTaskItem}this.checkPosition()}},insertProject:function(t,a,n){if(this.startDate>=n)return!1;if(this.getProject(t))return!1;this.checkHeighPanelTasks();var r=new e({id:t,name:a,startDate:n});this.project.push(r);for(var o=new i(this,r),s=0;s<this.arrProjects.length;s++){var l=this.arrProjects[s],d=this.arrProjects[s-1],h=this.arrProjects[s+1];if(n<l.project.startDate){if(this.arrProjects.splice(s,0,o),s>0&&(o.previousProject=d,d.nextProject=o),s+1<=this.arrProjects.length){o.nextProject=h,h.previousProject=o;var u=this.heightTaskItem+this.heightTaskItemExtra;o.shiftNextProject(o,u)}return o.create(),o.hideDescrProject(),this.checkPosition(),o}}return this.arrProjects.length>0&&(this.arrProjects[this.arrProjects.length-1].nextProject=o,o.previousProject=this.arrProjects[this.arrProjects.length-1]),this.arrProjects.push(o),o.create(),o.hideDescrProject(),this.checkPosition(),o},openTree:function(e){var t=this.getLastCloseParent(e);this.openNode(t),e.taskItem.id!=t.taskItem.id&&this.openTree(e)},openNode:function(e){e.isExpanded||(p.remove(e.cTaskNameItem[2],"ganttImageTreeExpand"),p.add(e.cTaskNameItem[2],"ganttImageTreeCollapse"),e.isExpanded=!0,e.shiftCurrentTasks(e,e.hideTasksHeight),e.showChildTasks(e,e.isExpanded),e.hideTasksHeight=0)},getLastCloseParent:function(e){return e.parentTask?e.parentTask.isExpanded&&"none"!=e.parentTask.cTaskNameItem[2].style.display?e:this.getLastCloseParent(e.parentTask):e},getProjectItemById:function(e){return l.filter(this.project,function(t){return t.id==e},this)[0]},clearAll:function(){this.contentDataHeight=0,this.startDate=null,this.clearData(),this.clearItems(),this.clearEvents()},clearEvents:function(){l.forEach(this._events,function(e){e.remove()}),this._events=[]},clearData:function(){this.project=[],this.arrProjects=[]},clearItems:function(){this.contentData.removeChild(this.contentData.firstChild),this.contentData.appendChild(this.createPanelTasks()),this.panelNames.removeChild(this.panelNames.firstChild),this.panelNames.appendChild(this.createPanelNamesTasks()),this.panelTime.removeChild(this.panelTime.firstChild)},buildUIContent:function(){this.project.sort(this.sortProjStartDate),this.startDate=this.getStartDate(),this.panelTime.appendChild(this.createPanelTime());for(var e=0;e<this.project.length;e++){for(var t=this.project[e],a=0;a<t.parentTasks.length;a++){var n=t.parentTasks[a];if(!n.startTime)return;if(this.setStartTimeChild(n),this.setPreviousTask(t))return}for(var a=0;a<t.parentTasks.length;a++){var n=t.parentTasks[a];if(n.startTime<t.startDate)return;if(this.checkPosParentTaskInTree(n))return}this.sortTasksByStartTime(t)}for(var e=0;e<this.project.length;e++){var t=this.project[e],r=new i(this,t);if(this.arrProjects.length>0){var o=this.arrProjects[this.arrProjects.length-1];r.previousProject=o,o.nextProject=r}r.create(),this.checkHeighPanelTasks(),this.arrProjects.push(r),this.createTasks(r)}this.resource&&this.resource.reConstruct(),this.postLoadData(),this.postBindEvents()},loadJSONData:function(e){var t=this;t.dataFilePath=e||t.dataFilePath,u.get(t.dataFilePath,{sync:!0}).then(function(e){t.loadJSONString(e.text),t.buildUIContent()},function(){})},loadJSONString:function(t){if(t){this.clearAll();var i=w.parse(t),a=i.items;l.forEach(a,function(t){var i=t.startdate.split("-"),a=new e({id:t.id,name:t.name,startDate:new Date(i[0],parseInt(i[1])-1,i[2])}),r=t.tasks;l.forEach(r,function(e){var t=e.id,i=e.name,r=e.starttime.split("-"),o=e.duration,s=e.percentage,l=e.previousTaskId,d=e.taskOwner,h=new n({id:t,name:i,startTime:new Date(r[0],parseInt(r[1])-1,r[2]),duration:o,percentage:s,previousTaskId:l,taskOwner:d}),u=e.children;0!=u.length&&this.buildChildTasksData(h,u),a.addTask(h)},this),this.addProject(a)},this)}},buildChildTasksData:function(e,t){t&&l.forEach(t,function(t){var i=t.id,a=t.name,r=t.starttime.split("-"),o=t.duration,s=t.percentage,l=t.previousTaskId,d=t.taskOwner,h=new n({id:i,name:a,startTime:new Date(r[0],parseInt(r[1])-1,r[2]),duration:o,percentage:s,previousTaskId:l,taskOwner:d});h.parentTask=e,e.addChildTask(h);var u=t.children;0!=u.length&&this.buildChildTasksData(h,u)},this)},getJSONData:function(){var e={identifier:"id",items:[]};return l.forEach(this.project,function(t){var i={id:t.id,name:t.name,startdate:t.startDate.getFullYear()+"-"+(t.startDate.getMonth()+1)+"-"+t.startDate.getDate(),tasks:[]};e.items.push(i),l.forEach(t.parentTasks,function(e){var t={id:e.id,name:e.name,starttime:e.startTime.getFullYear()+"-"+(e.startTime.getMonth()+1)+"-"+e.startTime.getDate(),duration:e.duration,percentage:e.percentage,previousTaskId:e.previousTaskId||"",taskOwner:e.taskOwner||"",children:this.getChildTasksData(e.cldTasks)};i.tasks.push(t)},this)},this),e},getChildTasksData:function(e){var t=[];return e&&e.length>0&&l.forEach(e,function(e){var i={id:e.id,name:e.name,starttime:e.startTime.getFullYear()+"-"+(e.startTime.getMonth()+1)+"-"+e.startTime.getDate(),duration:e.duration,percentage:e.percentage,previousTaskId:e.previousTaskId||"",taskOwner:e.taskOwner||"",children:this.getChildTasksData(e.cldTasks)};t.push(i)},this),t},saveJSONData:function(e){var t=this;t.dataFilePath=e&&d.trim(e).length>0?e:this.dataFilePath;try{u.post(t.saveProgramPath,{query:{filename:t.dataFilePath,data:w.stringify(t.getJSONData())}}).response.then(function(e){c.checkStatus(e.options.status)||405==e.options.status})}catch(i){}},sortTaskStartTime:function(e,t){return e.startTime<t.startTime?-1:e.startTime>t.startTime?1:0},sortProjStartDate:function(e,t){return e.startDate<t.startDate?-1:e.startDate>t.startDate?1:0},setStartTimeChild:function(e){l.forEach(e.cldTasks,function(t){t.startTime||(t.startTime=e.startTime),0!=t.cldTasks.length&&this.setStartTimeChild(t)},this)},createPanelTasks:function(){var e=g.create("div",{className:"ganttTaskPanel"});return y.set(e,{height:this.contentHeight-this.panelTimeHeight-this.scrollBarWidth+"px"}),e},refreshParams:function(e){this.pixelsPerDay=e,this.pixelsPerWorkHour=this.pixelsPerDay/this.hsPerDay,this.pixelsPerHour=this.pixelsPerDay/24},createPanelNamesTasksHeader:function(){var e=g.create("div",{className:"ganttPanelHeader"}),t=g.create("table",{cellPadding:"0px",border:"0px",cellSpacing:"0px",bgColor:"#FFFFFF",className:"ganttToolbar"},e),i=t.insertRow(t.rows.length),a=t.insertRow(t.rows.length),n=t.insertRow(t.rows.length),r=(t.insertRow(t.rows.length),g.create("td",{align:"center",vAlign:"middle",className:"ganttToolbarZoomIn"},i)),o=d.hitch(this,function(){2*this.scale>5||(this.scale=2*this.scale,this.switchTeleMicroView(this.pixelsPerDay*this.scale))});this.zoomInClickEvent&&this.zoomInClickEvent.remove(),this.zoomInClickEvent=m(r,"click",d.hitch(this,o)),this.zoomInKeyEvent&&this.zoomInKeyEvent.remove(),this.zoomInKeyEvent=m(r,"keydown",d.hitch(this,function(e){e.keyCode==k.ENTER&&o()})),v.set(r,"tabIndex",0);var s=g.create("td",{align:"center",vAlign:"middle",className:"ganttToolbarZoomOut"},i),h=d.hitch(this,function(){.5*this.scale<.2||(this.scale=.5*this.scale,this.switchTeleMicroView(this.pixelsPerDay*this.scale))});this.zoomOutClickEvent&&this.zoomOutClickEvent.remove(),this.zoomOutClickEvent=m(s,"click",d.hitch(this,h)),this.zoomOutKeyEvent&&this.zoomOutKeyEvent.remove(),this.zoomOutKeyEvent=m(s,"keydown",d.hitch(this,function(e){e.keyCode==k.ENTER&&h()})),v.set(s,"tabIndex",0);var u=g.create("td",{align:"center",vAlign:"middle",className:"ganttToolbarMicro"},a);this.microClickEvent&&this.microClickEvent.remove(),this.microClickEvent=m(u,"click",d.hitch(this,this.refresh,this.animation?15:1,0,2)),this.microKeyEvent&&this.microKeyEvent.remove(),this.microKeyEvent=m(u,"keydown",d.hitch(this,function(e){e.keyCode==k.ENTER&&(u.blur(),this.refresh(this.animation?15:1,0,2))})),v.set(u,"tabIndex",0);var c=g.create("td",{align:"center",vAlign:"middle",className:"ganttToolbarTele"},a);this.teleClickEvent&&this.teleClickEvent.remove(),this.teleClickEvent=m(c,"click",d.hitch(this,this.refresh,this.animation?15:1,0,.5)),this.teleKeyEvent&&this.teleKeyEvent.remove(),this.teleKeyEvent=m(c,"keydown",d.hitch(this,function(e){e.keyCode==k.ENTER&&(c.blur(),this.refresh(this.animation?15:1,0,.5))})),v.set(c,"tabIndex",0);var f=g.create("td",{align:"center",vAlign:"middle",className:"ganttToolbarSave"},n);this.saveClickEvent&&this.saveClickEvent.remove(),this.saveClickEvent=m(f,"click",d.hitch(this,this.saveJSONData,"")),this.saveKeyEvent&&this.saveKeyEvent.remove(),this.saveKeyEvent=m(f,"keydown",d.hitch(this,function(e){e.keyCode==k.ENTER&&this.saveJSONData("")})),v.set(f,"tabIndex",0);var y=g.create("td",{align:"center",vAlign:"middle",className:"ganttToolbarLoad"},n);this.loadClickEvent&&this.loadClickEvent.remove(),this.loadClickEvent=m(y,"click",d.hitch(this,this.loadJSONData,"")),this.loadKeyEvent&&this.loadKeyEvent.remove(),this.loadKeyEvent=m(y,"keydown",d.hitch(this,function(e){e.keyCode==k.ENTER&&this.loadJSONData("")})),v.set(y,"tabIndex",0);var b=[r,s,u,c,f,y],M=["Enlarge timeline","Shrink timeline","Zoom in time zone(microscope view)","Zoom out time zone(telescope view)","Save gantt data to json file","Load gantt data from json file"];return l.forEach(b,function(e,t){var i=M[t],a=function(){p.add(e,"ganttToolbarActionHover"),dijit.showTooltip(i,e,["above","below"])};e.onmouseover=a,e.onfocus=a;var n=function(){p.remove(e,"ganttToolbarActionHover"),e&&dijit.hideTooltip(e)};e.onmouseout=n,e.onblur=n},this),e},createPanelNamesTasks:function(){var e=g.create("div",{innerHTML:"&nbsp;",className:"ganttPanelNames"});return y.set(e,{height:this.contentHeight-this.panelTimeHeight-this.scrollBarWidth+"px",width:this.maxWidthPanelNames+"px"}),e},createPanelTime:function(){var e=g.create("div",{className:"ganttPanelTime"}),t=g.create("table",{cellPadding:"0px",border:"0px",cellSpacing:"0px",bgColor:"#FFFFFF",className:"ganttTblTime"},e);this.totalDays=this.countDays;var i,a,n=t.insertRow(t.rows.length),r=0;a=i=new Date(this.startDate).getFullYear();for(var o=0;o<this.countDays;o++,r++){var s=new Date(this.startDate);s.setDate(s.getDate()+o),a=s.getFullYear(),a!=i&&(this.addYearInPanelTime(n,r,i),r=0,i=a)}this.addYearInPanelTime(n,r,a),y.set(n,"display","none");var l,d,u=t.insertRow(t.rows.length),c=0,m=1970;d=l=new Date(this.startDate).getMonth();for(var o=0;o<this.countDays;o++,c++){var s=new Date(this.startDate);s.setDate(s.getDate()+o),d=s.getMonth(),m=s.getFullYear(),d!=l&&(this.addMonthInPanelTime(u,c,l,11!==l?m:m-1),c=0,l=d)}this.addMonthInPanelTime(u,c,d,m);var f,p,v=t.insertRow(t.rows.length),c=0;p=f=h._getWeekOfYear(new Date(this.startDate));for(var o=0;o<this.countDays;o++,c++){var s=new Date(this.startDate);s.setDate(s.getDate()+o),p=h._getWeekOfYear(s),p!=f&&(this.addWeekInPanelTime(v,c,f),c=0,f=p)}this.addWeekInPanelTime(v,c,p);for(var b=t.insertRow(t.rows.length),o=0;o<this.countDays;o++)this.addDayInPanelTime(b);for(var k=t.insertRow(t.rows.length),o=0;o<this.countDays;o++)this.addHourInPanelTime(k);return y.set(k,"display","none"),e},adjustPanelTime:function(){var e=l.map(this.arrProjects,function(e){return parseInt(e.projectItem[0].style.left)+parseInt(e.projectItem[0].firstChild.style.width)+e.descrProject.offsetWidth+this.panelTimeExpandDelta},this).sort(function(e,t){return t-e})[0];if(this.maxTaskEndPos!=e){for(var t=this.panelTime.firstChild.firstChild.rows,i=0;4>=i;i++)this.removeCell(t[i]);var a=Math.round((e+this.panelTimeExpandDelta)/this.pixelsPerDay);this.totalDays=a;var n,r,o=0;r=n=new Date(this.startDate).getFullYear();for(var i=0;a>i;i++,o++){var s=new Date(this.startDate);s.setDate(s.getDate()+i),r=s.getFullYear(),r!=n&&(this.addYearInPanelTime(t[0],o,n),o=0,n=r)}this.addYearInPanelTime(t[0],o,r);var d,u,c=0,m=1970;u=d=new Date(this.startDate).getMonth();for(var i=0;a>i;i++,c++){var s=new Date(this.startDate);s.setDate(s.getDate()+i),u=s.getMonth(),m=s.getFullYear(),u!=d&&(this.addMonthInPanelTime(t[1],c,d,11!==d?m:m-1),c=0,d=u)}this.addMonthInPanelTime(t[1],c,u,m);var f,p,c=0;p=f=h._getWeekOfYear(new Date(this.startDate));for(var i=0;a>i;i++,c++){var s=new Date(this.startDate);s.setDate(s.getDate()+i),p=h._getWeekOfYear(s),p!=f&&(this.addWeekInPanelTime(t[2],c,f),c=0,f=p)}this.addWeekInPanelTime(t[2],c,p);for(var i=0;a>i;i++)this.addDayInPanelTime(t[3]);for(var i=0;a>i;i++)this.addHourInPanelTime(t[4]);this.panelTime.firstChild.firstChild.style.width=this.pixelsPerDay*t[3].cells.length+"px",this.contentData.firstChild.style.width=this.pixelsPerDay*t[3].cells.length+"px",this.maxTaskEndPos=e}},addYearInPanelTime:function(e,t,i){var a="Year   "+i,n=g.create("td",{colSpan:t,align:"center",vAlign:"middle",className:"ganttYearNumber",innerHTML:this.pixelsPerDay*t>20?a:"",innerHTMLData:a},e);y.set(n,"width",this.pixelsPerDay*t+"px")},addMonthInPanelTime:function(e,t,i,a){var n=this.months[i]+(a?" of "+a:""),r=g.create("td",{colSpan:t,align:"center",vAlign:"middle",className:"ganttMonthNumber",innerHTML:this.pixelsPerDay*t>30?n:"",innerHTMLData:n},e);y.set(r,"width",this.pixelsPerDay*t+"px")},addWeekInPanelTime:function(e,t,i){var a="Week   "+i,n=g.create("td",{colSpan:t,align:"center",vAlign:"middle",className:"ganttWeekNumber",innerHTML:this.pixelsPerDay*t>20?a:"",innerHTMLData:a},e);y.set(n,"width",this.pixelsPerDay*t+"px")},addDayInPanelTime:function(e){var t=new Date(this.startDate);t.setDate(t.getDate()+parseInt(e.cells.length));var i=g.create("td",{align:"center",vAlign:"middle",className:"ganttDayNumber",innerHTML:this.pixelsPerDay>20?t.getDate():"",innerHTMLData:String(t.getDate()),data:e.cells.length},e);y.set(i,"width",this.pixelsPerDay+"px"),t.getDay()>=5&&p.add(i,"ganttDayNumberWeekend"),this._events.push(m(i,"mouseover",d.hitch(this,function(e){var t=e.target||e.srcElement,a=new Date(this.startDate.getTime());a.setDate(a.getDate()+parseInt(v.get(t,"data"))),dijit.showTooltip(a.getFullYear()+"."+(a.getMonth()+1)+"."+a.getDate(),i,["above","below"])}))),this._events.push(m(i,"mouseout",d.hitch(this,function(e){var t=e.target||e.srcElement;t&&dijit.hideTooltip(t)})))},addHourInPanelTime:function(e){var t=g.create("td",{align:"center",vAlign:"middle",className:"ganttHourNumber",data:e.cells.length},e);y.set(t,"width",this.pixelsPerDay+"px");for(var i=g.create("table",{cellPadding:"0",cellSpacing:"0"},t),a=i.insertRow(i.rows.length),n=0;n<this.hsPerDay;n++){var r=g.create("td",{className:"ganttHourClass"},a);y.set(r,"width",this.pixelsPerDay/this.hsPerDay+"px"),v.set(r,"innerHTMLData",String(9+n)),this.pixelsPerDay/this.hsPerDay>5&&v.set(r,"innerHTML",String(9+n)),p.add(r,3>=n?"ganttHourNumberAM":"ganttHourNumberPM")}},incHeightPanelTasks:function(e){var t=this.contentData.firstChild;t.style.height=parseInt(t.style.height)+e+"px"},incHeightPanelNames:function(e){var t=this.panelNames.firstChild;t.style.height=parseInt(t.style.height)+e+"px"},checkPosition:function(){l.forEach(this.arrProjects,function(e){l.forEach(e.arrTasks,function(e){e.checkPosition()},this)},this)},checkHeighPanelTasks:function(){this.contentDataHeight+=this.heightTaskItemExtra+this.heightTaskItem,parseInt(this.contentData.firstChild.style.height)<=this.contentDataHeight&&(this.incHeightPanelTasks(this.heightTaskItem+this.heightTaskItemExtra),this.incHeightPanelNames(this.heightTaskItem+this.heightTaskItemExtra))},sortTasksByStartTime:function(e){e.parentTasks.sort(this.sortTaskStartTime);for(var t=0;t<e.parentTasks.length;t++)e.parentTasks[t]=this.sortChildTasks(e.parentTasks[t])},sortChildTasks:function(e){e.cldTasks.sort(this.sortTaskStartTime);for(var t=0;t<e.cldTasks.length;t++)e.cldTasks[t].cldTasks.length>0&&this.sortChildTasks(e.cldTasks[t]);return e},refresh:function(e,t,i){if(!(this.arrProjects.length<=0||this.arrProjects[0].arrTasks.length<=0)){if(!e||t>e)return this.refreshController(),this.resource&&this.resource.refresh(),this.tempDayInPixels=0,void(this.panelNameHeadersCover&&y.set(this.panelNameHeadersCover,"display","none"));0==this.tempDayInPixels&&(this.tempDayInPixels=this.pixelsPerDay),this.panelNameHeadersCover&&y.set(this.panelNameHeadersCover,"display","");var a=this.tempDayInPixels+this.tempDayInPixels*(i-1)*Math.pow(t/e,2);this.refreshParams(a),l.forEach(this.arrProjects,function(e){l.forEach(e.arrTasks,function(e){e.refresh()},this),e.refresh()},this),setTimeout(d.hitch(this,function(){this.refresh(e,++t,i)}),15)}},switchTeleMicroView:function(e){for(var t=this.panelTime.firstChild.firstChild,i=0;5>i;i++)e>40?y.set(t.rows[i],"display",0==i||1==i?"none":""):20>e?y.set(t.rows[i],"display",2==i||4==i?"none":""):y.set(t.rows[i],"display",0==i||4==i?"none":"")},refreshController:function(){this.contentData.firstChild.style.width=Math.max(1200,this.pixelsPerDay*this.totalDays)+"px",this.panelTime.firstChild.style.width=this.pixelsPerDay*this.totalDays+"px",this.panelTime.firstChild.firstChild.style.width=this.pixelsPerDay*this.totalDays+"px",this.switchTeleMicroView(this.pixelsPerDay),l.forEach(this.panelTime.firstChild.firstChild.rows,function(e){l.forEach(e.childNodes,function(e){var t=parseInt(v.get(e,"colSpan")||1),i=d.trim(v.get(e,"innerHTMLData")||"");i.length>0?v.set(e,"innerHTML",this.pixelsPerDay*t<20?"":i):l.forEach(e.firstChild.rows[0].childNodes,function(e){var t=d.trim(v.get(e,"innerHTMLData")||"");v.set(e,"innerHTML",this.pixelsPerDay/this.hsPerDay>10?t:"")},this),1==t&&(y.set(e,"width",this.pixelsPerDay*t+"px"),i.length<=0&&l.forEach(e.firstChild.rows[0].childNodes,function(e){y.set(e,"width",this.pixelsPerDay*t/this.hsPerDay+"px")},this))},this)},this)},init:function(){this.startDate=this.getStartDate(),y.set(this.content,{width:this.contentWidth+"px",height:this.contentHeight+"px"}),this.tableControl=g.create("table",{cellPadding:"0",cellSpacing:"0",className:"ganttTabelControl"});var e=this.tableControl.insertRow(this.tableControl.rows.length);this.content.appendChild(this.tableControl),this.countDays=this.getCountDays(),this.panelTime=g.create("div",{className:"ganttPanelTimeContainer"}),y.set(this.panelTime,"height",this.panelTimeHeight+"px"),this.panelTime.appendChild(this.createPanelTime()),this.contentData=g.create("div",{className:"ganttContentDataContainer"}),y.set(this.contentData,"height",this.contentHeight-this.panelTimeHeight+"px"),this.contentData.appendChild(this.createPanelTasks());var a=g.create("td",{vAlign:"top"});this.panelNameHeaders=g.create("div",{className:"ganttPanelNameHeaders"},a),y.set(this.panelNameHeaders,{height:this.panelTimeHeight+"px",width:this.maxWidthPanelNames+"px"}),this.panelNameHeaders.appendChild(this.createPanelNamesTasksHeader()),this.panelNames=g.create("div",{className:"ganttPanelNamesContainer"},a),this.panelNames.appendChild(this.createPanelNamesTasks()),e.appendChild(a),a=g.create("td",{vAlign:"top"});var n=g.create("div",{className:"ganttDivCell"});n.appendChild(this.panelTime),n.appendChild(this.contentData),a.appendChild(n),e.appendChild(a),y.set(this.panelNames,"height",this.contentHeight-this.panelTimeHeight-this.scrollBarWidth+"px"),y.set(this.panelNames,"width",this.maxWidthPanelNames+"px"),y.set(this.contentData,"width",this.contentWidth-this.maxWidthPanelNames+"px"),y.set(this.contentData.firstChild,"width",this.pixelsPerDay*this.countDays+"px"),y.set(this.panelTime,"width",this.contentWidth-this.maxWidthPanelNames-this.scrollBarWidth+"px"),y.set(this.panelTime.firstChild,"width",this.pixelsPerDay*this.countDays+"px"),this.isShowConMenu&&(this.tabMenu=new r(this));var o=this;this.contentData.onscroll=function(){o.panelTime.scrollLeft=this.scrollLeft,o.panelNames&&(o.panelNames.scrollTop=this.scrollTop,o.isShowConMenu&&o.tabMenu.hide()),o.resource&&(o.resource.contentData.scrollLeft=this.scrollLeft)},this.project.sort(this.sortProjStartDate);for(var s=0;s<this.project.length;s++){for(var l=this.project[s],d=0;d<l.parentTasks.length;d++){var h=l.parentTasks[d];if(h.startTime||(h.startTime=l.startDate),this.setStartTimeChild(h),this.setPreviousTask(l))return}for(var d=0;d<l.parentTasks.length;d++){var h=l.parentTasks[d];if(h.startTime<l.startDate){if(!this.correctError)return;h.startTime=l.startDate}if(this.checkPosParentTaskInTree(h))return}this.sortTasksByStartTime(l)}for(var s=0;s<this.project.length;s++){var l=this.project[s],u=new i(this,l);if(this.arrProjects.length>0){var c=this.arrProjects[this.arrProjects.length-1];u.previousProject=c,c.nextProject=u}u.create(),this.checkHeighPanelTasks(),this.arrProjects.push(u),this.createTasks(u)}return this.withResource&&(this.resource=new t(this),this.resource.create()),this.postLoadData(),this.postBindEvents(),this},postLoadData:function(){l.forEach(this.arrProjects,function(e){l.forEach(e.arrTasks,function(e){e.postLoadData()},this),e.postLoadData()},this);var e=b.getMarginBox(this.panelNameHeaders);this.panelNameHeadersCover||(this.panelNameHeadersCover=g.create("div",{className:"ganttHeaderCover"},this.panelNameHeaders.parentNode),y.set(this.panelNameHeadersCover,{left:e.l+"px",top:e.t+"px",height:e.h+"px",width:e.w+"px",display:"none"}))},postBindEvents:function(){var e=b.position(this.tableControl,!0);M("dom-addeventlistener")&&this._events.push(m(this.tableControl,"mousemove",d.hitch(this,function(t){var i=t.srcElement||t.target;if(i==this.panelNames.firstChild||i==this.contentData.firstChild){var a=this.heightTaskItem+this.heightTaskItemExtra,n=parseInt(t.layerY/a)*a+this.panelTimeHeight-this.contentData.scrollTop;n!=this.oldHLTop&&n<e.h-50&&(this.highLightDiv?y.set(this.highLightDiv,"top",e.y+n+"px"):(this.highLightDiv=g.create("div",{className:"ganttRowHighlight"},x.body()),y.set(this.highLightDiv,{top:e.y+n+"px",left:e.x+"px",width:e.w-20+"px",height:a+"px"}))),this.oldHLTop=n}})))},getStartDate:function(){return l.forEach(this.project,function(e){this.startDate?e.startDate<this.startDate&&(this.startDate=new Date(e.startDate)):this.startDate=new Date(e.startDate)},this),this.initialPos=24*this.pixelsPerHour,this.startDate?new Date(this.startDate.setHours(this.startDate.getHours()-24)):new Date},getCountDays:function(){return parseInt((this.contentWidth-this.maxWidthPanelNames)/(24*this.pixelsPerHour))},createTasks:function(e){l.forEach(e.project.parentTasks,function(t,i){i>0&&(e.project.parentTasks[i-1].nextParentTask=t,t.previousParentTask=e.project.parentTasks[i-1]);var n=new a(t,e,this);e.arrTasks.push(n),n.create(),this.checkHeighPanelTasks(),t.cldTasks.length>0&&this.createChildItemControls(t.cldTasks,e)},this)},createChildItemControls:function(e,t){e&&l.forEach(e,function(i,n){n>0&&(i.previousChildTask=e[n-1],e[n-1].nextChildTask=i);var r=new a(i,t,this);r.create(),this.checkHeighPanelTasks(),i.cldTasks.length>0&&this.createChildItemControls(i.cldTasks,t)},this)},getPosOnDate:function(e){return(e-this.startDate)/36e5*this.pixelsPerHour},getWidthOnDuration:function(e){return Math.round(this.pixelsPerWorkHour*e)},getLastChildTask:function(e){return e.childTask.length>0?this.getLastChildTask(e.childTask[e.childTask.length-1]):e},removeCell:function(e){for(;e.cells[0];)e.deleteCell(e.cells[0])}})});//# sourceMappingURL=GanttChart.js.map