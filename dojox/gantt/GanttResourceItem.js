//>>built
define("dojox/gantt/GanttResourceItem",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/date/locale","dojo/request","dojo/on","dojo/dom","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/dom-attr","dojo/dom-geometry","dojo/keys","dojo/domReady!"],function(e,t,a,i,o,r,n,s,l,d,u,c,m){return e("dojox.gantt.GanttResourceItem",[],{constructor:function(e){this.ganttChart=e,this.ownerItem=[],this.ownerNameItem=[],this.ownerTaskNodeMapping={},this.ownerTaskNodeMapping_time={},this.resourceInfo={},this.ownerTimeConsume={}},clearAll:function(){this.clearData(),this.clearItems()},clearData:function(){this.ownerItem=[],this.ownerNameItem=[],this.ownerTaskNodeMapping={},this.ownerTaskNodeMapping_time={},this.resourceInfo={},this.ownerTimeConsume={}},clearItems:function(){this.content.firstChild&&l.destroy(this.content.firstChild)},buildResource:function(){var e={};return t.forEach(this.ganttChart.arrProjects,function(a){t.forEach(a.arrTasks,function(t){t.buildResourceInfo(e)},this)},this),e},buildOwnerTimeConsume:function(){var e={};for(var t in this.resourceInfo){for(var a=this.resourceInfo[t],i={},o=0;o<a.length;o++){var r=a[o],n=r.taskItem.startTime.getTime(),s=24*r.taskItem.duration*60*60*1e3/this.ganttChart.hsPerDay;i.min=i.min?Math.min(i.min,n):n,i.max=i.max?Math.max(i.max,n+s):n+s}i.dur=(i.max-i.min)*this.ganttChart.hsPerDay/864e5,i.min=new Date(i.min),i.max=new Date(i.max),e[t]=i}return e},refresh:function(){this.ownerTimeConsume=this.buildOwnerTimeConsume(),this.contentData.firstChild.style.width=Math.max(1200,this.ganttChart.pixelsPerDay*this.ganttChart.totalDays)+"px";for(var e in this.resourceInfo)this.refreshOwnerEntry(e)},reConstruct:function(){this.clearAll(),this.resourceInfo=this.buildResource(),this.ownerTimeConsume=this.buildOwnerTimeConsume(),this.tableControl=l.create("table",{cellPadding:"0",cellSpacing:"0",className:"ganttResourceTableControl"});var e=this.tableControl.insertRow(this.tableControl.rows.length);this.contentHeight=this.content.offsetHeight,this.contentWidth=this.content.offsetWidth,this.content.appendChild(this.tableControl),this.contentData=l.create("div",{className:"ganttResourceContentDataContainer"}),this.contentData.appendChild(this.createPanelOwners()),d.set(this.contentData,"height",this.contentHeight-this.ganttChart.panelTimeHeight+"px");var t=l.create("td",{vAlign:"top"});this.panelNames=l.create("div",{className:"ganttResourcePanelNames"}),this.panelNames.appendChild(this.createPanelNamesOwners()),t.appendChild(this.panelNames),e.appendChild(t),t=l.create("td",{vAlign:"top"});var a=l.create("div",{className:"ganttResourceDivCell"});a.appendChild(this.contentData),t.appendChild(a),e.appendChild(t),d.set(this.panelNames,{height:this.contentHeight-this.ganttChart.panelTimeHeight-this.ganttChart.scrollBarWidth+"px",width:this.ganttChart.maxWidthPanelNames+"px"}),this.contentData.style.width=this.contentWidth-this.ganttChart.maxWidthPanelNames+"px",this.contentData.firstChild.style.width=this.ganttChart.pixelsPerDay*this.ganttChart.panelTime.firstChild.firstChild.rows[3].cells.length+"px";var i=this;this.contentData.onscroll=function(){i.panelNames&&(i.panelNames.scrollTop=this.scrollTop)},this.contentData.scrollLeft=this.ganttChart.contentData.scrollLeft;for(var o in this.resourceInfo)this.createOwnerEntry(o);this.postAdjustment()},create:function(){var e=l.create("div",{innerHTML:"Resource Chart:",className:"ganttResourceHeader"},this.ganttChart.content,"after");d.set(e,"width",this.ganttChart.contentWidth+"px");var t=l.create("div",{className:"ganttResourceContent"},e,"after");d.set(t,{width:this.ganttChart.contentWidth+"px",height:(this.ganttChart.resourceChartHeight||.8*this.ganttChart.contentHeight)+"px"}),this.content=t||this.content,this.reConstruct()},postAdjustment:function(){this.contentData.firstChild.style.height=23*this.ownerItem.length+"px",this.panelNames.firstChild.style.height=23*this.ownerItem.length+"px"},refreshOwnerEntry:function(e){this.refreshOwnerItem(e),t.forEach(this.resourceInfo[e],function(t,a){var i=this.ownerTaskNodeMapping[e].tasks[a][0];this.refreshDetailedTaskEntry(e,i,t)},this)},createOwnerEntry:function(e){var a=this.contentData.firstChild,i=this.ownerItem[this.ownerItem.length-1];this.ownerTaskNodeMapping[e]={},this.ownerTaskNodeMapping[e][e]=[];var o=(i?parseInt(i.style.top):-17)+this.ganttChart.heightTaskItem+11,r=this.createOwnerItem(e,o);if(a.appendChild(r),this.ownerItem.push(r),this.ownerTaskNodeMapping[e][e].push(r),this.panelNames){var n=this.createOwnerNameItem(e,o);this.panelNames.firstChild.appendChild(n),this.ownerNameItem.push(n),this.ownerTaskNodeMapping[e][e].push(n)}var s=this.ownerNameItem[this.ownerNameItem.length-1];if(this.panelNames){this.checkWidthTaskNameItem(s);var l=this.createTreeImg(s);this.panelNames.firstChild.appendChild(l),this.ownerTaskNodeMapping[e][e].push(l)}return this.ownerTaskNodeMapping[e].taskCount=this.resourceInfo[e].length,this.ownerTaskNodeMapping[e].isOpen=!1,this.ownerTaskNodeMapping[e].tasks=[],t.forEach(this.resourceInfo[e],function(t){this.ownerTaskNodeMapping[e].tasks.push(this.createDetailedTaskEntry(e,s,t))},this),this},createOwnerNameItem:function(e,t){var a=l.create("div",{id:e,title:e,innerHTML:e,className:"ganttOwnerNameItem"});return d.set(a,"top",t+"px"),a},refreshOwnerItem:function(e){var a=this.ownerTaskNodeMapping[e][e][0],i=this.ownerTimeConsume[e].min,o=this.ownerTimeConsume[e].dur,r=this.ganttChart.getPosOnDate(i);a.style.left=r+"px",a.style.width=o*this.ganttChart.pixelsPerWorkHour+"px",t.forEach(this.resourceInfo[e],function(e,t){var i=this.ganttChart.getPosOnDate(e.taskItem.startTime);d.set(a.childNodes[t],{left:i-r+"px",width:e.taskItem.duration*this.ganttChart.pixelsPerWorkHour+"px"})},this)},createOwnerItem:function(e,a){var i=this.ownerTimeConsume[e].min,o=this.ownerTimeConsume[e].dur,r=this.ganttChart.getPosOnDate(i),n=l.create("div",{id:e,owner:!0,className:"ganttOwnerBar"});return d.set(n,{left:r+"px",top:a+"px",width:o*this.ganttChart.pixelsPerWorkHour+"px",height:this.ganttChart.heightTaskItem+"px"}),t.forEach(this.resourceInfo[e],function(t){var a=l.create("div",{id:e,className:"ganttOwnerTaskBar"},n),i=this.ganttChart.getPosOnDate(t.taskItem.startTime);d.set(a,{left:i-r+"px",width:t.taskItem.duration*this.ganttChart.pixelsPerWorkHour+"px",height:this.ganttChart.heightTaskItem+"px"})},this),n},refreshDetailedTaskEntry:function(e,t,a){this.refreshTaskItem(t,a)},createDetailedTaskEntry:function(e,a,i){var o=[],r=this.contentData.firstChild,n=parseInt(a.style.top),s=this.createTaskItem(i,n);if(s.style.display="none",r.appendChild(s),this.ownerItem.push(s),o.push(s),this.panelNames){var l=this.createTaskNameItem(i.taskItem.name,n);this.panelNames.firstChild.appendChild(l),l.style.display="none",this.ownerNameItem.push(l),o.push(l)}if(this.panelNames){this.ownerNameItem[this.ownerNameItem.length-1].style.left=d.get(a,"left")+15+"px";var u=this.createConnectingLinesPN(a,this.ownerNameItem[this.ownerNameItem.length-1]);t.forEach(u,function(e){e.style.display="none"},this),o.push({v:u[0],h:u[1]}),this.checkWidthTaskNameItem(this.ownerNameItem[this.ownerNameItem.length-1])}return o},createTaskNameItem:function(e,t){var a=l.create("div",{id:e,className:"ganttTaskNameItem",title:e,innerHTML:e});return d.set(a,"top",t+"px"),a},refreshTaskItem:function(e,t){var a=this.ganttChart.getPosOnDate(t.taskItem.startTime);d.set(e,{left:a+"px",width:t.taskItem.duration*this.ganttChart.pixelsPerWorkHour+"px"})},createTaskItem:function(e,t){var a=this.ganttChart.getPosOnDate(e.taskItem.startTime),i=l.create("div",{id:e.taskItem.name,className:"ganttTaskBar"});return d.set(i,{left:a+"px",top:t+"px",width:e.taskItem.duration*this.ganttChart.pixelsPerWorkHour+"px",height:this.ganttChart.heightTaskItem+"px"}),i},createConnectingLinesPN:function(e,t){var a=[],i=l.create("div",{innerHTML:"&nbsp;",className:"ganttResourceLineVerticalLeft"},this.panelNames.firstChild);i.cNode=t,i.pNode=e;var o=l.create("div",{noShade:!0,color:"#000",className:"ganttResourceLineHorizontalLeft"},this.panelNames.firstChild);return o.cNode=t,o.pNode=e,this.panelNames.firstChild.appendChild(o),a.push(i),a.push(o),a},createTreeImg:function(e){var i=l.create("div",{id:e.id,className:"ganttImageTreeExpand"});u.set(i,"tabIndex",0);var o=this.ownerTaskNodeMapping[e.id];return t.forEach(["click","keydown"],function(n){this.ganttChart._events.push(r(i,n,a.hitch(this,function(a){var r,l,u=!1;if("keydown"!=n||a.keyCode==m.ENTER)if(o.isOpen){s.remove(i,"ganttImageTreeCollapse"),s.add(i,"ganttImageTreeExpand"),o.isOpen=!1;for(r in this.ownerTaskNodeMapping)l=this.ownerTaskNodeMapping[r],u?(t.forEach(l[r],function(e){d.set(e,"top",d.get(e,"top")-23*o.taskCount+"px")}),t.forEach(l.tasks,function(e){t.forEach(e,function(e){var a=e.v||e.h?[e.v,e.h]:[e];t.forEach(a,function(e){d.set(e,"top",d.get(e,"top")-23*o.taskCount+"px")})})})):r==e.id&&(u=!0,t.forEach(l.tasks,function(e){t.forEach(e,function(e){this.styleOwnerItem(e,l[r][0],"none",0)},this)},this))}else{s.remove(i,"ganttImageTreeExpand"),s.add(i,"ganttImageTreeCollapse"),o.isOpen=!0;for(r in this.ownerTaskNodeMapping)l=this.ownerTaskNodeMapping[r],u?(t.forEach(l[r],function(e){d.set(e,"top",d.get(e,"top")+23*o.taskCount+"px")}),t.forEach(l.tasks,function(e){t.forEach(e,function(e){var a=e.v||e.h?[e.v,e.h]:[e];t.forEach(a,function(e){d.set(e,"top",d.get(e,"top")+23*o.taskCount+"px")})})})):r==e.id&&(u=!0,t.forEach(l.tasks,function(e,a){t.forEach(e,function(e){this.styleOwnerItem(e,l[r][0],"inline",23*(a+1))},this)},this))}})))},this),s.add(i,"ganttResourceTreeImage"),d.set(i,{left:d.get(e,"left")-12+"px",top:d.get(e,"top")+3+"px"}),i},styleOwnerItem:function(e,t,a,i){e.v||e.h?(d.set(e.v,{height:Math.max(1,e.v.cNode.offsetTop-e.v.pNode.offsetTop)+"px",top:e.v.pNode.offsetTop+5+"px",left:e.v.pNode.offsetLeft-9+"px",display:a}),d.set(e.h,{width:Math.max(1,e.h.cNode.offsetLeft-e.h.pNode.offsetLeft+4)+"px",top:e.h.cNode.offsetTop+5+"px",left:e.h.pNode.offsetLeft-9+"px",display:a})):d.set(e,{display:a,top:parseInt(t.style.top)+i+"px"})},checkWidthTaskNameItem:function(e){if(e&&e.offsetWidth+e.offsetLeft>this.ganttChart.maxWidthPanelNames){var t=e.offsetWidth+e.offsetLeft-this.ganttChart.maxWidthPanelNames,a=Math.round(t/(e.offsetWidth/e.firstChild.length)),i=e.id.substring(0,e.firstChild.length-a-3);e.innerHTML=i+"..."}},createPanelOwners:function(){var e=l.create("div",{className:"ganttOwnerPanel"});return d.set(e,{height:this.contentHeight-this.ganttChart.panelTimeHeight-this.ganttChart.scrollBarWidth+"px"}),e},createPanelNamesOwners:function(){var e=l.create("div",{innerHTML:"&nbsp;",className:"ganttResourcePanelNamesOwners"});return d.set(e,{height:this.contentHeight-this.ganttChart.panelTimeHeight-this.ganttChart.scrollBarWidth+"px",width:this.ganttChart.maxWidthPanelNames+"px"}),e}})});//# sourceMappingURL=GanttResourceItem.js.map