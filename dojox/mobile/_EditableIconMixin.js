//>>built
define("dojox/mobile/_EditableIconMixin",["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/event","dojo/_base/lang","dojo/_base/window","dojo/dom-geometry","dojo/dom-style","dojo/touch","dijit/registry","./IconItem","./sniff","./viewRegistry","./_css3"],function(e,t,i,a,o,n,r,s,l,d,h,u,c,m){return i("dojox.mobile._EditableIconMixin",null,{deleteIconForEdit:"mblDomButtonBlackCircleCross",threshold:4,destroy:function(){this._blankItem&&this._blankItem.destroy(),this.inherited(arguments)},startEdit:function(){if(this.editable&&!this.isEditing){this.isEditing=!0,this._handles||(this._handles=[this.connect(this.domNode,m.name("transitionStart"),"_onTransitionStart"),this.connect(this.domNode,m.name("transitionEnd"),"_onTransitionEnd")]);var i=0;e.forEach(this.getChildren(),function(e){this.defer(function(){e.set("deleteIcon",this.deleteIconForEdit),e.deleteIconNode&&(e._deleteHandle=this.connect(e.deleteIconNode,"onclick","_deleteIconClicked")),e.highlight(0)},15*i++)},this),t.publish("/dojox/mobile/startEdit",[this]),this.onStartEdit()}},endEdit:function(){this.isEditing&&(e.forEach(this.getChildren(),function(e){e.unhighlight(),e._deleteHandle&&(this.disconnect(e._deleteHandle),e._deleteHandle=null),e.set("deleteIcon","")},this),this._movingItem=null,this._handles&&(e.forEach(this._handles,this.disconnect,this),this._handles=null),t.publish("/dojox/mobile/endEdit",[this]),this.onEndEdit(),this.isEditing=!1)},scaleItem:function(e,t){s.set(e.domNode,m.add({},{transition:u("android")?"":m.name("transform",!0)+" .1s ease-in-out",transform:1==t?"":"scale("+t+")"}))},_onTransitionStart:function(e){a.stop(e)},_onTransitionEnd:function(e){a.stop(e);var t=d.getEnclosingWidget(e.target);t._moving=!1,s.set(t.domNode,m.name("transition"),"")},_onTouchStart:function(e){this._blankItem||(this._blankItem=new h,this._blankItem.domNode.style.visibility="hidden",this._blankItem._onClick=function(){});var t,i=this._movingItem=d.getEnclosingWidget(e.target),a=!1;for(t=e.target;t!==i.domNode;t=t.parentNode)if(t===i.iconNode){a=!0;break}a&&(this._conn||(this._conn=[this.connect(this.domNode,l.move,"_onTouchMove"),this.connect(n.doc,l.release,"_onTouchEnd")]),this._touchStartPosX=e.touches?e.touches[0].pageX:e.pageX,this._touchStartPosY=e.touches?e.touches[0].pageY:e.pageY,this.isEditing?this._onDragStart(e):this._pressTimer=this.defer(function(){this.startEdit(),this._onDragStart(e)},1e3))},_onDragStart:function(e){this._dragging=!0;var t=this._movingItem;t.get("selected")&&t.set("selected",!1),this.scaleItem(t,1.1);var i=e.touches?e.touches[0].pageX:e.pageX,o=e.touches?e.touches[0].pageY:e.pageY,n=c.getEnclosingScrollable(t.domNode),l=0,d=0;if(n){var h=n.getPos();l=h.x,d=h.y,a.stop(e)}var u=this._startPos=r.position(t.domNode,!0);this._offsetPos={x:u.x-i-l,y:u.y-o-d},this._startIndex=this.getIndexOfChild(t),this.addChild(this._blankItem,this._startIndex),this.moveChild(t,this.getChildren().length),s.set(t.domNode,{position:"absolute",top:u.y-d+"px",left:u.x-l+"px",zIndex:100})},_onTouchMove:function(e){var t=e.touches?e.touches[0].pageX:e.pageX,i=e.touches?e.touches[0].pageY:e.pageY;if(this._dragging)s.set(this._movingItem.domNode,{top:this._offsetPos.y+i+"px",left:this._offsetPos.x+t+"px"}),this._detectOverlap({x:t,y:i}),a.stop(e);else{var o=Math.abs(this._touchStartPosX-t),n=Math.abs(this._touchStartPosY-i);(o>this.threshold||n>this.threshold)&&this._clearPressTimer()}},_onTouchEnd:function(i){if(this._clearPressTimer(),this._conn&&(e.forEach(this._conn,this.disconnect,this),this._conn=null),this._dragging){this._dragging=!1;var a=this._movingItem;this.scaleItem(a,1),s.set(a.domNode,{position:"",top:"",left:"",zIndex:""});var o=this._startIndex,n=this.getIndexOfChild(this._blankItem);this.moveChild(a,n),this.removeChild(this._blankItem),t.publish("/dojox/mobile/moveIconItem",[this,a,o,n]),this.onMoveItem(a,o,n)}},_clearPressTimer:function(){this._pressTimer&&(this._pressTimer.remove(),this._pressTimer=null)},_detectOverlap:function(e){var t,i,a,o=this.getChildren(),n=this._blankItem,s=r.position(n.domNode,!0),l=this.getIndexOfChild(n),d=1;if(!this._contains(e,s))for((e.y<s.y||e.y<=s.y+s.h&&e.x<s.x)&&(d=-1),t=l+d;t>=0&&t<o.length-1;t+=d)if(i=o[t],!i._moving){if(a=r.position(i.domNode,!0),this._contains(e,a)){this.defer(function(){this.moveChildWithAnimation(n,1==d?t+1:t)});break}if(1==d&&a.y>e.y||-1==d&&a.y+a.h<e.y)break}},_contains:function(e,t){return t.x<e.x&&e.x<t.x+t.w&&t.y<e.y&&e.y<t.y+t.h},_animate:function(e,t){if(e!=t){var i,a,n=t>e?1:-1,r=this.getChildren(),l=[];for(i=e;i!=t;i+=n)l.push({t:r[i+n].domNode.offsetTop-r[i].domNode.offsetTop+"px",l:r[i+n].domNode.offsetLeft-r[i].domNode.offsetLeft+"px"});for(i=e,a=0;i!=t;i+=n,a++){var d=r[i];d._moving=!0,s.set(d.domNode,{top:l[a].t,left:l[a].l}),this.defer(o.hitch(d,function(){s.set(this.domNode,m.add({top:"0px",left:"0px"},{transition:"top .3s ease-in-out, left .3s ease-in-out"}))}),10*a)}}},removeChildWithAnimation:function(e){var t="number"==typeof e?e:this.getIndexOfChild(e);this.removeChild(e),this._blankItem&&this.addChild(this._blankItem),this._animate(t,this.getChildren().length-1),this._blankItem&&this.removeChild(this._blankItem)},moveChild:function(e,t){this.addChild(e,t),this.paneContainerWidget.addChild(e.paneWidget,t)},moveChildWithAnimation:function(e,t){var i=this.getIndexOfChild(this._blankItem);this.moveChild(e,t),this._animate(i,t)},_deleteIconClicked:function(e){if(this.deleteIconClicked(e)!==!1){var t=d.getEnclosingWidget(e.target);this.deleteItem(t)}},deleteIconClicked:function(){},deleteItem:function(e){e._deleteHandle&&this.disconnect(e._deleteHandle),this.removeChildWithAnimation(e),t.publish("/dojox/mobile/deleteIconItem",[this,e]),this.onDeleteItem(e),e.destroy()},onDeleteItem:function(e){},onMoveItem:function(e,t,i){},onStartEdit:function(){},onEndEdit:function(){},_setEditableAttr:function(e){this._set("editable",e),e&&!this._touchStartHandle?this._touchStartHandle=this.connect(this.domNode,l.press,"_onTouchStart"):!e&&this._touchStartHandle&&(this.disconnect(this._touchStartHandle),this._touchStartHandle=null)}})});//# sourceMappingURL=_EditableIconMixin.js.map