//>>built
define("dojox/gfx/utils",["dojo/_base/kernel","dojo/_base/lang","./_base","dojo/_base/html","dojo/_base/array","dojo/_base/window","dojo/_base/json","dojo/_base/Deferred","dojo/_base/sniff","require","dojo/_base/config"],function(e,t,a,i,r,o,n,s,l,d,u){var m=a.utils={};return t.mixin(m,{forEach:function(t,i,o){o=o||e.global,i.call(o,t),(t instanceof a.Surface||t instanceof a.Group)&&r.forEach(t.children,function(e){m.forEach(e,i,o)})},serialize:function(e){var t,i={},o=e instanceof a.Surface;if(o||e instanceof a.Group){if(i.children=r.map(e.children,m.serialize),o)return i.children}else i.shape=e.getShape();return e.getTransform&&(t=e.getTransform())&&(i.transform=t),e.getStroke&&(t=e.getStroke())&&(i.stroke=t),e.getFill&&(t=e.getFill())&&(i.fill=t),e.getFont&&(t=e.getFont())&&(i.font=t),i},toJson:function(e,t){return n.toJson(m.serialize(e),t)},deserialize:function(e,a){if(a instanceof Array)return r.map(a,t.hitch(null,m.deserialize,e));var i="shape"in a?e.createShape(a.shape):e.createGroup();return"transform"in a&&i.setTransform(a.transform),"stroke"in a&&i.setStroke(a.stroke),"fill"in a&&i.setFill(a.fill),"font"in a&&i.setFont(a.font),"children"in a&&r.forEach(a.children,t.hitch(null,m.deserialize,i)),i},fromJson:function(e,t){return m.deserialize(e,n.fromJson(t))},toSvg:function(e){var t=new s;if("svg"===a.renderer)try{var r=m._cleanSvg(m._innerXML(e.rawNode));t.callback(r)}catch(e){t.errback(e)}else{m._initSvgSerializerDeferred||m._initSvgSerializer();var n=m.toJson(e),l=function(){try{var a=e.getDimensions(),r=a.width,s=a.height,l=m._gfxSvgProxy.document.createElement("div");m._gfxSvgProxy.document.body.appendChild(l),o.withDoc(m._gfxSvgProxy.document,function(){i.style(l,"width",r),i.style(l,"height",s)},this);var d=m._gfxSvgProxy[dojox._scopeName].gfx.createSurface(l,r,s),u=function(e){try{m._gfxSvgProxy[dojox._scopeName].gfx.utils.fromJson(e,n);var a=m._cleanSvg(l.innerHTML);e.clear(),e.destroy(),m._gfxSvgProxy.document.body.removeChild(l),t.callback(a)}catch(e){t.errback(e)}};d.whenLoaded(null,u)}catch(e){t.errback(e)}};m._initSvgSerializerDeferred.fired>0?l():m._initSvgSerializerDeferred.addCallback(l)}return t},_gfxSvgProxy:null,_initSvgSerializerDeferred:null,_svgSerializerInitialized:function(){m._initSvgSerializerDeferred.callback(!0)},_initSvgSerializer:function(){if(!m._initSvgSerializerDeferred){m._initSvgSerializerDeferred=new s;var t=o.doc.createElement("iframe");i.style(t,{display:"none",position:"absolute",width:"1em",height:"1em",top:"-10000px"});var a;l("ie")?t.onreadystatechange=function(){"complete"==t.contentWindow.document.readyState&&(t.onreadystatechange=function(){},a=setInterval(function(){t.contentWindow[e.scopeMap.dojo[1]._scopeName]&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx.utils&&(clearInterval(a),t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._gfxSvgProxy=t.contentWindow,t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._svgSerializerInitialized())},50))}:t.onload=function(){t.onload=function(){},a=setInterval(function(){t.contentWindow[e.scopeMap.dojo[1]._scopeName]&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx.utils&&(clearInterval(a),t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._gfxSvgProxy=t.contentWindow,t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._svgSerializerInitialized())},50)};var r=u.dojoxGfxSvgProxyFrameUrl||d.toUrl("dojox/gfx/resources/gfxSvgProxyFrame.html");t.setAttribute("src",r.toString()),o.body().appendChild(t)}},_innerXML:function(e){return e.innerXML?e.innerXML:e.xml?e.xml:"undefined"!=typeof XMLSerializer?(new XMLSerializer).serializeToString(e):null},_cleanSvg:function(e){return e&&(-1==e.indexOf('xmlns="http://www.w3.org/2000/svg"')&&(e=e.substring(4,e.length),e='<svg xmlns="http://www.w3.org/2000/svg"'+e),-1==e.indexOf('xmlns:xlink="http://www.w3.org/1999/xlink"')&&(e=e.substring(4,e.length),e='<svg xmlns:xlink="http://www.w3.org/1999/xlink"'+e),-1===e.indexOf("xlink:href")&&(e=e.replace(/href\s*=/g,"xlink:href=")),e=e.replace(/<img\b([^>]*)>/gi,"<image $1 />"),e=e.replace(/\bdojoGfx\w*\s*=\s*(['"])\w*\1/g,""),e=e.replace(/\b__gfxObject__\s*=\s*(['"])\w*\1/g,""),e=e.replace(/[=]([^"']+?)(\s|>)/g,'="$1"$2'),e=e.replace(/\bstroke-opacity\w*\s*=\s*(['"])undefined\1/g,"")),e}}),m});//# sourceMappingURL=utils.js.map