//>>built
define("dojox/gfx/utils",["dojo/_base/kernel","dojo/_base/lang","./_base","dojo/_base/html","dojo/_base/array","dojo/_base/window","dojo/_base/json","dojo/_base/Deferred","dojo/_base/sniff","require","dojo/_base/config"],function(e,t,a,i,n,o,r,s,l,d,u){var c=a.utils={};return t.mixin(c,{forEach:function(t,i,o){o=o||e.global,i.call(o,t),(t instanceof a.Surface||t instanceof a.Group)&&n.forEach(t.children,function(e){c.forEach(e,i,o)})},serialize:function(e){var t,i={},o=e instanceof a.Surface;if(o||e instanceof a.Group){if(i.children=n.map(e.children,c.serialize),o)return i.children}else i.shape=e.getShape();return e.getTransform&&(t=e.getTransform(),t&&(i.transform=t)),e.getStroke&&(t=e.getStroke(),t&&(i.stroke=t)),e.getFill&&(t=e.getFill(),t&&(i.fill=t)),e.getFont&&(t=e.getFont(),t&&(i.font=t)),i},toJson:function(e,t){return r.toJson(c.serialize(e),t)},deserialize:function(e,a){if(a instanceof Array)return n.map(a,t.hitch(null,c.deserialize,e));var i="shape"in a?e.createShape(a.shape):e.createGroup();return"transform"in a&&i.setTransform(a.transform),"stroke"in a&&i.setStroke(a.stroke),"fill"in a&&i.setFill(a.fill),"font"in a&&i.setFont(a.font),"children"in a&&n.forEach(a.children,t.hitch(null,c.deserialize,i)),i},fromJson:function(e,t){return c.deserialize(e,r.fromJson(t))},toSvg:function(e){var t=new s;if("svg"===a.renderer)try{var n=c._cleanSvg(c._innerXML(e.rawNode));t.callback(n)}catch(r){t.errback(r)}else{c._initSvgSerializerDeferred||c._initSvgSerializer();var l=c.toJson(e),d=function(){try{var a=e.getDimensions(),n=a.width,r=a.height,s=c._gfxSvgProxy.document.createElement("div");c._gfxSvgProxy.document.body.appendChild(s),o.withDoc(c._gfxSvgProxy.document,function(){i.style(s,"width",n),i.style(s,"height",r)},this);var d=c._gfxSvgProxy[dojox._scopeName].gfx.createSurface(s,n,r),u=function(e){try{c._gfxSvgProxy[dojox._scopeName].gfx.utils.fromJson(e,l);var a=c._cleanSvg(s.innerHTML);e.clear(),e.destroy(),c._gfxSvgProxy.document.body.removeChild(s),t.callback(a)}catch(i){t.errback(i)}};d.whenLoaded(null,u)}catch(m){t.errback(m)}};c._initSvgSerializerDeferred.fired>0?d():c._initSvgSerializerDeferred.addCallback(d)}return t},_gfxSvgProxy:null,_initSvgSerializerDeferred:null,_svgSerializerInitialized:function(){c._initSvgSerializerDeferred.callback(!0)},_initSvgSerializer:function(){if(!c._initSvgSerializerDeferred){c._initSvgSerializerDeferred=new s;var t=o.doc.createElement("iframe");i.style(t,{display:"none",position:"absolute",width:"1em",height:"1em",top:"-10000px"});var a;l("ie")?t.onreadystatechange=function(){"complete"==t.contentWindow.document.readyState&&(t.onreadystatechange=function(){},a=setInterval(function(){t.contentWindow[e.scopeMap.dojo[1]._scopeName]&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx.utils&&(clearInterval(a),t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._gfxSvgProxy=t.contentWindow,t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._svgSerializerInitialized())},50))}:t.onload=function(){t.onload=function(){},a=setInterval(function(){t.contentWindow[e.scopeMap.dojo[1]._scopeName]&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx.utils&&(clearInterval(a),t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._gfxSvgProxy=t.contentWindow,t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._svgSerializerInitialized())},50)};var n=u.dojoxGfxSvgProxyFrameUrl||d.toUrl("dojox/gfx/resources/gfxSvgProxyFrame.html");t.setAttribute("src",n.toString()),o.body().appendChild(t)}},_innerXML:function(e){return e.innerXML?e.innerXML:e.xml?e.xml:"undefined"!=typeof XMLSerializer?(new XMLSerializer).serializeToString(e):null},_cleanSvg:function(e){return e&&(-1==e.indexOf('xmlns="http://www.w3.org/2000/svg"')&&(e=e.substring(4,e.length),e='<svg xmlns="http://www.w3.org/2000/svg"'+e),-1==e.indexOf('xmlns:xlink="http://www.w3.org/1999/xlink"')&&(e=e.substring(4,e.length),e='<svg xmlns:xlink="http://www.w3.org/1999/xlink"'+e),-1===e.indexOf("xlink:href")&&(e=e.replace(/href\s*=/g,"xlink:href=")),e=e.replace(/<img\b([^>]*)>/gi,"<image $1 />"),e=e.replace(/\bdojoGfx\w*\s*=\s*(['"])\w*\1/g,""),e=e.replace(/\b__gfxObject__\s*=\s*(['"])\w*\1/g,""),e=e.replace(/[=]([^"']+?)(\s|>)/g,'="$1"$2'),e=e.replace(/\bstroke-opacity\w*\s*=\s*(['"])undefined\1/g,"")),e}}),c});//# sourceMappingURL=utils.js.map