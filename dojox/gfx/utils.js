//>>built
define("dojox/gfx/utils",["dojo/_base/kernel","dojo/_base/lang","./_base","dojo/_base/html","dojo/_base/array","dojo/_base/window","dojo/_base/json","dojo/_base/Deferred","dojo/_base/sniff","require","dojo/_base/config"],function(e,t,i,a,r,o,n,d,s,l,u){var m=i.utils={};return t.mixin(m,{forEach:function(t,a,o){o=o||e.global,a.call(o,t),(t instanceof i.Surface||t instanceof i.Group)&&r.forEach(t.children,function(e){m.forEach(e,a,o)})},serialize:function(e){var t,a={},o=e instanceof i.Surface;if(o||e instanceof i.Group){if(a.children=r.map(e.children,m.serialize),o)return a.children}else a.shape=e.getShape();return e.getTransform&&(t=e.getTransform())&&(a.transform=t),e.getStroke&&(t=e.getStroke())&&(a.stroke=t),e.getFill&&(t=e.getFill())&&(a.fill=t),e.getFont&&(t=e.getFont())&&(a.font=t),a},toJson:function(e,t){return n.toJson(m.serialize(e),t)},deserialize:function(e,i){if(i instanceof Array)return r.map(i,t.hitch(null,m.deserialize,e));var a="shape"in i?e.createShape(i.shape):e.createGroup();return"transform"in i&&a.setTransform(i.transform),"stroke"in i&&a.setStroke(i.stroke),"fill"in i&&a.setFill(i.fill),"font"in i&&a.setFont(i.font),"children"in i&&r.forEach(i.children,t.hitch(null,m.deserialize,a)),a},fromJson:function(e,t){return m.deserialize(e,n.fromJson(t))},toSvg:function(e){var t=new d;if("svg"===i.renderer)try{var r=m._cleanSvg(m._innerXML(e.rawNode));t.callback(r)}catch(e){t.errback(e)}else{m._initSvgSerializerDeferred||m._initSvgSerializer();var n=m.toJson(e),s=function(){try{var i=e.getDimensions(),r=i.width,d=i.height,s=m._gfxSvgProxy.document.createElement("div");m._gfxSvgProxy.document.body.appendChild(s),o.withDoc(m._gfxSvgProxy.document,function(){a.style(s,"width",r),a.style(s,"height",d)},this);var l=m._gfxSvgProxy[dojox._scopeName].gfx.createSurface(s,r,d),u=function(e){try{m._gfxSvgProxy[dojox._scopeName].gfx.utils.fromJson(e,n);var i=m._cleanSvg(s.innerHTML);e.clear(),e.destroy(),m._gfxSvgProxy.document.body.removeChild(s),t.callback(i)}catch(e){t.errback(e)}};l.whenLoaded(null,u)}catch(e){t.errback(e)}};m._initSvgSerializerDeferred.fired>0?s():m._initSvgSerializerDeferred.addCallback(s)}return t},_gfxSvgProxy:null,_initSvgSerializerDeferred:null,_svgSerializerInitialized:function(){m._initSvgSerializerDeferred.callback(!0)},_initSvgSerializer:function(){if(!m._initSvgSerializerDeferred){m._initSvgSerializerDeferred=new d;var t=o.doc.createElement("iframe");a.style(t,{display:"none",position:"absolute",width:"1em",height:"1em",top:"-10000px"});var i;s("ie")?t.onreadystatechange=function(){"complete"==t.contentWindow.document.readyState&&(t.onreadystatechange=function(){},i=setInterval(function(){t.contentWindow[e.scopeMap.dojo[1]._scopeName]&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx.utils&&(clearInterval(i),t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._gfxSvgProxy=t.contentWindow,t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._svgSerializerInitialized())},50))}:t.onload=function(){t.onload=function(){},i=setInterval(function(){t.contentWindow[e.scopeMap.dojo[1]._scopeName]&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx&&t.contentWindow[e.scopeMap.dojox[1]._scopeName].gfx.utils&&(clearInterval(i),t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._gfxSvgProxy=t.contentWindow,t.contentWindow.parent[e.scopeMap.dojox[1]._scopeName].gfx.utils._svgSerializerInitialized())},50)};var r=u.dojoxGfxSvgProxyFrameUrl||l.toUrl("dojox/gfx/resources/gfxSvgProxyFrame.html");t.setAttribute("src",r.toString()),o.body().appendChild(t)}},_innerXML:function(e){return e.innerXML?e.innerXML:e.xml?e.xml:"undefined"!=typeof XMLSerializer?(new XMLSerializer).serializeToString(e):null},_cleanSvg:function(e){return e&&(-1==e.indexOf('xmlns="http://www.w3.org/2000/svg"')&&(e=e.substring(4,e.length),e='<svg xmlns="http://www.w3.org/2000/svg"'+e),-1==e.indexOf('xmlns:xlink="http://www.w3.org/1999/xlink"')&&(e=e.substring(4,e.length),e='<svg xmlns:xlink="http://www.w3.org/1999/xlink"'+e),-1===e.indexOf("xlink:href")&&(e=e.replace(/href\s*=/g,"xlink:href=")),e=e.replace(/<img\b([^>]*)>/gi,"<image $1 />"),e=e.replace(/\bdojoGfx\w*\s*=\s*(['"])\w*\1/g,""),e=e.replace(/\b__gfxObject__\s*=\s*(['"])\w*\1/g,""),e=e.replace(/[=]([^"']+?)(\s|>)/g,'="$1"$2'),e=e.replace(/\bstroke-opacity\w*\s*=\s*(['"])undefined\1/g,"")),e}}),m});//# sourceMappingURL=utils.js.map