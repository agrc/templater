//>>built
define("dojox/gfx/canvasWithEvents",["dojo/_base/lang","dojo/_base/declare","dojo/has","dojo/on","dojo/aspect","dojo/touch","dojo/_base/Color","dojo/dom","dojo/dom-geometry","dojo/_base/window","./_base","./canvas","./shape","./matrix"],function(e,t,i,a,r,n,o,s,d,l,h,u,c,m){function f(t){var i={};for(var a in t)"function"==typeof t[a]?i[a]=e.hitch(t,a):i[a]=t[a];return i}i.add("dom-mutableEvents",function(){var e=document.createEvent("UIEvents");try{return Object.defineProperty?Object.defineProperty(e,"type",{value:"foo"}):e.type="foo","foo"===e.type}catch(t){return!1}});var g=h.canvasWithEvents={};g.Shape=t("dojox.gfx.canvasWithEvents.Shape",u.Shape,{_testInputs:function(e,t){if(this.clip||!this.canvasFill&&this.strokeStyle)this._hitTestPixel(e,t);else{this._renderShape(e);for(var i=t.length,a=this.getTransform(),r=0;i>r;++r){var n=t[r];if(!n.target){var o=n.x,s=n.y,d=a?m.multiplyPoint(m.invert(a),o,s):{x:o,y:s};n.target=this._hitTestGeometry(e,d.x,d.y)}}}},_hitTestPixel:function(e,t){for(var i=0;i<t.length;++i){var a=t[i];if(!a.target){var r=a.x,n=a.y;e.clearRect(0,0,1,1),e.save(),e.translate(-r,-n),this._render(e,!0),a.target=e.getImageData(0,0,1,1).data[0]?this:null,e.restore()}}},_hitTestGeometry:function(e,t,i){return e.isPointInPath(t,i)?this:null},_renderFill:function(e,t){return e.pickingMode?void("canvasFill"in this&&t&&e.fill()):void this.inherited(arguments)},_renderStroke:function(e){if(this.strokeStyle&&e.pickingMode){var t=this.strokeStyle.color;try{this.strokeStyle.color=new o(e.strokeStyle),this.inherited(arguments)}finally{this.strokeStyle.color=t}}else this.inherited(arguments)},getEventSource:function(){return this.surface.rawNode},on:function(e,t){var i=this.rawNode;return a(this.getEventSource(),e,function(e){s.isDescendant(e.target,i)&&t.apply(i,arguments)})},connect:function(t,i,a){return"on"==t.substring(0,2)&&(t=t.substring(2)),this.on(t,a?e.hitch(i,a):e.hitch(null,i))},disconnect:function(e){e.remove()}}),g.Group=t("dojox.gfx.canvasWithEvents.Group",[g.Shape,u.Group],{_testInputs:function(e,t){var i,a,r,n=this.children,o=this.getTransform();if(0!==n.length){var s=[];for(i=0;i<t.length;++i)if(r=t[i],s[i]={x:r.x,y:r.y},!r.target){var d=r.x,l=r.y,h=o?m.multiplyPoint(m.invert(o),d,l):{x:d,y:l};r.x=h.x,r.y=h.y}for(i=n.length-1;i>=0;--i){n[i]._testInputs(e,t);var u=!0;for(a=0;a<t.length;++a)if(null==t[a].target){u=!1;break}if(u)break}if(this.clip)for(i=0;i<t.length;++i)r=t[i],r.x=s[i].x,r.y=s[i].y,r.target&&(e.clearRect(0,0,1,1),e.save(),e.translate(-r.x,-r.y),this._render(e,!0),e.getImageData(0,0,1,1).data[0]||(r.target=null),e.restore());else for(i=0;i<t.length;++i)t[i].x=s[i].x,t[i].y=s[i].y}}}),g.Image=t("dojox.gfx.canvasWithEvents.Image",[g.Shape,u.Image],{_renderShape:function(e){var t=this.shape;e.pickingMode?e.fillRect(t.x,t.y,t.width,t.height):this.inherited(arguments)},_hitTestGeometry:function(e,t,i){var a=this.shape;return t>=a.x&&t<=a.x+a.width&&i>=a.y&&i<=a.y+a.height?this:null}}),g.Text=t("dojox.gfx.canvasWithEvents.Text",[g.Shape,u.Text],{_testInputs:function(e,t){return this._hitTestPixel(e,t)}}),g.Rect=t("dojox.gfx.canvasWithEvents.Rect",[g.Shape,u.Rect],{}),g.Circle=t("dojox.gfx.canvasWithEvents.Circle",[g.Shape,u.Circle],{}),g.Ellipse=t("dojox.gfx.canvasWithEvents.Ellipse",[g.Shape,u.Ellipse],{}),g.Line=t("dojox.gfx.canvasWithEvents.Line",[g.Shape,u.Line],{}),g.Polyline=t("dojox.gfx.canvasWithEvents.Polyline",[g.Shape,u.Polyline],{}),g.Path=t("dojox.gfx.canvasWithEvents.Path",[g.Shape,u.Path],{}),g.TextPath=t("dojox.gfx.canvasWithEvents.TextPath",[g.Shape,u.TextPath],{});var p=null;g.Surface=t("dojox.gfx.canvasWithEvents.Surface",u.Surface,{constructor:function(){this._elementUnderPointer=null},fixTarget:function(e){var t=this;return function(a){var r;if(p)if(i("dom-mutableEvents"))Object.defineProperties(a,p);else{a=f(a);for(r in p)a[r]=p[r].value}else{var n=t.getEventSource(),o=n._dojoElementFromPoint((a.changedTouches?a.changedTouches[0]:a).pageX,(a.changedTouches?a.changedTouches[0]:a).pageY);i("dom-mutableEvents")?Object.defineProperties(a,{target:{value:o,configurable:!0,enumerable:!0},gfxTarget:{value:o.shape,configurable:!0,enumerable:!0}}):(a=f(a),a.target=o,a.gfxTarget=o.shape)}if(i("touch")){if(a.changedTouches&&a.changedTouches[0]){var s=a.changedTouches[0];for(r in s)a[r]||(i("dom-mutableEvents")?Object.defineProperty(a,r,{value:s[r],configurable:!0,enumerable:!0}):a[r]=s[r])}a.corrected=a}return e.call(this,a)}},_checkPointer:function(e){function t(t,i,r){for(var n,s=e.bubbles,d=0;n=t[d];++d)p={target:{value:i,configurable:!0,enumerable:!0},gfxTarget:{value:i.shape,configurable:!0,enumerable:!0},relatedTarget:{value:r,configurable:!0,enumerable:!0}},Object.defineProperty(e,"bubbles",{value:n.bubbles,configurable:!0,enumerable:!0}),a.emit(o,n.type,e),p=null;Object.defineProperty(e,"bubbles",{value:s,configurable:!0,enumerable:!0})}var i={out:[{type:"mouseout",bubbles:!0},{type:"MSPointerOut",bubbles:!0},{type:"pointerout",bubbles:!0},{type:"mouseleave",bubbles:!1},{type:"dojotouchout",bubbles:!0}],over:[{type:"mouseover",bubbles:!0},{type:"MSPointerOver",bubbles:!0},{type:"pointerover",bubbles:!0},{type:"mouseenter",bubbles:!1},{type:"dojotouchover",bubbles:!0}]},r=e.target,n=this._elementUnderPointer,o=this.getEventSource();n!==r&&(n&&n!==o&&t(i.out,n,r),this._elementUnderPointer=r,r&&r!==o&&t(i.over,r,n))},getEventSource:function(){return this.rawNode},on:function(e,t){return a(this.getEventSource(),e,t)},connect:function(t,i,a){return"on"==t.substring(0,2)&&(t=t.substring(2)),this.on(t,a?e.hitch(i,a):i)},disconnect:function(e){e.remove()},_initMirrorCanvas:function(){this._initMirrorCanvas=function(){};var t=this.getEventSource(),r=this.mirrorCanvas=t.ownerDocument.createElement("canvas");r.width=1,r.height=1,r.style.position="absolute",r.style.left=r.style.top="-99999px",t.parentNode.appendChild(r);var n="mousemove";i("pointer-events")?n="pointermove":i("MSPointer")?n="MSPointerMove":i("touch-events")&&(n="touchmove"),a(t,n,e.hitch(this,"_checkPointer"))},destroy:function(){this.mirrorCanvas&&(this.mirrorCanvas.parentNode.removeChild(this.mirrorCanvas),this.mirrorCanvas=null),this.inherited(arguments)}}),g.createSurface=function(e,t,i){if(!t&&!i){var a=d.position(e);t=t||a.w,i=i||a.h}"number"==typeof t&&(t+="px"),"number"==typeof i&&(i+="px");var r=new g.Surface,n=s.byId(e),o=n.ownerDocument.createElement("canvas");o.width=h.normalizedLength(t),o.height=h.normalizedLength(i),n.appendChild(o),r.rawNode=o,r._parent=n,r.surface=r,h._base._fixMsTouchAction(r);var l=o.addEventListener,u=o.removeEventListener,c=[],m=function(e,t,i){r._initMirrorCanvas();var a=r.fixTarget(t);c.push({original:t,actual:a}),l.call(this,e,a,i)},f=function(e,t,i){for(var a,r=0;a=c[r];++r)if(a.original===t){u.call(this,e,a.actual,i),c.splice(r,1);break}};try{Object.defineProperties(o,{addEventListener:{value:m,enumerable:!0,configurable:!0},removeEventListener:{value:f}})}catch(p){o.addEventListener=m,o.removeEventListener=f}return o._dojoElementFromPoint=function(e,t){if(!r.mirrorCanvas)return this;var i=d.position(this,!0);e-=i.x,t-=i.y;var a=r.mirrorCanvas,n=a.getContext("2d"),o=r.children;n.clearRect(0,0,a.width,a.height),n.save(),n.strokeStyle="rgba(127,127,127,1.0)",n.fillStyle="rgba(127,127,127,1.0)",n.pickingMode=!0;for(var s=[{x:e,y:t}],l=o.length-1;l>=0&&(o[l]._testInputs(n,s),!s[0].target);l--);return n.restore(),s[0]&&s[0].target?s[0].target.rawNode:this},r};var y={createObject:function(){var e=this.inherited(arguments),t={};return e.rawNode={shape:e,ownerDocument:e.surface.rawNode.ownerDocument,parentNode:e.parent?e.parent.rawNode:null,addEventListener:function(i,a){for(var n,o=t[i]=t[i]||[],s=0;n=o[s];++s)if(n.listener===a)return;o.push({listener:a,handle:r.after(this,"on"+i,e.surface.fixTarget(a),!0)})},removeEventListener:function(e,i){var a=t[e];if(a)for(var r,n=0;r=a[n];++n)if(r.listener===i)return r.handle.remove(),void a.splice(n,1)}},e}};return g.Group.extend(y),g.Surface.extend(y),g});//# sourceMappingURL=canvasWithEvents.js.map