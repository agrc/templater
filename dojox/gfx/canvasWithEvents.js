//>>built
define("dojox/gfx/canvasWithEvents",["dojo/_base/lang","dojo/_base/declare","dojo/has","dojo/on","dojo/aspect","dojo/touch","dojo/_base/Color","dojo/dom","dojo/dom-geometry","dojo/_base/window","./_base","./canvas","./shape","./matrix"],function(e,t,i,r,a,o,n,s,d,l,u,c,h,f){function m(t){var i={};for(var r in t)"function"==typeof t[r]?i[r]=e.hitch(t,r):i[r]=t[r];return i}i.add("dom-mutableEvents",function(){var e=document.createEvent("UIEvents");try{return Object.defineProperty?Object.defineProperty(e,"type",{value:"foo"}):e.type="foo","foo"===e.type}catch(e){return!1}});var p=u.canvasWithEvents={};p.Shape=t("dojox.gfx.canvasWithEvents.Shape",c.Shape,{_testInputs:function(e,t){if(this.clip||!this.canvasFill&&this.strokeStyle)this._hitTestPixel(e,t);else{this._renderShape(e);for(var i=t.length,r=this.getTransform(),a=0;a<i;++a){var o=t[a];if(!o.target){var n=o.x,s=o.y,d=r?f.multiplyPoint(f.invert(r),n,s):{x:n,y:s};o.target=this._hitTestGeometry(e,d.x,d.y)}}}},_hitTestPixel:function(e,t){for(var i=0;i<t.length;++i){var r=t[i];if(!r.target){var a=r.x,o=r.y;e.clearRect(0,0,1,1),e.save(),e.translate(-a,-o),this._render(e,!0),r.target=e.getImageData(0,0,1,1).data[0]?this:null,e.restore()}}},_hitTestGeometry:function(e,t,i){return e.isPointInPath(t,i)?this:null},_renderFill:function(e,t){if(e.pickingMode)return void("canvasFill"in this&&t&&e.fill());this.inherited(arguments)},_renderStroke:function(e){if(this.strokeStyle&&e.pickingMode){var t=this.strokeStyle.color;try{this.strokeStyle.color=new n(e.strokeStyle),this.inherited(arguments)}finally{this.strokeStyle.color=t}}else this.inherited(arguments)},getEventSource:function(){return this.surface.rawNode},on:function(e,t){var i=this.rawNode;return r(this.getEventSource(),e,function(e){s.isDescendant(e.target,i)&&t.apply(i,arguments)})},connect:function(t,i,r){return"on"==t.substring(0,2)&&(t=t.substring(2)),this.on(t,r?e.hitch(i,r):e.hitch(null,i))},disconnect:function(e){e.remove()}}),p.Group=t("dojox.gfx.canvasWithEvents.Group",[p.Shape,c.Group],{_testInputs:function(e,t){var i,r,a,o=this.children,n=this.getTransform();if(0!==o.length){var s=[];for(i=0;i<t.length;++i)if(a=t[i],s[i]={x:a.x,y:a.y},!a.target){var d=a.x,l=a.y,u=n?f.multiplyPoint(f.invert(n),d,l):{x:d,y:l};a.x=u.x,a.y=u.y}for(i=o.length-1;i>=0;--i){o[i]._testInputs(e,t);var c=!0;for(r=0;r<t.length;++r)if(null==t[r].target){c=!1;break}if(c)break}if(this.clip)for(i=0;i<t.length;++i)a=t[i],a.x=s[i].x,a.y=s[i].y,a.target&&(e.clearRect(0,0,1,1),e.save(),e.translate(-a.x,-a.y),this._render(e,!0),e.getImageData(0,0,1,1).data[0]||(a.target=null),e.restore());else for(i=0;i<t.length;++i)t[i].x=s[i].x,t[i].y=s[i].y}}}),p.Image=t("dojox.gfx.canvasWithEvents.Image",[p.Shape,c.Image],{_renderShape:function(e){var t=this.shape;e.pickingMode?e.fillRect(t.x,t.y,t.width,t.height):this.inherited(arguments)},_hitTestGeometry:function(e,t,i){var r=this.shape;return t>=r.x&&t<=r.x+r.width&&i>=r.y&&i<=r.y+r.height?this:null}}),p.Text=t("dojox.gfx.canvasWithEvents.Text",[p.Shape,c.Text],{_testInputs:function(e,t){return this._hitTestPixel(e,t)}}),p.Rect=t("dojox.gfx.canvasWithEvents.Rect",[p.Shape,c.Rect],{}),p.Circle=t("dojox.gfx.canvasWithEvents.Circle",[p.Shape,c.Circle],{}),p.Ellipse=t("dojox.gfx.canvasWithEvents.Ellipse",[p.Shape,c.Ellipse],{}),p.Line=t("dojox.gfx.canvasWithEvents.Line",[p.Shape,c.Line],{}),p.Polyline=t("dojox.gfx.canvasWithEvents.Polyline",[p.Shape,c.Polyline],{}),p.Path=t("dojox.gfx.canvasWithEvents.Path",[p.Shape,c.Path],{}),p.TextPath=t("dojox.gfx.canvasWithEvents.TextPath",[p.Shape,c.TextPath],{});var g=null;p.Surface=t("dojox.gfx.canvasWithEvents.Surface",c.Surface,{constructor:function(){this._elementUnderPointer=null},fixTarget:function(e){var t=this;return function(r){var a;if(g)if(i("dom-mutableEvents"))Object.defineProperties(r,g);else{r=m(r);for(a in g)r[a]=g[a].value}else{var o=t.getEventSource(),n=o._dojoElementFromPoint((r.changedTouches?r.changedTouches[0]:r).pageX,(r.changedTouches?r.changedTouches[0]:r).pageY);i("dom-mutableEvents")?Object.defineProperties(r,{target:{value:n,configurable:!0,enumerable:!0},gfxTarget:{value:n.shape,configurable:!0,enumerable:!0}}):(r=m(r),r.target=n,r.gfxTarget=n.shape)}if(i("touch")){if(r.changedTouches&&r.changedTouches[0]){var s=r.changedTouches[0];for(a in s)r[a]||(i("dom-mutableEvents")?Object.defineProperty(r,a,{value:s[a],configurable:!0,enumerable:!0}):r[a]=s[a])}r.corrected=r}return e.call(this,r)}},_checkPointer:function(e){function t(t,i,a){for(var o,s=e.bubbles,d=0;o=t[d];++d)g={target:{value:i,configurable:!0,enumerable:!0},gfxTarget:{value:i.shape,configurable:!0,enumerable:!0},relatedTarget:{value:a,configurable:!0,enumerable:!0}},Object.defineProperty(e,"bubbles",{value:o.bubbles,configurable:!0,enumerable:!0}),r.emit(n,o.type,e),g=null;Object.defineProperty(e,"bubbles",{value:s,configurable:!0,enumerable:!0})}var i={out:[{type:"mouseout",bubbles:!0},{type:"MSPointerOut",bubbles:!0},{type:"pointerout",bubbles:!0},{type:"mouseleave",bubbles:!1},{type:"dojotouchout",bubbles:!0}],over:[{type:"mouseover",bubbles:!0},{type:"MSPointerOver",bubbles:!0},{type:"pointerover",bubbles:!0},{type:"mouseenter",bubbles:!1},{type:"dojotouchover",bubbles:!0}]},a=e.target,o=this._elementUnderPointer,n=this.getEventSource();o!==a&&(o&&o!==n&&t(i.out,o,a),this._elementUnderPointer=a,a&&a!==n&&t(i.over,a,o))},getEventSource:function(){return this.rawNode},on:function(e,t){return r(this.getEventSource(),e,t)},connect:function(t,i,r){return"on"==t.substring(0,2)&&(t=t.substring(2)),this.on(t,r?e.hitch(i,r):i)},disconnect:function(e){e.remove()},_initMirrorCanvas:function(){this._initMirrorCanvas=function(){};var t=this.getEventSource(),a=this.mirrorCanvas=t.ownerDocument.createElement("canvas");a.width=1,a.height=1,a.style.position="absolute",a.style.left=a.style.top="-99999px",t.parentNode.appendChild(a);var o="mousemove";i("pointer-events")?o="pointermove":i("MSPointer")?o="MSPointerMove":i("touch-events")&&(o="touchmove"),r(t,o,e.hitch(this,"_checkPointer"))},destroy:function(){this.mirrorCanvas&&(this.mirrorCanvas.parentNode.removeChild(this.mirrorCanvas),this.mirrorCanvas=null),this.inherited(arguments)}}),p.createSurface=function(e,t,i){if(!t&&!i){var r=d.position(e);t=t||r.w,i=i||r.h}"number"==typeof t&&(t+="px"),"number"==typeof i&&(i+="px");var a=new p.Surface,o=s.byId(e),n=o.ownerDocument.createElement("canvas");n.width=u.normalizedLength(t),n.height=u.normalizedLength(i),o.appendChild(n),a.rawNode=n,a._parent=o,a.surface=a,u._base._fixMsTouchAction(a);var l=n.addEventListener,c=n.removeEventListener,h=[],f=function(e,t,i){a._initMirrorCanvas();var r=a.fixTarget(t);h.push({original:t,actual:r}),l.call(this,e,r,i)},m=function(e,t,i){for(var r,a=0;r=h[a];++a)if(r.original===t){c.call(this,e,r.actual,i),h.splice(a,1);break}};try{Object.defineProperties(n,{addEventListener:{value:f,enumerable:!0,configurable:!0},removeEventListener:{value:m}})}catch(e){n.addEventListener=f,n.removeEventListener=m}return n._dojoElementFromPoint=function(e,t){if(!a.mirrorCanvas)return this;var i=d.position(this,!0);e-=i.x,t-=i.y;var r=a.mirrorCanvas,o=r.getContext("2d"),n=a.children;o.clearRect(0,0,r.width,r.height),o.save(),o.strokeStyle="rgba(127,127,127,1.0)",o.fillStyle="rgba(127,127,127,1.0)",o.pickingMode=!0;for(var s=[{x:e,y:t}],l=n.length-1;l>=0&&(n[l]._testInputs(o,s),!s[0].target);l--);return o.restore(),s[0]&&s[0].target?s[0].target.rawNode:this},a};var y={createObject:function(){var e=this.inherited(arguments),t={};return e.rawNode={shape:e,ownerDocument:e.surface.rawNode.ownerDocument,parentNode:e.parent?e.parent.rawNode:null,addEventListener:function(i,r){for(var o,n=t[i]=t[i]||[],s=0;o=n[s];++s)if(o.listener===r)return;n.push({listener:r,handle:a.after(this,"on"+i,e.surface.fixTarget(r),!0)})},removeEventListener:function(e,i){var r=t[e];if(r)for(var a,o=0;a=r[o];++o)if(a.listener===i)return a.handle.remove(),void r.splice(o,1)}},e}};return p.Group.extend(y),p.Surface.extend(y),p});//# sourceMappingURL=canvasWithEvents.js.map