//>>built
define("dojox/gfx/canvasWithEvents",["dojo/_base/lang","dojo/_base/declare","dojo/has","dojo/on","dojo/aspect","dojo/touch","dojo/_base/Color","dojo/dom","dojo/dom-geometry","dojo/_base/window","./_base","./canvas","./shape","./matrix"],function(e,t,a,i,n,r,o,s,d,l,h,u,m,c){function f(t){var a={};for(var i in t)"function"==typeof t[i]?a[i]=e.hitch(t,i):a[i]=t[i];return a}a.add("dom-mutableEvents",function(){var e=document.createEvent("UIEvents");try{return Object.defineProperty?Object.defineProperty(e,"type",{value:"foo"}):e.type="foo","foo"===e.type}catch(t){return!1}});var g=h.canvasWithEvents={};g.Shape=t("dojox.gfx.canvasWithEvents.Shape",u.Shape,{_testInputs:function(e,t){if(this.clip||!this.canvasFill&&this.strokeStyle)this._hitTestPixel(e,t);else{this._renderShape(e);for(var a=t.length,i=this.getTransform(),n=0;a>n;++n){var r=t[n];if(!r.target){var o=r.x,s=r.y,d=i?c.multiplyPoint(c.invert(i),o,s):{x:o,y:s};r.target=this._hitTestGeometry(e,d.x,d.y)}}}},_hitTestPixel:function(e,t){for(var a=0;a<t.length;++a){var i=t[a];if(!i.target){var n=i.x,r=i.y;e.clearRect(0,0,1,1),e.save(),e.translate(-n,-r),this._render(e,!0),i.target=e.getImageData(0,0,1,1).data[0]?this:null,e.restore()}}},_hitTestGeometry:function(e,t,a){return e.isPointInPath(t,a)?this:null},_renderFill:function(e,t){return e.pickingMode?void("canvasFill"in this&&t&&e.fill()):void this.inherited(arguments)},_renderStroke:function(e){if(this.strokeStyle&&e.pickingMode){var t=this.strokeStyle.color;try{this.strokeStyle.color=new o(e.strokeStyle),this.inherited(arguments)}finally{this.strokeStyle.color=t}}else this.inherited(arguments)},getEventSource:function(){return this.surface.rawNode},on:function(e,t){var a=this.rawNode;return i(this.getEventSource(),e,function(e){s.isDescendant(e.target,a)&&t.apply(a,arguments)})},connect:function(t,a,i){return"on"==t.substring(0,2)&&(t=t.substring(2)),this.on(t,i?e.hitch(a,i):e.hitch(null,a))},disconnect:function(e){e.remove()}}),g.Group=t("dojox.gfx.canvasWithEvents.Group",[g.Shape,u.Group],{_testInputs:function(e,t){var a,i,n,r=this.children,o=this.getTransform();if(0!==r.length){var s=[];for(a=0;a<t.length;++a)if(n=t[a],s[a]={x:n.x,y:n.y},!n.target){var d=n.x,l=n.y,h=o?c.multiplyPoint(c.invert(o),d,l):{x:d,y:l};n.x=h.x,n.y=h.y}for(a=r.length-1;a>=0;--a){r[a]._testInputs(e,t);var u=!0;for(i=0;i<t.length;++i)if(null==t[i].target){u=!1;break}if(u)break}if(this.clip)for(a=0;a<t.length;++a)n=t[a],n.x=s[a].x,n.y=s[a].y,n.target&&(e.clearRect(0,0,1,1),e.save(),e.translate(-n.x,-n.y),this._render(e,!0),e.getImageData(0,0,1,1).data[0]||(n.target=null),e.restore());else for(a=0;a<t.length;++a)t[a].x=s[a].x,t[a].y=s[a].y}}}),g.Image=t("dojox.gfx.canvasWithEvents.Image",[g.Shape,u.Image],{_renderShape:function(e){var t=this.shape;e.pickingMode?e.fillRect(t.x,t.y,t.width,t.height):this.inherited(arguments)},_hitTestGeometry:function(e,t,a){var i=this.shape;return t>=i.x&&t<=i.x+i.width&&a>=i.y&&a<=i.y+i.height?this:null}}),g.Text=t("dojox.gfx.canvasWithEvents.Text",[g.Shape,u.Text],{_testInputs:function(e,t){return this._hitTestPixel(e,t)}}),g.Rect=t("dojox.gfx.canvasWithEvents.Rect",[g.Shape,u.Rect],{}),g.Circle=t("dojox.gfx.canvasWithEvents.Circle",[g.Shape,u.Circle],{}),g.Ellipse=t("dojox.gfx.canvasWithEvents.Ellipse",[g.Shape,u.Ellipse],{}),g.Line=t("dojox.gfx.canvasWithEvents.Line",[g.Shape,u.Line],{}),g.Polyline=t("dojox.gfx.canvasWithEvents.Polyline",[g.Shape,u.Polyline],{}),g.Path=t("dojox.gfx.canvasWithEvents.Path",[g.Shape,u.Path],{}),g.TextPath=t("dojox.gfx.canvasWithEvents.TextPath",[g.Shape,u.TextPath],{});var p=null;g.Surface=t("dojox.gfx.canvasWithEvents.Surface",u.Surface,{constructor:function(){this._elementUnderPointer=null},fixTarget:function(e){var t=this;return function(i){var n;if(p)if(a("dom-mutableEvents"))Object.defineProperties(i,p);else{i=f(i);for(n in p)i[n]=p[n].value}else{var r=t.getEventSource(),o=r._dojoElementFromPoint((i.changedTouches?i.changedTouches[0]:i).pageX,(i.changedTouches?i.changedTouches[0]:i).pageY);a("dom-mutableEvents")?Object.defineProperties(i,{target:{value:o,configurable:!0,enumerable:!0},gfxTarget:{value:o.shape,configurable:!0,enumerable:!0}}):(i=f(i),i.target=o,i.gfxTarget=o.shape)}if(a("touch")){if(i.changedTouches&&i.changedTouches[0]){var s=i.changedTouches[0];for(n in s)i[n]||(a("dom-mutableEvents")?Object.defineProperty(i,n,{value:s[n],configurable:!0,enumerable:!0}):i[n]=s[n])}i.corrected=i}return e.call(this,i)}},_checkPointer:function(e){function t(t,a,n){for(var r,s=e.bubbles,d=0;r=t[d];++d)p={target:{value:a,configurable:!0,enumerable:!0},gfxTarget:{value:a.shape,configurable:!0,enumerable:!0},relatedTarget:{value:n,configurable:!0,enumerable:!0}},Object.defineProperty(e,"bubbles",{value:r.bubbles,configurable:!0,enumerable:!0}),i.emit(o,r.type,e),p=null;Object.defineProperty(e,"bubbles",{value:s,configurable:!0,enumerable:!0})}var a={out:[{type:"mouseout",bubbles:!0},{type:"MSPointerOut",bubbles:!0},{type:"pointerout",bubbles:!0},{type:"mouseleave",bubbles:!1},{type:"dojotouchout",bubbles:!0}],over:[{type:"mouseover",bubbles:!0},{type:"MSPointerOver",bubbles:!0},{type:"pointerover",bubbles:!0},{type:"mouseenter",bubbles:!1},{type:"dojotouchover",bubbles:!0}]},n=e.target,r=this._elementUnderPointer,o=this.getEventSource();r!==n&&(r&&r!==o&&t(a.out,r,n),this._elementUnderPointer=n,n&&n!==o&&t(a.over,n,r))},getEventSource:function(){return this.rawNode},on:function(e,t){return i(this.getEventSource(),e,t)},connect:function(t,a,i){return"on"==t.substring(0,2)&&(t=t.substring(2)),this.on(t,i?e.hitch(a,i):a)},disconnect:function(e){e.remove()},_initMirrorCanvas:function(){this._initMirrorCanvas=function(){};var t=this.getEventSource(),n=this.mirrorCanvas=t.ownerDocument.createElement("canvas");n.width=1,n.height=1,n.style.position="absolute",n.style.left=n.style.top="-99999px",t.parentNode.appendChild(n);var r="mousemove";a("pointer-events")?r="pointermove":a("MSPointer")?r="MSPointerMove":a("touch-events")&&(r="touchmove"),i(t,r,e.hitch(this,"_checkPointer"))},destroy:function(){this.mirrorCanvas&&(this.mirrorCanvas.parentNode.removeChild(this.mirrorCanvas),this.mirrorCanvas=null),this.inherited(arguments)}}),g.createSurface=function(e,t,a){if(!t&&!a){var i=d.position(e);t=t||i.w,a=a||i.h}"number"==typeof t&&(t+="px"),"number"==typeof a&&(a+="px");var n=new g.Surface,r=s.byId(e),o=r.ownerDocument.createElement("canvas");o.width=h.normalizedLength(t),o.height=h.normalizedLength(a),r.appendChild(o),n.rawNode=o,n._parent=r,n.surface=n,h._base._fixMsTouchAction(n);var l=o.addEventListener,u=o.removeEventListener,m=[],c=function(e,t,a){n._initMirrorCanvas();var i=n.fixTarget(t);m.push({original:t,actual:i}),l.call(this,e,i,a)},f=function(e,t,a){for(var i,n=0;i=m[n];++n)if(i.original===t){u.call(this,e,i.actual,a),m.splice(n,1);break}};try{Object.defineProperties(o,{addEventListener:{value:c,enumerable:!0,configurable:!0},removeEventListener:{value:f}})}catch(p){o.addEventListener=c,o.removeEventListener=f}return o._dojoElementFromPoint=function(e,t){if(!n.mirrorCanvas)return this;var a=d.position(this,!0);e-=a.x,t-=a.y;var i=n.mirrorCanvas,r=i.getContext("2d"),o=n.children;r.clearRect(0,0,i.width,i.height),r.save(),r.strokeStyle="rgba(127,127,127,1.0)",r.fillStyle="rgba(127,127,127,1.0)",r.pickingMode=!0;for(var s=[{x:e,y:t}],l=o.length-1;l>=0&&(o[l]._testInputs(r,s),!s[0].target);l--);return r.restore(),s[0]&&s[0].target?s[0].target.rawNode:this},n};var y={createObject:function(){var e=this.inherited(arguments),t={};return e.rawNode={shape:e,ownerDocument:e.surface.rawNode.ownerDocument,parentNode:e.parent?e.parent.rawNode:null,addEventListener:function(a,i){for(var r,o=t[a]=t[a]||[],s=0;r=o[s];++s)if(r.listener===i)return;o.push({listener:i,handle:n.after(this,"on"+a,e.surface.fixTarget(i),!0)})},removeEventListener:function(e,a){var i=t[e];if(i)for(var n,r=0;n=i[r];++r)if(n.listener===a)return n.handle.remove(),void i.splice(r,1)}},e}};return g.Group.extend(y),g.Surface.extend(y),g});//# sourceMappingURL=canvasWithEvents.js.map