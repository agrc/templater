//>>built
define("dojox/gfx/VectorText",["dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/loader","dojo/_base/xhr","./_base","dojox/xml/DomParser","dojox/html/metrics","./matrix"],function(e,t,i,a,r,n,o,s,d){var l=function(e){var t;return r.get({url:e,sync:!0,load:function(e){t=e}}),t};return e.getObject("dojox.gfx.VectorText",!0),e.mixin(n,{vectorFontFitting:{NONE:0,FLOW:1,FIT:2},defaultVectorText:{type:"vectortext",x:0,y:0,width:null,height:null,text:"",align:"start",decoration:"none",fitting:0,leading:1.5},defaultVectorFont:{type:"vectorfont",size:"10pt",family:null},_vectorFontCache:{},_svgFontCache:{},getVectorFont:function(e){return n._vectorFontCache[e]?n._vectorFontCache[e]:new n.VectorFont(e)}}),t("dojox.gfx.VectorFont",null,{_entityRe:/&(quot|apos|lt|gt|amp|#x[^;]+|#\d+);/g,_decodeEntitySequence:function(e){if(e.match(this._entityRe)){for(var t,i={amp:"&",apos:"'",quot:'"',lt:"<",gt:">"},a="";null!==(t=this._entityRe.exec(e));)a+="x"==t[1].charAt(1)?String.fromCharCode(parseInt(t[1].slice(2),16)):isNaN(parseInt(t[1].slice(1),10))?i[t[1]]||"":String.fromCharCode(parseInt(t[1].slice(1),10));return a}},_parse:function(t,a){var r=n._svgFontCache[a]||o.parse(t),s=r.documentElement.byName("font")[0],d=r.documentElement.byName("font-face")[0],l=parseFloat(d.getAttribute("units-per-em")||1e3,10),h={x:parseFloat(s.getAttribute("horiz-adv-x"),10),y:parseFloat(s.getAttribute("vert-adv-y")||0,10)};h.y||(h.y=l);var u={horiz:{x:parseFloat(s.getAttribute("horiz-origin-x")||0,10),y:parseFloat(s.getAttribute("horiz-origin-y")||0,10)},vert:{x:parseFloat(s.getAttribute("vert-origin-x")||0,10),y:parseFloat(s.getAttribute("vert-origin-y")||0,10)}},c=d.getAttribute("font-family"),m=d.getAttribute("font-style")||"all",f=d.getAttribute("font-variant")||"normal",g=d.getAttribute("font-weight")||"all",p=d.getAttribute("font-stretch")||"normal",y=d.getAttribute("unicode-range")||"U+0-10FFFF",v=(d.getAttribute("panose-1")||"0 0 0 0 0 0 0 0 0 0",d.getAttribute("cap-height"),parseFloat(d.getAttribute("ascent")||l-u.vert.y,10)),b=parseFloat(d.getAttribute("descent")||u.vert.y,10),_={},M=c;if(d.byName("font-face-name")[0]&&(M=d.byName("font-face-name")[0].getAttribute("name")),!n._vectorFontCache[M]){i.forEach(["alphabetic","ideographic","mathematical","hanging"],function(e){var t=d.getAttribute(e);null!==t&&(_[e]=parseFloat(t,10))});var k=parseFloat(r.documentElement.byName("missing-glyph")[0].getAttribute("horiz-adv-x")||h.x,10),x={},w={},j=r.documentElement.byName("glyph");i.forEach(j,function(e){var t=e.getAttribute("unicode"),i=e.getAttribute("glyph-name"),a=parseFloat(e.getAttribute("horiz-adv-x")||h.x,10),r=e.getAttribute("d");t.match(this._entityRe)&&(t=this._decodeEntitySequence(t));var n={code:t,name:i,xAdvance:a,path:r};x[t]=n,w[i]=n},this);var I=r.documentElement.byName("hkern");i.forEach(I,function(e,t){var i,a=-parseInt(e.getAttribute("k"),10),r=e.getAttribute("u1"),n=e.getAttribute("g1"),o=e.getAttribute("u2"),s=e.getAttribute("g2");r?(r=this._decodeEntitySequence(r),x[r]&&(i=x[r])):w[n]&&(i=w[n]),i&&(i.kern||(i.kern={}),o?(o=this._decodeEntitySequence(o),i.kern[o]={x:a}):w[s]&&(i.kern[w[s].code]={x:a}))},this),e.mixin(this,{family:c,name:M,style:m,variant:f,weight:g,stretch:p,range:y,viewbox:{width:l,height:l},origin:u,advance:e.mixin(h,{missing:{x:k,y:k}}),ascent:v,descent:b,baseline:_,glyphs:x}),n._vectorFontCache[M]=this,n._vectorFontCache[a]=this,M==c||n._vectorFontCache[c]||(n._vectorFontCache[c]=this),n._svgFontCache[a]||(n._svgFontCache[a]=r)}},_clean:function(){var e=this.name,t=this.family;return i.forEach(["family","name","style","variant","weight","stretch","range","viewbox","origin","advance","ascent","descent","baseline","glyphs"],function(e){try{delete this[e]}catch(t){}},this),n._vectorFontCache[e]&&delete n._vectorFontCache[e],n._vectorFontCache[t]&&delete n._vectorFontCache[t],this},constructor:function(e){this._defaultLeading=1.5,void 0!==e&&this.load(e)},load:function(e){return this.onLoadBegin(e.toString()),this._parse(n._svgFontCache[e.toString()]||l(e.toString()),e.toString()),this.onLoad(this),this},initialized:function(){return null!==this.glyphs},_round:function(e){return Math.round(1e3*e)/1e3},_leading:function(e){return this.viewbox.height*(e||this._defaultLeading)},_normalize:function(e){return e.replace(/\s+/g,String.fromCharCode(32))},_getWidth:function(e){var t=0,a=0,r=null;return i.forEach(e,function(i,n){a=i.xAdvance,e[n]&&i.kern&&i.kern[e[n].code]&&(a+=i.kern[e[n].code].x),t+=a,r=i}),r&&" "==r.code&&(t-=r.xAdvance),this._round(t)},_getLongestLine:function(e){var t=0,a=0;return i.forEach(e,function(e,i){var r=Math.max(t,this._getWidth(e));r>t&&(t=r,a=i)},this),{width:t,index:a,line:e[a]}},_trim:function(t){var a=function(e){e.length&&(" "==e[e.length-1].code&&e.splice(e.length-1,1),e.length&&" "==e[0].code&&e.splice(0,1))};return e.isArray(t[0])?i.forEach(t,a):a(t),t},_split:function(e,t){for(var i=this._getWidth(e),a=Math.floor(i/t),r=[],n=0,o=[],s=!1,d=0,l=e.length;l>d;d++){if(" "==e[d].code&&(s=!0),n+=e[d].xAdvance,l>d+1&&e[d].kern&&e[d].kern[e[d+1].code]&&(n+=e[d].kern[e[d+1].code].x),n>=a){for(var h=e[d];s&&" "!=h.code&&d>=0;)h=o.pop(),d--;r.push(o),o=[],n=0,s=!1}o.push(e[d])}return o.length&&r.push(o),this._trim(r)},_getSizeFactor:function(e){e+="";var t=s.getCachedFontMeasurements(),i=this.viewbox.height,a=t["1em"],r=parseFloat(e,10);return e.indexOf("em")>-1?this._round(t["1em"]*r/i):e.indexOf("ex")>-1?this._round(t["1ex"]*r/i):e.indexOf("pt")>-1?this._round(t["12pt"]/12*r/i):e.indexOf("px")>-1?this._round(t["16px"]/16*r/i):e.indexOf("%")>-1?this._round(t["1em"]*(r/100)/i):(a=t[e]||t.medium,this._round(a/i))},_getFitFactor:function(e,t,i,a){if(i){var r=this._getLongestLine(e).width,n=e.length*(this.viewbox.height*a)-(this.viewbox.height*a-this.viewbox.height);return this._round(Math.min(t/r,i/n))}return this._round(t/this._getWidth(e))},_getBestFit:function(e,t,i,a){for(var r=32,n=0,o=r;r>0;){var s=this._getFitFactor(this._split(e,r),t,i,a);s>n&&(n=s,o=r),r--}return{scale:n,lines:this._split(e,o)}},_getBestFlow:function(e,t,i){for(var a=[],r=0,n=[],o=!1,s=0,d=e.length;d>s;s++){" "==e[s].code&&(o=!0);var l=e[s].xAdvance;if(d>s+1&&e[s].kern&&e[s].kern[e[s+1].code]&&(l+=e[s].kern[e[s+1].code].x),r+=i*l,r>=t){for(var h=e[s];o&&" "!=h.code&&s>=0;)h=n.pop(),s--;a.push(n),n=[],r=0,o=!1}n.push(e[s])}return n.length&&a.push(n),this._trim(a)},getWidth:function(e,t){return this._getWidth(i.map(this._normalize(e).split(""),function(e){return this.glyphs[e]||{xAdvance:this.advance.missing.x}},this))*(t||1)},getLineHeight:function(e){return this.viewbox.height*(e||1)},getCenterline:function(e){return(e||1)*(this.viewbox.height/2)},getBaseline:function(e){return(e||1)*(this.viewbox.height+this.descent)},draw:function(e,t,a,r,o){if(!this.initialized())throw new Error("dojox.gfx.VectorFont.draw(): we have not been initialized yet.");var s=e.createGroup();(t.x||t.y)&&e.applyTransform({dx:t.x||0,dy:t.y||0});var l=i.map(this._normalize(t.text).split(""),function(e){return this.glyphs[e]||{path:null,xAdvance:this.advance.missing.x}},this),h=a.size,u=t.fitting,c=t.width,m=t.height,f=t.align,g=t.leading||this._defaultLeading;u&&((u!=n.vectorFontFitting.FLOW||c)&&(u!=n.vectorFontFitting.FIT||c&&m)||(u=n.vectorFontFitting.NONE));var p,y;switch(u){case n.vectorFontFitting.FIT:var v=this._getBestFit(l,c,m,g);y=v.scale,p=v.lines;break;case n.vectorFontFitting.FLOW:y=this._getSizeFactor(h),p=this._getBestFlow(l,c,y);break;default:y=this._getSizeFactor(h),p=[l]}p=i.filter(p,function(e){return e.length>0});for(var b=0,_=this._getLongestLine(p).width,M=0,k=p.length;k>M;M++){for(var x=0,w=p[M],j=this._getWidth(w),I=s.createGroup(),C=0;C<w.length;C++){var T=w[C];if(null!==T.path){var F=I.createPath(T.path).setFill(r);o&&F.setStroke(o),F.setTransform([d.flipY,d.translate(x,-this.viewbox.height-this.descent)])}x+=T.xAdvance,C+1<w.length&&T.kern&&T.kern[w[C+1].code]&&(x+=T.kern[w[C+1].code].x)}var S=0;"middle"==f?S=_/2-j/2:"end"==f&&(S=_-j),I.setTransform({dx:S,dy:b}),b+=this.viewbox.height*g}return s.setTransform(d.scale(y)),s},onLoadBegin:function(e){},onLoad:function(e){}})});//# sourceMappingURL=VectorText.js.map