//>>built
define("dojox/gfx/VectorText",["dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/loader","dojo/_base/xhr","./_base","dojox/xml/DomParser","dojox/html/metrics","./matrix"],function(e,t,a,i,o,r,n,s,l){var d=function(e){var t;return o.get({url:e,sync:!0,load:function(e){t=e}}),t};return e.getObject("dojox.gfx.VectorText",!0),e.mixin(r,{vectorFontFitting:{NONE:0,FLOW:1,FIT:2},defaultVectorText:{type:"vectortext",x:0,y:0,width:null,height:null,text:"",align:"start",decoration:"none",fitting:0,leading:1.5},defaultVectorFont:{type:"vectorfont",size:"10pt",family:null},_vectorFontCache:{},_svgFontCache:{},getVectorFont:function(e){return r._vectorFontCache[e]?r._vectorFontCache[e]:new r.VectorFont(e)}}),t("dojox.gfx.VectorFont",null,{_entityRe:/&(quot|apos|lt|gt|amp|#x[^;]+|#\d+);/g,_decodeEntitySequence:function(e){if(e.match(this._entityRe)){for(var t,a={amp:"&",apos:"'",quot:'"',lt:"<",gt:">"},i="";null!==(t=this._entityRe.exec(e));)"x"==t[1].charAt(1)?i+=String.fromCharCode(parseInt(t[1].slice(2),16)):isNaN(parseInt(t[1].slice(1),10))?i+=a[t[1]]||"":i+=String.fromCharCode(parseInt(t[1].slice(1),10));return i}},_parse:function(t,i){var o=r._svgFontCache[i]||n.parse(t),s=o.documentElement.byName("font")[0],l=o.documentElement.byName("font-face")[0],d=parseFloat(l.getAttribute("units-per-em")||1e3,10),u={x:parseFloat(s.getAttribute("horiz-adv-x"),10),y:parseFloat(s.getAttribute("vert-adv-y")||0,10)};u.y||(u.y=d);var h={horiz:{x:parseFloat(s.getAttribute("horiz-origin-x")||0,10),y:parseFloat(s.getAttribute("horiz-origin-y")||0,10)},vert:{x:parseFloat(s.getAttribute("vert-origin-x")||0,10),y:parseFloat(s.getAttribute("vert-origin-y")||0,10)}},m=l.getAttribute("font-family"),c=l.getAttribute("font-style")||"all",f=l.getAttribute("font-variant")||"normal",p=l.getAttribute("font-weight")||"all",g=l.getAttribute("font-stretch")||"normal",v=l.getAttribute("unicode-range")||"U+0-10FFFF",y=(l.getAttribute("panose-1"),l.getAttribute("cap-height"),parseFloat(l.getAttribute("ascent")||d-h.vert.y,10)),k=parseFloat(l.getAttribute("descent")||h.vert.y,10),b={},M=m;if(l.byName("font-face-name")[0]&&(M=l.byName("font-face-name")[0].getAttribute("name")),!r._vectorFontCache[M]){a.forEach(["alphabetic","ideographic","mathematical","hanging"],function(e){var t=l.getAttribute(e);null!==t&&(b[e]=parseFloat(t,10))});var j=parseFloat(o.documentElement.byName("missing-glyph")[0].getAttribute("horiz-adv-x")||u.x,10),w={},x={},_=o.documentElement.byName("glyph");a.forEach(_,function(e){var t=e.getAttribute("unicode"),a=e.getAttribute("glyph-name"),i=parseFloat(e.getAttribute("horiz-adv-x")||u.x,10),o=e.getAttribute("d");t.match(this._entityRe)&&(t=this._decodeEntitySequence(t));var r={code:t,name:a,xAdvance:i,path:o};w[t]=r,x[a]=r},this);var I=o.documentElement.byName("hkern");a.forEach(I,function(e,t){var a,i=-parseInt(e.getAttribute("k"),10),o=e.getAttribute("u1"),r=e.getAttribute("g1"),n=e.getAttribute("u2"),s=e.getAttribute("g2");o?(o=this._decodeEntitySequence(o),w[o]&&(a=w[o])):x[r]&&(a=x[r]),a&&(a.kern||(a.kern={}),n?(n=this._decodeEntitySequence(n),a.kern[n]={x:i}):x[s]&&(a.kern[x[s].code]={x:i}))},this),e.mixin(this,{family:m,name:M,style:c,variant:f,weight:p,stretch:g,range:v,viewbox:{width:d,height:d},origin:h,advance:e.mixin(u,{missing:{x:j,y:j}}),ascent:y,descent:k,baseline:b,glyphs:w}),r._vectorFontCache[M]=this,r._vectorFontCache[i]=this,M==m||r._vectorFontCache[m]||(r._vectorFontCache[m]=this),r._svgFontCache[i]||(r._svgFontCache[i]=o)}},_clean:function(){var e=this.name,t=this.family;return a.forEach(["family","name","style","variant","weight","stretch","range","viewbox","origin","advance","ascent","descent","baseline","glyphs"],function(e){try{delete this[e]}catch(e){}},this),r._vectorFontCache[e]&&delete r._vectorFontCache[e],r._vectorFontCache[t]&&delete r._vectorFontCache[t],this},constructor:function(e){this._defaultLeading=1.5,void 0!==e&&this.load(e)},load:function(e){return this.onLoadBegin(e.toString()),this._parse(r._svgFontCache[e.toString()]||d(e.toString()),e.toString()),this.onLoad(this),this},initialized:function(){return null!==this.glyphs},_round:function(e){return Math.round(1e3*e)/1e3},_leading:function(e){return this.viewbox.height*(e||this._defaultLeading)},_normalize:function(e){return e.replace(/\s+/g,String.fromCharCode(32))},_getWidth:function(e){var t=0,i=0,o=null;return a.forEach(e,function(a,r){i=a.xAdvance,e[r]&&a.kern&&a.kern[e[r].code]&&(i+=a.kern[e[r].code].x),t+=i,o=a}),o&&" "==o.code&&(t-=o.xAdvance),this._round(t)},_getLongestLine:function(e){var t=0,i=0;return a.forEach(e,function(e,a){var o=Math.max(t,this._getWidth(e));o>t&&(t=o,i=a)},this),{width:t,index:i,line:e[i]}},_trim:function(t){var i=function(e){e.length&&(" "==e[e.length-1].code&&e.splice(e.length-1,1),e.length&&" "==e[0].code&&e.splice(0,1))};return e.isArray(t[0])?a.forEach(t,i):i(t),t},_split:function(e,t){for(var a=this._getWidth(e),i=Math.floor(a/t),o=[],r=0,n=[],s=!1,l=0,d=e.length;l<d;l++){if(" "==e[l].code&&(s=!0),r+=e[l].xAdvance,l+1<d&&e[l].kern&&e[l].kern[e[l+1].code]&&(r+=e[l].kern[e[l+1].code].x),r>=i){for(var u=e[l];s&&" "!=u.code&&l>=0;)u=n.pop(),l--;o.push(n),n=[],r=0,s=!1}n.push(e[l])}return n.length&&o.push(n),this._trim(o)},_getSizeFactor:function(e){e+="";var t=s.getCachedFontMeasurements(),a=this.viewbox.height,i=t["1em"],o=parseFloat(e,10);return e.indexOf("em")>-1?this._round(t["1em"]*o/a):e.indexOf("ex")>-1?this._round(t["1ex"]*o/a):e.indexOf("pt")>-1?this._round(t["12pt"]/12*o/a):e.indexOf("px")>-1?this._round(t["16px"]/16*o/a):e.indexOf("%")>-1?this._round(t["1em"]*(o/100)/a):(i=t[e]||t.medium,this._round(i/a))},_getFitFactor:function(e,t,a,i){if(a){var o=this._getLongestLine(e).width,r=e.length*(this.viewbox.height*i)-(this.viewbox.height*i-this.viewbox.height);return this._round(Math.min(t/o,a/r))}return this._round(t/this._getWidth(e))},_getBestFit:function(e,t,a,i){for(var o=32,r=0,n=o;o>0;){var s=this._getFitFactor(this._split(e,o),t,a,i);s>r&&(r=s,n=o),o--}return{scale:r,lines:this._split(e,n)}},_getBestFlow:function(e,t,a){for(var i=[],o=0,r=[],n=!1,s=0,l=e.length;s<l;s++){" "==e[s].code&&(n=!0);var d=e[s].xAdvance;if(s+1<l&&e[s].kern&&e[s].kern[e[s+1].code]&&(d+=e[s].kern[e[s+1].code].x),(o+=a*d)>=t){for(var u=e[s];n&&" "!=u.code&&s>=0;)u=r.pop(),s--;i.push(r),r=[],o=0,n=!1}r.push(e[s])}return r.length&&i.push(r),this._trim(i)},getWidth:function(e,t){return this._getWidth(a.map(this._normalize(e).split(""),function(e){return this.glyphs[e]||{xAdvance:this.advance.missing.x}},this))*(t||1)},getLineHeight:function(e){return this.viewbox.height*(e||1)},getCenterline:function(e){return(e||1)*(this.viewbox.height/2)},getBaseline:function(e){return(e||1)*(this.viewbox.height+this.descent)},draw:function(e,t,i,o,n){if(!this.initialized())throw new Error("dojox.gfx.VectorFont.draw(): we have not been initialized yet.");var s=e.createGroup();(t.x||t.y)&&e.applyTransform({dx:t.x||0,dy:t.y||0});var d=a.map(this._normalize(t.text).split(""),function(e){return this.glyphs[e]||{path:null,xAdvance:this.advance.missing.x}},this),u=i.size,h=t.fitting,m=t.width,c=t.height,f=t.align,p=t.leading||this._defaultLeading;h&&((h!=r.vectorFontFitting.FLOW||m)&&(h!=r.vectorFontFitting.FIT||m&&c)||(h=r.vectorFontFitting.NONE));var g,v;switch(h){case r.vectorFontFitting.FIT:var y=this._getBestFit(d,m,c,p);v=y.scale,g=y.lines;break;case r.vectorFontFitting.FLOW:v=this._getSizeFactor(u),g=this._getBestFlow(d,m,v);break;default:v=this._getSizeFactor(u),g=[d]}g=a.filter(g,function(e){return e.length>0});for(var k=0,b=this._getLongestLine(g).width,M=0,j=g.length;M<j;M++){for(var w=0,x=g[M],_=this._getWidth(x),I=s.createGroup(),T=0;T<x.length;T++){var F=x[T];if(null!==F.path){var C=I.createPath(F.path).setFill(o);n&&C.setStroke(n),C.setTransform([l.flipY,l.translate(w,-this.viewbox.height-this.descent)])}w+=F.xAdvance,T+1<x.length&&F.kern&&F.kern[x[T+1].code]&&(w+=F.kern[x[T+1].code].x)}var E=0;"middle"==f?E=b/2-_/2:"end"==f&&(E=b-_),I.setTransform({dx:E,dy:k}),k+=this.viewbox.height*p}return s.setTransform(l.scale(v)),s},onLoadBegin:function(e){},onLoad:function(e){}})});//# sourceMappingURL=VectorText.js.map