//>>built
define("dojox/layout/dnd/PlottedDnd",["dojo","dijit","dojox","dojo/require!dojo/dnd/Source,dojo/dnd/Manager,dojox/layout/dnd/Avatar"],function(e,t,a){e.provide("dojox.layout.dnd.PlottedDnd"),e.require("dojo.dnd.Source"),e.require("dojo.dnd.Manager"),e.require("dojox.layout.dnd.Avatar"),e.declare("dojox.layout.dnd.PlottedDnd",[e.dnd.Source],{GC_OFFSET_X:e.dnd.manager().OFFSET_X,GC_OFFSET_Y:e.dnd.manager().OFFSET_Y,constructor:function(e,t){this.childBoxes=null,this.dropIndicator=new a.layout.dnd.DropIndicator("dndDropIndicator","div"),this.withHandles=t.withHandles,this.handleClasses=t.handleClasses,this.opacity=t.opacity,this.allowAutoScroll=t.allowAutoScroll,this.dom=t.dom,this.singular=!0,this.skipForm=!0,this._over=!1,this.defaultHandleClass="GcDndHandle",this.isDropped=!1,this._timer=null,this.isOffset=!!t.isOffset,this.offsetDrag=t.offsetDrag?t.offsetDrag:{x:0,y:0},this.hideSource=t.hideSource?t.hideSource:!0,this._drop=this.dropIndicator.create()},_calculateCoords:function(t){e.forEach(this.node.childNodes,function(a){var i=e.coords(a,!0);a.coords={xy:i,w:a.offsetWidth/2,h:a.offsetHeight/2,mw:i.w},t&&(a.coords.mh=i.h)},this)},_legalMouseDown:function(t){if(!this.withHandles)return!0;for(var a=t.target;a&&a!=this.node;a=a.parentNode)if(e.hasClass(a,this.defaultHandleClass))return!0;return!1},setDndItemSelectable:function(t,a){for(var i=t;i&&t!=this.node;i=i.parentNode)if(e.hasClass(i,"dojoDndItem"))return void e.setSelectable(i,a)},getDraggedWidget:function(a){for(var i=a;i&&"body"!=i.nodeName.toLowerCase()&&!e.hasClass(i,"dojoDndItem");)i=i.parentNode;return i?t.byNode(i):null},isAccepted:function(e){var t=e?e.getAttribute("dndtype"):null;return t&&t in this.accept},onDndStart:function(t,i,r){this.firstIndicator=t==this,this._calculateCoords(!0);var n=e.dnd.manager();i[0].coords?(this._drop.style.height=i[0].coords.mh+"px",e.style(n.avatar.node,"width",i[0].coords.mw+"px")):this._drop.style.height=n.avatar.node.clientHeight+"px",this.dndNodes=i,a.layout.dnd.PlottedDnd.superclass.onDndStart.call(this,t,i,r),t==this&&this.hideSource&&e.forEach(i,function(t){e.style(t,"display","none")})},onDndCancel:function(){var t=e.dnd.manager();if(t.source==this&&this.hideSource){var i=this.getSelectedNodes();e.forEach(i,function(t){e.style(t,"display","")})}a.layout.dnd.PlottedDnd.superclass.onDndCancel.call(this),this.deleteDashedZone()},onDndDrop:function(e,t,i,r){try{this.isAccepted(t[0])?(e==this&&this._over&&this.dropObject&&(this.current=this.dropObject.c),a.layout.dnd.PlottedDnd.superclass.onDndDrop.call(this,e,t,i,r),this._calculateCoords(!0)):this.onDndCancel()}catch(n){}},onMouseDown:function(t){if(null==this.current?this.selection={}:this.current==this.anchor&&(this.anchor=null),null!==this.current){var i=e.coords(this.current,!0);if(this.current.coords={xy:i,w:this.current.offsetWidth/2,h:this.current.offsetHeight/2,mh:i.h,mw:i.w},this._drop.style.height=this.current.coords.mh+"px",this.isOffset){if(0==this.offsetDrag.x&&0==this.offsetDrag.y){var r=!0,n=e.coords(this._getChildByEvent(t));this.offsetDrag.x=n.x-t.pageX,this.offsetDrag.y=n.y-t.clientY}this.offsetDrag.y<16&&null!=this.current&&(this.offsetDrag.y=this.GC_OFFSET_Y);var o=e.dnd.manager();o.OFFSET_X=this.offsetDrag.x,o.OFFSET_Y=this.offsetDrag.y,r&&(this.offsetDrag.x=0,this.offsetDrag.y=0)}}if(e.dnd.isFormElement(t))this.setDndItemSelectable(t.target,!0);else{this.containerSource=!0;var s=this.getDraggedWidget(t.target);s&&s.dragRestriction||a.layout.dnd.PlottedDnd.superclass.onMouseDown.call(this,t)}},onMouseUp:function(t){a.layout.dnd.PlottedDnd.superclass.onMouseUp.call(this,t),this.containerSource=!1,!e.isIE&&this.mouseDown&&this.setDndItemSelectable(t.target,!0);var i=e.dnd.manager();i.OFFSET_X=this.GC_OFFSET_X,i.OFFSET_Y=this.GC_OFFSET_Y},onMouseMove:function(t){var a=e.dnd.manager();if(this.isDragging){var i=!1;(null!=this.current||null==this.current&&!this.dropObject)&&(this.isAccepted(a.nodes[0])||this.containerSource)&&(i=this.setIndicatorPosition(t)),this.current==this.targetAnchor&&i==this.before||(this._markTargetAnchor(i),a.canDrop(!(this.current&&a.source==this&&this.current.id in this.selection))),this.allowAutoScroll&&this._checkAutoScroll(t)}else{if(this.mouseDown&&this.isSource){var r=this.getSelectedNodes();r.length&&a.startDrag(this,r,this.copyState(e.isCopyKey(t)))}this.allowAutoScroll&&this._stopAutoScroll()}},_markTargetAnchor:function(e){this.current==this.targetAnchor&&this.before==e||(this.targetAnchor=this.current,this.targetBox=null,this.before=e)},_unmarkTargetAnchor:function(){this.targetAnchor&&(this.targetAnchor=null,this.targetBox=null,this.before=!0)},setIndicatorPosition:function(t){var a=!1;return this.current?(this.current.coords&&!this.allowAutoScroll||(this.current.coords={xy:e.coords(this.current,!0),w:this.current.offsetWidth/2,h:this.current.offsetHeight/2}),a=this.horizontal?t.pageX-this.current.coords.xy.x<this.current.coords.w:t.pageY-this.current.coords.xy.y<this.current.coords.h,this.insertDashedZone(a)):this.dropObject||this.insertDashedZone(!1),a},onOverEvent:function(){if(this._over=!0,a.layout.dnd.PlottedDnd.superclass.onOverEvent.call(this),this.isDragging){var t=e.dnd.manager();!this.current&&!this.dropObject&&this.getSelectedNodes()[0]&&this.isAccepted(t.nodes[0])&&this.insertDashedZone(!1)}},onOutEvent:function(){this._over=!1,this.containerSource=!1,a.layout.dnd.PlottedDnd.superclass.onOutEvent.call(this),this.dropObject&&this.deleteDashedZone()},deleteDashedZone:function(){this._drop.style.display="none";for(var e=this._drop.nextSibling;null!=e;)e.coords.xy.y-=parseInt(this._drop.style.height),e=e.nextSibling;delete this.dropObject},insertDashedZone:function(t){if(this.dropObject){if(t==this.dropObject.b&&(this.current&&this.dropObject.c==this.current.id||!this.current&&!this.dropObject.c))return;this.deleteDashedZone()}if(this.dropObject={n:this._drop,c:this.current?this.current.id:null,b:t},this.current)if(e.place(this._drop,this.current,t?"before":"after"),this.firstIndicator)this.firstIndicator=!1;else for(var a=this._drop.nextSibling;null!=a;)a.coords.xy.y+=parseInt(this._drop.style.height),a=a.nextSibling;else this.node.appendChild(this._drop);this._drop.style.display=""},insertNodes:function(i,r,n,o){if(!this.dropObject)return a.layout.dnd.PlottedDnd.superclass.insertNodes.call(this,i,r,n,o);e.style(this.dropObject.n,"display","none"),a.layout.dnd.PlottedDnd.superclass.insertNodes.call(this,!0,r,!0,this.dropObject.n),this.deleteDashedZone();var s=t.byId(r[0].getAttribute("widgetId"));s&&(a.layout.dnd._setGcDndHandle(s,this.withHandles,this.handleClasses),this.hideSource&&e.style(s.domNode,"display",""))},_checkAutoScroll:function(e){this._timer&&clearTimeout(this._timer),this._stopAutoScroll();var t=this.dom,a=this._sumAncestorProperties(t,"offsetTop");e.pageY-t.offsetTop+30>t.clientHeight?(this.autoScrollActive=!0,this._autoScrollDown(t)):t.scrollTop>0&&e.pageY-a<30&&(this.autoScrollActive=!0,this._autoScrollUp(t))},_autoScrollUp:function(t){this.autoScrollActive&&t.scrollTop>0&&(t.scrollTop-=30,this._timer=setTimeout(e.hitch(this,"_autoScrollUp",t),100))},_autoScrollDown:function(t){this.autoScrollActive&&t.scrollTop<t.scrollHeight-t.clientHeight&&(t.scrollTop+=30,this._timer=setTimeout(e.hitch(this,"_autoScrollDown",t),100))},_stopAutoScroll:function(){this.autoScrollActive=!1},_sumAncestorProperties:function(t,a){if(t=e.byId(t),!t)return 0;for(var i=0;t;){var r=t[a];if(r&&(i+=r-0,t==e.body()))break;t=t.parentNode}return i}}),a.layout.dnd._setGcDndHandle=function(t,a,i,r){var n="GcDndHandle";if(r||e.query(".GcDndHandle",t.domNode).removeClass(n),a){for(var o=!1,s=i.length-1;s>=0;s--){var l=e.query("."+i[s],t.domNode)[0];if(l&&(o=!0,i[s]!=n)){var d=e.query("."+n,t.domNode);0==d.length?e.removeClass(t.domNode,n):d.removeClass(n),e.addClass(l,n)}}o||e.addClass(t.domNode,n)}else e.addClass(t.domNode,n)},e.declare("dojox.layout.dnd.DropIndicator",null,{constructor:function(e,t){this.tag=t||"div",this.style=e||null},isInserted:function(){return this.node.parentNode&&1==this.node.parentNode.nodeType},create:function(){if(this.node&&this.isInserted())return this.node;var t="90px",a=e.doc.createElement(this.tag);return this.style?(a.className=this.style,a.style.height=t):e.style(a,{position:"relative",border:"1px dashed #F60",margin:"2px",height:t}),this.node=a,a},destroy:function(){this.node&&this.isInserted()&&(this.node.parentNode.removeChild(this.node),this.node=null)}}),e.extend(e.dnd.Manager,{canDrop:function(e){var t=this.target&&e;this.canDropFlag!=t&&(this.canDropFlag=t,this.avatar&&this.avatar.update())},makeAvatar:function(){return"dojox.layout.dnd.PlottedDnd"==this.source.declaredClass?new a.layout.dnd.Avatar(this,this.source.opacity):new e.dnd.Avatar(this)}}),e.isIE&&(a.layout.dnd.handdleIE=[e.subscribe("/dnd/start",null,function(){IEonselectstart=document.body.onselectstart,document.body.onselectstart=function(){return!1}}),e.subscribe("/dnd/cancel",null,function(){document.body.onselectstart=IEonselectstart}),e.subscribe("/dnd/drop",null,function(){document.body.onselectstart=IEonselectstart})],e.addOnWindowUnload(function(){e.forEach(a.layout.dnd.handdleIE,e.unsubscribe)}))});//# sourceMappingURL=PlottedDnd.js.map