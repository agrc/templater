//>>built
define("dojox/layout/dnd/PlottedDnd",["dojo","dijit","dojox","dojo/require!dojo/dnd/Source,dojo/dnd/Manager,dojox/layout/dnd/Avatar"],function(e,t,i){e.provide("dojox.layout.dnd.PlottedDnd"),e.require("dojo.dnd.Source"),e.require("dojo.dnd.Manager"),e.require("dojox.layout.dnd.Avatar"),e.declare("dojox.layout.dnd.PlottedDnd",[e.dnd.Source],{GC_OFFSET_X:e.dnd.manager().OFFSET_X,GC_OFFSET_Y:e.dnd.manager().OFFSET_Y,constructor:function(e,t){this.childBoxes=null,this.dropIndicator=new i.layout.dnd.DropIndicator("dndDropIndicator","div"),this.withHandles=t.withHandles,this.handleClasses=t.handleClasses,this.opacity=t.opacity,this.allowAutoScroll=t.allowAutoScroll,this.dom=t.dom,this.singular=!0,this.skipForm=!0,this._over=!1,this.defaultHandleClass="GcDndHandle",this.isDropped=!1,this._timer=null,this.isOffset=!!t.isOffset,this.offsetDrag=t.offsetDrag?t.offsetDrag:{x:0,y:0},this.hideSource=!t.hideSource||t.hideSource,this._drop=this.dropIndicator.create()},_calculateCoords:function(t){e.forEach(this.node.childNodes,function(i){var r=e.coords(i,!0);i.coords={xy:r,w:i.offsetWidth/2,h:i.offsetHeight/2,mw:r.w},t&&(i.coords.mh=r.h)},this)},_legalMouseDown:function(t){if(!this.withHandles)return!0;for(var i=t.target;i&&i!=this.node;i=i.parentNode)if(e.hasClass(i,this.defaultHandleClass))return!0;return!1},setDndItemSelectable:function(t,i){for(var r=t;r&&t!=this.node;r=r.parentNode)if(e.hasClass(r,"dojoDndItem"))return void e.setSelectable(r,i)},getDraggedWidget:function(i){for(var r=i;r&&"body"!=r.nodeName.toLowerCase()&&!e.hasClass(r,"dojoDndItem");)r=r.parentNode;return r?t.byNode(r):null},isAccepted:function(e){var t=e?e.getAttribute("dndtype"):null;return t&&t in this.accept},onDndStart:function(t,r,n){this.firstIndicator=t==this,this._calculateCoords(!0);var a=e.dnd.manager();r[0].coords?(this._drop.style.height=r[0].coords.mh+"px",e.style(a.avatar.node,"width",r[0].coords.mw+"px")):this._drop.style.height=a.avatar.node.clientHeight+"px",this.dndNodes=r,i.layout.dnd.PlottedDnd.superclass.onDndStart.call(this,t,r,n),t==this&&this.hideSource&&e.forEach(r,function(t){e.style(t,"display","none")})},onDndCancel:function(){if(e.dnd.manager().source==this&&this.hideSource){var t=this.getSelectedNodes();e.forEach(t,function(t){e.style(t,"display","")})}i.layout.dnd.PlottedDnd.superclass.onDndCancel.call(this),this.deleteDashedZone()},onDndDrop:function(e,t,r,n){try{this.isAccepted(t[0])?(e==this&&this._over&&this.dropObject&&(this.current=this.dropObject.c),i.layout.dnd.PlottedDnd.superclass.onDndDrop.call(this,e,t,r,n),this._calculateCoords(!0)):this.onDndCancel()}catch(e){}},onMouseDown:function(t){if(null==this.current?this.selection={}:this.current==this.anchor&&(this.anchor=null),null!==this.current){var r=e.coords(this.current,!0);if(this.current.coords={xy:r,w:this.current.offsetWidth/2,h:this.current.offsetHeight/2,mh:r.h,mw:r.w},this._drop.style.height=this.current.coords.mh+"px",this.isOffset){if(0==this.offsetDrag.x&&0==this.offsetDrag.y){var n=!0,a=e.coords(this._getChildByEvent(t));this.offsetDrag.x=a.x-t.pageX,this.offsetDrag.y=a.y-t.clientY}this.offsetDrag.y<16&&null!=this.current&&(this.offsetDrag.y=this.GC_OFFSET_Y);var o=e.dnd.manager();o.OFFSET_X=this.offsetDrag.x,o.OFFSET_Y=this.offsetDrag.y,n&&(this.offsetDrag.x=0,this.offsetDrag.y=0)}}if(e.dnd.isFormElement(t))this.setDndItemSelectable(t.target,!0);else{this.containerSource=!0;var s=this.getDraggedWidget(t.target);s&&s.dragRestriction||i.layout.dnd.PlottedDnd.superclass.onMouseDown.call(this,t)}},onMouseUp:function(t){i.layout.dnd.PlottedDnd.superclass.onMouseUp.call(this,t),this.containerSource=!1,!e.isIE&&this.mouseDown&&this.setDndItemSelectable(t.target,!0);var r=e.dnd.manager();r.OFFSET_X=this.GC_OFFSET_X,r.OFFSET_Y=this.GC_OFFSET_Y},onMouseMove:function(t){var i=e.dnd.manager();if(this.isDragging){var r=!1;(null!=this.current||null==this.current&&!this.dropObject)&&(this.isAccepted(i.nodes[0])||this.containerSource)&&(r=this.setIndicatorPosition(t)),this.current==this.targetAnchor&&r==this.before||(this._markTargetAnchor(r),i.canDrop(!(this.current&&i.source==this&&this.current.id in this.selection))),this.allowAutoScroll&&this._checkAutoScroll(t)}else{if(this.mouseDown&&this.isSource){var n=this.getSelectedNodes();n.length&&i.startDrag(this,n,this.copyState(e.isCopyKey(t)))}this.allowAutoScroll&&this._stopAutoScroll()}},_markTargetAnchor:function(e){this.current==this.targetAnchor&&this.before==e||(this.targetAnchor=this.current,this.targetBox=null,this.before=e)},_unmarkTargetAnchor:function(){this.targetAnchor&&(this.targetAnchor=null,this.targetBox=null,this.before=!0)},setIndicatorPosition:function(t){var i=!1;return this.current?(this.current.coords&&!this.allowAutoScroll||(this.current.coords={xy:e.coords(this.current,!0),w:this.current.offsetWidth/2,h:this.current.offsetHeight/2}),i=this.horizontal?t.pageX-this.current.coords.xy.x<this.current.coords.w:t.pageY-this.current.coords.xy.y<this.current.coords.h,this.insertDashedZone(i)):this.dropObject||this.insertDashedZone(!1),i},onOverEvent:function(){if(this._over=!0,i.layout.dnd.PlottedDnd.superclass.onOverEvent.call(this),this.isDragging){var t=e.dnd.manager();!this.current&&!this.dropObject&&this.getSelectedNodes()[0]&&this.isAccepted(t.nodes[0])&&this.insertDashedZone(!1)}},onOutEvent:function(){this._over=!1,this.containerSource=!1,i.layout.dnd.PlottedDnd.superclass.onOutEvent.call(this),this.dropObject&&this.deleteDashedZone()},deleteDashedZone:function(){this._drop.style.display="none";for(var e=this._drop.nextSibling;null!=e;)e.coords.xy.y-=parseInt(this._drop.style.height),e=e.nextSibling;delete this.dropObject},insertDashedZone:function(t){if(this.dropObject){if(t==this.dropObject.b&&(this.current&&this.dropObject.c==this.current.id||!this.current&&!this.dropObject.c))return;this.deleteDashedZone()}if(this.dropObject={n:this._drop,c:this.current?this.current.id:null,b:t},this.current)if(e.place(this._drop,this.current,t?"before":"after"),this.firstIndicator)this.firstIndicator=!1;else for(var i=this._drop.nextSibling;null!=i;)i.coords.xy.y+=parseInt(this._drop.style.height),i=i.nextSibling;else this.node.appendChild(this._drop);this._drop.style.display=""},insertNodes:function(r,n,a,o){if(!this.dropObject)return i.layout.dnd.PlottedDnd.superclass.insertNodes.call(this,r,n,a,o);e.style(this.dropObject.n,"display","none"),i.layout.dnd.PlottedDnd.superclass.insertNodes.call(this,!0,n,!0,this.dropObject.n),this.deleteDashedZone();var s=t.byId(n[0].getAttribute("widgetId"));s&&(i.layout.dnd._setGcDndHandle(s,this.withHandles,this.handleClasses),this.hideSource&&e.style(s.domNode,"display",""))},_checkAutoScroll:function(e){this._timer&&clearTimeout(this._timer),this._stopAutoScroll();var t=this.dom,i=this._sumAncestorProperties(t,"offsetTop");e.pageY-t.offsetTop+30>t.clientHeight?(this.autoScrollActive=!0,this._autoScrollDown(t)):t.scrollTop>0&&e.pageY-i<30&&(this.autoScrollActive=!0,this._autoScrollUp(t))},_autoScrollUp:function(t){this.autoScrollActive&&t.scrollTop>0&&(t.scrollTop-=30,this._timer=setTimeout(e.hitch(this,"_autoScrollUp",t),100))},_autoScrollDown:function(t){this.autoScrollActive&&t.scrollTop<t.scrollHeight-t.clientHeight&&(t.scrollTop+=30,this._timer=setTimeout(e.hitch(this,"_autoScrollDown",t),100))},_stopAutoScroll:function(){this.autoScrollActive=!1},_sumAncestorProperties:function(t,i){if(!(t=e.byId(t)))return 0;for(var r=0;t;){var n=t[i];if(n&&(r+=n-0,t==e.body()))break;t=t.parentNode}return r}}),i.layout.dnd._setGcDndHandle=function(t,i,r,n){var a="GcDndHandle";if(n||e.query(".GcDndHandle",t.domNode).removeClass(a),i){for(var o=!1,s=r.length-1;s>=0;s--){var l=e.query("."+r[s],t.domNode)[0];if(l&&(o=!0,r[s]!=a)){var d=e.query("."+a,t.domNode);0==d.length?e.removeClass(t.domNode,a):d.removeClass(a),e.addClass(l,a)}}o||e.addClass(t.domNode,a)}else e.addClass(t.domNode,a)},e.declare("dojox.layout.dnd.DropIndicator",null,{constructor:function(e,t){this.tag=t||"div",this.style=e||null},isInserted:function(){return this.node.parentNode&&1==this.node.parentNode.nodeType},create:function(){if(this.node&&this.isInserted())return this.node;var t="90px",i=e.doc.createElement(this.tag);return this.style?(i.className=this.style,i.style.height=t):e.style(i,{position:"relative",border:"1px dashed #F60",margin:"2px",height:t}),this.node=i,i},destroy:function(){this.node&&this.isInserted()&&(this.node.parentNode.removeChild(this.node),this.node=null)}}),e.extend(e.dnd.Manager,{canDrop:function(e){var t=this.target&&e;this.canDropFlag!=t&&(this.canDropFlag=t,this.avatar&&this.avatar.update())},makeAvatar:function(){return"dojox.layout.dnd.PlottedDnd"==this.source.declaredClass?new i.layout.dnd.Avatar(this,this.source.opacity):new e.dnd.Avatar(this)}}),e.isIE&&(i.layout.dnd.handdleIE=[e.subscribe("/dnd/start",null,function(){IEonselectstart=document.body.onselectstart,document.body.onselectstart=function(){return!1}}),e.subscribe("/dnd/cancel",null,function(){document.body.onselectstart=IEonselectstart}),e.subscribe("/dnd/drop",null,function(){document.body.onselectstart=IEonselectstart})],e.addOnWindowUnload(function(){e.forEach(i.layout.dnd.handdleIE,e.unsubscribe)}))});//# sourceMappingURL=PlottedDnd.js.map