//>>built
define("dojox/treemap/TreeMap",["dojo/_base/array","dojo/_base/lang","dojo/_base/declare","dojo/_base/event","dojo/_base/Color","dojo/touch","dojo/when","dojo/on","dojo/query","dojo/dom-construct","dojo/dom-geometry","dojo/dom-class","dojo/dom-style","./_utils","dijit/_WidgetBase","dojox/widget/_Invalidating","dojox/widget/Selection","dojo/_base/sniff","dojo/uacss"],function(e,t,i,a,o,n,r,s,l,d,h,u,c,m,f,p,g,v){return i("dojox.treemap.TreeMap",[f,p,g],{baseClass:"dojoxTreeMap",store:null,query:{},queryOptions:null,itemToRenderer:null,_dataChanged:!1,rootItem:null,_rootItemChanged:!1,tooltipAttr:"",areaAttr:"",_areaChanged:!1,labelAttr:"label",labelThreshold:NaN,colorAttr:"",colorModel:null,_coloringChanged:!1,groupAttrs:[],groupFuncs:null,_groupFuncs:null,_groupingChanged:!1,constructor:function(){this.itemToRenderer={},this.invalidatingProperties=["colorModel","groupAttrs","groupFuncs","areaAttr","areaFunc","labelAttr","labelFunc","labelThreshold","tooltipAttr","tooltipFunc","colorAttr","colorFunc","rootItem"]},getIdentity:function(e){return e.__treeID?e.__treeID:this.store.getIdentity(e)},resize:function(e){e&&(h.setMarginBox(this.domNode,e),this.invalidateRendering())},postCreate:function(){this.inherited(arguments),this.own(s(this.domNode,"mouseover",t.hitch(this,this._onMouseOver))),this.own(s(this.domNode,"mouseout",t.hitch(this,this._onMouseOut))),this.own(s(this.domNode,n.release,t.hitch(this,this._onMouseUp))),this.domNode.setAttribute("role","presentation"),this.domNode.setAttribute("aria-label","treemap")},buildRendering:function(){this.inherited(arguments),this.refreshRendering()},refreshRendering:function(){var e=!1;if(this._dataChanged&&(this._dataChanged=!1,this._groupingChanged=!0,this._coloringChanged=!0),this._groupingChanged&&(this._groupingChanged=!1,this._set("rootItem",null),this._updateTreeMapHierarchy(),e=!0),this._rootItemChanged&&(this._rootItemChanged=!1,e=!0),this._coloringChanged&&(this._coloringChanged=!1,null!=this.colorModel&&null!=this._data&&this.colorModel.initialize&&this.colorModel.initialize(this._data,t.hitch(this,function(e){return this.colorFunc(e,this.store)}))),this._areaChanged&&(this._areaChanged=!1,this._removeAreaForGroup()),void 0!=this.domNode&&null!=this._items){e&&d.empty(this.domNode);var i,a=this.rootItem;if(null!=a){var o=this._getRenderer(a);o&&(this._isLeaf(a)&&(a=o.parentItem),i=o.parentItem)}var n=h.getMarginBox(this.domNode);null!=a?this._buildRenderer(this.domNode,i,a,{x:n.l,y:n.t,w:n.w,h:n.h},0,e):this._buildChildrenRenderers(this.domNode,a||{__treeRoot:!0,children:this._items},0,e,n)}},_setRootItemAttr:function(e){this._rootItemChanged=!0,this._set("rootItem",e)},_setStoreAttr:function(e){var i;if(this._observeHandler&&(this._observeHandler.remove(),this._observeHandler=null),null!=e){var a=e.query(this.query,this.queryOptions);a.observe&&(this._observeHandler=a.observe(t.hitch(this,this._updateItem),!0)),i=r(a,t.hitch(this,this._initItems))}else i=this._initItems([]);return this._set("store",e),i},_initItems:function(e){return this._dataChanged=!0,this._data=e,this.invalidateRendering(),e},_updateItem:function(e,t,i){-1!=t?i!=t?this._data.splice(t,1):this._data[i]=e:-1!=i&&this._data.splice(i,0,e),this._dataChanged=!0,this.invalidateRendering()},_setGroupAttrsAttr:function(t){this._groupingChanged=!0,null==this.groupFuncs&&(this._groupFuncs=null!=t?e.map(t,function(e){return function(t){return t[e]}}):null),this._set("groupAttrs",t)},_setGroupFuncsAttr:function(t){this._groupingChanged=!0,this._set("groupFuncs",this._groupFuncs=t),null==t&&null!=this.groupAttrs&&(this._groupFuncs=e.map(this.groupAttrs,function(e){return function(t){return t[e]}}))},_setAreaAttrAttr:function(e){this._areaChanged=!0,this._set("areaAttr",e)},areaFunc:function(e,t){return this.areaAttr&&this.areaAttr.length>0?parseFloat(e[this.areaAttr]):1},_setAreaFuncAttr:function(e){this._areaChanged=!0,this._set("areaFunc",e)},labelFunc:function(e,t){var i=this.labelAttr&&this.labelAttr.length>0?e[this.labelAttr]:null;return i?i.toString():null},tooltipFunc:function(e,t){var i=this.tooltipAttr&&this.tooltipAttr.length>0?e[this.tooltipAttr]:null;return i?i.toString():null},_setColorModelAttr:function(e){this._coloringChanged=!0,this._set("colorModel",e)},_setColorAttrAttr:function(e){this._coloringChanged=!0,this._set("colorAttr",e)},colorFunc:function(e,t){var i=this.colorAttr&&this.colorAttr.length>0?e[this.colorAttr]:0;return null==i&&(i=0),parseFloat(i)},_setColorFuncAttr:function(e){this._coloringChanged=!0,this._set("colorFunc",e)},createRenderer:function(e,t,i){var a=d.create("div");return"header"!=i&&(c.set(a,"overflow","hidden"),c.set(a,"position","absolute")),a},styleRenderer:function(e,t,i,a){switch(a){case"leaf":c.set(e,"background",this.getColorForItem(t).toHex());case"header":var o=this.getLabelForItem(t);o&&(isNaN(this.labelThreshold)||i<this.labelThreshold)?e.innerHTML=o:d.empty(e)}},_updateTreeMapHierarchy:function(){null!=this._data&&(null!=this._groupFuncs&&this._groupFuncs.length>0?this._items=m.group(this._data,this._groupFuncs,t.hitch(this,this._getAreaForItem)).children:this._items=this._data)},_removeAreaForGroup:function(e){var t;if(null!=e){if(!e.__treeValue)return;delete e.__treeValue,t=e.children}else t=this._items;if(t)for(var i=0;i<t.length;++i)this._removeAreaForGroup(t[i])},_getAreaForItem:function(e){var t=this.areaFunc(e,this.store);return isNaN(t)?0:t},_computeAreaForItem:function(e){var t;if(e.__treeID){if(!(t=e.__treeValue)){t=0;for(var i=e.children,a=0;a<i.length;++a)t+=this._computeAreaForItem(i[a]);e.__treeValue=t}}else t=this._getAreaForItem(e);return t},getColorForItem:function(e){var t=this.colorFunc(e,this.store);return null!=this.colorModel?this.colorModel.getColor(t):new o(t)},getLabelForItem:function(e){return e.__treeName?e.__treeName:this.labelFunc(e,this.store)},_buildChildrenRenderers:function(i,a,o,n,r,s){var l=a.children,d=h.getMarginBox(i),u=m.solve(l,d.w,d.h,t.hitch(this,this._computeAreaForItem),!this.isLeftToRight()),c=u.rectangles;r&&(c=e.map(c,function(e){return e.x+=r.l,e.y+=r.t,e}));for(var f,p=0;p<l.length;++p)f=c[p],this._buildRenderer(i,a,l[p],f,o,n,s)},_isLeaf:function(e){return!e.children},_isRoot:function(e){return e.__treeRoot},_getRenderer:function(e,t,i){if(t)for(var a=0;a<i.children.length;++a)if(i.children[a].item==e)return i.children[a];return this.itemToRenderer[this.getIdentity(e)]},_buildRenderer:function(e,t,i,a,o,n,r){var s=this._isLeaf(i),l=n?null:this._getRenderer(i,r,e);l=s?this._updateLeafRenderer(l,i,o):this._updateGroupRenderer(l,i,o),n&&(l.level=o,l.item=i,l.parentItem=t,this.itemToRenderer[this.getIdentity(i)]=l,this.updateRenderers(i));var u=Math.floor(a.x),c=Math.floor(a.y),m=Math.floor(a.x+a.w+1e-11)-u,f=Math.floor(a.y+a.h+1e-11)-c;if(n&&d.place(l,e),h.setMarginBox(l,{l:u,t:c,w:m,h:f}),!s){var p=h.getContentBox(l);this._layoutGroupContent(l,p.w,p.h,o+1,n,r)}this.onRendererUpdated({renderer:l,item:i,kind:s?"leaf":"group",level:o})},_layoutGroupContent:function(e,t,i,a,o,n){var r=l(".dojoxTreeMapHeader",e)[0],s=l(".dojoxTreeMapGroupContent",e)[0];if(null!=r&&null!=s){var d=h.getMarginBox(r);d.h>i?(d.h=i,c.set(s,"display","none")):(c.set(s,"display","block"),h.setMarginBox(s,{l:0,t:d.h,w:t,h:i-d.h}),this._buildChildrenRenderers(s,e.item,a,o,null,n)),h.setMarginBox(r,{l:0,t:0,w:t,h:d.h})}},_updateGroupRenderer:function(e,t,i){var a=null==e;null==e&&(e=this.createRenderer("div",i,"group"),u.add(e,"dojoxTreeMapGroup")),this.styleRenderer(e,t,i,"group");var o=l(".dojoxTreeMapHeader",e)[0];o=this._updateHeaderRenderer(o,t,i),a&&d.place(o,e);var n=l(".dojoxTreeMapGroupContent",e)[0];return n=this._updateGroupContentRenderer(n,t,i),a&&d.place(n,e),e},_updateHeaderRenderer:function(e,t,i){return null==e&&(e=this.createRenderer(t,i,"header"),u.add(e,"dojoxTreeMapHeader"),u.add(e,"dojoxTreeMapHeader_"+i)),this.styleRenderer(e,t,i,"header"),e},_updateLeafRenderer:function(e,t,i){null==e&&(e=this.createRenderer(t,i,"leaf"),u.add(e,"dojoxTreeMapLeaf"),u.add(e,"dojoxTreeMapLeaf_"+i)),this.styleRenderer(e,t,i,"leaf");var a=this.tooltipFunc(t,this.store);return a&&(e.title=a),e},_updateGroupContentRenderer:function(e,t,i){return null==e&&(e=this.createRenderer(t,i,"content"),u.add(e,"dojoxTreeMapGroupContent"),u.add(e,"dojoxTreeMapGroupContent_"+i)),this.styleRenderer(e,t,i,"content"),e},_getRendererFromTarget:function(e){for(var t=e;t!=this.domNode&&!t.item;)t=t.parentNode;return t},_onMouseOver:function(e){var t=this._getRendererFromTarget(e.target);if(t.item){var i=t.item;this._hoveredItem=i,this.updateRenderers(i),this.onItemRollOver({renderer:t,item:i,triggerEvent:e})}},_onMouseOut:function(e){var t=this._getRendererFromTarget(e.target);if(t.item){var i=t.item;this._hoveredItem=null,this.updateRenderers(i),this.onItemRollOut({renderer:t,item:i,triggerEvent:e})}},_onMouseUp:function(e){var t=this._getRendererFromTarget(e.target);t.item&&this.selectFromEvent(e,t.item,t,!0)},onRendererUpdated:function(){},onItemRollOver:function(){},onItemRollOut:function(){},updateRenderers:function(e){if(e){t.isArray(e)||(e=[e]);for(var i=0;i<e.length;i++){var a=e[i],o=this._getRenderer(a);if(o){var n,r=this.isItemSelected(a),s=v("ie");if(r){if(u.add(o,"dojoxTreeMapSelected"),s&&(v("quirks")||s<9)){n=o.previousSibling;var l=c.get(o);n&&u.contains(n,"dojoxTreeMapIEHack")||(n=this.createRenderer(a,-10,"group"),u.add(n,"dojoxTreeMapIEHack"),u.add(n,"dojoxTreeMapSelected"),c.set(n,{position:"absolute",overflow:"hidden"}),d.place(n,o,"before"));var h=2*parseInt(c.get(n,"border-width"));this._isLeaf(a)?h-=1:h+=1,"auto"!=l.left&&c.set(n,{left:parseInt(l.left)+1+"px",top:parseInt(l.top)+1+"px",width:parseInt(l.width)-h+"px",height:parseInt(l.height)-h+"px"})}}else s&&(v("quirks")||s<9)&&(n=o.previousSibling)&&u.contains(n,"dojoxTreeMapIEHack")&&n.parentNode.removeChild(n),u.remove(o,"dojoxTreeMapSelected");this._hoveredItem==a?u.add(o,"dojoxTreeMapHovered"):u.remove(o,"dojoxTreeMapHovered"),r||this._hoveredItem==a?c.set(o,"zIndex",20):c.set(o,"zIndex",v("ie")<=7?0:"auto")}}}}})});//# sourceMappingURL=TreeMap.js.map