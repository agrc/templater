//>>built
define("dojox/json/ref",["dojo/_base/array","dojo/_base/json","dojo/_base/kernel","dojo/_base/lang","dojo/date/stamp","dojox"],function(array,djson,dojo,lang,stamp,dojox){return lang.getObject("json",!0,dojox),dojox.json.ref={resolveJson:function(e,t){function i(p,g,y,v,b,_,M){var w,k,x,T=r in p?p[r]:y;(r in p||void 0!==T&&v)&&(T=(s+T).replace(c,"$2$3"));var j=_||p;if(void 0!==T){if(l&&(p.__id=T),!t.schemas||p instanceof Array||!(x=T.match(/^(.+\/)[^\.\[]*$/))||(b=t.schemas[x[1]]),d[T]&&p instanceof Array==d[T]instanceof Array)j=d[T],delete j.$ref,delete j._loadObject,k=!0;else{var C=b&&b.prototype;C&&(f.prototype=C,j=new f)}d[T]=j,u&&(u[T]=t.time)}for(;b;){var I=b.properties;if(I)for(w in p){var F=I[w];F&&"date-time"==F.format&&"string"==typeof p[w]&&(p[w]=stamp.fromISOString(p[w]))}b=b.extends}var S=p.length;for(w in p){if(w==S)break;if(p.hasOwnProperty(w)){if("object"==typeof(x=p[w])&&x&&!(x instanceof Date)&&"__parent"!=w)if(a=x[o]||n&&x[r],p==h||a&&x.__parent||(x.__parent=M||j),a){delete p[w];var A=a.toString().replace(/(#)([^\.\[])/,"$1.$2").match(/(^([^\[]*\/)?[^#\.\[]*)#?([\.\[].*)?/);if(d[(s+a).replace(c,"$2$3")]?a=d[(s+a).replace(c,"$2$3")]:(a="$"==A[1]||"this"==A[1]||""===A[1]?e:d[(s+A[1]).replace(c,"$2$3")])&&A[3]&&A[3].replace(/(\[([^\]]+)\])|(\.?([^\.\[]+))/g,function(e,t,i,r,o){a=a&&a[i?i.replace(/[\"\'\\]/,""):o]}),a)x=a;else if(!g){var E;E||h.push(j),E=!0,x=i(x,!1,x[o],!0,F),x._loadObject=t.loader}}else g||(x=i(x,h==p,void 0===T?void 0:m(T,w),!1,F,j!=p&&"object"==typeof j[w]&&j[w],p));if(p[w]=x,j!=p&&!j.__isDirty){var z=j[w];j[w]=x,!k||x===z||j._loadObject||"_"==w.charAt(0)&&"_"==w.charAt(1)||"$ref"==w||x instanceof Date&&z instanceof Date&&x.getTime()==z.getTime()||"function"==typeof x&&"function"==typeof z&&x.toString()==z.toString()||!d.onUpdate||d.onUpdate(j,w,z,x)}}}if(k&&(r in p||j instanceof Array)){for(w in j)if(!j.__isDirty&&j.hasOwnProperty(w)&&!p.hasOwnProperty(w)&&("_"!=w.charAt(0)||"_"!=w.charAt(1))&&!(j instanceof Array&&isNaN(w)))for(d.onUpdate&&"_loadObject"!=w&&"_idAttr"!=w&&d.onUpdate(j,w,j[w],void 0),delete j[w];j instanceof Array&&j.length&&void 0===j[j.length-1];)j.length--}else d.onLoad&&d.onLoad(j);return j}t=t||{};var a,r=t.idAttribute||"id",o=this.refAttribute,n=t.idAsRef,s=t.idPrefix||"",l=t.assignAbsoluteIds,d=t.index||{},u=t.timeStamps,h=[],c=/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,m=this._addProp,f=function(){};return e&&"object"==typeof e&&(e=i(e,!1,t.defaultId,!0),i(h,!1)),e},fromJson:function(str,args){function ref(e){var t={};return t[this.refAttribute]=e,t}var root;try{root=eval("("+str+")")}catch(e){throw new SyntaxError("Invalid JSON string: "+e.message+" parsing: "+str)}return root?this.resolveJson(root,args):root},toJson:function(e,t,i,a,r){function o(){var e=(m++).toString();return h.hasOwnProperty(e)?o():e}function n(e,a,m){if("object"==typeof e&&e){if(e instanceof Date)return'"'+stamp.toISOString(e,{zulu:!0})+'"';var f=e.__id;if(f){if("#"!=a&&(s&&!f.match(/#/)||u[f])){var p=f;"#"!=f.charAt(0)&&(p=e.__clientId==f?"cid:"+f:f.substring(0,i.length)==i?f.substring(i.length):f);var g={};return g[d]=p,djson.toJson(g,t)}a=f}else c?e instanceof Array||(a=o(),e.__id=a,h[a]=e):(e.__id=a,h[a]=e);u[a]=e,m=m||"";var y=t?m+djson.toJsonIndentStr:"",v=t?"\n":"",b=t?" ":"";if(e instanceof Array){return"["+array.map(e,function(e,t){var i=n(e,c?void 0:l(a,t),y);return"string"!=typeof i&&(i="undefined"),v+y+i}).join(","+b)+v+m+"]"}var _=[];c&&void 0===e[r]&&_.push(v+y+djson._escapeString(r)+":"+b+djson.toJson(e.__id));for(var M in e)if(e.hasOwnProperty(M)){var w;if("number"==typeof M)w='"'+M+'"';else{if("string"!=typeof M||"_"==M.charAt(0)&&"_"==M.charAt(1))continue;w=djson._escapeString(M)}var k=n(e[M],c?void 0:l(a,M),y);if("string"!=typeof k)continue;_.push(v+y+w+":"+b+k)}return"{"+_.join(","+b)+v+m+"}"}return"function"==typeof e&&dojox.json.ref.serializeFunctions?e.toString():djson.toJson(e)}var s=this._useRefs,l=this._addProp,d=this.refAttribute;i=i||"";var u={},h={},c=!!r,m=1,f=n(e,c?void 0:"#","");if(!a)for(var p in h)delete h[p].__id;return f},_addProp:function(e,t){return e+(e.match(/#/)?1==e.length?"":".":"#")+t},refAttribute:"$ref",_useRefs:!1,serializeFunctions:!1}});//# sourceMappingURL=ref.js.map