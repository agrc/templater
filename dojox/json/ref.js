//>>built
define("dojox/json/ref",["dojo/_base/array","dojo/_base/json","dojo/_base/kernel","dojo/_base/lang","dojo/date/stamp","dojox"],function(array,djson,dojo,lang,stamp,dojox){return lang.getObject("json",!0,dojox),dojox.json.ref={resolveJson:function(e,t){function i(p,g,y,v,b,M,_){var w,k,j,x=r in p?p[r]:y;(r in p||void 0!==x&&v)&&(x=(s+x).replace(c,"$2$3"));var I=M||p;if(void 0!==x){if(d&&(p.__id=x),!t.schemas||p instanceof Array||!(j=x.match(/^(.+\/)[^\.\[]*$/))||(b=t.schemas[j[1]]),l[x]&&p instanceof Array==l[x]instanceof Array)I=l[x],delete I.$ref,delete I._loadObject,k=!0;else{var T=b&&b.prototype;T&&(f.prototype=T,I=new f)}l[x]=I,h&&(h[x]=t.time)}for(;b;){var C=b.properties;if(C)for(w in p){var F=C[w];F&&"date-time"==F.format&&"string"==typeof p[w]&&(p[w]=stamp.fromISOString(p[w]))}b=b["extends"]}var E=p.length;for(w in p){if(w==E)break;if(p.hasOwnProperty(w)){if(j=p[w],"object"==typeof j&&j&&!(j instanceof Date)&&"__parent"!=w)if(a=j[o]||n&&j[r],p==u||a&&j.__parent||(j.__parent=_?_:I),a){delete p[w];var S=a.toString().replace(/(#)([^\.\[])/,"$1.$2").match(/(^([^\[]*\/)?[^#\.\[]*)#?([\.\[].*)?/);if(l[(s+a).replace(c,"$2$3")]?a=l[(s+a).replace(c,"$2$3")]:(a="$"==S[1]||"this"==S[1]||""==S[1]?e:l[(s+S[1]).replace(c,"$2$3")])&&S[3]&&S[3].replace(/(\[([^\]]+)\])|(\.?([^\.\[]+))/g,function(e,t,i,r,o){a=a&&a[i?i.replace(/[\"\'\\]/,""):o]}),a)j=a;else if(!g){var A;A||u.push(I),A=!0,j=i(j,!1,j[o],!0,F),j._loadObject=t.loader}}else g||(j=i(j,u==p,void 0===x?void 0:m(x,w),!1,F,I!=p&&"object"==typeof I[w]&&I[w],p));if(p[w]=j,I!=p&&!I.__isDirty){var N=I[w];I[w]=j,!k||j===N||I._loadObject||"_"==w.charAt(0)&&"_"==w.charAt(1)||"$ref"==w||j instanceof Date&&N instanceof Date&&j.getTime()==N.getTime()||"function"==typeof j&&"function"==typeof N&&j.toString()==N.toString()||!l.onUpdate||l.onUpdate(I,w,N,j)}}}if(k&&(r in p||I instanceof Array)){for(w in I)if(!I.__isDirty&&I.hasOwnProperty(w)&&!p.hasOwnProperty(w)&&("_"!=w.charAt(0)||"_"!=w.charAt(1))&&!(I instanceof Array&&isNaN(w)))for(l.onUpdate&&"_loadObject"!=w&&"_idAttr"!=w&&l.onUpdate(I,w,I[w],void 0),delete I[w];I instanceof Array&&I.length&&void 0===I[I.length-1];)I.length--}else l.onLoad&&l.onLoad(I);return I}t=t||{};var a,r=t.idAttribute||"id",o=this.refAttribute,n=t.idAsRef,s=t.idPrefix||"",d=t.assignAbsoluteIds,l=t.index||{},h=t.timeStamps,u=[],c=/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,m=this._addProp,f=function(){};return e&&"object"==typeof e&&(e=i(e,!1,t.defaultId,!0),i(u,!1)),e},fromJson:function(str,args){function ref(e){var t={};return t[this.refAttribute]=e,t}try{var root=eval("("+str+")")}catch(e){throw new SyntaxError("Invalid JSON string: "+e.message+" parsing: "+str)}return root?this.resolveJson(root,args):root},toJson:function(e,t,i,a){function r(e,a,h){if("object"==typeof e&&e){if(e instanceof Date)return'"'+stamp.toISOString(e,{zulu:!0})+'"';var u=e.__id;if(u){if("#"!=a&&(o&&!u.match(/#/)||d[u])){var c=u;"#"!=u.charAt(0)&&(c=e.__clientId==u?"cid:"+u:u.substring(0,i.length)==i?u.substring(i.length):u);var m={};return m[s]=c,djson.toJson(m,t)}a=u}else e.__id=a,l[a]=e;d[a]=e,h=h||"";var f=t?h+djson.toJsonIndentStr:"",p=t?"\n":"",g=t?" ":"";if(e instanceof Array){var y=array.map(e,function(e,t){var i=r(e,n(a,t),f);return"string"!=typeof i&&(i="undefined"),p+f+i});return"["+y.join(","+g)+p+h+"]"}var v=[];for(var b in e)if(e.hasOwnProperty(b)){var M;if("number"==typeof b)M='"'+b+'"';else{if("string"!=typeof b||"_"==b.charAt(0)&&"_"==b.charAt(1))continue;M=djson._escapeString(b)}var _=r(e[b],n(a,b),f);if("string"!=typeof _)continue;v.push(p+f+M+":"+g+_)}return"{"+v.join(","+g)+p+h+"}"}return"function"==typeof e&&dojox.json.ref.serializeFunctions?e.toString():djson.toJson(e)}var o=this._useRefs,n=this._addProp,s=this.refAttribute;i=i||"";var d={},l={},h=r(e,"#","");if(!a)for(var u in l)delete l[u].__id;return h},_addProp:function(e,t){return e+(e.match(/#/)?1==e.length?"":".":"#")+t},refAttribute:"$ref",_useRefs:!1,serializeFunctions:!1}});//# sourceMappingURL=ref.js.map