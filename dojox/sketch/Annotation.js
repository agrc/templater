//>>built
define("dojox/sketch/Annotation",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/declare","dojo/_base/json","./Anchor","./_Plugin"],function(e){e.declare("dojox.sketch.AnnotationTool",dojox.sketch._Plugin,{onMouseDown:function(e){this._omd=!0},onMouseMove:function(e,t){this._omd&&(this._cshape?this._cshape.setShape(t):(this._cshape=this.figure.surface.createRect(t).setStroke({color:"#999",width:1,style:"ShortDot"}).setFill([255,255,255,.7]),this._cshape.getEventSource().setAttribute("shape-rendering","crispEdges")))},onMouseUp:function(e){if(this._omd){this._omd=!1;var t=this.figure;if(this._cshape&&(t.surface.remove(this._cshape),delete this._cshape),t._startPoint.x!=e.pageX||t._startPoint.y!=e.pageY){var i=10;Math.max(i,Math.abs(t._absEnd.x-t._start.x),Math.abs(t._absEnd.y-t._start.y))>i&&this._create(t._start,t._end)}}},_create:function(e,t){var i=this.figure,o=i.nextKey(),a=new this.annotation(i,o);a.transform={dx:i._calCol(e.x/i.zoomFactor),dy:i._calCol(e.y/i.zoomFactor)},a.end={x:i._calCol(t.x/i.zoomFactor),y:i._calCol(t.y/i.zoomFactor)},a.control&&(a.control={x:i._calCol(t.x/2/i.zoomFactor),y:i._calCol(t.y/2/i.zoomFactor)}),i.onBeforeCreateShape(a),a.initialize(),i.select(a),i.onCreateShape(a),i.history.add(dojox.sketch.CommandTypes.Create,a)}}),dojox.sketch.Annotation=function(e,t){this.id=this._key=t,this.figure=e,this.mode=dojox.sketch.Annotation.Modes.View,this.shape=null,this.boundingBox=null,this.hasAnchors=!0,this.anchors={},this._properties={stroke:{color:"blue",width:2},font:{family:"Arial",size:16,weight:"bold"},fill:"blue",label:""},this.figure&&this.figure.add(this)};var t=dojox.sketch.Annotation.prototype;return t.constructor=dojox.sketch.Annotation,t.type=function(){return""},t.getType=function(){return dojox.sketch.Annotation},t.onRemove=function(e){this.figure.history.add(dojox.sketch.CommandTypes.Delete,this,this.serialize())},t.property=function(e,t){var i;return e=e.toLowerCase(),void 0!==this._properties[e]&&(i=this._properties[e]),arguments.length>1&&(this._properties[e]=t,i!=t&&this.onPropertyChange(e,i)),i},t.onPropertyChange=function(e,t){},t.onCreate=function(){this.figure.history.add(dojox.sketch.CommandTypes.Create,this)},t.onDblClick=function(e){var t=prompt("Set new text:",this.property("label"));t!==!1&&(this.beginEdit(dojox.sketch.CommandTypes.Modify),this.property("label",t),this.draw(),this.endEdit())},t.initialize=function(){},t.destroy=function(){},t.draw=function(){},t.apply=function(e){},t.serialize=function(){},t.getBBox=function(){},t.beginEdit=function(e){this._type||(this._type=e||dojox.sketch.CommandTypes.Move,this._prevState=this.serialize())},t.endEdit=function(){this._prevState!=this.serialize()&&this.figure.history.add(this._type,this,this._prevState),this._type=this._prevState=""},t.calculate={slope:function(e,t){return e.x-t.x?(e.y-t.y)/(e.x-t.x):0},dx:function(e,t,i){var o=this.slope(e,t);return 0==o?o:i/o},dy:function(e,t,i){return this.slope(e,t)*i}},t.drawBBox=function(){var e=this.getBBox();this.boundingBox?this.boundingBox.setShape(e):(this.boundingBox=this.shape.createRect(e).moveToBack().setStroke({color:"#999",width:1,style:"Dash"}).setFill([238,238,238,.3]),this.boundingBox.getEventSource().setAttribute("id",this.id+"-boundingBox"),this.boundingBox.getEventSource().setAttribute("shape-rendering","crispEdges"),this.figure._add(this))},t.setBinding=function(e){this.transform.dx+=e.dx,this.transform.dy+=e.dy,this.draw()},t.getTextBox=function(e){var t=this.property("font"),i={fontFamily:t.family,fontSize:t.size,fontWeight:t.weight};return e&&(i.fontSize=Math.floor(i.fontSize/e)),dojox.gfx._base._getTextBox(this.property("label"),i)},t.setMode=function(e){if(this.mode!=e){this.mode=e;var t="disable";e==dojox.sketch.Annotation.Modes.Edit&&(t="enable"),"enable"==t?(this.drawBBox(),this.figure._add(this)):this.boundingBox&&(this.shape&&this.shape.remove(this.boundingBox),this.boundingBox=null);for(var i in this.anchors)this.anchors[i][t]()}},t.zoom=function(t){if(t=t||this.figure.zoomFactor,this.labelShape){var i=e.clone(this.property("font"));i.size=Math.ceil(i.size/t)+"px",this.labelShape.setFont(i)}for(var o in this.anchors)this.anchors[o].zoom(t);if("vml"==dojox.gfx.renderer&&(t=1),this.pathShape){var a=e.clone(this.property("stroke"));a.width=t>1?a.width:Math.ceil(a.width/t)+"px",this.pathShape.setStroke(a)}},t.writeCommonAttrs=function(){return'id="'+this.id+'" dojoxsketch:type="'+this.type()+'" transform="translate('+this.transform.dx+","+this.transform.dy+')"'+(this.data?" ><![CDATA[data:"+e.toJson(this.data)+"]]":"")},t.readCommonAttrs=function(t){for(var i,o=0,a=t.childNodes;i=a[o++];)4==i.nodeType&&("properties:"==i.nodeValue.substr(0,11)?this._properties=e.fromJson(i.nodeValue.substr(11)):"data:"==i.nodeValue.substr(0,5)&&(this.data=e.fromJson(i.nodeValue.substr(5))));if(t.getAttribute("transform")){var r=t.getAttribute("transform").replace("translate(",""),n=r.split(",");this.transform.dx=parseFloat(n[0],10),this.transform.dy=parseFloat(n[1],10)}},dojox.sketch.Annotation.Modes={View:0,Edit:1},dojox.sketch.Annotation.register=function(t,i){var o=dojox.sketch[t+"Annotation"];dojox.sketch.registerTool(t,function(a){return e.mixin(a,{shape:t,annotation:o}),new(i||dojox.sketch.AnnotationTool)(a)})},dojox.sketch.Annotation});//# sourceMappingURL=Annotation.js.map