//>>built
define("dojox/data/JsonRestStore",["dojo/_base/lang","dojo/_base/declare","dojo/_base/connect","dojox/rpc/Rest","dojox/rpc/JsonRest","dojox/json/schema","dojox/data/ServiceStore"],function(e,t,a,i,r,o,d){var n=e.getObject("dojox.rpc",!0),l=t("dojox.data.JsonRestStore",d,{constructor:function(e){a.connect(i._index,"onUpdate",this,function(e,t,a,i){var r=this.service.servicePath;e.__id&&e.__id.substring(0,r.length)==r&&this.onSet(e,t,a,i)}),this.idAttribute=this.idAttribute||"id","string"==typeof e.target&&(e.target=e.target.match(/\/$/)||this.allowNoTrailingSlash?e.target:e.target+"/",this.service||(this.service=r.services[e.target]||i(e.target,!0))),r.registerService(this.service,e.target,this.schema),this.schema=this.service._schema=this.schema||this.service._schema||{},this.service._store=this,this.service.idAsRef=this.idAsRef,this.schema._idAttr=this.idAttribute;var t=r.getConstructor(this.service),o=this;this._constructor=function(e){t.call(this,e),o.onNew(this)},this._constructor.prototype=t.prototype,this._index=i._index},loadReferencedSchema:!0,idAsRef:!1,referenceIntegrity:!0,target:"",allowNoTrailingSlash:!1,newItem:function(e,t){if(e=new this._constructor(e),t){var a=this.getValue(t.parent,t.attribute,[]);a=a.concat([e]),e.__parent=a,this.setValue(t.parent,t.attribute,a)}return e},deleteItem:function(e){var t=[],a=s._getStoreForItem(e)||this;if(this.referenceIntegrity){r._saveNotNeeded=!0;var o=i._index,d=function(i){var r;t.push(i),i.__checked=1;for(var n in i)if("__"!=n.substring(0,2)){var l=i[n];l==e?i!=o&&(i instanceof Array?(r=r||[]).push(n):(s._getStoreForItem(i)||a).unsetAttribute(i,n)):"object"==typeof l&&l&&(l.__checked||d(l),"object"==typeof l.__checked&&i!=o&&(s._getStoreForItem(i)||a).setValue(i,n,l.__checked))}if(r){for(n=r.length,i=i.__checked=i.concat();n--;)i.splice(r[n],1);return i}return null};d(o),r._saveNotNeeded=!1;for(var n=0;t[n];)delete t[n++].__checked}r.deleteObject(e),a.onDelete(e)},changing:function(e,t){r.changing(e,t)},cancelChanging:function(e){if(e.__id){dirtyObjects=a=r.getDirtyObjects();for(var t=0;t<dirtyObjects.length;t++){var a=dirtyObjects[t];if(e==a.object)return void dirtyObjects.splice(t,1)}}},setValue:function(e,t,a){var i=e[t],r=e.__id?s._getStoreForItem(e):this;if(o&&r.schema&&r.schema.properties&&o.mustBeValid(o.checkPropertyChange(a,r.schema.properties[t])),t==r.idAttribute)throw new Error("Can not change the identity attribute for an item");r.changing(e),e[t]=a,a&&!a.__parent&&(a.__parent=e),r.onSet(e,t,i,a)},setValues:function(t,a,i){if(!e.isArray(i))throw new Error("setValues expects to be passed an Array object as its value");this.setValue(t,a,i)},unsetAttribute:function(e,t){this.changing(e);var a=e[t];delete e[t],this.onSet(e,t,a,void 0)},save:function(e){e&&e.global||((e=e||{}).service=this.service),("syncMode"in e?e.syncMode:this.syncMode)&&(n._sync=!0);var t=r.commit(e);return this.serverVersion=this._updates&&this._updates.length,t},revert:function(e){r.revert(!(e&&e.global)&&this.service)},isDirty:function(e){return r.isDirty(e,this)},isItem:function(e,t){return e&&e.__id&&(t||this.service==r.getServiceAndId(e.__id).service)},_doQuery:function(t){var a="string"==typeof t.queryStr?t.queryStr:t.query,i=r.query(this.service,a,t),o=this;return this.loadReferencedSchema&&i.addCallback(function(t){var a=i.ioArgs&&i.ioArgs.xhr&&i.ioArgs.xhr.getResponseHeader("Content-Type"),d=a&&a.match(/definedby\s*=\s*([^;]*)/);if(a&&!d&&(d=i.ioArgs.xhr.getResponseHeader("Link"),d=d&&d.match(/<([^>]*)>;\s*rel="?definedby"?/)),d=d&&d[1]){var n=r.getServiceAndId((o.target+d).replace(/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,"$2$3")),l=r.byId(n.service,n.id);return l.addCallbacks(function(a){return e.mixin(o.schema,a),t},function(e){return t}),l}}),i},_processResults:function(e,t){var a=e.length;return{totalCount:t.fullLength||(t.request.count==a?(t.request.start||0)+2*a:a),items:e}},getConstructor:function(){return this._constructor},getIdentity:function(e){var t=e.__clientId||e.__id;if(!t)return t;var a=this.service.servicePath.replace(/[^\/]*$/,"");return t.substring(0,a.length)!=a?t:t.substring(a.length)},fetchItemByIdentity:function(e){var t=e.identity,a=this;if(t.toString().match(/^(\w*:)?\//)){var i=r.getServiceAndId(t);a=i.service._store,e.identity=i.id}return e._prefix=a.service.servicePath.replace(/[^\/]*$/,""),a.inherited(arguments)},onSet:function(){},onNew:function(){},onDelete:function(){},getFeatures:function(){var e=this.inherited(arguments);return e["dojo.data.api.Write"]=!0,e["dojo.data.api.Notification"]=!0,e},getParent:function(e){return e&&e.__parent}});l.getStore=function(e,t){if("string"==typeof e.target){e.target=e.target.match(/\/$/)||e.allowNoTrailingSlash?e.target:e.target+"/";var a=(r.services[e.target]||{})._store;if(a)return a}return new(t||l)(e)};var s=e.getObject("dojox.data",!0);s._getStoreForItem=function(e){if(e.__id){var t=r.getServiceAndId(e.__id);if(t&&t.service._store)return t.service._store;var a=e.__id.toString().match(/.*\//)[0];return new l({target:a})}return null};var m=e.getObject("dojox.json.ref",!0);return m._useRefs=!0,l});//# sourceMappingURL=JsonRestStore.js.map