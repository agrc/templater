//>>built
define("dojox/data/QueryReadStore",["dojo","dojox","dojo/data/util/sorter","dojo/string"],function(e,t){return e.declare("dojox.data.QueryReadStore",null,{url:"",requestMethod:"get",_className:"dojox.data.QueryReadStore",_items:[],_lastServerQuery:null,_numRows:-1,lastRequestHash:null,doClientPaging:!1,doClientSorting:!1,_itemsByIdentity:null,_identifier:null,_features:{"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},_labelAttr:"label",constructor:function(t){e.mixin(this,t)},getValue:function(t,a,i){if(this._assertIsItem(t),!e.isString(a))throw new Error(this._className+".getValue(): Invalid attribute, string expected!");return!this.hasAttribute(t,a)&&i?i:t.i[a]},getValues:function(e,t){this._assertIsItem(e);var a=[];return this.hasAttribute(e,t)&&a.push(e.i[t]),a},getAttributes:function(e){this._assertIsItem(e);var t=[];for(var a in e.i)t.push(a);return t},hasAttribute:function(e,t){return this.isItem(e)&&"undefined"!=typeof e.i[t]},containsValue:function(e,t,a){for(var i=this.getValues(e,t),r=i.length,o=0;r>o;o++)if(i[o]==a)return!0;return!1},isItem:function(e){return e?"undefined"!=typeof e.r&&e.r==this:!1},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){this.isItemLoaded(e.item)},fetch:function(t){t=t||{},t.store||(t.store=this);var a=this,i=function(t,a){if(a.onError){var i=a.scope||e.global;a.onError.call(i,t,a)}},r=function(t,i,r){var o=i.abort||null,n=!1,d=i.start?i.start:0;0==a.doClientPaging&&(d=0);var s=i.count?d+i.count:t.length;i.abort=function(){n=!0,o&&o.call(i)};var l=i.scope||e.global;if(i.store||(i.store=a),i.onBegin&&i.onBegin.call(l,r,i),i.sort&&a.doClientSorting&&t.sort(e.data.util.sorter.createSortFunction(i.sort,a)),i.onItem)for(var m=d;m<t.length&&s>m;++m){var h=t[m];n||i.onItem.call(l,h,i)}if(i.onComplete&&!n){var u=null;i.onItem||(u=t.slice(d,s)),i.onComplete.call(l,u,i)}};return this._fetchItems(t,r,i),t},getFeatures:function(){return this._features},close:function(e){},getLabel:function(e){return this._labelAttr&&this.isItem(e)?this.getValue(e,this._labelAttr):void 0},getLabelAttributes:function(e){return this._labelAttr?[this._labelAttr]:null},_xhrFetchHandler:function(t,a,i,r){t=this._filterResponse(t),t.label&&(this._labelAttr=t.label);var o=t.numRows||-1;this._items=[],e.forEach(t.items,function(e){this._items.push({i:e,r:this})},this);var n=t.identifier;if(this._itemsByIdentity={},n){this._identifier=n;var d;for(d=0;d<this._items.length;++d){var s=this._items[d].i,l=s[n];if(this._itemsByIdentity[l])throw new Error(this._className+":  The json data as specified by: ["+this.url+"] is malformed.  Items within the list have identifier: ["+n+"].  Value collided: ["+l+"]");this._itemsByIdentity[l]=s}}else for(this._identifier=Number,d=0;d<this._items.length;++d)this._items[d].n=d;o=this._numRows=-1===o?this._items.length:o,i(this._items,a,o),this._numRows=o},_fetchItems:function(t,a,i){var r=t.serverQuery||t.query||{};if(this.doClientPaging||(r.start=t.start||0,t.count&&(r.count=t.count)),!this.doClientSorting&&t.sort){var o=[];e.forEach(t.sort,function(e){e&&e.attribute&&o.push((e.descending?"-":"")+e.attribute)}),r.sort=o.join(",")}if(this.doClientPaging&&null!==this._lastServerQuery&&e.toJson(r)==e.toJson(this._lastServerQuery))this._numRows=-1===this._numRows?this._items.length:this._numRows,a(this._items,t,this._numRows);else{var n="post"==this.requestMethod.toLowerCase()?e.xhrPost:e.xhrGet,d=n({url:this.url,handleAs:"json-comment-optional",content:r,failOk:!0});t.abort=function(){d.cancel()},d.addCallback(e.hitch(this,function(e){this._xhrFetchHandler(e,t,a,i)})),d.addErrback(function(e){i(e,t)}),this.lastRequestHash=(new Date).getTime()+"-"+String(Math.random()).substring(2),this._lastServerQuery=e.mixin({},r)}},_filterResponse:function(e){return e},_assertIsItem:function(e){if(!this.isItem(e))throw new Error(this._className+": Invalid item argument.")},_assertIsAttribute:function(e){if("string"!=typeof e)throw new Error(this._className+": Invalid attribute argument ('"+e+"').")},fetchItemByIdentity:function(t){if(this._itemsByIdentity){var a=this._itemsByIdentity[t.identity];if(void 0!==a){if(t.onItem){var i=t.scope?t.scope:e.global;t.onItem.call(i,{i:a,r:this})}return}}var r=function(a,i){var r=t.scope?t.scope:e.global;t.onError&&t.onError.call(r,a)},o=function(a,i){var r=t.scope?t.scope:e.global;try{var o=null;a&&1==a.length&&(o=a[0]),t.onItem&&t.onItem.call(r,o)}catch(n){t.onError&&t.onError.call(r,n)}},n={serverQuery:{id:t.identity}};this._fetchItems(n,o,r)},getIdentity:function(e){var t=null;return t=this._identifier===Number?e.n:e.i[this._identifier]},getIdentityAttributes:function(e){return[this._identifier]}})});//# sourceMappingURL=QueryReadStore.js.map