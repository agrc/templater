//>>built
define("dojox/data/AtomReadStore",["dojo","dojox","dojo/data/util/filter","dojo/data/util/simpleFetch","dojo/date/stamp"],function(e,t){e.experimental("dojox.data.AtomReadStore");var a=e.declare("dojox.data.AtomReadStore",null,{constructor:function(e){if(e&&(this.url=e.url,this.rewriteUrl=e.rewriteUrl,this.label=e.label||this.label,this.sendQuery=e.sendQuery||e.sendquery||this.sendQuery,this.unescapeHTML=e.unescapeHTML,"urlPreventCache"in e&&(this.urlPreventCache=!!e.urlPreventCache)),!this.url)throw new Error("AtomReadStore: a URL must be specified when creating the data store")},url:"",label:"title",sendQuery:!1,unescapeHTML:!1,urlPreventCache:!1,getValue:function(t,a,i){this._assertIsItem(t),this._assertIsAttribute(a),this._initItem(t),a=a.toLowerCase(),t._attribs[a]||t._parsed||(this._parseItem(t),t._parsed=!0);var r=t._attribs[a];if(!r&&"summary"==a){var o=this.getValue(t,"content"),d=new RegExp("/(<([^>]+)>)/g","i"),n=o.text.replace(d,"");r={text:n.substring(0,Math.min(400,n.length)),type:"text"},t._attribs[a]=r}return r&&this.unescapeHTML&&("content"!=a&&"summary"!=a&&"subtitle"!=a||t["_"+a+"Escaped"]||(r.text=this._unescapeHTML(r.text),t["_"+a+"Escaped"]=!0)),r?e.isArray(r)?r[0]:r:i},getValues:function(e,t){this._assertIsItem(e),this._assertIsAttribute(t),this._initItem(e),t=t.toLowerCase(),e._attribs[t]||this._parseItem(e);var a=e._attribs[t];return a?void 0!==a.length&&"string"!=typeof a?a:[a]:void 0},getAttributes:function(e){this._assertIsItem(e),e._attribs||(this._initItem(e),this._parseItem(e));var t=[];for(var a in e._attribs)t.push(a);return t},hasAttribute:function(e,t){return void 0!==this.getValue(e,t)},containsValue:function(e,t,a){for(var i=this.getValues(e,t),r=0;r<i.length;r++)if("string"==typeof a){if(i[r].toString&&i[r].toString()===a)return!0}else if(i[r]===a)return!0;return!1},isItem:function(e){return!!(e&&e.element&&e.store&&e.store===this)},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){},getFeatures:function(){return{"dojo.data.api.Read":!0}},getLabel:function(e){if(""!==this.label&&this.isItem(e)){var t=this.getValue(e,this.label);return t&&t.text?t.text:t?t.toString():void 0}},getLabelAttributes:function(e){return""!==this.label?[this.label]:null},getFeedValue:function(t,a){var i=this.getFeedValues(t,a);return e.isArray(i)?i[0]:i},getFeedValues:function(e,t){return this.doc?(this._feedMetaData||(this._feedMetaData={element:this.doc.getElementsByTagName("feed")[0],store:this,_attribs:{}},this._parseItem(this._feedMetaData)),this._feedMetaData._attribs[e]||t):t},_initItem:function(e){e._attribs||(e._attribs={})},_fetchItems:function(t,a,i){var r=this._getFetchUrl(t);if(!r)return void i(new Error("No URL specified."));var o=this.sendQuery?null:t,d=this,n=function(i){d.doc=i;var r=d._getItems(i,o),n=t.query;n&&(n.id?r=e.filter(r,function(e){return d.getValue(e,"id")==n.id}):n.category&&(r=e.filter(r,function(t){var a=d.getValues(t,"category");return!!a&&e.some(a,"return item.term=='"+n.category+"'")}))),r&&r.length>0?a(r,t):a([],t)};if(this.doc)n(this.doc);else{var l={url:r,handleAs:"xml",preventCache:this.urlPreventCache},s=e.xhrGet(l);s.addCallback(n),s.addErrback(function(e){i(e,t)})}},_getFetchUrl:function(t){if(!this.sendQuery)return this.url;var a=t.query;if(!a)return this.url;if(e.isString(a))return this.url+a;var i="";for(var r in a){var o=a[r];o&&(i&&(i+="&"),i+=r+"="+o)}if(!i)return this.url;var d=this.url;return d.indexOf("?")<0?d+="?":d+="&",d+i},_getItems:function(t,a){if(this._items)return this._items;var i=[],r=[];if(t.childNodes.length<1)return this._items=i,i;var o=e.filter(t.childNodes,"return item.tagName && item.tagName.toLowerCase() == 'feed'");a.query;if(!o||1!=o.length)return i;r=e.filter(o[0].childNodes,"return item.tagName && item.tagName.toLowerCase() == 'entry'"),a.onBegin&&a.onBegin(r.length,this.sendQuery?a:{});for(var d=0;d<r.length;d++){var n=r[d];1==n.nodeType&&i.push(this._getItem(n))}return this._items=i,i},close:function(e){},_getItem:function(e){return{element:e,store:this}},_parseItem:function(t){function a(e){var t=e.textContent||e.innerHTML||e.innerXML;if(!t&&e.childNodes[0]){var a=e.childNodes[0];!a||3!=a.nodeType&&4!=a.nodeType||(t=e.childNodes[0].nodeValue)}return t}function i(e){return{text:a(e),type:e.getAttribute("type")}}var r=t._attribs;e.forEach(t.element.childNodes,function(t){var o=t.tagName?t.tagName.toLowerCase():"";switch(o){case"title":r[o]={text:a(t),type:t.getAttribute("type")};break;case"subtitle":case"summary":case"content":r[o]=i(t);break;case"author":var d,n;e.forEach(t.childNodes,function(e){if(e.tagName)switch(e.tagName.toLowerCase()){case"name":d=e;break;case"uri":n=e}});var l={};d&&1==d.length&&(l.name=a(d[0])),n&&1==n.length&&(l.uri=a(n[0])),r[o]=l;break;case"id":r[o]=a(t);break;case"updated":case"published":r[o]=e.date.stamp.fromISOString(a(t));break;case"category":r[o]||(r[o]=[]),r[o].push({scheme:t.getAttribute("scheme"),term:t.getAttribute("term")});break;case"link":r[o]||(r[o]=[]);var s={rel:t.getAttribute("rel"),href:t.getAttribute("href"),type:t.getAttribute("type")};r[o].push(s),"alternate"==s.rel&&(r.alternate=s)}})},_unescapeHTML:function(e){return e=e.replace(/&#8217;/m,"'").replace(/&#8243;/m,'"').replace(/&#60;/m,">").replace(/&#62;/m,"<").replace(/&#38;/m,"&")},_assertIsItem:function(e){if(!this.isItem(e))throw new Error("dojox.data.AtomReadStore: Invalid item argument.")},_assertIsAttribute:function(e){if("string"!=typeof e)throw new Error("dojox.data.AtomReadStore: Invalid attribute argument.")}});return e.extend(a,e.data.util.simpleFetch),a});//# sourceMappingURL=AtomReadStore.js.map