//>>built
define("dojox/data/CsvStore",["dojo/_base/lang","dojo/_base/declare","dojo/_base/xhr","dojo/_base/kernel","dojo/data/util/filter","dojo/data/util/simpleFetch"],function(e,t,a,i,r,n){var o=t("dojox.data.CsvStore",null,{constructor:function(e){this._attributes=[],this._attributeIndexes={},this._dataArray=[],this._arrayOfAllItems=[],this._loadFinished=!1,e.url&&(this.url=e.url),this._csvData=e.data,e.label?this.label=e.label:""===this.label&&(this.label=void 0),this._storeProp="_csvStore",this._idProp="_csvId",this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._loadInProgress=!1,this._queuedFetches=[],this.identifier=e.identifier,""===this.identifier?delete this.identifier:this._idMap={},"separator"in e&&(this.separator=e.separator),"urlPreventCache"in e&&(this.urlPreventCache=!!e.urlPreventCache)},url:"",label:"",identifier:"",separator:",",urlPreventCache:!1,_assertIsItem:function(e){if(!this.isItem(e))throw new Error(this.declaredClass+": a function was passed an item argument that was not an item")},_getIndex:function(e){var t=this.getIdentity(e);return this.identifier&&(t=this._idMap[t]),t},getValue:function(e,t,a){this._assertIsItem(e);var i=a;if("string"!=typeof t)throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string");var r=this._attributeIndexes[t];if(null!=r){var n=this._dataArray[this._getIndex(e)];i=n[r]||a}return i},getValues:function(e,t){var a=this.getValue(e,t);return a?[a]:[]},getAttributes:function(e){this._assertIsItem(e);for(var t=[],a=this._dataArray[this._getIndex(e)],i=0;i<a.length;i++)""!==a[i]&&t.push(this._attributes[i]);return t},hasAttribute:function(e,t){if(this._assertIsItem(e),"string"==typeof t){var a=this._attributeIndexes[t],i=this._dataArray[this._getIndex(e)];return"undefined"!=typeof a&&a<i.length&&""!==i[a]}throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string")},containsValue:function(e,t,a){var i=void 0;return"string"==typeof a&&(i=r.patternToRegExp(a,!1)),this._containsValue(e,t,a,i)},_containsValue:function(e,t,a,i){for(var r=this.getValues(e,t),n=0;n<r.length;++n){var o=r[n];if("string"==typeof o&&i)return null!==o.match(i);if(a===o)return!0}return!1},isItem:function(e){if(e&&e[this._storeProp]===this){var t=e[this._idProp];if(this.identifier){var a=this._dataArray[this._idMap[t]];if(a)return!0}else if(t>=0&&t<this._dataArray.length)return!0}return!1},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){},getFeatures:function(){return this._features},getLabel:function(e){return this.label&&this.isItem(e)?this.getValue(e,this.label):void 0},getLabelAttributes:function(e){return this.label?[this.label]:null},_fetchItems:function(e,t,i){var n=this,o=function(e,a){var i=null;if(e.query){var o,d;i=[];var s=e.queryOptions?e.queryOptions.ignoreCase:!1,l={};for(o in e.query)d=e.query[o],"string"==typeof d&&(l[o]=r.patternToRegExp(d,s));for(var u=0;u<a.length;++u){var c=!0,m=a[u];for(o in e.query)d=e.query[o],n._containsValue(m,o,d,l[o])||(c=!1);c&&i.push(m)}}else i=a.slice(0,a.length);t(i,e)};if(this._loadFinished)o(e,this._arrayOfAllItems);else if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:e,filter:o});else{this._loadInProgress=!0;var d={url:n.url,handleAs:"text",preventCache:n.urlPreventCache},s=a.get(d);s.addCallback(function(t){try{n._processData(t),o(e,n._arrayOfAllItems),n._handleQueuedFetches()}catch(a){i(a,e)}}),s.addErrback(function(t){if(n._loadInProgress=!1,!i)throw t;i(t,e)});var l=null;e.abort&&(l=e.abort),e.abort=function(){var t=s;t&&-1===t.fired&&(t.cancel(),t=null),l&&l.call(e)}}else if(this._csvData)try{this._processData(this._csvData),this._csvData=null,o(e,this._arrayOfAllItems)}catch(u){i(u,e)}else{var c=new Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(!i)throw c;i(c,e)}},close:function(e){},_getArrayOfArraysFromCsvFileContents:function(t){if(e.isString(t)){var a,i=new RegExp("^\\s+","g"),r=new RegExp("\\s+$","g"),n=new RegExp('""',"g"),o=[],d=this._splitLines(t);for(a=0;a<d.length;++a){var s=d[a];if(s.length>0){for(var l=s.split(this.separator),u=0;u<l.length;){var c=l[u],m=c.replace(i,""),f=m.replace(r,""),h=f.charAt(0),y=f.charAt(f.length-1),p=f.charAt(f.length-2),v=f.charAt(f.length-3);if(2===f.length&&'""'==f)l[u]="";else if('"'==h&&('"'!=y||'"'==y&&'"'==p&&'"'!=v)){if(u+1===l.length)return;var g=l[u+1];l[u]=m+this.separator+g,l.splice(u+1,1)}else'"'==h&&'"'==y&&(f=f.slice(1,f.length-1),f=f.replace(n,'"')),l[u]=f,u+=1}o.push(l)}}for(this._attributes=o.shift(),a=0;a<this._attributes.length;a++)this._attributeIndexes[this._attributes[a]]=a;this._dataArray=o}},_splitLines:function(e){var t,a=[],i="",r=!1;for(t=0;t<e.length;t++){var n=e.charAt(t);switch(n){case'"':r=!r,i+=n;break;case"\r":r?i+=n:(a.push(i),i="",t<e.length-1&&"\n"==e.charAt(t+1)&&t++);break;case"\n":r?i+=n:(a.push(i),i="");break;default:i+=n}}return""!==i&&a.push(i),a},_processData:function(e){if(this._getArrayOfArraysFromCsvFileContents(e),this._arrayOfAllItems=[],this.identifier&&void 0===this._attributeIndexes[this.identifier])throw new Error(this.declaredClass+": Identity specified is not a column header in the data set.");for(var t=0;t<this._dataArray.length;t++){var a=t;if(this.identifier){var i=this._dataArray[t];a=i[this._attributeIndexes[this.identifier]],this._idMap[a]=t}this._arrayOfAllItems.push(this._createItemFromIdentity(a))}this._loadFinished=!0,this._loadInProgress=!1},_createItemFromIdentity:function(e){var t={};return t[this._storeProp]=this,t[this._idProp]=e,t},getIdentity:function(e){return this.isItem(e)?e[this._idProp]:null},fetchItemByIdentity:function(e){var t,r=e.scope?e.scope:i.global;if(this._loadFinished)t=this._createItemFromIdentity(e.identity),this.isItem(t)||(t=null),e.onItem&&e.onItem.call(r,t);else{var n=this;if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:e});else{this._loadInProgress=!0;var o={url:n.url,handleAs:"text"},d=a.get(o);d.addCallback(function(t){try{n._processData(t);var a=n._createItemFromIdentity(e.identity);n.isItem(a)||(a=null),e.onItem&&e.onItem.call(r,a),n._handleQueuedFetches()}catch(i){e.onError&&e.onError.call(r,i)}}),d.addErrback(function(t){this._loadInProgress=!1,e.onError&&e.onError.call(r,t)})}else if(this._csvData)try{n._processData(n._csvData),n._csvData=null,t=n._createItemFromIdentity(e.identity),n.isItem(t)||(t=null),e.onItem&&e.onItem.call(r,t)}catch(s){e.onError&&e.onError.call(r,s)}}},getIdentityAttributes:function(e){return this.identifier?[this.identifier]:null},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var e=0;e<this._queuedFetches.length;e++){var t=this._queuedFetches[e],a=t.filter,i=t.args;a?a(i,this._arrayOfAllItems):this.fetchItemByIdentity(t.args)}this._queuedFetches=[]}}});return e.extend(o,n),o});//# sourceMappingURL=CsvStore.js.map