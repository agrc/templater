//>>built
define("dojox/data/CsvStore",["dojo/_base/lang","dojo/_base/declare","dojo/_base/xhr","dojo/_base/kernel","dojo/data/util/filter","dojo/data/util/simpleFetch"],function(e,t,i,a,r,n){var o=t("dojox.data.CsvStore",null,{constructor:function(e){this._attributes=[],this._attributeIndexes={},this._dataArray=[],this._arrayOfAllItems=[],this._loadFinished=!1,e.url&&(this.url=e.url),this._csvData=e.data,e.label?this.label=e.label:""===this.label&&(this.label=void 0),this._storeProp="_csvStore",this._idProp="_csvId",this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._loadInProgress=!1,this._queuedFetches=[],this.identifier=e.identifier,""===this.identifier?delete this.identifier:this._idMap={},"separator"in e&&(this.separator=e.separator),"urlPreventCache"in e&&(this.urlPreventCache=!!e.urlPreventCache)},url:"",label:"",identifier:"",separator:",",urlPreventCache:!1,_assertIsItem:function(e){if(!this.isItem(e))throw new Error(this.declaredClass+": a function was passed an item argument that was not an item")},_getIndex:function(e){var t=this.getIdentity(e);return this.identifier&&(t=this._idMap[t]),t},getValue:function(e,t,i){this._assertIsItem(e);var a=i;if("string"!=typeof t)throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string");var r=this._attributeIndexes[t];if(null!=r){var n=this._dataArray[this._getIndex(e)];a=n[r]||i}return a},getValues:function(e,t){var i=this.getValue(e,t);return i?[i]:[]},getAttributes:function(e){this._assertIsItem(e);for(var t=[],i=this._dataArray[this._getIndex(e)],a=0;a<i.length;a++)""!==i[a]&&t.push(this._attributes[a]);return t},hasAttribute:function(e,t){if(this._assertIsItem(e),"string"==typeof t){var i=this._attributeIndexes[t],a=this._dataArray[this._getIndex(e)];return"undefined"!=typeof i&&i<a.length&&""!==a[i]}throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string")},containsValue:function(e,t,i){var a=void 0;return"string"==typeof i&&(a=r.patternToRegExp(i,!1)),this._containsValue(e,t,i,a)},_containsValue:function(e,t,i,a){for(var r=this.getValues(e,t),n=0;n<r.length;++n){var o=r[n];if("string"==typeof o&&a)return null!==o.match(a);if(i===o)return!0}return!1},isItem:function(e){if(e&&e[this._storeProp]===this){var t=e[this._idProp];if(this.identifier){var i=this._dataArray[this._idMap[t]];if(i)return!0}else if(t>=0&&t<this._dataArray.length)return!0}return!1},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){},getFeatures:function(){return this._features},getLabel:function(e){return this.label&&this.isItem(e)?this.getValue(e,this.label):void 0},getLabelAttributes:function(e){return this.label?[this.label]:null},_fetchItems:function(e,t,a){var n=this,o=function(e,i){var a=null;if(e.query){var o,d;a=[];var s=e.queryOptions?e.queryOptions.ignoreCase:!1,l={};for(o in e.query)d=e.query[o],"string"==typeof d&&(l[o]=r.patternToRegExp(d,s));for(var u=0;u<i.length;++u){var c=!0,f=i[u];for(o in e.query)d=e.query[o],n._containsValue(f,o,d,l[o])||(c=!1);c&&a.push(f)}}else a=i.slice(0,i.length);t(a,e)};if(this._loadFinished)o(e,this._arrayOfAllItems);else if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:e,filter:o});else{this._loadInProgress=!0;var d={url:n.url,handleAs:"text",preventCache:n.urlPreventCache},s=i.get(d);s.addCallback(function(t){try{n._processData(t),o(e,n._arrayOfAllItems),n._handleQueuedFetches()}catch(i){a(i,e)}}),s.addErrback(function(t){if(n._loadInProgress=!1,!a)throw t;a(t,e)});var l=null;e.abort&&(l=e.abort),e.abort=function(){var t=s;t&&-1===t.fired&&(t.cancel(),t=null),l&&l.call(e)}}else if(this._csvData)try{this._processData(this._csvData),this._csvData=null,o(e,this._arrayOfAllItems)}catch(u){a(u,e)}else{var c=new Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(!a)throw c;a(c,e)}},close:function(e){},_getArrayOfArraysFromCsvFileContents:function(t){if(e.isString(t)){var i,a=new RegExp("^\\s+","g"),r=new RegExp("\\s+$","g"),n=new RegExp('""',"g"),o=[],d=this._splitLines(t);for(i=0;i<d.length;++i){var s=d[i];if(s.length>0){for(var l=s.split(this.separator),u=0;u<l.length;){var c=l[u],f=c.replace(a,""),m=f.replace(r,""),h=m.charAt(0),y=m.charAt(m.length-1),p=m.charAt(m.length-2),v=m.charAt(m.length-3);if(2===m.length&&'""'==m)l[u]="";else if('"'==h&&('"'!=y||'"'==y&&'"'==p&&'"'!=v)){if(u+1===l.length)return;var g=l[u+1];l[u]=f+this.separator+g,l.splice(u+1,1)}else'"'==h&&'"'==y&&(m=m.slice(1,m.length-1),m=m.replace(n,'"')),l[u]=m,u+=1}o.push(l)}}for(this._attributes=o.shift(),i=0;i<this._attributes.length;i++)this._attributeIndexes[this._attributes[i]]=i;this._dataArray=o}},_splitLines:function(e){var t,i=[],a="",r=!1;for(t=0;t<e.length;t++){var n=e.charAt(t);switch(n){case'"':r=!r,a+=n;break;case"\r":r?a+=n:(i.push(a),a="",t<e.length-1&&"\n"==e.charAt(t+1)&&t++);break;case"\n":r?a+=n:(i.push(a),a="");break;default:a+=n}}return""!==a&&i.push(a),i},_processData:function(e){if(this._getArrayOfArraysFromCsvFileContents(e),this._arrayOfAllItems=[],this.identifier&&void 0===this._attributeIndexes[this.identifier])throw new Error(this.declaredClass+": Identity specified is not a column header in the data set.");for(var t=0;t<this._dataArray.length;t++){var i=t;if(this.identifier){var a=this._dataArray[t];i=a[this._attributeIndexes[this.identifier]],this._idMap[i]=t}this._arrayOfAllItems.push(this._createItemFromIdentity(i))}this._loadFinished=!0,this._loadInProgress=!1},_createItemFromIdentity:function(e){var t={};return t[this._storeProp]=this,t[this._idProp]=e,t},getIdentity:function(e){return this.isItem(e)?e[this._idProp]:null},fetchItemByIdentity:function(e){var t,r=e.scope?e.scope:a.global;if(this._loadFinished)t=this._createItemFromIdentity(e.identity),this.isItem(t)||(t=null),e.onItem&&e.onItem.call(r,t);else{var n=this;if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:e});else{this._loadInProgress=!0;var o={url:n.url,handleAs:"text"},d=i.get(o);d.addCallback(function(t){try{n._processData(t);var i=n._createItemFromIdentity(e.identity);n.isItem(i)||(i=null),e.onItem&&e.onItem.call(r,i),n._handleQueuedFetches()}catch(a){e.onError&&e.onError.call(r,a)}}),d.addErrback(function(t){this._loadInProgress=!1,e.onError&&e.onError.call(r,t)})}else if(this._csvData)try{n._processData(n._csvData),n._csvData=null,t=n._createItemFromIdentity(e.identity),n.isItem(t)||(t=null),e.onItem&&e.onItem.call(r,t)}catch(s){e.onError&&e.onError.call(r,s)}}},getIdentityAttributes:function(e){return this.identifier?[this.identifier]:null},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var e=0;e<this._queuedFetches.length;e++){var t=this._queuedFetches[e],i=t.filter,a=t.args;i?i(a,this._arrayOfAllItems):this.fetchItemByIdentity(t.args)}this._queuedFetches=[]}}});return e.extend(o,n),o});//# sourceMappingURL=CsvStore.js.map