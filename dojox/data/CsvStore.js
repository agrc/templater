//>>built
define("dojox/data/CsvStore",["dojo/_base/lang","dojo/_base/declare","dojo/_base/xhr","dojo/_base/kernel","dojo/data/util/filter","dojo/data/util/simpleFetch"],function(e,t,a,i,r,o){var d=t("dojox.data.CsvStore",null,{constructor:function(e){this._attributes=[],this._attributeIndexes={},this._dataArray=[],this._arrayOfAllItems=[],this._loadFinished=!1,e.url&&(this.url=e.url),this._csvData=e.data,e.label?this.label=e.label:""===this.label&&(this.label=void 0),this._storeProp="_csvStore",this._idProp="_csvId",this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._loadInProgress=!1,this._queuedFetches=[],this.identifier=e.identifier,""===this.identifier?delete this.identifier:this._idMap={},"separator"in e&&(this.separator=e.separator),"urlPreventCache"in e&&(this.urlPreventCache=!!e.urlPreventCache)},url:"",label:"",identifier:"",separator:",",urlPreventCache:!1,_assertIsItem:function(e){if(!this.isItem(e))throw new Error(this.declaredClass+": a function was passed an item argument that was not an item")},_getIndex:function(e){var t=this.getIdentity(e);return this.identifier&&(t=this._idMap[t]),t},getValue:function(e,t,a){this._assertIsItem(e);var i=a;if("string"!=typeof t)throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string");var r=this._attributeIndexes[t];if(null!=r){var o=this._dataArray[this._getIndex(e)];i=o[r]||a}return i},getValues:function(e,t){var a=this.getValue(e,t);return a?[a]:[]},getAttributes:function(e){this._assertIsItem(e);for(var t=[],a=this._dataArray[this._getIndex(e)],i=0;i<a.length;i++)""!==a[i]&&t.push(this._attributes[i]);return t},hasAttribute:function(e,t){if(this._assertIsItem(e),"string"==typeof t){var a=this._attributeIndexes[t],i=this._dataArray[this._getIndex(e)];return"undefined"!=typeof a&&a<i.length&&""!==i[a]}throw new Error(this.declaredClass+": a function was passed an attribute argument that was not a string")},containsValue:function(e,t,a){var i=void 0;return"string"==typeof a&&(i=r.patternToRegExp(a,!1)),this._containsValue(e,t,a,i)},_containsValue:function(e,t,a,i){for(var r=this.getValues(e,t),o=0;o<r.length;++o){var d=r[o];if("string"==typeof d&&i)return null!==d.match(i);if(a===d)return!0}return!1},isItem:function(e){if(e&&e[this._storeProp]===this){var t=e[this._idProp];if(this.identifier){var a=this._dataArray[this._idMap[t]];if(a)return!0}else if(t>=0&&t<this._dataArray.length)return!0}return!1},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){},getFeatures:function(){return this._features},getLabel:function(e){return this.label&&this.isItem(e)?this.getValue(e,this.label):void 0},getLabelAttributes:function(e){return this.label?[this.label]:null},_fetchItems:function(e,t,i){var o=this,d=function(e,a){var i=null;if(e.query){var d,n;i=[];var l=e.queryOptions?e.queryOptions.ignoreCase:!1,s={};for(d in e.query)n=e.query[d],"string"==typeof n&&(s[d]=r.patternToRegExp(n,l));for(var m=0;m<a.length;++m){var u=!0,f=a[m];for(d in e.query)n=e.query[d],o._containsValue(f,d,n,s[d])||(u=!1);u&&i.push(f)}}else i=a.slice(0,a.length);t(i,e)};if(this._loadFinished)d(e,this._arrayOfAllItems);else if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:e,filter:d});else{this._loadInProgress=!0;var n={url:o.url,handleAs:"text",preventCache:o.urlPreventCache},l=a.get(n);l.addCallback(function(t){try{o._processData(t),d(e,o._arrayOfAllItems),o._handleQueuedFetches()}catch(a){i(a,e)}}),l.addErrback(function(t){if(o._loadInProgress=!1,!i)throw t;i(t,e)});var s=null;e.abort&&(s=e.abort),e.abort=function(){var t=l;t&&-1===t.fired&&(t.cancel(),t=null),s&&s.call(e)}}else if(this._csvData)try{this._processData(this._csvData),this._csvData=null,d(e,this._arrayOfAllItems)}catch(m){i(m,e)}else{var u=new Error(this.declaredClass+": No CSV source data was provided as either URL or String data input.");if(!i)throw u;i(u,e)}},close:function(e){},_getArrayOfArraysFromCsvFileContents:function(t){if(e.isString(t)){var a,i=new RegExp("^\\s+","g"),r=new RegExp("\\s+$","g"),o=new RegExp('""',"g"),d=[],n=this._splitLines(t);for(a=0;a<n.length;++a){var l=n[a];if(l.length>0){for(var s=l.split(this.separator),m=0;m<s.length;){var u=s[m],f=u.replace(i,""),h=f.replace(r,""),y=h.charAt(0),c=h.charAt(h.length-1),v=h.charAt(h.length-2),M=h.charAt(h.length-3);if(2===h.length&&'""'==h)s[m]="";else if('"'==y&&('"'!=c||'"'==c&&'"'==v&&'"'!=M)){if(m+1===s.length)return;var p=s[m+1];s[m]=f+this.separator+p,s.splice(m+1,1)}else'"'==y&&'"'==c&&(h=h.slice(1,h.length-1),h=h.replace(o,'"')),s[m]=h,m+=1}d.push(s)}}for(this._attributes=d.shift(),a=0;a<this._attributes.length;a++)this._attributeIndexes[this._attributes[a]]=a;this._dataArray=d}},_splitLines:function(e){var t,a=[],i="",r=!1;for(t=0;t<e.length;t++){var o=e.charAt(t);switch(o){case'"':r=!r,i+=o;break;case"\r":r?i+=o:(a.push(i),i="",t<e.length-1&&"\n"==e.charAt(t+1)&&t++);break;case"\n":r?i+=o:(a.push(i),i="");break;default:i+=o}}return""!==i&&a.push(i),a},_processData:function(e){if(this._getArrayOfArraysFromCsvFileContents(e),this._arrayOfAllItems=[],this.identifier&&void 0===this._attributeIndexes[this.identifier])throw new Error(this.declaredClass+": Identity specified is not a column header in the data set.");for(var t=0;t<this._dataArray.length;t++){var a=t;if(this.identifier){var i=this._dataArray[t];a=i[this._attributeIndexes[this.identifier]],this._idMap[a]=t}this._arrayOfAllItems.push(this._createItemFromIdentity(a))}this._loadFinished=!0,this._loadInProgress=!1},_createItemFromIdentity:function(e){var t={};return t[this._storeProp]=this,t[this._idProp]=e,t},getIdentity:function(e){return this.isItem(e)?e[this._idProp]:null},fetchItemByIdentity:function(e){var t,r=e.scope?e.scope:i.global;if(this._loadFinished)t=this._createItemFromIdentity(e.identity),this.isItem(t)||(t=null),e.onItem&&e.onItem.call(r,t);else{var o=this;if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:e});else{this._loadInProgress=!0;var d={url:o.url,handleAs:"text"},n=a.get(d);n.addCallback(function(t){try{o._processData(t);var a=o._createItemFromIdentity(e.identity);o.isItem(a)||(a=null),e.onItem&&e.onItem.call(r,a),o._handleQueuedFetches()}catch(i){e.onError&&e.onError.call(r,i)}}),n.addErrback(function(t){this._loadInProgress=!1,e.onError&&e.onError.call(r,t)})}else if(this._csvData)try{o._processData(o._csvData),o._csvData=null,t=o._createItemFromIdentity(e.identity),o.isItem(t)||(t=null),e.onItem&&e.onItem.call(r,t)}catch(l){e.onError&&e.onError.call(r,l)}}},getIdentityAttributes:function(e){return this.identifier?[this.identifier]:null},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var e=0;e<this._queuedFetches.length;e++){var t=this._queuedFetches[e],a=t.filter,i=t.args;a?a(i,this._arrayOfAllItems):this.fetchItemByIdentity(t.args)}this._queuedFetches=[]}}});return e.extend(d,o),d});//# sourceMappingURL=CsvStore.js.map