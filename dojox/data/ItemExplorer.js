//>>built
define("dojox/data/ItemExplorer",["dojo","dijit","dojox","dojo/require!dijit/Tree,dijit/Dialog,dijit/Menu,dijit/form/ValidationTextBox,dijit/form/Textarea,dijit/form/Button,dijit/form/RadioButton,dijit/form/FilteringSelect"],function(e,t,a){e.provide("dojox.data.ItemExplorer"),e.require("dijit.Tree"),e.require("dijit.Dialog"),e.require("dijit.Menu"),e.require("dijit.form.ValidationTextBox"),e.require("dijit.form.Textarea"),e.require("dijit.form.Button"),e.require("dijit.form.RadioButton"),e.require("dijit.form.FilteringSelect"),function(){var a=function(e,t,a){var i=e.getValues(t,a);return i.length<2&&(i=e.getValue(t,a)),i};e.declare("dojox.data.ItemExplorer",t.Tree,{useSelect:!1,refSelectSearchAttr:null,constructor:function(t){e.mixin(this,t);var i=this,r={},o=this.rootModelNode={value:r,id:"root"};this._modelNodeIdMap={},this._modelNodePropMap={};var d=1;this.model={getRoot:function(e){e(o)},mayHaveChildren:function(e){return e.value&&"object"==typeof e.value&&!(e.value instanceof Date)},getChildren:function(e,t,o){function d(){if(u)n=i.store.getAttributes(s),l=s;else if(s&&"object"==typeof s){l=e.value,n=[];for(var r in s)s.hasOwnProperty(r)&&"__id"!=r&&"__clientId"!=r&&n.push(r)}if(n){for(var o,d=0;o=n[d++];)m.push({property:o,value:u?a(i.store,s,o):s[o],parent:l});m.push({addNew:!0,parent:l,parentNode:e})}t(m)}var n,l,s=e.value,m=[];if(s==r)return void t([]);var u=i.store&&i.store.isItem(s,!0);u&&!i.store.isItemLoaded(s)?i.store.loadItem({item:s,onItem:function(e){s=e,d()}}):d()},getIdentity:function(e){if(!e.id&&(e.addNew&&(e.property="--addNew"),e.id=d++,i.store)){if(i.store.isItem(e.value)){var t=i.store.getIdentity(e.value);(i._modelNodeIdMap[t]=i._modelNodeIdMap[t]||[]).push(e)}e.parent&&(t=i.store.getIdentity(e.parent)+"."+e.property,(i._modelNodePropMap[t]=i._modelNodePropMap[t]||[]).push(e))}return e.id},getLabel:function(e){return e===o?"Object Properties":e.addNew?e.parent instanceof Array?"Add new value":"Add new property":e.property+": "+(e.value instanceof Array?"("+e.value.length+" elements)":e.value)},onChildrenChange:function(e){},onChange:function(e){}}},postCreate:function(){this.inherited(arguments),e.connect(this,"onClick",function(e,t){this.lastFocused=t,e.addNew?this._addProperty():this._editProperty()});var a=new t.Menu({targetNodeIds:[this.rootNode.domNode],id:"contextMenu"});e.connect(a,"_openMyself",this,function(i){var r=t.getEnclosingWidget(i.target);if(r){var o=r.item;this.store.isItem(o.value,!0)&&!o.parent?(e.forEach(a.getChildren(),function(e){e.attr("disabled","Add"!=e.label)}),this.lastFocused=r):!o.value||"object"!=typeof o.value||o.value instanceof Date?o.property&&e.indexOf(this.store.getIdentityAttributes(),o.property)>=0?(this.focusNode(r),alert("Cannot modify an Identifier node.")):o.addNew?this.focusNode(r):(e.forEach(a.getChildren(),function(e){e.attr("disabled","Edit"!=e.label&&"Delete"!=e.label)}),this.lastFocused=r):(e.forEach(a.getChildren(),function(e){e.attr("disabled","Add"!=e.label&&"Delete"!=e.label)}),this.lastFocused=r)}}),a.addChild(new t.MenuItem({label:"Add",onClick:e.hitch(this,"_addProperty")})),a.addChild(new t.MenuItem({label:"Edit",onClick:e.hitch(this,"_editProperty")})),a.addChild(new t.MenuItem({label:"Delete",onClick:e.hitch(this,"_destroyProperty")})),a.startup()},store:null,setStore:function(t){this.store=t;var a=this;this._editDialog&&(this._editDialog.destroyRecursive(),delete this._editDialog),e.connect(t,"onSet",function(e,t,i,r){var o,d,n=a.store.getIdentity(e);if(o=a._modelNodeIdMap[n],o&&(void 0===i||void 0===r||i instanceof Array||r instanceof Array||"object"==typeof i||"object"==typeof r))for(d=0;d<o.length;d++)!function(e){a.model.getChildren(e,function(t){a.model.onChildrenChange(e,t)})}(o[d]);if(o=a._modelNodePropMap[n+"."+t])for(d=0;d<o.length;d++)o[d].value=r,a.model.onChange(o[d])}),this.rootNode.setChildItems([])},setItem:function(e){(this._modelNodeIdMap={})[this.store.getIdentity(e)]=[this.rootModelNode],this._modelNodePropMap={},this.rootModelNode.value=e;var t=this;this.model.getChildren(this.rootModelNode,function(e){t.rootNode.setChildItems(e)})},refreshItem:function(){this.setItem(this.rootModelNode.value)},_createEditDialog:function(){this._editDialog=new t.Dialog({title:"Edit Property",execute:e.hitch(this,"_updateItem"),preload:!0}),this._editDialog.placeAt(e.body()),this._editDialog.startup();var a=e.doc.createElement("div"),i=e.doc.createElement("label");e.attr(i,"for","property"),e.style(i,"fontWeight","bold"),e.attr(i,"innerHTML","Property:"),a.appendChild(i);new t.form.ValidationTextBox({name:"property",value:"",required:!0,disabled:!0}).placeAt(a);a.appendChild(e.doc.createElement("br")),a.appendChild(e.doc.createElement("br"));var r=(new t.form.RadioButton({name:"itemType",value:"value",onClick:e.hitch(this,function(){this._enableFields("value")})}).placeAt(a),e.doc.createElement("label"));e.attr(r,"for","value"),e.attr(r,"innerHTML","Value (JSON):"),a.appendChild(r);var o=e.doc.createElement("div");e.addClass(o,"value");new t.form.Textarea({name:"jsonVal"}).placeAt(o);a.appendChild(o);var d=(new t.form.RadioButton({name:"itemType",value:"reference",onClick:e.hitch(this,function(){this._enableFields("reference")})}).placeAt(a),e.doc.createElement("label"));e.attr(d,"for","_reference"),e.attr(d,"innerHTML","Reference (ID):"),a.appendChild(d),a.appendChild(e.doc.createElement("br"));var n=e.doc.createElement("div");if(e.addClass(n,"reference"),this.useSelect){new t.form.FilteringSelect({name:"_reference",store:this.store,searchAttr:this.refSelectSearchAttr||this.store.getIdentityAttributes()[0],required:!1,value:null,pageSize:10}).placeAt(n)}else{new t.form.ValidationTextBox({name:"_reference",value:"",promptMessage:"Enter the ID of the item to reference",isValid:e.hitch(this,function(e){return!0})}).placeAt(n)}a.appendChild(n),a.appendChild(e.doc.createElement("br")),a.appendChild(e.doc.createElement("br"));var l=document.createElement("div");l.setAttribute("dir","rtl");var s=new t.form.Button({type:"reset",label:"Cancel"}).placeAt(l);s.onClick=e.hitch(this._editDialog,"onCancel");new t.form.Button({type:"submit",label:"OK"}).placeAt(l);a.appendChild(l),this._editDialog.attr("content",a)},_enableFields:function(a){switch(a){case"reference":e.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(e){t.getEnclosingWidget(e).attr("disabled",!0)}),e.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(e){t.getEnclosingWidget(e).attr("disabled",!1)});break;case"value":e.query(".value [widgetId]",this._editDialog.containerNode).forEach(function(e){t.getEnclosingWidget(e).attr("disabled",!1)}),e.query(".reference [widgetId]",this._editDialog.containerNode).forEach(function(e){t.getEnclosingWidget(e).attr("disabled",!0)})}},_updateItem:function(t){function i(){try{var e,i=[],s=t.property;if(l){for(;!m.isItem(o.parent,!0);)r=r.getParent(),i.push(o.property),o=r.item;if(0==i.length)m.setValue(o.parent,o.property,d);else{for(n=a(m,o.parent,o.property),n instanceof Array&&(n=n.concat()),e=n;i.length>1;)e=e[i.pop()];e[i]=d,m.setValue(o.parent,o.property,n)}}else if(m.isItem(u,!0))m.isItemLoaded(u)?(u instanceof Array&&(s=u.length),m.setValue(u,s,d)):m.loadItem({item:u,onItem:function(e){e instanceof Array&&(s=e.length),m.setValue(e,s,d)}});else{for(o.value instanceof Array?i.push(o.value.length):i.push(t.property);!m.isItem(o.parent,!0);)r=r.getParent(),i.push(o.property),o=r.item;for(n=a(m,o.parent,o.property),e=n;i.length>1;)e=e[i.pop()];e[i]=d,m.setValue(o.parent,o.property,n)}}catch(h){alert(h)}}var r,o,d,n,l="Edit Property"==this._editDialog.attr("title"),s=this._editDialog,m=this.store;if(s.validate()){r=this.lastFocused,o=r.item;var u=o.value;switch(o.addNew&&(u=r.item.parent,r=r.getParent(),o=r.item),d=null,t.itemType){case"reference":this.store.fetchItemByIdentity({identity:t._reference,onItem:function(e){d=e,i()},onError:function(){alert("The id could not be found")}});break;case"value":var h=t.jsonVal;d=e.fromJson(h),"function"==typeof d&&(d.toString=function(){return h}),i()}}else s.show()},_editProperty:function(){var a=e.mixin({},this.lastFocused.item);this._editDialog?this._editDialog.reset():this._createEditDialog(),e.indexOf(this.store.getIdentityAttributes(),a.property)>=0?alert("Cannot Edit an Identifier!"):(this._editDialog.attr("title","Edit Property"),t.getEnclosingWidget(e.query("input",this._editDialog.containerNode)[0]).attr("disabled",!0),this.store.isItem(a.value,!0)?a.parent&&(a.itemType="reference",this._enableFields(a.itemType),a._reference=this.store.getIdentity(a.value),this._editDialog.attr("value",a),this._editDialog.show()):(!a.value||"object"!=typeof a.value||a.value instanceof Date)&&(a.itemType="value",this._enableFields(a.itemType),a.jsonVal="function"==typeof a.value?a.value.toString():a.value instanceof Date?'new Date("'+a.value+'")':e.toJson(a.value),this._editDialog.attr("value",a),this._editDialog.show()))},_destroyProperty:function(){for(var t=this.lastFocused,i=t.item,r=[];!this.store.isItem(i.parent,!0)||i.parent instanceof Array;)t=t.getParent(),r.push(i.property),i=t.item;if(e.indexOf(this.store.getIdentityAttributes(),i.property)>=0)alert("Cannot Delete an Identifier!");else try{if(r.length>0){var o,d=a(this.store,i.parent,i.property);for(o=d;r.length>1;)o=o[r.pop()];e.isArray(o)?o.splice(r,1):delete o[r],this.store.setValue(i.parent,i.property,d)}else this.store.unsetAttribute(i.parent,i.property)}catch(n){alert(n)}},_addProperty:function(){var a=this.lastFocused.item,i=a.value,r=e.hitch(this,function(){var a=null;this._editDialog?this._editDialog.reset():this._createEditDialog(),i instanceof Array?(a=i.length,t.getEnclosingWidget(e.query("input",this._editDialog.containerNode)[0]).attr("disabled",!0)):t.getEnclosingWidget(e.query("input",this._editDialog.containerNode)[0]).attr("disabled",!1),this._editDialog.attr("title","Add Property"),this._enableFields("value"),this._editDialog.attr("value",{itemType:"value",property:a}),this._editDialog.show()});a.addNew&&(a=this.lastFocused.getParent().item,i=this.lastFocused.item.parent),a.property&&e.indexOf(this.store.getIdentityAttributes(),a.property)>=0?alert("Cannot add properties to an ID node!"):this.store.isItem(i,!0)&&!this.store.isItemLoaded(i)?this.store.loadItem({item:i,onItem:function(e){i=e,r()}}):r()}})}()});//# sourceMappingURL=ItemExplorer.js.map