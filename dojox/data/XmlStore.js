//>>built
define("dojox/data/XmlStore",["dojo/_base/lang","dojo/_base/declare","dojo/_base/xhr","dojo/data/util/simpleFetch","dojo/_base/query","dojo/_base/array","dojo/_base/kernel","dojo/data/util/filter","dojox/xml/parser","dojox/data/XmlItem"],function(e,t,i,a,r,o,n,s,d,l){var m=t("dojox.data.XmlStore",null,{constructor:function(e){e&&(this.url=e.url,this.rootItem=e.rootItem||e.rootitem||this.rootItem,this.keyAttribute=e.keyAttribute||e.keyattribute||this.keyAttribute,this._attributeMap=e.attributeMap||e.attributemap,this.label=e.label||this.label,this.sendQuery=e.sendQuery||e.sendquery||this.sendQuery,"urlPreventCache"in e&&(this.urlPreventCache=!!e.urlPreventCache)),this._newItems=[],this._deletedItems=[],this._modifiedItems=[]},url:"",rootItem:"",keyAttribute:"",label:"",sendQuery:!1,attributeMap:null,urlPreventCache:!0,getValue:function(e,t,i){var a,r,o=e.element;if("tagName"===t)return o.nodeName;if("childNodes"===t){for(a=0;a<o.childNodes.length;a++)if(r=o.childNodes[a],1===r.nodeType)return this._getItem(r);return i}if("text()"===t){for(a=0;a<o.childNodes.length;a++)if(r=o.childNodes[a],3===r.nodeType||4===r.nodeType)return r.nodeValue;return i}if(t=this._getAttribute(o.nodeName,t),"@"===t.charAt(0)){var n=t.substring(1),s=o.getAttribute(n);return s||i}for(a=0;a<o.childNodes.length;a++)if(r=o.childNodes[a],1===r.nodeType&&r.nodeName===t)return this._getItem(r);return i},getValues:function(e,t){var i,a,r=e.element,o=[];if("tagName"===t)return[r.nodeName];if("childNodes"===t){for(i=0;i<r.childNodes.length;i++)a=r.childNodes[i],1===a.nodeType&&o.push(this._getItem(a));return o}if("text()"===t){var n=r.childNodes;for(i=0;i<n.length;i++)a=n[i],3!==a.nodeType&&4!==a.nodeType||o.push(a.nodeValue);return o}if(t=this._getAttribute(r.nodeName,t),"@"===t.charAt(0)){var s=t.substring(1),d=r.getAttribute(s);return void 0!==d?[d]:[]}for(i=0;i<r.childNodes.length;i++)a=r.childNodes[i],1===a.nodeType&&a.nodeName===t&&o.push(this._getItem(a));return o},getAttributes:function(e){var t,i=e.element,a=[];if(a.push("tagName"),i.childNodes.length>0){var r={},o=!0,n=!1;for(t=0;t<i.childNodes.length;t++){var s=i.childNodes[t];if(1===s.nodeType){var d=s.nodeName;r[d]||(a.push(d),r[d]=d),o=!0}else 3===s.nodeType&&(n=!0)}o&&a.push("childNodes"),n&&a.push("text()")}for(t=0;t<i.attributes.length;t++)a.push("@"+i.attributes[t].nodeName);if(this._attributeMap)for(var l in this._attributeMap)if((t=l.indexOf("."))>0){var m=l.substring(0,t);m===i.nodeName&&a.push(l.substring(t+1))}else a.push(l);return a},hasAttribute:function(e,t){return void 0!==this.getValue(e,t)},containsValue:function(e,t,i){for(var a=this.getValues(e,t),r=0;r<a.length;r++)if("string"==typeof i){if(a[r].toString&&a[r].toString()===i)return!0}else if(a[r]===i)return!0;return!1},isItem:function(e){return!!(e&&e.element&&e.store&&e.store===this)},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){},getFeatures:function(){var e={"dojo.data.api.Read":!0,"dojo.data.api.Write":!0};return this.sendQuery&&""===this.keyAttribute||(e["dojo.data.api.Identity"]=!0),e},getLabel:function(e){if(""!==this.label&&this.isItem(e)){var t=this.getValue(e,this.label);if(t)return t.toString()}},getLabelAttributes:function(e){return""!==this.label?[this.label]:null},_fetchItems:function(e,t,a){var r=this._getFetchUrl(e);if(!r)return void a(new Error("No URL specified."),e);var o=this.sendQuery?{}:e,n=this,s={url:r,handleAs:"xml",preventCache:n.urlPreventCache},d=i.get(s);d.addCallback(function(i){var a=n._getItems(i,o);a&&a.length>0?t(a,e):t([],e)}),d.addErrback(function(t){a(t,e)})},_getFetchUrl:function(t){if(!this.sendQuery)return this.url;var i=t.query;if(!i)return this.url;if(e.isString(i))return this.url+i;var a="";for(var r in i){var o=i[r];o&&(a&&(a+="&"),a+=r+"="+o)}if(!a)return this.url;var n=this.url;return n.indexOf("?")<0?n+="?":n+="&",n+a},_getItems:function(e,t){var i=null;t&&(i=t.query);var a=[],n=null;n=""!==this.rootItem?r(this.rootItem,e):e.documentElement.childNodes,!!t.queryOptions&&t.queryOptions.deep&&(n=this._flattenNodes(n));for(var d=0;d<n.length;d++){var l=n[d];if(1==l.nodeType){var m=this._getItem(l);if(i){var u,h,c=!!t.queryOptions&&t.queryOptions.ignoreCase,f=!1,y=!0,p={};for(var v in i)u=i[v],"string"==typeof u?p[v]=s.patternToRegExp(u,c):u&&(p[v]=u);for(var g in i){y=!1;var b=this.getValues(m,g);for(h=0;h<b.length;h++){if(u=b[h]){var M=i[g];if("string"==typeof u&&p[g])f=null!==u.match(p[g]);else if("object"==typeof u)if(u.toString&&p[g]){var k=u.toString();f=null!==k.match(p[g])}else f="*"===M||M===u}if(f)break}if(!f)break}(y||f)&&a.push(m)}else a.push(m)}}return o.forEach(a,function(e){e.element.parentNode&&e.element.parentNode.removeChild(e.element)},this),a},_flattenNodes:function(e){var t=[];if(e){var i;for(i=0;i<e.length;i++){var a=e[i];t.push(a),a.childNodes&&a.childNodes.length>0&&(t=t.concat(this._flattenNodes(a.childNodes)))}}return t},close:function(e){},newItem:function(e,t){e=e||{};var i=e.tagName;if(!i&&""===(i=this.rootItem))return null;var a=this._getDocument(),r=a.createElement(i);for(var o in e){var n;if("tagName"!==o)if("text()"===o)n=a.createTextNode(e[o]),r.appendChild(n);else if(o=this._getAttribute(i,o),"@"===o.charAt(0)){var s=o.substring(1);r.setAttribute(s,e[o])}else{var d=a.createElement(o);n=a.createTextNode(e[o]),d.appendChild(n),r.appendChild(d)}}var l=this._getItem(r);this._newItems.push(l);var m=null;if(t&&t.parent&&t.attribute){m={item:t.parent,attribute:t.attribute,oldValue:void 0};var u=this.getValues(t.parent,t.attribute);if(u&&u.length>0){var h=u.slice(0,u.length);1===u.length?m.oldValue=u[0]:m.oldValue=u.slice(0,u.length),h.push(l),this.setValues(t.parent,t.attribute,h),m.newValue=this.getValues(t.parent,t.attribute)}else this.setValue(t.parent,t.attribute,l),m.newValue=l}return l},deleteItem:function(e){var t=e.element;return t.parentNode?(this._backupItem(e),t.parentNode.removeChild(t),!0):(this._forgetItem(e),this._deletedItems.push(e),!0)},setValue:function(e,t,i){if("tagName"===t)return!1;this._backupItem(e);var a,r,o=e.element;if("childNodes"===t)a=i.element,o.appendChild(a);else if("text()"===t){for(;o.firstChild;)o.removeChild(o.firstChild);r=this._getDocument(o).createTextNode(i),o.appendChild(r)}else if(t=this._getAttribute(o.nodeName,t),"@"===t.charAt(0)){var n=t.substring(1);o.setAttribute(n,i)}else{for(var s=0;s<o.childNodes.length;s++){var d=o.childNodes[s];if(1===d.nodeType&&d.nodeName===t){a=d;break}}var l=this._getDocument(o);if(a)for(;a.firstChild;)a.removeChild(a.firstChild);else a=l.createElement(t),o.appendChild(a);r=l.createTextNode(i),a.appendChild(r)}return!0},setValues:function(e,t,i){if("tagName"===t)return!1;this._backupItem(e);var a,r,o,n=e.element;if("childNodes"===t){for(;n.firstChild;)n.removeChild(n.firstChild);for(a=0;a<i.length;a++)r=i[a].element,n.appendChild(r)}else if("text()"===t){for(;n.firstChild;)n.removeChild(n.firstChild);var s="";for(a=0;a<i.length;a++)s+=i[a];o=this._getDocument(n).createTextNode(s),n.appendChild(o)}else if(t=this._getAttribute(n.nodeName,t),"@"===t.charAt(0)){var d=t.substring(1);n.setAttribute(d,i[0])}else{for(a=n.childNodes.length-1;a>=0;a--){var l=n.childNodes[a];1===l.nodeType&&l.nodeName===t&&n.removeChild(l)}var m=this._getDocument(n);for(a=0;a<i.length;a++)r=m.createElement(t),o=m.createTextNode(i[a]),r.appendChild(o),n.appendChild(r)}return!0},unsetAttribute:function(e,t){if("tagName"===t)return!1;this._backupItem(e);var i=e.element;if("childNodes"===t||"text()"===t)for(;i.firstChild;)i.removeChild(i.firstChild);else if(t=this._getAttribute(i.nodeName,t),"@"===t.charAt(0)){var a=t.substring(1);i.removeAttribute(a)}else for(var r=i.childNodes.length-1;r>=0;r--){var o=i.childNodes[r];1===o.nodeType&&o.nodeName===t&&i.removeChild(o)}return!0},save:function(e){e||(e={});var t;for(t=0;t<this._modifiedItems.length;t++)this._saveItem(this._modifiedItems[t],e,"PUT");for(t=0;t<this._newItems.length;t++){this._newItems[t].element.parentNode?(this._newItems.splice(t,1),t--):this._saveItem(this._newItems[t],e,"POST")}for(t=0;t<this._deletedItems.length;t++)this._saveItem(this._deletedItems[t],e,"DELETE")},revert:function(){return this._newItems=[],this._restoreItems(this._deletedItems),this._deletedItems=[],this._restoreItems(this._modifiedItems),this._modifiedItems=[],!0},isDirty:function(e){if(e){var t=this._getRootElement(e.element);return this._getItemIndex(this._newItems,t)>=0||this._getItemIndex(this._deletedItems,t)>=0||this._getItemIndex(this._modifiedItems,t)>=0}return this._newItems.length>0||this._deletedItems.length>0||this._modifiedItems.length>0},_saveItem:function(e,t,a){var r,o;if(!(r="PUT"===a?this._getPutUrl(e):"DELETE"===a?this._getDeleteUrl(e):this._getPostUrl(e)))return void(t.onError&&(o=t.scope||n.global,t.onError.call(o,new Error("No URL for saving content: "+this._getPostContent(e)))));var s,d={url:r,method:a||"POST",contentType:"text/xml",handleAs:"xml"};"PUT"===a?(d.putData=this._getPutContent(e),s=i.put(d)):"DELETE"===a?s=i.del(d):(d.postData=this._getPostContent(e),s=i.post(d)),o=t.scope||n.global;var l=this;s.addCallback(function(i){l._forgetItem(e),t.onComplete&&t.onComplete.call(o)}),s.addErrback(function(e){t.onError&&t.onError.call(o,e)})},_getPostUrl:function(e){return this.url},_getPutUrl:function(e){return this.url},_getDeleteUrl:function(e){var t=this.url;if(e&&""!==this.keyAttribute){var i=this.getValue(e,this.keyAttribute);if(i){var a="@"===this.keyAttribute.charAt(0)?this.keyAttribute.substring(1):this.keyAttribute;t+=t.indexOf("?")<0?"?":"&",t+=a+"="+i}}return t},_getPostContent:function(e){return"<?xml version='1.0'?>"+d.innerXML(e.element)},_getPutContent:function(e){return"<?xml version='1.0'?>"+d.innerXML(e.element)},_getAttribute:function(e,t){if(this._attributeMap){var i=e+"."+t,a=this._attributeMap[i];a?t=a:(a=this._attributeMap[t])&&(t=a)}return t},_getItem:function(e){try{var t=null;return""===this.keyAttribute&&(t=this._getXPath(e)),new l(e,this,t)}catch(e){}return null},_getItemIndex:function(e,t){for(var i=0;i<e.length;i++)if(e[i].element===t)return i;return-1},_backupItem:function(e){var t=this._getRootElement(e.element);this._getItemIndex(this._newItems,t)>=0||this._getItemIndex(this._modifiedItems,t)>=0||(t!=e.element&&(e=this._getItem(t)),e._backup=t.cloneNode(!0),this._modifiedItems.push(e))},_restoreItems:function(e){o.forEach(e,function(e){e._backup&&(e.element=e._backup,e._backup=null)},this)},_forgetItem:function(e){var t=e.element,i=this._getItemIndex(this._newItems,t);i>=0&&this._newItems.splice(i,1),i=this._getItemIndex(this._deletedItems,t),i>=0&&this._deletedItems.splice(i,1),(i=this._getItemIndex(this._modifiedItems,t))>=0&&this._modifiedItems.splice(i,1)},_getDocument:function(e){return e?e.ownerDocument:this._document?null:d.parse()},_getRootElement:function(e){for(;e.parentNode;)e=e.parentNode;return e},_getXPath:function(e){var t=null;if(!this.sendQuery){var i=e;for(t="";i&&i!=e.ownerDocument;){for(var a=0,r=i,o=i.nodeName;r;)(r=r.previousSibling)&&r.nodeName===o&&a++;var n="/"+o+"["+a+"]";t=t?n+t:n,i=i.parentNode}}return t},getIdentity:function(e){if(this.isItem(e)){var t=null;return this.sendQuery&&""!==this.keyAttribute?t=this.getValue(e,this.keyAttribute).toString():this.serverQuery||(t=""!==this.keyAttribute?this.getValue(e,this.keyAttribute).toString():e.q),t}throw new Error("dojox.data.XmlStore: Object supplied to getIdentity is not an item")},getIdentityAttributes:function(e){if(this.isItem(e))return""!==this.keyAttribute?[this.keyAttribute]:null;throw new Error("dojox.data.XmlStore: Object supplied to getIdentity is not an item")},fetchItemByIdentity:function(e){var t=null,a=null,r=this,o=null,s=null,d=null;if(r.sendQuery){if(""!==r.keyAttribute){var l={query:{}};l.query[r.keyAttribute]=e.identity,o=this._getFetchUrl(l),t=function(t){var i=null;if(t){var a=r._getItems(t,{});if(1===a.length)i=a[0];else if(e.onError){var o=e.scope||n.global;e.onError.call(o,new Error("More than one item was returned from the server for the denoted identity"))}}e.onItem&&(o=e.scope||n.global,e.onItem.call(o,i))},s={url:o,handleAs:"xml",preventCache:r.urlPreventCache},d=i.get(s),d.addCallback(t),e.onError&&d.addErrback(function(t){var i=e.scope||n.global;e.onError.call(i,t)})}else if(e.onError){var m=e.scope||n.global;e.onError.call(m,new Error("XmlStore is not told that the server to provides identity support.  No keyAttribute specified."))}}else t=function(t){if(t)if(""!==r.keyAttribute){var i={};i.query={},i.query[r.keyAttribute]=e.identity,i.queryOptions={deep:!0};var o=r._getItems(t,i);a=e.scope||n.global,1===o.length?e.onItem&&e.onItem.call(a,o[0]):0===o.length?e.onItem&&e.onItem.call(a,null):e.onError&&e.onError.call(a,new Error("Items array size for identity lookup greater than 1, invalid keyAttribute."))}else{var s,d=e.identity.split("/"),l=t;for(s=0;s<d.length;s++)if(d[s]&&""!==d[s]){var m=d[s];m=m.substring(0,m.length-1);var u=m.split("["),h=u[0],c=parseInt(u[1],10),f=0;if(!l)break;var y=l.childNodes;if(y){var p,v=null;for(p=0;p<y.length;p++){var g=y[p];if(g.nodeName===h){if(!(f<c)){v=g;break}f++}}l=v||null}else l=null}var b=null;l&&(b=r._getItem(l),b.element.parentNode&&b.element.parentNode.removeChild(b.element)),e.onItem&&(a=e.scope||n.global,e.onItem.call(a,b))}},o=this._getFetchUrl(null),s={url:o,handleAs:"xml",preventCache:r.urlPreventCache},d=i.get(s),d.addCallback(t),e.onError&&d.addErrback(function(t){var i=e.scope||n.global;e.onError.call(i,t)})}});return e.extend(m,a),m});//# sourceMappingURL=XmlStore.js.map