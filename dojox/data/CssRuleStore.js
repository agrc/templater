//>>built
define("dojox/data/CssRuleStore",["dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/json","dojo/_base/kernel","dojo/_base/sniff","dojo/data/util/sorter","dojo/data/util/filter","./css"],function(e,t,i,a,r,n,o,d,s){return t("dojox.data.CssRuleStore",null,{_storeRef:"_S",_labelAttribute:"selector",_cache:null,_browserMap:null,_cName:"dojox.data.CssRuleStore",constructor:function(t){function i(){try{for(a.context=s.determineContext(a.context),a.gatherHandle&&(clearInterval(a.gatherHandle),a.gatherHandle=null);a._waiting.length;){var e=a._waiting.pop();s.rules.forEach(e.forFunc,null,a.context),e.finishFunc()}}catch(t){}}t&&e.mixin(this,t),this._cache={},this._allItems=null,this._waiting=[],this.gatherHandle=null;var a=this;this.gatherHandle=setInterval(i,250)},setContext:function(e){e&&(this.close(),this.context=s.determineContext(e))},getFeatures:function(){return{"dojo.data.api.Read":!0}},isItem:function(e){return!(!e||e[this._storeRef]!=this)},hasAttribute:function(e,t){this._assertIsItem(e),this._assertIsAttribute(t);var a=this.getAttributes(e);return-1!=i.indexOf(a,t)},getAttributes:function(e){this._assertIsItem(e);var t=["selector","classes","rule","style","cssText","styleSheet","parentStyleSheet","parentStyleSheetHref"],i=e.rule.style;if(i){var a;for(a in i)t.push("style."+a)}return t},getValue:function(e,t,i){var a=this.getValues(e,t);return a&&a.length>0?a[0]:i},getValues:function(t,i){this._assertIsItem(t),this._assertIsAttribute(i);var a=null;if("selector"===i)a=t.rule.selectorText,a&&e.isString(a)&&(a=a.split(","));else if("classes"===i)a=t.classes;else if("rule"===i)a=t.rule.rule;else if("style"===i)a=t.rule.style;else if("cssText"===i)n("ie")?t.rule.style&&(a=t.rule.style.cssText,a&&(a="{ "+a.toLowerCase()+" }")):(a=t.rule.cssText,a&&(a=a.substring(a.indexOf("{"),a.length)));else if("styleSheet"===i)a=t.rule.styleSheet;else if("parentStyleSheet"===i)a=t.rule.parentStyleSheet;else if("parentStyleSheetHref"===i)t.href&&(a=t.href);else if(0===i.indexOf("style.")){var r=i.substring(i.indexOf("."),i.length);a=t.rule.style[r]}else a=[];return void 0!==a&&(e.isArray(a)||(a=[a])),a},getLabel:function(e){return this._assertIsItem(e),this.getValue(e,this._labelAttribute)},getLabelAttributes:function(e){return[this._labelAttribute]},containsValue:function(e,t,i){var a=void 0;return"string"==typeof i&&(a=d.patternToRegExp(i,!1)),this._containsValue(e,t,i,a)},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){this._assertIsItem(e.item)},fetch:function(e){e=e||{},e.store||(e.store=this);e.scope||r.global;return this._pending&&this._pending.length>0?this._pending.push({request:e,fetch:!0}):(this._pending=[{request:e,fetch:!0}],this._fetch(e)),e},_fetch:function(t){var i=t.scope||r.global;if(null===this._allItems){this._allItems={};try{this.gatherHandle?this._waiting.push({forFunc:e.hitch(this,this._handleRule),finishFunc:e.hitch(this,this._handleReturn)}):(s.rules.forEach(e.hitch(this,this._handleRule),null,this.context),this._handleReturn())}catch(a){t.onError&&t.onError.call(i,a,t)}}else this._handleReturn()},_handleRule:function(e,t,i){for(var a=e.selectorText,r=a.split(" "),n=[],o=0;o<r.length;o++){var d=r[o],s=d.indexOf(".");if(d&&d.length>0&&-1!==s){var l=d.indexOf(",")||d.indexOf("[");d=d.substring(s,-1!==l&&l>s?l:d.length),n.push(d)}}var u={};u.rule=e,u.styleSheet=t,u.href=i,u.classes=n,u[this._storeRef]=this,this._allItems[a]||(this._allItems[a]=[]),this._allItems[a].push(u)},_handleReturn:function(){var e=[],t=[],i=null;for(var a in this._allItems){i=this._allItems[a];for(var r in i)t.push(i[r])}for(var n;this._pending.length;)n=this._pending.pop(),n.request._items=t,e.push(n);for(;e.length;)n=e.pop(),this._handleFetchReturn(n.request)},_handleFetchReturn:function(t){var i,n=t.scope||r.global,s=[],l="all";if(t.query&&(l=a.toJson(t.query)),this._cache[l])s=this._cache[l];else if(t.query){for(i in t._items){var u,f,c=t._items[i],m=t.queryOptions?t.queryOptions.ignoreCase:!1,h={};for(u in t.query)f=t.query[u],"string"==typeof f&&(h[u]=d.patternToRegExp(f,m));var y=!0;for(u in t.query)f=t.query[u],this._containsValue(c,u,f,h[u])||(y=!1);y&&s.push(c)}this._cache[l]=s}else for(i in t._items)s.push(t._items[i]);var p=s.length;t.sort&&s.sort(o.createSortFunction(t.sort,this));var v=0,g=s.length;t.start>0&&t.start<s.length&&(v=t.start),t.count&&t.count&&(g=t.count);var b=v+g;if(b>s.length&&(b=s.length),s=s.slice(v,b),t.onBegin&&t.onBegin.call(n,p,t),t.onItem){if(e.isArray(s)){for(i=0;i<s.length;i++)t.onItem.call(n,s[i],t);t.onComplete&&t.onComplete.call(n,null,t)}}else t.onComplete&&t.onComplete.call(n,s,t);return t},close:function(){this._cache={},this._allItems=null},_assertIsItem:function(e){if(!this.isItem(e))throw new Error(this._cName+": Invalid item argument.")},_assertIsAttribute:function(e){if("string"!=typeof e)throw new Error(this._cName+": Invalid attribute argument.")},_containsValue:function(t,a,r,n){return i.some(this.getValues(t,a),function(t){if(null!==t&&!e.isObject(t)&&n){if(t.toString().match(n))return!0}else if(r===t)return!0;return!1})}})});//# sourceMappingURL=CssRuleStore.js.map