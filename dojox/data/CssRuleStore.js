//>>built
define("dojox/data/CssRuleStore",["dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/json","dojo/_base/kernel","dojo/_base/sniff","dojo/data/util/sorter","dojo/data/util/filter","./css"],function(e,t,i,a,r,o,n,s,d){return t("dojox.data.CssRuleStore",null,{_storeRef:"_S",_labelAttribute:"selector",_cache:null,_browserMap:null,_cName:"dojox.data.CssRuleStore",constructor:function(t){function i(){try{for(a.context=d.determineContext(a.context),a.gatherHandle&&(clearInterval(a.gatherHandle),a.gatherHandle=null);a._waiting.length;){var e=a._waiting.pop();d.rules.forEach(e.forFunc,null,a.context),e.finishFunc()}}catch(e){}}t&&e.mixin(this,t),this._cache={},this._allItems=null,this._waiting=[],this.gatherHandle=null;var a=this;this.gatherHandle=setInterval(i,250)},setContext:function(e){e&&(this.close(),this.context=d.determineContext(e))},getFeatures:function(){return{"dojo.data.api.Read":!0}},isItem:function(e){return!(!e||e[this._storeRef]!=this)},hasAttribute:function(e,t){this._assertIsItem(e),this._assertIsAttribute(t);var a=this.getAttributes(e);return-1!=i.indexOf(a,t)},getAttributes:function(e){this._assertIsItem(e);var t=["selector","classes","rule","style","cssText","styleSheet","parentStyleSheet","parentStyleSheetHref"],i=e.rule.style;if(i){var a;for(a in i)t.push("style."+a)}return t},getValue:function(e,t,i){var a=this.getValues(e,t);return a&&a.length>0?a[0]:i},getValues:function(t,i){this._assertIsItem(t),this._assertIsAttribute(i);var a=null;if("selector"===i)(a=t.rule.selectorText)&&e.isString(a)&&(a=a.split(","));else if("classes"===i)a=t.classes;else if("rule"===i)a=t.rule.rule;else if("style"===i)a=t.rule.style;else if("cssText"===i)o("ie")?t.rule.style&&(a=t.rule.style.cssText)&&(a="{ "+a.toLowerCase()+" }"):(a=t.rule.cssText)&&(a=a.substring(a.indexOf("{"),a.length));else if("styleSheet"===i)a=t.rule.styleSheet;else if("parentStyleSheet"===i)a=t.rule.parentStyleSheet;else if("parentStyleSheetHref"===i)t.href&&(a=t.href);else if(0===i.indexOf("style.")){var r=i.substring(i.indexOf("."),i.length);a=t.rule.style[r]}else a=[];return void 0!==a&&(e.isArray(a)||(a=[a])),a},getLabel:function(e){return this._assertIsItem(e),this.getValue(e,this._labelAttribute)},getLabelAttributes:function(e){return[this._labelAttribute]},containsValue:function(e,t,i){var a=void 0;return"string"==typeof i&&(a=s.patternToRegExp(i,!1)),this._containsValue(e,t,i,a)},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){this._assertIsItem(e.item)},fetch:function(e){e=e||{},e.store||(e.store=this);e.scope||r.global;return this._pending&&this._pending.length>0?this._pending.push({request:e,fetch:!0}):(this._pending=[{request:e,fetch:!0}],this._fetch(e)),e},_fetch:function(t){var i=t.scope||r.global;if(null===this._allItems){this._allItems={};try{this.gatherHandle?this._waiting.push({forFunc:e.hitch(this,this._handleRule),finishFunc:e.hitch(this,this._handleReturn)}):(d.rules.forEach(e.hitch(this,this._handleRule),null,this.context),this._handleReturn())}catch(e){t.onError&&t.onError.call(i,e,t)}}else this._handleReturn()},_handleRule:function(e,t,i){for(var a=e.selectorText,r=a.split(" "),o=[],n=0;n<r.length;n++){var s=r[n],d=s.indexOf(".");if(s&&s.length>0&&-1!==d){var l=s.indexOf(",")||s.indexOf("[");s=s.substring(d,-1!==l&&l>d?l:s.length),o.push(s)}}var m={};m.rule=e,m.styleSheet=t,m.href=i,m.classes=o,m[this._storeRef]=this,this._allItems[a]||(this._allItems[a]=[]),this._allItems[a].push(m)},_handleReturn:function(){var e=[],t=[],i=null;for(var a in this._allItems){i=this._allItems[a];for(var r in i)t.push(i[r])}for(var o;this._pending.length;)o=this._pending.pop(),o.request._items=t,e.push(o);for(;e.length;)o=e.pop(),this._handleFetchReturn(o.request)},_handleFetchReturn:function(t){var i,o=t.scope||r.global,d=[],l="all";if(t.query&&(l=a.toJson(t.query)),this._cache[l])d=this._cache[l];else if(t.query){for(i in t._items){var m,h,u=t._items[i],c=!!t.queryOptions&&t.queryOptions.ignoreCase,f={};for(m in t.query)"string"==typeof(h=t.query[m])&&(f[m]=s.patternToRegExp(h,c));var y=!0;for(m in t.query)h=t.query[m],this._containsValue(u,m,h,f[m])||(y=!1);y&&d.push(u)}this._cache[l]=d}else for(i in t._items)d.push(t._items[i]);var p=d.length;t.sort&&d.sort(n.createSortFunction(t.sort,this));var v=0,g=d.length;t.start>0&&t.start<d.length&&(v=t.start),t.count&&t.count&&(g=t.count);var b=v+g;if(b>d.length&&(b=d.length),d=d.slice(v,b),t.onBegin&&t.onBegin.call(o,p,t),t.onItem){if(e.isArray(d)){for(i=0;i<d.length;i++)t.onItem.call(o,d[i],t);t.onComplete&&t.onComplete.call(o,null,t)}}else t.onComplete&&t.onComplete.call(o,d,t);return t},close:function(){this._cache={},this._allItems=null},_assertIsItem:function(e){if(!this.isItem(e))throw new Error(this._cName+": Invalid item argument.")},_assertIsAttribute:function(e){if("string"!=typeof e)throw new Error(this._cName+": Invalid attribute argument.")},_containsValue:function(t,a,r,o){return i.some(this.getValues(t,a),function(t){if(null!==t&&!e.isObject(t)&&o){if(t.toString().match(o))return!0}else if(r===t)return!0;return!1})}})});//# sourceMappingURL=CssRuleStore.js.map