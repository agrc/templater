//>>built
define("dojox/data/KeyValueStore",["dojo/_base/declare","dojo/_base/lang","dojo/_base/xhr","dojo/_base/kernel","dojo/data/util/simpleFetch","dojo/data/util/filter"],function(declare,lang,xhr,kernel,simpleFetch,filterUtil){var KeyValueStore=declare("dojox.data.KeyValueStore",null,{constructor:function(e){e.url&&(this.url=e.url),this._keyValueString=e.data,this._keyValueVar=e.dataVar,this._keyAttribute="key",this._valueAttribute="value",this._storeProp="_keyValueStore",this._features={"dojo.data.api.Read":!0,"dojo.data.api.Identity":!0},this._loadInProgress=!1,this._queuedFetches=[],e&&"urlPreventCache"in e&&(this.urlPreventCache=!!e.urlPreventCache)},url:"",data:"",urlPreventCache:!1,_assertIsItem:function(e){if(!this.isItem(e))throw new Error("dojox.data.KeyValueStore: a function was passed an item argument that was not an item")},_assertIsAttribute:function(e,t){if(!lang.isString(t))throw new Error("dojox.data.KeyValueStore: a function was passed an attribute argument that was not an attribute object nor an attribute name string")},getValue:function(e,t,a){this._assertIsItem(e),this._assertIsAttribute(e,t);var i;return i=t==this._keyAttribute?e[this._keyAttribute]:e[this._valueAttribute],void 0===i&&(i=a),i},getValues:function(e,t){var a=this.getValue(e,t);return a?[a]:[]},getAttributes:function(e){return[this._keyAttribute,this._valueAttribute,e[this._keyAttribute]]},hasAttribute:function(e,t){return this._assertIsItem(e),this._assertIsAttribute(e,t),t==this._keyAttribute||t==this._valueAttribute||t==e[this._keyAttribute]},containsValue:function(e,t,a){var i=void 0;return"string"==typeof a&&(i=filterUtil.patternToRegExp(a,!1)),this._containsValue(e,t,a,i)},_containsValue:function(e,t,a,i){for(var r=this.getValues(e,t),o=0;o<r.length;++o){var n=r[o];if("string"==typeof n&&i)return null!==n.match(i);if(a===n)return!0}return!1},isItem:function(e){return!(!e||e[this._storeProp]!==this)},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){},getFeatures:function(){return this._features},close:function(e){},getLabel:function(e){return e[this._keyAttribute]},getLabelAttributes:function(e){return[this._keyAttribute]},_fetchItems:function(keywordArgs,findCallback,errorCallback){var self=this,filter=function(e,t){var a=null;if(e.query){a=[];var i=e.queryOptions?e.queryOptions.ignoreCase:!1,r={};for(var o in e.query){var n=e.query[o];"string"==typeof n&&(r[o]=filterUtil.patternToRegExp(n,i))}for(var d=0;d<t.length;++d){var s=!0,l=t[d];for(var o in e.query){var n=e.query[o];self._containsValue(l,o,n,r[o])||(s=!1)}s&&a.push(l)}}else if(e.identity){a=[];var m;for(var o in t)if(m=t[o],m[self._keyAttribute]==e.identity){a.push(m);break}}else t.length>0&&(a=t.slice(0,t.length));findCallback(a,e)};if(this._loadFinished)filter(keywordArgs,this._arrayOfAllItems);else if(""!==this.url)if(this._loadInProgress)this._queuedFetches.push({args:keywordArgs,filter:filter});else{this._loadInProgress=!0;var getArgs={url:self.url,handleAs:"json-comment-filtered",preventCache:this.urlPreventCache},getHandler=xhr.get(getArgs);getHandler.addCallback(function(e){self._processData(e),filter(keywordArgs,self._arrayOfAllItems),self._handleQueuedFetches()}),getHandler.addErrback(function(e){throw self._loadInProgress=!1,e})}else if(this._keyValueString)this._processData(eval(this._keyValueString)),this._keyValueString=null,filter(keywordArgs,this._arrayOfAllItems);else{if(!this._keyValueVar)throw new Error("dojox.data.KeyValueStore: No source data was provided as either URL, String, or Javascript variable data input.");this._processData(this._keyValueVar),this._keyValueVar=null,filter(keywordArgs,this._arrayOfAllItems)}},_handleQueuedFetches:function(){if(this._queuedFetches.length>0){for(var e=0;e<this._queuedFetches.length;e++){var t=this._queuedFetches[e],a=t.filter,i=t.args;a?a(i,this._arrayOfAllItems):this.fetchItemByIdentity(t.args)}this._queuedFetches=[]}},_processData:function(e){this._arrayOfAllItems=[];for(var t=0;t<e.length;t++)this._arrayOfAllItems.push(this._createItem(e[t]));this._loadFinished=!0,this._loadInProgress=!1},_createItem:function(e){var t={};t[this._storeProp]=this;for(var a in e){t[this._keyAttribute]=a,t[this._valueAttribute]=e[a];break}return t},getIdentity:function(e){return this.isItem(e)?e[this._keyAttribute]:null},getIdentityAttributes:function(e){return[this._keyAttribute]},fetchItemByIdentity:function(e){e.oldOnItem=e.onItem,e.onItem=null,e.onComplete=this._finishFetchItemByIdentity,this.fetch(e)},_finishFetchItemByIdentity:function(e,t){var a=t.scope||kernel.global;e.length?t.oldOnItem.call(a,e[0]):t.oldOnItem.call(a,null)}});return lang.extend(KeyValueStore,simpleFetch),KeyValueStore});//# sourceMappingURL=KeyValueStore.js.map