//>>built
define("dojox/data/CdfStore",["dojo","dojox","dojo/data/util/sorter"],function(e,t){return t.data.ASYNC_MODE=0,t.data.SYNC_MODE=1,e.declare("dojox.data.CdfStore",null,{identity:"jsxid",url:"",xmlStr:"",data:null,label:"",mode:t.data.ASYNC_MODE,constructor:function(e){e&&(this.url=e.url,this.xmlStr=e.xmlStr||e.str,e.data&&(this.xmlStr=this._makeXmlString(e.data)),this.identity=e.identity||this.identity,this.label=e.label||this.label,this.mode=void 0!==e.mode?e.mode:this.mode),this._modifiedItems={},this.byId=this.fetchItemByIdentity},getValue:function(e,t,i){return e.getAttribute(t)||i},getValues:function(t,i){var a=this.getValue(t,i,[]);return e.isArray(a)?a:[a]},getAttributes:function(e){return e.getAttributeNames()},hasAttribute:function(e,t){return void 0!==this.getValue(e,t)},hasProperty:function(e,t){return this.hasAttribute(e,t)},containsValue:function(e,t,i){for(var a=this.getValues(e,t),r=0;r<a.length;r++)if(null!==a[r])if("string"==typeof i){if(a[r].toString&&a[r].toString()===i)return!0}else if(a[r]===i)return!0;return!1},isItem:function(e){return!(!e.getClass||!e.getClass().equals(jsx3.xml.Entity.jsxclass))},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){},getFeatures:function(){return{"dojo.data.api.Read":!0,"dojo.data.api.Write":!0,"dojo.data.api.Identity":!0}},getLabel:function(e){if(""!==this.label&&this.isItem(e)){var t=this.getValue(e,this.label);if(t)return t.toString()}},getLabelAttributes:function(e){return""!==this.label?[this.label]:null},fetch:function(i){i=i||{},i.store||(i.store=this),void 0!==i.mode&&(this.mode=i.mode);var a=this,r=function(t){if(i.onError){var a=i.scope||e.global;i.onError.call(a,t,i)}},o=function(t,r){r=r||i;var o=r.abort||null,n=!1,d=r.start?r.start:0,s=r.count&&r.count!==1/0?d+r.count:t.length;r.abort=function(){n=!0,o&&o.call(r)};var l=r.scope||e.global;if(r.store||(r.store=a),r.onBegin&&r.onBegin.call(l,t.length,r),r.sort&&t.sort(e.data.util.sorter.createSortFunction(r.sort,a)),r.onItem)for(var h=d;h<t.length&&s>h;++h){var m=t[h];n||r.onItem.call(l,m,r)}return r.onComplete&&!n?(r.onItem||(t=t.slice(d,s),r.byId&&(t=t[0])),r.onComplete.call(l,t,r)):(t=t.slice(d,s),r.byId&&(t=t[0])),t};if(!this.url&&!this.data&&!this.xmlStr)return r(new Error("No URL or data specified.")),!1;var n=i||"*";if(this.mode==t.data.SYNC_MODE){var d=this._loadCDF();if(d instanceof Error)return i.onError&&i.onError.call(i.scope||e.global,d,i),d;this.cdfDoc=d;var s=this._getItems(this.cdfDoc,n);return s=s&&s.length>0?o(s,i):o([],i)}var l=this._loadCDF();return l.addCallbacks(e.hitch(this,function(e){var t=this._getItems(this.cdfDoc,n);t&&t.length>0?o(t,i):o([],i)}),e.hitch(this,function(e){r(e,i)})),l},_loadCDF:function(){var i=new e.Deferred;if(this.cdfDoc)return this.mode==t.data.SYNC_MODE?this.cdfDoc:(setTimeout(e.hitch(this,function(){i.callback(this.cdfDoc)}),0),i);if(this.cdfDoc=jsx3.xml.CDF.Document.newDocument(),this.cdfDoc.subscribe("response",this,function(e){i.callback(this.cdfDoc)}),this.cdfDoc.subscribe("error",this,function(e){i.errback(e)}),this.cdfDoc.setAsync(!this.mode),this.url)this.cdfDoc.load(this.url);else if(this.xmlStr&&(this.cdfDoc.loadXML(this.xmlStr),this.cdfDoc.getError().code))return new Error(this.cdfDoc.getError().description);return this.mode==t.data.SYNC_MODE?this.cdfDoc:i},_getItems:function(e,t){for(var i=e.selectNodes(t.query,!1,1),a=[];i.hasNext();)a.push(i.next());return a},close:function(e){},newItem:function(e,t){e=e||{},e.tagName&&("record"!=e.tagName,delete e.tagName),e.jsxid=e.jsxid||this.cdfDoc.getKey(),this.isItem(t)&&(t=this.getIdentity(t));var i=this.cdfDoc.insertRecord(e,t);return this._makeDirty(i),i},deleteItem:function(e){return this.cdfDoc.deleteRecord(this.getIdentity(e)),this._makeDirty(e),!0},setValue:function(e,t,i){return this._makeDirty(e),e.setAttribute(t,i),!0},setValues:function(e,t,i){return this._makeDirty(e),e.setAttribute(t,i)},unsetAttribute:function(e,t){return this._makeDirty(e),e.removeAttribute(t),!0},revert:function(){return delete this.cdfDoc,this._modifiedItems={},!0},isDirty:function(e){if(e)return!!this._modifiedItems[this.getIdentity(e)];var t=!1;for(var i in this._modifiedItems){t=!0;break}return t},_makeDirty:function(e){var t=this.getIdentity(e);this._modifiedItems[t]=e},_makeXmlString:function(t){var i=function(t,a){var r,o="";if(e.isArray(t))for(var n=0;n<t.length;n++)o+=i(t[n],a);else if(e.isObject(t)){o+="<"+a+" ";for(r in t)e.isObject(t[r])||(o+=r+'="'+t[r]+'" ');o+=">";for(r in t)e.isObject(t[r])&&(o+=i(t[r],r));o+="</"+a+">"}return o};return i(t,"data")},getIdentity:function(e){return this.getValue(e,this.identity)},getIdentityAttributes:function(e){return[this.identity]},fetchItemByIdentity:function(i){if(e.isString(i)){var a=i;i={query:"//record[@jsxid='"+a+"']",mode:t.data.SYNC_MODE}}else i&&(i.query="//record[@jsxid='"+i.identity+"']"),i.mode||(i.mode=this.mode);return i.byId=!0,this.fetch(i)},byId:function(e){}})});//# sourceMappingURL=CdfStore.js.map