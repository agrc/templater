//>>built
define("dojox/data/CdfStore",["dojo","dojox","dojo/data/util/sorter"],function(e,t){return t.data.ASYNC_MODE=0,t.data.SYNC_MODE=1,e.declare("dojox.data.CdfStore",null,{identity:"jsxid",url:"",xmlStr:"",data:null,label:"",mode:t.data.ASYNC_MODE,constructor:function(e){e&&(this.url=e.url,this.xmlStr=e.xmlStr||e.str,e.data&&(this.xmlStr=this._makeXmlString(e.data)),this.identity=e.identity||this.identity,this.label=e.label||this.label,this.mode=void 0!==e.mode?e.mode:this.mode),this._modifiedItems={},this.byId=this.fetchItemByIdentity},getValue:function(e,t,a){return e.getAttribute(t)||a},getValues:function(t,a){var i=this.getValue(t,a,[]);return e.isArray(i)?i:[i]},getAttributes:function(e){return e.getAttributeNames()},hasAttribute:function(e,t){return void 0!==this.getValue(e,t)},hasProperty:function(e,t){return this.hasAttribute(e,t)},containsValue:function(e,t,a){for(var i=this.getValues(e,t),r=0;r<i.length;r++)if(null!==i[r])if("string"==typeof a){if(i[r].toString&&i[r].toString()===a)return!0}else if(i[r]===a)return!0;return!1},isItem:function(e){return!(!e.getClass||!e.getClass().equals(jsx3.xml.Entity.jsxclass))},isItemLoaded:function(e){return this.isItem(e)},loadItem:function(e){},getFeatures:function(){return{"dojo.data.api.Read":!0,"dojo.data.api.Write":!0,"dojo.data.api.Identity":!0}},getLabel:function(e){if(""!==this.label&&this.isItem(e)){var t=this.getValue(e,this.label);if(t)return t.toString()}},getLabelAttributes:function(e){return""!==this.label?[this.label]:null},fetch:function(a){a=a||{},a.store||(a.store=this),void 0!==a.mode&&(this.mode=a.mode);var i=this,r=function(t){if(a.onError){var i=a.scope||e.global;a.onError.call(i,t,a)}},o=function(t,r){r=r||a;var o=r.abort||null,n=!1,d=r.start?r.start:0,s=r.count&&r.count!==1/0?d+r.count:t.length;r.abort=function(){n=!0,o&&o.call(r)};var l=r.scope||e.global;if(r.store||(r.store=i),r.onBegin&&r.onBegin.call(l,t.length,r),r.sort&&t.sort(e.data.util.sorter.createSortFunction(r.sort,i)),r.onItem)for(var m=d;m<t.length&&s>m;++m){var u=t[m];n||r.onItem.call(l,u,r)}return r.onComplete&&!n?(r.onItem||(t=t.slice(d,s),r.byId&&(t=t[0])),r.onComplete.call(l,t,r)):(t=t.slice(d,s),r.byId&&(t=t[0])),t};if(!this.url&&!this.data&&!this.xmlStr)return r(new Error("No URL or data specified.")),!1;var n=a||"*";if(this.mode==t.data.SYNC_MODE){var d=this._loadCDF();if(d instanceof Error)return a.onError&&a.onError.call(a.scope||e.global,d,a),d;this.cdfDoc=d;var s=this._getItems(this.cdfDoc,n);return s=s&&s.length>0?o(s,a):o([],a)}var l=this._loadCDF();return l.addCallbacks(e.hitch(this,function(e){var t=this._getItems(this.cdfDoc,n);t&&t.length>0?o(t,a):o([],a)}),e.hitch(this,function(e){r(e,a)})),l},_loadCDF:function(){var a=new e.Deferred;if(this.cdfDoc)return this.mode==t.data.SYNC_MODE?this.cdfDoc:(setTimeout(e.hitch(this,function(){a.callback(this.cdfDoc)}),0),a);if(this.cdfDoc=jsx3.xml.CDF.Document.newDocument(),this.cdfDoc.subscribe("response",this,function(e){a.callback(this.cdfDoc)}),this.cdfDoc.subscribe("error",this,function(e){a.errback(e)}),this.cdfDoc.setAsync(!this.mode),this.url)this.cdfDoc.load(this.url);else if(this.xmlStr&&(this.cdfDoc.loadXML(this.xmlStr),this.cdfDoc.getError().code))return new Error(this.cdfDoc.getError().description);return this.mode==t.data.SYNC_MODE?this.cdfDoc:a},_getItems:function(e,t){for(var a=e.selectNodes(t.query,!1,1),i=[];a.hasNext();)i.push(a.next());return i},close:function(e){},newItem:function(e,t){e=e||{},e.tagName&&("record"!=e.tagName,delete e.tagName),e.jsxid=e.jsxid||this.cdfDoc.getKey(),this.isItem(t)&&(t=this.getIdentity(t));var a=this.cdfDoc.insertRecord(e,t);return this._makeDirty(a),a},deleteItem:function(e){return this.cdfDoc.deleteRecord(this.getIdentity(e)),this._makeDirty(e),!0},setValue:function(e,t,a){return this._makeDirty(e),e.setAttribute(t,a),!0},setValues:function(e,t,a){return this._makeDirty(e),e.setAttribute(t,a)},unsetAttribute:function(e,t){return this._makeDirty(e),e.removeAttribute(t),!0},revert:function(){return delete this.cdfDoc,this._modifiedItems={},!0},isDirty:function(e){if(e)return!!this._modifiedItems[this.getIdentity(e)];var t=!1;for(var a in this._modifiedItems){t=!0;break}return t},_makeDirty:function(e){var t=this.getIdentity(e);this._modifiedItems[t]=e},_makeXmlString:function(t){var a=function(t,i){var r,o="";if(e.isArray(t))for(var n=0;n<t.length;n++)o+=a(t[n],i);else if(e.isObject(t)){o+="<"+i+" ";for(r in t)e.isObject(t[r])||(o+=r+'="'+t[r]+'" ');o+=">";for(r in t)e.isObject(t[r])&&(o+=a(t[r],r));o+="</"+i+">"}return o};return a(t,"data")},getIdentity:function(e){return this.getValue(e,this.identity)},getIdentityAttributes:function(e){return[this.identity]},fetchItemByIdentity:function(a){if(e.isString(a)){var i=a;a={query:"//record[@jsxid='"+i+"']",mode:t.data.SYNC_MODE}}else a&&(a.query="//record[@jsxid='"+a.identity+"']"),a.mode||(a.mode=this.mode);return a.byId=!0,this.fetch(a)},byId:function(e){}})});//# sourceMappingURL=CdfStore.js.map