//>>built
define("dojox/form/FileUploader",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/window","dojo/_base/sniff","dojo/query","dojo/dom","dojo/dom-style","dojo/dom-geometry","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-form","dojo/_base/config","dijit/_base/manager","dojo/io/iframe","dojo/_base/Color","dojo/_base/unload","dijit/_Widget","dijit/_TemplatedMixin","dijit/_Contained","dojox/embed/Flash","dojox/embed/flashVars","dojox/html/styles"],function(e,t,a,i,r,o,n,s,l,d,u,m,c,h,f,p,y,g,v,b,M,k,w,_,j,x){return e.deprecated("dojox.form.FileUploader","Use dojox.form.Uploader","2.0"),t("dojox.form.FileUploader",[M,k,w],{swfPath:p.uploaderPath||require.toUrl("dojox/form/resources/fileuploader.swf"),templateString:'<div><div dojoAttachPoint="progNode"><div dojoAttachPoint="progTextNode"></div></div><div dojoAttachPoint="insideNode" class="uploaderInsideNode"></div></div>',uploadUrl:"",isDebug:!1,devMode:!1,baseClass:"dojoxUploaderNorm",hoverClass:"dojoxUploaderHover",activeClass:"dojoxUploaderActive",disabledClass:"dojoxUploaderDisabled",force:"",uploaderType:"",flashObject:null,flashMovie:null,insideNode:null,deferredUploading:1,fileListId:"",uploadOnChange:!1,selectMultipleFiles:!0,htmlFieldName:"uploadedfile",flashFieldName:"flashUploadFiles",fileMask:null,minFlashVersion:9,tabIndex:-1,showProgress:!1,progressMessage:"Loading",progressBackgroundUrl:require.toUrl("dijit/themes/tundra/images/buttonActive.png"),progressBackgroundColor:"#ededed",progressWidgetId:"",skipServerCheck:!1,serverTimeout:5e3,log:function(){this.isDebug&&console.log(Array.prototype.slice.call(arguments).join(" "))},constructor:function(){this._subs=[]},postMixInProperties:function(){this.fileList=[],this._cons=[],this.fileMask=this.fileMask||[],this.fileInputs=[],this.fileCount=0,this.flashReady=!1,this._disabled=!1,this.force=this.force.toLowerCase(),this.uploaderType=(_.available>=this.minFlashVersion||"flash"==this.force)&&"html"!=this.force?"flash":"html",this.deferredUploading=this.deferredUploading===!0?1:this.deferredUploading,this._refNode=this.srcNodeRef,this.getButtonStyle()},startup:function(){},postCreate:function(){this.inherited(arguments),this.setButtonStyle();var e;"flash"==this.uploaderType?e="createFlashUploader":(this.uploaderType="html",e="createHtmlUploader"),this[e](),this.fileListId&&this.connect(l.byId(this.fileListId),"click",function(e){var t=e.target.parentNode.parentNode.parentNode;t.id&&t.id.indexOf("file_")>-1&&this.removeFile(t.id.split("file_")[1])}),b.addOnUnload(this,this.destroy)},getHiddenNode:function(e){if(!e)return null;for(var t=null,a=e.parentNode;a&&"body"!=a.tagName.toLowerCase();){var i=d.get(a,"display");if("none"==i){t=a;break}a=a.parentNode}return t},getButtonStyle:function(){var e=this.srcNodeRef;if(this._hiddenNode=this.getHiddenNode(e),this._hiddenNode&&d.set(this._hiddenNode,"display","block"),!e&&this.button&&this.button.domNode){var t=!0,a=this.button.domNode.className+" dijitButtonNode",i=this.getText(s(".dijitButtonText",this.button.domNode)[0]),r='<button id="'+this.button.id+'" class="'+a+'">'+i+"</button>";e=h.place(r,this.button.domNode,"after"),this.srcNodeRef=e,this.button.destroy(),this.baseClass="dijitButton",this.hoverClass="dijitButtonHover",this.pressClass="dijitButtonActive",this.disabledClass="dijitButtonDisabled"}else!this.srcNodeRef&&this.button&&(e=this.button);m.get(e,"class")&&(this.baseClass+=" "+m.get(e,"class")),m.set(e,"class",this.baseClass),this.norm=this.getStyle(e),this.width=this.norm.w,this.height=this.norm.h,"flash"==this.uploaderType?(this.over=this.getTempNodeStyle(e,this.baseClass+" "+this.hoverClass,t),this.down=this.getTempNodeStyle(e,this.baseClass+" "+this.activeClass,t),this.dsbl=this.getTempNodeStyle(e,this.baseClass+" "+this.disabledClass,t),this.fhtml={cn:this.getText(e),nr:this.norm,ov:this.over,dn:this.down,ds:this.dsbl}):(this.fhtml={cn:this.getText(e),nr:this.norm},"middle"==this.norm.va&&(this.norm.lh=this.norm.h)),this.devMode&&(this.log("classes - base:",this.baseClass," hover:",this.hoverClass,"active:",this.activeClass),this.log("fhtml:",this.fhtml),this.log("norm:",this.norm),this.log("over:",this.over),this.log("down:",this.down))},setButtonStyle:function(){d.set(this.domNode,{width:this.fhtml.nr.w+"px",height:this.fhtml.nr.h+"px",padding:"0px",lineHeight:"normal",position:"relative"}),"html"==this.uploaderType&&"middle"==this.norm.va&&d.set(this.domNode,"lineHeight",this.norm.lh+"px"),this.showProgress?(this.progTextNode.innerHTML=this.progressMessage,d.set(this.progTextNode,{width:this.fhtml.nr.w+"px",height:this.fhtml.nr.h+0+"px",padding:"0px",margin:"0px",left:"0px",lineHeight:this.fhtml.nr.h+0+"px",position:"absolute"}),d.set(this.progNode,{width:this.fhtml.nr.w+"px",height:this.fhtml.nr.h+0+"px",padding:"0px",margin:"0px",left:"0px",position:"absolute",display:"none",backgroundImage:"url("+this.progressBackgroundUrl+")",backgroundPosition:"bottom",backgroundRepeat:"repeat-x",backgroundColor:this.progressBackgroundColor})):h.destroy(this.progNode),d.set(this.insideNode,{position:"absolute",top:"0px",left:"0px",display:""}),c.add(this.domNode,this.srcNodeRef.className),this.fhtml.nr.d.indexOf("inline")>-1&&c.add(this.domNode,"dijitInline");try{this.insideNode.innerHTML=this.fhtml.cn}catch(e){if("flash"==this.uploaderType){this.insideNode=this.insideNode.parentNode.removeChild(this.insideNode),o.body().appendChild(this.insideNode),this.insideNode.innerHTML=this.fhtml.cn;var t=r.connect(this,"onReady",this,function(){r.disconnect(t),this.insideNode=this.insideNode.parentNode.removeChild(this.insideNode),this.domNode.appendChild(this.insideNode)})}else this.insideNode.appendChild(document.createTextNode(this.fhtml.cn))}this._hiddenNode&&d.set(this._hiddenNode,"display","none")},onChange:function(e){},onProgress:function(e){},onComplete:function(e){},onCancel:function(){},onError:function(e){},onReady:function(e){},onLoad:function(e){},submit:function(e){var t=e?f.toObject(e):null;return this.upload(t),!1},upload:function(e){if(!this.fileList.length)return!1;if(!this.uploadUrl)return!1;if(this.showProgress||this.set("disabled",!0),this.progressWidgetId){var t=y.byId(this.progressWidgetId).domNode;"none"==d.get(t,"display")&&(this.restoreProgDisplay="none",d.set(t,"display","block")),"hidden"==d.get(t,"visibility")&&(this.restoreProgDisplay="hidden",d.set(t,"visibility","visible"))}e&&!e.target&&(this.postData=e),this.log("upload type:",this.uploaderType," - postData:",this.postData);for(var a=0;a<this.fileList.length;a++){var i=this.fileList[a];i.bytesLoaded=0,i.bytesTotal=i.size||1e5,i.percent=0}return"flash"==this.uploaderType?this.uploadFlash():this.uploadHTML(),!1},removeFile:function(e,t){var a;for(a=0;a<this.fileList.length;a++)if(this.fileList[a].name==e){t||this.fileList.splice(a,1);break}"flash"==this.uploaderType?this.flashMovie.removeFile(e):t||(h.destroy(this.fileInputs[a]),this.fileInputs.splice(a,1),this._renumberInputs()),this.fileListId&&h.destroy("file_"+e)},destroy:function(){return"flash"!=this.uploaderType||this.flashMovie?(i.forEach(this._subs,r.unsubscribe,dojo),i.forEach(this._cons,r.disconnect,dojo),this.scrollConnect&&r.disconnect(this.scrollConnect),"flash"==this.uploaderType?(this.flashObject.destroy(),delete this.flashObject):(h.destroy(this._fileInput),h.destroy(this._formNode)),void this.inherited(arguments)):void this._cons.push(r.connect(this,"onLoad",this,"destroy"))},_displayProgress:function(e){if(e===!0)"flash"==this.uploaderType?d.set(this.insideNode,"top","-2500px"):d.set(this.insideNode,"display","none"),d.set(this.progNode,"display","");else if(e===!1)d.set(this.insideNode,{display:"",top:"0"}),d.set(this.progNode,"display","none");else{var t=e*this.fhtml.nr.w;d.set(this.progNode,"width",t+"px")}},_animateProgress:function(){this._displayProgress(!0);var e=!1,t=r.connect(this,"_complete",function(){r.disconnect(t),e=!0}),i=0,o=setInterval(a.hitch(this,function(){i+=5,i>this.fhtml.nr.w&&(i=0,e=!0),this._displayProgress(i/this.fhtml.nr.w),e&&(clearInterval(o),setTimeout(a.hitch(this,function(){this._displayProgress(!1)}),500))}),50)},_error:function(e){"string"==typeof e&&(e=new Error(e)),this.onError(e)},_addToFileList:function(){if(this.fileListId){var e="";i.forEach(this.fileList,function(t){e+='<table id="file_'+t.name+'" class="fileToUpload"><tr><td class="fileToUploadClose"></td><td class="fileToUploadName">'+t.name+'</td><td class="fileToUploadSize">'+(t.size?Math.ceil(.001*t.size)+"kb":"")+"</td></tr></table>"},this),l.byId(this.fileListId).innerHTML=e}},_change:function(e){n("ie")&&i.forEach(e,function(e){e.name=e.name.split("\\")[e.name.split("\\").length-1]}),this.selectMultipleFiles?this.fileList=this.fileList.concat(e):(this.fileList[0]&&this.removeFile(this.fileList[0].name,!0),this.fileList=e),this._addToFileList(),this.onChange(e),this.uploadOnChange?("html"==this.uploaderType&&this._buildFileInput(),this.upload()):"html"==this.uploaderType&&this.selectMultipleFiles&&(this._buildFileInput(),this._connectInput())},_complete:function(e){e=a.isArray(e)?e:[e],i.forEach(e,function(e){e.ERROR&&this._error(e.ERROR)},this),i.forEach(this.fileList,function(e){e.bytesLoaded=1,e.bytesTotal=1,e.percent=100,this._progress(e)},this),i.forEach(this.fileList,function(e){this.removeFile(e.name,!0)},this),this.onComplete(e),this.fileList=[],this._resetHTML(),this.set("disabled",!1),this.restoreProgDisplay&&setTimeout(a.hitch(this,function(){d.set(y.byId(this.progressWidgetId).domNode,"none"==this.restoreProgDisplay?"display":"visibility",this.restoreProgDisplay)}),500)},_progress:function(e){for(var t=0,a=0,i=0;i<this.fileList.length;i++){var r=this.fileList[i];r.name==e.name&&(r.bytesLoaded=e.bytesLoaded,r.bytesTotal=e.bytesTotal,r.percent=Math.ceil(r.bytesLoaded/r.bytesTotal*100),this.log(r.name,"percent:",r.percent)),a+=Math.ceil(.001*r.bytesLoaded),t+=Math.ceil(.001*r.bytesTotal)}var o=Math.ceil(a/t*100);this.progressWidgetId&&y.byId(this.progressWidgetId).update({progress:o+"%"}),this.showProgress&&this._displayProgress(.01*o),this.onProgress(this.fileList)},_getDisabledAttr:function(){return this._disabled},_setDisabledAttr:function(e){if(this._disabled!=e){if("flash"==this.uploaderType){if(!this.flashReady){var t=r.connect(this,"onLoad",this,function(){r.disconnect(t),this._setDisabledAttr(e)});return}this._disabled=e,this.flashMovie.doDisable(e)}else this._disabled=e,d.set(this._fileInput,"display",this._disabled?"none":"");c.toggle(this.domNode,this.disabledClass,e)}},_onFlashBlur:function(){if(this.flashMovie.blur(),!this.nextFocusObject&&this.tabIndex)for(var e=s("[tabIndex]"),t=0;t<e.length;t++)if(e[t].tabIndex>=Number(this.tabIndex)+1){this.nextFocusObject=e[t];break}this.nextFocusObject.focus()},_disconnect:function(){i.forEach(this._cons,r.disconnect,dojo)},uploadHTML:function(){this.selectMultipleFiles&&h.destroy(this._fileInput),this._setHtmlPostData(),this.showProgress&&this._animateProgress();g.send({url:this.uploadUrl.toString(),form:this._formNode,handleAs:"json",error:a.hitch(this,function(e){this._error("HTML Upload Error:"+e.message)}),load:a.hitch(this,function(e,t,a){this._complete(e)})})},createHtmlUploader:function(){this._buildForm(),this._setFormStyle(),this._buildFileInput(),this._connectInput(),this._styleContent(),d.set(this.insideNode,"visibility","visible"),this.onReady()},_connectInput:function(){this._disconnect(),this._cons.push(r.connect(this._fileInput,"mouseover",this,function(e){c.add(this.domNode,this.hoverClass),this.onMouseOver(e)})),this._cons.push(r.connect(this._fileInput,"mouseout",this,function(e){setTimeout(a.hitch(this,function(){c.remove(this.domNode,this.activeClass),c.remove(this.domNode,this.hoverClass),this.onMouseOut(e),this._checkHtmlCancel("off")}),0)})),this._cons.push(r.connect(this._fileInput,"mousedown",this,function(e){c.add(this.domNode,this.activeClass),c.remove(this.domNode,this.hoverClass),this.onMouseDown(e)})),this._cons.push(r.connect(this._fileInput,"mouseup",this,function(e){c.remove(this.domNode,this.activeClass),this.onMouseUp(e),this.onClick(e),this._checkHtmlCancel("up")})),this._cons.push(r.connect(this._fileInput,"change",this,function(){this._checkHtmlCancel("change"),this._change([{name:this._fileInput.value,type:"",size:0}])})),this.tabIndex>=0&&m.set(this.domNode,"tabIndex",this.tabIndex)},_checkHtmlCancel:function(e){"change"==e&&(this.dialogIsOpen=!1),"up"==e&&(this.dialogIsOpen=!0),"off"==e&&(this.dialogIsOpen&&this.onCancel(),this.dialogIsOpen=!1)},_styleContent:function(){var e=this.fhtml.nr;d.set(this.insideNode,{width:e.w+"px",height:"middle"==e.va?e.h+"px":"auto",textAlign:e.ta,paddingTop:e.p[0]+"px",paddingRight:e.p[1]+"px",paddingBottom:e.p[2]+"px",paddingLeft:e.p[3]+"px"});try{d.set(this.insideNode,"lineHeight","inherit")}catch(t){}},_resetHTML:function(){"html"==this.uploaderType&&this._formNode&&(this.fileInputs=[],s("*",this._formNode).forEach(function(e){h.destroy(e)}),this.fileCount=0,this._buildFileInput(),this._connectInput())},_buildForm:function(){this._formNode||(n("ie")<9||n("ie")&&n("quirks")?(this._formNode=document.createElement('<form enctype="multipart/form-data" method="post">'),this._formNode.encoding="multipart/form-data",this._formNode.id=y.getUniqueId("FileUploaderForm"),this.domNode.appendChild(this._formNode)):this._formNode=h.create("form",{enctype:"multipart/form-data",method:"post",id:y.getUniqueId("FileUploaderForm")},this.domNode))},_buildFileInput:function(){this._fileInput&&(this._disconnect(),this._fileInput.id=this._fileInput.id+this.fileCount,d.set(this._fileInput,"display","none")),this._fileInput=document.createElement("input"),this.fileInputs.push(this._fileInput);var e=this.htmlFieldName,t=this.id;this.selectMultipleFiles&&(e+=this.fileCount,t+=this.fileCount,this.fileCount++),m.set(this._fileInput,{id:this.id,name:e,type:"file"}),c.add(this._fileInput,"dijitFileInputReal"),this._formNode.appendChild(this._fileInput);var a=u.getMarginBox(this._fileInput);d.set(this._fileInput,{position:"relative",left:this.fhtml.nr.w-a.w+"px",opacity:0})},_renumberInputs:function(){if(this.selectMultipleFiles){var e;this.fileCount=0,i.forEach(this.fileInputs,function(t){e=this.htmlFieldName+this.fileCount,this.fileCount++,m.set(t,"name",e)},this)}},_setFormStyle:function(){var e=Math.max(2,Math.max(Math.ceil(this.fhtml.nr.w/60),Math.ceil(this.fhtml.nr.h/15)));x.insertCssRule("#"+this._formNode.id+" input","font-size:"+e+"em"),d.set(this.domNode,{overflow:"hidden",position:"relative"}),d.set(this.insideNode,"position","absolute")},_setHtmlPostData:function(){if(this.postData)for(var e in this.postData)h.create("input",{type:"hidden",name:e,value:this.postData[e]},this._formNode)},uploadFlash:function(){try{if(this.showProgress){this._displayProgress(!0);var e=r.connect(this,"_complete",this,function(){r.disconnect(e),this._displayProgress(!1)})}var t={};for(var a in this.postData)t[a]=this.postData[a];this.flashMovie.doUpload(t)}catch(i){this._error("FileUploader - Sorry, the SWF failed to initialize."+i)}},createFlashUploader:function(){if(this.uploadUrl=this.uploadUrl.toString(),this.uploadUrl)if(this.uploadUrl.toLowerCase().indexOf("http")<0&&0!=this.uploadUrl.indexOf("/")){var e=window.location.href.split("/");e.pop(),e=e.join("/")+"/",this.uploadUrl=e+this.uploadUrl,this.log("SWF Fixed - Relative loc:",e," abs loc:",this.uploadUrl)}else this.log("SWF URL unmodified:",this.uploadUrl);var t=this.fhtml.nr.w,i=this.fhtml.nr.h,r={expressInstall:!0,path:this.swfPath.uri||this.swfPath,width:t,height:i,allowScriptAccess:"always",allowNetworking:"all",vars:{uploadDataFieldName:this.flashFieldName,uploadUrl:this.uploadUrl,uploadOnSelect:this.uploadOnChange,deferredUploading:this.deferredUploading||0,selectMultipleFiles:this.selectMultipleFiles,id:this.id,isDebug:this.isDebug,devMode:this.devMode,flashButton:j.serialize("fh",this.fhtml),fileMask:j.serialize("fm",this.fileMask),noReturnCheck:this.skipServerCheck,serverTimeout:this.serverTimeout},params:{scale:"noscale",wmode:"opaque",allowScriptAccess:"always",allowNetworking:"all"}};this.flashObject=new _(r,this.insideNode),this.flashObject.onError=a.hitch(function(e){this._error("Flash Error: "+e)}),this.flashObject.onReady=a.hitch(this,function(){d.set(this.insideNode,"visibility","visible"),this.log("FileUploader flash object ready"),this.onReady(this)}),this.flashObject.onLoad=a.hitch(this,function(e){this.flashMovie=e,this.flashReady=!0,this.onLoad(this)}),this._connectFlash()},_connectFlash:function(){this._doSub("/filesSelected","_change"),this._doSub("/filesUploaded","_complete"),this._doSub("/filesProgress","_progress"),this._doSub("/filesError","_error"),this._doSub("/filesCanceled","onCancel"),this._doSub("/stageBlur","_onFlashBlur"),this._doSub("/up","onMouseUp"),this._doSub("/down","onMouseDown"),this._doSub("/over","onMouseOver"),this._doSub("/out","onMouseOut"),this.connect(this.domNode,"focus",function(){this.flashMovie.focus(),this.flashMovie.doFocus()}),this.tabIndex>=0&&m.set(this.domNode,"tabIndex",this.tabIndex)},_doSub:function(e,t){this._subs.push(r.subscribe(this.id+e,this,t))},urlencode:function(e){return e&&"none"!=e?e.replace(/:/g,"||").replace(/\./g,"^^").replace("url(","").replace(")","").replace(/'/g,"").replace(/"/g,""):!1},isButton:function(e){var t=e.tagName.toLowerCase();return"button"==t||"input"==t},getTextStyle:function(e){var t={};if(t.ff=d.get(e,"fontFamily"),t.ff){if(t.ff=t.ff.replace(", ",","),t.ff=t.ff.replace(/\"|\'/g,""),t.ff="sans-serif"==t.ff?"Arial":t.ff,t.fw=d.get(e,"fontWeight"),t.fi=d.get(e,"fontStyle"),t.fs=parseInt(d.get(e,"fontSize"),10),d.get(e,"fontSize").indexOf("%")>-1)for(var a=e;a.tagName;){if(-1==d.get(a,"fontSize").indexOf("%")){t.fs=parseInt(d.get(a,"fontSize"),10);break}"body"==a.tagName.toLowerCase()&&(t.fs=.16*parseInt(d.get(a,"fontSize"),10)),a=a.parentNode}t.fc=new v(d.get(e,"color")).toHex(),t.fc=parseInt(t.fc.substring(1,1/0),16)}return t.lh=d.get(e,"lineHeight"),t.ta=d.get(e,"textAlign"),t.ta="start"!=t.ta&&t.ta?t.ta:"left",t.va=this.isButton(e)?"middle":t.lh==t.h?"middle":d.get(e,"verticalAlign"),t},getText:function(e){var t=a.trim(e.innerHTML);return t.indexOf("<")>-1&&(t=escape(t)),t},getStyle:function(e){var t={},i=u.getContentBox(e),r=u.getPadExtents(e);t.p=[r.t,r.w-r.l,r.h-r.t,r.l],t.w=i.w+r.w,t.h=i.h+r.h,t.d=d.get(e,"display");var o=new v(d.get(e,"backgroundColor"));t.bc=0==o.a?"#ffffff":o.toHex(),t.bc=parseInt(t.bc.substring(1,1/0),16);var n=this.urlencode(d.get(e,"backgroundImage"));if(n&&(t.bi={url:n,rp:d.get(e,"backgroundRepeat"),pos:escape(d.get(e,"backgroundPosition"))},!t.bi.pos)){var s=d.get(e,"backgroundPositionX"),l=d.get(e,"backgroundPositionY");s="left"==s?"0%":"right"==s?"100%":s,l="top"==l?"0%":"bottom"==l?"100%":l,t.bi.pos=escape(s+" "+l)}return a.mixin(t,this.getTextStyle(e))},getTempNodeStyle:function(e,t,a){var i,r;if(a){i=h.place("<"+e.tagName+"><span>"+e.innerHTML+"</span></"+e.tagName+">",e.parentNode);var o=i.firstChild;c.add(o,e.className),c.add(i,t),r=this.getStyle(o)}else i=h.place("<"+e.tagName+">"+e.innerHTML+"</"+e.tagName+">",e.parentNode),c.add(i,e.className),c.add(i,t),i.id=e.id,r=this.getStyle(i);return h.destroy(i),r}})});//# sourceMappingURL=FileUploader.js.map