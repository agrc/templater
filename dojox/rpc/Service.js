//>>built
define("dojox/rpc/Service",["dojo","dojox","dojo/AdapterRegistry","dojo/_base/url"],function(e,t){return e.declare("dojox.rpc.Service",null,{constructor:function(t,i){function a(t){t._baseUrl=new e._Url(e.isBrowser?location.href:e.config.baseUrl,o||".")+"",r._smd=t;for(var i in r._smd.services){for(var a=i.split("."),n=r,s=0;s<a.length-1;s++)n=n[a[s]]||(n[a[s]]={});n[a[a.length-1]]=r._generateService(i,r._smd.services[i])}}var o,r=this;if(t)if(e.isString(t)||t instanceof e._Url){o=t instanceof e._Url?t+"":t;var n=e._getText(o);if(!n)throw new Error("Unable to load SMD from "+t);a(e.fromJson(n))}else a(t);this._options=i?i:{},this._requestId=0},_generateService:function(i,a){if(this[i])throw new Error("WARNING: "+i+" already exists for service. Unable to generate function");a.name=i;var o=e.hitch(this,"_executeMethod",a),r=t.rpc.transportRegistry.match(a.transport||this._smd.transport);r.getExecutor&&(o=r.getExecutor(o,a,this));var n=a.returns||(a._schema={}),s="/"+i+"/";return n._service=o,o.servicePath=s,o._schema=n,o.id=t.rpc.Service._nextId++,o},_getRequest:function(i,a){var o,r=this._smd,n=t.rpc.envelopeRegistry.match(i.envelope||r.envelope||"NONE"),s=(i.parameters||[]).concat(r.parameters||[]);if(n.namedParams){if(1==a.length&&e.isObject(a[0]))a=a[0];else{var l={};for(o=0;o<i.parameters.length;o++)"undefined"==typeof a[o]&&i.parameters[o].optional||(l[i.parameters[o].name]=a[o]);a=l}if(i.strictParameters||r.strictParameters)for(o in a){for(var d=!1,h=0;h<s.length;h++)s[h].name==o&&(d=!0);d||delete a[o]}for(o=0;o<s.length;o++){var u=s[o];if(!u.optional&&u.name&&!a[u.name])if(u["default"])a[u.name]=u["default"];else if(!(u.name in a))throw new Error("Required parameter "+u.name+" was omitted")}}else s&&s[0]&&s[0].name&&1==a.length&&e.isObject(a[0])&&(a=n.namedParams===!1?t.rpc.toOrdered(s,a):a[0]);e.isObject(this._options)&&(a=e.mixin(a,this._options));var c=i._schema||i.returns,m=n.serialize.apply(this,[r,i,a]);m._envDef=n;var f=i.contentType||r.contentType||m.contentType;return e.mixin(m,{sync:this._options.sync||t.rpc._sync,contentType:f,headers:i.headers||r.headers||m.headers||{},target:m.target||t.rpc.getTarget(r,i),transport:i.transport||r.transport||m.transport,envelope:i.envelope||r.envelope||m.envelope,timeout:i.timeout||r.timeout,callbackParamName:i.callbackParamName||r.callbackParamName,rpcObjectParamName:i.rpcObjectParamName||r.rpcObjectParamName,schema:c,handleAs:m.handleAs||"auto",preventCache:i.preventCache||r.preventCache,frameDoc:this._options.frameDoc||void 0})},_executeMethod:function(e){var i,a=[];for(i=1;i<arguments.length;i++)a.push(arguments[i]);var o=this._getRequest(e,a),r=t.rpc.transportRegistry.match(o.transport).fire(o);return r.addBoth(function(e){return o._envDef.deserialize.call(this,e)}),r}}),t.rpc.getTarget=function(t,i){var a=t._baseUrl;return t.target&&(a=new e._Url(a,t.target)+""),i.target&&(a=new e._Url(a,i.target)+""),a},t.rpc.toOrdered=function(t,i){if(e.isArray(i))return i;for(var a=[],o=0;o<t.length;o++)a.push(i[t[o].name]);return a},t.rpc.transportRegistry=new e.AdapterRegistry(!0),t.rpc.envelopeRegistry=new e.AdapterRegistry(!0),t.rpc.envelopeRegistry.register("URL",function(e){return"URL"==e},{serialize:function(t,i,a){var o=e.objectToQuery(a);return{data:o,transport:"POST"}},deserialize:function(e){return e},namedParams:!0}),t.rpc.envelopeRegistry.register("JSON",function(e){return"JSON"==e},{serialize:function(t,i,a){var o=e.toJson(a);return{data:o,handleAs:"json",contentType:"application/json"}},deserialize:function(e){return e}}),t.rpc.envelopeRegistry.register("PATH",function(e){return"PATH"==e},{serialize:function(i,a,o){var r,n=t.rpc.getTarget(i,a);if(e.isArray(o))for(r=0;r<o.length;r++)n+="/"+o[r];else for(r in o)n+="/"+r+"/"+o[r];return{data:"",target:n}},deserialize:function(e){return e}}),t.rpc.transportRegistry.register("POST",function(e){return"POST"==e},{fire:function(t){return t.url=t.target,t.postData=t.data,e.rawXhrPost(t)}}),t.rpc.transportRegistry.register("GET",function(e){return"GET"==e},{fire:function(t){return t.url=t.target+(t.data?"?"+(t.rpcObjectParamName?t.rpcObjectParamName+"=":"")+t.data:""),e.xhrGet(t)}}),t.rpc.transportRegistry.register("JSONP",function(e){return"JSONP"==e},{fire:function(t){return t.url=t.target+(-1==t.target.indexOf("?")?"?":"&")+(t.rpcObjectParamName?t.rpcObjectParamName+"=":"")+t.data,t.callbackParamName=t.callbackParamName||"callback",e.io.script.get(t)}}),t.rpc.Service._nextId=1,e._contentHandlers.auto=function(t){var i=e._contentHandlers,a=t.getResponseHeader("Content-Type"),o=a?a.match(/\/.*json/)?i.json(t):a.match(/\/javascript/)?i.javascript(t):a.match(/\/xml/)?i.xml(t):i.text(t):i.text(t);return o},t.rpc.Service});//# sourceMappingURL=Service.js.map