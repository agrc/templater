//>>built
define("dojox/rpc/Service",["dojo","dojox","dojo/AdapterRegistry","dojo/_base/url"],function(e,t){return e.declare("dojox.rpc.Service",null,{constructor:function(t,i){function a(t){t._baseUrl=new e._Url(e.isBrowser?location.href:e.config.baseUrl,n||".")+"",o._smd=t;for(var i in o._smd.services){for(var a=i.split("."),r=o,s=0;s<a.length-1;s++)r=r[a[s]]||(r[a[s]]={});r[a[a.length-1]]=o._generateService(i,o._smd.services[i])}}var n,o=this;if(t)if(e.isString(t)||t instanceof e._Url){n=t instanceof e._Url?t+"":t;var r=e._getText(n);if(!r)throw new Error("Unable to load SMD from "+t);a(e.fromJson(r))}else a(t);this._options=i?i:{},this._requestId=0},_generateService:function(i,a){if(this[i])throw new Error("WARNING: "+i+" already exists for service. Unable to generate function");a.name=i;var n=e.hitch(this,"_executeMethod",a),o=t.rpc.transportRegistry.match(a.transport||this._smd.transport);o.getExecutor&&(n=o.getExecutor(n,a,this));var r=a.returns||(a._schema={}),s="/"+i+"/";return r._service=n,n.servicePath=s,n._schema=r,n.id=t.rpc.Service._nextId++,n},_getRequest:function(i,a){var n,o=this._smd,r=t.rpc.envelopeRegistry.match(i.envelope||o.envelope||"NONE"),s=(i.parameters||[]).concat(o.parameters||[]);if(r.namedParams){if(1==a.length&&e.isObject(a[0]))a=a[0];else{var l={};for(n=0;n<i.parameters.length;n++)"undefined"==typeof a[n]&&i.parameters[n].optional||(l[i.parameters[n].name]=a[n]);a=l}if(i.strictParameters||o.strictParameters)for(n in a){for(var d=!1,u=0;u<s.length;u++)s[u].name==n&&(d=!0);d||delete a[n]}for(n=0;n<s.length;n++){var c=s[n];if(!c.optional&&c.name&&!a[c.name])if(c["default"])a[c.name]=c["default"];else if(!(c.name in a))throw new Error("Required parameter "+c.name+" was omitted")}}else s&&s[0]&&s[0].name&&1==a.length&&e.isObject(a[0])&&(a=r.namedParams===!1?t.rpc.toOrdered(s,a):a[0]);e.isObject(this._options)&&(a=e.mixin(a,this._options));var h=i._schema||i.returns,m=r.serialize.apply(this,[o,i,a]);m._envDef=r;var f=i.contentType||o.contentType||m.contentType;return e.mixin(m,{sync:this._options.sync||t.rpc._sync,contentType:f,headers:i.headers||o.headers||m.headers||{},target:m.target||t.rpc.getTarget(o,i),transport:i.transport||o.transport||m.transport,envelope:i.envelope||o.envelope||m.envelope,timeout:i.timeout||o.timeout,callbackParamName:i.callbackParamName||o.callbackParamName,rpcObjectParamName:i.rpcObjectParamName||o.rpcObjectParamName,schema:h,handleAs:m.handleAs||"auto",preventCache:i.preventCache||o.preventCache,frameDoc:this._options.frameDoc||void 0})},_executeMethod:function(e){var i,a=[];for(i=1;i<arguments.length;i++)a.push(arguments[i]);var n=this._getRequest(e,a),o=t.rpc.transportRegistry.match(n.transport).fire(n);return o.addBoth(function(e){return n._envDef.deserialize.call(this,e)}),o}}),t.rpc.getTarget=function(t,i){var a=t._baseUrl;return t.target&&(a=new e._Url(a,t.target)+""),i.target&&(a=new e._Url(a,i.target)+""),a},t.rpc.toOrdered=function(t,i){if(e.isArray(i))return i;for(var a=[],n=0;n<t.length;n++)a.push(i[t[n].name]);return a},t.rpc.transportRegistry=new e.AdapterRegistry(!0),t.rpc.envelopeRegistry=new e.AdapterRegistry(!0),t.rpc.envelopeRegistry.register("URL",function(e){return"URL"==e},{serialize:function(t,i,a){var n=e.objectToQuery(a);return{data:n,transport:"POST"}},deserialize:function(e){return e},namedParams:!0}),t.rpc.envelopeRegistry.register("JSON",function(e){return"JSON"==e},{serialize:function(t,i,a){var n=e.toJson(a);return{data:n,handleAs:"json",contentType:"application/json"}},deserialize:function(e){return e}}),t.rpc.envelopeRegistry.register("PATH",function(e){return"PATH"==e},{serialize:function(i,a,n){var o,r=t.rpc.getTarget(i,a);if(e.isArray(n))for(o=0;o<n.length;o++)r+="/"+n[o];else for(o in n)r+="/"+o+"/"+n[o];return{data:"",target:r}},deserialize:function(e){return e}}),t.rpc.transportRegistry.register("POST",function(e){return"POST"==e},{fire:function(t){return t.url=t.target,t.postData=t.data,e.rawXhrPost(t)}}),t.rpc.transportRegistry.register("GET",function(e){return"GET"==e},{fire:function(t){return t.url=t.target+(t.data?"?"+(t.rpcObjectParamName?t.rpcObjectParamName+"=":"")+t.data:""),e.xhrGet(t)}}),t.rpc.transportRegistry.register("JSONP",function(e){return"JSONP"==e},{fire:function(t){return t.url=t.target+(-1==t.target.indexOf("?")?"?":"&")+(t.rpcObjectParamName?t.rpcObjectParamName+"=":"")+t.data,t.callbackParamName=t.callbackParamName||"callback",e.io.script.get(t)}}),t.rpc.Service._nextId=1,e._contentHandlers.auto=function(t){var i=e._contentHandlers,a=t.getResponseHeader("Content-Type"),n=a?a.match(/\/.*json/)?i.json(t):a.match(/\/javascript/)?i.javascript(t):a.match(/\/xml/)?i.xml(t):i.text(t):i.text(t);return n},t.rpc.Service});//# sourceMappingURL=Service.js.map