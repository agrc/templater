//>>built
define("dojox/rpc/JsonRest",["dojo","dojox","dojox/json/ref","dojox/rpc/Rest"],function(e,t){function i(e,i,r,n){var s=i.ioArgs&&i.ioArgs.xhr&&i.ioArgs.xhr.getResponseHeader("Last-Modified");s&&o._timeStamps&&(o._timeStamps[n]=s);var l=e._schema&&e._schema.hrefProperty;return l&&(t.json.ref.refAttribute=l),r=r&&t.json.ref.resolveJson(r,{defaultId:n,index:o._index,timeStamps:s&&o._timeStamps,time:s,idPrefix:e._store.allowNoTrailingSlash?e.servicePath+"/":e.servicePath.replace(/[^\/]*$/,""),idAttribute:a.getIdAttribute(e),schemas:a.schemas,loader:a._loader,idAsRef:e.idAsRef,assignAbsoluteIds:!0}),t.json.ref.refAttribute="$ref",r}var a,r=[],o=t.rpc.Rest;return a=t.rpc.JsonRest={serviceClass:t.rpc.Rest,conflictDateHeader:"If-Unmodified-Since",commit:function(t){t=t||{};for(var i=[],n={},s=[],l=0;l<r.length;l++){var d=r[l],u=d.object,c=d.old;if((!t.service||!u&&!c||!(u||c).__id.indexOf(t.service.servicePath))&&d.save){if(delete u.__isDirty,u)if(c){var h;if((h=u.__id.match(/(.*)#.*/))&&(u=o._index[h[1]]),!(u.__id in n)){if(n[u.__id]=u,t.incrementalUpdates&&!h)var m=("function"==typeof t.incrementalUpdates?t.incrementalUpdates:function(){m={};for(var e in u)if(u.hasOwnProperty(e))u[e]!==c[e]&&(m[e]=u[e]);else if(c.hasOwnProperty(e))return null;return m})(u,c);m?i.push({method:"post",target:u,content:m}):i.push({method:"put",target:u,content:u})}}else{var f=a.getServiceAndId(u.__id).service,p=a.getIdAttribute(f);p in u&&!t.alwaysPostNewItems?i.push({method:"put",target:u,content:u}):i.push({method:"post",target:{__id:f.servicePath},content:u})}else c&&i.push({method:"delete",target:c});s.push(d),r.splice(l--,1)}}return e.connect(t,"onError",function(){if(t.revertOnError!==!1){var i=r;r=s;a.revert(),r=i}else e.forEach(s,function(e){a.changing(e.object,!e.object)})}),a.sendToServer(i,t),i},sendToServer:function(r,n){var s,l,d,u=e.xhr,c=r.length,h=this.conflictDateHeader;for(e.xhr=function(t,i){return i.headers=i.headers||{},i.headers.Transaction=r.length-1==s?"commit":"open",h&&d&&(i.headers[h]=d),l&&(i.headers["Content-ID"]="<"+l+">"),u.apply(e,arguments)},s=0;s<r.length;s++){var m=r[s];t.rpc.JsonRest._contentId=m.content&&m.content.__id;var f="post"==m.method;d="put"==m.method&&o._timeStamps[m.content.__id],d&&(o._timeStamps[m.content.__id]=new Date+""),l=f&&t.rpc.JsonRest._contentId;var p=a.getServiceAndId(m.target.__id),g=p.service,v=m.deferred=g[m.method](p.id.replace(/#/,""),t.json.ref.toJson(m.content,!1,g.servicePath,!0));!function(e,t,a){t.addCallback(function(s){try{var l=t.ioArgs.xhr&&t.ioArgs.xhr.getResponseHeader("Location");if(l){var d=l.match(/(^\w+:\/\/)/)&&l.indexOf(a.servicePath);l=d>0?l.substring(d):(a.servicePath+l).replace(/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,"$2$3"),e.__id=l,o._index[l]=e}s=i(a,t,s,e&&e.__id)}catch(u){}return--c||n.onComplete&&n.onComplete.call(n.scope,r),s})}(m.content,v,g),v.addErrback(function(e){c=-1,n.onError.call(n.scope,e)})}e.xhr=u},getDirtyObjects:function(){return r},revert:function(e){for(var i=r.length;i>0;){i--;var a=r[i],o=a.object,n=a.old,s=t.data._getStoreForItem(o||n);if(!e||!o&&!n||!(o||n).__id.indexOf(e.servicePath)){if(o&&n){for(var l in n)n.hasOwnProperty(l)&&o[l]!==n[l]&&(s&&s.onSet(o,l,o[l],n[l]),o[l]=n[l]);for(l in o)n.hasOwnProperty(l)||(s&&s.onSet(o,l,o[l]),delete o[l])}else n?s&&s.onNew(n):s&&s.onDelete(o);delete(o||n).__isDirty,r.splice(i,1)}}},changing:function(e,t){if(e.__id){e.__isDirty=!0;for(var i=0;i<r.length;i++){var a=r[i];if(e==a.object)return void(t&&(a.object=!1,this._saveNotNeeded||(a.save=!0)))}var o=e instanceof Array?[]:{};for(i in e)e.hasOwnProperty(i)&&(o[i]=e[i]);r.push({object:!t&&e,old:o,save:!this._saveNotNeeded})}},deleteObject:function(e){this.changing(e,!0)},getConstructor:function(i,n){if("string"==typeof i){var s=i;i=new t.rpc.Rest(i,!0),this.registerService(i,s,n)}return i._constructor?i._constructor:(i._constructor=function(n){function s(e){if(e){s(e["extends"]),l=e.properties;for(var t in l){var i=l[t];i&&"object"==typeof i&&"default"in i&&(u[t]=i["default"])}}e&&e.prototype&&e.prototype.initialize&&(d=!0,e.prototype.initialize.apply(u,c))}var l,d,u=this,c=arguments;s(i._schema),!d&&n&&"object"==typeof n&&e.mixin(u,n);var h=a.getIdAttribute(i);o._index[this.__id=this.__clientId=i.servicePath+(this[h]||Math.random().toString(16).substring(2,14)+"@"+(t.rpc.Client&&t.rpc.Client.clientId||"client"))]=this,t.json.schema&&l&&t.json.schema.mustBeValid(t.json.schema.validate(this,i._schema)),r.push({object:this,save:!0})},e.mixin(i._constructor,i._schema,{load:i}))},fetch:function(e){var t=a.getServiceAndId(e);return this.byId(t.service,t.id)},getIdAttribute:function(e){var t,i=e._schema;if(i&&!(t=i._idAttr))for(var a in i.properties)(i.properties[a].identity||"self"==i.properties[a].link)&&(i._idAttr=t=a);return t||"id"},getServiceAndId:function(e){var t="";for(var i in a.services)e.substring(0,i.length)==i&&i.length>=t.length&&(t=i);if(t)return{service:a.services[t],id:e.substring(t.length)};var r=e.match(/^(.*\/)([^\/]*)$/);return{service:new a.serviceClass(r[1],!0),id:r[2]}},services:{},schemas:{},registerService:function(e,t,i){t=e.servicePath=t||e.servicePath,e._schema=a.schemas[t]=i||e._schema||{},a.services[t]=e},byId:function(t,i){var a,r=o._index[(t.servicePath||"")+i];return r&&!r._loadObject?(a=new e.Deferred,a.callback(r),a):this.query(t,i)},query:function(e,t,a){var r=e(t,a);return r.addCallback(function(o){return o.nodeType&&o.cloneNode?o:i(e,r,o,"string"!=typeof t||a&&(a.start||a.count)?void 0:t)}),r},_loader:function(e){var t=a.getServiceAndId(this.__id),i=this;a.query(t.service,t.id).addBoth(function(t){t==i?(delete t.$ref,delete t._loadObject):i._loadObject=function(e){e(t)},e(t)})},isDirty:function(i,a){return i?i.__isDirty:a?e.some(r,function(e){return t.data._getStoreForItem(e.object||e.old)==a}):!!r.length}},t.rpc.JsonRest});//# sourceMappingURL=JsonRest.js.map