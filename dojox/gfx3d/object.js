//>>built
define("dojox/gfx3d/object",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojox/gfx","dojox/gfx/matrix","./_base","./scheduler","./gradient","./vector","./matrix","./lighting"],function(e,t,a,i,r,o,n,s,l,d,u){var c=n.scheduler;return t("dojox.gfx3d.Object",null,{constructor:function(){this.object=null,this.matrix=null,this.cache=null,this.renderer=null,this.parent=null,this.strokeStyle=null,this.fillStyle=null,this.shape=null},setObject:function(e){return this.object=i.makeParameters(this.object,e),this},setTransform:function(e){return this.matrix=d.clone(e?d.normalize(e):o.identity,!0),this},applyRightTransform:function(e){return e?this.setTransform([this.matrix,e]):this},applyLeftTransform:function(e){return e?this.setTransform([e,this.matrix]):this},applyTransform:function(e){return e?this.setTransform([this.matrix,e]):this},setFill:function(e){return this.fillStyle=e,this},setStroke:function(e){return this.strokeStyle=e,this},toStdFill:function(e,t){return this.fillStyle&&void 0!==this.fillStyle.type?e[this.fillStyle.type](t,this.fillStyle.finish,this.fillStyle.color):this.fillStyle},invalidate:function(){this.renderer.addTodo(this)},destroy:function(){if(this.shape){var e=this.shape.getParent();e&&e.remove(this.shape),this.shape=null}},render:function(e){throw"Pure virtual function, not implemented"},draw:function(e){throw"Pure virtual function, not implemented"},getZOrder:function(){return 0},getOutline:function(){return null}}),t("dojox.gfx3d.Scene",o.Object,{constructor:function(){this.objects=[],this.todos=[],this.schedule=c.zOrder,this._draw=o.drawer.conservative},setFill:function(t){return this.fillStyle=t,e.forEach(this.objects,function(e){e.setFill(t)}),this},setStroke:function(t){return this.strokeStyle=t,e.forEach(this.objects,function(e){e.setStroke(t)}),this},render:function(t,a){var i=d.multiply(t,this.matrix);a&&(this.todos=this.objects),e.forEach(this.todos,function(e){e.render(i,a)})},draw:function(e){this.objects=this.schedule(this.objects),this._draw(this.todos,this.objects,this.renderer)},addTodo:function(t){e.every(this.todos,function(e){return e!=t})&&(this.todos.push(t),this.invalidate())},invalidate:function(){this.parent.addTodo(this)},getZOrder:function(){var t=0;return e.forEach(this.objects,function(e){t+=e.getZOrder()}),this.objects.length>1?t/this.objects.length:0}}),t("dojox.gfx3d.Edges",o.Object,{constructor:function(){this.object=a.clone(o.defaultEdges)},setObject:function(e,t){return this.object=i.makeParameters(this.object,e instanceof Array?{points:e,style:t}:e),this},getZOrder:function(){var t=0;return e.forEach(this.cache,function(e){t+=e.z}),this.cache.length>1?t/this.cache.length:0},render:function(t){var a=d.multiply(t,this.matrix);this.cache=e.map(this.object.points,function(e){return d.multiplyPoint(a,e)})},draw:function(){var t=this.cache;this.shape?this.shape.setShape(""):this.shape=this.renderer.createPath();var a=this.shape.setAbsoluteMode("absolute");if("strip"==this.object.style||"loop"==this.object.style)a.moveTo(t[0].x,t[0].y),e.forEach(t.slice(1),function(e){a.lineTo(e.x,e.y)}),"loop"==this.object.style&&a.closePath();else for(var i=0;i<this.cache.length;)a.moveTo(t[i].x,t[i].y),i++,a.lineTo(t[i].x,t[i].y),i++;a.setStroke(this.strokeStyle)}}),t("dojox.gfx3d.Orbit",o.Object,{constructor:function(){this.object=a.clone(o.defaultOrbit)},render:function(t){var a=d.multiply(t,this.matrix),i=[0,Math.PI/4,Math.PI/3],o=d.multiplyPoint(a,this.object.center),n=e.map(i,function(e){return{x:this.center.x+this.radius*Math.cos(e),y:this.center.y+this.radius*Math.sin(e),z:this.center.z}},this.object);n=e.map(n,function(e){return d.multiplyPoint(a,e)});var s=l.normalize(n);n=e.map(n,function(e){return l.substract(e,o)});var u={xx:n[0].x*n[0].y,xy:n[0].y*n[0].y,xz:1,yx:n[1].x*n[1].y,yy:n[1].y*n[1].y,yz:1,zx:n[2].x*n[2].y,zy:n[2].y*n[2].y,zz:1,dx:0,dy:0,dz:0},c=e.map(n,function(e){return-Math.pow(e.x,2)}),m=d.multiplyPoint(d.invert(u),c[0],c[1],c[2]),h=Math.atan2(m.x,1-m.y)/2,f=e.map(n,function(e){return r.multiplyPoint(r.rotate(-h),e.x,e.y)}),p=Math.pow(f[0].x,2),y=Math.pow(f[0].y,2),g=Math.pow(f[1].x,2),v=Math.pow(f[1].y,2),b=Math.sqrt((p*v-y*g)/(v-y)),M=Math.sqrt((p*v-y*g)/(p-g));this.cache={cx:o.x,cy:o.y,rx:b,ry:M,theta:h,normal:s}},draw:function(e){this.shape?this.shape.setShape(this.cache):this.shape=this.renderer.createEllipse(this.cache),this.shape.applyTransform(r.rotateAt(this.cache.theta,this.cache.cx,this.cache.cy)).setStroke(this.strokeStyle).setFill(this.toStdFill(e,this.cache.normal))}}),t("dojox.gfx3d.Path3d",o.Object,{constructor:function(){this.object=a.clone(o.defaultPath3d),this.segments=[],this.absolute=!0,this.last={},this.path=""},_collectArgs:function(e,t){for(var a=0;a<t.length;++a){var i=t[a];"boolean"==typeof i?e.push(i?1:0):"number"==typeof i?e.push(i):i instanceof Array?this._collectArgs(e,i):"x"in i&&"y"in i&&(e.push(i.x),e.push(i.y))}},_validSegments:{m:3,l:3,z:0},_pushSegment:function(e,t){var a,i=this._validSegments[e.toLowerCase()];"number"==typeof i&&(i?t.length>=i&&(a={action:e,args:t.slice(0,t.length-t.length%i)},this.segments.push(a)):(a={action:e,args:[]},this.segments.push(a)))},moveTo:function(){var e=[];return this._collectArgs(e,arguments),this._pushSegment(this.absolute?"M":"m",e),this},lineTo:function(){var e=[];return this._collectArgs(e,arguments),this._pushSegment(this.absolute?"L":"l",e),this},closePath:function(){return this._pushSegment("Z",[]),this},render:function(t){var a=d.multiply(t,this.matrix),i="",r=this._validSegments;e.forEach(this.segments,function(e){i+=e.action;for(var t=0;t<e.args.length;t+=r[e.action.toLowerCase()]){var o=d.multiplyPoint(a,e.args[t],e.args[t+1],e.args[t+2]);i+=" "+o.x+" "+o.y}}),this.cache=i},_draw:function(){return this.parent.createPath(this.cache)}}),t("dojox.gfx3d.Triangles",o.Object,{constructor:function(){this.object=a.clone(o.defaultTriangles)},setObject:function(e,t){return e instanceof Array?this.object=i.makeParameters(this.object,{points:e,style:t}):this.object=i.makeParameters(this.object,e),this},render:function(t){var a=d.multiply(t,this.matrix),i=e.map(this.object.points,function(e){return d.multiplyPoint(a,e)});this.cache=[];var r=i.slice(0,2),o=i[0];if("strip"==this.object.style)e.forEach(i.slice(2),function(e){r.push(e),r.push(r[0]),this.cache.push(r),r=r.slice(1,3)},this);else if("fan"==this.object.style)e.forEach(i.slice(2),function(e){r.push(e),r.push(o),this.cache.push(r),r=[o,e]},this);else for(var n=0;n<i.length;)this.cache.push([i[n],i[n+1],i[n+2],i[n]]),n+=3},draw:function(t){this.cache=c.bsp(this.cache,function(e){return e}),this.shape?this.shape.clear():this.shape=this.renderer.createGroup(),e.forEach(this.cache,function(e){this.shape.createPolyline(e).setStroke(this.strokeStyle).setFill(this.toStdFill(t,l.normalize(e)))},this)},getZOrder:function(){var t=0;return e.forEach(this.cache,function(e){t+=(e[0].z+e[1].z+e[2].z)/3}),this.cache.length>1?t/this.cache.length:0}}),t("dojox.gfx3d.Quads",o.Object,{constructor:function(){this.object=a.clone(o.defaultQuads)},setObject:function(e,t){return this.object=i.makeParameters(this.object,e instanceof Array?{points:e,style:t}:e),this},render:function(t){var a,i=d.multiply(t,this.matrix),r=e.map(this.object.points,function(e){return d.multiplyPoint(i,e)});if(this.cache=[],"strip"==this.object.style){var o=r.slice(0,2);for(a=2;a<r.length;)o=o.concat([r[a],r[a+1],o[0]]),this.cache.push(o),o=o.slice(2,4),a+=2}else for(a=0;a<r.length;)this.cache.push([r[a],r[a+1],r[a+2],r[a+3],r[a]]),a+=4},draw:function(e){this.cache=o.scheduler.bsp(this.cache,function(e){return e}),this.shape?this.shape.clear():this.shape=this.renderer.createGroup();for(var t=0;t<this.cache.length;t++)this.shape.createPolyline(this.cache[t]).setStroke(this.strokeStyle).setFill(this.toStdFill(e,l.normalize(this.cache[t])))},getZOrder:function(){for(var e=0,t=0;t<this.cache.length;t++){var a=this.cache[t];e+=(a[0].z+a[1].z+a[2].z+a[3].z)/4}return this.cache.length>1?e/this.cache.length:0}}),t("dojox.gfx3d.Polygon",o.Object,{constructor:function(){this.object=a.clone(o.defaultPolygon)},setObject:function(e){return this.object=i.makeParameters(this.object,e instanceof Array?{path:e}:e),this},render:function(t){var a=d.multiply(t,this.matrix);this.cache=e.map(this.object.path,function(e){return d.multiplyPoint(a,e)}),this.cache.push(this.cache[0])},draw:function(e){this.shape?this.shape.setShape({points:this.cache}):this.shape=this.renderer.createPolyline({points:this.cache}),this.shape.setStroke(this.strokeStyle).setFill(this.toStdFill(e,d.normalize(this.cache)))},getZOrder:function(){for(var e=0,t=0;t<this.cache.length;t++)e+=this.cache[t].z;return this.cache.length>1?e/this.cache.length:0},getOutline:function(){return this.cache.slice(0,3)}}),t("dojox.gfx3d.Cube",o.Object,{constructor:function(){this.object=a.clone(o.defaultCube),this.polygons=[]},setObject:function(e){this.object=i.makeParameters(this.object,e)},render:function(t){var a=this.object.top,i=this.object.bottom,r={x:i.x,y:a.y,z:a.z},o={x:i.x,y:i.y,z:a.z},n={x:a.x,y:i.y,z:a.z},s={x:a.x,y:a.y,z:i.z},l={x:i.x,y:a.y,z:i.z},u={x:a.x,y:i.y,z:i.z},c=[a,r,o,n,s,l,i,u],m=d.multiply(t,this.matrix),h=e.map(c,function(e){return d.multiplyPoint(m,e)});a=h[0],r=h[1],o=h[2],n=h[3],s=h[4],l=h[5],i=h[6],u=h[7],this.cache=[[a,r,o,n,a],[s,l,i,u,s],[a,n,u,s,a],[n,o,i,u,n],[o,r,l,i,o],[r,a,s,l,r]]},draw:function(e){this.cache=o.scheduler.bsp(this.cache,function(e){return e});var t=this.cache.slice(3);this.shape?this.shape.clear():this.shape=this.renderer.createGroup();for(var a=0;a<t.length;a++)this.shape.createPolyline(t[a]).setStroke(this.strokeStyle).setFill(this.toStdFill(e,l.normalize(t[a])))},getZOrder:function(){var e=this.cache[0][0],t=this.cache[1][2];return(e.z+t.z)/2}}),t("dojox.gfx3d.Cylinder",o.Object,{constructor:function(){this.object=a.clone(o.defaultCylinder)},render:function(t){var a=d.multiply(t,this.matrix),i=[0,Math.PI/4,Math.PI/3],o=d.multiplyPoint(a,this.object.center),n=e.map(i,function(e){return{x:this.center.x+this.radius*Math.cos(e),y:this.center.y+this.radius*Math.sin(e),z:this.center.z}},this.object);n=e.map(n,function(e){return l.substract(d.multiplyPoint(a,e),o)});var u={xx:n[0].x*n[0].y,xy:n[0].y*n[0].y,xz:1,yx:n[1].x*n[1].y,yy:n[1].y*n[1].y,yz:1,zx:n[2].x*n[2].y,zy:n[2].y*n[2].y,zz:1,dx:0,dy:0,dz:0},c=e.map(n,function(e){return-Math.pow(e.x,2)}),m=d.multiplyPoint(d.invert(u),c[0],c[1],c[2]),h=Math.atan2(m.x,1-m.y)/2,f=e.map(n,function(e){return r.multiplyPoint(r.rotate(-h),e.x,e.y)}),p=Math.pow(f[0].x,2),y=Math.pow(f[0].y,2),g=Math.pow(f[1].x,2),v=Math.pow(f[1].y,2),b=Math.sqrt((p*v-y*g)/(v-y)),M=Math.sqrt((p*v-y*g)/(p-g));if(b<M){var k=b;b=M,M=k,h-=Math.PI/2}var j=d.multiplyPoint(a,l.sum(this.object.center,{x:0,y:0,z:this.object.height})),x="constant"==this.fillStyle.type?this.fillStyle.color:s(this.renderer.lighting,this.fillStyle,this.object.center,this.object.radius,Math.PI,2*Math.PI,a);(isNaN(b)||isNaN(M)||isNaN(h))&&(b=this.object.radius,M=0,h=0),this.cache={center:o,top:j,rx:b,ry:M,theta:h,gradient:x}},draw:function(){var e=this.cache,t=l,a=r,i=[e.center,e.top],o=t.substract(e.top,e.center);t.dotProduct(o,this.renderer.lighting.incident)>0&&(i=[e.top,e.center],o=t.substract(e.center,e.top));var n=this.renderer.lighting[this.fillStyle.type](o,this.fillStyle.finish,this.fillStyle.color),s=Math.sqrt(Math.pow(e.center.x-e.top.x,2)+Math.pow(e.center.y-e.top.y,2));this.shape?this.shape.clear():this.shape=this.renderer.createGroup(),this.shape.createPath("").moveTo(0,-e.rx).lineTo(s,-e.rx).lineTo(s,e.rx).lineTo(0,e.rx).arcTo(e.ry,e.rx,0,!0,!0,0,-e.rx).setFill(e.gradient).setStroke(this.strokeStyle).setTransform([a.translate(i[0]),a.rotate(Math.atan2(i[1].y-i[0].y,i[1].x-i[0].x))]),e.rx>0&&e.ry>0&&this.shape.createEllipse({cx:i[1].x,cy:i[1].y,rx:e.rx,ry:e.ry}).setFill(n).setStroke(this.strokeStyle).applyTransform(a.rotateAt(e.theta,i[1]))}}),t("dojox.gfx3d.Viewport",i.Group,{constructor:function(){this.dimension=null,this.objects=[],this.todos=[],this.renderer=this,this.schedule=o.scheduler.zOrder,this.draw=o.drawer.conservative,this.deep=!1,this.lights=[],this.lighting=null},setCameraTransform:function(e){return this.camera=d.clone(e?d.normalize(e):o.identity,!0),this.invalidate(),this},applyCameraRightTransform:function(e){return e?this.setCameraTransform([this.camera,e]):this},applyCameraLeftTransform:function(e){return e?this.setCameraTransform([e,this.camera]):this},applyCameraTransform:function(e){return this.applyCameraRightTransform(e)},setLights:function(e,t,a){this.lights=e instanceof Array?{sources:e,ambient:t,specular:a}:e;var i={x:0,y:0,z:1};return this.lighting=new u.Model(i,this.lights.sources,this.lights.ambient,this.lights.specular),this.invalidate(),this},addLights:function(e){return this.setLights(this.lights.sources.concat(e))},addTodo:function(t){e.every(this.todos,function(e){return e!=t})&&this.todos.push(t)},invalidate:function(){this.deep=!0,this.todos=this.objects},setDimensions:function(e){if(e){var t=a.isString(e.width)?parseInt(e.width):e.width,i=a.isString(e.height)?parseInt(e.height):e.height;if(this.rawNode){var r=this.rawNode.style;r?(r.height=i,r.width=t):(this.rawNode.width=t,this.rawNode.height=i)}this.dimension={width:t,height:i}}else this.dimension=null},render:function(){if(this.todos.length){for(var e=d,t=0;t<this.todos.length;t++)this.todos[t].render(d.normalize([e.cameraRotateXg(180),e.cameraTranslate(0,this.dimension.height,0),this.camera]),this.deep);this.objects=this.schedule(this.objects),this.draw(this.todos,this.objects,this),this.todos=[],this.deep=!1}}}),o.Viewport.nodeType=i.Group.nodeType,o._creators={createEdges:function(e,t){return this.create3DObject(o.Edges,e,t)},createTriangles:function(e,t){return this.create3DObject(o.Triangles,e,t)},createQuads:function(e,t){return this.create3DObject(o.Quads,e,t)},createPolygon:function(e){return this.create3DObject(o.Polygon,e)},createOrbit:function(e){return this.create3DObject(o.Orbit,e)},createCube:function(e){return this.create3DObject(o.Cube,e)},createCylinder:function(e){return this.create3DObject(o.Cylinder,e)},createPath3d:function(e){return this.create3DObject(o.Path3d,e)},createScene:function(){return this.create3DObject(o.Scene)},create3DObject:function(e,t,a){var i=new e;return this.adopt(i),t&&i.setObject(t,a),i},adopt:function(e){return e.renderer=this.renderer,e.parent=this,this.objects.push(e),this.addTodo(e),this},abandon:function(e,t){for(var a=0;a<this.objects.length;++a)this.objects[a]==e&&this.objects.splice(a,1);return e.parent=null,this},setScheduler:function(e){this.schedule=e},setDrawer:function(e){this.draw=e}},a.extend(o.Viewport,o._creators),a.extend(o.Scene,o._creators),delete o._creators,a.extend(i.Surface,{createViewport:function(){var e=this.createObject(o.Viewport,null,!0);return e.setDimensions(this.getDimensions()),e}}),o.Object});//# sourceMappingURL=object.js.map