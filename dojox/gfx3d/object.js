//>>built
define("dojox/gfx3d/object",["dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojox/gfx","dojox/gfx/matrix","./_base","./scheduler","./gradient","./vector","./matrix","./lighting"],function(e,t,i,a,r,o,s,n,d,l,h){var u=s.scheduler;return t("dojox.gfx3d.Object",null,{constructor:function(){this.object=null,this.matrix=null,this.cache=null,this.renderer=null,this.parent=null,this.strokeStyle=null,this.fillStyle=null,this.shape=null},setObject:function(e){return this.object=a.makeParameters(this.object,e),this},setTransform:function(e){return this.matrix=l.clone(e?l.normalize(e):o.identity,!0),this},applyRightTransform:function(e){return e?this.setTransform([this.matrix,e]):this},applyLeftTransform:function(e){return e?this.setTransform([e,this.matrix]):this},applyTransform:function(e){return e?this.setTransform([this.matrix,e]):this},setFill:function(e){return this.fillStyle=e,this},setStroke:function(e){return this.strokeStyle=e,this},toStdFill:function(e,t){return this.fillStyle&&"undefined"!=typeof this.fillStyle.type?e[this.fillStyle.type](t,this.fillStyle.finish,this.fillStyle.color):this.fillStyle},invalidate:function(){this.renderer.addTodo(this)},destroy:function(){if(this.shape){var e=this.shape.getParent();e&&e.remove(this.shape),this.shape=null}},render:function(e){throw"Pure virtual function, not implemented"},draw:function(e){throw"Pure virtual function, not implemented"},getZOrder:function(){return 0},getOutline:function(){return null}}),t("dojox.gfx3d.Scene",o.Object,{constructor:function(){this.objects=[],this.todos=[],this.schedule=u.zOrder,this._draw=o.drawer.conservative},setFill:function(t){return this.fillStyle=t,e.forEach(this.objects,function(e){e.setFill(t)}),this},setStroke:function(t){return this.strokeStyle=t,e.forEach(this.objects,function(e){e.setStroke(t)}),this},render:function(t,i){var a=l.multiply(t,this.matrix);i&&(this.todos=this.objects),e.forEach(this.todos,function(e){e.render(a,i)})},draw:function(e){this.objects=this.schedule(this.objects),this._draw(this.todos,this.objects,this.renderer)},addTodo:function(t){e.every(this.todos,function(e){return e!=t})&&(this.todos.push(t),this.invalidate())},invalidate:function(){this.parent.addTodo(this)},getZOrder:function(){var t=0;return e.forEach(this.objects,function(e){t+=e.getZOrder()}),this.objects.length>1?t/this.objects.length:0}}),t("dojox.gfx3d.Edges",o.Object,{constructor:function(){this.object=i.clone(o.defaultEdges)},setObject:function(e,t){return this.object=a.makeParameters(this.object,e instanceof Array?{points:e,style:t}:e),this},getZOrder:function(){var t=0;return e.forEach(this.cache,function(e){t+=e.z}),this.cache.length>1?t/this.cache.length:0},render:function(t){var i=l.multiply(t,this.matrix);this.cache=e.map(this.object.points,function(e){return l.multiplyPoint(i,e)})},draw:function(){var t=this.cache;this.shape?this.shape.setShape(""):this.shape=this.renderer.createPath();var i=this.shape.setAbsoluteMode("absolute");if("strip"==this.object.style||"loop"==this.object.style)i.moveTo(t[0].x,t[0].y),e.forEach(t.slice(1),function(e){i.lineTo(e.x,e.y)}),"loop"==this.object.style&&i.closePath();else for(var a=0;a<this.cache.length;)i.moveTo(t[a].x,t[a].y),a++,i.lineTo(t[a].x,t[a].y),a++;i.setStroke(this.strokeStyle)}}),t("dojox.gfx3d.Orbit",o.Object,{constructor:function(){this.object=i.clone(o.defaultOrbit)},render:function(t){var i=l.multiply(t,this.matrix),a=[0,Math.PI/4,Math.PI/3],o=l.multiplyPoint(i,this.object.center),s=e.map(a,function(e){return{x:this.center.x+this.radius*Math.cos(e),y:this.center.y+this.radius*Math.sin(e),z:this.center.z}},this.object);s=e.map(s,function(e){return l.multiplyPoint(i,e)});var n=d.normalize(s);s=e.map(s,function(e){return d.substract(e,o)});var h={xx:s[0].x*s[0].y,xy:s[0].y*s[0].y,xz:1,yx:s[1].x*s[1].y,yy:s[1].y*s[1].y,yz:1,zx:s[2].x*s[2].y,zy:s[2].y*s[2].y,zz:1,dx:0,dy:0,dz:0},u=e.map(s,function(e){return-Math.pow(e.x,2)}),m=l.multiplyPoint(l.invert(h),u[0],u[1],u[2]),c=Math.atan2(m.x,1-m.y)/2,f=e.map(s,function(e){return r.multiplyPoint(r.rotate(-c),e.x,e.y)}),p=Math.pow(f[0].x,2),y=Math.pow(f[0].y,2),g=Math.pow(f[1].x,2),v=Math.pow(f[1].y,2),b=Math.sqrt((p*v-y*g)/(v-y)),M=Math.sqrt((p*v-y*g)/(p-g));this.cache={cx:o.x,cy:o.y,rx:b,ry:M,theta:c,normal:n}},draw:function(e){this.shape?this.shape.setShape(this.cache):this.shape=this.renderer.createEllipse(this.cache),this.shape.applyTransform(r.rotateAt(this.cache.theta,this.cache.cx,this.cache.cy)).setStroke(this.strokeStyle).setFill(this.toStdFill(e,this.cache.normal))}}),t("dojox.gfx3d.Path3d",o.Object,{constructor:function(){this.object=i.clone(o.defaultPath3d),this.segments=[],this.absolute=!0,this.last={},this.path=""},_collectArgs:function(e,t){for(var i=0;i<t.length;++i){var a=t[i];"boolean"==typeof a?e.push(a?1:0):"number"==typeof a?e.push(a):a instanceof Array?this._collectArgs(e,a):"x"in a&&"y"in a&&(e.push(a.x),e.push(a.y))}},_validSegments:{m:3,l:3,z:0},_pushSegment:function(e,t){var i,a=this._validSegments[e.toLowerCase()];"number"==typeof a&&(a?t.length>=a&&(i={action:e,args:t.slice(0,t.length-t.length%a)},this.segments.push(i)):(i={action:e,args:[]},this.segments.push(i)))},moveTo:function(){var e=[];return this._collectArgs(e,arguments),this._pushSegment(this.absolute?"M":"m",e),this},lineTo:function(){var e=[];return this._collectArgs(e,arguments),this._pushSegment(this.absolute?"L":"l",e),this},closePath:function(){return this._pushSegment("Z",[]),this},render:function(t){var i=l.multiply(t,this.matrix),a="",r=this._validSegments;e.forEach(this.segments,function(e){a+=e.action;for(var t=0;t<e.args.length;t+=r[e.action.toLowerCase()]){var o=l.multiplyPoint(i,e.args[t],e.args[t+1],e.args[t+2]);a+=" "+o.x+" "+o.y}}),this.cache=a},_draw:function(){return this.parent.createPath(this.cache)}}),t("dojox.gfx3d.Triangles",o.Object,{constructor:function(){this.object=i.clone(o.defaultTriangles)},setObject:function(e,t){return e instanceof Array?this.object=a.makeParameters(this.object,{points:e,style:t}):this.object=a.makeParameters(this.object,e),this},render:function(t){var i=l.multiply(t,this.matrix),a=e.map(this.object.points,function(e){return l.multiplyPoint(i,e)});this.cache=[];var r=a.slice(0,2),o=a[0];if("strip"==this.object.style)e.forEach(a.slice(2),function(e){r.push(e),r.push(r[0]),this.cache.push(r),r=r.slice(1,3)},this);else if("fan"==this.object.style)e.forEach(a.slice(2),function(e){r.push(e),r.push(o),this.cache.push(r),r=[o,e]},this);else for(var s=0;s<a.length;)this.cache.push([a[s],a[s+1],a[s+2],a[s]]),s+=3},draw:function(t){this.cache=u.bsp(this.cache,function(e){return e}),this.shape?this.shape.clear():this.shape=this.renderer.createGroup(),e.forEach(this.cache,function(e){this.shape.createPolyline(e).setStroke(this.strokeStyle).setFill(this.toStdFill(t,d.normalize(e)))},this)},getZOrder:function(){var t=0;return e.forEach(this.cache,function(e){t+=(e[0].z+e[1].z+e[2].z)/3}),this.cache.length>1?t/this.cache.length:0}}),t("dojox.gfx3d.Quads",o.Object,{constructor:function(){this.object=i.clone(o.defaultQuads)},setObject:function(e,t){return this.object=a.makeParameters(this.object,e instanceof Array?{points:e,style:t}:e),this},render:function(t){var i,a=l.multiply(t,this.matrix),r=e.map(this.object.points,function(e){return l.multiplyPoint(a,e)});if(this.cache=[],"strip"==this.object.style){var o=r.slice(0,2);for(i=2;i<r.length;)o=o.concat([r[i],r[i+1],o[0]]),this.cache.push(o),o=o.slice(2,4),i+=2}else for(i=0;i<r.length;)this.cache.push([r[i],r[i+1],r[i+2],r[i+3],r[i]]),i+=4},draw:function(e){this.cache=o.scheduler.bsp(this.cache,function(e){return e}),this.shape?this.shape.clear():this.shape=this.renderer.createGroup();for(var t=0;t<this.cache.length;t++)this.shape.createPolyline(this.cache[t]).setStroke(this.strokeStyle).setFill(this.toStdFill(e,d.normalize(this.cache[t])))},getZOrder:function(){for(var e=0,t=0;t<this.cache.length;t++){var i=this.cache[t];e+=(i[0].z+i[1].z+i[2].z+i[3].z)/4}return this.cache.length>1?e/this.cache.length:0}}),t("dojox.gfx3d.Polygon",o.Object,{constructor:function(){this.object=i.clone(o.defaultPolygon)},setObject:function(e){return this.object=a.makeParameters(this.object,e instanceof Array?{path:e}:e),this},render:function(t){var i=l.multiply(t,this.matrix);this.cache=e.map(this.object.path,function(e){return l.multiplyPoint(i,e)}),this.cache.push(this.cache[0])},draw:function(e){this.shape?this.shape.setShape({points:this.cache}):this.shape=this.renderer.createPolyline({points:this.cache}),this.shape.setStroke(this.strokeStyle).setFill(this.toStdFill(e,l.normalize(this.cache)))},getZOrder:function(){for(var e=0,t=0;t<this.cache.length;t++)e+=this.cache[t].z;return this.cache.length>1?e/this.cache.length:0},getOutline:function(){return this.cache.slice(0,3)}}),t("dojox.gfx3d.Cube",o.Object,{constructor:function(){this.object=i.clone(o.defaultCube),this.polygons=[]},setObject:function(e){this.object=a.makeParameters(this.object,e)},render:function(t){var i=this.object.top,a=this.object.bottom,r={x:a.x,y:i.y,z:i.z},o={x:a.x,y:a.y,z:i.z},s={x:i.x,y:a.y,z:i.z},n={x:i.x,y:i.y,z:a.z},d={x:a.x,y:i.y,z:a.z},h={x:i.x,y:a.y,z:a.z},u=[i,r,o,s,n,d,a,h],m=l.multiply(t,this.matrix),c=e.map(u,function(e){return l.multiplyPoint(m,e)});i=c[0],r=c[1],o=c[2],s=c[3],n=c[4],d=c[5],a=c[6],h=c[7],this.cache=[[i,r,o,s,i],[n,d,a,h,n],[i,s,h,n,i],[s,o,a,h,s],[o,r,d,a,o],[r,i,n,d,r]]},draw:function(e){this.cache=o.scheduler.bsp(this.cache,function(e){return e});var t=this.cache.slice(3);this.shape?this.shape.clear():this.shape=this.renderer.createGroup();for(var i=0;i<t.length;i++)this.shape.createPolyline(t[i]).setStroke(this.strokeStyle).setFill(this.toStdFill(e,d.normalize(t[i])))},getZOrder:function(){var e=this.cache[0][0],t=this.cache[1][2];return(e.z+t.z)/2}}),t("dojox.gfx3d.Cylinder",o.Object,{constructor:function(){this.object=i.clone(o.defaultCylinder)},render:function(t){var i=l.multiply(t,this.matrix),a=[0,Math.PI/4,Math.PI/3],o=l.multiplyPoint(i,this.object.center),s=e.map(a,function(e){return{x:this.center.x+this.radius*Math.cos(e),y:this.center.y+this.radius*Math.sin(e),z:this.center.z}},this.object);s=e.map(s,function(e){return d.substract(l.multiplyPoint(i,e),o)});var h={xx:s[0].x*s[0].y,xy:s[0].y*s[0].y,xz:1,yx:s[1].x*s[1].y,yy:s[1].y*s[1].y,yz:1,zx:s[2].x*s[2].y,zy:s[2].y*s[2].y,zz:1,dx:0,dy:0,dz:0},u=e.map(s,function(e){return-Math.pow(e.x,2)}),m=l.multiplyPoint(l.invert(h),u[0],u[1],u[2]),c=Math.atan2(m.x,1-m.y)/2,f=e.map(s,function(e){return r.multiplyPoint(r.rotate(-c),e.x,e.y)}),p=Math.pow(f[0].x,2),y=Math.pow(f[0].y,2),g=Math.pow(f[1].x,2),v=Math.pow(f[1].y,2),b=Math.sqrt((p*v-y*g)/(v-y)),M=Math.sqrt((p*v-y*g)/(p-g));if(M>b){var k=b;b=M,M=k,c-=Math.PI/2}var x=l.multiplyPoint(i,d.sum(this.object.center,{x:0,y:0,z:this.object.height})),w="constant"==this.fillStyle.type?this.fillStyle.color:n(this.renderer.lighting,this.fillStyle,this.object.center,this.object.radius,Math.PI,2*Math.PI,i);(isNaN(b)||isNaN(M)||isNaN(c))&&(b=this.object.radius,M=0,c=0),this.cache={center:o,top:x,rx:b,ry:M,theta:c,gradient:w}},draw:function(){var e=this.cache,t=d,i=r,a=[e.center,e.top],o=t.substract(e.top,e.center);t.dotProduct(o,this.renderer.lighting.incident)>0&&(a=[e.top,e.center],o=t.substract(e.center,e.top));var s=this.renderer.lighting[this.fillStyle.type](o,this.fillStyle.finish,this.fillStyle.color),n=Math.sqrt(Math.pow(e.center.x-e.top.x,2)+Math.pow(e.center.y-e.top.y,2));this.shape?this.shape.clear():this.shape=this.renderer.createGroup(),this.shape.createPath("").moveTo(0,-e.rx).lineTo(n,-e.rx).lineTo(n,e.rx).lineTo(0,e.rx).arcTo(e.ry,e.rx,0,!0,!0,0,-e.rx).setFill(e.gradient).setStroke(this.strokeStyle).setTransform([i.translate(a[0]),i.rotate(Math.atan2(a[1].y-a[0].y,a[1].x-a[0].x))]),e.rx>0&&e.ry>0&&this.shape.createEllipse({cx:a[1].x,cy:a[1].y,rx:e.rx,ry:e.ry}).setFill(s).setStroke(this.strokeStyle).applyTransform(i.rotateAt(e.theta,a[1]))}}),t("dojox.gfx3d.Viewport",a.Group,{constructor:function(){this.dimension=null,this.objects=[],this.todos=[],this.renderer=this,this.schedule=o.scheduler.zOrder,this.draw=o.drawer.conservative,this.deep=!1,this.lights=[],this.lighting=null},setCameraTransform:function(e){return this.camera=l.clone(e?l.normalize(e):o.identity,!0),this.invalidate(),this},applyCameraRightTransform:function(e){return e?this.setCameraTransform([this.camera,e]):this},applyCameraLeftTransform:function(e){return e?this.setCameraTransform([e,this.camera]):this},applyCameraTransform:function(e){return this.applyCameraRightTransform(e)},setLights:function(e,t,i){this.lights=e instanceof Array?{sources:e,ambient:t,specular:i}:e;var a={x:0,y:0,z:1};return this.lighting=new h.Model(a,this.lights.sources,this.lights.ambient,this.lights.specular),this.invalidate(),this},addLights:function(e){return this.setLights(this.lights.sources.concat(e))},addTodo:function(t){e.every(this.todos,function(e){return e!=t})&&this.todos.push(t)},invalidate:function(){this.deep=!0,this.todos=this.objects},setDimensions:function(e){if(e){var t=i.isString(e.width)?parseInt(e.width):e.width,a=i.isString(e.height)?parseInt(e.height):e.height;if(this.rawNode){var r=this.rawNode.style;r?(r.height=a,r.width=t):(this.rawNode.width=t,this.rawNode.height=a)}this.dimension={width:t,height:a}}else this.dimension=null},render:function(){if(this.todos.length){for(var e=l,t=0;t<this.todos.length;t++)this.todos[t].render(l.normalize([e.cameraRotateXg(180),e.cameraTranslate(0,this.dimension.height,0),this.camera]),this.deep);this.objects=this.schedule(this.objects),this.draw(this.todos,this.objects,this),this.todos=[],this.deep=!1}}}),o.Viewport.nodeType=a.Group.nodeType,o._creators={createEdges:function(e,t){return this.create3DObject(o.Edges,e,t)},createTriangles:function(e,t){return this.create3DObject(o.Triangles,e,t)},createQuads:function(e,t){return this.create3DObject(o.Quads,e,t)},createPolygon:function(e){return this.create3DObject(o.Polygon,e)},createOrbit:function(e){return this.create3DObject(o.Orbit,e)},createCube:function(e){return this.create3DObject(o.Cube,e)},createCylinder:function(e){return this.create3DObject(o.Cylinder,e)},createPath3d:function(e){return this.create3DObject(o.Path3d,e)},createScene:function(){return this.create3DObject(o.Scene)},create3DObject:function(e,t,i){var a=new e;return this.adopt(a),t&&a.setObject(t,i),a},adopt:function(e){return e.renderer=this.renderer,e.parent=this,this.objects.push(e),this.addTodo(e),this},abandon:function(e,t){for(var i=0;i<this.objects.length;++i)this.objects[i]==e&&this.objects.splice(i,1);return e.parent=null,this},setScheduler:function(e){this.schedule=e},setDrawer:function(e){this.draw=e}},i.extend(o.Viewport,o._creators),i.extend(o.Scene,o._creators),delete o._creators,i.extend(a.Surface,{createViewport:function(){var e=this.createObject(o.Viewport,null,!0);return e.setDimensions(this.getDimensions()),e}}),o.Object});//# sourceMappingURL=object.js.map