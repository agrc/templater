//>>built
define("dojox/mdnd/adapter/DndFromDojo",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/connect","dojo/_base/array","dojo/dom-class","dojo/_base/window","dojox/mdnd/AreaManager","dojo/dnd/Manager"],function(e,t,i,a,o,r,n,s){var l=t("dojox.mdnd.adapter.DndFromDojo",null,{dropIndicatorSize:{w:0,h:50},_areaManager:null,_dojoManager:null,_currentArea:null,_oldArea:null,_moveHandler:null,_subscribeHandler:null,constructor:function(){this._areaManager=n.areaManager(),this._dojoManager=s.manager(),this._currentArea=null,this._moveHandler=null,this.subscribeDnd()},subscribeDnd:function(){this._subscribeHandler=[i.subscribe("/dnd/start",this,"onDragStart"),i.subscribe("/dnd/drop/before",this,"onDrop"),i.subscribe("/dnd/cancel",this,"onDropCancel"),i.subscribe("/dnd/source/over",this,"onDndSource")]},unsubscribeDnd:function(){a.forEach(this._subscribeHandler,i.unsubscribe)},_getHoverArea:function(e){var t=e.x,i=e.y;this._oldArea=this._currentArea,this._currentArea=null;for(var a=this._areaManager._areaList,o=0;o<a.length;o++){var r=a[o],n=r.coords.x,s=n+r.node.offsetWidth,l=r.coords.y,d=l+r.node.offsetHeight;if(n<=t&&t<=s&&l<=i&&i<=d){this._areaManager._oldIndexArea=this._areaManager._currentIndexArea,this._areaManager._currentIndexArea=o,this._currentArea=r.node;break}}this._currentArea!=this._oldArea&&(null==this._currentArea?this.onDragExit():null==this._oldArea?this.onDragEnter():(this.onDragExit(),this.onDragEnter()))},onDragStart:function(t,a,o){this._dragNode=a[0],this._copy=o,this._source=t,this._outSourceHandler=i.connect(this._dojoManager,"outSource",this,function(){null==this._moveHandler&&(this._moveHandler=i.connect(e.doc,"mousemove",this,"onMouseMove"))})},onMouseMove:function(e){var t={x:e.pageX,y:e.pageY};this._getHoverArea(t),this._currentArea&&this._areaManager._accept&&("hidden"==this._areaManager._dropIndicator.node.style.visibility&&(this._areaManager._dropIndicator.node.style.visibility="",o.add(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop")),this._areaManager.placeDropIndicator(t,this.dropIndicatorSize))},onDragEnter:function(){var e=this._dragNode.getAttribute("dndType"),t=e?e.split(/\s*,\s*/):["text"];this._areaManager._isAccepted(t,this._areaManager._areaList[this._areaManager._currentIndexArea].accept),this._dojoManager.avatar&&(this._areaManager._accept?o.add(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop"):o.remove(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop"))},onDragExit:function(){this._areaManager._accept=!1,this._dojoManager.avatar&&o.remove(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop"),null==this._currentArea?(this._areaManager._dropMode.refreshItems(this._areaManager._areaList[this._areaManager._oldIndexArea],this._areaManager._oldDropIndex,this.dropIndicatorSize,!1),this._areaManager._resetAfterDrop()):this._areaManager._dropIndicator.remove()},isAccepted:function(e,t){var i=e.getAttribute("dndType")?e.getAttribute("dndType"):"text";return!!(i&&i in t)},onDndSource:function(t){if(null!=this._currentArea)if(t){if(this._dojoManager.target==t||this.isAccepted(this._dragNode,t.accept)){i.disconnect(this._moveHandler),this._currentArea=this._moveHandler=null;var a=this._areaManager._dropIndicator.node;a&&null!==a.parentNode&&1==a.parentNode.nodeType&&(a.style.visibility="hidden")}else this._resetAvatar()}else this._moveHandler||(this._moveHandler=i.connect(e.doc,"mousemove",this,"onMouseMove")),this._resetAvatar()},_resetAvatar:function(){this._dojoManager.avatar&&(this._areaManager._accept?o.add(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop"):o.remove(this._dojoManager.avatar.node,"dojoDndAvatarCanDrop"))},onDropCancel:function(){null==this._currentArea?(this._areaManager._resetAfterDrop(),i.disconnect(this._moveHandler),i.disconnect(this._outSourceHandler),this._currentArea=this._moveHandler=this._outSourceHandler=null):this._areaManager._accept?this.onDrop(this._source,[this._dragNode],this._copy,this._currentArea):(this._currentArea=null,i.disconnect(this._outSourceHandler),i.disconnect(this._moveHandler),this._moveHandler=this._outSourceHandler=null)},onDrop:function(e,t,a){if(i.disconnect(this._moveHandler),i.disconnect(this._outSourceHandler),this._moveHandler=this._outSourceHandler=null,this._currentArea){var o=this._areaManager._currentDropIndex;i.publish("/dnd/drop/after",[e,t,a,this._currentArea,o]),this._currentArea=null}"hidden"==this._areaManager._dropIndicator.node.style.visibility&&(this._areaManager._dropIndicator.node.style.visibility=""),this._areaManager._resetAfterDrop()}});return dojox.mdnd.adapter._dndFromDojo=null,dojox.mdnd.adapter._dndFromDojo=new dojox.mdnd.adapter.DndFromDojo,l});//# sourceMappingURL=DndFromDojo.js.map