//>>built
define("dojox/storage/GearsStorageProvider",["dojo","dijit","dojox","dojo/require!dojo/gears,dojox/storage/Provider,dojox/storage/manager,dojox/sql"],function(e,t,i){e.provide("dojox.storage.GearsStorageProvider"),e.require("dojo.gears"),e.require("dojox.storage.Provider"),e.require("dojox.storage.manager"),e.require("dojox.sql"),e.gears.available&&function(){e.declare("dojox.storage.GearsStorageProvider",i.storage.Provider,{constructor:function(){},TABLE_NAME:"__DOJO_STORAGE",initialized:!1,_available:null,_storageReady:!1,initialize:function(){1!=e.config.disableGearsStorage&&(this.TABLE_NAME="__DOJO_STORAGE",this.initialized=!0,i.storage.manager.loaded())},isAvailable:function(){return this._available=e.gears.available},put:function(t,a,r,o){if(this._initStorage(),!this.isValidKey(t))throw new Error("Invalid key given: "+t);if(o=o||this.DEFAULT_NAMESPACE,!this.isValidKey(o))throw new Error("Invalid namespace given: "+t);a=e.isString(a)?"string:"+a:e.toJson(a);try{i.sql("DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ? AND key = ?",o,t),i.sql("INSERT INTO "+this.TABLE_NAME+" VALUES (?, ?, ?)",o,t,a)}catch(e){return void r(this.FAILED,t,e.toString(),o)}r&&r(i.storage.SUCCESS,t,null,o)},get:function(t,a){if(this._initStorage(),!this.isValidKey(t))throw new Error("Invalid key given: "+t);if(a=a||this.DEFAULT_NAMESPACE,!this.isValidKey(a))throw new Error("Invalid namespace given: "+t);var r=i.sql("SELECT * FROM "+this.TABLE_NAME+" WHERE namespace = ? AND  key = ?",a,t);return r.length?(r=r[0].value,r=e.isString(r)&&/^string:/.test(r)?r.substring("string:".length):e.fromJson(r)):null},getNamespaces:function(){this._initStorage();for(var e=[i.storage.DEFAULT_NAMESPACE],t=i.sql("SELECT namespace FROM "+this.TABLE_NAME+" DESC GROUP BY namespace"),a=0;a<t.length;a++)t[a].namespace!=i.storage.DEFAULT_NAMESPACE&&e.push(t[a].namespace);return e},getKeys:function(e){if(this._initStorage(),e=e||this.DEFAULT_NAMESPACE,!this.isValidKey(e))throw new Error("Invalid namespace given: "+e);for(var t=i.sql("SELECT key FROM "+this.TABLE_NAME+" WHERE namespace = ?",e),a=[],r=0;r<t.length;r++)a.push(t[r].key);return a},clear:function(e){if(this._initStorage(),e=e||this.DEFAULT_NAMESPACE,!this.isValidKey(e))throw new Error("Invalid namespace given: "+e);i.sql("DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ?",e)},remove:function(e,t){if(this._initStorage(),!this.isValidKey(e))throw new Error("Invalid key given: "+e);if(t=t||this.DEFAULT_NAMESPACE,!this.isValidKey(t))throw new Error("Invalid namespace given: "+e);i.sql("DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ? AND key = ?",t,e)},putMultiple:function(t,a,r,o){if(this._initStorage(),!this.isValidKeyArray(t)||!a instanceof Array||t.length!=a.length)throw new Error("Invalid arguments: keys = ["+t+"], values = ["+a+"]");if(null!=o&&void 0!==o||(o=i.storage.DEFAULT_NAMESPACE),!this.isValidKey(o))throw new Error("Invalid namespace given: "+o);this._statusHandler=r;try{i.sql.open(),i.sql.db.execute("BEGIN TRANSACTION");for(var n="REPLACE INTO "+this.TABLE_NAME+" VALUES (?, ?, ?)",s=0;s<t.length;s++){var l=a[s];l=e.isString(l)?"string:"+l:e.toJson(l),i.sql.db.execute(n,[o,t[s],l])}i.sql.db.execute("COMMIT TRANSACTION"),i.sql.close()}catch(e){return void(r&&r(this.FAILED,t,e.toString(),o))}r&&r(i.storage.SUCCESS,t,null,o)},getMultiple:function(t,a){if(this._initStorage(),!this.isValidKeyArray(t))throw new("Invalid key array given: "+t);if(null!=a&&void 0!==a||(a=i.storage.DEFAULT_NAMESPACE),!this.isValidKey(a))throw new Error("Invalid namespace given: "+a);for(var r="SELECT * FROM "+this.TABLE_NAME+" WHERE namespace = ? AND  key = ?",o=[],n=0;n<t.length;n++){var s=i.sql(r,a,t[n]);s.length?(s=s[0].value,e.isString(s)&&/^string:/.test(s)?o[n]=s.substring("string:".length):o[n]=e.fromJson(s)):o[n]=null}return o},removeMultiple:function(e,t){if(this._initStorage(),!this.isValidKeyArray(e))throw new Error("Invalid arguments: keys = ["+e+"]");if(null!=t&&void 0!==t||(t=i.storage.DEFAULT_NAMESPACE),!this.isValidKey(t))throw new Error("Invalid namespace given: "+t);i.sql.open(),i.sql.db.execute("BEGIN TRANSACTION");for(var a="DELETE FROM "+this.TABLE_NAME+" WHERE namespace = ? AND key = ?",r=0;r<e.length;r++)i.sql.db.execute(a,[t,e[r]]);i.sql.db.execute("COMMIT TRANSACTION"),i.sql.close()},isPermanent:function(){return!0},getMaximumSize:function(){return this.SIZE_NO_LIMIT},hasSettingsUI:function(){return!1},showSettingsUI:function(){throw new Error(this.declaredClass+" does not support a storage settings user-interface")},hideSettingsUI:function(){throw new Error(this.declaredClass+" does not support a storage settings user-interface")},_initStorage:function(){if(!this._storageReady){if(!google.gears.factory.hasPermission){if(!google.gears.factory.getPermission(null,null,"This site would like to use Google Gears to enable enhanced functionality."))throw new Error("You must give permission to use Gears in order to store data")}try{i.sql("CREATE TABLE IF NOT EXISTS "+this.TABLE_NAME+"(  namespace TEXT,  key TEXT,  value TEXT )"),i.sql("CREATE UNIQUE INDEX IF NOT EXISTS namespace_key_index ON "+this.TABLE_NAME+" (namespace, key)")}catch(e){throw new Error("Unable to create storage tables for Gears in Dojo Storage")}this._storageReady=!0}}}),i.storage.manager.register("dojox.storage.GearsStorageProvider",new i.storage.GearsStorageProvider)}()});//# sourceMappingURL=GearsStorageProvider.js.map