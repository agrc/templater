//>>built
define("dojox/sql/_base",["dojo","dijit","dojox","dojo/require!dojox/sql/_crypto"],function(e,t,i){e.provide("dojox.sql._base"),e.require("dojox.sql._crypto"),e.mixin(i.sql,{dbName:null,debug:e.exists("dojox.sql.debug")?i.sql.debug:!1,open:function(e){if(!this._dbOpen||e&&e!=this.dbName){this.dbName||(this.dbName="dot_store_"+window.location.href.replace(/[^0-9A-Za-z_]/g,"_"),this.dbName.length>63&&(this.dbName=this.dbName.substring(0,63))),e||(e=this.dbName);try{this._initDb(),this.db.open(e),this._dbOpen=!0}catch(t){throw t.message||t}}},close:function(t){if(!e.isIE&&(this._dbOpen||t&&t!=this.dbName)){t||(t=this.dbName);try{this.db.close(t),this._dbOpen=!1}catch(i){throw i.message||i}}},_exec:function(t){try{this._initDb(),this._dbOpen||(this.open(),this._autoClose=!0);var a=null,o=null,n=null,r=e._toArray(t);a=r.splice(0,1)[0],(this._needsEncrypt(a)||this._needsDecrypt(a))&&(o=r.splice(r.length-1,1)[0],n=r.splice(r.length-1,1)[0]),this.debug&&this._printDebugSQL(a,r);var s;if(this._needsEncrypt(a))return s=new i.sql._SQLCrypto("encrypt",a,n,r,o),null;if(this._needsDecrypt(a))return s=new i.sql._SQLCrypto("decrypt",a,n,r,o),null;var l=this.db.execute(a,r);return l=this._normalizeResults(l),this._autoClose&&this.close(),l}catch(d){if(d=d.message||d,this._autoClose)try{this.close()}catch(h){}throw d}return null},_initDb:function(){if(!this.db)try{this.db=google.gears.factory.create("beta.database","1.0")}catch(t){throw e.setObject("google.gears.denied",!0),i.off&&i.off.onFrameworkEvent("coreOperationFailed"),"Google Gears must be allowed to run"}},_printDebugSQL:function(e,t){for(var i='dojox.sql("'+e+'"',a=0;a<t.length;a++)i+="string"==typeof t[a]?', "'+t[a]+'"':", "+t[a];i+=")"},_normalizeResults:function(e){var t=[];if(!e)return[];for(;e.isValidRow();){for(var i={},a=0;a<e.fieldCount();a++){var o=e.fieldName(a),n=e.field(a);i[o]=n}t.push(i),e.next()}return e.close(),t},_needsEncrypt:function(e){return/encrypt\([^\)]*\)/i.test(e)},_needsDecrypt:function(e){return/decrypt\([^\)]*\)/i.test(e)}}),e.declare("dojox.sql._SQLCrypto",null,{constructor:function(e,t,i,a,o){"encrypt"==e?this._execEncryptSQL(t,i,a,o):this._execDecryptSQL(t,i,a,o)},_execEncryptSQL:function(e,t,a,o){var n=this._stripCryptoSQL(e),r=this._flagEncryptedArgs(e,a),s=this;this._encrypt(n,t,a,r,function(a){var r=!1,l=[],d=null;try{l=i.sql.db.execute(n,a)}catch(h){r=!0,d=h.message||h}if(null!=d){if(i.sql._autoClose)try{i.sql.close()}catch(c){}return void o(null,!0,d.toString())}if(l=i.sql._normalizeResults(l),i.sql._autoClose&&i.sql.close(),i.sql._needsDecrypt(e)){var u=s._determineDecryptedColumns(e);s._decrypt(l,u,t,function(e){o(e,!1,null)})}else o(l,!1,null)})},_execDecryptSQL:function(e,t,a,o){var n=this._stripCryptoSQL(e),r=this._determineDecryptedColumns(e),s=!1,l=[],d=null;try{l=i.sql.db.execute(n,a)}catch(h){s=!0,d=h.message||h}if(null!=d){if(i.sql._autoClose)try{i.sql.close()}catch(c){}return void o(l,!0,d.toString())}l=i.sql._normalizeResults(l),i.sql._autoClose&&i.sql.close(),this._decrypt(l,r,t,function(e){o(e,!1,null)})},_encrypt:function(t,a,o,n,r){this._totalCrypto=0,this._finishedCrypto=0,this._finishedSpawningCrypto=!1,this._finalArgs=o;for(var s=0;s<o.length;s++)if(n[s]){var l=o[s],d=s;this._totalCrypto++,i.sql._crypto.encrypt(l,a,e.hitch(this,function(e){this._finalArgs[d]=e,this._finishedCrypto++,this._finishedCrypto>=this._totalCrypto&&this._finishedSpawningCrypto&&r(this._finalArgs)}))}this._finishedSpawningCrypto=!0},_decrypt:function(e,t,i,a){this._totalCrypto=0,this._finishedCrypto=0,this._finishedSpawningCrypto=!1,this._finalResultSet=e;for(var o=0;o<e.length;o++){var n=e[o];for(var r in n)if("*"==t||t[r]){this._totalCrypto++;var s=n[r];this._decryptSingleColumn(r,s,i,o,function(e){a(e)})}}this._finishedSpawningCrypto=!0},_stripCryptoSQL:function(e){e=e.replace(/DECRYPT\(\*\)/gi,"*");var t=e.match(/ENCRYPT\([^\)]*\)/gi);if(null!=t)for(var i=0;i<t.length;i++){var a=t[i],o=a.match(/ENCRYPT\(([^\)]*)\)/i)[1];e=e.replace(a,o)}if(t=e.match(/DECRYPT\([^\)]*\)/gi),null!=t)for(i=0;i<t.length;i++){var n=t[i],r=n.match(/DECRYPT\(([^\)]*)\)/i)[1];e=e.replace(n,r)}return e},_flagEncryptedArgs:function(e,t){for(var i,a=new RegExp(/([\"][^\"]*\?[^\"]*[\"])|([\'][^\']*\?[^\']*[\'])|(\?)/gi),o=0,n=[];null!=(i=a.exec(e));){var r=RegExp.lastMatch+"";if(!/^[\"\']/.test(r)){var s=!1;/ENCRYPT\([^\)]*$/i.test(RegExp.leftContext)&&(s=!0),n[o]=s,o++}}return n},_determineDecryptedColumns:function(t){var i={};if(/DECRYPT\(\*\)/i.test(t))i="*";else for(var a=/DECRYPT\((?:\s*\w*\s*\,?)*\)/gi,o=a.exec(t);o;){var n=new String(RegExp.lastMatch),r=n.replace(/DECRYPT\(/i,"");r=r.replace(/\)/,""),r=r.split(/\s*,\s*/),e.forEach(r,function(e){/\s*\w* AS (\w*)/i.test(e)&&(e=e.match(/\s*\w* AS (\w*)/i)[1]),i[e]=!0}),o=a.exec(t)}return i},_decryptSingleColumn:function(t,a,o,n,r){i.sql._crypto.decrypt(a,o,e.hitch(this,function(e){this._finalResultSet[n][t]=e,this._finishedCrypto++,this._finishedCrypto>=this._totalCrypto&&this._finishedSpawningCrypto&&r(this._finalResultSet)}))}}),function(){var t=i.sql;i.sql=new Function("return dojox.sql._exec(arguments);"),e.mixin(i.sql,t)}()});//# sourceMappingURL=_base.js.map