//>>built
define("dojox/sql/_crypto",["dojo","dijit","dojox"],function(dojo,dijit,dojox){dojo.provide("dojox.sql._crypto"),dojo.mixin(dojox.sql._crypto,{_POOL_SIZE:100,encrypt:function(e,t,i){this._initWorkerPool();var o={plaintext:e,password:t};o=dojo.toJson(o),o="encr:"+String(o),this._assignWork(o,i)},decrypt:function(e,t,i){this._initWorkerPool();var o={ciphertext:e,password:t};o=dojo.toJson(o),o="decr:"+String(o),this._assignWork(o,i)},_initWorkerPool:function(){if(!this._manager)try{this._manager=google.gears.factory.create("beta.workerpool","1.0"),this._unemployed=[],this._employed={},this._handleMessage=[];var e=this;this._manager.onmessage=function(t,i){var o=e._employed["_"+i];if(e._employed["_"+i]=void 0,e._unemployed.push("_"+i),e._handleMessage.length){var a=e._handleMessage.shift();e._assignWork(a.msg,a.callback)}o(t)};for(var t="function _workerInit(){gearsWorkerPool.onmessage = "+String(this._workerHandler)+";}",i=t+" _workerInit();",o=0;o<this._POOL_SIZE;o++)this._unemployed.push("_"+this._manager.createWorker(i))}catch(a){throw a.message||a}},_assignWork:function(e,t){if(!this._handleMessage.length&&this._unemployed.length){var i=this._unemployed.shift().substring(1);this._employed["_"+i]=t,this._manager.sendMessage(e,parseInt(i,10))}else this._handleMessage={msg:e,callback:t}},_workerHandler:function(msg,sender){function Cipher(e,t){for(var i=4,o=t.length/i-1,a=[[],[],[],[]],n=0;4*i>n;n++)a[n%4][Math.floor(n/4)]=e[n];a=AddRoundKey(a,t,0,i);for(var r=1;o>r;r++)a=SubBytes(a,i),a=ShiftRows(a,i),a=MixColumns(a,i),a=AddRoundKey(a,t,r,i);a=SubBytes(a,i),a=ShiftRows(a,i),a=AddRoundKey(a,t,o,i);for(var s=new Array(4*i),n=0;4*i>n;n++)s[n]=a[n%4][Math.floor(n/4)];return s}function SubBytes(e,t){for(var i=0;4>i;i++)for(var o=0;t>o;o++)e[i][o]=Sbox[e[i][o]];return e}function ShiftRows(e,t){for(var i=new Array(4),o=1;4>o;o++){for(var a=0;4>a;a++)i[a]=e[o][(a+o)%t];for(var a=0;4>a;a++)e[o][a]=i[a]}return e}function MixColumns(e,t){for(var i=0;4>i;i++){for(var o=new Array(4),a=new Array(4),n=0;4>n;n++)o[n]=e[n][i],a[n]=128&e[n][i]?e[n][i]<<1^283:e[n][i]<<1;e[0][i]=a[0]^o[1]^a[1]^o[2]^o[3],e[1][i]=o[0]^a[1]^o[2]^a[2]^o[3],e[2][i]=o[0]^o[1]^a[2]^o[3]^a[3],e[3][i]=o[0]^a[0]^o[1]^o[2]^a[3]}return e}function AddRoundKey(e,t,i,o){for(var a=0;4>a;a++)for(var n=0;o>n;n++)e[a][n]^=t[4*i+n][a];return e}function KeyExpansion(e){for(var t=4,i=e.length/4,o=i+6,a=new Array(t*(o+1)),n=new Array(4),r=0;i>r;r++){var s=[e[4*r],e[4*r+1],e[4*r+2],e[4*r+3]];a[r]=s}for(var r=i;t*(o+1)>r;r++){a[r]=new Array(4);for(var d=0;4>d;d++)n[d]=a[r-1][d];if(r%i==0){n=SubWord(RotWord(n));for(var d=0;4>d;d++)n[d]^=Rcon[r/i][d]}else i>6&&r%i==4&&(n=SubWord(n));for(var d=0;4>d;d++)a[r][d]=a[r-i][d]^n[d]}return a}function SubWord(e){for(var t=0;4>t;t++)e[t]=Sbox[e[t]];return e}function RotWord(e){e[4]=e[0];for(var t=0;4>t;t++)e[t]=e[t+1];return e}function AESEncryptCtr(e,t,i){if(128!=i&&192!=i&&256!=i)return"";for(var o=i/8,a=new Array(o),n=0;o>n;n++)a[n]=255&t.charCodeAt(n);var r=Cipher(a,KeyExpansion(a));r=r.concat(r.slice(0,o-16));for(var s=16,d=new Array(s),l=(new Date).getTime(),n=0;4>n;n++)d[n]=l>>>8*n&255;for(var n=0;4>n;n++)d[n+4]=l/4294967296>>>8*n&255;for(var h=KeyExpansion(r),c=Math.ceil(e.length/s),u=new Array(c),m=0;c>m;m++){for(var f=0;4>f;f++)d[15-f]=m>>>8*f&255;for(var f=0;4>f;f++)d[15-f-4]=m/4294967296>>>8*f;for(var p=Cipher(d,h),g=c-1>m?s:(e.length-1)%s+1,y="",n=0;g>n;n++){var v=e.charCodeAt(m*s+n),b=v^p[n];y+=String.fromCharCode(b)}u[m]=escCtrlChars(y)}for(var _="",n=0;8>n;n++)_+=String.fromCharCode(d[n]);return _=escCtrlChars(_),_+"-"+u.join("-")}function AESDecryptCtr(e,t,i){if(128!=i&&192!=i&&256!=i)return"";for(var o=i/8,a=new Array(o),n=0;o>n;n++)a[n]=255&t.charCodeAt(n);var r=KeyExpansion(a),s=Cipher(a,r);s=s.concat(s.slice(0,o-16));var d=KeyExpansion(s);e=e.split("-");for(var l=16,h=new Array(l),c=unescCtrlChars(e[0]),n=0;8>n;n++)h[n]=c.charCodeAt(n);for(var u=new Array(e.length-1),m=1;m<e.length;m++){for(var f=0;4>f;f++)h[15-f]=m-1>>>8*f&255;for(var f=0;4>f;f++)h[15-f-4]=m/4294967296-1>>>8*f&255;var p=Cipher(h,d);e[m]=unescCtrlChars(e[m]);for(var g="",n=0;n<e[m].length;n++){var y=e[m].charCodeAt(n),v=y^p[n];g+=String.fromCharCode(v)}u[m-1]=g}return u.join("")}function escCtrlChars(e){return e.replace(/[\0\t\n\v\f\r\xa0!-]/g,function(e){return"!"+e.charCodeAt(0)+"!"})}function unescCtrlChars(e){return e.replace(/!\d\d?\d?!/g,function(e){return String.fromCharCode(e.slice(1,-1))})}function encrypt(e,t){return AESEncryptCtr(e,t,256)}function decrypt(e,t){return AESDecryptCtr(e,t,256)}var Sbox=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],Rcon=[[0,0,0,0],[1,0,0,0],[2,0,0,0],[4,0,0,0],[8,0,0,0],[16,0,0,0],[32,0,0,0],[64,0,0,0],[128,0,0,0],[27,0,0,0],[54,0,0,0]],cmd=msg.substr(0,4),arg=msg.substr(5);if("encr"==cmd){arg=eval("("+arg+")");var plaintext=arg.plaintext,password=arg.password,results=encrypt(plaintext,password);gearsWorkerPool.sendMessage(String(results),sender)}else if("decr"==cmd){arg=eval("("+arg+")");var ciphertext=arg.ciphertext,password=arg.password,results=decrypt(ciphertext,password);gearsWorkerPool.sendMessage(String(results),sender)}}})});//# sourceMappingURL=_crypto.js.map