//>>built
define("dojox/editor/plugins/SpellCheck",["dojo","dijit","dojo/io/script","dijit/popup","dijit/_Widget","dijit/_Templated","dijit/_editor/_Plugin","dijit/form/TextBox","dijit/form/DropDownButton","dijit/TooltipDialog","dijit/form/MultiSelect","dijit/Menu","dojo/i18n!dojox/editor/plugins/nls/SpellCheck"],function(e,t,i,r,n,a,o){e.experimental("dojox.editor.plugins.SpellCheck");var s=e.declare("dojox.editor.plugins._spellCheckControl",[n,a],{widgetsInTemplate:!0,templateString:"<table role='presentation' class='dijitEditorSpellCheckTable'><tr><td colspan='3' class='alignBottom'><label for='${textId}' id='${textId}_label'>${unfound}</label><div class='dijitEditorSpellCheckBusyIcon' id='${id}_progressIcon'></div></td></tr><tr><td class='dijitEditorSpellCheckBox'><input dojoType='dijit.form.TextBox' required='false' intermediateChanges='true' class='dijitEditorSpellCheckBox' dojoAttachPoint='unfoundTextBox' id='${textId}'/></td><td><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='skipButton'>${skip}</button></td><td><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='skipAllButton'>${skipAll}</button></td></tr><tr><td class='alignBottom'><label for='${selectId}'>${suggestions}</td></label><td colspan='2'><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='toDicButton'>${toDic}</button></td></tr><tr><td><select dojoType='dijit.form.MultiSelect' id='${selectId}' class='dijitEditorSpellCheckBox listHeight' dojoAttachPoint='suggestionSelect'></select></td><td colspan='2'><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='replaceButton'>${replace}</button><div class='topMargin'><button dojoType='dijit.form.Button' class='blockButton' dojoAttachPoint='replaceAllButton'>${replaceAll}</button><div></td></tr><tr><td><div class='topMargin'><button dojoType='dijit.form.Button' dojoAttachPoint='cancelButton'>${cancel}</button></div></td><td></td><td></td></tr></table>",constructor:function(){this.ignoreChange=!1,this.isChanged=!1,this.isOpen=!1,this.closable=!0},postMixInProperties:function(){this.id=t.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.textId=this.id+"_textBox",this.selectId=this.id+"_select"},postCreate:function(){var t=this.suggestionSelect;e.removeAttr(t.domNode,"multiple"),t.addItems=function(t){var i=this,r=null;t&&t.length>0&&e.forEach(t,function(t,n){r=e.create("option",{innerHTML:t,value:t},i.domNode),0==n&&(r.selected=!0)})},t.removeItems=function(){e.empty(this.domNode)},t.deselectAll=function(){this.containerNode.selectedIndex=-1},this.connect(this,"onKeyPress","_cancel"),this.connect(this.unfoundTextBox,"onKeyPress","_enter"),this.connect(this.unfoundTextBox,"onChange","_unfoundTextBoxChange"),this.connect(this.suggestionSelect,"onKeyPress","_enter"),this.connect(this.skipButton,"onClick","onSkip"),this.connect(this.skipAllButton,"onClick","onSkipAll"),this.connect(this.toDicButton,"onClick","onAddToDic"),this.connect(this.replaceButton,"onClick","onReplace"),this.connect(this.replaceAllButton,"onClick","onReplaceAll"),this.connect(this.cancelButton,"onClick","onCancel")},onSkip:function(){},onSkipAll:function(){},onAddToDic:function(){},onReplace:function(){},onReplaceAll:function(){},onCancel:function(){},onEnter:function(){},focus:function(){this.unfoundTextBox.focus()},_cancel:function(t){t.keyCode==e.keys.ESCAPE&&(this.onCancel(),e.stopEvent(t))},_enter:function(t){t.keyCode==e.keys.ENTER&&(this.onEnter(),e.stopEvent(t))},_unfoundTextBoxChange:function(){var t=this.textId+"_label";this.ignoreChange?e.byId(t).innerHTML=this.unfound:(e.byId(t).innerHTML=this.replaceWith,this.isChanged=!0,this.suggestionSelect.deselectAll())},_setUnfoundWordAttr:function(e){e=e||"",this.unfoundTextBox.set("value",e)},_getUnfoundWordAttr:function(){return this.unfoundTextBox.get("value")},_setSuggestionListAttr:function(e){var t=this.suggestionSelect;e=e||[],t.removeItems(),t.addItems(e)},_getSelectedWordAttr:function(){var e=this.suggestionSelect.getSelected();return e&&e.length>0?e[0].value:this.unfoundTextBox.get("value")},_setDisabledAttr:function(e){this.skipButton.set("disabled",e),this.skipAllButton.set("disabled",e),this.toDicButton.set("disabled",e),this.replaceButton.set("disabled",e),this.replaceAllButton.set("disabled",e)},_setInProgressAttr:function(t){var i=this.id+"_progressIcon";e.toggleClass(i,"hidden",!t)}}),d=e.declare("dojox.editor.plugins._SpellCheckScriptMultiPart",null,{ACTION_QUERY:"query",ACTION_UPDATE:"update",callbackHandle:"callback",maxBufferLength:100,delimiter:" ",label:"response",_timeout:3e4,SEC:1e3,constructor:function(){this.serviceEndPoint="",this._queue=[],this.isWorking=!1,this.exArgs=null,this._counter=0},send:function(t,i){var r=this,n=this.delimiter,a=this.maxBufferLength,o=this.label,s=this.serviceEndPoint,d=this.callbackHandle,l=this.exArgs,u=this._timeout,c=0,f=0;this._result||(this._result=[]),i=i||this.ACTION_QUERY;var h=function(){var h=[],m=0;if(t&&t.length>0){r.isWorking=!0;var p=t.length;do{if(c=f+1,(f+=a)>p)f=p;else for(;n&&t.charAt(f)!=n&&p>=f;)f++;h.push({l:c,r:f}),m++}while(p>f);e.forEach(h,function(n,a){var c={url:s,action:i,timeout:u,callbackParamName:d,handle:function(t,i){if(++r._counter<=this.size&&!(t instanceof Error)&&t[o]&&e.isArray(t[o])){var n=this.offset;e.forEach(t[o],function(e){e.offset+=n}),r._result[this.number]=t[o]}r._counter==this.size&&(r._finalizeCollection(this.action),r.isWorking=!1,r._queue.length>0&&r._queue.shift()())}};c.content=l?e.mixin(l,{action:i,content:t.substring(n.l-1,n.r)}):{action:i,content:t.substring(n.l-1,n.r)},c.size=m,c.number=a,c.offset=n.l-1,e.io.script.get(c)})}};r.isWorking?r._queue.push(h):h()},_finalizeCollection:function(e){for(var t=this._result,i=t.length,r=0;i>r;r++){var n=t.shift();t=t.concat(n)}e==this.ACTION_QUERY&&this.onLoad(t),this._counter=0,this._result=[]},onLoad:function(e){},setWaitingTime:function(e){this._timeout=e*this.SEC}}),l=e.declare("dojox.editor.plugins.SpellCheck",[o],{url:"",bufferLength:100,interactive:!1,timeout:30,button:null,_editor:null,exArgs:null,_cursorSpan:'<span class="cursorPlaceHolder"></span>',_cursorSelector:"cursorPlaceHolder",_incorrectWordsSpan:"<span class='incorrectWordPlaceHolder'>${text}</span>",_ignoredIncorrectStyle:{cursor:"inherit",borderBottom:"none",backgroundColor:"transparent"},_normalIncorrectStyle:{cursor:"pointer",borderBottom:"1px dotted red",backgroundColor:"yellow"},_highlightedIncorrectStyle:{borderBottom:"1px dotted red",backgroundColor:"#b3b3ff"},_selector:"incorrectWordPlaceHolder",_maxItemNumber:3,constructor:function(){this._spanList=[],this._cache={},this._enabled=!0,this._iterator=0},setEditor:function(e){this._editor=e,this._initButton(),this._setNetwork(),this._connectUp()},_initButton:function(){var i=this,n=this._strings=e.i18n.getLocalization("dojox.editor.plugins","SpellCheck"),a=this._dialog=new t.TooltipDialog;a.set("content",this._dialogContent=new s({unfound:n.unfound,skip:n.skip,skipAll:n.skipAll,toDic:n.toDic,suggestions:n.suggestions,replaceWith:n.replaceWith,replace:n.replace,replaceAll:n.replaceAll,cancel:n.cancel})),this.button=new t.form.DropDownButton({label:n.widgetLabel,showLabel:!1,iconClass:"dijitEditorSpellCheckIcon",dropDown:a,id:t.getUniqueId(this.declaredClass.replace(/\./g,"_"))+"_dialogPane",closeDropDown:function(t){if(i._dialogContent.closable){if(i._dialogContent.isOpen=!1,e.isIE){var n=i._iterator,a=i._spanList;n<a.length&&n>=0&&e.style(a[n],i._normalIncorrectStyle)}this._opened&&(r.close(this.dropDown),t&&this.focus(),this._opened=!1,this.state="")}}}),i._dialogContent.isOpen=!1,a.domNode.setAttribute("aria-label",this._strings.widgetLabel)},_setNetwork:function(){var e=this.exArgs;if(!this._service){var t=this._service=new d;t.serviceEndPoint=this.url,t.maxBufferLength=this.bufferLength,t.setWaitingTime(this.timeout),e&&(delete e.name,delete e.url,delete e.interactive,delete e.timeout,t.exArgs=e)}},_connectUp:function(){var i=this._editor,r=this._dialogContent;this.connect(this.button,"set","_disabled"),this.connect(this._service,"onLoad","_loadData"),this.connect(this._dialog,"onOpen","_openDialog"),this.connect(i,"onKeyPress","_keyPress"),this.connect(i,"onLoad","_submitContent"),this.connect(r,"onSkip","_skip"),this.connect(r,"onSkipAll","_skipAll"),this.connect(r,"onAddToDic","_add"),this.connect(r,"onReplace","_replace"),this.connect(r,"onReplaceAll","_replaceAll"),this.connect(r,"onCancel","_cancel"),this.connect(r,"onEnter","_enter"),i.contentPostFilters.push(this._spellCheckFilter),e.publish(t._scopeName+".Editor.plugin.SpellCheck.getParser",[this]),!this.parser},_disabled:function(e,t){"disabled"==e&&(t?(this._iterator=0,this._spanList=[]):this.interactive&&!t&&this._service&&this._submitContent(!0),this._enabled=!t)},_keyPress:function(t){if(this.interactive){var i=118,r=86,n=t.charCode;t.altKey||n!=e.keys.SPACE?(t.ctrlKey&&(n==i||n==r)||!t.ctrlKey&&t.charCode)&&this._submitContent(!0):this._submitContent()}},_loadData:function(t){var i=this._cache,r=this._editor.get("value"),n=this._dialogContent;this._iterator=0,e.forEach(t,function(e){i[e.text]=e.suggestion,i[e.text].correct=!1}),this._enabled&&(n.closable=!1,this._markIncorrectWords(r,i),n.closable=!0,this._dialogContent.isOpen&&(this._iterator=-1,this._skip()))},_openDialog:function(){var e=this._dialogContent;e.ignoreChange=!0,e.set("unfoundWord",""),e.set("suggestionList",null),e.set("disabled",!0),e.set("inProgress",!0),e.isOpen=!0,e.closable=!1,this._submitContent(),e.closable=!0},_skip:function(t,i){var r=this._dialogContent,n=this._spanList||[],a=n.length,o=this._iterator;for(r.closable=!1,r.isChanged=!1,r.ignoreChange=!0,!i&&o>=0&&a>o&&this._skipWord(o);++o<a&&1==n[o].edited;);a>o?(this._iterator=o,this._populateDialog(o),this._selectWord(o)):(this._iterator=-1,r.set("unfoundWord",this._strings.msg),r.set("suggestionList",null),r.set("disabled",!0),r.set("inProgress",!1)),setTimeout(function(){e.isWebKit&&r.skipButton.focus(),r.focus(),r.ignoreChange=!1,r.closable=!0},0)},_skipAll:function(){this._dialogContent.closable=!1,this._skipWordAll(this._iterator),this._skip()},_add:function(){var e=this._dialogContent;e.closable=!1,e.isOpen=!0,this._addWord(this._iterator,e.get("unfoundWord")),this._skip()},_replace:function(){var e=this._dialogContent,t=this._iterator,i=e.get("selectedWord");e.closable=!1,this._replaceWord(t,i),this._skip(null,!0)},_replaceAll:function(){var e=this._dialogContent,t=this._spanList,i=t.length,r=t[this._iterator].innerHTML.toLowerCase(),n=e.get("selectedWord");e.closable=!1;for(var a=0;i>a;a++)t[a].innerHTML.toLowerCase()==r&&this._replaceWord(a,n);this._skip(null,!0)},_cancel:function(){this._dialogContent.closable=!0,this._editor.focus()},_enter:function(){this._dialogContent.isChanged?this._replace():this._skip()},_query:function(t){var i=this._service,r=this._cache,n=this.parser.parseIntoWords(this._html2Text(t))||[],a=[];e.forEach(n,function(e){e=e.toLowerCase(),r[e]||(r[e]=[],r[e].correct=!0,a.push(e))}),a.length>0?i.send(a.join(" ")):i.isWorking||this._loadData([])},_html2Text:function(e){for(var t=[],i=!1,r=e?e.length:0,n=0;r>n;n++)"<"==e.charAt(n)&&(i=!0),1==i?t.push(" "):t.push(e.charAt(n)),">"==e.charAt(n)&&(i=!1);return t.join("")},_getBookmark:function(e){var t=this._editor,i=this._cursorSpan;t.execCommand("inserthtml",i);for(var r=t.get("value"),n=r.indexOf(i),a=-1;++a<n&&e.charAt(a)==r.charAt(a););return a},_moveToBookmark:function(){var t=this._editor,i=e.query("."+this._cursorSelector,t.document),r=i&&i[0];if(r){t._sCall("selectElement",[r]),t._sCall("collapse",[!0]);var n=r.parentNode;n&&n.removeChild(r)}},_submitContent:function(e){if(e){var t=this,i=3e3;this._delayHandler&&(clearTimeout(this._delayHandler),this._delayHandler=null),setTimeout(function(){t._query(t._editor.get("value"))},i)}else this._query(this._editor.get("value"))},_populateDialog:function(e){var t=this._spanList,i=this._cache,r=this._dialogContent;if(r.set("disabled",!1),e<t.length&&t.length>0){var n=t[e].innerHTML;r.set("unfoundWord",n),r.set("suggestionList",i[n.toLowerCase()]),r.set("inProgress",!1)}},_markIncorrectWords:function(i,r){for(var n=this,a=this.parser,o=this._editor,s=this._incorrectWordsSpan,d=this._normalIncorrectStyle,l=this._selector,u=a.parseIntoWords(this._html2Text(i).toLowerCase()),c=a.getIndices(),f=this._cursorSpan,h=this._getBookmark(i),m="<span class='incorrectWordPlaceHolder'>".length,p=!1,y=i.split(""),v=null,g=u.length-1;g>=0;g--){var b=u[g];if(r[b]&&!r[b].correct){var M=c[g],w=u[g].length,_=M+w;if(h>=_&&!p&&(y.splice(h,0,f),p=!0),y.splice(M,w,e.string.substitute(s,{text:i.substring(M,_)})),h>M&&_>h&&!p){var k=y[M].split("");k.splice(m+h-M,0,f),y[M]=k.join(""),p=!0}}}p||(y.splice(h,0,f),p=!0),o.set("value",y.join("")),o._cursorToStart=!1,this._moveToBookmark(),v=this._spanList=e.query("."+this._selector,o.document),v.forEach(function(e,t){e.id=l+t}),this.interactive||delete d.cursor,v.style(d),this.interactive&&(n._contextMenu&&(n._contextMenu.uninitialize(),n._contextMenu=null),n._contextMenu=new t.Menu({targetNodeIds:[o.iframe],bindDomNode:function(i){i=e.byId(i);var a,s,d;"iframe"==i.tagName.toLowerCase()?(s=i,d=this._iframeContentWindow(s),a=e.body(o.document)):a=i==e.body()?e.doc.documentElement:i;var u={node:i,iframe:s};e.attr(i,"_dijitMenu"+this.id,this._bindings.push(u));var c=e.hitch(this,function(i){return[e.connect(i,this.leftClickToOpen?"onclick":"oncontextmenu",this,function(i){var a=i.target,d=n._strings;if(e.hasClass(a,l)&&!a.edited){e.stopEvent(i);var u=n._maxItemNumber,c=a.id,f=c.substring(l.length),h=r[a.innerHTML.toLowerCase()],m=h.length;if(this.destroyDescendants(),0==m)this.addChild(new t.MenuItem({label:d.iMsg,disabled:!0}));else for(var p=0;u>p&&m>p;p++)this.addChild(new t.MenuItem({label:h[p],onClick:function(){var e=f,t=h[p];return function(){n._replaceWord(e,t),o.focus()}}()}));this.addChild(new t.MenuSeparator),this.addChild(new t.MenuItem({label:d.iSkip,onClick:function(){n._skipWord(f),o.focus()}})),this.addChild(new t.MenuItem({label:d.iSkipAll,onClick:function(){n._skipWordAll(f),o.focus()}})),this.addChild(new t.MenuSeparator),this.addChild(new t.MenuItem({label:d.toDic,onClick:function(){n._addWord(f),o.focus()}})),this._scheduleOpen(a,s,{x:i.pageX,y:i.pageY})}}),e.connect(i,"onkeydown",this,function(t){t.shiftKey&&t.keyCode==e.keys.F10&&(e.stopEvent(t),this._scheduleOpen(t.target,s))})]});u.connects=a?c(a):[],s&&(u.onloadHandler=e.hitch(this,function(){var t=(this._iframeContentWindow(s),e.body(o.document));u.connects=c(t)}),s.addEventListener?s.addEventListener("load",u.onloadHandler,!1):s.attachEvent("onload",u.onloadHandler))}}))},_selectWord:function(t){var i=this._editor,r=this._spanList;t<r.length&&r.length>0&&(i._sCall("selectElement",[r[t]]),i._sCall("collapse",[!0]),this._findText(r[t].innerHTML,!1,!1),e.isIE&&e.style(r[t],this._highlightedIncorrectStyle))},_replaceWord:function(t,i){var r=this._spanList;r[t].innerHTML=i,e.style(r[t],this._ignoredIncorrectStyle),r[t].edited=!0},_skipWord:function(t){var i=this._spanList;e.style(i[t],this._ignoredIncorrectStyle),this._cache[i[t].innerHTML.toLowerCase()].correct=!0,i[t].edited=!0},_skipWordAll:function(e,t){var i=this._spanList,r=i.length;t=t||i[e].innerHTML.toLowerCase();for(var n=0;r>n;n++)i[n].edited||i[n].innerHTML.toLowerCase()!=t||this._skipWord(n)},_addWord:function(e,t){var i=this._service;i.send(t||this._spanList[e].innerHTML.toLowerCase(),i.ACTION_UPDATE),this._skipWordAll(e,t)},_findText:function(e,t,i){var r=this._editor,n=r.window,a=!1;if(e)if(n.find)a=n.find(e,t,i,!1,!1,!1,!1);else{var o=r.document;if(o.selection){this._editor.focus();var s=o.body.createTextRange(),d=o.selection?o.selection.createRange():null;d&&(i?s.setEndPoint("EndToStart",d):s.setEndPoint("StartToEnd",d));var l=t?4:0;i&&(l=1|l),a=s.findText(e,s.text.length,l),a&&s.select()}}return a},_spellCheckFilter:function(e){var t=/<span class=["']incorrectWordPlaceHolder["'].*?>(.*?)<\/span>/g;return e.replace(t,"$1")}});return l._SpellCheckControl=s,l._SpellCheckScriptMultiPart=d,e.subscribe(t._scopeName+".Editor.getPlugin",null,function(e){if(!e.plugin){var t=e.args.name.toLowerCase();"spellcheck"===t&&(e.plugin=new l({url:"url"in e.args?e.args.url:"",interactive:"interactive"in e.args?e.args.interactive:!1,bufferLength:"bufferLength"in e.args?e.args.bufferLength:100,timeout:"timeout"in e.args?e.args.timeout:30,exArgs:e.args}))}}),l});//# sourceMappingURL=SpellCheck.js.map