//>>built
define("dojox/editor/plugins/FindReplace",["dojo","dijit","dojox","dijit/_base/manager","dijit/_base/popup","dijit/_Widget","dijit/_TemplatedMixin","dijit/_KeyNavContainer","dijit/_WidgetsInTemplateMixin","dijit/TooltipDialog","dijit/Toolbar","dijit/form/CheckBox","dijit/form/_TextBoxMixin","dijit/form/TextBox","dijit/_editor/_Plugin","dijit/form/Button","dijit/form/DropDownButton","dijit/form/ToggleButton","./ToolbarLineBreak","dojo/_base/connect","dojo/_base/declare","dojo/i18n","dojo/string","dojo/i18n!dojox/editor/plugins/nls/FindReplace"],function(e,t,a,i,r,o,n,d,s,l,m,h,u,f,c){e.experimental("dojox.editor.plugins.FindReplace");var y=e.declare("dojox.editor.plugins._FindReplaceCloseBox",[o,n,s],{btnId:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='float: right' class='dijitInline' tabindex='-1'><button class='dijit dijitReset dijitInline' id='${btnId}' dojoAttachPoint='button' dojoType='dijit.form.Button' tabindex='-1' iconClass='dijitEditorIconsFindReplaceClose' showLabel='false'>X</button></span>",postMixInProperties:function(){this.id=t.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.btnId=this.id+"_close",this.inherited(arguments)},startup:function(){this.connect(this.button,"onClick","onClick")},onClick:function(){}}),p=e.declare("dojox.editor.plugins._FindReplaceTextBox",[o,n,s],{textId:"",label:"",toolTip:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='white-space: nowrap' class='dijit dijitReset dijitInline dijitEditorFindReplaceTextBox' title='${tooltip}' tabindex='-1'><label class='dijitLeft dijitInline' for='${textId}' tabindex='-1'>${label}</label><input dojoType='dijit.form.TextBox' intermediateChanges='true' class='focusTextBox' tabIndex='0' id='${textId}' dojoAttachPoint='textBox, focusNode' value='' dojoAttachEvent='onKeyPress: _onKeyPress'/></span>",postMixInProperties:function(){this.id=t.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.textId=this.id+"_text",this.inherited(arguments)},postCreate:function(){this.textBox.set("value",""),this.disabled=this.textBox.get("disabled"),this.connect(this.textBox,"onChange","onChange"),e.attr(this.textBox.textbox,"formnovalidate","true")},_setValueAttr:function(e){this.value=e,this.textBox.set("value",e)},focus:function(){this.textBox.focus()},_setDisabledAttr:function(e){this.disabled=e,this.textBox.set("disabled",e)},onChange:function(e){this.value=e},_onKeyPress:function(a){var i=0,r=0;!a.target||a.ctrlKey||a.altKey||a.shiftKey||(a.keyCode==e.keys.LEFT_ARROW?(i=a.target.selectionStart,r=a.target.selectionEnd,r>i&&(t.selectInputText(a.target,i,i),e.stopEvent(a))):a.keyCode==e.keys.RIGHT_ARROW&&(i=a.target.selectionStart,r=a.target.selectionEnd,r>i&&(t.selectInputText(a.target,r,r),e.stopEvent(a))))}}),v=e.declare("dojox.editor.plugins._FindReplaceCheckBox",[o,n,s],{checkId:"",label:"",tooltip:"",widget:null,widgetsInTemplate:!0,templateString:"<span style='white-space: nowrap' tabindex='-1' class='dijit dijitReset dijitInline dijitEditorFindReplaceCheckBox' title='${tooltip}' ><input dojoType='dijit.form.CheckBox' tabIndex='0' id='${checkId}' dojoAttachPoint='checkBox, focusNode' value=''/><label tabindex='-1' class='dijitLeft dijitInline' for='${checkId}'>${label}</label></span>",postMixInProperties:function(){this.id=t.getUniqueId(this.declaredClass.replace(/\./g,"_")),this.checkId=this.id+"_check",this.inherited(arguments)},postCreate:function(){this.checkBox.set("checked",!1),this.disabled=this.checkBox.get("disabled"),this.checkBox.isFocusable=function(){return!1}},_setValueAttr:function(e){this.checkBox.set("value",e)},_getValueAttr:function(){return this.checkBox.get("value")},focus:function(){this.checkBox.focus()},_setDisabledAttr:function(e){this.disabled=e,this.checkBox.set("disabled",e)}}),g=e.declare("dojox.editor.plugins._FindReplaceToolbar",m,{postCreate:function(){this.connectKeyNavHandlers([],[]),this.connect(this.containerNode,"onclick","_onToolbarEvent"),this.connect(this.containerNode,"onkeydown","_onToolbarEvent"),e.addClass(this.domNode,"dijitToolbar")},addChild:function(e,a){t._KeyNavContainer.superclass.addChild.apply(this,arguments)},_onToolbarEvent:function(e){e.stopPropagation()}}),M=e.declare("dojox.editor.plugins.FindReplace",[c],{buttonClass:t.form.ToggleButton,iconClassPrefix:"dijitEditorIconsFindReplace",editor:null,button:null,_frToolbar:null,_closeBox:null,_findField:null,_replaceField:null,_findButton:null,_replaceButton:null,_replaceAllButton:null,_caseSensitive:null,_backwards:null,_promDialog:null,_promDialogTimeout:null,_strings:null,_bookmark:null,_initButton:function(){this._strings=e.i18n.getLocalization("dojox.editor.plugins","FindReplace"),this.button=new t.form.ToggleButton({label:this._strings.findReplace,showLabel:!1,iconClass:this.iconClassPrefix+" dijitEditorIconFindString",tabIndex:"-1",onChange:e.hitch(this,"_toggleFindReplace")}),e.isOpera&&this.button.set("disabled",!0),this.connect(this.button,"set",e.hitch(this,function(e,t){"disabled"===e&&this._toggleFindReplace(!t&&this._displayed,!0,!0)}))},setEditor:function(e){this.editor=e,this._initButton()},toggle:function(){this.button.set("checked",!this.button.get("checked"))},_toggleFindReplace:function(t,a,i){var r=e.marginBox(this.editor.domNode);t&&!e.isOpera?(e.style(this._frToolbar.domNode,"display","block"),this._populateFindField(),a||(this._displayed=!0)):(e.style(this._frToolbar.domNode,"display","none"),a||(this._displayed=!1),i||this.editor.focus()),this.editor.resize({h:r.h})},_populateFindField:function(){var e=this.editor,a=(e.window,e._sCall("getSelectedText",[null]));this._findField&&this._findField.textBox&&(a&&this._findField.textBox.set("value",a),this._findField.textBox.focus(),t.selectInputText(this._findField.textBox.focusNode))},setToolbar:function(i){if(this.inherited(arguments),!e.isOpera){var r=this._frToolbar=new g;e.style(r.domNode,"display","none"),e.place(r.domNode,i.domNode,"after"),r.startup(),this._closeBox=new y,r.addChild(this._closeBox),this._findField=new p({label:this._strings.findLabel,tooltip:this._strings.findTooltip}),r.addChild(this._findField),this._replaceField=new p({label:this._strings.replaceLabel,tooltip:this._strings.replaceTooltip}),r.addChild(this._replaceField),r.addChild(new a.editor.plugins.ToolbarLineBreak),this._findButton=new t.form.Button({label:this._strings.findButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconFind"}),this._findButton.titleNode.title=this._strings.findButtonTooltip,r.addChild(this._findButton),this._replaceButton=new t.form.Button({label:this._strings.replaceButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconReplace"}),this._replaceButton.titleNode.title=this._strings.replaceButtonTooltip,r.addChild(this._replaceButton),this._replaceAllButton=new t.form.Button({label:this._strings.replaceAllButton,showLabel:!0,iconClass:this.iconClassPrefix+" dijitEditorIconReplaceAll"}),this._replaceAllButton.titleNode.title=this._strings.replaceAllButtonTooltip,r.addChild(this._replaceAllButton),this._caseSensitive=new v({label:this._strings.matchCase,tooltip:this._strings.matchCaseTooltip}),r.addChild(this._caseSensitive),this._backwards=new v({label:this._strings.backwards,tooltip:this._strings.backwardsTooltip}),r.addChild(this._backwards),this._findButton.set("disabled",!0),this._replaceButton.set("disabled",!0),this._replaceAllButton.set("disabled",!0),this.connect(this._findField,"onChange","_checkButtons"),this.connect(this._findField,"onKeyDown","_onFindKeyDown"),this.connect(this._replaceField,"onKeyDown","_onReplaceKeyDown"),this.connect(this._findButton,"onClick","_find"),this.connect(this._replaceButton,"onClick","_replace"),this.connect(this._replaceAllButton,"onClick","_replaceAll"),this.connect(this._closeBox,"onClick","toggle"),this._promDialog=new t.TooltipDialog,this._promDialog.startup(),this._promDialog.set("content","")}},_checkButtons:function(){var e=this._findField.get("value");e?(this._findButton.set("disabled",!1),this._replaceButton.set("disabled",!1),this._replaceAllButton.set("disabled",!1)):(this._findButton.set("disabled",!0),this._replaceButton.set("disabled",!0),this._replaceAllButton.set("disabled",!0))},_onFindKeyDown:function(t){t.keyCode==e.keys.ENTER&&(this._find(),e.stopEvent(t))},_onReplaceKeyDown:function(t){t.keyCode==e.keys.ENTER&&(this._replace()||this._replace(),e.stopEvent(t))},_find:function(a){var i=this._findField.get("value")||"";if(i){var r=this._caseSensitive.get("value"),o=this._backwards.get("value"),n=this._findText(i,r,o);return!n&&a&&(this._promDialog.set("content",e.string.substitute(this._strings.eofDialogText,{0:this._strings.eofDialogTextFind})),t.popup.open({popup:this._promDialog,around:this._findButton.domNode}),this._promDialogTimeout=setTimeout(e.hitch(this,function(){clearTimeout(this._promDialogTimeout),this._promDialogTimeout=null,t.popup.close(this._promDialog)}),3e3),setTimeout(e.hitch(this,function(){this.editor.focus()}),0)),n}return!1},_replace:function(a){var i=!1,r=this.editor;r.focus();var o=this._findField.get("value")||"",n=this._replaceField.get("value")||"";if(o){var d=this._caseSensitive.get("value"),s=this._backwards.get("value"),l=r._sCall("getSelectedText",[null]);e.isMoz&&(o=e.trim(o),l=e.trim(l));var m=this._filterRegexp(o,!d);return l&&m.test(l)&&(r.execCommand("inserthtml",n),i=!0,s&&(this._findText(n,d,s),r._sCall("collapse",[!0]))),!this._find(!1)&&a&&(this._promDialog.set("content",e.string.substitute(this._strings.eofDialogText,{0:this._strings.eofDialogTextReplace})),t.popup.open({popup:this._promDialog,around:this._replaceButton.domNode}),this._promDialogTimeout=setTimeout(e.hitch(this,function(){clearTimeout(this._promDialogTimeout),this._promDialogTimeout=null,t.popup.close(this._promDialog)}),3e3),setTimeout(e.hitch(this,function(){this.editor.focus()}),0)),i}return null},_replaceAll:function(a){var i=0,r=this._backwards.get("value");r?this.editor.placeCursorAtEnd():this.editor.placeCursorAtStart(),this._replace(!1)&&i++;var o=e.hitch(this,function(){this._replace(!1)?(i++,setTimeout(o,10)):a&&(this._promDialog.set("content",e.string.substitute(this._strings.replaceDialogText,{0:""+i})),t.popup.open({popup:this._promDialog,around:this._replaceAllButton.domNode}),this._promDialogTimeout=setTimeout(e.hitch(this,function(){clearTimeout(this._promDialogTimeout),this._promDialogTimeout=null,t.popup.close(this._promDialog)}),3e3),setTimeout(e.hitch(this,function(){this._findField.focus(),this._findField.textBox.focusNode.select()}),0))});o()},_findText:function(e,t,a){var i=this.editor,r=i.window,o=!1;if(e)if(r.find)o=r.find(e,t,a,!1,!1,!1,!1);else{var n=i.document;if(n.selection||r.getSelection){this.editor.focus();var d=n.body.createTextRange(),s=d.duplicate(),l=r.getSelection(),m=(l.getRangeAt(0),n.selection?n.selection.createRange():null);if(m)a?d.setEndPoint("EndToStart",m):d.setEndPoint("StartToEnd",m);else if(this._bookmark){var h=r.getSelection().toString();d.moveToBookmark(this._bookmark),d.text!=h?(d=s.duplicate(),this._bookmark=null):a?(s.setEndPoint("EndToStart",d),d=s.duplicate()):(s.setEndPoint("StartToEnd",d),d=s.duplicate())}var u=t?4:0;a&&(u=1|u),o=d.findText(e,d.text.length,u),o&&(d.select(),this._bookmark=d.getBookmark())}}return o},_filterRegexp:function(e,t){for(var a="",i=null,r=0;r<e.length;r++)switch(i=e.charAt(r)){case"\\":a+=i,r++,a+=e.charAt(r);break;case"$":case"^":case"/":case"+":case".":case"|":case"(":case")":case"{":case"}":case"[":case"]":a+="\\";default:a+=i}return a="^"+a+"$",t?new RegExp(a,"mi"):new RegExp(a,"m")},updateState:function(){this.button.set("disabled",this.get("disabled"))},destroy:function(){this.inherited(arguments),this._promDialogTimeout&&(clearTimeout(this._promDialogTimeout),this._promDialogTimeout=null,t.popup.close(this._promDialog)),this._frToolbar&&(this._frToolbar.destroyRecursive(),this._frToolbar=null),this._promDialog&&(this._promDialog.destroyRecursive(),this._promDialog=null)}});return M._FindReplaceCloseBox=y,M._FindReplaceTextBox=p,M._FindReplaceCheckBox=v,M._FindReplaceToolbar=g,e.subscribe(t._scopeName+".Editor.getPlugin",null,function(e){if(!e.plugin){var t=e.args.name.toLowerCase();"findreplace"===t&&(e.plugin=new M({}))}}),M});//# sourceMappingURL=FindReplace.js.map