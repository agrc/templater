//>>built
define("dojox/editor/plugins/LocalImage",["dojo","dijit","dijit/registry","dijit/_base/popup","dijit/_editor/_Plugin","dijit/_editor/plugins/LinkDialog","dijit/TooltipDialog","dijit/form/_TextBoxMixin","dijit/form/Button","dijit/form/ValidationTextBox","dijit/form/DropDownButton","dojo/_base/connect","dojo/_base/declare","dojo/_base/sniff","dojox/form/FileUploader","dojo/i18n!dojox/editor/plugins/nls/LocalImage"],function(e,t,i,a,r,n,o,s,d,l,h,u,c,m,f,y){var p=e.declare("dojox.editor.plugins.LocalImage",n.ImgLinkDialog,{uploadable:!1,uploadUrl:"",baseImageUrl:"",fileMask:"*.jpg;*.jpeg;*.gif;*.png;*.bmp",urlRegExp:"",htmlFieldName:"uploadedfile",_isLocalFile:!1,_messages:"",_cssPrefix:"dijitEditorEilDialog",_closable:!0,linkDialogTemplate:["<div style='border-bottom: 1px solid black; padding-bottom: 2pt; margin-bottom: 4pt;'></div>","<div class='dijitEditorEilDialogDescription'>${prePopuTextUrl}${prePopuTextBrowse}</div>","<table role='presentation'><tr><td colspan='2'>","<label for='${id}_urlInput' title='${prePopuTextUrl}${prePopuTextBrowse}'>${url}</label>","</td></tr><tr><td class='dijitEditorEilDialogField'>","<input dojoType='dijit.form.ValidationTextBox' class='dijitEditorEilDialogField'regExp='${urlRegExp}' title='${prePopuTextUrl}${prePopuTextBrowse}'  selectOnClick='true' required='true' id='${id}_urlInput' name='urlInput' intermediateChanges='true' invalidMessage='${invalidMessage}' prePopuText='&lt;${prePopuTextUrl}${prePopuTextBrowse}&gt'>","</td><td>","<div id='${id}_browse' style='display:${uploadable}'>${browse}</div>","</td></tr><tr><td colspan='2'>","<label for='${id}_textInput'>${text}</label>","</td></tr><tr><td>","<input dojoType='dijit.form.TextBox' required='false' id='${id}_textInput' name='textInput' intermediateChanges='true' selectOnClick='true' class='dijitEditorEilDialogField'>","</td><td></td></tr><tr><td>","</td><td>","</td></tr><tr><td colspan='2'>","<button dojoType='dijit.form.Button' id='${id}_setButton'>${set}</button>","</td></tr></table>"].join(""),_initButton:function(){var t=this;this._messages=y,this.tag="img";var r=this.dropDown=new o({title:y[this.command+"Title"],onOpen:function(){t._initialFileUploader(),t._onOpenDialog(),o.prototype.onOpen.apply(this,arguments),setTimeout(function(){s.selectInputText(t._urlInput.textbox),t._urlInput.isLoadComplete=!0},0)},onClose:function(){e.disconnect(t.blurHandler),t.blurHandler=null,this.onHide()},onCancel:function(){setTimeout(e.hitch(t,"_onCloseDialog"),0)}}),n=this.getLabel(this.command),d=this.iconClassPrefix+" "+this.iconClassPrefix+this.command.charAt(0).toUpperCase()+this.command.substr(1),u=e.mixin({label:n,showLabel:!1,iconClass:d,dropDown:this.dropDown,tabIndex:"-1"},this.params||{});m("ie")||(u.closeDropDown=function(e){t._closable&&this._opened&&(a.close(this.dropDown),e&&this.focus(),this._opened=!1,this.state=""),setTimeout(function(){t._closable=!0},10)}),this.button=new h(u);var c=this.fileMask.split(";"),f="";e.forEach(c,function(e){e=e.replace(/\./,"\\.").replace(/\*/g,".*"),f+="|"+e+"|"+e.toUpperCase()}),y.urlRegExp=this.urlRegExp=f.substring(1),this.uploadable||(y.prePopuTextBrowse="."),y.id=i.getUniqueId(this.editor.id),y.uploadable=this.uploadable?"inline":"none",this._uniqueId=y.id,this._setContent("<div class='"+this._cssPrefix+"Title'>"+r.title+"</div>"+e.string.substitute(this.linkDialogTemplate,y)),r.startup();var p=this._urlInput=i.byId(this._uniqueId+"_urlInput");if(this._textInput=i.byId(this._uniqueId+"_textInput"),this._setButton=i.byId(this._uniqueId+"_setButton"),p){var g=l.prototype;p=e.mixin(p,{isLoadComplete:!1,isValid:function(e){return this.isLoadComplete?g.isValid.apply(this,arguments):this.get("value").length>0},reset:function(){this.isLoadComplete=!1,g.reset.apply(this,arguments)}}),this.connect(p,"onKeyDown","_cancelFileUpload"),this.connect(p,"onChange","_checkAndFixInput")}this._setButton&&this.connect(this._setButton,"onClick","_checkAndSetValue"),this._connectTagEvents()},_initialFileUploader:function(){var e=null,t=this,i=t._uniqueId,a=i+"_browse",r=t._urlInput;t.uploadable&&!t._fileUploader&&(e=t._fileUploader=new f({force:"html",uploadUrl:t.uploadUrl,htmlFieldName:t.htmlFieldName,uploadOnChange:!1,selectMultipleFiles:!1,showProgress:!0},a),e.reset=function(){t._isLocalFile=!1,e._resetHTML()},t.connect(e,"onClick",function(){r.validate(!1),m("ie")||(t._closable=!1)}),t.connect(e,"onChange",function(e){t._isLocalFile=!0,r.set("value",e[0].name),r.focus()}),t.connect(e,"onComplete",function(e){var i=t.baseImageUrl;i=i&&"/"==i.charAt(i.length-1)?i:i+"/",r.set("value",i+e[0].file),t._isLocalFile=!1,t._setDialogStatus(!0),t.setValue(t.dropDown.get("value"))}),t.connect(e,"onError",function(e){t._setDialogStatus(!0)}))},_checkAndFixInput:function(){this._setButton.set("disabled",!this._isValid())},_isValid:function(){return this._urlInput.isValid()},_cancelFileUpload:function(){this._fileUploader.reset(),this._isLocalFile=!1},_checkAndSetValue:function(){this._fileUploader&&this._isLocalFile?(this._setDialogStatus(!1),this._fileUploader.upload()):this.setValue(this.dropDown.get("value"))},_setDialogStatus:function(e){this._urlInput.set("disabled",!e),this._textInput.set("disabled",!e),this._setButton.set("disabled",!e)},destroy:function(){this.inherited(arguments),this._fileUploader&&(this._fileUploader.destroy(),delete this._fileUploader)}}),g=function(e){return new p({command:"insertImage",uploadable:"uploadable"in e?e.uploadable:!1,uploadUrl:"uploadable"in e&&"uploadUrl"in e?e.uploadUrl:"",htmlFieldName:"uploadable"in e&&"htmlFieldName"in e?e.htmlFieldName:"uploadedfile",baseImageUrl:"uploadable"in e&&"baseImageUrl"in e?e.baseImageUrl:"",fileMask:"fileMask"in e?e.fileMask:"*.jpg;*.jpeg;*.gif;*.png;*.bmp"})};return r.registry.LocalImage=g,r.registry.localImage=g,r.registry.localimage=g,p});//# sourceMappingURL=LocalImage.js.map