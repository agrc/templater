//>>built
define("dojox/store/db/IndexedDB",["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","dojo/promise/all","dojo/store/util/SimpleQueryEngine","dojo/store/util/QueryResults"],function(e,t,i,a,o,n,r){function s(e){var t=new i;return e.onsuccess=function(e){t.resolve(e.target.result)},e.onerror=function(){e.error.message=e.webkitErrorMessage,t.reject(e.error)},t.promise}function l(e,t,i){if(m||c.length){if(e&&(c.push({cursor:e,priority:t,retry:i}),c.sort(function(e,t){return e.priority>t.priority?1:-1})),m>=u)return;var a=c.pop();e=a&&a.cursor}if(e)try{e.continue(),m++}catch(e){if("TransactionInactiveError"!==e.name&&0!==e.name||!a)throw e;a.retry()}}function d(){return!0}function h(e){function t(t,n){return a?t&&i.then(function(e){e.forEach(t,n)}):(t&&o.push(t),i||(i=e.filter(function(e){a=!0;for(var t=0,i=o.length;t<i;t++)o[t].call(n,e);return!0}))),i}var i,a,o=[];return{total:e.total,filter:function(e,i){var a;return t(function(t){a||(a=!e.call(i,t))})},forEach:t,map:function(e,i){var a=[];return t(function(t){a.push(e.call(i,t))}).then(function(){return a})},then:function(e,i){return t().then(e,i)}}}var c=[],u=1,m=0,f=/(.*)\*$/,p=window.IDBKeyRange||window.webkitIDBKeyRange;return e(null,{constructor:function(t){e.safeMixin(this,t);var i=this,a=this.dbConfig;this.indices=a.stores[this.storeName],this.cachedCount={};for(var o in i.indices){var n=i.indices[o];"number"==typeof n&&(i.indices[o]={preference:n})}if(this.db=this.db||a.db,!this.db){var r=a.openRequest;r||(r=a.openRequest=window.indexedDB.open(a.name||"dojo-db",parseInt(a.version,10)),r.onupgradeneeded=function(){var e=i.db=r.result;for(var t in a.stores){var o=a.stores[t];if(e.objectStoreNames.contains(t))s=r.transaction.objectStore(t);else var n=o.idProperty||"id",s=e.createObjectStore(t,{keyPath:n,autoIncrement:o[n]&&o[n].autoIncrement||!1});for(var l in o)s.indexNames.contains(l)||"autoIncrement"===l||!1===o[l].indexed||s.createIndex(l,l,o[l])}},a.available=s(r)),this.available=a.available.then(function(e){return i.db=e})}},idProperty:"id",storeName:"",indices:{},queryEngine:n,transaction:function(){var e=this;return this._currentTransaction=null,{abort:function(){e._currentTransaction.abort()},commit:function(){e._currentTransaction=null}}},_getTransaction:function(){if(!this._currentTransaction){this._currentTransaction=this.db.transaction([this.storeName],"readwrite");var e=this;this._currentTransaction.oncomplete=function(){e._currentTransaction=null},this._currentTransaction.onerror=function(e){}}return this._currentTransaction},_callOnStore:function(e,t,i,o){var n=this;return a(this.available,function a(){var r=n._currentTransaction;if(r)var l=!0;else r=n._getTransaction();var d,h;if(l)try{h=r.objectStore(n.storeName),i&&(h=h.index(i)),d=h[e].apply(h,t)}catch(e){if("TransactionInactiveError"===e.name||"InvalidStateError"===e.name)return n._currentTransaction=null,a();throw e}else h=r.objectStore(n.storeName),i&&(h=h.index(i)),d=h[e].apply(h,t);return o?d:s(d)})},get:function(e){return this._callOnStore("get",[e])},getIdentity:function(e){return e[this.idProperty]},put:function(e,t){return t=t||{},this.cachedCount={},this._callOnStore(!1===t.overwrite?"add":"put",[e])},add:function(e,t){return t=t||{},t.overwrite=!1,this.put(e,t)},remove:function(e){return this.cachedCount={},this._callOnStore("delete",[e])},query:function(e,n){function s(e,t,i){S++;var a=y.indices[e];if(a&&!1!==a.indexed&&(t=t||a.preference*(i||1)||.001)>C)return C=t,j=e,!0;S++}n=n||{};var c=n.start||0,u=n.count||1/0,g=n.sort,y=this;if(e.forEach){var v={sort:g},b=this.queryEngine({},v),_=[],k=0,M=0;return h({total:{then:function(){return o(_).then(function(e){return e.reduce(function(e,t){return e+t})*k/(M||1)}).then.apply(this,arguments)}},filter:function(t,i){var a,n=0,r=[],s={},l=[];return o(e.map(function(e,o){function d(e){h.push(e);for(var o=[],s=[];r.every(function(e){if(e.length>0){var t=e[0];return t&&s.push(t),o.push(t)}});){if(n>=c+u||0===s.length)return void(a=!0);var d=b(s)[0];if(r[o.indexOf(d)].shift(),n++>=c&&(l.push(d),!t.call(i,d)))return void(a=!0);o=[],s=[]}return!0}var h=r[o]=[],m=y.query(e,v);return _[o]=m.total,m.filter(function(e){if(!a){var t=y.getIdentity(e);return M++,t in s?!0:(k++,s[t]=!0,d(e))}}).then(function(e){return d(null),e})})).then(function(){return l})}})}var x,w,j,I,T=JSON.stringify(e)+"-"+JSON.stringify(n.sort),C=0,S=0;for(var E in e){I=e[E];var F,A=!1,z=null;if("boolean"!=typeof I){if(I)if(I.from||I.to)A=!0,function(e,t){z={test:function(i){return!e||e<=i&&(!t||t>=i)},keyRange:e?t?p.bound(e,t,I.excludeFrom,I.excludeTo):p.lowerBound(e,I.excludeFrom):p.upperBound(t,I.excludeTo)}}(I.from,I.to);else if("object"==typeof I&&I.contains)!function(e){var t,i=e[0],a=i&&i.match&&i.match(f);a?(i=a[1],t=p.bound(i,i+"~")):t=p.only(i),z={test:function(t){return e.every(function(e){var i=e&&e.match&&e.match(f);return i?(e=i[1],t&&t.some(function(t){return t.slice(0,e.length)===e})):t&&t.indexOf(e)>-1})},keyRange:t}}(I.contains);else if(F=I.match&&I.match(f)){var P=F[1];z=new RegExp("^"+P),z.keyRange=p.bound(P,P+"~")}z&&(e[E]=z),s(E,null,A?.1:1)}}var N;if(g){var B=g[0];if(B.attribute===j||s(B.attribute,1))N=B.descending;else{var L=!0;c=0,u=1/0}}var D;j?(j in e?(I=e[j],x=I&&I.keyRange?I.keyRange:p.only(I),j):x=null,D=[x,N?"prev":"next"]):D=[];var G=y.cachedPosition;G&&G.queryId===T&&G.offset<c&&S>1?(w=G.preFilterOffset+1,y.cachedPosition=G=t.mixin({},G)):(G=y.cachedPosition={offset:-1,preFilterOffset:-1,queryId:T},S<2&&(G.offset=G.preFilterOffset=(w=c)-1));var H=this.queryEngine(e),R={total:{then:function(e){function t(e){return y.cachedCount[T]=e,Math.round((G.offset+1.01)/(G.preFilterOffset+1.01)*e)}var i=y.cachedCount[T];if(i)return e(t(i));var a=x?y._callOnStore("count",[x],j):y._callOnStore("count");return(this.then=a.then(t)).then.apply(this,arguments)}},filter:function(e,t){function o(){a(y._callOnStore("openCursor",D,j,!0),function(i){m++,i.onsuccess=function(d){m--;var h=d.target.result;if(h){if(w)return h.advance(w),m++,void(w=!1);G.preFilterOffset++;try{var f=h.value;return n.join&&(f=n.join(f)),a(f,function(a){return H.matches(a)&&++G.offset>=c&&(s.push(a),!e.call(t,a)||G.offset>=c+u-1)?(i.lastCursor=h,r.resolve(s),void l()):l(h,n.priority,function(){w=G.preFilterOffset,o()})})}catch(e){r.reject(e)}}else r.resolve(s);l()},i.onerror=function(e){m--,r.reject(e),l()}})}var r=new i,s=[];return o(),r.promise}};if(L){var b=this.queryEngine({},n),O=t.delegate(R.filter(d).then(function(e){return b(e)}));return O.total=R.total,new r(O)}return n.rawResults?R:h(R)}})});//# sourceMappingURL=IndexedDB.js.map