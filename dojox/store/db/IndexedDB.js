//>>built
define("dojox/store/db/IndexedDB",["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","dojo/promise/all","dojo/store/util/SimpleQueryEngine","dojo/store/util/QueryResults"],function(e,t,i,a,n,o,r){function s(e){var t=new i;return e.onsuccess=function(e){t.resolve(e.target.result)},e.onerror=function(){e.error.message=e.webkitErrorMessage,t.reject(e.error)},t.promise}function d(e,t,i){if(m||u.length){if(e&&(u.push({cursor:e,priority:t,retry:i}),u.sort(function(e,t){return e.priority>t.priority?1:-1})),m>=c)return;var a=u.pop();e=a&&a.cursor}if(e)try{e["continue"](),m++}catch(n){if("TransactionInactiveError"!==n.name&&0!==n.name||!a)throw n;a.retry()}}function l(){return!0}function h(e){function t(t,o){return a?t&&i.then(function(e){e.forEach(t,o)}):(t&&n.push(t),i||(i=e.filter(function(e){a=!0;for(var t=0,i=n.length;i>t;t++)n[t].call(o,e);return!0}))),i}var i,a,n=[];return{total:e.total,filter:function(e,i){var a;return t(function(t){a||(a=!e.call(i,t))})},forEach:t,map:function(e,i){var a=[];return t(function(t){a.push(e.call(i,t))}).then(function(){return a})},then:function(e,i){return t().then(e,i)}}}var u=[],c=1,m=0,f=/(.*)\*$/,g=window.IDBKeyRange||window.webkitIDBKeyRange;return e(null,{constructor:function(t){e.safeMixin(this,t);var i=this,a=this.dbConfig;this.indices=a.stores[this.storeName],this.cachedCount={};for(var n in i.indices){var o=i.indices[n];"number"==typeof o&&(i.indices[n]={preference:o})}if(this.db=this.db||a.db,!this.db){var r=a.openRequest;r||(r=a.openRequest=window.indexedDB.open(a.name||"dojo-db",parseInt(a.version,10)),r.onupgradeneeded=function(){var e=i.db=r.result;for(var t in a.stores){var n=a.stores[t];if(e.objectStoreNames.contains(t))s=r.transaction.objectStore(t);else var o=n.idProperty||"id",s=e.createObjectStore(t,{keyPath:o,autoIncrement:n[o]&&n[o].autoIncrement||!1});for(var d in n)s.indexNames.contains(d)||"autoIncrement"===d||n[d].indexed===!1||s.createIndex(d,d,n[d])}},a.available=s(r)),this.available=a.available.then(function(e){return i.db=e})}},idProperty:"id",storeName:"",indices:{},queryEngine:o,transaction:function(){var e=this;return this._currentTransaction=null,{abort:function(){e._currentTransaction.abort()},commit:function(){e._currentTransaction=null}}},_getTransaction:function(){if(!this._currentTransaction){this._currentTransaction=this.db.transaction([this.storeName],"readwrite");var e=this;this._currentTransaction.oncomplete=function(){e._currentTransaction=null},this._currentTransaction.onerror=function(e){}}return this._currentTransaction},_callOnStore:function(e,t,i,n){var o=this;return a(this.available,function r(){var a=o._currentTransaction;if(a)var d=!0;else a=o._getTransaction();var l,h;if(d)try{h=a.objectStore(o.storeName),i&&(h=h.index(i)),l=h[e].apply(h,t)}catch(u){if("TransactionInactiveError"===u.name||"InvalidStateError"===u.name)return o._currentTransaction=null,r();throw u}else h=a.objectStore(o.storeName),i&&(h=h.index(i)),l=h[e].apply(h,t);return n?l:s(l)})},get:function(e){return this._callOnStore("get",[e])},getIdentity:function(e){return e[this.idProperty]},put:function(e,t){return t=t||{},this.cachedCount={},this._callOnStore(t.overwrite===!1?"add":"put",[e])},add:function(e,t){return t=t||{},t.overwrite=!1,this.put(e,t)},remove:function(e){return this.cachedCount={},this._callOnStore("delete",[e])},query:function(e,o){function s(e,t,i){F++;var a=v.indices[e];return a&&a.indexed!==!1&&(t=t||a.preference*(i||1)||.001,t>S)?(S=t,C=e,!0):void F++}o=o||{};var u=o.start||0,c=o.count||1/0,p=o.sort,v=this;if(e.forEach){var y={sort:p},b=this.queryEngine({},y),_=[],k=0,M=0;return h({total:{then:function(){return n(_).then(function(e){return e.reduce(function(e,t){return e+t})*k/(M||1)}).then.apply(this,arguments)}},filter:function(t,i){var a,o=0,r=[],s={},d=[];return n(e.map(function(e,n){function l(e){h.push(e);for(var n=[],s=[];r.every(function(e){if(e.length>0){var t=e[0];return t&&s.push(t),n.push(t)}});){if(o>=u+c||0===s.length)return void(a=!0);var l=b(s)[0];if(r[n.indexOf(l)].shift(),o++>=u&&(d.push(l),!t.call(i,l)))return void(a=!0);n=[],s=[]}return!0}var h=r[n]=[],m=v.query(e,y);return _[n]=m.total,m.filter(function(e){if(!a){var t=v.getIdentity(e);return M++,t in s?!0:(k++,s[t]=!0,l(e))}}).then(function(e){return l(null),e})})).then(function(){return d})}})}var x,w,j,C,T,I=JSON.stringify(e)+"-"+JSON.stringify(o.sort),S=0,F=0;for(var E in e){T=e[E];var N,A=!1,P=null;if("boolean"!=typeof T){if(T)if(T.from||T.to)A=!0,function(e,t){P={test:function(i){return!e||i>=e&&(!t||t>=i)},keyRange:e?t?g.bound(e,t,T.excludeFrom,T.excludeTo):g.lowerBound(e,T.excludeFrom):g.upperBound(t,T.excludeTo)}}(T.from,T.to);else if("object"==typeof T&&T.contains)!function(e){var t,i=e[0],a=i&&i.match&&i.match(f);a?(i=a[1],t=g.bound(i,i+"~")):t=g.only(i),P={test:function(t){return e.every(function(e){var i=e&&e.match&&e.match(f);return i?(e=i[1],t&&t.some(function(t){return t.slice(0,e.length)===e})):t&&t.indexOf(e)>-1})},keyRange:t}}(T.contains);else if(N=T.match&&T.match(f)){var D=N[1];P=new RegExp("^"+D),P.keyRange=g.bound(D,D+"~")}P&&(e[E]=P),s(E,null,A?.1:1)}}var z;if(p){var L=p[0];if(L.attribute===C||s(L.attribute,1))z=L.descending;else{var B=!0;u=0,c=1/0}}var R;C?(C in e?(T=e[C],x=T&&T.keyRange?T.keyRange:g.only(T),w=C):x=null,R=[x,z?"prev":"next"]):R=[];var G=v.cachedPosition;G&&G.queryId===I&&G.offset<u&&F>1?(j=G.preFilterOffset+1,v.cachedPosition=G=t.mixin({},G)):(G=v.cachedPosition={offset:-1,preFilterOffset:-1,queryId:I},2>F&&(G.offset=G.preFilterOffset=(j=u)-1));var O=this.queryEngine(e),H={total:{then:function(e){function t(e){return v.cachedCount[I]=e,Math.round((G.offset+1.01)/(G.preFilterOffset+1.01)*e)}var i=v.cachedCount[I];if(i)return e(t(i));var a=x?v._callOnStore("count",[x],C):v._callOnStore("count");return(this.then=a.then(t)).then.apply(this,arguments)}},filter:function(e,t){function n(){a(v._callOnStore("openCursor",R,C,!0),function(i){m++,i.onsuccess=function(l){m--;var h=l.target.result;if(h){if(j)return h.advance(j),m++,void(j=!1);G.preFilterOffset++;try{var f=h.value;return o.join&&(f=o.join(f)),a(f,function(a){return O.matches(a)&&(G.offset++,G.offset>=u&&(s.push(a),!e.call(t,a)||G.offset>=u+c-1))?(i.lastCursor=h,r.resolve(s),void d()):d(h,o.priority,function(){j=G.preFilterOffset,n()})})}catch(g){r.reject(g)}}else r.resolve(s);d()},i.onerror=function(e){m--,r.reject(e),d()}})}var r=new i,s=[];return n(),r.promise}};if(B){var b=this.queryEngine({},o),q=t.delegate(H.filter(l).then(function(e){return b(e)}));return q.total=H.total,new r(q)}return o.rawResults?H:h(H)}})});//# sourceMappingURL=IndexedDB.js.map