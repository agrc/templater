//>>built
define("dojox/store/db/SQL",["dojo/_base/declare","dojo/Deferred","dojo/when","dojo/store/util/QueryResults","dojo/_base/lang","dojo/promise/all"],function(e,t,i,a,o,n){function r(e){return e&&o.mixin(e,JSON.parse(e.__extra))}var s=/(.*)\*$/;return e([],{constructor:function(e){var t=e.dbConfig;this.database=openDatabase(e.dbName||"dojo-db","1.0","dojo-db",4194304);var i=this.indexPrefix=e.indexPrefix||"idx_",a=e.table||e.storeName;this.table=(e.table||e.storeName).replace(/[^\w]/g,"_");var o=[];this.indices=t.stores[a],this.repeatingIndices={};for(var r in this.indices)this.indices[r].multiEntry&&(this.repeatingIndices[r]=!0);if(!t.available){for(var a in t.stores){var s=t.stores[a],l=a.replace(/[^\w]/g,"_"),d=s[this.idProperty],h=["__extra",this.idProperty+" "+(d&&d.autoIncrement?"INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY")],u=[this.idProperty];for(var r in s)r!=this.idProperty&&h.push(r);o.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+l+" ("+h.join(",")+")"));for(var r in s)if(r!=this.idProperty)if(s[r].multiEntry){u.push(r);var c=l+"_repeating_"+r;o.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+c+" (id,value)")),o.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+c+"_id ON "+c+"(id)")),o.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+c+"_value ON "+c+"(value)"))}else o.push(this.executeSql("ALTER TABLE "+l+" ADD "+r).then(null,function(){})),!1!==s[r].indexed&&o.push(this.executeSql("CREATE INDEX IF NOT EXISTS "+i+l+"_"+r+" ON "+l+"("+r+")"))}t.available=n(o)}this.available=t.available},idProperty:"id",selectColumns:["*"],get:function(e){return i(this.executeSql("SELECT "+this.selectColumns.join(",")+" FROM "+this.table+" WHERE "+this.idProperty+"=?",[e]),function(e){return e.rows.length>0?r(e.rows.item(0)):void 0})},getIdentity:function(e){return e[this.idProperty]},remove:function(e){return this.executeSql("DELETE FROM "+this.table+" WHERE "+this.idProperty+"=?",[e])},identifyGeneratedKey:!0,add:function(e,t){var a=[],o=[],r=[],s={},l=[],d=this;for(var h in e)e.hasOwnProperty(h)&&(h in this.indices||h==this.idProperty?this.repeatingIndices[h]?l.push(function(t){var i=e[h];return n(i.map(function(e){return d.executeSql("INSERT INTO "+d.table+"_repeating_"+h+" (value, id) VALUES (?, ?)",[e,t])}))}):(r.push(h),o.push("?"),a.push(e[h])):s[h]=e[h]);r.push("__extra"),o.push("?"),a.push(JSON.stringify(s));var u=this.idProperty;this.identifyGeneratedKey&&(a.idColumn=u);var c="INSERT INTO "+this.table+" ("+r.join(",")+") VALUES ("+o.join(",")+")";return i(this.executeSql(c,a),function(t){var i=t.insertId;return e[u]=i,n(l.map(function(e){return e(i)})).then(function(){return i})})},put:function(e,t){t=t||{};var a=t.id||e[this.idProperty],o=t.overwrite;if(void 0===o){var n=this;return this.get(a).then(function(i){return(t.overwrite=!!i)?(t.overwrite=!0,n.put(e,t)):n.add(e,t)})}if(!o)return n.add(e,t);var r="UPDATE "+this.table+" SET ",s=[],l=[],d={};for(var h in e)if(e.hasOwnProperty(h))if(h in this.indices||h==this.idProperty)if(this.repeatingIndices[h]){this.executeSql("DELETE FROM "+this.table+"_repeating_"+h+" WHERE id=?",[a]);for(var u=e[h],c=0;c<u.length;c++)this.executeSql("INSERT INTO "+this.table+"_repeating_"+h+" (value, id) VALUES (?, ?)",[u[c],a])}else l.push(h+"=?"),s.push(e[h]);else d[h]=e[h];return l.push("__extra=?"),s.push(JSON.stringify(d)),r+=l.join(",")+" WHERE "+this.idProperty+"=?",s.push(e[this.idProperty]),i(this.executeSql(r,s),function(e){return a})},query:function(e,t){function i(e){function t(e){var t=e&&e.match&&e.match(s);return t?(u.push(t[1]+"%")," LIKE ?"):(u.push(e),"=?")}var i=[];for(var a in e){var o=e[a];if(o){if(o.contains){var n=d.table+"_repeating_"+a;i.push(o.contains.map(function(e){return d.idProperty+" IN (SELECT id FROM "+n+" WHERE value"+t(e)+")"}).join(" AND "));continue}if("object"==typeof o&&("from"in o||"to"in o)){var r=o.excludeFrom?">":">=",l=o.excludeTo?"<":"<=";"from"in o?(u.push(o.from),"to"in o?(u.push(o.to),i.push("("+h+"."+a+r+"? AND "+h+"."+a+l+"?)")):i.push(h+"."+a+r+"?")):(u.push(o.to),i.push(h+"."+a+l+"?"));continue}}i.push(h+"."+a+t(o))}return i.join(" AND ")}t=t||{};var n,l="FROM "+this.table,d=this,h=this.table,u=[];e.forEach?(n=e.map(i).join(") OR ("))&&(n="("+n+")"):n=i(e),n&&(n=" WHERE "+n),t.sort&&(n+=" ORDER BY "+t.sort.map(function(e){return h+"."+e.attribute+" "+(e.descending?"desc":"asc")}));var c=n;t.count&&(c+=" LIMIT "+t.count),t.start&&(c+=" OFFSET "+t.start);var m=o.delegate(this.executeSql("SELECT * "+l+c,u).then(function(e){for(var t=[],i=0;i<e.rows.length;i++)t.push(r(e.rows.item(i)));return t})),d=this;return m.total={then:function(e,t){return d.executeSql("SELECT COUNT(*) "+l+n,u).then(function(e){return e.rows.item(0)["COUNT(*)"]}).then(e,t)}},new a(m)},executeSql:function(e,i){var a,o,n=new t;if(this.database.transaction(function(t){t.executeSql(e,i,function(e,t){n.resolve(a=t)},function(e,t){n.reject(o=t)})}),a)return a;if(o)throw o;return n.promise}})});//# sourceMappingURL=SQL.js.map