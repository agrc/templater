//>>built
define("dojox/store/db/SQL",["dojo/_base/declare","dojo/Deferred","dojo/when","dojo/store/util/QueryResults","dojo/_base/lang","dojo/promise/all"],function(e,t,i,a,r,o){function n(e){return e&&r.mixin(e,JSON.parse(e.__extra))}var s=/(.*)\*$/;return e([],{constructor:function(e){var t=e.dbConfig;this.database=openDatabase(e.dbName||"dojo-db","1.0","dojo-db",4194304);var i=this.indexPrefix=e.indexPrefix||"idx_",a=e.table||e.storeName;this.table=(e.table||e.storeName).replace(/[^\w]/g,"_");var r=[];this.indices=t.stores[a],this.repeatingIndices={};for(var n in this.indices)this.indices[n].multiEntry&&(this.repeatingIndices[n]=!0);if(!t.available){for(var a in t.stores){var s=t.stores[a],l=a.replace(/[^\w]/g,"_"),d=s[this.idProperty],u=["__extra",this.idProperty+" "+(d&&d.autoIncrement?"INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY")],c=[this.idProperty];for(var n in s)n!=this.idProperty&&u.push(n);r.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+l+" ("+u.join(",")+")"));for(var n in s)if(n!=this.idProperty)if(s[n].multiEntry){c.push(n);var h=l+"_repeating_"+n;r.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+h+" (id,value)")),r.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+h+"_id ON "+h+"(id)")),r.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+h+"_value ON "+h+"(value)"))}else r.push(this.executeSql("ALTER TABLE "+l+" ADD "+n).then(null,function(){})),s[n].indexed!==!1&&r.push(this.executeSql("CREATE INDEX IF NOT EXISTS "+i+l+"_"+n+" ON "+l+"("+n+")"))}t.available=o(r)}this.available=t.available},idProperty:"id",selectColumns:["*"],get:function(e){return i(this.executeSql("SELECT "+this.selectColumns.join(",")+" FROM "+this.table+" WHERE "+this.idProperty+"=?",[e]),function(e){return e.rows.length>0?n(e.rows.item(0)):void 0})},getIdentity:function(e){return e[this.idProperty]},remove:function(e){return this.executeSql("DELETE FROM "+this.table+" WHERE "+this.idProperty+"=?",[e])},identifyGeneratedKey:!0,add:function(e,t){var a=[],r=[],n=[],s={},l=[],d=this;for(var u in e)e.hasOwnProperty(u)&&(u in this.indices||u==this.idProperty?this.repeatingIndices[u]?l.push(function(t){var i=e[u];return o(i.map(function(e){return d.executeSql("INSERT INTO "+d.table+"_repeating_"+u+" (value, id) VALUES (?, ?)",[e,t])}))}):(n.push(u),r.push("?"),a.push(e[u])):s[u]=e[u]);n.push("__extra"),r.push("?"),a.push(JSON.stringify(s));var c=this.idProperty;this.identifyGeneratedKey&&(a.idColumn=c);var h="INSERT INTO "+this.table+" ("+n.join(",")+") VALUES ("+r.join(",")+")";return i(this.executeSql(h,a),function(t){var i=t.insertId;return e[c]=i,o(l.map(function(e){return e(i)})).then(function(){return i})})},put:function(e,t){t=t||{};var a=t.id||e[this.idProperty],r=t.overwrite;if(void 0===r){var o=this;return this.get(a).then(function(i){return(t.overwrite=!!i)?(t.overwrite=!0,o.put(e,t)):o.add(e,t)})}if(!r)return o.add(e,t);var n="UPDATE "+this.table+" SET ",s=[],l=[],d={};for(var u in e)if(e.hasOwnProperty(u))if(u in this.indices||u==this.idProperty)if(this.repeatingIndices[u]){this.executeSql("DELETE FROM "+this.table+"_repeating_"+u+" WHERE id=?",[a]);for(var c=e[u],h=0;h<c.length;h++)this.executeSql("INSERT INTO "+this.table+"_repeating_"+u+" (value, id) VALUES (?, ?)",[c[h],a])}else l.push(u+"=?"),s.push(e[u]);else d[u]=e[u];return l.push("__extra=?"),s.push(JSON.stringify(d)),n+=l.join(",")+" WHERE "+this.idProperty+"=?",s.push(e[this.idProperty]),i(this.executeSql(n,s),function(e){return a})},query:function(e,t){function i(e){function t(e){var t=e&&e.match&&e.match(s);return t?(c.push(t[1]+"%")," LIKE ?"):(c.push(e),"=?")}var i=[];for(var a in e){var r=e[a];if(r){if(r.contains){var o=d.table+"_repeating_"+a;i.push(r.contains.map(function(e){return d.idProperty+" IN (SELECT id FROM "+o+" WHERE value"+t(e)+")"}).join(" AND "));continue}if("object"==typeof r&&("from"in r||"to"in r)){var n=r.excludeFrom?">":">=",l=r.excludeTo?"<":"<=";"from"in r?(c.push(r.from),"to"in r?(c.push(r.to),i.push("("+u+"."+a+n+"? AND "+u+"."+a+l+"?)")):i.push(u+"."+a+n+"?")):(c.push(r.to),i.push(u+"."+a+l+"?"));continue}}i.push(u+"."+a+t(r))}return i.join(" AND ")}t=t||{};var o,l="FROM "+this.table,d=this,u=this.table,c=[];e.forEach?(o=e.map(i).join(") OR ("),o&&(o="("+o+")")):o=i(e),o&&(o=" WHERE "+o),t.sort&&(o+=" ORDER BY "+t.sort.map(function(e){return u+"."+e.attribute+" "+(e.descending?"desc":"asc")}));var h=o;t.count&&(h+=" LIMIT "+t.count),t.start&&(h+=" OFFSET "+t.start);var m=r.delegate(this.executeSql("SELECT * "+l+h,c).then(function(e){for(var t=[],i=0;i<e.rows.length;i++)t.push(n(e.rows.item(i)));return t})),d=this;return m.total={then:function(e,t){return d.executeSql("SELECT COUNT(*) "+l+o,c).then(function(e){return e.rows.item(0)["COUNT(*)"]}).then(e,t)}},new a(m)},executeSql:function(e,i){var a,r,o=new t;if(this.database.transaction(function(t){t.executeSql(e,i,function(e,t){o.resolve(a=t)},function(e,t){o.reject(r=t)})}),a)return a;if(r)throw r;return o.promise}})});//# sourceMappingURL=SQL.js.map