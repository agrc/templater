//>>built
define("dojox/store/db/SQL",["dojo/_base/declare","dojo/Deferred","dojo/when","dojo/store/util/QueryResults","dojo/_base/lang","dojo/promise/all"],function(e,t,i,a,o,r){function n(e){return e&&o.mixin(e,JSON.parse(e.__extra))}var s=/(.*)\*$/;return e([],{constructor:function(e){var t=e.dbConfig;this.database=openDatabase(e.dbName||"dojo-db","1.0","dojo-db",4194304);var i=this.indexPrefix=e.indexPrefix||"idx_",a=e.table||e.storeName;this.table=(e.table||e.storeName).replace(/[^\w]/g,"_");var o=[];this.indices=t.stores[a],this.repeatingIndices={};for(var n in this.indices)this.indices[n].multiEntry&&(this.repeatingIndices[n]=!0);if(!t.available){for(var a in t.stores){var s=t.stores[a],d=a.replace(/[^\w]/g,"_"),l=s[this.idProperty],h=["__extra",this.idProperty+" "+(l&&l.autoIncrement?"INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY")],c=[this.idProperty];for(var n in s)n!=this.idProperty&&h.push(n);o.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+d+" ("+h.join(",")+")"));for(var n in s)if(n!=this.idProperty)if(s[n].multiEntry){c.push(n);var u=d+"_repeating_"+n;o.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+u+" (id,value)")),o.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+u+"_id ON "+u+"(id)")),o.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+u+"_value ON "+u+"(value)"))}else o.push(this.executeSql("ALTER TABLE "+d+" ADD "+n).then(null,function(){})),s[n].indexed!==!1&&o.push(this.executeSql("CREATE INDEX IF NOT EXISTS "+i+d+"_"+n+" ON "+d+"("+n+")"))}t.available=r(o)}this.available=t.available},idProperty:"id",selectColumns:["*"],get:function(e){return i(this.executeSql("SELECT "+this.selectColumns.join(",")+" FROM "+this.table+" WHERE "+this.idProperty+"=?",[e]),function(e){return e.rows.length>0?n(e.rows.item(0)):void 0})},getIdentity:function(e){return e[this.idProperty]},remove:function(e){return this.executeSql("DELETE FROM "+this.table+" WHERE "+this.idProperty+"=?",[e])},identifyGeneratedKey:!0,add:function(e,t){var a=[],o=[],n=[],s={},d=[],l=this;for(var h in e)e.hasOwnProperty(h)&&(h in this.indices||h==this.idProperty?this.repeatingIndices[h]?d.push(function(t){var i=e[h];return r(i.map(function(e){return l.executeSql("INSERT INTO "+l.table+"_repeating_"+h+" (value, id) VALUES (?, ?)",[e,t])}))}):(n.push(h),o.push("?"),a.push(e[h])):s[h]=e[h]);n.push("__extra"),o.push("?"),a.push(JSON.stringify(s));var c=this.idProperty;this.identifyGeneratedKey&&(a.idColumn=c);var u="INSERT INTO "+this.table+" ("+n.join(",")+") VALUES ("+o.join(",")+")";return i(this.executeSql(u,a),function(t){var i=t.insertId;return e[c]=i,r(d.map(function(e){return e(i)})).then(function(){return i})})},put:function(e,t){t=t||{};var a=t.id||e[this.idProperty],o=t.overwrite;if(void 0===o){var r=this;return this.get(a).then(function(i){return(t.overwrite=!!i)?(t.overwrite=!0,r.put(e,t)):r.add(e,t)})}if(!o)return r.add(e,t);var n="UPDATE "+this.table+" SET ",s=[],d=[],l={};for(var h in e)if(e.hasOwnProperty(h))if(h in this.indices||h==this.idProperty)if(this.repeatingIndices[h]){this.executeSql("DELETE FROM "+this.table+"_repeating_"+h+" WHERE id=?",[a]);for(var c=e[h],u=0;u<c.length;u++)this.executeSql("INSERT INTO "+this.table+"_repeating_"+h+" (value, id) VALUES (?, ?)",[c[u],a])}else d.push(h+"=?"),s.push(e[h]);else l[h]=e[h];return d.push("__extra=?"),s.push(JSON.stringify(l)),n+=d.join(",")+" WHERE "+this.idProperty+"=?",s.push(e[this.idProperty]),i(this.executeSql(n,s),function(e){return a})},query:function(e,t){function i(e){function t(e){var t=e&&e.match&&e.match(s);return t?(c.push(t[1]+"%")," LIKE ?"):(c.push(e),"=?")}var i=[];for(var a in e){var o=e[a];if(o){if(o.contains){var r=l.table+"_repeating_"+a;i.push(o.contains.map(function(e){return l.idProperty+" IN (SELECT id FROM "+r+" WHERE value"+t(e)+")"}).join(" AND "));continue}if("object"==typeof o&&("from"in o||"to"in o)){var n=o.excludeFrom?">":">=",d=o.excludeTo?"<":"<=";"from"in o?(c.push(o.from),"to"in o?(c.push(o.to),i.push("("+h+"."+a+n+"? AND "+h+"."+a+d+"?)")):i.push(h+"."+a+n+"?")):(c.push(o.to),i.push(h+"."+a+d+"?"));continue}}i.push(h+"."+a+t(o))}return i.join(" AND ")}t=t||{};var r,d="FROM "+this.table,l=this,h=this.table,c=[];e.forEach?(r=e.map(i).join(") OR ("),r&&(r="("+r+")")):r=i(e),r&&(r=" WHERE "+r),t.sort&&(r+=" ORDER BY "+t.sort.map(function(e){return h+"."+e.attribute+" "+(e.descending?"desc":"asc")}));var u=r;t.count&&(u+=" LIMIT "+t.count),t.start&&(u+=" OFFSET "+t.start);var m=o.delegate(this.executeSql("SELECT * "+d+u,c).then(function(e){for(var t=[],i=0;i<e.rows.length;i++)t.push(n(e.rows.item(i)));return t})),l=this;return m.total={then:function(e,t){return l.executeSql("SELECT COUNT(*) "+d+r,c).then(function(e){return e.rows.item(0)["COUNT(*)"]}).then(e,t)}},new a(m)},executeSql:function(e,i){var a,o,r=new t;if(this.database.transaction(function(t){t.executeSql(e,i,function(e,t){r.resolve(a=t)},function(e,t){r.reject(o=t)})}),a)return a;if(o)throw o;return r.promise}})});//# sourceMappingURL=SQL.js.map