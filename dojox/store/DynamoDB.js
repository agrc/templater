//>>built
define("dojox/store/DynamoDB",["dojo/_base/declare","dojo/Stateful","dojo/request","dojo/store/util/QueryResults","dojo/store/util/SimpleQueryEngine","dojo/_base/lang","dojo/_base/array","dojo/errors/RequestError","dojo/Deferred","../encoding/digests/SHA256","../encoding/digests/_base","require"],function(e,t,i,a,r,n,o,s,l,d,h,u){function c(e,t,i){return i=i||h.outputTypes.String,d._hmac(t,e,i)}function m(e,t,i){return this._signingDate=e,c(c(c(c("AWS4"+t,e),i),"dynamodb"),"aws4_request")}function f(e){function t(e){return e=String(e),1===e.length?"0"+e:e}return String(e.getUTCFullYear())+t(e.getUTCMonth()+1)+t(e.getUTCDate())+"T"+t(e.getUTCHours())+t(e.getUTCMinutes())+t(e.getUTCSeconds())+"Z"}function g(e){if("undefined"!=typeof document){var t=document.createElement("a");return t.href=e,t.hostname}return e=u.parse(e),e.hostname}function p(e){if(null==e)return"NULL";var t=typeof e;return"string"===t?"S":"boolean"===t?"BOOL":"number"===t?"N":e instanceof Array?"L":"M"}function y(e){var t,i=p(e),a={};switch(i){case"BOOL":case"S":t=e;break;case"N":t=String(e);break;case"NULL":t=!0;break;case"M":t={};for(var r in e)t[r]=y(e[r]);break;case"L":t=[];for(var n=0;n<e.length;n++)t[n]=y(e[n]);break;default:throw new Error("Unknown Dynamo type: "+i)}return a[i]=t,a}function v(e){function t(e){if("N"===i)return Number(e);if("NULL"===i)return null;if("L"===i)return o.map(e,function(e){return v(e)});if("M"===i){var t={};for(var a in e)t[a]=v(e[a]);return t}return e}var i,a;for(i in e)a=e[i];return"S"===i.charAt(1)?(i=i.charAt(0),o.map(a,t)):t(a)}function b(e){var t={};for(var i in e)t[i]=y(e[i]);return t}function k(e){if(!e)return null;var t={};for(var i in e)t[i]=v(e[i]);return t}return e(t,{tableName:"",attributesToGet:null,consistentRead:!1,maxRetries:5,idProperty:"id",queryEngine:r,region:null,endpointUrl:null,credentials:null,_signRequest:function(e,t){t=f(t||new Date);var i=t.slice(0,8),a=this.credentials.SecretAccessKey,r=this.credentials.AccessKeyId,n=this.credentials.SessionToken,o="",s="";e.headers["x-amz-date"]=t,n&&(o="x-amz-security-token:"+n+"\n",s=";x-amz-security-token",e.headers["x-amz-security-token"]=n);var l=e.method+"\n/\n\nhost:"+e.host+"\nx-amz-date:"+t+"\n"+o+"x-amz-target:"+e.headers["x-amz-target"]+"\n\nhost;x-amz-date"+s+";x-amz-target\n"+d(e.body,h.outputTypes.Hex),u=m(i,a,this.region),g="AWS4-HMAC-SHA256\n"+t+"\n"+i+"/"+this.region+"/dynamodb/aws4_request\n"+d(l,h.outputTypes.Hex),p=c(u,g,h.outputTypes.Hex);e.headers.authorization="AWS4-HMAC-SHA256 Credential="+r+"/"+i+"/"+this.region+"/dynamodb/aws4_request,SignedHeaders=host;x-amz-date;x-amz-target"+s+",Signature="+p},_rpc:function(e,t){var a,r,o=new l(function(){r&&r.cancel.apply(i,arguments),clearTimeout(a)}),d={"Content-Type":"application/x-amz-json-1.0","x-amz-target":"DynamoDB_20120810."+e};t.TableName=this.tableName,t=JSON.stringify(t),this.endpointUrl||(this.endpointUrl="https://dynamodb."+this.region+".amazonaws.com"),this.credentials&&this._signRequest({body:t,host:g(this.endpointUrl),method:"POST",headers:d});var h=this.endpointUrl,u=this.maxRetries,c=0;return function e(){r=i.post(h,{data:t,headers:d,handleAs:"json"}).then(n.hitch(o,"resolve"),function(t){var i=t.response;if(++c===u)return void o.reject(t);i.status>=500||i.status<400||400===i.status&&i.data&&i.data.__type&&(i.data.__type.indexOf("#ProvisionedThroughputExceededException")>-1||i.data.__type.indexOf("#ThrottlingException")>-1)?a=setTimeout(e,50*Math.pow(2,c)):o.reject(t)})}(),o.promise.then(function(e){return e},function(e){var t=e.response&&e.response.data;if(t)throw new s(t.__type+": "+t.message,e.response);throw e})},_getKeyFromId:function(e){var t={};return this.idProperty instanceof Array?("string"==typeof e&&(e=o.map(e.split("/"),function(e){var t=e.charAt(0);return e=e.slice(1),"N"===t&&(e=+e),e})),o.forEach(e,function(e,i){t[this.idProperty[i]]=y(e)},this)):t[this.idProperty]=y(e),t},get:function(e){var t={Key:this._getKeyFromId(e),ConsistentRead:this.consistentRead};return this.attributesToGet&&(t.AttributesToGet=this.attributesToGet),this._rpc("GetItem",t).then(function(e){return k(e.Item)})},getIdentity:function(e){return this.idProperty instanceof Array?o.map(this.idProperty,function(t){return p(e[t])+e[t]}).join("/"):e[this.idProperty]},query:function(e,t){function i(e){var t={};for(var i in e)t[i]=y(e[i]);return t}t=t||{};var r={KeyConditions:{},ConsistentRead:this.consistentRead};if(this.attributesToGet&&(r.AttributesToGet=this.attributesToGet),t.indexName&&(r.IndexName=t.indexName),t.sort&&t.sort.length){if(t.sort.length>1)throw new Error("Cannot sort by more than one dimension");r.IndexName||(r.IndexName=t.sort[0].attribute),r.ScanIndexForward=!t.sort[0].descending}for(var s in e){var d=e[s];r.KeyConditions[s]={AttributeValueList:d instanceof Array?o.map(d,y):[y(d)],ComparisonOperator:"EQ"}}if(t.filter){var h=t.filter;r.FilterExpression=h.FilterExpression,h.ExpressionAttributeValues&&(r.ExpressionAttributeValues=i(h.ExpressionAttributeValues)),h.ExpressionAttributeNames&&(r.ExpressionAttributeNames=h.ExpressionAttributeNames)}var u=new l(function(){m&&m.cancel.apply(m,arguments)}),c=a(u.promise);!1!==t.fetchTotal&&(c.total=this._rpc("Query",n.mixin({},r,{Select:"COUNT"})).then(function(e){return e.Count}));var m,f=this,g=[],p="number"==typeof t.start?t.start:0,v=p+(t.count||0)||1/0;return function e(t){r.Limit=v<1/0?v:void 0,r.ExclusiveStartKey=t,m=f._rpc("Query",r).then(function(t){if(t.Items.length){var i=o.map(t.Items.slice(p),k);p>0&&(p=Math.max(p-i.length,0)),v-=i.length,g=g.concat(i)}v>0&&t.LastEvaluatedKey?e(t.LastEvaluatedKey):u.resolve(g)},n.hitch(u,"reject"))}("object"==typeof t.start?b(t.start):void 0),c},remove:function(e,t){t=t||{};var i={Key:this._getKeyFromId(e),ReturnValues:"ALL_OLD"};if(t.expected){i.Expected={};for(var a in t.expected)i.Expected[a]={Value:y(t.expected[a])}}return this._rpc("DeleteItem",i).then(function(e){return k(e.Attributes)})},put:function(e,t){t=t||{};var i={Item:b(e)};if(t.id&&n.mixin(i.Item,this._getKeyFromId(t.id)),!1===t.overwrite){i.Expected={};var a=this.idProperty instanceof Array?this.idProperty:[this.idProperty];o.forEach(a,function(e){i.Expected[e]={Exists:!1}})}else if(t.expected){i.Expected={};for(var r in t.expected)i.Expected[r]={Value:y(t.expected[r])}}return this._rpc("PutItem",i).then(function(){})},add:function(e,t){return t=t||{},t.overwrite=!1,this.put(e,t)}})});//# sourceMappingURL=DynamoDB.js.map