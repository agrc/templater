//>>built
define("dojox/xmpp/TransportSession",["dojo","dijit","dojox","dojo/require!dojox/xmpp/bosh,dojox/xmpp/util,dojox/data/dom"],function(e,t,i){e.provide("dojox.xmpp.TransportSession"),e.require("dojox.xmpp.bosh"),e.require("dojox.xmpp.util"),e.require("dojox.data.dom"),i.xmpp.TransportSession=function(t){this.sendTimeout=1e3*(this.wait+20),t&&e.isObject(t)&&(e.mixin(this,t),this.useScriptSrcTransport&&(this.transportIframes=[]))},e.extend(i.xmpp.TransportSession,{rid:0,hold:1,polling:1e3,secure:!1,wait:60,lang:"en",submitContentType:"text/xml; charset=utf=8",serviceUrl:"/httpbind",defaultResource:"dojoIm",domain:"imserver.com",sendTimeout:0,useScriptSrcTransport:!1,keepAliveTimer:null,state:"NotReady",transmitState:"Idle",protocolPacketQueue:[],outboundQueue:[],outboundRequests:{},inboundQueue:[],deferredRequests:{},matchTypeIdAttribute:{},open:function(){this.status="notReady",this.rid=Math.round(1e9*Math.random()),this.protocolPacketQueue=[],this.outboundQueue=[],this.outboundRequests={},this.inboundQueue=[],this.deferredRequests={},this.matchTypeIdAttribute={},this.keepAliveTimer=setTimeout(e.hitch(this,"_keepAlive"),1e4),this.useScriptSrcTransport?i.xmpp.bosh.initialize({iframes:this.hold+1,load:e.hitch(this,function(){this._sendLogin()})}):this._sendLogin()},_sendLogin:function(){var e=this.rid++,t={content:this.submitContentType,hold:this.hold,rid:e,to:this.domain,secure:this.secure,wait:this.wait,"xml:lang":this.lang,"xmpp:version":"1.0",xmlns:i.xmpp.xmpp.BODY_NS,"xmlns:xmpp":"urn:xmpp:xbosh"},a=i.xmpp.util.createElement("body",t,!0);this.addToOutboundQueue(a,e)},_sendRestart:function(){var e=this.rid++,t={rid:e,sid:this.sid,to:this.domain,"xmpp:restart":"true","xml:lang":this.lang,xmlns:i.xmpp.xmpp.BODY_NS,"xmlns:xmpp":"urn:xmpp:xbosh"},a=i.xmpp.util.createElement("body",t,!0);this.addToOutboundQueue(a,e)},processScriptSrc:function(e,t){var a=i.xml.parser.parse(e,"text/xml");a&&this.processDocument(a,t)},_keepAlive:function(){"wait"==this.state||this.isTerminated()||(this._dispatchPacket(),this.keepAliveTimer=setTimeout(e.hitch(this,"_keepAlive"),1e4))},close:function(e){var t=this.rid++,a={sid:this.sid,rid:t,type:"terminate"},o=null;e?(o=new i.string.Builder(i.xmpp.util.createElement("body",a,!1)),o.append(e),o.append("</body>")):o=new i.string.Builder(i.xmpp.util.createElement("body",a,!1)),this.addToOutboundQueue(o.toString(),t),"Terminate"==this.state},dispatchPacket:function(t,i,a,o){t&&this.protocolPacketQueue.push(t);var r=new e.Deferred;return i&&a&&(r.protocolMatchType=i,r.matchId=a,r.matchProperty=o||"id","id"!=r.matchProperty&&(this.matchTypeIdAttribute[i]=r.matchProperty)),this.deferredRequests[r.protocolMatchType+"-"+r.matchId]=r,this.dispatchTimer||(this.dispatchTimer=setTimeout(e.hitch(this,"_dispatchPacket"),600)),r},_dispatchPacket:function(){if(clearTimeout(this.dispatchTimer),delete this.dispatchTimer,this.sid&&this.authId&&!("error"!=this.transmitState&&0==this.protocolPacketQueue.length&&this.outboundQueue.length>0||"wait"==this.state||this.isTerminated())){var t,a={sid:this.sid,xmlns:i.xmpp.xmpp.BODY_NS};if(this.protocolPacketQueue.length>0)a.rid=this.rid++,t=new i.string.Builder(i.xmpp.util.createElement("body",a,!1)),t.append(this.processProtocolPacketQueue()),t.append("</body>"),delete this.lastPollTime;else{if(this.lastPollTime){var o=(new Date).getTime();if(o-this.lastPollTime<this.polling)return void(this.dispatchTimer=setTimeout(e.hitch(this,"_dispatchPacket"),this.polling-(o-this.lastPollTime)+10))}a.rid=this.rid++,this.lastPollTime=(new Date).getTime(),t=new i.string.Builder(i.xmpp.util.createElement("body",a,!0))}this.addToOutboundQueue(t.toString(),a.rid)}},redispatchPacket:function(e){var t=this.outboundRequests[e];this.sendXml(t,e)},addToOutboundQueue:function(e,t){this.outboundQueue.push({msg:e,rid:t}),this.outboundRequests[t]=e,this.sendXml(e,t)},removeFromOutboundQueue:function(e){for(var t=0;t<this.outboundQueue.length;t++)if(e==this.outboundQueue[t].rid){this.outboundQueue.splice(t,1);break}delete this.outboundRequests[e]},processProtocolPacketQueue:function(){for(var e=new i.string.Builder,t=0;t<this.protocolPacketQueue.length;t++)e.append(this.protocolPacketQueue[t]);return this.protocolPacketQueue=[],e.toString()},sendXml:function(t,a){if(this.isTerminated())return!1;this.transmitState="transmitting";var o=null;return o=this.useScriptSrcTransport?i.xmpp.bosh.get({rid:a,url:this.serviceUrl+"?"+encodeURIComponent(t),error:e.hitch(this,function(e,t){return this.setState("Terminate","error"),!1}),timeout:this.sendTimeout}):e.rawXhrPost({contentType:"text/xml",url:this.serviceUrl,postData:t,handleAs:"xml",error:e.hitch(this,function(e,t){return this.processError(t.xhr.responseXML,t.xhr.status,a)}),timeout:this.sendTimeout}),o.addCallback(this,function(e){return this.processDocument(e,a)}),o},processDocument:function(e,t){if(this.isTerminated()||!e.firstChild)return!1;this.transmitState="idle";var i=e.firstChild;if("body"!=i.nodeName,this.outboundQueue.length<1)return!1;var a=this.outboundQueue[0].rid;if(t==a)this.removeFromOutboundQueue(t),this.processResponse(i,t),this.processInboundQueue();else{var o=t-a;o<this.hold+2&&this.addToInboundQueue(e,t)}return e},processInboundQueue:function(){for(;this.inboundQueue.length>0;){var e=this.inboundQueue.shift();this.processDocument(e.doc,e.rid)}},addToInboundQueue:function(e,t){for(var i=0;i<this.inboundQueue.length;i++)t<this.inboundQueue[i].rid||this.inboundQueue.splice(i,0,{doc:e,rid:t})},processResponse:function(t,i){if("terminate"==t.getAttribute("type")){var a=t.firstChild.firstChild,o="";return"conflict"==a.nodeName&&(o="conflict"),void this.setState("Terminate",o)}if("Ready"!=this.state&&"Terminate"!=this.state){var r=t.getAttribute("sid");if(!r)throw new Error("No sid returned during xmpp session startup");this.sid=r,this.authId=t.getAttribute("authid"),""==this.authId&&this.authRetries--<1&&this.terminateSession(),this.wait=t.getAttribute("wait"),t.getAttribute("polling")&&(this.polling=1e3*parseInt(t.getAttribute("polling"))),this.inactivity=t.getAttribute("inactivity"),this.setState("Ready")}e.forEach(t.childNodes,function(e){this.processProtocolResponse(e,i)},this),"idle"==this.transmitState&&this.dispatchPacket()},processProtocolResponse:function(e,t){this.onProcessProtocolResponse(e);var i=e.nodeName+"-"+e.getAttribute("id"),a=this.deferredRequests[i];a&&(a.callback(e),delete this.deferredRequests[i])},setState:function(e,t){this.state!=e&&(this["on"+e]&&this["on"+e](e,this.state,t),this.state=e)},isTerminated:function(){return"Terminate"==this.state},processError:function(t,i,a){if(this.isTerminated())return!1;if(200!=i)return i>=400&&500>i?(this.setState("Terminate",r),!1):(this.removeFromOutboundQueue(a),setTimeout(e.hitch(this,function(){this.dispatchPacket()}),200),!0);if(t&&t.dojoType&&"timeout"==t.dojoType,this.removeFromOutboundQueue(a),t&&t.firstChild&&"terminate"==t.firstChild.getAttribute("type")){var o=t.firstChild.firstChild,r="";return o&&"conflict"==o.nodeName&&(r="conflict"),this.setState("Terminate",r),!1}return this.transmitState="error",setTimeout(e.hitch(this,function(){this.dispatchPacket()}),200),!0},onTerminate:function(e,t,i){},onProcessProtocolResponse:function(e){},onReady:function(e,t){}})});//# sourceMappingURL=TransportSession.js.map