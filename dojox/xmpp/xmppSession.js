//>>built
define("dojox/xmpp/xmppSession",["dojo","dijit","dojox","dojo/require!dojox/xmpp/TransportSession,dojox/xmpp/RosterService,dojox/xmpp/PresenceService,dojox/xmpp/UserService,dojox/xmpp/ChatService,dojox/xmpp/sasl"],function(e,t,i){e.provide("dojox.xmpp.xmppSession"),e.require("dojox.xmpp.TransportSession"),e.require("dojox.xmpp.RosterService"),e.require("dojox.xmpp.PresenceService"),e.require("dojox.xmpp.UserService"),e.require("dojox.xmpp.ChatService"),e.require("dojox.xmpp.sasl"),i.xmpp.xmpp={STREAM_NS:"http://etherx.jabber.org/streams",CLIENT_NS:"jabber:client",STANZA_NS:"urn:ietf:params:xml:ns:xmpp-stanzas",SASL_NS:"urn:ietf:params:xml:ns:xmpp-sasl",BIND_NS:"urn:ietf:params:xml:ns:xmpp-bind",SESSION_NS:"urn:ietf:params:xml:ns:xmpp-session",BODY_NS:"http://jabber.org/protocol/httpbind",XHTML_BODY_NS:"http://www.w3.org/1999/xhtml",XHTML_IM_NS:"http://jabber.org/protocol/xhtml-im",INACTIVE:"Inactive",CONNECTED:"Connected",ACTIVE:"Active",TERMINATE:"Terminate",LOGIN_FAILURE:"LoginFailure",INVALID_ID:-1,NO_ID:0,error:{BAD_REQUEST:"bad-request",CONFLICT:"conflict",FEATURE_NOT_IMPLEMENTED:"feature-not-implemented",FORBIDDEN:"forbidden",GONE:"gone",INTERNAL_SERVER_ERROR:"internal-server-error",ITEM_NOT_FOUND:"item-not-found",ID_MALFORMED:"jid-malformed",NOT_ACCEPTABLE:"not-acceptable",NOT_ALLOWED:"not-allowed",NOT_AUTHORIZED:"not-authorized",SERVICE_UNAVAILABLE:"service-unavailable",SUBSCRIPTION_REQUIRED:"subscription-required",UNEXPECTED_REQUEST:"unexpected-request"}},i.xmpp.xmppSession=function(t){this.roster=[],this.chatRegister=[],this._iqId=Math.round(1e9*Math.random()),t&&e.isObject(t)&&e.mixin(this,t),this.session=new i.xmpp.TransportSession(t),e.connect(this.session,"onReady",this,"onTransportReady"),e.connect(this.session,"onTerminate",this,"onTransportTerminate"),e.connect(this.session,"onProcessProtocolResponse",this,"processProtocolResponse")},e.extend(i.xmpp.xmppSession,{roster:[],chatRegister:[],_iqId:0,open:function(e,t,i){if(!e)throw new Error("User id cannot be null");this.jid=e,-1==e.indexOf("@")&&(this.jid=this.jid+"@"+this.domain),t&&(this.password=t),i&&(this.resource=i),this.session.open()},close:function(){this.state=i.xmpp.xmpp.TERMINATE,this.session.close(i.xmpp.util.createElement("presence",{type:"unavailable",xmlns:i.xmpp.xmpp.CLIENT_NS},!0))},processProtocolResponse:function(e){var t=e.nodeName,a=t.indexOf(":");switch(a>0&&(t=t.substring(a+1)),t){case"iq":case"presence":case"message":case"features":this[t+"Handler"](e);break;default:e.getAttribute("xmlns")==i.xmpp.xmpp.SASL_NS&&this.saslHandler(e)}},messageHandler:function(e){switch(e.getAttribute("type")){case"chat":this.chatHandler(e);break;case"normal":break;default:this.simpleMessageHandler(e)}},iqHandler:function(e){return"set"==e.getAttribute("type")?void this.iqSetHandler(e):void("get"==e.getAttribute("type"))},presenceHandler:function(e){switch(e.getAttribute("type")){case"subscribe":this.presenceSubscriptionRequest(e.getAttribute("from"));break;case"subscribed":case"unsubscribed":break;case"error":this.processXmppError(e);break;default:this.presenceUpdate(e)}},featuresHandler:function(e){var t=[],a=!1,r=!1;if(e.hasChildNodes())for(var o=0;o<e.childNodes.length;o++){var n=e.childNodes[o];switch(n.nodeName){case"mechanisms":for(var s=0;s<n.childNodes.length;s++)t.push(n.childNodes[s].firstChild.nodeValue);break;case"bind":a=!0;break;case"session":r=!0}}if(this.state==i.xmpp.xmpp.CONNECTED)if(this.auth)a&&this.bindResource(r);else for(var o=0;o<t.length;o++)try{this.auth=i.xmpp.sasl.registry.match(t[o],this);break}catch(d){}},saslHandler:function(e){return"success"==e.nodeName?void this.auth.onSuccess():"challenge"==e.nodeName?void this.auth.onChallenge(e):void(e.hasChildNodes()&&(this.onLoginFailure(e.firstChild.nodeName),this.session.setState("Terminate",e.firstChild.nodeName)))},sendRestart:function(){this.session._sendRestart()},chatHandler:function(e){for(var t={from:e.getAttribute("from"),to:e.getAttribute("to")},a=null,r=0;r<e.childNodes.length;r++){var o=e.childNodes[r];if(o.hasChildNodes())switch(o.nodeName){case"thread":t.chatid=o.firstChild.nodeValue;break;case"body":o.getAttribute("xmlns")&&""!==o.getAttribute("xmlns")||(t.body=o.firstChild.nodeValue);break;case"subject":t.subject=o.firstChild.nodeValue;break;case"html":o.getAttribute("xmlns")==i.xmpp.xmpp.XHTML_IM_NS&&(t.xhtml=o.getElementsByTagName("body")[0]);break;case"x":}}var n=-1;if(t.chatid)for(var r=0;r<this.chatRegister.length;r++){var s=this.chatRegister[r];if(s&&s.chatid==t.chatid){n=r;break}}else for(var r=0;r<this.chatRegister.length;r++){var s=this.chatRegister[r];s&&s.uid==this.getBareJid(t.from)&&(n=r)}if(n>-1&&a){var d=this.chatRegister[n];d.setState(a),d.firstMessage&&a==i.xmpp.chat.ACTIVE_STATE&&(d.useChatState=null!==a,d.firstMessage=!1)}if(t.body&&""!==t.body||t.xhtml)if(n>-1){var d=this.chatRegister[n];d.receiveMessage(t)}else{var l=new i.xmpp.ChatService;l.uid=this.getBareJid(t.from),l.chatid=t.chatid,l.firstMessage=!0,a&&a==i.xmpp.chat.ACTIVE_STATE||(this.useChatState=!1),this.registerChatInstance(l,t)}},simpleMessageHandler:function(e){},registerChatInstance:function(e,t){e.setSession(this),this.chatRegister.push(e),this.onRegisterChatInstance(e,t),e.receiveMessage(t,!0)},iqSetHandler:function(e){if(e.hasChildNodes()){var t=e.firstChild;switch(t.nodeName){case"query":"jabber:iq:roster"==t.getAttribute("xmlns")&&(this.rosterSetHandler(t),this.sendIqResult(e.getAttribute("id"),e.getAttribute("from")))}}},sendIqResult:function(e,t){var a={id:e,to:t||this.domain,type:"result",from:this.jid+"/"+this.resource};this.dispatchPacket(i.xmpp.util.createElement("iq",a,!0))},rosterSetHandler:function(t){for(var a,r=0;r<t.childNodes.length;r++){var o=t.childNodes[r];if("item"==o.nodeName){for(var n=!1,s=-1,d=null,l=null,h=0;h<this.roster.length;h++)if(a=this.roster[h],o.getAttribute("jid")==a.jid){if(n=!0,"remove"==o.getAttribute("subscription")){d={id:a.jid,name:a.name,groups:[]};for(var c=0;c<a.groups.length;c++)d.groups.push(a.groups[c]);this.roster.splice(h,1),s=i.xmpp.roster.REMOVED}else{l=e.clone(a);var u=o.getAttribute("name");u&&(this.roster[h].name=u),a.groups=[],o.getAttribute("subscription")&&(a.status=o.getAttribute("subscription")),a.substatus=i.xmpp.presence.SUBSCRIPTION_SUBSTATUS_NONE,"subscribe"==o.getAttribute("ask")&&(a.substatus=i.xmpp.presence.SUBSCRIPTION_REQUEST_PENDING);for(var c=0;c<o.childNodes.length;c++){var m=o.childNodes[c];if("group"==m.nodeName&&m.hasChildNodes()){var f=m.firstChild.nodeValue;a.groups.push(f)}}d=a,s=i.xmpp.roster.CHANGED}break}switch(n||"remove"==o.getAttribute("subscription")||(a=this.createRosterEntry(o),d=a,s=i.xmpp.roster.ADDED),s){case i.xmpp.roster.ADDED:this.onRosterAdded(d);break;case i.xmpp.roster.REMOVED:this.onRosterRemoved(d);break;case i.xmpp.roster.CHANGED:this.onRosterChanged(d,l)}}}},presenceUpdate:function(e){if(e.getAttribute("to")){var t=this.getBareJid(e.getAttribute("to"));if(t!=this.jid)return}var a=this.getResourceFromJid(e.getAttribute("from")),r={from:this.getBareJid(e.getAttribute("from")),resource:a,show:i.xmpp.presence.STATUS_ONLINE,priority:5,hasAvatar:!1};"unavailable"==e.getAttribute("type")&&(r.show=i.xmpp.presence.STATUS_OFFLINE);for(var o=0;o<e.childNodes.length;o++){var n=e.childNodes[o];if(n.hasChildNodes())switch(n.nodeName){case"status":case"show":r[n.nodeName]=n.firstChild.nodeValue;break;case"priority":r.priority=parseInt(n.firstChild.nodeValue,10);break;case"x":n.firstChild&&n.firstChild.firstChild&&""!==n.firstChild.firstChild.nodeValue&&(r.avatarHash=n.firstChild.firstChild.nodeValue,r.hasAvatar=!0)}}this.onPresenceUpdate(r)},retrieveRoster:function(){var e={id:this.getNextIqId(),from:this.jid+"/"+this.resource,type:"get"},t=new i.string.Builder(i.xmpp.util.createElement("iq",e,!1));t.append(i.xmpp.util.createElement("query",{xmlns:"jabber:iq:roster"},!0)),t.append("</iq>");var a=this.dispatchPacket(t,"iq",e.id);a.addCallback(this,"onRetrieveRoster")},getRosterIndex:function(e){-1==e.indexOf("@")&&(e+="@"+this.domain);for(var t=0;t<this.roster.length;t++)if(e==this.roster[t].jid)return t;return-1},createRosterEntry:function(e){var t={name:e.getAttribute("name"),jid:e.getAttribute("jid"),groups:[],status:i.xmpp.presence.SUBSCRIPTION_NONE,substatus:i.xmpp.presence.SUBSCRIPTION_SUBSTATUS_NONE};t.name||(t.name=t.id);for(var a=0;a<e.childNodes.length;a++){var r=e.childNodes[a];"group"==r.nodeName&&r.hasChildNodes()&&t.groups.push(r.firstChild.nodeValue)}return e.getAttribute("subscription")&&(t.status=e.getAttribute("subscription")),"subscribe"==e.getAttribute("ask")&&(t.substatus=i.xmpp.presence.SUBSCRIPTION_REQUEST_PENDING),t},bindResource:function(e){var t={id:this.getNextIqId(),type:"set"},a=new i.string.Builder(i.xmpp.util.createElement("iq",t,!1));a.append(i.xmpp.util.createElement("bind",{xmlns:i.xmpp.xmpp.BIND_NS},!1)),this.resource&&(a.append(i.xmpp.util.createElement("resource")),a.append(this.resource),a.append("</resource>")),a.append("</bind></iq>");var r=this.dispatchPacket(a,"iq",t.id);r.addCallback(this,function(t){return this.onBindResource(t,e),t})},getNextIqId:function(){return"im_"+this._iqId++},presenceSubscriptionRequest:function(e){this.onSubscriptionRequest(e)},dispatchPacket:function(e,t,i){return"Terminate"!=this.state?this.session.dispatchPacket(e,t,i):void 0},setState:function(e,t){this.state!=e&&(this["on"+e]&&this["on"+e](e,this.state,t),this.state=e)},search:function(e,t,a){var r={id:this.getNextIqId(),"xml:lang":this.lang,type:"set",from:this.jid+"/"+this.resource,to:t},o=new i.string.Builder(i.xmpp.util.createElement("iq",r,!1));o.append(i.xmpp.util.createElement("query",{xmlns:"jabber:iq:search"},!1)),o.append(i.xmpp.util.createElement(a,{},!1)),o.append(e),o.append("</").append(a).append(">"),o.append("</query></iq>");var n=this.dispatchPacket(o.toString,"iq",r.id);n.addCallback(this,"_onSearchResults")},_onSearchResults:function(e){"result"==e.getAttribute("type")&&e.hasChildNodes()&&this.onSearchResults([])},onLogin:function(){this.retrieveRoster()},onLoginFailure:function(e){},onBindResource:function(e,t){if("result"==e.getAttribute("type")){if(e.hasChildNodes()&&"bind"==e.firstChild.nodeName){var a=e.firstChild;if(a.hasChildNodes()&&"jid"==a.firstChild.nodeName&&a.firstChild.hasChildNodes()){var r=a.firstChild.firstChild.nodeValue;this.jid=this.getBareJid(r),this.resource=this.getResourceFromJid(r)}if(t){var o={id:this.getNextIqId(),type:"set"},n=new i.string.Builder(i.xmpp.util.createElement("iq",o,!1));n.append(i.xmpp.util.createElement("session",{xmlns:i.xmpp.xmpp.SESSION_NS},!0)),n.append("</iq>");var s=this.dispatchPacket(n,"iq",o.id);return void s.addCallback(this,"onBindSession")}}this.onLogin()}else if("error"==e.getAttribute("type")){var d=this.processXmppError(e);this.onLoginFailure(d)}},onBindSession:function(e){if("error"==e.getAttribute("type")){var t=this.processXmppError(e);this.onLoginFailure(t)}else this.onLogin()},onSearchResults:function(e){},onRetrieveRoster:function(e){if("result"==e.getAttribute("type")&&e.hasChildNodes()){var t=e.getElementsByTagName("query")[0];if("jabber:iq:roster"==t.getAttribute("xmlns"))for(var a=0;a<t.childNodes.length;a++)"item"==t.childNodes[a].nodeName&&(this.roster[a]=this.createRosterEntry(t.childNodes[a]))}else"error"==e.getAttribute("type");return this.setState(i.xmpp.xmpp.ACTIVE),this.onRosterUpdated(),e},onRosterUpdated:function(){},onSubscriptionRequest:function(e){},onPresenceUpdate:function(e){},onTransportReady:function(){this.setState(i.xmpp.xmpp.CONNECTED),this.rosterService=new i.xmpp.RosterService(this),this.presenceService=new i.xmpp.PresenceService(this),this.userService=new i.xmpp.UserService(this)},onTransportTerminate:function(e,t,a){this.setState(i.xmpp.xmpp.TERMINATE,a)},onConnected:function(){},onTerminate:function(e,t,i){},onActive:function(){},onRegisterChatInstance:function(e,t){},onRosterAdded:function(e){},onRosterRemoved:function(e){},onRosterChanged:function(e,t){},processXmppError:function(e){for(var t={stanzaType:e.nodeName,id:e.getAttribute("id")},a=0;a<e.childNodes.length;a++){var r=e.childNodes[a];switch(r.nodeName){case"error":t.errorType=r.getAttribute("type");for(var o=0;o<r.childNodes.length;o++){var n=r.childNodes[o];"text"==n.nodeName&&n.getAttribute("xmlns")==i.xmpp.xmpp.STANZA_NS&&n.hasChildNodes()?t.message=n.firstChild.nodeValue:n.getAttribute("xmlns")!=i.xmpp.xmpp.STANZA_NS||n.hasChildNodes()||(t.condition=n.nodeName)}}}return t},sendStanzaError:function(e,t,a,r,o,n){var s={type:"error"};t&&(s.to=t),a&&(s.id=a);var d=new i.string.Builder(i.xmpp.util.createElement(e,s,!1));if(d.append(i.xmpp.util.createElement("error",{type:r},!1)),d.append(i.xmpp.util.createElement("condition",{xmlns:i.xmpp.xmpp.STANZA_NS},!0)),n){var l={xmlns:i.xmpp.xmpp.STANZA_NS,"xml:lang":this.lang};d.append(i.xmpp.util.createElement("text",l,!1)),d.append(n).append("</text>")}d.append("</error></").append(e).append(">"),this.dispatchPacket(d.toString())},getBareJid:function(e){var t=e.indexOf("/");return-1!=t?e.substring(0,t):e},getResourceFromJid:function(e){var t=e.indexOf("/");return-1!=t?e.substring(t+1,e.length):""}})});//# sourceMappingURL=xmppSession.js.map