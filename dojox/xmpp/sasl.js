//>>built
define("dojox/xmpp/sasl",["dojo","dijit","dojox","dojo/require!dojox/xmpp/util,dojo/AdapterRegistry,dojox/encoding/digests/MD5"],function(e,t,i){e.provide("dojox.xmpp.sasl"),e.require("dojox.xmpp.util"),e.require("dojo.AdapterRegistry"),e.require("dojox.encoding.digests.MD5"),i.xmpp.sasl.saslNS="urn:ietf:params:xml:ns:xmpp-sasl",e.declare("dojox.xmpp.sasl._Base",null,{mechanism:null,closeAuthTag:!0,constructor:function(e){this.session=e,this.startAuth()},startAuth:function(){var e=new i.string.Builder(i.xmpp.util.createElement("auth",{xmlns:i.xmpp.sasl.saslNS,mechanism:this.mechanism},this.closeAuthTag));this.appendToAuth(e),this.session.dispatchPacket(e.toString())},appendToAuth:function(e){},onChallenge:function(e){this.first_challenge?this.onSecondChallenge(e):(this.first_challenge=!0,this.onFirstChallenge(e))},onFirstChallenge:function(){},onSecondChallenge:function(){},onSuccess:function(){this.session.sendRestart()}}),e.declare("dojox.xmpp.sasl.SunWebClientAuth",i.xmpp.sasl._Base,{mechanism:"SUN-COMMS-CLIENT-PROXY-AUTH"}),e.declare("dojox.xmpp.sasl.Plain",i.xmpp.sasl._Base,{mechanism:"PLAIN",closeAuthTag:!1,appendToAuth:function(e){var t=this.session.jid,a=this.session.jid.indexOf("@");-1!=a&&(t=this.session.jid.substring(0,a));var o=this.session.jid+"\x00"+t+"\x00"+this.session.password;o=i.xmpp.util.Base64.encode(o),e.append(o),e.append("</auth>"),delete this.session.password}}),e.declare("dojox.xmpp.sasl.DigestMD5",i.xmpp.sasl._Base,{mechanism:"DIGEST-MD5",onFirstChallenge:function(e){var t=i.encoding.digests,a=i.encoding.digests.outputTypes,o=function(e){return t.MD5(e,a.Hex)},r=function(e){return t.MD5(e,a.String)},n=i.xmpp.util.Base64.decode(e.firstChild.nodeValue),s={realm:"",nonce:"",qop:"auth",maxbuf:65536};n.replace(/([a-z]+)=([^,]+)/g,function(e,t,i){i=i.replace(/^"(.+)"$/,"$1"),s[t]=i});var l="";switch(s.qop){case"auth-int":case"auth-conf":l=":00000000000000000000000000000000";case"auth":break;default:return!1}var d=t.MD5(1234567890*Math.random(),a.Hex),u="xmpp/"+this.session.domain,h=this.session.jid,c=this.session.jid.indexOf("@");-1!=c&&(h=this.session.jid.substring(0,c)),h=i.xmpp.util.encodeJid(h);var m=new i.string.Builder;m.append(r(h+":"+s.realm+":"+this.session.password),":",s.nonce+":"+d),delete this.session.password;var f=":"+u+l,p="AUTHENTICATE"+f,g=new i.string.Builder;g.append(o(m.toString()),":",s.nonce,":00000001:",d,":",s.qop,":");var v=new i.string.Builder;v.append('username="',h,'",','realm="',s.realm,'",',"nonce=",s.nonce,",",'cnonce="',d,'",','nc="00000001",qop="',s.qop,'",digest-uri="',u,'",','response="',o(g.toString()+o(p)),'",charset="utf-8"');var y=new i.string.Builder(i.xmpp.util.createElement("response",{xmlns:i.xmpp.xmpp.SASL_NS},!1));y.append(i.xmpp.util.Base64.encode(v.toString())),y.append("</response>"),this.rspauth=o(g.toString()+o(f)),this.session.dispatchPacket(y.toString())},onSecondChallenge:function(e){var t=i.xmpp.util.Base64.decode(e.firstChild.nodeValue);if(this.rspauth==t.substring(8)){var a=new i.string.Builder(i.xmpp.util.createElement("response",{xmlns:i.xmpp.xmpp.SASL_NS},!0));this.session.dispatchPacket(a.toString())}}}),i.xmpp.sasl.registry=new e.AdapterRegistry,i.xmpp.sasl.registry.register("SUN-COMMS-CLIENT-PROXY-AUTH",function(e){return"SUN-COMMS-CLIENT-PROXY-AUTH"==e},function(e,t){return new i.xmpp.sasl.SunWebClientAuth(t)}),i.xmpp.sasl.registry.register("DIGEST-MD5",function(e){return"DIGEST-MD5"==e},function(e,t){return new i.xmpp.sasl.DigestMD5(t)}),i.xmpp.sasl.registry.register("PLAIN",function(e){return"PLAIN"==e},function(e,t){return new i.xmpp.sasl.Plain(t)})});//# sourceMappingURL=sasl.js.map