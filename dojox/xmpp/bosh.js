//>>built
define("dojox/xmpp/bosh",["dojo","dijit","dojox","dojo/require!dojo/io/script,dojo/io/iframe,dojox/xml/parser"],function(e,t,i){e.provide("dojox.xmpp.bosh"),e.require("dojo.io.script"),e.require("dojo.io.iframe"),e.require("dojox.xml.parser"),i.xmpp.bosh={transportIframes:[],initialize:function(t){this.transportIframes=[];for(var a=i._scopeName+".xmpp.bosh",n=e.connect(e.getObject(a),"_iframeOnload",this,function(i){0==i&&(t.load(),e.disconnect(n))}),o=0;o<t.iframes;o++){var r="xmpp-transport-"+o,s=e.byId("xmpp-transport-"+o);s&&(window[r]&&(window[r]=null),window.frames[r]&&(window.frames[r]=null),e.destroy(s)),s=e.io.iframe.create("xmpp-transport-"+o,a+"._iframeOnload("+o+");"),this.transportIframes.push(s)}},_iframeOnload:function(t){var i=e.io.iframe.doc(e.byId("xmpp-transport-"+t));i.write("<script>var isLoaded=true; var rid=0; var transmiting=false; function _BOSH_(msg) { transmiting=false; parent.dojox.xmpp.bosh.handle(msg, rid); } </script>")},findOpenIframe:function(){for(var e=0;e<this.transportIframes.length;e++){var t=this.transportIframes[e],i=t.contentWindow;if(i.isLoaded&&!i.transmiting)return t}return!1},handle:function(e,t){var a=this["rid"+t],n=i.xml.parser.parse(e,"text/xml");n?a.ioArgs.xmppMessage=n:a.errback(new Error("Received bad document from server: "+e))},get:function(t){var i=this.findOpenIframe(),a=e.io.iframe.doc(i);t.frameDoc=a;var n=this._makeScriptDeferred(t),o=n.ioArgs;return i.contentWindow.rid=o.rid,i.contentWindow.transmiting=!0,e._ioAddQueryToUrl(o),e._ioNotifyStart(n),e.io.script.attach(o.id,o.url,a),e._ioWatch(n,this._validCheck,this._ioCheck,this._resHandle),n},remove:function(t,i){e.destroy(e.byId(t,i)),this[t]&&delete this[t]},_makeScriptDeferred:function(t){var i=e._ioSetArgs(t,this._deferredCancel,this._deferredOk,this._deferredError),a=i.ioArgs;return a.id="rid"+t.rid,a.rid=t.rid,a.canDelete=!0,a.frameDoc=t.frameDoc,this[a.id]=i,i},_deferredCancel:function(e){e.canceled=!0,e.ioArgs.canDelete&&i.xmpp.bosh._addDeadScript(e.ioArgs)},_deferredOk:function(e){var t=e.ioArgs;return t.canDelete&&i.xmpp.bosh._addDeadScript(t),t.xmppMessage||t},_deferredError:function(e,t){return t.ioArgs.canDelete&&("timeout"==e.dojoType?i.xmpp.bosh.remove(t.ioArgs.id,t.ioArgs.frameDoc):i.xmpp.bosh._addDeadScript(t.ioArgs)),e},_deadScripts:[],_addDeadScript:function(e){i.xmpp.bosh._deadScripts.push({id:e.id,frameDoc:e.frameDoc}),e.frameDoc=null},_validCheck:function(e){var t=i.xmpp.bosh,a=t._deadScripts;if(a&&a.length>0){for(var n=0;n<a.length;n++)t.remove(a[n].id,a[n].frameDoc),a[n].frameDoc=null;i.xmpp.bosh._deadScripts=[]}return!0},_ioCheck:function(e){var t=e.ioArgs;return!!t.xmppMessage},_resHandle:function(e){i.xmpp.bosh._ioCheck(e)?e.callback(e):e.errback(new Error("inconceivable dojox.xmpp.bosh._resHandle error"))}}});//# sourceMappingURL=bosh.js.map