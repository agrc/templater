//>>built
define("dojox/xmpp/bosh",["dojo","dijit","dojox","dojo/require!dojo/io/script,dojo/io/iframe,dojox/xml/parser"],function(e,t,i){e.provide("dojox.xmpp.bosh"),e.require("dojo.io.script"),e.require("dojo.io.iframe"),e.require("dojox.xml.parser"),i.xmpp.bosh={transportIframes:[],initialize:function(t){this.transportIframes=[];for(var a=i._scopeName+".xmpp.bosh",o=e.connect(e.getObject(a),"_iframeOnload",this,function(i){0==i&&(t.load(),e.disconnect(o))}),r=0;r<t.iframes;r++){var n="xmpp-transport-"+r,s=e.byId("xmpp-transport-"+r);s&&(window[n]&&(window[n]=null),window.frames[n]&&(window.frames[n]=null),e.destroy(s)),s=e.io.iframe.create("xmpp-transport-"+r,a+"._iframeOnload("+r+");"),this.transportIframes.push(s)}},_iframeOnload:function(t){e.io.iframe.doc(e.byId("xmpp-transport-"+t)).write("<script>var isLoaded=true; var rid=0; var transmiting=false; function _BOSH_(msg) { transmiting=false; parent.dojox.xmpp.bosh.handle(msg, rid); } <\/script>")},findOpenIframe:function(){for(var e=0;e<this.transportIframes.length;e++){var t=this.transportIframes[e],i=t.contentWindow;if(i.isLoaded&&!i.transmiting)return t}return!1},handle:function(e,t){var a=this["rid"+t],o=i.xml.parser.parse(e,"text/xml");o?a.ioArgs.xmppMessage=o:a.errback(new Error("Received bad document from server: "+e))},get:function(t){var i=this.findOpenIframe(),a=e.io.iframe.doc(i);t.frameDoc=a;var o=this._makeScriptDeferred(t),r=o.ioArgs;return i.contentWindow.rid=r.rid,i.contentWindow.transmiting=!0,e._ioAddQueryToUrl(r),e._ioNotifyStart(o),e.io.script.attach(r.id,r.url,a),e._ioWatch(o,this._validCheck,this._ioCheck,this._resHandle),o},remove:function(t,i){e.destroy(e.byId(t,i)),this[t]&&delete this[t]},_makeScriptDeferred:function(t){var i=e._ioSetArgs(t,this._deferredCancel,this._deferredOk,this._deferredError),a=i.ioArgs;return a.id="rid"+t.rid,a.rid=t.rid,a.canDelete=!0,a.frameDoc=t.frameDoc,this[a.id]=i,i},_deferredCancel:function(e){e.canceled=!0,e.ioArgs.canDelete&&i.xmpp.bosh._addDeadScript(e.ioArgs)},_deferredOk:function(e){var t=e.ioArgs;return t.canDelete&&i.xmpp.bosh._addDeadScript(t),t.xmppMessage||t},_deferredError:function(e,t){return t.ioArgs.canDelete&&("timeout"==e.dojoType?i.xmpp.bosh.remove(t.ioArgs.id,t.ioArgs.frameDoc):i.xmpp.bosh._addDeadScript(t.ioArgs)),e},_deadScripts:[],_addDeadScript:function(e){i.xmpp.bosh._deadScripts.push({id:e.id,frameDoc:e.frameDoc}),e.frameDoc=null},_validCheck:function(e){var t=i.xmpp.bosh,a=t._deadScripts;if(a&&a.length>0){for(var o=0;o<a.length;o++)t.remove(a[o].id,a[o].frameDoc),a[o].frameDoc=null;i.xmpp.bosh._deadScripts=[]}return!0},_ioCheck:function(e){return!!e.ioArgs.xmppMessage},_resHandle:function(e){i.xmpp.bosh._ioCheck(e)?e.callback(e):e.errback(new Error("inconceivable dojox.xmpp.bosh._resHandle error"))}}});//# sourceMappingURL=bosh.js.map