//>>built
define("dojox/io/proxy/xip",["dojo/main","dojo/io/iframe","dojox/data/dom","dojo/_base/xhr","dojo/_base/url"],function(e,t,a){return e.getObject("io.proxy.xip",!0,dojox),dojox.io.proxy.xip={xipClientUrl:(e.config||djConfig).xipClientUrl||e.moduleUrl("dojox.io.proxy","xip_client.html").toString(),urlLimit:4e3,_callbackName:(dojox._scopeName||"dojox")+".io.proxy.xip.fragmentReceived",_state:{},_stateIdCounter:0,_isWebKit:-1!=navigator.userAgent.indexOf("WebKit"),send:function(t){var a=this.xipClientUrl;if(a.split(":")[0].match(/javascript/i)||t._ifpServerUrl.split(":")[0].match(/javascript/i))return null;var i=a.indexOf(":"),r=a.indexOf("/");if(-1==i||r<i){var n=window.location.href;a=0==r?n.substring(0,n.indexOf("/",9))+a:n.substring(0,n.lastIndexOf("/")+1)+a}return this.fullXipClientUrl=a,void 0!==document.postMessage&&document.addEventListener("message",e.hitch(this,this.fragmentReceivedEvent),!1),this.send=this._realSend,this._realSend(t)},_realSend:function(e){var a="XhrIframeProxy"+this._stateIdCounter++;e._stateId=a;var i=e._ifpServerUrl+"#0:init:id="+a+"&client="+encodeURIComponent(this.fullXipClientUrl)+"&callback="+encodeURIComponent(this._callbackName);return this._state[a]={facade:e,stateId:a,clientFrame:t.create(a,"",i),isSending:!1,serverUrl:e._ifpServerUrl,requestData:null,responseMessage:"",requestParts:[],idCounter:1,partIndex:0,serverWindow:null},a},receive:function(e,t){for(var i={},r=t.split("&"),n=0;n<r.length;n++)if(r[n]){var o=r[n].split("=");i[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}var s=this._state[e],l=s.facade;if(l._setResponseHeaders(i.responseHeaders),(0==i.status||i.status)&&(l.status=parseInt(i.status,10)),i.statusText&&(l.statusText=i.statusText),i.responseText){l.responseText=i.responseText;var d=l.getResponseHeader("Content-Type");if(d){var u=d.split(";")[0];0!=u.indexOf("application/xml")&&0!=u.indexOf("text/xml")||(l.responseXML=a.createDocument(i.responseText,d))}}l.readyState=4,this.destroyState(e)},frameLoaded:function(t){var a=this._state[t],i=a.facade,r=[];for(var n in i._requestHeaders)r.push(n+": "+i._requestHeaders[n]);var o={uri:i._uri};r.length>0&&(o.requestHeaders=r.join("\r\n")),i._method&&(o.method=i._method),i._bodyData&&(o.data=i._bodyData),this.sendRequest(t,e.objectToQuery(o))},destroyState:function(e){var t=this._state[e];if(t){delete this._state[e];t.clientFrame.parentNode.removeChild(t.clientFrame),t.clientFrame=null,t=null}},createFacade:function(){return arguments&&arguments[0]&&arguments[0].iframeProxyUrl?new dojox.io.proxy.xip.XhrIframeFacade(arguments[0].iframeProxyUrl):dojox.io.proxy.xip._xhrObjOld.apply(e,arguments)},sendRequest:function(e,t){var a=this._state[e];a.isSending||(a.isSending=!0,a.requestData=t||"",a.serverWindow=frames[a.stateId],a.serverWindow||(a.serverWindow=document.getElementById(a.stateId).contentWindow),void 0===document.postMessage&&a.serverWindow.contentWindow&&(a.serverWindow=a.serverWindow.contentWindow),this.sendRequestStart(e))},sendRequestStart:function(e){var t=this._state[e];t.requestParts=[];for(var a=t.requestData,i=t.serverUrl.length,r=this.urlLimit-i,n=0;a.length-n+i>this.urlLimit;){var o=a.substring(n,n+r),s=o.lastIndexOf("%");s!=o.length-1&&s!=o.length-2||(o=o.substring(0,s)),t.requestParts.push(o),n+=o.length}t.requestParts.push(a.substring(n,a.length)),t.partIndex=0,this.sendRequestPart(e)},sendRequestPart:function(e){var t=this._state[e];if(t.partIndex<t.requestParts.length){var a=t.requestParts[t.partIndex],i="part";t.partIndex+1==t.requestParts.length?i="end":0==t.partIndex&&(i="start"),this.setServerUrl(e,i,a),t.partIndex++}},setServerUrl:function(e,t,a){var i=this.makeServerUrl(e,t,a),r=this._state[e];this._isWebKit?r.serverWindow.location=i:r.serverWindow.location.replace(i)},makeServerUrl:function(e,t,a){var i=this._state[e],r=i.serverUrl+"#"+i.idCounter+++":"+t;return a&&(r+=":"+a),r},fragmentReceivedEvent:function(e){e.uri.split("#")[0]==this.fullXipClientUrl&&this.fragmentReceived(e.data)},fragmentReceived:function(e){var t=e.indexOf("#"),a=e.substring(0,t),i=e.substring(t+1,e.length),r=this.unpackMessage(i),n=this._state[a];switch(r.command){case"loaded":this.frameLoaded(a);break;case"ok":this.sendRequestPart(a);break;case"start":n.responseMessage=""+r.message,this.setServerUrl(a,"ok");break;case"part":n.responseMessage+=r.message,this.setServerUrl(a,"ok");break;case"end":this.setServerUrl(a,"ok"),n.responseMessage+=r.message,this.receive(a,n.responseMessage)}},unpackMessage:function(e){var t=e.split(":"),a=t[1];e=t[2]||"";var i=null;if("init"==a){var r=e.split("&");i={};for(var n=0;n<r.length;n++){var o=r[n].split("=");i[decodeURIComponent(o[0])]=decodeURIComponent(o[1])}}return{command:a,message:e,config:i}}},dojox.io.proxy.xip._xhrObjOld=e._xhrObj,e._xhrObj=dojox.io.proxy.xip.createFacade,dojox.io.proxy.xip.XhrIframeFacade=function(e){this._requestHeaders={},this._allResponseHeaders=null,this._responseHeaders={},this._method=null,this._uri=null,this._bodyData=null,this.responseText=null,this.responseXML=null,this.status=null,this.statusText=null,this.readyState=0,this._ifpServerUrl=e,this._stateId=null},e.extend(dojox.io.proxy.xip.XhrIframeFacade,{open:function(e,t){this._method=e,this._uri=t,this.readyState=1},setRequestHeader:function(e,t){this._requestHeaders[e]=t},send:function(e){this._bodyData=e,this._stateId=dojox.io.proxy.xip.send(this),this.readyState=2},abort:function(){dojox.io.proxy.xip.destroyState(this._stateId)},getAllResponseHeaders:function(){return this._allResponseHeaders},getResponseHeader:function(e){return this._responseHeaders[e]},_setResponseHeaders:function(e){if(e){this._allResponseHeaders=e,e=e.replace(/\r/g,"");for(var t=e.split("\n"),a=0;a<t.length;a++)if(t[a]){var i=t[a].split(": ");this._responseHeaders[i[0]]=i[1]}}}}),dojox.io.proxy.xip});//# sourceMappingURL=xip.js.map