//>>built
define("dojox/dtl/dom",["dojo/_base/lang","./_base","dojox/string/tokenize","./Context","dojo/dom","dojo/dom-construct","dojo/_base/html","dojo/_base/array","dojo/_base/connect","dojo/_base/sniff"],function(e,t,i,a,r,o,n,d,s,l){t.BOOLS={checked:1,disabled:1,readonly:1},t.TOKEN_CHANGE=-11,t.TOKEN_ATTR=-12,t.TOKEN_CUSTOM=-13,t.TOKEN_NODE=1;var h=t.text,u=t.dom={_attributes:{},_uppers:{},_re4:/^function anonymous\(\)\s*{\s*(.*)\s*}$/,_reTrim:/(?:^[\n\s]*(\{%)?\s*|\s*(%\})?[\n\s]*$)/g,_reSplit:/\s*%\}[\n\s]*\{%\s*/g,getTemplate:function(t){if("undefined"==typeof this._commentable){this._commentable=!1;var a=document.createElement("div"),r="Test comment handling, and long comments, using comments whenever possible.";a.innerHTML="<!--"+r+"-->",a.childNodes.length&&8==a.firstChild.nodeType&&a.firstChild.data==r&&(this._commentable=!0)}this._commentable||(t=t.replace(/<!--({({|%).*?(%|})})-->/g,"$1")),l("ie")&&(t=t.replace(/\b(checked|disabled|readonly|style)="/g,'t$1="')),t=t.replace(/\bstyle="/g,'tstyle="');for(var o,n,d=l("webkit"),s=[[!0,"select","option"],[d,"tr","td|th"],[d,"thead","tr","th"],[d,"tbody","tr","td"],[d,"table","tbody|thead|tr","tr","td"]],h=[],u=0;n=s[u];u++)if(n[0]&&-1!=t.indexOf("<"+n[1]))for(var m=new RegExp("<"+n[1]+"(?:.|\n)*?>((?:.|\n)+?)</"+n[1]+">","ig");o=m.exec(t);){for(var c,f=n[2].split("|"),y=[],p=0;c=f[p];p++)y.push("<"+c+"(?:.|\n)*?>(?:.|\n)*?</"+c+">");var v=[],g=i(o[1],new RegExp("("+y.join("|")+")","ig"),function(e){var t=/<(\w+)/.exec(e)[1];return v[t]||(v[t]=!0,v.push(t)),{data:e}});if(v.length){for(var M=1==v.length?v[0]:n[2].split("|")[0],b=[],p=0,_=g.length;_>p;p++){var w=g[p];if(e.isObject(w))b.push(w.data);else{var x=w.replace(this._reTrim,"");if(!x)continue;w=x.split(this._reSplit);for(var j=0,k=w.length;k>j;j++){for(var I="",F=2,E=n.length;E>F;F++)if(2==F)I+="<"+M+' dtlinstruction="{% '+w[j].replace('"','\\"')+' %}">';else{if(M==n[F])continue;I+="<"+n[F]+">"}I+="DTL";for(var F=n.length-1;F>1;F--)if(2==F)I+="</"+M+">";else{if(M==n[F])continue;I+="</"+n[F]+">"}b.push("ÿ"+h.length),h.push(I)}}}t=t.replace(o[1],b.join(""))}}for(var u=h.length;u--;)t=t.replace("ÿ"+u,h[u]);for(var C=/\b([a-zA-Z_:][a-zA-Z0-9_\-\.:]*)=['"]/g;o=C.exec(t);){var T=o[1].toLowerCase();"dtlinstruction"!=T&&(T!=o[1]&&(this._uppers[T]=o[1]),this._attributes[T]=!0)}var a=document.createElement("div");a.innerHTML=t;for(var S={nodes:[]};a.childNodes.length;)S.nodes.push(a.removeChild(a.childNodes[0]));return S},tokenize:function(e){for(var t,i=[],a=0;t=e[a++];)1!=t.nodeType?this.__tokenize(t,i):this._tokenize(t,i);return i},_swallowed:[],_tokenize:function(i,a){var r,o,n,d=!1,s=this._swallowed;if(!a.first){d=a.first=!0;var h=t.register.getAttributeTags();for(r=0;o=h[r];r++)try{o[2]({swallowNode:function(){throw 1}},new t.Token(t.TOKEN_ATTR,""))}catch(u){s.push(o)}}for(r=0;o=s[r];r++){var m=i.getAttribute(o[0]);if(m){var s=!1,c=o[2]({swallowNode:function(){return s=!0,i}},new t.Token(t.TOKEN_ATTR,o[0]+" "+m));if(s)return i.parentNode&&i.parentNode.removeChild&&i.parentNode.removeChild(i),void a.push([t.TOKEN_CUSTOM,c])}}var f=[];if(l("ie")&&"SCRIPT"==i.tagName)f.push({nodeType:3,data:i.text}),i.text="";else for(r=0;n=i.childNodes[r];r++)f.push(n);a.push([t.TOKEN_NODE,i]);var y=!1;f.length&&(a.push([t.TOKEN_CHANGE,i]),y=!0);for(var p in this._attributes){var v=!1,g="";if("class"==p)g=i.className||g;else if("for"==p)g=i.htmlFor||g;else{if("value"==p&&i.value==i.innerHTML)continue;if(i.getAttribute)if(g=i.getAttribute(p,2)||g,"href"==p||"src"==p){if(l("ie")){var M=location.href.lastIndexOf(location.hash),b=location.href.substring(0,M).split("/");b.pop(),b=b.join("/")+"/",0==g.indexOf(b)&&(g=g.replace(b,"")),g=decodeURIComponent(g)}}else"tstyle"==p?(v=p,p="style"):t.BOOLS[p.slice(1)]&&e.trim(g)?p=p.slice(1):this._uppers[p]&&e.trim(g)&&(v=this._uppers[p])}v&&(i.setAttribute(v,""),i.removeAttribute(v)),"function"==typeof g&&(g=g.toString().replace(this._re4,"$1")),y||(a.push([t.TOKEN_CHANGE,i]),y=!0),a.push([t.TOKEN_ATTR,i,p,g])}for(r=0,n;n=f[r];r++){if(1==n.nodeType){var _=n.getAttribute("dtlinstruction");_&&(n.parentNode.removeChild(n),n={nodeType:8,data:_})}this.__tokenize(n,a)}!d&&i.parentNode&&i.parentNode.tagName?(y&&a.push([t.TOKEN_CHANGE,i,!0]),a.push([t.TOKEN_CHANGE,i.parentNode]),i.parentNode.removeChild(i)):a.push([t.TOKEN_CHANGE,i,!0,!0])},__tokenize:function(i,a){var r=i.data;switch(i.nodeType){case 1:return void this._tokenize(i,a);case 3:if(!r.match(/[^\s\n]/)||-1==r.indexOf("{{")&&-1==r.indexOf("{%"))a.push([i.nodeType,i]);else for(var o,n=h.tokenize(r),d=0;o=n[d];d++)"string"==typeof o?a.push([t.TOKEN_TEXT,o]):a.push(o);return void(i.parentNode&&i.parentNode.removeChild(i));case 8:if(0==r.indexOf("{%")){var o=e.trim(r.slice(2,-2));if("load "==o.substr(0,5))for(var s,l=e.trim(o).split(/\s+/g),u=1;s=l[u];u++)/\./.test(s)&&(s=s.replace(/\./g,"/")),require([s]);a.push([t.TOKEN_BLOCK,o])}return 0==r.indexOf("{{")&&a.push([t.TOKEN_VAR,e.trim(r.slice(2,-2))]),void(i.parentNode&&i.parentNode.removeChild(i))}}};return t.DomTemplate=e.extend(function(e){if(!e.nodes){var i=r.byId(e);i&&1==i.nodeType?(d.forEach(["class","src","href","name","value"],function(e){u._attributes[e]=!0}),e={nodes:[i]}):("object"==typeof e&&(e=h.getTemplateString(e)),e=u.getTemplate(e))}var a=u.tokenize(e.nodes);t.tests&&(this.tokens=a.slice(0));var o=new t._DomParser(a);this.nodelist=o.parse()},{_count:0,_re:/\bdojo:([a-zA-Z0-9_]+)\b/g,setClass:function(e){this.getRootNode().className=e},getRootNode:function(){return this.buffer.rootNode},getBuffer:function(){return new t.DomBuffer},render:function(e,i){i=this.buffer=i||this.getBuffer(),this.rootNode=null;for(var a,r=this.nodelist.render(e||new t.Context({}),i),o=0;a=i._cache[o];o++)a._cache&&(a._cache.length=0);return r},unrender:function(e,t){return this.nodelist.unrender(e,t)}}),t.DomBuffer=e.extend(function(e){this._parent=e,this._cache=[]},{concat:function(t){var i=this._parent;if(i&&t.parentNode&&t.parentNode===i&&!i._dirty)return this;if(1==t.nodeType&&!this.rootNode)return this.rootNode=t||!0,this;if(!i){if(3==t.nodeType&&e.trim(t.data))throw new Error("Text should not exist outside of the root node in template");return this}if(this._closed){if(3!=t.nodeType||e.trim(t.data))throw new Error("Content should not exist outside of the root node in template");return this}if(i._dirty){if(t._drawn&&t.parentNode==i){var a=i._cache;if(a){for(var r,o=0;r=a[o];o++)this.onAddNode&&this.onAddNode(r),i.insertBefore(r,t),this.onAddNodeComplete&&this.onAddNodeComplete(r);a.length=0}}i._dirty=!1}return i._cache||(i._cache=[],this._cache.push(i)),i._dirty=!0,i._cache.push(t),this},remove:function(e){if("string"==typeof e)this._parent&&this._parent.removeAttribute(e);else{if(1==e.nodeType&&!this.getRootNode()&&!this._removed)return this._removed=!0,this;e.parentNode&&(this.onRemoveNode&&this.onRemoveNode(e),e.parentNode&&e.parentNode.removeChild(e))}return this},setAttribute:function(e,t){var i=n.attr(this._parent,e);return this.onChangeAttribute&&i!=t&&this.onChangeAttribute(this._parent,e,i,t),"style"==e?this._parent.style.cssText=t:(n.attr(this._parent,e,t),"value"==e&&this._parent.setAttribute(e,t)),this},addEvent:function(t,i,a,r){if(!t.getThis())throw new Error("You must use Context.setObject(instance)");this.onAddEvent&&this.onAddEvent(this.getParent(),i,a);var o=a;return e.isArray(r)&&(o=function(e){this[a].apply(this,[e].concat(r))}),s.connect(this.getParent(),i,t.getThis(),o)},setParent:function(e,t,i){if(this._parent||(this._parent=this._first=e),t&&i&&e===this._first&&(this._closed=!0),t){var a=this._parent,r="",o=l("ie")&&"SCRIPT"==a.tagName;if(o&&(a.text=""),a._dirty){for(var n,d=a._cache,s="SELECT"==a.tagName&&!a.options.length,h=0;n=d[h];h++)n!==a&&(this.onAddNode&&this.onAddNode(n),o?r+=n.data:(a.appendChild(n),s&&n.defaultSelected&&h&&(s=h)),this.onAddNodeComplete&&this.onAddNodeComplete(n));s&&(a.options.selectedIndex="number"==typeof s?s:0),d.length=0,a._dirty=!1}o&&(a.text=r)}return this._parent=e,this.onSetParent&&this.onSetParent(e,t,i),this},getParent:function(){return this._parent},getRootNode:function(){return this.rootNode}}),t._DomNode=e.extend(function(e){this.contents=e},{render:function(e,t){return this._rendered=!0,t.concat(this.contents)},unrender:function(e,t){return this._rendered?(this._rendered=!1,t.remove(this.contents)):t},clone:function(e){return new this.constructor(this.contents)}}),t._DomNodeList=e.extend(function(e){this.contents=e||[]},{push:function(e){this.contents.push(e)},unshift:function(e){this.contents.unshift(e)},render:function(e,i,a){if(i=i||t.DomTemplate.prototype.getBuffer(),a)var r=i.getParent();for(var o=0;o<this.contents.length;o++)if(i=this.contents[o].render(e,i),!i)throw new Error("Template node render functions must return their buffer");return r&&i.setParent(r),i},dummyRender:function(e,i,a){var r=document.createElement("div"),n=i.getParent(),d=n._clone;n._clone=r;var s=this.clone(i,r);if(d?n._clone=d:n._clone=null,i=t.DomTemplate.prototype.getBuffer(),s.unshift(new t.ChangeNode(r)),s.unshift(new t._DomNode(r)),s.push(new t.ChangeNode(r,!0)),s.render(e,i),a)return i.getRootNode();var h=r.innerHTML;return l("ie")?o.replace(/\s*_(dirty|clone)="[^"]*"/g,""):h},unrender:function(e,t,i){if(i)var a=t.getParent();for(var r=0;r<this.contents.length;r++)if(t=this.contents[r].unrender(e,t),!t)throw new Error("Template node render functions must return their buffer");return a&&t.setParent(a),t},clone:function(e){for(var i=e.getParent(),a=this.contents,r=new t._DomNodeList,o=[],n=0;n<a.length;n++){var d=a[n].clone(e);if(d instanceof t.ChangeNode||d instanceof t._DomNode){var s=d.contents._clone;if(s)d.contents=s;else if(i!=d.contents&&d instanceof t._DomNode){var l=d.contents;d.contents=d.contents.cloneNode(!1),e.onClone&&e.onClone(l,d.contents),o.push(l),l._clone=d.contents}}r.push(d)}for(var d,n=0;d=o[n];n++)d._clone=null;return r},rtrim:function(){for(;;){var e=this.contents.length-1;if(!(this.contents[e]instanceof t._DomTextNode&&this.contents[e].isEmpty()))break;this.contents.pop()}return this}}),t._DomVarNode=e.extend(function(e){this.contents=new t._Filter(e)},{render:function(e,i){var a=this.contents.resolve(e),r="text";switch(a&&(a.render&&a.getRootNode?r="injection":a.safe&&(a.nodeType?r="node":a.toString&&(a=a.toString(),r="html"))),this._type&&r!=this._type&&this.unrender(e,i),this._type=r,r){case"text":if(this._rendered=!0,this._txt=this._txt||document.createTextNode(a),this._txt.data!=a){var o=this._txt.data;this._txt.data=a,i.onChangeData&&i.onChangeData(this._txt,o,this._txt.data)}return i.concat(this._txt);case"injection":var n=a.getRootNode();this._rendered&&n!=this._root&&(i=this.unrender(e,i)),this._root=n;var d=this._injected=new t._DomNodeList;return d.push(new t.ChangeNode(i.getParent())),d.push(new t._DomNode(n)),d.push(a),d.push(new t.ChangeNode(i.getParent())),this._rendered=!0,d.render(e,i);case"node":return this._rendered=!0,this._node&&this._node!=a&&this._node.parentNode&&this._node.parentNode===i.getParent()&&this._node.parentNode.removeChild(this._node),this._node=a,i.concat(a);case"html":if(this._rendered&&this._src!=a&&(i=this.unrender(e,i)),this._src=a,!this._rendered){this._rendered=!0,this._html=this._html||[];var s=this._div=this._div||document.createElement("div");s.innerHTML=a;for(var l=s.childNodes;l.length;){var h=s.removeChild(l[0]);this._html.push(h),i=i.concat(h)}}return i;default:return i}},unrender:function(e,t){if(!this._rendered)return t;switch(this._rendered=!1,this._type){case"text":return t.remove(this._txt);case"injection":return this._injection.unrender(e,t);case"node":return this._node.parentNode===t.getParent()?t.remove(this._node):t;case"html":for(var i=0,a=this._html.length;a>i;i++)t=t.remove(this._html[i]);return t;default:return t}},clone:function(){return new this.constructor(this.contents.getExpression())}}),t.ChangeNode=e.extend(function(e,t,i){this.contents=e,this.up=t,this.root=i},{render:function(e,t){return t.setParent(this.contents,this.up,this.root)},unrender:function(e,t){return t.getParent()?t.setParent(this.contents):t},clone:function(){return new this.constructor(this.contents,this.up,this.root)}}),t.AttributeNode=e.extend(function(e,i){this.key=e,this.value=i,this.contents=i,this._pool[i]?this.nodelist=this._pool[i]:((this.nodelist=t.quickFilter(i))||(this.nodelist=new t.Template(i,!0).nodelist),this._pool[i]=this.nodelist),this.contents=""},{_pool:{},render:function(e,i){var a=this.key,r=this.nodelist.dummyRender(e);return t.BOOLS[a]&&(r=!("false"==r||"undefined"==r||!r)),r!==this.contents?(this.contents=r,i.setAttribute(a,r)):i},unrender:function(e,t){return this.contents="",t.remove(this.key)},clone:function(e){return new this.constructor(this.key,this.value)}}),t._DomTextNode=e.extend(function(e){this.contents=document.createTextNode(e),this.upcoming=e},{set:function(e){return this.upcoming=e,this},render:function(e,t){if(this.contents.data!=this.upcoming){var i=this.contents.data;this.contents.data=this.upcoming,t.onChangeData&&t.onChangeData(this.contents,i,this.upcoming)}return t.concat(this.contents)},unrender:function(e,t){return t.remove(this.contents)},isEmpty:function(){return!e.trim(this.contents.data)},clone:function(){return new this.constructor(this.contents.data)}}),t._DomParser=e.extend(function(e){this.contents=e},{i:0,parse:function(i){var a={},r=this.contents;i||(i=[]);for(var o=0;o<i.length;o++)a[i[o]]=!0;for(var d=new t._DomNodeList;this.i<r.length;){var s=r[this.i++],l=s[0],u=s[1];if(l==t.TOKEN_CUSTOM)d.push(u);else if(l==t.TOKEN_CHANGE){var m=new t.ChangeNode(u,s[2],s[3]);u[m.attr]=m,d.push(m)}else if(l==t.TOKEN_ATTR){var c=h.getTag("attr:"+s[2],!0);if(c&&s[3])-1==s[3].indexOf("{%")&&-1==s[3].indexOf("{{")||u.setAttribute(s[2],""),d.push(c(null,new t.Token(l,s[2]+" "+s[3])));else if(e.isString(s[3]))if("style"==s[2]||-1!=s[3].indexOf("{%")||-1!=s[3].indexOf("{{"))d.push(new t.AttributeNode(s[2],s[3]));else if(e.trim(s[3]))try{n.attr(u,s[2],s[3])}catch(f){}}else if(l==t.TOKEN_NODE){var c=h.getTag("node:"+u.tagName.toLowerCase(),!0);c&&d.push(c(null,new t.Token(l,u),u.tagName.toLowerCase())),d.push(new t._DomNode(u))}else if(l==t.TOKEN_VAR)d.push(new t._DomVarNode(u));else if(l==t.TOKEN_TEXT)d.push(new t._DomTextNode(u.data||u));else if(l==t.TOKEN_BLOCK){if(a[u])return--this.i,d;var y=u.split(/\s+/g);if(y.length){y=y[0];var c=h.getTag(y);if("function"!=typeof c)throw new Error("Function not found for "+y);var p=c(this,new t.Token(l,u));p&&d.push(p)}}}if(i.length)throw new Error("Could not find closing tag(s): "+i.toString());return d},next_token:function(){var e=this.contents[this.i++];return new t.Token(e[0],e[1])},delete_first_token:function(){this.i++},skip_past:function(e){return t._Parser.prototype.skip_past.call(this,e)},create_variable_node:function(e){return new t._DomVarNode(e)},create_text_node:function(e){return new t._DomTextNode(e||"")},getTemplate:function(e){return new t.DomTemplate(u.getTemplate(e))}}),u});//# sourceMappingURL=dom.js.map