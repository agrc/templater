//>>built
define("dojox/dtl/dom",["dojo/_base/lang","./_base","dojox/string/tokenize","./Context","dojo/dom","dojo/dom-construct","dojo/_base/html","dojo/_base/array","dojo/_base/connect","dojo/_base/sniff"],function(e,t,i,a,r,n,o,s,d,l){t.BOOLS={checked:1,disabled:1,readonly:1},t.TOKEN_CHANGE=-11,t.TOKEN_ATTR=-12,t.TOKEN_CUSTOM=-13,t.TOKEN_NODE=1;var u=t.text,c=t.dom={_attributes:{},_uppers:{},_re4:/^function anonymous\(\)\s*{\s*(.*)\s*}$/,_reTrim:/(?:^[\n\s]*(\{%)?\s*|\s*(%\})?[\n\s]*$)/g,_reSplit:/\s*%\}[\n\s]*\{%\s*/g,getTemplate:function(t){if("undefined"==typeof this._commentable){this._commentable=!1;var a=document.createElement("div"),r="Test comment handling, and long comments, using comments whenever possible.";a.innerHTML="<!--"+r+"-->",a.childNodes.length&&8==a.firstChild.nodeType&&a.firstChild.data==r&&(this._commentable=!0)}this._commentable||(t=t.replace(/<!--({({|%).*?(%|})})-->/g,"$1")),l("ie")&&(t=t.replace(/\b(checked|disabled|readonly|style)="/g,'t$1="')),t=t.replace(/\bstyle="/g,'tstyle="');for(var n,o,s=l("webkit"),d=[[!0,"select","option"],[s,"tr","td|th"],[s,"thead","tr","th"],[s,"tbody","tr","td"],[s,"table","tbody|thead|tr","tr","td"]],u=[],c=0;o=d[c];c++)if(o[0]&&-1!=t.indexOf("<"+o[1]))for(var h=new RegExp("<"+o[1]+"(?:.|\n)*?>((?:.|\n)+?)</"+o[1]+">","ig");n=h.exec(t);){for(var f,m=o[2].split("|"),y=[],p=0;f=m[p];p++)y.push("<"+f+"(?:.|\n)*?>(?:.|\n)*?</"+f+">");var v=[],g=i(n[1],new RegExp("("+y.join("|")+")","ig"),function(e){var t=/<(\w+)/.exec(e)[1];return v[t]||(v[t]=!0,v.push(t)),{data:e}});if(v.length){for(var b=1==v.length?v[0]:o[2].split("|")[0],M=[],p=0,w=g.length;w>p;p++){var _=g[p];if(e.isObject(_))M.push(_.data);else{var k=_.replace(this._reTrim,"");if(!k)continue;_=k.split(this._reSplit);for(var j=0,x=_.length;x>j;j++){for(var F="",I=2,E=o.length;E>I;I++)if(2==I)F+="<"+b+' dtlinstruction="{% '+_[j].replace('"','\\"')+' %}">';else{if(b==o[I])continue;F+="<"+o[I]+">"}F+="DTL";for(var I=o.length-1;I>1;I--)if(2==I)F+="</"+b+">";else{if(b==o[I])continue;F+="</"+o[I]+">"}M.push("ÿ"+u.length),u.push(F)}}}t=t.replace(n[1],M.join(""))}}for(var c=u.length;c--;)t=t.replace("ÿ"+c,u[c]);for(var T=/\b([a-zA-Z_:][a-zA-Z0-9_\-\.:]*)=['"]/g;n=T.exec(t);){var A=n[1].toLowerCase();"dtlinstruction"!=A&&(A!=n[1]&&(this._uppers[A]=n[1]),this._attributes[A]=!0)}var a=document.createElement("div");a.innerHTML=t;for(var C={nodes:[]};a.childNodes.length;)C.nodes.push(a.removeChild(a.childNodes[0]));return C},tokenize:function(e){for(var t,i=[],a=0;t=e[a++];)1!=t.nodeType?this.__tokenize(t,i):this._tokenize(t,i);return i},_swallowed:[],_tokenize:function(i,a){var r,n,o,s=!1,d=this._swallowed;if(!a.first){s=a.first=!0;var u=t.register.getAttributeTags();for(r=0;n=u[r];r++)try{n[2]({swallowNode:function(){throw 1}},new t.Token(t.TOKEN_ATTR,""))}catch(c){d.push(n)}}for(r=0;n=d[r];r++){var h=i.getAttribute(n[0]);if(h){var d=!1,f=n[2]({swallowNode:function(){return d=!0,i}},new t.Token(t.TOKEN_ATTR,n[0]+" "+h));if(d)return i.parentNode&&i.parentNode.removeChild&&i.parentNode.removeChild(i),void a.push([t.TOKEN_CUSTOM,f])}}var m=[];if(l("ie")&&"SCRIPT"==i.tagName)m.push({nodeType:3,data:i.text}),i.text="";else for(r=0;o=i.childNodes[r];r++)m.push(o);a.push([t.TOKEN_NODE,i]);var y=!1;m.length&&(a.push([t.TOKEN_CHANGE,i]),y=!0);for(var p in this._attributes){var v=!1,g="";if("class"==p)g=i.className||g;else if("for"==p)g=i.htmlFor||g;else{if("value"==p&&i.value==i.innerHTML)continue;if(i.getAttribute)if(g=i.getAttribute(p,2)||g,"href"==p||"src"==p){if(l("ie")){var b=location.href.lastIndexOf(location.hash),M=location.href.substring(0,b).split("/");M.pop(),M=M.join("/")+"/",0==g.indexOf(M)&&(g=g.replace(M,"")),g=decodeURIComponent(g)}}else"tstyle"==p?(v=p,p="style"):t.BOOLS[p.slice(1)]&&e.trim(g)?p=p.slice(1):this._uppers[p]&&e.trim(g)&&(v=this._uppers[p])}v&&(i.setAttribute(v,""),i.removeAttribute(v)),"function"==typeof g&&(g=g.toString().replace(this._re4,"$1")),y||(a.push([t.TOKEN_CHANGE,i]),y=!0),a.push([t.TOKEN_ATTR,i,p,g])}for(r=0,o;o=m[r];r++){if(1==o.nodeType){var w=o.getAttribute("dtlinstruction");w&&(o.parentNode.removeChild(o),o={nodeType:8,data:w})}this.__tokenize(o,a)}!s&&i.parentNode&&i.parentNode.tagName?(y&&a.push([t.TOKEN_CHANGE,i,!0]),a.push([t.TOKEN_CHANGE,i.parentNode]),i.parentNode.removeChild(i)):a.push([t.TOKEN_CHANGE,i,!0,!0])},__tokenize:function(i,a){var r=i.data;switch(i.nodeType){case 1:return void this._tokenize(i,a);case 3:if(!r.match(/[^\s\n]/)||-1==r.indexOf("{{")&&-1==r.indexOf("{%"))a.push([i.nodeType,i]);else for(var n,o=u.tokenize(r),s=0;n=o[s];s++)"string"==typeof n?a.push([t.TOKEN_TEXT,n]):a.push(n);return void(i.parentNode&&i.parentNode.removeChild(i));case 8:if(0==r.indexOf("{%")){var n=e.trim(r.slice(2,-2));if("load "==n.substr(0,5))for(var d,l=e.trim(n).split(/\s+/g),c=1;d=l[c];c++)/\./.test(d)&&(d=d.replace(/\./g,"/")),require([d]);a.push([t.TOKEN_BLOCK,n])}return 0==r.indexOf("{{")&&a.push([t.TOKEN_VAR,e.trim(r.slice(2,-2))]),void(i.parentNode&&i.parentNode.removeChild(i))}}};return t.DomTemplate=e.extend(function(e){if(!e.nodes){var i=r.byId(e);i&&1==i.nodeType?(s.forEach(["class","src","href","name","value"],function(e){c._attributes[e]=!0}),e={nodes:[i]}):("object"==typeof e&&(e=u.getTemplateString(e)),e=c.getTemplate(e))}var a=c.tokenize(e.nodes);t.tests&&(this.tokens=a.slice(0));var n=new t._DomParser(a);this.nodelist=n.parse()},{_count:0,_re:/\bdojo:([a-zA-Z0-9_]+)\b/g,setClass:function(e){this.getRootNode().className=e},getRootNode:function(){return this.buffer.rootNode},getBuffer:function(){return new t.DomBuffer},render:function(e,i){i=this.buffer=i||this.getBuffer(),this.rootNode=null;for(var a,r=this.nodelist.render(e||new t.Context({}),i),n=0;a=i._cache[n];n++)a._cache&&(a._cache.length=0);return r},unrender:function(e,t){return this.nodelist.unrender(e,t)}}),t.DomBuffer=e.extend(function(e){this._parent=e,this._cache=[]},{concat:function(t){var i=this._parent;if(i&&t.parentNode&&t.parentNode===i&&!i._dirty)return this;if(1==t.nodeType&&!this.rootNode)return this.rootNode=t||!0,this;if(!i){if(3==t.nodeType&&e.trim(t.data))throw new Error("Text should not exist outside of the root node in template");return this}if(this._closed){if(3!=t.nodeType||e.trim(t.data))throw new Error("Content should not exist outside of the root node in template");return this}if(i._dirty){if(t._drawn&&t.parentNode==i){var a=i._cache;if(a){for(var r,n=0;r=a[n];n++)this.onAddNode&&this.onAddNode(r),i.insertBefore(r,t),this.onAddNodeComplete&&this.onAddNodeComplete(r);a.length=0}}i._dirty=!1}return i._cache||(i._cache=[],this._cache.push(i)),i._dirty=!0,i._cache.push(t),this},remove:function(e){if("string"==typeof e)this._parent&&this._parent.removeAttribute(e);else{if(1==e.nodeType&&!this.getRootNode()&&!this._removed)return this._removed=!0,this;e.parentNode&&(this.onRemoveNode&&this.onRemoveNode(e),e.parentNode&&e.parentNode.removeChild(e))}return this},setAttribute:function(e,t){var i=o.attr(this._parent,e);return this.onChangeAttribute&&i!=t&&this.onChangeAttribute(this._parent,e,i,t),"style"==e?this._parent.style.cssText=t:(o.attr(this._parent,e,t),"value"==e&&this._parent.setAttribute(e,t)),this},addEvent:function(t,i,a,r){if(!t.getThis())throw new Error("You must use Context.setObject(instance)");this.onAddEvent&&this.onAddEvent(this.getParent(),i,a);var n=a;return e.isArray(r)&&(n=function(e){this[a].apply(this,[e].concat(r))}),d.connect(this.getParent(),i,t.getThis(),n)},setParent:function(e,t,i){if(this._parent||(this._parent=this._first=e),t&&i&&e===this._first&&(this._closed=!0),t){var a=this._parent,r="",n=l("ie")&&"SCRIPT"==a.tagName;if(n&&(a.text=""),a._dirty){for(var o,s=a._cache,d="SELECT"==a.tagName&&!a.options.length,u=0;o=s[u];u++)o!==a&&(this.onAddNode&&this.onAddNode(o),n?r+=o.data:(a.appendChild(o),d&&o.defaultSelected&&u&&(d=u)),this.onAddNodeComplete&&this.onAddNodeComplete(o));d&&(a.options.selectedIndex="number"==typeof d?d:0),s.length=0,a._dirty=!1}n&&(a.text=r)}return this._parent=e,this.onSetParent&&this.onSetParent(e,t,i),this},getParent:function(){return this._parent},getRootNode:function(){return this.rootNode}}),t._DomNode=e.extend(function(e){this.contents=e},{render:function(e,t){return this._rendered=!0,t.concat(this.contents)},unrender:function(e,t){return this._rendered?(this._rendered=!1,t.remove(this.contents)):t},clone:function(e){return new this.constructor(this.contents)}}),t._DomNodeList=e.extend(function(e){this.contents=e||[]},{push:function(e){this.contents.push(e)},unshift:function(e){this.contents.unshift(e)},render:function(e,i,a){if(i=i||t.DomTemplate.prototype.getBuffer(),a)var r=i.getParent();for(var n=0;n<this.contents.length;n++)if(i=this.contents[n].render(e,i),!i)throw new Error("Template node render functions must return their buffer");return r&&i.setParent(r),i},dummyRender:function(e,i,a){var r=document.createElement("div"),o=i.getParent(),s=o._clone;o._clone=r;var d=this.clone(i,r);if(s?o._clone=s:o._clone=null,i=t.DomTemplate.prototype.getBuffer(),d.unshift(new t.ChangeNode(r)),d.unshift(new t._DomNode(r)),d.push(new t.ChangeNode(r,!0)),d.render(e,i),a)return i.getRootNode();var u=r.innerHTML;return l("ie")?n.replace(/\s*_(dirty|clone)="[^"]*"/g,""):u},unrender:function(e,t,i){if(i)var a=t.getParent();for(var r=0;r<this.contents.length;r++)if(t=this.contents[r].unrender(e,t),!t)throw new Error("Template node render functions must return their buffer");return a&&t.setParent(a),t},clone:function(e){for(var i=e.getParent(),a=this.contents,r=new t._DomNodeList,n=[],o=0;o<a.length;o++){var s=a[o].clone(e);if(s instanceof t.ChangeNode||s instanceof t._DomNode){var d=s.contents._clone;if(d)s.contents=d;else if(i!=s.contents&&s instanceof t._DomNode){var l=s.contents;s.contents=s.contents.cloneNode(!1),e.onClone&&e.onClone(l,s.contents),n.push(l),l._clone=s.contents}}r.push(s)}for(var s,o=0;s=n[o];o++)s._clone=null;return r},rtrim:function(){for(;;){var e=this.contents.length-1;if(!(this.contents[e]instanceof t._DomTextNode&&this.contents[e].isEmpty()))break;this.contents.pop()}return this}}),t._DomVarNode=e.extend(function(e){this.contents=new t._Filter(e)},{render:function(e,i){var a=this.contents.resolve(e),r="text";switch(a&&(a.render&&a.getRootNode?r="injection":a.safe&&(a.nodeType?r="node":a.toString&&(a=a.toString(),r="html"))),this._type&&r!=this._type&&this.unrender(e,i),this._type=r,r){case"text":if(this._rendered=!0,this._txt=this._txt||document.createTextNode(a),this._txt.data!=a){var n=this._txt.data;this._txt.data=a,i.onChangeData&&i.onChangeData(this._txt,n,this._txt.data)}return i.concat(this._txt);case"injection":var o=a.getRootNode();this._rendered&&o!=this._root&&(i=this.unrender(e,i)),this._root=o;var s=this._injected=new t._DomNodeList;return s.push(new t.ChangeNode(i.getParent())),s.push(new t._DomNode(o)),s.push(a),s.push(new t.ChangeNode(i.getParent())),this._rendered=!0,s.render(e,i);case"node":return this._rendered=!0,this._node&&this._node!=a&&this._node.parentNode&&this._node.parentNode===i.getParent()&&this._node.parentNode.removeChild(this._node),this._node=a,i.concat(a);case"html":if(this._rendered&&this._src!=a&&(i=this.unrender(e,i)),this._src=a,!this._rendered){this._rendered=!0,this._html=this._html||[];var d=this._div=this._div||document.createElement("div");d.innerHTML=a;for(var l=d.childNodes;l.length;){var u=d.removeChild(l[0]);this._html.push(u),i=i.concat(u)}}return i;default:return i}},unrender:function(e,t){if(!this._rendered)return t;switch(this._rendered=!1,this._type){case"text":return t.remove(this._txt);case"injection":return this._injection.unrender(e,t);case"node":return this._node.parentNode===t.getParent()?t.remove(this._node):t;case"html":for(var i=0,a=this._html.length;a>i;i++)t=t.remove(this._html[i]);return t;default:return t}},clone:function(){return new this.constructor(this.contents.getExpression())}}),t.ChangeNode=e.extend(function(e,t,i){this.contents=e,this.up=t,this.root=i},{render:function(e,t){return t.setParent(this.contents,this.up,this.root)},unrender:function(e,t){return t.getParent()?t.setParent(this.contents):t},clone:function(){return new this.constructor(this.contents,this.up,this.root)}}),t.AttributeNode=e.extend(function(e,i){this.key=e,this.value=i,this.contents=i,this._pool[i]?this.nodelist=this._pool[i]:((this.nodelist=t.quickFilter(i))||(this.nodelist=new t.Template(i,!0).nodelist),this._pool[i]=this.nodelist),this.contents=""},{_pool:{},render:function(e,i){var a=this.key,r=this.nodelist.dummyRender(e);return t.BOOLS[a]&&(r=!("false"==r||"undefined"==r||!r)),r!==this.contents?(this.contents=r,i.setAttribute(a,r)):i},unrender:function(e,t){return this.contents="",t.remove(this.key)},clone:function(e){return new this.constructor(this.key,this.value)}}),t._DomTextNode=e.extend(function(e){this.contents=document.createTextNode(e),this.upcoming=e},{set:function(e){return this.upcoming=e,this},render:function(e,t){if(this.contents.data!=this.upcoming){var i=this.contents.data;this.contents.data=this.upcoming,t.onChangeData&&t.onChangeData(this.contents,i,this.upcoming)}return t.concat(this.contents)},unrender:function(e,t){return t.remove(this.contents)},isEmpty:function(){return!e.trim(this.contents.data)},clone:function(){return new this.constructor(this.contents.data)}}),t._DomParser=e.extend(function(e){this.contents=e},{i:0,parse:function(i){var a={},r=this.contents;i||(i=[]);for(var n=0;n<i.length;n++)a[i[n]]=!0;for(var s=new t._DomNodeList;this.i<r.length;){var d=r[this.i++],l=d[0],c=d[1];if(l==t.TOKEN_CUSTOM)s.push(c);else if(l==t.TOKEN_CHANGE){var h=new t.ChangeNode(c,d[2],d[3]);c[h.attr]=h,s.push(h)}else if(l==t.TOKEN_ATTR){var f=u.getTag("attr:"+d[2],!0);if(f&&d[3])-1==d[3].indexOf("{%")&&-1==d[3].indexOf("{{")||c.setAttribute(d[2],""),s.push(f(null,new t.Token(l,d[2]+" "+d[3])));else if(e.isString(d[3]))if("style"==d[2]||-1!=d[3].indexOf("{%")||-1!=d[3].indexOf("{{"))s.push(new t.AttributeNode(d[2],d[3]));else if(e.trim(d[3]))try{o.attr(c,d[2],d[3])}catch(m){}}else if(l==t.TOKEN_NODE){var f=u.getTag("node:"+c.tagName.toLowerCase(),!0);f&&s.push(f(null,new t.Token(l,c),c.tagName.toLowerCase())),s.push(new t._DomNode(c))}else if(l==t.TOKEN_VAR)s.push(new t._DomVarNode(c));else if(l==t.TOKEN_TEXT)s.push(new t._DomTextNode(c.data||c));else if(l==t.TOKEN_BLOCK){if(a[c])return--this.i,s;var y=c.split(/\s+/g);if(y.length){y=y[0];var f=u.getTag(y);if("function"!=typeof f)throw new Error("Function not found for "+y);var p=f(this,new t.Token(l,c));p&&s.push(p)}}}if(i.length)throw new Error("Could not find closing tag(s): "+i.toString());return s},next_token:function(){var e=this.contents[this.i++];return new t.Token(e[0],e[1])},delete_first_token:function(){this.i++},skip_past:function(e){return t._Parser.prototype.skip_past.call(this,e)},create_variable_node:function(e){return new t._DomVarNode(e)},create_text_node:function(e){return new t._DomTextNode(e||"")},getTemplate:function(e){return new t.DomTemplate(c.getTemplate(e))}}),c});//# sourceMappingURL=dom.js.map