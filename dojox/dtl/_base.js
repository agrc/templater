//>>built
define("dojox/dtl/_base",["dojo/_base/kernel","dojo/_base/lang","dojox/string/tokenize","dojo/_base/json","dojo/dom","dojo/_base/xhr","dojox/string/Builder","dojo/_base/Deferred"],function(e,t,a,r,o,n,d,s){e.experimental("dojox.dtl");var l=t.getObject("dojox.dtl",!0);l._base={},l.TOKEN_BLOCK=-1,l.TOKEN_VAR=-2,l.TOKEN_COMMENT=-3,l.TOKEN_TEXT=3,l._Context=t.extend(function(e){e&&(t._mixin(this,e),e.get&&(this._getter=e.get,delete this.get))},{push:function(){var e=this,i=t.delegate(this);return i.pop=function(){return e},i},pop:function(){throw new Error("pop() called on empty Context")},get:function(e,t){var i=this._normalize;if(this._getter){var a=this._getter(e);if(void 0!==a)return i(a)}return void 0!==this[e]?i(this[e]):t},_normalize:function(e){return e instanceof Date&&(e.year=e.getFullYear(),e.month=e.getMonth()+1,e.day=e.getDate(),e.date=e.year+"-"+("0"+e.month).slice(-2)+"-"+("0"+e.day).slice(-2),e.hour=e.getHours(),e.minute=e.getMinutes(),e.second=e.getSeconds(),e.microsecond=e.getMilliseconds()),e},update:function(e){var i=this.push();return e&&t._mixin(this,e),i}});var h=/("(?:[^"\\]*(?:\\.[^"\\]*)*)"|'(?:[^'\\]*(?:\\.[^'\\]*)*)'|[^\s]+)/g,u=/\s+/g,c=function(e,t){if(e=e||u,e instanceof RegExp||(e=new RegExp(e,"g")),!e.global)throw new Error("You must use a globally flagged RegExp with split "+e);e.exec("");for(var i,a=[],r=0,o=0;(i=e.exec(this))&&(a.push(this.slice(r,e.lastIndex-i[0].length)),r=e.lastIndex,!(t&&++o>t-1)););return a.push(this.slice(r)),a};l.Token=function(e,i){this.token_type=e,this.contents=new String(t.trim(i)),this.contents.split=c,this.split=function(){return String.prototype.split.apply(this.contents,arguments)}},l.Token.prototype.split_contents=function(e){var t,i=[],a=0;for(e=e||999;a++<e&&(t=h.exec(this.contents));)t=t[0],'"'==t.charAt(0)&&'"'==t.slice(-1)?i.push('"'+t.slice(1,-1).replace('\\"','"').replace("\\\\","\\")+'"'):"'"==t.charAt(0)&&"'"==t.slice(-1)?i.push("'"+t.slice(1,-1).replace("\\'","'").replace("\\\\","\\")+"'"):i.push(t);return i};var m=l.text={_get:function(e,i,a){var r=l.register.get(e,i.toLowerCase(),a);if(!r){if(!a)throw new Error("No tag found for "+i);return null}var o,n=r[1],d=r[2];-1!=n.indexOf(":")&&(o=n.split(":"),n=o.pop());var s=d;/\./.test(d)&&(d=d.replace(/\./g,"/")),require([d],function(){});var h=t.getObject(s);return h[n||i]||h[i+"_"]||h[n+"_"]},getTag:function(e,t){return m._get("tag",e,t)},getFilter:function(e,t){return m._get("filter",e,t)},getTemplate:function(e){return new l.Template(m.getTemplateString(e))},getTemplateString:function(e){return n._getText(e.toString())||""},_resolveLazy:function(e,t,i){return t?i?i.fromJson(n._getText(e))||{}:l.text.getTemplateString(e):n.get({handleAs:i?"json":"text",url:e})},_resolveTemplateArg:function(e,t){if(m._isTemplate(e)){if(!t){var i=new s;return i.callback(e),i}return e}return m._resolveLazy(e,t)},_isTemplate:function(e){return void 0===e||"string"==typeof e&&(e.match(/^\s*[<{]/)||-1!=e.indexOf(" "))},_resolveContextArg:function(e,t){if(e.constructor==Object){if(!t){var i=new s;return i.callback(e),i}return e}return m._resolveLazy(e,t,!0)},_re:/(?:\{\{\s*(.+?)\s*\}\}|\{%\s*(load\s*)?(.+?)\s*%\})/g,tokenize:function(e){return a(e,m._re,m._parseDelims)},_parseDelims:function(e,i,a){if(e)return[l.TOKEN_VAR,e];if(!i)return[l.TOKEN_BLOCK,a];for(var r,o=t.trim(a).split(/\s+/g),n=0;r=o[n];n++)/\./.test(r)&&(r=r.replace(/\./g,"/")),require([r])}};l.Template=t.extend(function(e,t){var i=t?e:m._resolveTemplateArg(e,!0)||"",a=m.tokenize(i),r=new l._Parser(a);this.nodelist=r.parse()},{update:function(e,t){return m._resolveContextArg(t).addCallback(this,function(t){var i=this.render(new l._Context(t));return e.forEach?e.forEach(function(e){e.innerHTML=i}):o.byId(e).innerHTML=i,this})},render:function(e,t){return t=t||this.getBuffer(),e=e||new l._Context({}),this.nodelist.render(e,t)+""},getBuffer:function(){return new d}});var f=/\{\{\s*(.+?)\s*\}\}/g;l.quickFilter=function(e){return e?-1==e.indexOf("{%")?new l._QuickNodeList(a(e,f,function(e){return new l._Filter(e)})):void 0:new l._NodeList},l._QuickNodeList=t.extend(function(e){this.contents=e},{render:function(e,t){for(var i=0,a=this.contents.length;a>i;i++)t=this.contents[i].resolve?t.concat(this.contents[i].resolve(e)):t.concat(this.contents[i]);return t},dummyRender:function(e){return this.render(e,l.Template.prototype.getBuffer()).toString()},clone:function(e){return this}}),l._Filter=t.extend(function(e){if(!e)throw new Error("Filter must be called with variable name");this.contents=e;var t=this._cache[e];t?(this.key=t[0],this.filters=t[1]):(this.filters=[],a(e,this._re,this._tokenize,this),this._cache[e]=[this.key,this.filters])},{_cache:{},_re:/(?:^_\("([^\\"]*(?:\\.[^\\"])*)"\)|^"([^\\"]*(?:\\.[^\\"]*)*)"|^([a-zA-Z0-9_.]+)|\|(\w+)(?::(?:_\("([^\\"]*(?:\\.[^\\"])*)"\)|"([^\\"]*(?:\\.[^\\"]*)*)"|([a-zA-Z0-9_.]+)|'([^\\']*(?:\\.[^\\']*)*)'))?|^'([^\\']*(?:\\.[^\\']*)*)')/g,_values:{0:'"',1:'"',2:"",8:'"'},_args:{4:'"',5:'"',6:"",7:"'"},_tokenize:function(){for(var e,i,a=0,r=[];a<arguments.length;a++)r[a]=void 0!==arguments[a]&&"string"==typeof arguments[a]&&arguments[a];if(this.key){for(e in this._args)if(r[e]){var o=arguments[e];"'"==this._args[e]?o=o.replace(/\\'/g,"'"):'"'==this._args[e]&&(o=o.replace(/\\"/g,'"')),i=[!this._args[e],o];break}var n=m.getFilter(arguments[3]);if(!t.isFunction(n))throw new Error(arguments[3]+" is not registered as a filter");this.filters.push([n,i])}else for(e in this._values)if(r[e]){this.key=this._values[e]+arguments[e]+this._values[e];break}},getExpression:function(){return this.contents},resolve:function(e){if(void 0===this.key)return"";for(var t,i=this.resolvePath(this.key,e),a=0;t=this.filters[a];a++)i=t[1]?t[1][0]?t[0](i,this.resolvePath(t[1][1],e)):t[0](i,t[1][1]):t[0](i);return i},resolvePath:function(e,i){var a,r,o=e.charAt(0),n=e.slice(-1);if(isNaN(parseInt(o)))if('"'==o&&o==n)a=e.slice(1,-1);else{if("true"==e)return!0;if("false"==e)return!1;if("null"==e||"None"==e)return null;if(r=e.split("."),a=i.get(r[0]),t.isFunction(a)){var d=i.getThis&&i.getThis();a=a.alters_data?"":d?a.call(d):""}for(var s=1;s<r.length;s++){var h=r[s];if(!a)return"";var u=a;if(t.isObject(a)&&"items"==h&&void 0===a[h]){var c=[];for(var m in a)c.push([m,a[m]]);a=c}else{if(a.get&&t.isFunction(a.get)&&a.get.safe)a=a.get(h);else{if(void 0===a[h]){a=a[h];break}a=a[h]}t.isFunction(a)?a=a.alters_data?"":a.call(u):a instanceof Date&&(a=l._Context.prototype._normalize(a))}}}else a=-1==e.indexOf(".")?parseInt(e):parseFloat(e);return a}}),l._TextNode=l._Node=t.extend(function(e){this.contents=e},{set:function(e){return this.contents=e,this},render:function(e,t){return t.concat(this.contents)},isEmpty:function(){return!t.trim(this.contents)},clone:function(){return this}}),l._NodeList=t.extend(function(e){this.contents=e||[],this.last=""},{push:function(e){return this.contents.push(e),this},concat:function(e){return this.contents=this.contents.concat(e),this},render:function(e,t){for(var i=0;i<this.contents.length;i++)if(t=this.contents[i].render(e,t),!t)throw new Error("Template must return buffer");return t},dummyRender:function(e){return this.render(e,l.Template.prototype.getBuffer()).toString()},unrender:function(){return arguments[1]},clone:function(){return this},rtrim:function(){for(;;){if(i=this.contents.length-1,!(this.contents[i]instanceof l._TextNode&&this.contents[i].isEmpty()))break;this.contents.pop()}return this}}),l._VarNode=t.extend(function(e){this.contents=new l._Filter(e)},{render:function(e,t){var i=this.contents.resolve(e)||"";return i.safe||(i=l._base.escape(""+i)),t.concat(i)}}),l._noOpNode=new function(){this.render=this.unrender=function(){return arguments[1]},this.clone=function(){return this}},l._Parser=t.extend(function(e){this.contents=e},{i:0,parse:function(e){var t,i={};e=e||[];for(var a=0;a<e.length;a++)i[e[a]]=!0;for(var r=new l._NodeList;this.i<this.contents.length;)if(t=this.contents[this.i++],"string"==typeof t)r.push(new l._TextNode(t));else{var o=t[0],n=t[1];if(o==l.TOKEN_VAR)r.push(new l._VarNode(n));else if(o==l.TOKEN_BLOCK){if(i[n])return--this.i,r;var d=n.split(/\s+/g);if(d.length){d=d[0];var s=m.getTag(d);s&&r.push(s(this,new l.Token(o,n)))}}}if(e.length)throw new Error("Could not find closing tag(s): "+e.toString());return this.contents.length=0,r},next_token:function(){var e=this.contents[this.i++];return new l.Token(e[0],e[1])},delete_first_token:function(){this.i++},skip_past:function(e){for(;this.i<this.contents.length;){var t=this.contents[this.i++];if(t[0]==l.TOKEN_BLOCK&&t[1]==e)return}throw new Error("Unclosed tag found when looking for "+e)},create_variable_node:function(e){return new l._VarNode(e)},create_text_node:function(e){return new l._TextNode(e||"")},getTemplate:function(e){return new l.Template(e)}}),l.register={_registry:{attributes:[],tags:[],filters:[]},get:function(e,t){for(var i,a=l.register._registry[e+"s"],r=0;i=a[r];r++)if("string"==typeof i[0]){if(i[0]==t)return i}else if(t.match(i[0]))return i},getAttributeTags:function(){for(var e,i=[],a=l.register._registry.attributes,r=0;e=a[r];r++)if(3==e.length)i.push(e);else{var o=t.getObject(e[1]);o&&t.isFunction(o)&&(e.push(o),i.push(e))}return i},_any:function(e,i,a){for(var r in a)for(var o,n=0;o=a[r][n];n++){var d=o;if(t.isArray(o)&&(d=o[0],o=o[1]),"string"==typeof d){if("attr:"==d.substr(0,5)){var s=o;"attr:"==s.substr(0,5)&&(s=s.slice(5)),l.register._registry.attributes.push([s.toLowerCase(),i+"."+r+"."+s])}d=d.toLowerCase()}l.register._registry[e].push([d,o,i+"."+r])}},tags:function(e,t){l.register._any("tags",e,t)},filters:function(e,t){l.register._any("filters",e,t)}};var y=/&/g,p=/</g,g=/>/g,v=/'/g,M=/"/g;return l._base.escape=function(e){return l.mark_safe(e.replace(y,"&amp;").replace(p,"&lt;").replace(g,"&gt;").replace(M,"&quot;").replace(v,"&#39;"))},l._base.safe=function(e){return"string"==typeof e&&(e=new String(e)),"object"==typeof e&&(e.safe=!0),e},l.mark_safe=l._base.safe,l.register.tags("dojox.dtl.tag",{date:["now"],logic:["if","for","ifequal","ifnotequal"],loader:["extends","block","include","load","ssi"],misc:["comment","debug","filter","firstof","spaceless","templatetag","widthratio","with"],loop:["cycle","ifchanged","regroup"]}),l.register.filters("dojox.dtl.filter",{dates:["date","time","timesince","timeuntil"],htmlstrings:["linebreaks","linebreaksbr","removetags","striptags"],integers:["add","get_digit"],lists:["dictsort","dictsortreversed","first","join","length","length_is","random","slice","unordered_list"],logic:["default","default_if_none","divisibleby","yesno"],misc:["filesizeformat","pluralize","phone2numeric","pprint"],strings:["addslashes","capfirst","center","cut","fix_ampersands","floatformat","iriencode","linenumbers","ljust","lower","make_list","rjust","slugify","stringformat","title","truncatewords","truncatewords_html","upper","urlencode","urlize","urlizetrunc","wordcount","wordwrap"]}),l.register.filters("dojox.dtl",{_base:["escape","safe"]}),l});//# sourceMappingURL=_base.js.map