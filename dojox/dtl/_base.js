//>>built
define("dojox/dtl/_base",["dojo/_base/kernel","dojo/_base/lang","dojox/string/tokenize","dojo/_base/json","dojo/dom","dojo/_base/xhr","dojox/string/Builder","dojo/_base/Deferred"],function(e,t,a,r,n,o,s,d){e.experimental("dojox.dtl");var l=t.getObject("dojox.dtl",!0);l._base={},l.TOKEN_BLOCK=-1,l.TOKEN_VAR=-2,l.TOKEN_COMMENT=-3,l.TOKEN_TEXT=3,l._Context=t.extend(function(e){e&&(t._mixin(this,e),e.get&&(this._getter=e.get,delete this.get))},{push:function(){var e=this,i=t.delegate(this);return i.pop=function(){return e},i},pop:function(){throw new Error("pop() called on empty Context")},get:function(e,t){var i=this._normalize;if(this._getter){var a=this._getter(e);if(void 0!==a)return i(a)}return void 0!==this[e]?i(this[e]):t},_normalize:function(e){return e instanceof Date&&(e.year=e.getFullYear(),e.month=e.getMonth()+1,e.day=e.getDate(),e.date=e.year+"-"+("0"+e.month).slice(-2)+"-"+("0"+e.day).slice(-2),e.hour=e.getHours(),e.minute=e.getMinutes(),e.second=e.getSeconds(),e.microsecond=e.getMilliseconds()),e},update:function(e){var i=this.push();return e&&t._mixin(this,e),i}});var u=/("(?:[^"\\]*(?:\\.[^"\\]*)*)"|'(?:[^'\\]*(?:\\.[^'\\]*)*)'|[^\s]+)/g,h=/\s+/g,c=function(e,t){if(e=e||h,e instanceof RegExp||(e=new RegExp(e,"g")),!e.global)throw new Error("You must use a globally flagged RegExp with split "+e);e.exec("");for(var i,a=[],r=0,n=0;(i=e.exec(this))&&(a.push(this.slice(r,e.lastIndex-i[0].length)),r=e.lastIndex,!(t&&++n>t-1)););return a.push(this.slice(r)),a};l.Token=function(e,i){this.token_type=e,this.contents=new String(t.trim(i)),this.contents.split=c,this.split=function(){return String.prototype.split.apply(this.contents,arguments)}},l.Token.prototype.split_contents=function(e){var t,i=[],a=0;for(e=e||999;a++<e&&(t=u.exec(this.contents));)t=t[0],'"'==t.charAt(0)&&'"'==t.slice(-1)?i.push('"'+t.slice(1,-1).replace('\\"','"').replace("\\\\","\\")+'"'):"'"==t.charAt(0)&&"'"==t.slice(-1)?i.push("'"+t.slice(1,-1).replace("\\'","'").replace("\\\\","\\")+"'"):i.push(t);return i};var m=l.text={_get:function(e,i,a){var r=l.register.get(e,i.toLowerCase(),a);if(!r){if(!a)throw new Error("No tag found for "+i);return null}var n,o=r[1],s=r[2];-1!=o.indexOf(":")&&(n=o.split(":"),o=n.pop());var d=s;/\./.test(s)&&(s=s.replace(/\./g,"/")),require([s],function(){});var u=t.getObject(d);return u[o||i]||u[i+"_"]||u[o+"_"]},getTag:function(e,t){return m._get("tag",e,t)},getFilter:function(e,t){return m._get("filter",e,t)},getTemplate:function(e){return new l.Template(m.getTemplateString(e))},getTemplateString:function(e){return o._getText(e.toString())||""},_resolveLazy:function(e,t,i){return t?i?i.fromJson(o._getText(e))||{}:l.text.getTemplateString(e):o.get({handleAs:i?"json":"text",url:e})},_resolveTemplateArg:function(e,t){if(m._isTemplate(e)){if(!t){var i=new d;return i.callback(e),i}return e}return m._resolveLazy(e,t)},_isTemplate:function(e){return void 0===e||"string"==typeof e&&(e.match(/^\s*[<{]/)||-1!=e.indexOf(" "))},_resolveContextArg:function(e,t){if(e.constructor==Object){if(!t){var i=new d;return i.callback(e),i}return e}return m._resolveLazy(e,t,!0)},_re:/(?:\{\{\s*(.+?)\s*\}\}|\{%\s*(load\s*)?(.+?)\s*%\})/g,tokenize:function(e){return a(e,m._re,m._parseDelims)},_parseDelims:function(e,i,a){if(e)return[l.TOKEN_VAR,e];if(!i)return[l.TOKEN_BLOCK,a];for(var r,n=t.trim(a).split(/\s+/g),o=0;r=n[o];o++)/\./.test(r)&&(r=r.replace(/\./g,"/")),require([r])}};l.Template=t.extend(function(e,t){var i=t?e:m._resolveTemplateArg(e,!0)||"",a=m.tokenize(i),r=new l._Parser(a);this.nodelist=r.parse()},{update:function(e,t){return m._resolveContextArg(t).addCallback(this,function(t){var i=this.render(new l._Context(t));return e.forEach?e.forEach(function(e){e.innerHTML=i}):n.byId(e).innerHTML=i,this})},render:function(e,t){return t=t||this.getBuffer(),e=e||new l._Context({}),this.nodelist.render(e,t)+""},getBuffer:function(){return new s}});var f=/\{\{\s*(.+?)\s*\}\}/g;l.quickFilter=function(e){return e?-1==e.indexOf("{%")?new l._QuickNodeList(a(e,f,function(e){return new l._Filter(e)})):void 0:new l._NodeList},l._QuickNodeList=t.extend(function(e){this.contents=e},{render:function(e,t){for(var i=0,a=this.contents.length;a>i;i++)t=this.contents[i].resolve?t.concat(this.contents[i].resolve(e)):t.concat(this.contents[i]);return t},dummyRender:function(e){return this.render(e,l.Template.prototype.getBuffer()).toString()},clone:function(e){return this}}),l._Filter=t.extend(function(e){if(!e)throw new Error("Filter must be called with variable name");this.contents=e;var t=this._cache[e];t?(this.key=t[0],this.filters=t[1]):(this.filters=[],a(e,this._re,this._tokenize,this),this._cache[e]=[this.key,this.filters])},{_cache:{},_re:/(?:^_\("([^\\"]*(?:\\.[^\\"])*)"\)|^"([^\\"]*(?:\\.[^\\"]*)*)"|^([a-zA-Z0-9_.]+)|\|(\w+)(?::(?:_\("([^\\"]*(?:\\.[^\\"])*)"\)|"([^\\"]*(?:\\.[^\\"]*)*)"|([a-zA-Z0-9_.]+)|'([^\\']*(?:\\.[^\\']*)*)'))?|^'([^\\']*(?:\\.[^\\']*)*)')/g,_values:{0:'"',1:'"',2:"",8:'"'},_args:{4:'"',5:'"',6:"",7:"'"},_tokenize:function(){for(var e,i,a=0,r=[];a<arguments.length;a++)r[a]=void 0!==arguments[a]&&"string"==typeof arguments[a]&&arguments[a];if(this.key){for(e in this._args)if(r[e]){var n=arguments[e];"'"==this._args[e]?n=n.replace(/\\'/g,"'"):'"'==this._args[e]&&(n=n.replace(/\\"/g,'"')),i=[!this._args[e],n];break}var o=m.getFilter(arguments[3]);if(!t.isFunction(o))throw new Error(arguments[3]+" is not registered as a filter");this.filters.push([o,i])}else for(e in this._values)if(r[e]){this.key=this._values[e]+arguments[e]+this._values[e];break}},getExpression:function(){return this.contents},resolve:function(e){if(void 0===this.key)return"";for(var t,i=this.resolvePath(this.key,e),a=0;t=this.filters[a];a++)i=t[1]?t[1][0]?t[0](i,this.resolvePath(t[1][1],e)):t[0](i,t[1][1]):t[0](i);return i},resolvePath:function(e,i){var a,r,n=e.charAt(0),o=e.slice(-1);if(isNaN(parseInt(n)))if('"'==n&&n==o)a=e.slice(1,-1);else{if("true"==e)return!0;if("false"==e)return!1;if("null"==e||"None"==e)return null;if(r=e.split("."),a=i.get(r[0]),t.isFunction(a)){var s=i.getThis&&i.getThis();a=a.alters_data?"":s?a.call(s):""}for(var d=1;d<r.length;d++){var u=r[d];if(!a)return"";var h=a;if(t.isObject(a)&&"items"==u&&void 0===a[u]){var c=[];for(var m in a)c.push([m,a[m]]);a=c}else{if(a.get&&t.isFunction(a.get)&&a.get.safe)a=a.get(u);else{if(void 0===a[u]){a=a[u];break}a=a[u]}t.isFunction(a)?a=a.alters_data?"":a.call(h):a instanceof Date&&(a=l._Context.prototype._normalize(a))}}}else a=-1==e.indexOf(".")?parseInt(e):parseFloat(e);return a}}),l._TextNode=l._Node=t.extend(function(e){this.contents=e},{set:function(e){return this.contents=e,this},render:function(e,t){return t.concat(this.contents)},isEmpty:function(){return!t.trim(this.contents)},clone:function(){return this}}),l._NodeList=t.extend(function(e){this.contents=e||[],this.last=""},{push:function(e){return this.contents.push(e),this},concat:function(e){return this.contents=this.contents.concat(e),this},render:function(e,t){for(var i=0;i<this.contents.length;i++)if(t=this.contents[i].render(e,t),!t)throw new Error("Template must return buffer");return t},dummyRender:function(e){return this.render(e,l.Template.prototype.getBuffer()).toString()},unrender:function(){return arguments[1]},clone:function(){return this},rtrim:function(){for(;;){if(i=this.contents.length-1,!(this.contents[i]instanceof l._TextNode&&this.contents[i].isEmpty()))break;this.contents.pop()}return this}}),l._VarNode=t.extend(function(e){this.contents=new l._Filter(e)},{render:function(e,t){var i=this.contents.resolve(e)||"";return i.safe||(i=l._base.escape(""+i)),t.concat(i)}}),l._noOpNode=new function(){this.render=this.unrender=function(){return arguments[1]},this.clone=function(){return this}},l._Parser=t.extend(function(e){this.contents=e},{i:0,parse:function(e){var t,i={};e=e||[];for(var a=0;a<e.length;a++)i[e[a]]=!0;for(var r=new l._NodeList;this.i<this.contents.length;)if(t=this.contents[this.i++],"string"==typeof t)r.push(new l._TextNode(t));else{var n=t[0],o=t[1];if(n==l.TOKEN_VAR)r.push(new l._VarNode(o));else if(n==l.TOKEN_BLOCK){if(i[o])return--this.i,r;var s=o.split(/\s+/g);if(s.length){s=s[0];var d=m.getTag(s);d&&r.push(d(this,new l.Token(n,o)))}}}if(e.length)throw new Error("Could not find closing tag(s): "+e.toString());return this.contents.length=0,r},next_token:function(){var e=this.contents[this.i++];return new l.Token(e[0],e[1])},delete_first_token:function(){this.i++},skip_past:function(e){for(;this.i<this.contents.length;){var t=this.contents[this.i++];if(t[0]==l.TOKEN_BLOCK&&t[1]==e)return}throw new Error("Unclosed tag found when looking for "+e)},create_variable_node:function(e){return new l._VarNode(e)},create_text_node:function(e){return new l._TextNode(e||"")},getTemplate:function(e){return new l.Template(e)}}),l.register={_registry:{attributes:[],tags:[],filters:[]},get:function(e,t){for(var i,a=l.register._registry[e+"s"],r=0;i=a[r];r++)if("string"==typeof i[0]){if(i[0]==t)return i}else if(t.match(i[0]))return i},getAttributeTags:function(){for(var e,i=[],a=l.register._registry.attributes,r=0;e=a[r];r++)if(3==e.length)i.push(e);else{var n=t.getObject(e[1]);n&&t.isFunction(n)&&(e.push(n),i.push(e))}return i},_any:function(e,i,a){for(var r in a)for(var n,o=0;n=a[r][o];o++){var s=n;if(t.isArray(n)&&(s=n[0],n=n[1]),"string"==typeof s){if("attr:"==s.substr(0,5)){var d=n;"attr:"==d.substr(0,5)&&(d=d.slice(5)),l.register._registry.attributes.push([d.toLowerCase(),i+"."+r+"."+d])}s=s.toLowerCase()}l.register._registry[e].push([s,n,i+"."+r])}},tags:function(e,t){l.register._any("tags",e,t)},filters:function(e,t){l.register._any("filters",e,t)}};var y=/&/g,p=/</g,v=/>/g,g=/'/g,M=/"/g;return l._base.escape=function(e){return l.mark_safe(e.replace(y,"&amp;").replace(p,"&lt;").replace(v,"&gt;").replace(M,"&quot;").replace(g,"&#39;"))},l._base.safe=function(e){return"string"==typeof e&&(e=new String(e)),"object"==typeof e&&(e.safe=!0),e},l.mark_safe=l._base.safe,l.register.tags("dojox.dtl.tag",{date:["now"],logic:["if","for","ifequal","ifnotequal"],loader:["extends","block","include","load","ssi"],misc:["comment","debug","filter","firstof","spaceless","templatetag","widthratio","with"],loop:["cycle","ifchanged","regroup"]}),l.register.filters("dojox.dtl.filter",{dates:["date","time","timesince","timeuntil"],htmlstrings:["linebreaks","linebreaksbr","removetags","striptags"],integers:["add","get_digit"],lists:["dictsort","dictsortreversed","first","join","length","length_is","random","slice","unordered_list"],logic:["default","default_if_none","divisibleby","yesno"],misc:["filesizeformat","pluralize","phone2numeric","pprint"],strings:["addslashes","capfirst","center","cut","fix_ampersands","floatformat","iriencode","linenumbers","ljust","lower","make_list","rjust","slugify","stringformat","title","truncatewords","truncatewords_html","upper","urlencode","urlize","urlizetrunc","wordcount","wordwrap"]}),l.register.filters("dojox.dtl",{_base:["escape","safe"]}),l});//# sourceMappingURL=_base.js.map