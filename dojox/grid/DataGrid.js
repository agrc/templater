//>>built
define("dojox/grid/DataGrid",["../main","dojo/_base/array","dojo/_base/lang","dojo/_base/json","dojo/_base/sniff","dojo/_base/declare","./_Grid","./DataSelection","dojo/_base/html","dojo/has","dojo/has!dojo-bidi?./bidi/_BidiMixin"],function(e,t,i,a,r,o,n,s,d){var l=o("dojox.grid.DataGrid",n,{store:null,query:null,queryOptions:null,fetchText:"...",sortFields:null,updateDelay:1,items:null,_store_connects:null,_by_idty:null,_by_idx:null,_cache:null,_pages:null,_pending_requests:null,_bop:-1,_eop:-1,_requests:0,rowCount:0,_isLoaded:!1,_isLoading:!1,keepSelection:!1,postCreate:function(){this._pages=[],this._store_connects=[],this._by_idty={},this._by_idx=[],this._cache=[],this._pending_requests={},this._setStore(this.store),this.inherited(arguments)},destroy:function(){this.selection.destroy(),this.inherited(arguments)},createSelection:function(){this.selection=new s(this)},get:function(e,i){if(i&&"_item"==this.field&&!this.fields)return i;if(i&&this.fields){var a=[],r=this.grid.store;return t.forEach(this.fields,function(e){a=a.concat(r.getValues(i,e))}),a}return i||"string"!=typeof e?i?this.field?"_item"==this.field?i:this.grid.store.getValue(i,this.field):this.value:this.defaultValue:this.inherited(arguments)},_checkUpdateStatus:function(){if(this.updateDelay>0){var e=!1;if(this._endUpdateDelay&&(clearTimeout(this._endUpdateDelay),delete this._endUpdateDelay,e=!0),this.updating||(this.beginUpdate(),e=!0),e){var t=this;this._endUpdateDelay=setTimeout(function(){delete t._endUpdateDelay,t.endUpdate()},this.updateDelay)}}},_onSet:function(e,t,i,a){this._checkUpdateStatus();var r=this.getItemIndex(e);r>-1&&this.updateRow(r)},_createItem:function(e,t){var i=this._hasIdentity?this.store.getIdentity(e):a.toJson(this.query)+":idx:"+t+":sort:"+a.toJson(this.getSortProps()),r=this._by_idty[i]={idty:i,item:e};return r},_addItem:function(e,t,i){this._by_idx[t]=this._createItem(e,t),i||this.updateRow(t)},_onNew:function(e,t){this._checkUpdateStatus();var i=this.get("rowCount");this._addingItem=!0,this.updateRowCount(i+1),this._addingItem=!1,this._addItem(e,i),this.showMessage()},_onDelete:function(e){this._checkUpdateStatus();var t=this._getItemIndex(e,!0);if(t>=0){this._pages=[],this._bop=-1,this._eop=-1;var i=this._by_idx[t];this._by_idx.splice(t,1),delete this._by_idty[i.idty],this.updateRowCount(this.get("rowCount")-1),0===this.get("rowCount")&&this.showMessage(this.noDataMessage)}this.selection.isSelected(t)&&(this.selection.deselect(t),this.selection.selected.splice(t,1))},_onRevert:function(){this._refresh()},setStore:function(e,t,i){this._requestsPending(0)||(this._setQuery(t,i),this._setStore(e),this._refresh(!0))},setQuery:function(e,t){this._requestsPending(0)||(this._setQuery(e,t),this._refresh(!0))},setItems:function(e){this.items=e,this._setStore(this.store),this._refresh(!0)},_setQuery:function(e,t){this.query=e,this.queryOptions=t||this.queryOptions},_setStore:function(e){if(this.store&&this._store_connects&&t.forEach(this._store_connects,this.disconnect,this),this.store=e,this.store){var i=this.store.getFeatures(),a=[];this._canEdit=!!i["dojo.data.api.Write"]&&!!i["dojo.data.api.Identity"],this._hasIdentity=!!i["dojo.data.api.Identity"],i["dojo.data.api.Notification"]&&!this.items&&(a.push(this.connect(this.store,"onSet","_onSet")),a.push(this.connect(this.store,"onNew","_onNew")),a.push(this.connect(this.store,"onDelete","_onDelete"))),this._canEdit&&a.push(this.connect(this.store,"revert","_onRevert")),this._store_connects=a}},_onFetchBegin:function(e,t){this.scroller&&(this.rowCount!=e&&(t.isRender?(this.scroller.init(e,this.keepRows,this.rowsPerPage),this.rowCount=e,this._setAutoHeightAttr(this.autoHeight,!0),this._skipRowRenormalize=!0,this.prerender(),this._skipRowRenormalize=!1):this.updateRowCount(e)),e?this.showMessage():(this.views.render(),this._resize(),this.showMessage(this.noDataMessage),this.focus.initFocusView()))},_onFetchComplete:function(e,i){this.scroller&&(e&&e.length>0&&(t.forEach(e,function(e,t){this._addItem(e,i.start+t,!0)},this),this.updateRows(i.start,e.length),i.isRender?(this.setScrollTop(0),this.postrender()):this._lastScrollTop&&this.setScrollTop(this._lastScrollTop),r("ie")&&d.setSelectable(this.domNode,this.selectable)),delete this._lastScrollTop,this._isLoaded||(this._isLoading=!1,this._isLoaded=!0),this._pending_requests[i.start]=!1)},_onFetchError:function(e,t){delete this._lastScrollTop,this._isLoaded||(this._isLoading=!1,this._isLoaded=!0,this.showMessage(this.errorMessage)),this._pending_requests[t.start]=!1,this.onFetchError(e,t)},onFetchError:function(e,t){},_fetch:function(e,a){if(e=e||0,this.store&&!this._pending_requests[e]){this._isLoaded||this._isLoading||(this._isLoading=!0,this.showMessage(this.loadingMessage)),this._pending_requests[e]=!0;try{if(this.items){var r=this.items,o=this.store;this.rowsPerPage=r.length;var n={start:e,count:this.rowsPerPage,isRender:a};this._onFetchBegin(r.length,n);var s=0;if(t.forEach(r,function(e){o.isItemLoaded(e)||s++}),0===s)this._onFetchComplete(r,n);else{var d=function(e){s--,0===s&&this._onFetchComplete(r,n)};t.forEach(r,function(e){o.isItemLoaded(e)||o.loadItem({item:e,onItem:d,scope:this})},this)}}else this.store.fetch({start:e,count:this.rowsPerPage,query:this.query,sort:this.getSortProps(),queryOptions:this.queryOptions,isRender:a,onBegin:i.hitch(this,"_onFetchBegin"),onComplete:i.hitch(this,"_onFetchComplete"),onError:i.hitch(this,"_onFetchError")})}catch(l){this._onFetchError(l,{start:e,count:this.rowsPerPage})}}},_clearData:function(){this.updateRowCount(0),this._by_idty={},this._by_idx=[],this._pages=[],this._bop=this._eop=-1,this._isLoaded=!1,this._isLoading=!1},getItem:function(e){var t=this._by_idx[e];return!t||t&&!t.item?(this._preparePage(e),null):t.item},getItemIndex:function(e){return this._getItemIndex(e,!1)},_getItemIndex:function(e,t){if(!t&&!this.store.isItem(e))return-1;for(var i=this._hasIdentity?this.store.getIdentity(e):null,a=0,r=this._by_idx.length;r>a;a++){var o=this._by_idx[a];if(o&&(i&&o.idty==i||o.item===e))return a}return-1},filter:function(e,t){this.query=e,t&&this._clearData(),this._fetch()},_getItemAttr:function(e,t){var i=this.getItem(e);return i?this.store.getValue(i,t):this.fetchText},_render:function(){this.domNode.parentNode&&(this.scroller.init(this.get("rowCount"),this.keepRows,this.rowsPerPage),this.prerender(),this._fetch(0,!0))},_requestsPending:function(e){return this._pending_requests[e]},_rowToPage:function(e){return this.rowsPerPage?Math.floor(e/this.rowsPerPage):e},_pageToRow:function(e){return this.rowsPerPage?this.rowsPerPage*e:e},_preparePage:function(e){if((e<this._bop||e>=this._eop)&&!this._addingItem){var t=this._rowToPage(e);this._needPage(t),this._bop=t*this.rowsPerPage,this._eop=this._bop+(this.rowsPerPage||this.get("rowCount"))}},_needPage:function(e){this._pages[e]||(this._pages[e]=!0,this._requestPage(e))},_requestPage:function(e){var t=this._pageToRow(e),a=Math.min(this.rowsPerPage,this.get("rowCount")-t);a>0&&(this._requests++,this._requestsPending(t)||setTimeout(i.hitch(this,"_fetch",t,!1),1))},getCellName:function(e){return e.field},_refresh:function(e){this._clearData(),this._fetch(0,e)},sort:function(){this.edit.apply(),this._lastScrollTop=this.scrollTop,this._refresh()},canSort:function(){return!this._isLoading},getSortProps:function(){var e=this.getCell(this.getSortIndex());if(e){var t=e.sortDesc,i=!(this.sortInfo>0);return t="undefined"==typeof t?i:i?!t:t,[{attribute:e.field,descending:t}]}return this.sortFields?this.sortFields:null},styleRowState:function(e){if(this.store&&this.store.getState){for(var t,i=this.store.getState(e.index),a="",r=0,o=["inflight","error","inserting"];t=o[r];r++)if(i[t]){a=" dojoxGridRow-"+t;break}e.customClasses+=a}},onStyleRow:function(e){this.styleRowState(e),this.inherited(arguments)},canEdit:function(e,t){return this._canEdit},_copyAttr:function(e,t){var i=this.getItem(e);return this.store.getValue(i,t)},doStartEdit:function(e,t){this._cache[t]||(this._cache[t]=this._copyAttr(t,e.field)),this.onStartEdit(e,t)},doApplyCellEdit:function(e,t,a){this.store.fetchItemByIdentity({identity:this._by_idx[t].idty,onItem:i.hitch(this,function(i){var r=this.store.getValue(i,a);if("number"==typeof r)e=isNaN(e)?e:parseFloat(e);else if("boolean"==typeof r)e="true"==e?!0:"false"==e?!1:e;else if(r instanceof Date){var o=new Date(e);e=isNaN(o.getTime())?e:o}this.store.setValue(i,a,e),this.onApplyCellEdit(e,t,a)})})},doCancelEdit:function(e){var t=this._cache[e];t&&(this.updateRow(e),delete this._cache[e]),this.onCancelEdit.apply(this,arguments)},doApplyEdit:function(e,t){this._cache[e];this.onApplyEdit(e)},removeSelectedRows:function(){if(this._canEdit){this.edit.apply();var e=i.hitch(this,function(e){e.length&&(t.forEach(e,this.store.deleteItem,this.store),this.selection.clear())});this.allItemsSelected?this.store.fetch({query:this.query,queryOptions:this.queryOptions,onComplete:e}):e(this.selection.getSelected())}}});return l.cell_markupFactory=function(e,t,a){var r=i.trim(d.attr(t,"field")||"");r&&(a.field=r),a.field=a.field||a.name;var o=i.trim(d.attr(t,"fields")||"");o&&(a.fields=o.split(",")),e&&e(t,a)},l.markupFactory=function(e,t,a,r){return n.markupFactory(e,t,a,i.partial(l.cell_markupFactory,r))},l});//# sourceMappingURL=DataGrid.js.map