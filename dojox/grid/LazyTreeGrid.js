//>>built
require({cache:{"url:dojox/grid/resources/Expando.html":'<div class="dojoxGridExpando"\n	><div class="dojoxGridExpandoNode" dojoAttachEvent="onclick:onToggle"\n		><div class="dojoxGridExpandoNodeInner" dojoAttachPoint="expandoInner"></div\n	></div\n></div>\n'}}),define("dojox/grid/LazyTreeGrid",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/event","dojo/_base/array","dojo/query","dojo/parser","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/dom-geometry","dojo/dom","dojo/keys","dojo/text!./resources/Expando.html","dijit/_Widget","dijit/_TemplatedMixin","./TreeGrid","./_Builder","./_View","./_Layout","./cells/tree","./_RowManager","./_FocusManager","./_EditManager","./DataSelection","./util"],function(e,t,a,i,r,o,n,s,d,l,h,m,u,c,f,p,y,g,v,b,M,k,x,w,_,I){var T=t("dojox.grid._LazyExpando",[f,p],{grid:null,view:null,rowIdx:-1,cellIdx:-1,level:0,itemId:"",templateString:c,onToggle:function(e){if(this.grid._treeCache.items[this.rowIdx]){this.grid.focus.setFocusIndex(this.rowIdx,this.cellIdx),this.setOpen(!this.grid._treeCache.items[this.rowIdx].opened);try{i.stop(e)}catch(t){}}},setOpen:function(e){var t=this.grid,a=t._by_idx[this.rowIdx].item;a&&t.treeModel.mayHaveChildren(a)&&!t._loading&&t._treeCache.items[this.rowIdx].opened!==e&&(t._treeCache.items[this.rowIdx].opened=e,t.expandoFetch(this.rowIdx,e),this._updateOpenState(a))},_updateOpenState:function(e){var t,a=this.grid;e&&a.treeModel.mayHaveChildren(e)?(t=a._treeCache.items[this.rowIdx].opened,this.expandoInner.innerHTML=t?"-":"+",d.toggle(this.domNode,"dojoxGridExpandoOpened",t),this.domNode.parentNode.setAttribute("aria-expanded",t)):d.remove(this.domNode,"dojoxGridExpandoOpened")},setRowNode:function(e,t,a){if(this.cellIdx<0||!this.itemId)return!1;this.view=a,this.grid=a.grid,this.rowIdx=e;var i=this.grid.isLeftToRight()?"marginLeft":"marginRight";return l.set(this.domNode.parentNode,i,1.125*this.level+"em"),this._updateOpenState(this.grid._by_idx[this.rowIdx].item),!0}}),j=t("dojox.grid._TreeGridContentBuilder",g._ContentBuilder,{generateHtml:function(e,t){var i=this.getTableArray(),o=this.grid,n=this.view,s=n.structure.cells,d=o.getItem(t),l=0,m="",u=o._treeCache.items[t]?o._treeCache.items[t].treePath:null;I.fire(this.view,"onBeforeRow",[t,s]),d&&a.isArray(u)&&(l=u.length,m=o.treeModel.mayHaveChildren(d)?"":"dojoxGridNoChildren");for(var c,f,p,y=0,g=0,v=0,b=[];c=s[g];g++)if(!c.hidden&&!c.header){i.push('<tr class="'+m+'">'),p=this._getColSpans(l),p&&r.forEach(p,function(e){for(y=0;f=c[y];y++)y>=e.start&&y<=e.end&&(v+=this._getCellWidth(c,y));b.push(v),v=0},this);var M,k,x,w,_=0;for(y=0;f=c[y];y++)if(M=f.markup,k=f.customClasses=[],x=f.customStyles=[],p&&p[_]&&y>=p[_].start&&y<=p[_].end){var T=p[_].primary||p[_].start;if(y!=T){if(y==p[_].end){_++;continue}continue}M[5]=f.formatAtLevel(d,l,t),M[1]=k.join(" "),w=h.getMarginBox(f.getHeaderNode()).w-h.getContentBox(f.getHeaderNode()).w,x=f.customStyles=["width:"+(b[_]-w)+"px"],M[3]=x.join(";"),i.push.apply(i,M)}else M[5]=f.formatAtLevel(d,l,t),M[1]=k.join(" "),M[3]=x.join(";"),i.push.apply(i,M);i.push("</tr>")}return i.push("</table>"),i.join("")},_getColSpans:function(e){var t=this.grid.colSpans;return t&&t[e]?t[e]:null},_getCellWidth:function(e,t){var a=e[t],i=a.getHeaderNode();if(a.hidden)return 0;if(t==e.length-1||r.every(e.slice(t+1),function(e){return e.hidden})){var o=h.position(e[t].view.headerContentNode.firstChild);return o.x+o.w-h.position(i).x}var n;do n=e[++t];while(n.hidden);return h.position(n.getHeaderNode()).x-h.position(i).x}});t("dojox.grid._TreeGridView",v,{_contentBuilderClass:j,postCreate:function(){this.inherited(arguments),this._expandos={},this.connect(this.grid,"_onCleanupExpandoCache","_cleanupExpandoCache")},destroy:function(){this._cleanupExpandoCache(),this.inherited(arguments)},_cleanupExpandoCache:function(e){if(e&&this._expandos[e])this._expandos[e].destroy(),delete this._expandos[e];else{var t;for(t in this._expandos)this._expandos[t].destroy();this._expandos={}}},onAfterRow:function(e,t,a){o("span.dojoxGridExpando",a).forEach(function(t){if(t&&t.parentNode){var i,r,o=this.grid._by_idx;o&&o[e]&&o[e].idty&&(i=o[e].idty,r=this._expandos[i]),r?(s.place(r.domNode,t,"replace"),r.itemId=t.getAttribute("itemId"),r.cellIdx=parseInt(t.getAttribute("cellIdx"),10),isNaN(r.cellIdx)&&(r.cellIdx=-1)):(r=n.parse(t.parentNode)[0],i&&(this._expandos[i]=r)),r.setRowNode(e,a,this)||r.domNode.parentNode.removeChild(r.domNode),s.destroy(t)}},this),this.inherited(arguments)},updateRow:function(e){var t,a=this.grid;a.keepSelection&&(t=a.getItem(e),t&&a.selection.preserver._reSelectById(t,e)),this.inherited(arguments)}});var F=a.mixin(a.clone(M),{formatAtLevel:function(t,a,i){if(!t)return this.formatIndexes(i,t,a);var r,o="",n="";return this.isCollapsable&&this.grid.store.isItem(t)&&(n="<span "+e._scopeName+'Type="dojox.grid._LazyExpando" level="'+a+'" class="dojoxGridExpando" itemId="'+this.grid.store.getIdentity(t)+'" cellIdx="'+this.index+'"></span>'),r=this.formatIndexes(i,t,a),o=""!==n?"<div>"+n+r+"</div>":r},formatIndexes:function(e,t,a){var i=this.grid.edit.info,r=this.get?this.get(e,t):this.value||this.defaultValue;if(this.editable&&(this.alwaysEditing||i.rowIndex===e&&i.cell===this))return this.formatEditing(r,e);var o=this.textDir||this.grid.textDir,n=this._defaultFormat(r,[r,e,a,this]);return o&&this._enforceTextDirWithUcc&&(n=this._enforceTextDirWithUcc(o,n)),n}}),C=t("dojox.grid._LazyTreeLayout",b,{setStructure:function(e){var t=this.grid,a=e;t&&!r.every(a,function(e){return!!e.cells})&&(a=arguments[0]=[{cells:[a]}]),1===a.length&&1===a[0].cells.length&&(a[0].type="dojox.grid._TreeGridView",this._isCollapsable=!0,a[0].cells[0][this.grid.expandoCell].isCollapsable=!0),this.inherited(arguments)},addCellDef:function(e,t,i){var r=this.inherited(arguments);return a.mixin(r,F)}}),E=t("dojox.grid._LazyTreeGridCache",null,{constructor:function(){this.items=[]},getSiblingIndex:function(e,t){for(var a,i=e-1,r=0;i>=0;i--)if(a=this.items[i]?this.items[i].treePath:[],a.join("/")===t.join("/"))r++;else if(a.length<t.length)break;return r},removeChildren:function(e){for(var t,a,i=e+1,r=this.items[e]?this.items[e].treePath:[];i<this.items.length&&(a=this.items[i]?this.items[i].treePath:[],!(a.join("/")===r.join("/")||a.length<=r.length));i++);return t=i-(e+1),this.items.splice(e+1,t),t}}),z=t("dojox.grid.LazyTreeGrid",y,{_layoutClass:C,_size:0,treeModel:null,defaultState:null,colSpans:null,postCreate:function(){if(this._setState(),this.inherited(arguments),this._treeCache||(this._treeCache=new E),!(this.treeModel&&this.treeModel instanceof dijit.tree.ForestStoreModel))throw new Error("dojox.grid.LazyTreeGrid: must be used with a treeModel which is an instance of dijit.tree.ForestStoreModel");d.add(this.domNode,"dojoxGridTreeModel"),m.setSelectable(this.domNode,this.selectable)},createManagers:function(){this.rows=new k(this),this.focus=new x(this),this.edit=new w(this)},createSelection:function(){this.selection=new _(this)},setModel:function(e){e&&(this._setModel(e),this._cleanup(),this._refresh(!0))},setStore:function(e,t,a){e&&(this._setQuery(t,a),this.treeModel.query=t,this.treeModel.store=e,this.treeModel.root.children=[],this.setModel(this.treeModel))},onSetState:function(){},_setState:function(){this.defaultState&&(this._treeCache=this.defaultState.cache,this.sortInfo=this.defaultState.sortInfo||0,this.query=this.defaultState.query||this.query,this._lastScrollTop=this.defaultState.scrollTop,this.keepSelection?this.selection.preserver._selectedById=this.defaultState.selection:this.selection.selected=this.defaultState.selection||[],this.onSetState())},getState:function(){var e=this,t=this.keepSelection?this.selection.preserver._selectedById:this.selection.selected;return{cache:a.clone(e._treeCache),query:a.clone(e.query),sortInfo:a.clone(e.sortInfo),scrollTop:a.clone(e.scrollTop),selection:a.clone(t)}},_setQuery:function(e,t){this.inherited(arguments),this.treeModel.query=e},filter:function(e,t){this._cleanup(),this.inherited(arguments)},destroy:function(){this._cleanup(),this.inherited(arguments)},expand:function(e){this._fold(e,!0)},collapse:function(e){this._fold(e,!1)},refresh:function(e){e||this._cleanup(),this._refresh(!0)},_cleanup:function(){this._treeCache.items=[],this._onCleanupExpandoCache()},setSortIndex:function(e,t){this.canSort(e+1)&&this._cleanup(),this.inherited(arguments)},_refresh:function(e){this._clearData(),this.updateRowCount(this._size),this._fetch(0,!0)},render:function(){this.inherited(arguments),this.setScrollTop(this.scrollTop)},_onNew:function(e,t){var a=t&&this.store.isItem(t.item)&&r.some(this.treeModel.childrenAttrs,function(e){return e===t.attribute}),i=this._treeCache.items,o=this._by_idx;if(a){for(var n=t.item,s=this.store.getIdentity(n),d=-1,l=0;l<o.length;l++)if(s===o[l].idty){d=l;break}if(d>=0)if(i[d]&&i[d].opened){for(var h=i[d].treePath,m=d+1;m<i.length&&!(i[m].treePath.length<=h.length);m++);var u=h.slice();u.push(s),this._treeCache.items.splice(m,0,{opened:!1,treePath:u});var c=this.store.getIdentity(e);this._by_idty[c]={idty:c,item:e},o.splice(m,0,this._by_idty[c]),this._size+=1,this.updateRowCount(this._size),this._updateRenderedRows(m)}else this.updateRow(d)}else i.push({opened:!1,treePath:[]}),this._size+=1,this.inherited(arguments)},_onDelete:function(e){for(var t=0,a=-1,i=this.store.getIdentity(e);t<this._by_idx.length;t++)if(i===this._by_idx[t].idty){a=t;break}if(a>=0){var r,o=this._treeCache.items,n=o[a]?o[a].treePath:[],s=1;for(t=a+1;t<this._size&&(r=o[t]?o[t].treePath:[],!(o[t].treePath.length<=n.length));t++,s++);o.splice(a,s),this._onCleanupExpandoCache(i),this._by_idx.splice(a,s),this._size-=s,this.updateRowCount(this._size),this._updateRenderedRows(a)}},_onCleanupExpandoCache:function(e){},_fetch:function(e,t){this._loading||(this._loading=!0),e=e||0;var a=this._size-e>0?Math.min(this.rowsPerPage,this._size-e):this.rowsPerPage,i=0,r=[];for(this._reqQueueLen=0;a>i&&this._by_idx[e+i];i++)r.push(this._by_idx[e+i].item);if(r.length===a)this._reqQueueLen=1,this._onFetchBegin(this._size,{startRowIdx:e,count:a}),this._onFetchComplete(r,{startRowIdx:e,count:a});else{var o,n,s=1,d=this._treeCache.items,l=d[e]?d[e].treePath:[];for(i=1;a>i;i++)o=d[e+s-1]?d[e+s-1].treePath.length:0,n=d[e+s]?d[e+s].treePath.length:0,o!==n?(this._reqQueueLen++,this._fetchItems({startRowIdx:e,count:s,treePath:l}),e+=s,s=1,l=d[e]?d[e].treePath:0):s++;this._reqQueueLen++,this._fetchItems({startRowIdx:e,count:s,treePath:l})}},_fetchItems:function(e){if(!this._pending_requests[e.startRowIdx]){this.showMessage(this.loadingMessage),this._pending_requests[e.startRowIdx]=!0;var t=a.hitch(this,"_onFetchError"),i=this._treeCache.getSiblingIndex(e.startRowIdx,e.treePath);if(0===e.treePath.length)this.store.fetch({start:i,startRowIdx:e.startRowIdx,treePath:e.treePath,count:e.count,query:this.query,sort:this.getSortProps(),queryOptions:this.queryOptions,onBegin:a.hitch(this,"_onFetchBegin"),onComplete:a.hitch(this,"_onFetchComplete"),onError:a.hitch(this,"_onFetchError")});else{var r,o=e.treePath[e.treePath.length-1],n={start:i,startRowIdx:e.startRowIdx,treePath:e.treePath,count:e.count,parentId:o,sort:this.getSortProps()},s=this,d=function(){var e=a.hitch(s,"_onFetchComplete");1==arguments.length?e.apply(s,[arguments[0],n]):e.apply(s,arguments)};this._by_idty[o]?(r=this._by_idty[o].item,this.treeModel.getChildren(r,d,t,n)):this.store.fetchItemByIdentity({identity:o,onItem:function(e){s.treeModel.getChildren(e,d,t,n)},onError:t})}}},_onFetchBegin:function(e,t){0===this._treeCache.items.length&&(this._size=parseInt(e,10)),e=this._size,this.inherited(arguments)},_onFetchComplete:function(e,t){var i=t.startRowIdx,r=t.count,o=e.length<=r?0:t.start,n=t.treePath||[];if(a.isArray(e)&&e.length>0){for(var s=0,d=Math.min(r,e.length);d>s;s++)this._treeCache.items[i+s]||(this._treeCache.items[i+s]={opened:!1,treePath:n}),this._by_idx[i+s]||this._addItem(e[o+s],i+s,!0);this.updateRows(i,d)}0==this._size?this.showMessage(this.noDataMessage):this.showMessage(),this._pending_requests[i]=!1,this._reqQueueLen--,this._loading&&0===this._reqQueueLen&&(this._loading=!1,this._lastScrollTop&&this.setScrollTop(this._lastScrollTop))},expandoFetch:function(e,t){if(!this._loading&&this._by_idx[e]){this._loading=!0,this._toggleLoadingClass(e,!0),this.expandoRowIndex=e;var i=this._by_idx[e].item;if(t){var r={start:0,count:this.rowsPerPage,parentId:this.store.getIdentity(this._by_idx[e].item),sort:this.getSortProps()};this.treeModel.getChildren(i,a.hitch(this,"_onExpandoComplete"),a.hitch(this,"_onFetchError"),r)}else{var o=this._treeCache.removeChildren(e);this._by_idx.splice(e+1,o),this._bop=this._eop=-1,this._size-=o,this.updateRowCount(this._size),this._updateRenderedRows(e+1),this._toggleLoadingClass(e,!1),this._loading&&(this._loading=!1),this.focus._delayedCellFocus()}}},_onExpandoComplete:function(e,t,a){a=isNaN(a)?e.length:parseInt(a,10);var i=this._treeCache.items[this.expandoRowIndex].treePath.slice(0);i.push(this.store.getIdentity(this._by_idx[this.expandoRowIndex].item));for(var r,o=1;a>=o;o++)this._treeCache.items.splice(this.expandoRowIndex+o,0,{treePath:i,opened:!1});for(this._size+=a,this.updateRowCount(this._size),o=0;a>o;o++)e[o]?(r=this.store.getIdentity(e[o]),this._by_idty[r]={idty:r,item:e[o]},this._by_idx.splice(this.expandoRowIndex+1+o,0,this._by_idty[r])):this._by_idx.splice(this.expandoRowIndex+1+o,0,null);this._updateRenderedRows(this.expandoRowIndex+1),this._toggleLoadingClass(this.expandoRowIndex,!1),this.stateChangeNode=null,this._loading&&(this._loading=!1),this.autoHeight===!0&&this._resize(),this.focus._delayedCellFocus()},styleRowNode:function(e,t){t&&this.rows.styleRowNode(e,t)},onStyleRow:function(e){return this.layout._isCollapsable?(e.customClasses+=(e.odd?" dojoxGridRowOdd":"")+(e.selected?" dojoxGridRowSelected":"")+(e.over?" dojoxGridRowOver":""),this.focus.styleRow(e),void this.edit.styleRow(e)):void this.inherited(arguments)},onKeyDown:function(e){if(!e.altKey&&!e.metaKey){var t=dijit.findWidgets(e.target)[0];e.keyCode===u.ENTER&&t instanceof T&&t.onToggle(),this.inherited(arguments)}},_toggleLoadingClass:function(e,t){var a,i=this.views.views,r=i[i.length-1].getRowNode(e);r&&(a=o(".dojoxGridExpando",r)[0],a&&d.toggle(a,"dojoxGridExpandoLoading",t))},_updateRenderedRows:function(e){r.forEach(this.scroller.stack,function(t){t*this.rowsPerPage>=e?this.updateRows(t*this.rowsPerPage,this.rowsPerPage):(t+1)*this.rowsPerPage>=e&&this.updateRows(e,(t+1)*this.rowsPerPage-e+1)},this)},_fold:function(e,t){var a=-1,i=0,r=this._by_idx,o=this._by_idty[e];if(o&&o.item&&this.treeModel.mayHaveChildren(o.item)){for(;i<r.length;i++)if(r[i]&&r[i].idty===e){a=i;break}if(a>=0){var n=this.views.views[this.views.views.length-1].getRowNode(a);if(n){var s=dijit.findWidgets(n)[0];s&&s.setOpen(t)}}}}});return z.markupFactory=function(e,t,a,i){return y.markupFactory(e,t,a,i)},z});//# sourceMappingURL=LazyTreeGrid.js.map