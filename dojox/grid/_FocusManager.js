//>>built
define("dojox/grid/_FocusManager",["dojo/_base/array","dojo/_base/lang","dojo/_base/declare","dojo/_base/connect","dojo/_base/event","dojo/_base/sniff","dojo/query","./util","dojo/_base/html"],function(e,t,i,a,r,n,o,s,d){return i("dojox.grid._FocusManager",null,{constructor:function(e){this.grid=e,this.cell=null,this.rowIndex=-1,this._connects=[],this._headerConnects=[],this.headerMenu=this.grid.headerMenu,this._connects.push(a.connect(this.grid.domNode,"onfocus",this,"doFocus")),this._connects.push(a.connect(this.grid.domNode,"onblur",this,"doBlur")),this._connects.push(a.connect(this.grid.domNode,"mousedown",this,"_mouseDown")),this._connects.push(a.connect(this.grid.domNode,"mouseup",this,"_mouseUp")),this._connects.push(a.connect(this.grid.domNode,"oncontextmenu",this,"doContextMenu")),this._connects.push(a.connect(this.grid.lastFocusNode,"onfocus",this,"doLastNodeFocus")),this._connects.push(a.connect(this.grid.lastFocusNode,"onblur",this,"doLastNodeBlur")),this._connects.push(a.connect(this.grid,"_onFetchComplete",this,"_delayedCellFocus")),this._connects.push(a.connect(this.grid,"postrender",this,"_delayedHeaderFocus"))},destroy:function(){e.forEach(this._connects,a.disconnect),e.forEach(this._headerConnects,a.disconnect),delete this.grid,delete this.cell},_colHeadNode:null,_colHeadFocusIdx:null,_contextMenuBindNode:null,tabbingOut:!1,focusClass:"dojoxGridCellFocus",focusView:null,initFocusView:function(){this.focusView=this.grid.views.getFirstScrollingView()||this.focusView||this.grid.views.views[0],this._initColumnHeaders()},isFocusCell:function(e,t){return this.cell==e&&this.rowIndex==t},isLastFocusCell:function(){return!!this.cell&&(this.rowIndex==this.grid.rowCount-1&&this.cell.index==this.grid.layout.cellCount-1)},isFirstFocusCell:function(){return!!this.cell&&(0===this.rowIndex&&0===this.cell.index)},isNoFocusCell:function(){return this.rowIndex<0||!this.cell},isNavHeader:function(){return!!this._colHeadNode},getHeaderIndex:function(){return this._colHeadNode?e.indexOf(this._findHeaderCells(),this._colHeadNode):-1},_focusifyCellNode:function(e){var t=this.cell&&this.cell.getNode(this.rowIndex);if(t&&(d.toggleClass(t,this.focusClass,e),e)){var i=this.scrollIntoView();try{!n("webkit")&&this.grid.edit.isEditing()||(s.fire(t,"focus"),i&&(this.cell.view.scrollboxNode.scrollLeft=i))}catch(e){}}},_delayedCellFocus:function(){if(!this.isNavHeader()&&this.grid.focused){var e=this.cell&&this.cell.getNode(this.rowIndex);if(e)try{this.grid.edit.isEditing()||(d.toggleClass(e,this.focusClass,!0),this._colHeadNode&&this.blurHeader(),s.fire(e,"focus"))}catch(e){}}},_delayedHeaderFocus:function(){this.isNavHeader()&&this.focusHeader()},_initColumnHeaders:function(){e.forEach(this._headerConnects,a.disconnect),this._headerConnects=[];for(var t=this._findHeaderCells(),i=0;i<t.length;i++)this._headerConnects.push(a.connect(t[i],"onfocus",this,"doColHeaderFocus")),this._headerConnects.push(a.connect(t[i],"onblur",this,"doColHeaderBlur"))},_findHeaderCells:function(){for(var e=o("th",this.grid.viewsHeaderNode),t=[],i=0;i<e.length;i++){var a=e[i],r=d.hasAttr(a,"tabIndex"),n=d.attr(a,"tabIndex");r&&n<0&&t.push(a)}return t},_setActiveColHeader:function(e,t,i){this.grid.domNode.setAttribute("aria-activedescendant",e.id),null!=i&&i>=0&&i!=t&&d.toggleClass(this._findHeaderCells()[i],this.focusClass,!1),d.toggleClass(e,this.focusClass,!0),this._colHeadNode=e,this._colHeadFocusIdx=t,this._scrollHeader(this._colHeadFocusIdx)},scrollIntoView:function(){var e=this.cell?this._scrollInfo(this.cell):null;if(!e||!e.s)return null;var t=this.grid.scroller.findScrollTop(this.rowIndex);return e.n&&e.sr&&(e.n.offsetLeft+e.n.offsetWidth>e.sr.l+e.sr.w?e.s.scrollLeft=e.n.offsetLeft+e.n.offsetWidth-e.sr.w:e.n.offsetLeft<e.sr.l&&(e.s.scrollLeft=e.n.offsetLeft)),e.r&&e.sr&&(t+e.r.offsetHeight>e.sr.t+e.sr.h?this.grid.setScrollTop(t+e.r.offsetHeight-e.sr.h):t<e.sr.t&&this.grid.setScrollTop(t)),e.s.scrollLeft},_scrollInfo:function(e,t){if(e){var i=e,a=i.view.scrollboxNode,r={w:a.clientWidth,l:a.scrollLeft,t:a.scrollTop,h:a.clientHeight},n=i.view.getRowNode(this.rowIndex);return{c:i,s:a,sr:r,n:t||e.getNode(this.rowIndex),r:n}}return null},_scrollHeader:function(e){var t=null;if(this._colHeadNode){var i=this.grid.getCell(e);if(!i)return;t=this._scrollInfo(i,i.getNode(0))}if(t&&t.s&&t.sr&&t.n){var a=t.sr.l+t.sr.w;t.n.offsetLeft+t.n.offsetWidth>a?t.s.scrollLeft=t.n.offsetLeft+t.n.offsetWidth-t.sr.w:t.n.offsetLeft<t.sr.l?t.s.scrollLeft=t.n.offsetLeft:n("ie")<=7&&i&&i.view.headerNode&&(i.view.headerNode.scrollLeft=t.s.scrollLeft)}},_isHeaderHidden:function(){var e=this.focusView;if(!e)for(var t,i=0;t=this.grid.views.views[i];i++)if(t.headerNode){e=t;break}return e&&"none"==d.getComputedStyle(e.headerNode).display},colSizeAdjust:function(e,t,i){var a=this._findHeaderCells(),r=this.focusView;if(!r||!r.header.tableMap.map)for(var n,o=0;n=this.grid.views.views[o];o++)if(n.header.tableMap.map){r=n;break}var s=a[t];if(r&&(t!=a.length-1||0!==t)&&(r.content.baseDecorateEvent(e),e.cellNode=s,e.cellIndex=r.content.getCellNodeIndex(e.cellNode),e.cell=e.cellIndex>=0?this.grid.getCell(e.cellIndex):null,r.header.canResize(e))){var d={l:i},l=r.header.colResizeSetup(e,!1);r.header.doResizeColumn(l,null,d),r.update()}},styleRow:function(e){},setFocusIndex:function(e,t){this.setFocusCell(this.grid.getCell(t),e)},setFocusCell:function(e,i){e&&!this.isFocusCell(e,i)&&(this.tabbingOut=!1,this._colHeadNode&&this.blurHeader(),this._colHeadNode=this._colHeadFocusIdx=null,this.focusGridView(),this._focusifyCellNode(!1),this.cell=e,this.rowIndex=i,this._focusifyCellNode(!0)),n("opera")?setTimeout(t.hitch(this.grid,"onCellFocus",this.cell,this.rowIndex),1):this.grid.onCellFocus(this.cell,this.rowIndex)},next:function(){if(this.cell){var e=this.rowIndex,t=this.cell.index+1,i=this.grid.layout.cellCount-1,a=this.grid.rowCount-1;if(t>i&&(t=0,e++),e>a&&(t=i,e=a),this.grid.edit.isEditing()){var r=this.grid.getCell(t);if(!this.isLastFocusCell()&&(!r.editable||this.grid.canEdit&&!this.grid.canEdit(r,e)))return this.cell=r,this.rowIndex=e,void this.next()}this.setFocusIndex(e,t)}},previous:function(){if(this.cell){var e=this.rowIndex||0,t=(this.cell.index||0)-1;if(t<0&&(t=this.grid.layout.cellCount-1,e--),e<0&&(e=0,t=0),this.grid.edit.isEditing()){var i=this.grid.getCell(t);if(!this.isFirstFocusCell()&&!i.editable)return this.cell=i,this.rowIndex=e,void this.previous()}this.setFocusIndex(e,t)}},move:function(t,i){var a=i<0?-1:1;if(this.isNavHeader()){var r=this._findHeaderCells(),n=currentIdx=e.indexOf(r,this._colHeadNode);for(currentIdx+=i;currentIdx>=0&&currentIdx<r.length&&"none"==r[currentIdx].style.display;)currentIdx+=a;currentIdx>=0&&currentIdx<r.length&&this._setActiveColHeader(r[currentIdx],currentIdx,n)}else if(this.cell){var o=this.grid.scroller,s=this.rowIndex,l=this.grid.rowCount-1,u=Math.min(l,Math.max(0,s+t));t&&(t>0?u>o.getLastPageRow(o.page)&&this.grid.setScrollTop(this.grid.scrollTop+o.findScrollTop(u)-o.findScrollTop(s)):t<0&&u<=o.getPageRow(o.page)&&this.grid.setScrollTop(this.grid.scrollTop-o.findScrollTop(s)-o.findScrollTop(u)));for(var h=this.grid.layout.cellCount-1,m=this.cell.index,c=Math.min(h,Math.max(0,m+i)),f=this.grid.getCell(c);c>=0&&c<h&&f&&!0===f.hidden;)c+=a,f=this.grid.getCell(c);f&&!0!==f.hidden||(c=m);var p=f.getNode(u);if(!p&&t)return void(u+t>=0&&u+t<=l&&this.move(t>0?++t:--t,i));if((!p||"none"===d.style(p,"display"))&&i)return void(c+i>=0&&c+i<=h&&this.move(t,i>0?++i:--i));this.setFocusIndex(u,c),t&&this.grid.updateRow(s)}},previousKey:function(e){this.grid.edit.isEditing()?(r.stop(e),this.previous()):this.isNavHeader()||this._isHeaderHidden()?(this.tabOut(this.grid.domNode),null!=this._colHeadFocusIdx&&(d.toggleClass(this._findHeaderCells()[this._colHeadFocusIdx],this.focusClass,!1),this._colHeadFocusIdx=null),this._focusifyCellNode(!1)):(this.grid.domNode.focus(),r.stop(e))},nextKey:function(e){this.grid.rowCount;e.target===this.grid.domNode&&null==this._colHeadFocusIdx?(this.focusHeader(),r.stop(e)):this.isNavHeader()?(this.blurHeader(),this.findAndFocusGridCell()||this.tabOut(this.grid.lastFocusNode),this._colHeadNode=this._colHeadFocusIdx=null):this.grid.edit.isEditing()?(r.stop(e),this.next()):this.tabOut(this.grid.lastFocusNode)},tabOut:function(e){this.tabbingOut=!0,e.focus()},focusGridView:function(){s.fire(this.focusView,"focus")},focusGrid:function(e){this.focusGridView(),this._focusifyCellNode(!0)},findAndFocusGridCell:function(){var e=!0,t=0===this.grid.rowCount;if(this.isNoFocusCell()&&!t){var i=0;this.grid.getCell(i).hidden&&(i=this.isNavHeader()?this._colHeadFocusIdx:0),this.setFocusIndex(0,i)}else this.cell&&!t?(this.focusView&&!this.focusView.rowNodes[this.rowIndex]&&this.grid.scrollToRow(this.rowIndex),this.focusGrid()):e=!1;return this._colHeadNode=this._colHeadFocusIdx=null,e},focusHeader:function(){var e=this._findHeaderCells(),t=this._colHeadFocusIdx;for(this._isHeaderHidden()?this.findAndFocusGridCell():this._colHeadFocusIdx||(this.isNoFocusCell()?this._colHeadFocusIdx=0:this._colHeadFocusIdx=this.cell.index),this._colHeadNode=e[this._colHeadFocusIdx];this._colHeadNode&&this._colHeadFocusIdx>=0&&this._colHeadFocusIdx<e.length&&"none"==this._colHeadNode.style.display;)this._colHeadFocusIdx++,this._colHeadNode=e[this._colHeadFocusIdx];this._colHeadNode&&"none"!=this._colHeadNode.style.display?(this.headerMenu&&this._contextMenuBindNode!=this.grid.domNode&&(this.headerMenu.unBindDomNode(this.grid.viewsHeaderNode),this.headerMenu.bindDomNode(this.grid.domNode),this._contextMenuBindNode=this.grid.domNode),this._setActiveColHeader(this._colHeadNode,this._colHeadFocusIdx,t),this._scrollHeader(this._colHeadFocusIdx),this._focusifyCellNode(!1)):this.findAndFocusGridCell()},blurHeader:function(){if(d.removeClass(this._colHeadNode,this.focusClass),d.removeAttr(this.grid.domNode,"aria-activedescendant"),this.headerMenu&&this._contextMenuBindNode==this.grid.domNode){var e=this.grid.viewsHeaderNode;this.headerMenu.unBindDomNode(this.grid.domNode),this.headerMenu.bindDomNode(e),this._contextMenuBindNode=e}},doFocus:function(e){if(e&&e.target!=e.currentTarget)return void r.stop(e);this._clickFocus||(this.tabbingOut||this.focusHeader(),this.tabbingOut=!1,r.stop(e))},doBlur:function(e){r.stop(e)},doContextMenu:function(e){this.headerMenu||r.stop(e)},doLastNodeFocus:function(e){this.tabbingOut?this._focusifyCellNode(!1):this.grid.rowCount>0?(this.isNoFocusCell()&&this.setFocusIndex(0,0),this._focusifyCellNode(!0)):this.focusHeader(),this.tabbingOut=!1,r.stop(e)},doLastNodeBlur:function(e){r.stop(e)},doColHeaderFocus:function(e){this._setActiveColHeader(e.target,d.attr(e.target,"idx"),this._colHeadFocusIdx),this._scrollHeader(this.getHeaderIndex()),r.stop(e)},doColHeaderBlur:function(e){d.toggleClass(e.target,this.focusClass,!1)},_mouseDown:function(e){this._clickFocus=dojo.some(this.grid.views.views,function(t){return t.scrollboxNode===e.target})},_mouseUp:function(e){this._clickFocus=!1}})});//# sourceMappingURL=_FocusManager.js.map