//>>built
define("dojox/grid/_Builder",["../main","dojo/_base/array","dojo/_base/lang","dojo/_base/window","dojo/_base/event","dojo/_base/sniff","dojo/_base/connect","dojo/dnd/Moveable","dojox/html/metrics","./util","dojo/_base/html","dojo/dom-geometry"],function(e,t,a,i,r,o,n,s,d,l,h,u){var m=e.grid,c=function(e){return e.cellIndex>=0?e.cellIndex:t.indexOf(e.parentNode.cells,e)},f=function(e){return e.rowIndex>=0?e.rowIndex:t.indexOf(e.parentNode.childNodes,e)},p=function(e,t){return e&&((e.rows||0)[t]||e.childNodes[t])},y=function(e){for(var t=e;t&&"TABLE"!=t.tagName;t=t.parentNode);return t},g=function(e,t){for(var a=e;a&&t(a);a=a.parentNode);return a},v=function(e){var t=e.toUpperCase();return function(e){return e.tagName!=t}},M=l.rowIndexTag,b=l.gridViewTag,k=m._Builder=a.extend(function(e){e&&(this.view=e,this.grid=e.grid)},{view:null,_table:'<table class="dojoxGridRowTable" border="0" cellspacing="0" cellpadding="0" role="presentation"',getTableArray:function(){var e=[this._table];return this.view.viewWidth&&e.push([' style="width:',this.view.viewWidth,';"'].join("")),e.push(">"),e},generateCellMarkup:function(e,t,a,i){var r,o=[];if(i){var n=e.index!=e.grid.getSortIndex()?"":e.grid.sortInfo>0?'aria-sort="ascending"':'aria-sort="descending"';e.id||(e.id=this.grid.id+"Hdr"+e.index),r=['<th tabIndex="-1" aria-readonly="true" role="columnheader"',n,' id="',e.id,'"']}else{var s=this.grid.editable&&!e.editable?'aria-readonly="true"':"";r=['<td tabIndex="-1" role="gridcell"',s]}return e.colSpan&&r.push(' colspan="',e.colSpan,'"'),e.rowSpan&&r.push(' rowspan="',e.rowSpan,'"'),r.push(' class="dojoxGridCell '),e.classes&&r.push(e.classes," "),a&&r.push(a," "),o.push(r.join("")),o.push(""),r=['" idx="',e.index,'" style="'],t&&";"!=t[t.length-1]&&(t+=";"),r.push(e.styles,t||"",e.hidden?"display:none;":""),e.unitWidth&&r.push("width:",e.unitWidth,";"),o.push(r.join("")),o.push(""),r=['"'],e.attrs&&r.push(" ",e.attrs),r.push(">"),o.push(r.join("")),o.push(""),o.push(i?"</th>":"</td>"),o},isCellNode:function(e){return Boolean(e&&e!=i.doc&&h.attr(e,"idx"))},getCellNodeIndex:function(e){return e?Number(h.attr(e,"idx")):-1},getCellNode:function(e,t){for(var a,i=0;(a=p(e.firstChild,i))&&a.cells;i++)for(var r,o=0;r=a.cells[o];o++)if(this.getCellNodeIndex(r)==t)return r;return null},findCellTarget:function(e,t){for(var a=e;a&&(!this.isCellNode(a)||a.offsetParent&&b in a.offsetParent.parentNode&&a.offsetParent.parentNode[b]!=this.view.id)&&a!=t;)a=a.parentNode;return a!=t?a:null},baseDecorateEvent:function(e){e.dispatch="do"+e.type,e.grid=this.grid,e.sourceView=this.view,e.cellNode=this.findCellTarget(e.target,e.rowNode),e.cellIndex=this.getCellNodeIndex(e.cellNode),e.cell=e.cellIndex>=0?this.grid.getCell(e.cellIndex):null},findTarget:function(e,t){for(var a=e;a&&a!=this.domNode&&(!(t in a)||b in a&&a[b]!=this.view.id);)a=a.parentNode;return a!=this.domNode?a:null},findRowTarget:function(e){return this.findTarget(e,M)},isIntraNodeEvent:function(e){try{return e.cellNode&&e.relatedTarget&&h.isDescendant(e.relatedTarget,e.cellNode)}catch(t){return!1}},isIntraRowEvent:function(e){try{var t=e.relatedTarget&&this.findRowTarget(e.relatedTarget);return!t&&-1==e.rowIndex||t&&e.rowIndex==t.gridRowIndex}catch(a){return!1}},dispatchEvent:function(e){return e.dispatch in this?this[e.dispatch](e):!1},domouseover:function(e){e.cellNode&&e.cellNode!=this.lastOverCellNode&&(this.lastOverCellNode=e.cellNode,this.grid.onMouseOver(e)),this.grid.onMouseOverRow(e)},domouseout:function(e){e.cellNode&&e.cellNode==this.lastOverCellNode&&!this.isIntraNodeEvent(e,this.lastOverCellNode)&&(this.lastOverCellNode=null,this.grid.onMouseOut(e),this.isIntraRowEvent(e)||this.grid.onMouseOutRow(e))},domousedown:function(e){e.cellNode&&this.grid.onMouseDown(e),this.grid.onMouseDownRow(e)},_getTextDirStyle:function(e,t,a){return""}}),w=m._ContentBuilder=a.extend(function(e){k.call(this,e)},k.prototype,{update:function(){this.prepareHtml()},prepareHtml:function(){for(var e,t=this.grid.get,a=this.view.structure.cells,i=0;e=a[i];i++)for(var r,o=0;r=e[o];o++)r.get=r.get||void 0==r.value&&t,r.markup=this.generateCellMarkup(r,r.cellStyles,r.cellClasses,!1),!this.grid.editable&&r.editable&&(this.grid.editable=!0)},generateHtml:function(e,t){var a,i=this.getTableArray(),r=this.view,o=r.structure.cells,n=this.grid.getItem(t);l.fire(this.view,"onBeforeRow",[t,o]);for(var s,d=0;s=o[d];d++)if(!s.hidden&&!s.header){i.push(s.invisible?'<tr class="dojoxGridInvisible">':"<tr>");for(var h,u,m,c,f=0;h=s[f];f++)u=h.markup,m=h.customClasses=[],c=h.customStyles=[],u[5]=h.format(t,n),u[1]=m.join(" "),u[3]=c.join(";"),a=h.textDir||this.grid.textDir,a&&(u[3]+=this._getTextDirStyle(a,h,t)),i.push.apply(i,u);i.push("</tr>")}return i.push("</table>"),i.join("")},decorateEvent:function(e){return e.rowNode=this.findRowTarget(e.target),e.rowNode?(e.rowIndex=e.rowNode[M],this.baseDecorateEvent(e),e.cell=this.grid.getCell(e.cellIndex),!0):!1}}),_=m._HeaderBuilder=a.extend(function(e){this.moveable=null,k.call(this,e)},k.prototype,{_skipBogusClicks:!1,overResizeWidth:4,minColWidth:1,update:function(){this.tableMap?this.tableMap.mapRows(this.view.structure.cells):this.tableMap=new m._TableMap(this.view.structure.cells)},generateHtml:function(e,t){var a,i=this.getTableArray(),r=this.view.structure.cells;l.fire(this.view,"onBeforeRow",[-1,r]);for(var o,n=0;o=r[n];n++)if(!o.hidden){i.push(o.invisible?'<tr class="dojoxGridInvisible">':"<tr>");for(var s,d,h=0;s=o[h];h++)s.customClasses=[],s.customStyles=[],this.view.simpleStructure&&(s.draggable&&(s.headerClasses?-1==s.headerClasses.indexOf("dojoDndItem")&&(s.headerClasses+=" dojoDndItem"):s.headerClasses="dojoDndItem"),s.attrs?-1==s.attrs.indexOf("dndType='gridColumn_")&&(s.attrs+=" dndType='gridColumn_"+this.grid.id+"'"):s.attrs="dndType='gridColumn_"+this.grid.id+"'"),d=this.generateCellMarkup(s,s.headerStyles,s.headerClasses,!0),d[5]=void 0!=t?t:e(s),d[3]=s.customStyles.join(";"),a=s.textDir||this.grid.textDir,a&&(d[3]+=this._getTextDirStyle(a,s,t)),d[1]=s.customClasses.join(" "),i.push(d.join(""));i.push("</tr>")}return i.push("</table>"),i.join("")},getCellX:function(e){var t,a,i;return t=g(e.target,v("th")),t?(i=u.position(t),a=e.clientX-i.x):a=e.layerX,a},decorateEvent:function(e){return this.baseDecorateEvent(e),e.rowIndex=-1,e.cellX=this.getCellX(e),!0},prepareResize:function(e,t){do{var a=e.cellIndex;e.cellNode=a?e.cellNode.parentNode.cells[a+t]:null,e.cellIndex=e.cellNode?this.getCellNodeIndex(e.cellNode):-1}while(e.cellNode&&"none"==e.cellNode.style.display);return Boolean(e.cellNode)},canResize:function(e){if(!e.cellNode||e.cellNode.colSpan>1)return!1;var t=this.grid.getCell(e.cellIndex);return!t.noresize&&t.canResize()},overLeftResizeArea:function(e){if(h.hasClass(i.body(),"dojoDndMove"))return!1;if(o("ie")){var t=e.target;if(h.hasClass(t,"dojoxGridArrowButtonNode")||h.hasClass(t,"dojoxGridArrowButtonChar")||h.hasClass(t,"dojoxGridColCaption"))return!1}if(this.grid.isLeftToRight())return e.cellIndex>0&&e.cellX>0&&e.cellX<this.overResizeWidth&&this.prepareResize(e,-1);var a=e.cellNode&&e.cellX>0&&e.cellX<this.overResizeWidth;return a},overRightResizeArea:function(e){if(h.hasClass(i.body(),"dojoDndMove"))return!1;if(o("ie")){var t=e.target;if(h.hasClass(t,"dojoxGridArrowButtonNode")||h.hasClass(t,"dojoxGridArrowButtonChar")||h.hasClass(t,"dojoxGridColCaption"))return!1}return this.grid.isLeftToRight()?e.cellNode&&e.cellX>=e.cellNode.offsetWidth-this.overResizeWidth:e.cellIndex>0&&e.cellX>=e.cellNode.offsetWidth-this.overResizeWidth&&this.prepareResize(e,-1)},domousemove:function(e){if(!this.moveable){var t=this.overRightResizeArea(e)?"dojoxGridColResize":this.overLeftResizeArea(e)?"dojoxGridColResize":"";t&&!this.canResize(e)&&(t="dojoxGridColNoResize"),h.toggleClass(e.sourceView.headerNode,"dojoxGridColNoResize","dojoxGridColNoResize"==t),h.toggleClass(e.sourceView.headerNode,"dojoxGridColResize","dojoxGridColResize"==t),t&&r.stop(e)}},domousedown:function(e){this.moveable||((this.overRightResizeArea(e)||this.overLeftResizeArea(e))&&this.canResize(e)?this.beginColumnResize(e):(this.grid.onMouseDown(e),this.grid.onMouseOverRow(e)))},doclick:function(e){return this._skipBogusClicks?(r.stop(e),!0):!1},colResizeSetup:function(e,t){var a=h.contentBox(e.sourceView.headerNode);if(t){this.lineDiv=document.createElement("div");var r=h.position(e.sourceView.headerNode,!0),n=h.contentBox(e.sourceView.domNode),s=e.pageX;!this.grid.isLeftToRight()&&o("ie")<8&&(s-=d.getScrollbar().w),h.style(this.lineDiv,{top:r.y+"px",left:s+"px",height:n.h+a.h+"px"}),h.addClass(this.lineDiv,"dojoxGridResizeColLine"),this.lineDiv._origLeft=s,i.body().appendChild(this.lineDiv)}for(var l,u=[],m=this.tableMap.findOverlappingNodes(e.cellNode),c=0;l=m[c];c++)u.push({node:l,index:this.getCellNodeIndex(l),width:l.offsetWidth});for(var f,p=e.sourceView,y=this.grid.isLeftToRight()?1:-1,g=e.grid.views.views,v=[],M=p.idx+y;f=g[M];M+=y)v.push({node:f.headerNode,left:window.parseInt(f.headerNode.style.left)});var b=p.headerContentNode.firstChild,k={scrollLeft:e.sourceView.headerNode.scrollLeft,view:p,node:e.cellNode,index:e.cellIndex,w:h.contentBox(e.cellNode).w,vw:a.w,table:b,tw:h.contentBox(b).w,spanners:u,followers:v};return k},beginColumnResize:function(e){this.moverDiv=document.createElement("div"),h.style(this.moverDiv,{position:"absolute",left:0}),i.body().appendChild(this.moverDiv),h.addClass(this.grid.domNode,"dojoxGridColumnResizing");var t=this.moveable=new s(this.moverDiv),r=this.colResizeSetup(e,!0);t.onMove=a.hitch(this,"doResizeColumn",r),n.connect(t,"onMoveStop",a.hitch(this,function(){this.endResizeColumn(r),r.node.releaseCapture&&r.node.releaseCapture(),this.moveable.destroy(),delete this.moveable,this.moveable=null,h.removeClass(this.grid.domNode,"dojoxGridColumnResizing")})),e.cellNode.setCapture&&e.cellNode.setCapture(),t.onMouseDown(e)},doResizeColumn:function(e,t,a){var i=a.l,r={deltaX:i,w:e.w+(this.grid.isLeftToRight()?i:-i),vw:e.vw+i,tw:e.tw+i};this.dragRecord={inDrag:e,mover:t,leftTop:a},r.w>=this.minColWidth&&(t?h.style(this.lineDiv,"left",this.lineDiv._origLeft+r.deltaX+"px"):this.doResizeNow(e,r))},endResizeColumn:function(e){if(this.dragRecord){var t=this.dragRecord.leftTop,a=this.grid.isLeftToRight()?t.l:-t.l;a+=Math.max(e.w+a,this.minColWidth)-(e.w+a),o("webkit")&&e.spanners.length&&(a+=h._getPadBorderExtents(e.spanners[0].node).w);var i={deltaX:a,w:e.w+a,vw:e.vw+a,tw:e.tw+a};this.doResizeNow(e,i),delete this.dragRecord}h.destroy(this.lineDiv),h.destroy(this.moverDiv),h.destroy(this.moverDiv),delete this.moverDiv,this._skipBogusClicks=!0,e.view.update(),this._skipBogusClicks=!1,this.grid.onResizeColumn(e.index)},doResizeNow:function(e,t){if(e.view.convertColPctToFixed(),e.view.flexCells&&!e.view.testFlexCells()){var a=y(e.node);a&&(a.style.width="")}var i,r,n,s,d;for(i=0;r=e.spanners[i];i++)n=r.width+t.deltaX,n>0&&(r.node.style.width=n+"px",e.view.setColWidth(r.index,n));if(this.grid.isLeftToRight()||!o("ie"))for(i=0;s=e.followers[i];i++)d=s.left+t.deltaX,s.node.style.left=d+"px";e.node.style.width=t.w+"px",e.view.setColWidth(e.index,t.w),e.view.headerNode.style.width=t.vw+"px",e.view.setColumnsWidth(t.tw),this.grid.isLeftToRight()||(e.view.headerNode.scrollLeft=e.scrollLeft+t.deltaX)}});return m._TableMap=a.extend(function(e){this.mapRows(e)},{map:null,mapRows:function(e){var t=e.length;if(t){this.map=[];for(var a,i=0;a=e[i];i++)this.map[i]=[];for(var r=0;a=e[r];r++)for(var o,n,s,d=0,l=0;o=a[d];d++){for(;this.map[r][l];)l++;this.map[r][l]={c:d,r:r},s=o.rowSpan||1,n=o.colSpan||1;for(var h=0;s>h;h++)for(var u=0;n>u;u++)this.map[r+h][l+u]=this.map[r][l];l+=n}}},dumpMap:function(){for(var e,t=0,a="";e=this.map[t];t++,a="")for(var i,r=0;i=e[r];r++)a+=i.r+","+i.c+"   "},getMapCoords:function(e,t){for(var a,i=0;a=this.map[i];i++)for(var r,o=0;r=a[o];o++)if(r.c==t&&r.r==e)return{j:i,i:o};return{j:-1,i:-1}},getNode:function(e,t,a){var i=e&&e.rows[t];return i&&i.cells[a]},_findOverlappingNodes:function(e,t,a){for(var i,r=[],o=this.getMapCoords(t,a),n=0;i=this.map[n];n++)if(n!=o.j){var s=i[o.i],d=s?this.getNode(e,s.r,s.c):null;d&&r.push(d)}return r},findOverlappingNodes:function(e){return this._findOverlappingNodes(y(e),f(e.parentNode),c(e))}}),{_Builder:k,_HeaderBuilder:_,_ContentBuilder:w}});//# sourceMappingURL=_Builder.js.map