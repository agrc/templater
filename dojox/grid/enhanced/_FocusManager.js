//>>built
define("dojox/grid/enhanced/_FocusManager",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/connect","dojo/_base/event","dojo/_base/sniff","dojo/_base/html","dojo/keys","dijit/a11y","dijit/focus","../_FocusManager"],function(e,t,i,a,n,r,o,s,l,d,h,u){var c=i("dojox.grid.enhanced._FocusArea",null,{constructor:function(e,i){this._fm=i,this._evtStack=[e.name];var a=function(){return!0};e.onFocus=e.onFocus||a,e.onBlur=e.onBlur||a,e.onMove=e.onMove||a,e.onKeyUp=e.onKeyUp||a,e.onKeyDown=e.onKeyDown||a,t.mixin(this,e)},move:function(e,t,i){if(this.name){var a,n=this._evtStack.length;for(a=n-1;a>=0;--a)if(this._fm._areas[this._evtStack[a]].onMove(e,t,i)===!1)return!1}return!0},_onKeyEvent:function(e,t){if(this.name){var i,a=this._evtStack.length;for(i=a-1;i>=0;--i)if(this._fm._areas[this._evtStack[i]][t](e,!1)===!1)return!1;for(i=0;a>i;++i)if(this._fm._areas[this._evtStack[i]][t](e,!0)===!1)return!1}return!0},keydown:function(e){return this._onKeyEvent(e,"onKeyDown")},keyup:function(e){return this._onKeyEvent(e,"onKeyUp")},contentMouseEventPlanner:function(){return 0},headerMouseEventPlanner:function(){return 0}});return i("dojox.grid.enhanced._FocusManager",u,{_stopEvent:function(e){try{e&&e.preventDefault&&r.stop(e)}catch(t){}},constructor:function(e){this.grid=e,this._areas={},this._areaQueue=[],this._contentMouseEventHandlers=[],this._headerMouseEventHandlers=[],this._currentAreaIdx=-1,this._gridBlured=!0,this._connects.push(n.connect(e,"onBlur",this,"_doBlur")),this._connects.push(n.connect(e.scroller,"renderPage",this,"_delayedCellFocus")),this.addArea({name:"header",onFocus:t.hitch(this,this.focusHeader),onBlur:t.hitch(this,this._blurHeader),onMove:t.hitch(this,this._navHeader),getRegions:t.hitch(this,this._findHeaderCells),onRegionFocus:t.hitch(this,this.doColHeaderFocus),onRegionBlur:t.hitch(this,this.doColHeaderBlur),onKeyDown:t.hitch(this,this._onHeaderKeyDown)}),this.addArea({name:"content",onFocus:t.hitch(this,this._focusContent),onBlur:t.hitch(this,this._blurContent),onMove:t.hitch(this,this._navContent),onKeyDown:t.hitch(this,this._onContentKeyDown)}),this.addArea({name:"editableCell",onFocus:t.hitch(this,this._focusEditableCell),onBlur:t.hitch(this,this._blurEditableCell),onKeyDown:t.hitch(this,this._onEditableCellKeyDown),onContentMouseEvent:t.hitch(this,this._onEditableCellMouseEvent),contentMouseEventPlanner:function(e,t){return-1}}),this.placeArea("header"),this.placeArea("content"),this.placeArea("editableCell"),this.placeArea("editableCell","above","content")},destroy:function(){for(var e in this._areas){var t=this._areas[e];a.forEach(t._connects,n.disconnect),t._connects=null,t.uninitialize&&t.uninitialize()}this.inherited(arguments)},addArea:function(e){e.name&&t.isString(e.name)&&(this._areas[e.name]&&a.forEach(e._connects,n.disconnect),this._areas[e.name]=new c(e,this),e.onHeaderMouseEvent&&this._headerMouseEventHandlers.push(e.name),e.onContentMouseEvent&&this._contentMouseEventHandlers.push(e.name))},getArea:function(e){return this._areas[e]},_bindAreaEvents:function(){var e,i,r=this._areas;a.forEach(this._areaQueue,function(o){e=r[o],!e._initialized&&t.isFunction(e.initialize)&&(e.initialize(),e._initialized=!0),e.getRegions&&(e._regions=e.getRegions()||[],a.forEach(e._connects||[],n.disconnect),e._connects=[],a.forEach(e._regions,function(t){e.onRegionFocus&&(i=n.connect(t,"onfocus",e.onRegionFocus),e._connects.push(i)),e.onRegionBlur&&(i=n.connect(t,"onblur",e.onRegionBlur),e._connects.push(i))}))})},removeArea:function(e){var t=this._areas[e];if(t){this.ignoreArea(e);var i=a.indexOf(this._contentMouseEventHandlers,e);i>=0&&this._contentMouseEventHandlers.splice(i,1),i=a.indexOf(this._headerMouseEventHandlers,e),i>=0&&this._headerMouseEventHandlers.splice(i,1),a.forEach(t._connects,n.disconnect),t.uninitialize&&t.uninitialize(),delete this._areas[e]}},currentArea:function(e,i){var n,r=this._currentAreaIdx;return t.isString(e)&&(n=a.indexOf(this._areaQueue,e))>=0?(r!=n&&(this.tabbingOut=!1,i&&r>=0&&r<this._areaQueue.length&&this._areas[this._areaQueue[r]].onBlur(),this._currentAreaIdx=n),null):0>r||r>=this._areaQueue.length?new c({},this):this._areas[this._areaQueue[this._currentAreaIdx]]},placeArea:function(e,t,i){if(this._areas[e]){var n=a.indexOf(this._areaQueue,i);switch(t){case"after":n>=0&&++n;case"before":if(n>=0){this._areaQueue.splice(n,0,e);break}default:this._areaQueue.push(e);break;case"above":var r=!0;case"below":var o=this._areas[i];o&&(r?o._evtStack.push(e):o._evtStack.splice(0,0,e))}}},ignoreArea:function(e){this._areaQueue=a.filter(this._areaQueue,function(t){return t!=e})},focusArea:function(e,i){var n;n="number"==typeof e?0>e?this._areaQueue.length+e:e:a.indexOf(this._areaQueue,t.isString(e)?e:e&&e.name),0>n&&(n=0);var r=n-this._currentAreaIdx;this._gridBlured=!1,r?this.tab(r,i):this.currentArea().onFocus(i,r)},tab:function(e,i){if(this._gridBlured=!1,this.tabbingOut=!1,0!==e){var n=this._currentAreaIdx,r=e>0?1:-1;if(0>n||n>=this._areaQueue.length)n=this._currentAreaIdx+=e;else{var o=this._areas[this._areaQueue[n]].onBlur(i,e);o===!0?n=this._currentAreaIdx+=e:t.isString(o)&&this._areas[o]&&(n=this._currentAreaIdx=a.indexOf(this._areaQueue,o))}for(;n>=0&&n<this._areaQueue.length;n+=r)if(this._currentAreaIdx=n,this._areaQueue[n]&&this._areas[this._areaQueue[n]].onFocus(i,e))return;this.tabbingOut=!0,0>e?(this._currentAreaIdx=-1,h.focus(this.grid.domNode)):(this._currentAreaIdx=this._areaQueue.length,h.focus(this.grid.lastFocusNode))}},_onMouseEvent:function(e,t){for(var i=e.toLowerCase(),n=this["_"+i+"MouseEventHandlers"],r=a.map(n,function(e){return{area:e,idx:this._areas[e][i+"MouseEventPlanner"](t,n)}},this).sort(function(e,t){return t.idx-e.idx}),o=a.map(r,function(e){return r.area}),s=r.length;--s>=0;)if(this._areas[r[s].area]["on"+e+"MouseEvent"](t,o)===!1)return},contentMouseEvent:function(e){this._onMouseEvent("Content",e)},headerMouseEvent:function(e){this._onMouseEvent("Header",e)},initFocusView:function(){this.focusView=this.grid.views.getFirstScrollingView()||this.focusView||this.grid.views.views[0],this._bindAreaEvents()},isNavHeader:function(){return"header"==this._areaQueue[this._currentAreaIdx]},previousKey:function(e){this.tab(-1,e)},nextKey:function(e){this.tab(1,e)},setFocusCell:function(e,t){e&&(this.currentArea(this.grid.edit.isEditing()?"editableCell":"content",!0),this._focusifyCellNode(!1),this.cell=e,this.rowIndex=t,this._focusifyCellNode(!0)),this.grid.onCellFocus(this.cell,this.rowIndex)},doFocus:function(e){e&&e.target==e.currentTarget&&!this.tabbingOut?this._gridBlured&&(this._gridBlured=!1,this._currentAreaIdx<0||this._currentAreaIdx>=this._areaQueue.length?this.focusArea(0,e):this.focusArea(this._currentAreaIdx,e)):this.tabbingOut=!1,r.stop(e)},_doBlur:function(){this._gridBlured=!0},doLastNodeFocus:function(e){this.tabbingOut?this.tabbingOut=!1:this.focusArea(-1,e)},_delayedHeaderFocus:function(){this.isNavHeader()&&!o("ie")&&this.focusHeader()},_delayedCellFocus:function(){},_changeMenuBindNode:function(e,t){var i=this.grid.headerMenu;i&&this._contextMenuBindNode==e&&(i.unBindDomNode(e),i.bindDomNode(t),this._contextMenuBindNode=t)},focusHeader:function(e,t){var i=!1;return this.inherited(arguments),this._colHeadNode&&"none"!=s.style(this._colHeadNode,"display")&&(h.focus(this._colHeadNode),this._stopEvent(e),i=!0),i},_blurHeader:function(e,t){return this._colHeadNode&&s.removeClass(this._colHeadNode,this.focusClass),s.removeAttr(this.grid.domNode,"aria-activedescendant"),this._changeMenuBindNode(this.grid.domNode,this.grid.viewsHeaderNode),this._colHeadNode=this._colHeadFocusIdx=null,!0},_navHeader:function(e,t,i){var n=0>t?-1:1,r=a.indexOf(this._findHeaderCells(),this._colHeadNode);return r>=0&&i.shiftKey&&i.ctrlKey?void this.colSizeAdjust(i,r,5*n):void this.move(e,t)},_onHeaderKeyDown:function(e,t){if(t){var i=l;switch(e.keyCode){case i.ENTER:case i.SPACE:var a=this.getHeaderIndex();a>=0&&!this.grid.pluginMgr.isFixedCell(e.cell)&&(this.grid.setSortIndex(a,null,e),r.stop(e))}}return!0},_setActiveColHeader:function(){this.inherited(arguments),h.focus(this._colHeadNode)},findAndFocusGridCell:function(){this._focusContent()},_focusContent:function(e,t){var i=!0,a=0===this.grid.rowCount;if(this.isNoFocusCell()&&!a){for(var n=0,r=this.grid.getCell(0);r&&r.hidden;r=this.grid.getCell(++n));this.setFocusIndex(0,r?n:0)}else this.cell&&!a?this.focusView&&!this.focusView.rowNodes[this.rowIndex]?(this.grid.scrollToRow(this.rowIndex),this.focusGrid()):this.setFocusIndex(this.rowIndex,this.cell.index):i=!1;return i&&this._stopEvent(e),i},_blurContent:function(e,t){return this._focusifyCellNode(!1),!0},_navContent:function(e,t,i){0===this.rowIndex&&0>e||this.rowIndex===this.grid.rowCount-1&&e>0||(this._colHeadNode=null,this.move(e,t,i),i&&r.stop(i))},_onContentKeyDown:function(e,t){if(t){var i=l,a=this.grid.scroller;switch(e.keyCode){case i.ENTER:case i.SPACE:var o=this.grid;if(o.indirectSelection)break;o.selection.clickSelect(this.rowIndex,n.isCopyKey(e),e.shiftKey),o.onRowClick(e),r.stop(e);break;case i.PAGE_UP:0!==this.rowIndex&&(this.rowIndex!=a.firstVisibleRow+1?this._navContent(a.firstVisibleRow-this.rowIndex,0):(this.grid.setScrollTop(a.findScrollTop(this.rowIndex-1)),this._navContent(a.firstVisibleRow-a.lastVisibleRow+1,0)),r.stop(e));break;case i.PAGE_DOWN:this.rowIndex+1!=this.grid.rowCount&&(r.stop(e),this.rowIndex!=a.lastVisibleRow-1?this._navContent(a.lastVisibleRow-this.rowIndex-1,0):(this.grid.setScrollTop(a.findScrollTop(this.rowIndex+1)),this._navContent(a.lastVisibleRow-a.firstVisibleRow-1,0)),r.stop(e))}}return!0},_blurFromEditableCell:!1,_isNavigating:!1,_navElems:null,_focusEditableCell:function(e,t){var i=!1;return this._isNavigating?i=!0:this.grid.edit.isEditing()&&this.cell&&(!this._blurFromEditableCell&&this._blurEditableCell(e,t)||(this.setFocusIndex(this.rowIndex,this.cell.index),i=!0),this._stopEvent(e)),i},_applyEditableCell:function(){try{this.grid.edit.apply()}catch(e){}},_blurEditableCell:function(e,t){if(this._blurFromEditableCell=!1,this._isNavigating){var i=!0;if(e){var a=this._navElems,n=a.lowest||a.first,r=a.last||a.highest||n,l=o("ie")?e.srcElement:e.target;i=l==(t>0?r:n)}return i?(this._isNavigating=!1,s.setSelectable(this.cell.getNode(this.rowIndex),!1),"content"):!1}if(this.grid.edit.isEditing()&&this.cell){if(!t||"number"!=typeof t)return!1;for(var d,h=t>0?1:-1,u=this.grid.layout.cellCount,c=this.cell.index+h;c>=0&&u>c;c+=h)if(d=this.grid.getCell(c),d.editable)return this.cell=d,this._blurFromEditableCell=!0,!1;if((this.rowIndex>0||1==h)&&(this.rowIndex<this.grid.rowCount||-1==h)){for(this.rowIndex+=h,c=h>0?0:u-1;c>=0&&u>c;c+=h)if(d=this.grid.getCell(c),d.editable){this.cell=d;break}return this._applyEditableCell(),"content"}}return!0},_initNavigatableElems:function(){this._navElems=d._getTabNavigable(this.cell.getNode(this.rowIndex))},_onEditableCellKeyDown:function(e,t){var i=l,a=this.grid,n=a.edit,o=!1,d=!0;switch(e.keyCode){case i.ENTER:t&&n.isEditing()&&(this._applyEditableCell(),o=!0,r.stop(e));case i.SPACE:if(!t&&this._isNavigating){d=!1;break}if(t){if(!this.cell.editable&&this.cell.navigatable){this._initNavigatableElems();var u=this._navElems.lowest||this._navElems.first;if(u){this._isNavigating=!0,s.setSelectable(this.cell.getNode(this.rowIndex),!0),h.focus(u),r.stop(e),this.currentArea("editableCell",!0);break}}o||n.isEditing()||a.pluginMgr.isFixedCell(this.cell)||n.setEditCell(this.cell,this.rowIndex),o?this.currentArea("content",!0):this.cell.editable&&a.canEdit()&&this.currentArea("editableCell",!0)}break;case i.PAGE_UP:case i.PAGE_DOWN:!t&&n.isEditing()&&(d=!1);break;case i.ESCAPE:t||(n.cancel(),this.currentArea("content",!0))}return d},_onEditableCellMouseEvent:function(e){if("click"==e.type){var t=this.cell||e.cell;if(t&&!t.editable&&t.navigatable){if(this._initNavigatableElems(),this._navElems.lowest||this._navElems.first){var i=o("ie")?e.srcElement:e.target;if(i!=t.getNode(e.rowIndex))return this._isNavigating=!0,this.focusArea("editableCell",e),s.setSelectable(t.getNode(e.rowIndex),!0),h.focus(i),!1}}else if(this.grid.singleClickEdit)return this.currentArea("editableCell"),!1}return!0}})});//# sourceMappingURL=_FocusManager.js.map