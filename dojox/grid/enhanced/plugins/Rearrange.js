//>>built
define("dojox/grid/enhanced/plugins/Rearrange",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/connect","../../EnhancedGrid","../_Plugin","./_RowMapLayer"],function(e,t,i,a,r,n,o,s){var l=i("dojox.grid.enhanced.plugins.Rearrange",o,{name:"rearrange",constructor:function(e,t){this.grid=e,this.setArgs(t);var i=new s(e);dojox.grid.enhanced.plugins.wrap(e,"_storeLayerFetch",i)},setArgs:function(e){this.args=t.mixin(this.args||{},e||{}),this.args.setIdentifierForNewItem=this.args.setIdentifierForNewItem||function(e){return e}},destroy:function(){this.inherited(arguments),this.grid.unwrap("rowmap")},onSetStore:function(e){this.grid.layer("rowmap").clearMapping()},_hasIdentity:function(e){var t=this.grid,i=t.store,r=t.layout.cells;return!(!i.getFeatures()["dojo.data.api.Identity"]||!a.some(e,function(e){return i.getIdentityAttributes(t._by_idx[e.r].item)==r[e.c].field}))},moveColumns:function(e,t){var i,a,n=this.grid,o=n.layout,s=o.cells,l=0,d=!0,u={},c={};for(e.sort(function(e,t){return e-t}),a=0;a<e.length;++a)u[e[a]]=a,e[a]<t&&++l;var h=0,m=0,f=Math.max(e[e.length-1],t);f==s.length&&--f;var g=Math.min(e[0],t);for(a=g;f>=a;++a){var p=u[a];p>=0?c[a]=t-l+p:t>a?(c[a]=g+h,++h):a>=t&&(c[a]=t+e.length-l+m,++m)}for(l=0,t==s.length&&(--t,d=!1),n._notRefreshSelection=!0,a=0;a<e.length;++a)i=e[a],t>i&&(i-=l),++l,i!=t&&(o.moveColumn(s[i].view.idx,s[t].view.idx,i,t,d),s=o.cells),i>=t&&++t;delete n._notRefreshSelection,r.publish("dojox/grid/rearrange/move/"+n.id,["col",c,e])},moveRows:function(e,i){var n,o,s,l,d,u,c=this.grid,h={},m=[],f=[],g=e.length;for(n=0;g>n&&(o=e[n],!(o>=i));++n)m.push(o);if(f=e.slice(n),l=m,g=l.length)for(d={},a.forEach(l,function(e){d[e]=!0}),h[l[0]]=i-g,s=0,n=l[s]+1,u=n-1;i>n;++n)d[n]?(++s,h[n]=i-g+s):(h[n]=u,++u);if(l=f,g=l.length)for(d={},a.forEach(l,function(e){d[e]=!0}),h[l[g-1]]=i+g-1,s=g-1,n=l[s]-1,u=n+1;n>=i;--n)d[n]?(--s,h[n]=i+s):(h[n]=u,--u);var p=t.clone(h);c.layer("rowmap").setMapping(h),c.forEachLayer(function(e){return"rowmap"!=e.name()?(e.invalidate(),!0):!1},!1),c.selection.selected=[],c._noInternalMapping=!0,c._refresh(),setTimeout(function(){r.publish("dojox/grid/rearrange/move/"+c.id,["row",p,e]),c._noInternalMapping=!1},0)},moveCells:function(e,t){var i=this.grid,n=i.store;if(n.getFeatures()["dojo.data.api.Write"]){if(e.min.row==t.min.row&&e.min.col==t.min.col)return;var o,s,l,d,u=i.layout.cells,c=(e.max.row-e.min.row+1,[]),h=[];for(o=e.min.row,l=t.min.row;o<=e.max.row;++o,++l)for(s=e.min.col,d=t.min.col;s<=e.max.col;++s,++d){for(;u[s]&&u[s].hidden;)++s;for(;u[d]&&u[d].hidden;)++d;c.push({r:o,c:s}),h.push({r:l,c:d,v:u[s].get(o,i._by_idx[o].item)})}if(this._hasIdentity(c.concat(h)))return;a.forEach(c,function(e){n.setValue(i._by_idx[e.r].item,u[e.c].field,"")}),a.forEach(h,function(e){n.setValue(i._by_idx[e.r].item,u[e.c].field,e.v)}),n.save({onComplete:function(){r.publish("dojox/grid/rearrange/move/"+i.id,["cell",{from:e,to:t}])}})}},copyCells:function(e,t){var i=this.grid,n=i.store;if(n.getFeatures()["dojo.data.api.Write"]){if(e.min.row==t.min.row&&e.min.col==t.min.col)return;var o,s,l,d,u=i.layout.cells,c=(e.max.row-e.min.row+1,[]);for(o=e.min.row,l=t.min.row;o<=e.max.row;++o,++l)for(s=e.min.col,d=t.min.col;s<=e.max.col;++s,++d){for(;u[s]&&u[s].hidden;)++s;for(;u[d]&&u[d].hidden;)++d;c.push({r:l,c:d,v:u[s].get(o,i._by_idx[o].item)})}if(this._hasIdentity(c))return;a.forEach(c,function(e){n.setValue(i._by_idx[e.r].item,u[e.c].field,e.v)}),n.save({onComplete:function(){setTimeout(function(){r.publish("dojox/grid/rearrange/copy/"+i.id,["cell",{from:e,to:t}])},0)}})}},changeCells:function(e,t,i){var n=this.grid,o=n.store;if(o.getFeatures()["dojo.data.api.Write"]){var s,l,d,u,c=e,h=n.layout.cells,m=c.layout.cells,f=(t.max.row-t.min.row+1,[]);for(s=t.min.row,d=i.min.row;s<=t.max.row;++s,++d)for(l=t.min.col,u=i.min.col;l<=t.max.col;++l,++u){for(;m[l]&&m[l].hidden;)++l;for(;h[u]&&h[u].hidden;)++u;f.push({r:d,c:u,v:m[l].get(s,c._by_idx[s].item)})}if(this._hasIdentity(f))return;a.forEach(f,function(e){o.setValue(n._by_idx[e.r].item,h[e.c].field,e.v)}),o.save({onComplete:function(){r.publish("dojox/grid/rearrange/change/"+n.id,["cell",i])}})}},clearCells:function(e){var t=this.grid,i=t.store;if(i.getFeatures()["dojo.data.api.Write"]){var n,o,s=t.layout.cells,l=(e.max.row-e.min.row+1,[]);for(n=e.min.row;n<=e.max.row;++n)for(o=e.min.col;o<=e.max.col;++o){for(;s[o]&&s[o].hidden;)++o;l.push({r:n,c:o})}if(this._hasIdentity(l))return;a.forEach(l,function(e){i.setValue(t._by_idx[e.r].item,s[e.c].field,"")}),i.save({onComplete:function(){r.publish("dojox/grid/rearrange/change/"+t.id,["cell",e])}})}},insertRows:function(e,i,n){try{var o,s=this.grid,l=s.store,d=s.rowCount,u={},c={idx:0},h=[],m=0>n,f=this,g=i.length;if(m)n=0;else for(o=n;o<s.rowCount;++o)u[o]=o+g;if(l.getFeatures()["dojo.data.api.Write"]){if(e){var p,y,v=e,b=v.store;if(m)y=a.filter(a.map(s.layout.cells,function(e){return e.field}),function(e){return e});else{for(o=0;!p;++o)p=s._by_idx[o];y=l.getAttributes(p.item)}var k=[];a.forEach(i,function(e,t){var i={},r=v._by_idx[e];if(r){a.forEach(y,function(e){i[e]=b.getValue(r.item,e)}),i=f.args.setIdentifierForNewItem(i,l,d+c.idx)||i;try{l.newItem(i),h.push(n+t),u[d+c.idx]=n+t,++c.idx}catch(o){}}else k.push(e)})}else{if(!i.length||!t.isObject(i[0]))return;a.forEach(i,function(e,t){var i=f.args.setIdentifierForNewItem(e,l,d+c.idx)||e;try{l.newItem(i),h.push(n+t),u[d+c.idx]=n+t,++c.idx}catch(a){}})}s.layer("rowmap").setMapping(u),l.save({onComplete:function(){s._refresh(),setTimeout(function(){r.publish("dojox/grid/rearrange/insert/"+s.id,["row",h])},0)}})}}catch(M){}},removeRows:function(e){var t=this.grid,i=t.store;try{a.forEach(a.map(e,function(e){return t._by_idx[e]}),function(e){e&&i.deleteItem(e.item)}),i.save({onComplete:function(){r.publish("dojox/grid/rearrange/remove/"+t.id,["row",e])}})}catch(n){}},_getPageInfo:function(){var e,t,i,r=this.grid.scroller,n=r.page,o=r.page,s=r.firstVisibleRow,l=r.lastVisibleRow,d=r.rowsPerPage,u=r.pageNodes[0],c=[];return a.forEach(u,function(a,r){a&&(i=!1,e=r*d,t=(r+1)*d-1,s>=e&&t>=s&&(n=r,i=!0),l>=e&&t>=l&&(o=r,i=!0),!i&&(e>l||s>t)&&c.push(r))}),{topPage:n,bottomPage:o,invalidPages:c}}});return n.registerPlugin(l),l});//# sourceMappingURL=Rearrange.js.map