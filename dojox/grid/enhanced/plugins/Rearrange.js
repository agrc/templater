//>>built
define("dojox/grid/enhanced/plugins/Rearrange",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/connect","../../EnhancedGrid","../_Plugin","./_RowMapLayer"],function(e,t,i,a,r,o,n,s){var d=i("dojox.grid.enhanced.plugins.Rearrange",n,{name:"rearrange",constructor:function(e,t){this.grid=e,this.setArgs(t);var i=new s(e);dojox.grid.enhanced.plugins.wrap(e,"_storeLayerFetch",i)},setArgs:function(e){this.args=t.mixin(this.args||{},e||{}),this.args.setIdentifierForNewItem=this.args.setIdentifierForNewItem||function(e){return e}},destroy:function(){this.inherited(arguments),this.grid.unwrap("rowmap")},onSetStore:function(e){this.grid.layer("rowmap").clearMapping()},_hasIdentity:function(e){var t=this.grid,i=t.store,r=t.layout.cells;return!(!i.getFeatures()["dojo.data.api.Identity"]||!a.some(e,function(e){return i.getIdentityAttributes(t._by_idx[e.r].item)==r[e.c].field}))},moveColumns:function(e,t){var i,a,o=this.grid,n=o.layout,s=n.cells,d=0,l=!0,h={},u={};for(e.sort(function(e,t){return e-t}),a=0;a<e.length;++a)h[e[a]]=a,e[a]<t&&++d;var c=0,m=0,f=Math.max(e[e.length-1],t);f==s.length&&--f;var p=Math.min(e[0],t);for(a=p;f>=a;++a){var y=h[a];y>=0?u[a]=t-d+y:t>a?(u[a]=p+c,++c):a>=t&&(u[a]=t+e.length-d+m,++m)}for(d=0,t==s.length&&(--t,l=!1),o._notRefreshSelection=!0,a=0;a<e.length;++a)i=e[a],t>i&&(i-=d),++d,i!=t&&(n.moveColumn(s[i].view.idx,s[t].view.idx,i,t,l),s=n.cells),i>=t&&++t;delete o._notRefreshSelection,r.publish("dojox/grid/rearrange/move/"+o.id,["col",u,e])},moveRows:function(e,i){var o,n,s,d,l,h,u=this.grid,c={},m=[],f=[],p=e.length;for(o=0;p>o&&(n=e[o],!(n>=i));++o)m.push(n);if(f=e.slice(o),d=m,p=d.length)for(l={},a.forEach(d,function(e){l[e]=!0}),c[d[0]]=i-p,s=0,o=d[s]+1,h=o-1;i>o;++o)l[o]?(++s,c[o]=i-p+s):(c[o]=h,++h);if(d=f,p=d.length)for(l={},a.forEach(d,function(e){l[e]=!0}),c[d[p-1]]=i+p-1,s=p-1,o=d[s]-1,h=o+1;o>=i;--o)l[o]?(--s,c[o]=i+s):(c[o]=h,--h);var y=t.clone(c);u.layer("rowmap").setMapping(c),u.forEachLayer(function(e){return"rowmap"!=e.name()?(e.invalidate(),!0):!1},!1),u.selection.selected=[],u._noInternalMapping=!0,u._refresh(),setTimeout(function(){r.publish("dojox/grid/rearrange/move/"+u.id,["row",y,e]),u._noInternalMapping=!1},0)},moveCells:function(e,t){var i=this.grid,o=i.store;if(o.getFeatures()["dojo.data.api.Write"]){if(e.min.row==t.min.row&&e.min.col==t.min.col)return;var n,s,d,l,h=i.layout.cells,u=(e.max.row-e.min.row+1,[]),c=[];for(n=e.min.row,d=t.min.row;n<=e.max.row;++n,++d)for(s=e.min.col,l=t.min.col;s<=e.max.col;++s,++l){for(;h[s]&&h[s].hidden;)++s;for(;h[l]&&h[l].hidden;)++l;u.push({r:n,c:s}),c.push({r:d,c:l,v:h[s].get(n,i._by_idx[n].item)})}if(this._hasIdentity(u.concat(c)))return;a.forEach(u,function(e){o.setValue(i._by_idx[e.r].item,h[e.c].field,"")}),a.forEach(c,function(e){o.setValue(i._by_idx[e.r].item,h[e.c].field,e.v)}),o.save({onComplete:function(){r.publish("dojox/grid/rearrange/move/"+i.id,["cell",{from:e,to:t}])}})}},copyCells:function(e,t){var i=this.grid,o=i.store;if(o.getFeatures()["dojo.data.api.Write"]){if(e.min.row==t.min.row&&e.min.col==t.min.col)return;var n,s,d,l,h=i.layout.cells,u=(e.max.row-e.min.row+1,[]);for(n=e.min.row,d=t.min.row;n<=e.max.row;++n,++d)for(s=e.min.col,l=t.min.col;s<=e.max.col;++s,++l){for(;h[s]&&h[s].hidden;)++s;for(;h[l]&&h[l].hidden;)++l;u.push({r:d,c:l,v:h[s].get(n,i._by_idx[n].item)})}if(this._hasIdentity(u))return;a.forEach(u,function(e){o.setValue(i._by_idx[e.r].item,h[e.c].field,e.v)}),o.save({onComplete:function(){setTimeout(function(){r.publish("dojox/grid/rearrange/copy/"+i.id,["cell",{from:e,to:t}])},0)}})}},changeCells:function(e,t,i){var o=this.grid,n=o.store;if(n.getFeatures()["dojo.data.api.Write"]){var s,d,l,h,u=e,c=o.layout.cells,m=u.layout.cells,f=(t.max.row-t.min.row+1,[]);for(s=t.min.row,l=i.min.row;s<=t.max.row;++s,++l)for(d=t.min.col,h=i.min.col;d<=t.max.col;++d,++h){for(;m[d]&&m[d].hidden;)++d;for(;c[h]&&c[h].hidden;)++h;f.push({r:l,c:h,v:m[d].get(s,u._by_idx[s].item)})}if(this._hasIdentity(f))return;a.forEach(f,function(e){n.setValue(o._by_idx[e.r].item,c[e.c].field,e.v)}),n.save({onComplete:function(){r.publish("dojox/grid/rearrange/change/"+o.id,["cell",i])}})}},clearCells:function(e){var t=this.grid,i=t.store;if(i.getFeatures()["dojo.data.api.Write"]){var o,n,s=t.layout.cells,d=(e.max.row-e.min.row+1,[]);for(o=e.min.row;o<=e.max.row;++o)for(n=e.min.col;n<=e.max.col;++n){for(;s[n]&&s[n].hidden;)++n;d.push({r:o,c:n})}if(this._hasIdentity(d))return;a.forEach(d,function(e){i.setValue(t._by_idx[e.r].item,s[e.c].field,"")}),i.save({onComplete:function(){r.publish("dojox/grid/rearrange/change/"+t.id,["cell",e])}})}},insertRows:function(e,i,o){try{var n,s=this.grid,d=s.store,l=s.rowCount,h={},u={idx:0},c=[],m=0>o,f=this,p=i.length;if(m)o=0;else for(n=o;n<s.rowCount;++n)h[n]=n+p;if(d.getFeatures()["dojo.data.api.Write"]){if(e){var y,g,v=e,b=v.store;if(m)g=a.filter(a.map(s.layout.cells,function(e){return e.field}),function(e){return e});else{for(n=0;!y;++n)y=s._by_idx[n];g=d.getAttributes(y.item)}var M=[];a.forEach(i,function(e,t){var i={},r=v._by_idx[e];if(r){a.forEach(g,function(e){i[e]=b.getValue(r.item,e)}),i=f.args.setIdentifierForNewItem(i,d,l+u.idx)||i;try{d.newItem(i),c.push(o+t),h[l+u.idx]=o+t,++u.idx}catch(n){}}else M.push(e)})}else{if(!i.length||!t.isObject(i[0]))return;a.forEach(i,function(e,t){var i=f.args.setIdentifierForNewItem(e,d,l+u.idx)||e;try{d.newItem(i),c.push(o+t),h[l+u.idx]=o+t,++u.idx}catch(a){}})}s.layer("rowmap").setMapping(h),d.save({onComplete:function(){s._refresh(),setTimeout(function(){r.publish("dojox/grid/rearrange/insert/"+s.id,["row",c])},0)}})}}catch(w){}},removeRows:function(e){var t=this.grid,i=t.store;try{a.forEach(a.map(e,function(e){return t._by_idx[e]}),function(e){e&&i.deleteItem(e.item)}),i.save({onComplete:function(){r.publish("dojox/grid/rearrange/remove/"+t.id,["row",e])}})}catch(o){}},_getPageInfo:function(){var e,t,i,r=this.grid.scroller,o=r.page,n=r.page,s=r.firstVisibleRow,d=r.lastVisibleRow,l=r.rowsPerPage,h=r.pageNodes[0],u=[];return a.forEach(h,function(a,r){a&&(i=!1,e=r*l,t=(r+1)*l-1,s>=e&&t>=s&&(o=r,i=!0),d>=e&&t>=d&&(n=r,i=!0),!i&&(e>d||s>t)&&u.push(r))}),{topPage:o,bottomPage:n,invalidPages:u}}});return o.registerPlugin(d),d});//# sourceMappingURL=Rearrange.js.map