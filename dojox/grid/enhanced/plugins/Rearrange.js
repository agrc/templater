//>>built
define("dojox/grid/enhanced/plugins/Rearrange",["dojo/_base/kernel","dojo/_base/lang","dojo/_base/declare","dojo/_base/array","dojo/_base/connect","../../EnhancedGrid","../_Plugin","./_RowMapLayer"],function(e,t,i,r,a,n,o,s){var l=i("dojox.grid.enhanced.plugins.Rearrange",o,{name:"rearrange",constructor:function(e,t){this.grid=e,this.setArgs(t);var i=new s(e);dojox.grid.enhanced.plugins.wrap(e,"_storeLayerFetch",i)},setArgs:function(e){this.args=t.mixin(this.args||{},e||{}),this.args.setIdentifierForNewItem=this.args.setIdentifierForNewItem||function(e){return e}},destroy:function(){this.inherited(arguments),this.grid.unwrap("rowmap")},onSetStore:function(e){this.grid.layer("rowmap").clearMapping()},_hasIdentity:function(e){var t=this.grid,i=t.store,a=t.layout.cells;return!(!i.getFeatures()["dojo.data.api.Identity"]||!r.some(e,function(e){return i.getIdentityAttributes(t._by_idx[e.r].item)==a[e.c].field}))},moveColumns:function(e,t){var i,r,n=this.grid,o=n.layout,s=o.cells,l=0,d=!0,u={},c={};for(e.sort(function(e,t){return e-t}),r=0;r<e.length;++r)u[e[r]]=r,e[r]<t&&++l;var h=0,f=0,m=Math.max(e[e.length-1],t);m==s.length&&--m;var p=Math.min(e[0],t);for(r=p;r<=m;++r){var g=u[r];g>=0?c[r]=t-l+g:r<t?(c[r]=p+h,++h):r>=t&&(c[r]=t+e.length-l+f,++f)}for(l=0,t==s.length&&(--t,d=!1),n._notRefreshSelection=!0,r=0;r<e.length;++r)i=e[r],i<t&&(i-=l),++l,i!=t&&(o.moveColumn(s[i].view.idx,s[t].view.idx,i,t,d),s=o.cells),t<=i&&++t;delete n._notRefreshSelection,a.publish("dojox/grid/rearrange/move/"+n.id,["col",c,e])},moveRows:function(e,i){var n,o,s,l,d,u,c=this.grid,h={},f=[],m=[],p=e.length;for(n=0;n<p&&!((o=e[n])>=i);++n)f.push(o);if(m=e.slice(n),l=f,p=l.length)for(d={},r.forEach(l,function(e){d[e]=!0}),h[l[0]]=i-p,s=0,n=l[s]+1,u=n-1;n<i;++n)d[n]?(++s,h[n]=i-p+s):(h[n]=u,++u);if(l=m,p=l.length)for(d={},r.forEach(l,function(e){d[e]=!0}),h[l[p-1]]=i+p-1,s=p-1,n=l[s]-1,u=n+1;n>=i;--n)d[n]?(--s,h[n]=i+s):(h[n]=u,--u);var g=t.clone(h);c.layer("rowmap").setMapping(h),c.forEachLayer(function(e){return"rowmap"!=e.name()&&(e.invalidate(),!0)},!1),c.selection.selected=[],c._noInternalMapping=!0,c._refresh(),setTimeout(function(){a.publish("dojox/grid/rearrange/move/"+c.id,["row",g,e]),c._noInternalMapping=!1},0)},moveCells:function(e,t){var i=this.grid,n=i.store;if(n.getFeatures()["dojo.data.api.Write"]){if(e.min.row==t.min.row&&e.min.col==t.min.col)return;var o,s,l,d,u=i.layout.cells,c=(e.max.row,e.min.row,[]),h=[];for(o=e.min.row,l=t.min.row;o<=e.max.row;++o,++l)for(s=e.min.col,d=t.min.col;s<=e.max.col;++s,++d){for(;u[s]&&u[s].hidden;)++s;for(;u[d]&&u[d].hidden;)++d;c.push({r:o,c:s}),h.push({r:l,c:d,v:u[s].get(o,i._by_idx[o].item)})}if(this._hasIdentity(c.concat(h)))return;r.forEach(c,function(e){n.setValue(i._by_idx[e.r].item,u[e.c].field,"")}),r.forEach(h,function(e){n.setValue(i._by_idx[e.r].item,u[e.c].field,e.v)}),n.save({onComplete:function(){a.publish("dojox/grid/rearrange/move/"+i.id,["cell",{from:e,to:t}])}})}},copyCells:function(e,t){var i=this.grid,n=i.store;if(n.getFeatures()["dojo.data.api.Write"]){if(e.min.row==t.min.row&&e.min.col==t.min.col)return;var o,s,l,d,u=i.layout.cells,c=(e.max.row,e.min.row,[]);for(o=e.min.row,l=t.min.row;o<=e.max.row;++o,++l)for(s=e.min.col,d=t.min.col;s<=e.max.col;++s,++d){for(;u[s]&&u[s].hidden;)++s;for(;u[d]&&u[d].hidden;)++d;c.push({r:l,c:d,v:u[s].get(o,i._by_idx[o].item)})}if(this._hasIdentity(c))return;r.forEach(c,function(e){n.setValue(i._by_idx[e.r].item,u[e.c].field,e.v)}),n.save({onComplete:function(){setTimeout(function(){a.publish("dojox/grid/rearrange/copy/"+i.id,["cell",{from:e,to:t}])},0)}})}},changeCells:function(e,t,i){var n=this.grid,o=n.store;if(o.getFeatures()["dojo.data.api.Write"]){var s,l,d,u,c=e,h=n.layout.cells,f=c.layout.cells,m=(t.max.row,t.min.row,[]);for(s=t.min.row,d=i.min.row;s<=t.max.row;++s,++d)for(l=t.min.col,u=i.min.col;l<=t.max.col;++l,++u){for(;f[l]&&f[l].hidden;)++l;for(;h[u]&&h[u].hidden;)++u;m.push({r:d,c:u,v:f[l].get(s,c._by_idx[s].item)})}if(this._hasIdentity(m))return;r.forEach(m,function(e){o.setValue(n._by_idx[e.r].item,h[e.c].field,e.v)}),o.save({onComplete:function(){a.publish("dojox/grid/rearrange/change/"+n.id,["cell",i])}})}},clearCells:function(e){var t=this.grid,i=t.store;if(i.getFeatures()["dojo.data.api.Write"]){var n,o,s=t.layout.cells,l=(e.max.row,e.min.row,[]);for(n=e.min.row;n<=e.max.row;++n)for(o=e.min.col;o<=e.max.col;++o){for(;s[o]&&s[o].hidden;)++o;l.push({r:n,c:o})}if(this._hasIdentity(l))return;r.forEach(l,function(e){i.setValue(t._by_idx[e.r].item,s[e.c].field,"")}),i.save({onComplete:function(){a.publish("dojox/grid/rearrange/change/"+t.id,["cell",e])}})}},insertRows:function(e,i,n){try{var o,s=this.grid,l=s.store,d=s.rowCount,u={},c={idx:0},h=[],f=n<0,m=this,p=i.length;if(f)n=0;else for(o=n;o<s.rowCount;++o)u[o]=o+p;if(l.getFeatures()["dojo.data.api.Write"]){if(e){var g,y,v=e,b=v.store;if(f)y=r.filter(r.map(s.layout.cells,function(e){return e.field}),function(e){return e});else{for(o=0;!g;++o)g=s._by_idx[o];y=l.getAttributes(g.item)}var w=[];r.forEach(i,function(e,t){var i={},a=v._by_idx[e];if(a){r.forEach(y,function(e){i[e]=b.getValue(a.item,e)}),i=m.args.setIdentifierForNewItem(i,l,d+c.idx)||i;try{l.newItem(i),h.push(n+t),u[d+c.idx]=n+t,++c.idx}catch(e){}}else w.push(e)})}else{if(!i.length||!t.isObject(i[0]))return;r.forEach(i,function(e,t){var i=m.args.setIdentifierForNewItem(e,l,d+c.idx)||e;try{l.newItem(i),h.push(n+t),u[d+c.idx]=n+t,++c.idx}catch(e){}})}s.layer("rowmap").setMapping(u),l.save({onComplete:function(){s._refresh(),setTimeout(function(){a.publish("dojox/grid/rearrange/insert/"+s.id,["row",h])},0)}})}}catch(e){}},removeRows:function(e){var t=this.grid,i=t.store;try{r.forEach(r.map(e,function(e){return t._by_idx[e]}),function(e){e&&i.deleteItem(e.item)}),i.save({onComplete:function(){a.publish("dojox/grid/rearrange/remove/"+t.id,["row",e])}})}catch(e){}},_getPageInfo:function(){var e,t,i,a=this.grid.scroller,n=a.page,o=a.page,s=a.firstVisibleRow,l=a.lastVisibleRow,d=a.rowsPerPage,u=a.pageNodes[0],c=[];return r.forEach(u,function(r,a){r&&(i=!1,e=a*d,t=(a+1)*d-1,s>=e&&s<=t&&(n=a,i=!0),l>=e&&l<=t&&(o=a,i=!0),!i&&(e>l||t<s)&&c.push(a))}),{topPage:n,bottomPage:o,invalidPages:c}}});return n.registerPlugin(l),l});//# sourceMappingURL=Rearrange.js.map