//>>built
define("dojox/grid/enhanced/plugins/filter/FilterLayer",["dojo/_base/declare","dojo/_base/lang","dojo/_base/kernel","dojo/_base/json","../_StoreLayer"],function(e,t,i,r,a){var n="filter",o="clear",s=function(e,r){return r?t.hitch(e||i.global,r):function(){}},l=function(e){var i={};if(e&&t.isObject(e))for(var r in e)i[r]=e[r];return i},d=e("dojox.grid.enhanced.plugins.filter._FilterLayerMixin",null,{tags:["sizeChange"],name:function(){return"filter"},onFilterDefined:function(e){},onFiltered:function(e,t){}}),u=e("dojox.grid.enhanced.plugins.filter.ServerSideFilterLayer",[a._ServerSideLayer,d],{constructor:function(e){this._onUserCommandLoad=e.setupFilterQuery||this._onUserCommandLoad,this.filterDef(null)},filterDef:function(e){if(e){this._filter=e;var t=e.toObject();this.command(n,this._isStateful?r.toJson(t):t),this.command(o,null),this.useCommands(!0),this.onFilterDefined(e)}else null===e&&(this._filter=null,this.command(n,null),this.command(o,!0),this.useCommands(!0),this.onFilterDefined(null));return this._filter},onCommandLoad:function(e,t){this.inherited(arguments);var i=t.onBegin;if(this._isStateful){var r;if(e){this.command(n,null),this.command(o,null),this.useCommands(!1);var a=e.split(",");if(!(a.length>=2))return;r=this._filteredSize=parseInt(a[0],10),this.onFiltered(r,parseInt(a[1],10))}else r=this._filteredSize;this.enabled()&&(t.onBegin=function(e,a){s(t.scope,i)(r,a)})}else{var l=this;t.onBegin=function(e,r){l._filter||(l._storeSize=e),l.onFiltered(e,l._storeSize||e),r.onBegin=i,s(t.scope,i)(e,r)}}}}),c=e("dojox.grid.enhanced.plugins.filter.ClientSideFilterLayer",[a._StoreLayer,d],{_storeSize:-1,_fetchAll:!0,constructor:function(e){this.filterDef(null),e=t.isObject(e)?e:{},this.fetchAllOnFirstFilter(e.fetchAll),this._getter=t.isFunction(e.getter)?e.getter:this._defaultGetter},_defaultGetter:function(e,t,i,r){return r.getValue(e,t)},filterDef:function(e){return void 0!==e&&(this._filter=e,this.invalidate(),this.onFilterDefined(e)),this._filter},setGetter:function(e){t.isFunction(e)&&(this._getter=e)},fetchAllOnFirstFilter:function(e){return void 0!==e&&(this._fetchAll=!!e),this._fetchAll},invalidate:function(){this._items=[],this._nextUnfetchedIdx=0,this._result=[],this._indexMap=[],this._resultStartIdx=0},_fetch:function(e,i){if(!this._filter){var a=e.onBegin,n=this;return e.onBegin=function(t,i){s(e.scope,a)(t,i),n.onFiltered(t,t)},this.originFetch(e),e}try{var o=i?i._nextResultItemIdx:e.start;if(o=o||0,!i){this._result=[],this._resultStartIdx=o;var d;t.isArray(e.sort)&&e.sort.length>0&&(d=r.toJson(e.sort))!=this._lastSortInfo&&(this.invalidate(),this._lastSortInfo=d)}var u="number"==typeof e.count?o+e.count-this._result.length:this._items.length;this._result.length?this._result=this._result.concat(this._items.slice(o,u)):this._result=this._items.slice(e.start,"number"==typeof e.count?e.start+e.count:this._items.length),this._result.length>=e.count||this._hasReachedStoreEnd()?this._completeQuery(e):(i||(i=l(e),i.onBegin=t.hitch(this,this._onFetchBegin),i.onComplete=t.hitch(this,function(t,i){this._nextUnfetchedIdx+=t.length,this._doFilter(t,i.start,e),this._fetch(e,i)})),i.start=this._nextUnfetchedIdx,this._fetchAll&&delete i.count,i._nextResultItemIdx=u<this._items.length?u:this._items.length,this.originFetch(i))}catch(t){if(!e.onError)throw t;s(e.scope,e.onError)(t,e)}return e},_hasReachedStoreEnd:function(){return this._storeSize>=0&&this._nextUnfetchedIdx>=this._storeSize},_applyFilter:function(e,t){var i=this._getter,r=this._store;try{return!!this._filter.applyRow(e,function(e,a){return i(e,a,t,r)}).getValue()}catch(e){return!1}},_doFilter:function(e,t,i){for(var r=0,a=0;r<e.length;++r)this._applyFilter(e[r],t+r)&&(s(i.scope,i.onItem)(e[r],i),a+=this._addCachedItems(e[r],this._items.length),this._indexMap.push(t+r))},_onFetchBegin:function(e,t){this._storeSize=e},_completeQuery:function(e){var t=this._items.length;this._nextUnfetchedIdx<this._storeSize&&t++,s(e.scope,e.onBegin)(t,e),this.onFiltered(this._items.length,this._storeSize),s(e.scope,e.onComplete)(this._result,e)},_addCachedItems:function(e,i){t.isArray(e)||(e=[e]);for(var r=0;r<e.length;++r)this._items[i+r]=e[r];return e.length},onRowMappingChange:function(e){if(this._filter){var i=t.clone(e),r={};for(var a in i)a=parseInt(a,10),e[this._indexMap[a]]=this._indexMap[i[a]],r[this._indexMap[a]]||(r[this._indexMap[a]]=!0),r[a]||(r[a]=!0,delete e[a])}}});return t.mixin({ServerSideFilterLayer:u,ClientSideFilterLayer:c},a)});//# sourceMappingURL=FilterLayer.js.map