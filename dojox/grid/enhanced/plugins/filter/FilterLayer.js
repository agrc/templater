//>>built
define("dojox/grid/enhanced/plugins/filter/FilterLayer",["dojo/_base/declare","dojo/_base/lang","dojo/_base/kernel","dojo/_base/json","../_StoreLayer"],function(e,t,i,a,o){var r="filter",n="clear",s=function(e,a){return a?t.hitch(e||i.global,a):function(){}},l=function(e){var i={};if(e&&t.isObject(e))for(var a in e)i[a]=e[a];return i},d=e("dojox.grid.enhanced.plugins.filter._FilterLayerMixin",null,{tags:["sizeChange"],name:function(){return"filter"},onFilterDefined:function(e){},onFiltered:function(e,t){}}),u=e("dojox.grid.enhanced.plugins.filter.ServerSideFilterLayer",[o._ServerSideLayer,d],{constructor:function(e){this._onUserCommandLoad=e.setupFilterQuery||this._onUserCommandLoad,this.filterDef(null)},filterDef:function(e){if(e){this._filter=e;var t=e.toObject();this.command(r,this._isStateful?a.toJson(t):t),this.command(n,null),this.useCommands(!0),this.onFilterDefined(e)}else null===e&&(this._filter=null,this.command(r,null),this.command(n,!0),this.useCommands(!0),this.onFilterDefined(null));return this._filter},onCommandLoad:function(e,t){this.inherited(arguments);var i=t.onBegin;if(this._isStateful){var a;if(e){this.command(r,null),this.command(n,null),this.useCommands(!1);var o=e.split(",");if(!(o.length>=2))return;a=this._filteredSize=parseInt(o[0],10),this.onFiltered(a,parseInt(o[1],10))}else a=this._filteredSize;this.enabled()&&(t.onBegin=function(e,o){s(t.scope,i)(a,o)})}else{var l=this;t.onBegin=function(e,a){l._filter||(l._storeSize=e),l.onFiltered(e,l._storeSize||e),a.onBegin=i,s(t.scope,i)(e,a)}}}}),h=e("dojox.grid.enhanced.plugins.filter.ClientSideFilterLayer",[o._StoreLayer,d],{_storeSize:-1,_fetchAll:!0,constructor:function(e){this.filterDef(null),e=t.isObject(e)?e:{},this.fetchAllOnFirstFilter(e.fetchAll),this._getter=t.isFunction(e.getter)?e.getter:this._defaultGetter},_defaultGetter:function(e,t,i,a){return a.getValue(e,t)},filterDef:function(e){return void 0!==e&&(this._filter=e,this.invalidate(),this.onFilterDefined(e)),this._filter},setGetter:function(e){t.isFunction(e)&&(this._getter=e)},fetchAllOnFirstFilter:function(e){return void 0!==e&&(this._fetchAll=!!e),this._fetchAll},invalidate:function(){this._items=[],this._nextUnfetchedIdx=0,this._result=[],this._indexMap=[],this._resultStartIdx=0},_fetch:function(e,i){if(!this._filter){var o=e.onBegin,r=this;return e.onBegin=function(t,i){s(e.scope,o)(t,i),r.onFiltered(t,t)},this.originFetch(e),e}try{var n=i?i._nextResultItemIdx:e.start;if(n=n||0,!i){this._result=[],this._resultStartIdx=n;var d;t.isArray(e.sort)&&e.sort.length>0&&(d=a.toJson(e.sort))!=this._lastSortInfo&&(this.invalidate(),this._lastSortInfo=d)}var u="number"==typeof e.count?n+e.count-this._result.length:this._items.length;this._result.length?this._result=this._result.concat(this._items.slice(n,u)):this._result=this._items.slice(e.start,"number"==typeof e.count?e.start+e.count:this._items.length),this._result.length>=e.count||this._hasReachedStoreEnd()?this._completeQuery(e):(i||(i=l(e),i.onBegin=t.hitch(this,this._onFetchBegin),i.onComplete=t.hitch(this,function(t,i){this._nextUnfetchedIdx+=t.length,this._doFilter(t,i.start,e),this._fetch(e,i)})),i.start=this._nextUnfetchedIdx,this._fetchAll&&delete i.count,i._nextResultItemIdx=u<this._items.length?u:this._items.length,this.originFetch(i))}catch(h){if(!e.onError)throw h;s(e.scope,e.onError)(h,e)}return e},_hasReachedStoreEnd:function(){return this._storeSize>=0&&this._nextUnfetchedIdx>=this._storeSize},_applyFilter:function(e,t){var i=this._getter,a=this._store;try{return!!this._filter.applyRow(e,function(e,o){return i(e,o,t,a)}).getValue()}catch(o){return!1}},_doFilter:function(e,t,i){for(var a=0,o=0;a<e.length;++a)this._applyFilter(e[a],t+a)&&(s(i.scope,i.onItem)(e[a],i),o+=this._addCachedItems(e[a],this._items.length),this._indexMap.push(t+a))},_onFetchBegin:function(e,t){this._storeSize=e},_completeQuery:function(e){var t=this._items.length;this._nextUnfetchedIdx<this._storeSize&&t++,s(e.scope,e.onBegin)(t,e),this.onFiltered(this._items.length,this._storeSize),s(e.scope,e.onComplete)(this._result,e)},_addCachedItems:function(e,i){t.isArray(e)||(e=[e]);for(var a=0;a<e.length;++a)this._items[i+a]=e[a];return e.length},onRowMappingChange:function(e){if(this._filter){var i=t.clone(e),a={};for(var o in i)o=parseInt(o,10),e[this._indexMap[o]]=this._indexMap[i[o]],a[this._indexMap[o]]||(a[this._indexMap[o]]=!0),a[o]||(a[o]=!0,delete e[o])}}});return t.mixin({ServerSideFilterLayer:u,ClientSideFilterLayer:h},o)});//# sourceMappingURL=FilterLayer.js.map