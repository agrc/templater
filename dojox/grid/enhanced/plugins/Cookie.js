//>>built
define("dojox/grid/enhanced/plugins/Cookie",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/sniff","dojo/_base/html","dojo/_base/json","dojo/_base/window","dojo/_base/unload","dojo/cookie","../_Plugin","../../_RowSelector","../../EnhancedGrid","../../cells/_base"],function(e,t,i,a,r,n,o,s,l,d,u,m){var c=i.getObject("dojox.grid.cells"),h=function(e){return window.location+"/"+e.id},f=function(e){var a=[];return i.isArray(e)||(e=[e]),t.forEach(e,function(e){i.isArray(e)&&(e={cells:e});var r=e.rows||e.cells;i.isArray(r)&&(i.isArray(r[0])||(r=[r]),t.forEach(r,function(e){i.isArray(e)&&t.forEach(e,function(e){a.push(e)})}))}),a},g=function(e,t){if(i.isArray(e)){var a=t._setStructureAttr;t._setStructureAttr=function(i){if(!t._colWidthLoaded){t._colWidthLoaded=!0;for(var r=f(i),n=r.length-1;n>=0;--n)"number"==typeof e[n]?r[n].width=e[n]+"px":"hidden"==e[n]&&(r[n].hidden=!0)}a.call(t,i),t._setStructureAttr=a}}},p=function(e){return t.map(t.filter(e.layout.cells,function(e){return!(e.isRowSelector||e instanceof c.RowIndex)}),function(e){return e.hidden?"hidden":r[a("webkit")?"marginBox":"contentBox"](e.getHeaderNode()).w})},y=function(e,a){if(e&&t.every(e,function(e){return i.isArray(e)&&t.every(e,function(e){return i.isArray(e)&&e.length>0})})){var r=a._setStructureAttr,o=function(e){return"name"in e||"field"in e||"get"in e},s=function(e){return null!==e&&i.isObject(e)&&("cells"in e||"rows"in e||"type"in e&&!o(e))};a._setStructureAttr=function(o){if(!a._colOrderLoaded){a._colOrderLoaded=!0,a._setStructureAttr=r,o=i.clone(o),i.isArray(o)&&!t.some(o,s)?o=[{cells:o}]:s(o)&&(o=[o]);var l=f(o);t.forEach(i.isArray(o)?o:[o],function(a,r){var o=a;i.isArray(a)?a.splice(0,a.length):(delete a.rows,o=a.cells=[]),t.forEach(e[r],function(e){t.forEach(e,function(e){var t,i;for(t=0;t<l.length&&(i=l[t],n.toJson({name:i.name,field:i.field})!=n.toJson(e));++t);t<l.length&&o.push(i)})})})}r.call(a,o)}}},v=function(e){return t.map(t.filter(e.views.views,function(e){return!(e instanceof u)}),function(e){return t.map(e.structure.cells,function(e){return t.map(t.filter(e,function(e){return!(e.isRowSelector||e instanceof c.RowIndex)}),function(e){return{name:e.name,field:e.field}})})})},k=function(e,t){try{e&&i.isObject(e)&&t.setSortIndex(e.idx,e.asc)}catch(e){}},b=function(e){return{idx:e.getSortIndex(),asc:e.getSortAsc()}};a("ie")||s.addOnWindowUnload(function(){t.forEach(dijit.findWidgets(o.body()),function(e){e instanceof m&&!e._destroyed&&e.destroyRecursive()})});var M=e("dojox.grid.enhanced.plugins.Cookie",d,{name:"cookie",_cookieEnabled:!0,constructor:function(e,a){this.grid=e,a=a&&i.isObject(a)?a:{},this.cookieProps=a.cookieProps,this._cookieHandlers=[],this._mixinGrid(),this.addCookieHandler({name:"columnWidth",onLoad:g,onSave:p}),this.addCookieHandler({name:"columnOrder",onLoad:y,onSave:v}),this.addCookieHandler({name:"sortOrder",onLoad:k,onSave:b}),t.forEach(this._cookieHandlers,function(e){!1===a[e.name]&&(e.enable=!1)},this)},destroy:function(){this._saveCookie(),this._cookieHandlers=null,this.inherited(arguments)},_mixinGrid:function(){var e=this.grid;e.addCookieHandler=i.hitch(this,"addCookieHandler"),e.removeCookie=i.hitch(this,"removeCookie"),e.setCookieEnabled=i.hitch(this,"setCookieEnabled"),e.getCookieEnabled=i.hitch(this,"getCookieEnabled")},_saveCookie:function(){if(this.getCookieEnabled()){for(var e={},t=this._cookieHandlers,a=this.cookieProps,r=h(this.grid),o=t.length-1;o>=0;--o)t[o].enabled&&(e[t[o].name]=t[o].onSave(this.grid));a=i.isObject(this.cookieProps)?this.cookieProps:{},l(r,n.toJson(e),a)}else this.removeCookie()},onPreInit:function(){var e=this.grid,t=this._cookieHandlers,i=h(e),a=l(i);if(a){a=n.fromJson(a);for(var r=0;r<t.length;++r)t[r].name in a&&t[r].enabled&&t[r].onLoad(a[t[r].name],e)}this._cookie=a||{},this._cookieStartedup=!0},addCookieHandler:function(e){if(e.name){var t=function(){};e.onLoad=e.onLoad||t,e.onSave=e.onSave||t,"enabled"in e||(e.enabled=!0);for(var i=this._cookieHandlers.length-1;i>=0;--i)this._cookieHandlers[i].name==e.name&&this._cookieHandlers.splice(i,1);this._cookieHandlers.push(e),this._cookieStartedup&&e.name in this._cookie&&e.onLoad(this._cookie[e.name],this.grid)}},removeCookie:function(){var e=h(this.grid);l(e,null,{expires:-1})},setCookieEnabled:function(e,t){if("string"==typeof e)for(var i=this._cookieHandlers,a=i.length-1;a>=0;--a)i[a].name===e&&(i[a].enabled=!!t);else this._cookieEnabled=!!e,this._cookieEnabled||this.removeCookie()},getCookieEnabled:function(e){if(i.isString(e)){for(var t=this._cookieHandlers,a=t.length-1;a>=0;--a)if(t[a].name==e)return t[a].enabled;return!1}return this._cookieEnabled}});return m.registerPlugin(M,{preInit:!0}),M});//# sourceMappingURL=Cookie.js.map