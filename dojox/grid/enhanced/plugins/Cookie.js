//>>built
define("dojox/grid/enhanced/plugins/Cookie",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/sniff","dojo/_base/html","dojo/_base/json","dojo/_base/window","dojo/_base/unload","dojo/cookie","../_Plugin","../../_RowSelector","../../EnhancedGrid","../../cells/_base"],function(e,t,i,a,o,r,n,s,l,d,u,h){var c=i.getObject("dojox.grid.cells"),m=function(e){return window.location+"/"+e.id},f=function(e){var a=[];return i.isArray(e)||(e=[e]),t.forEach(e,function(e){i.isArray(e)&&(e={cells:e});var o=e.rows||e.cells;i.isArray(o)&&(i.isArray(o[0])||(o=[o]),t.forEach(o,function(e){i.isArray(e)&&t.forEach(e,function(e){a.push(e)})}))}),a},p=function(e,t){if(i.isArray(e)){var a=t._setStructureAttr;t._setStructureAttr=function(i){if(!t._colWidthLoaded){t._colWidthLoaded=!0;for(var o=f(i),r=o.length-1;r>=0;--r)"number"==typeof e[r]?o[r].width=e[r]+"px":"hidden"==e[r]&&(o[r].hidden=!0)}a.call(t,i),t._setStructureAttr=a}}},g=function(e){return t.map(t.filter(e.layout.cells,function(e){return!(e.isRowSelector||e instanceof c.RowIndex)}),function(e){return e.hidden?"hidden":o[a("webkit")?"marginBox":"contentBox"](e.getHeaderNode()).w})},y=function(e,a){if(e&&t.every(e,function(e){return i.isArray(e)&&t.every(e,function(e){return i.isArray(e)&&e.length>0})})){var o=a._setStructureAttr,n=function(e){return"name"in e||"field"in e||"get"in e},s=function(e){return null!==e&&i.isObject(e)&&("cells"in e||"rows"in e||"type"in e&&!n(e))};a._setStructureAttr=function(n){if(!a._colOrderLoaded){a._colOrderLoaded=!0,a._setStructureAttr=o,n=i.clone(n),i.isArray(n)&&!t.some(n,s)?n=[{cells:n}]:s(n)&&(n=[n]);var l=f(n);t.forEach(i.isArray(n)?n:[n],function(a,o){var n=a;i.isArray(a)?a.splice(0,a.length):(delete a.rows,n=a.cells=[]),t.forEach(e[o],function(e){t.forEach(e,function(e){var t,i;for(t=0;t<l.length&&(i=l[t],r.toJson({name:i.name,field:i.field})!=r.toJson(e));++t);t<l.length&&n.push(i)})})})}o.call(a,n)}}},v=function(e){var i=t.map(t.filter(e.views.views,function(e){return!(e instanceof u)}),function(e){return t.map(e.structure.cells,function(e){return t.map(t.filter(e,function(e){return!(e.isRowSelector||e instanceof c.RowIndex)}),function(e){return{name:e.name,field:e.field}})})});return i},b=function(e,t){try{e&&i.isObject(e)&&t.setSortIndex(e.idx,e.asc)}catch(a){}},k=function(e){return{idx:e.getSortIndex(),asc:e.getSortAsc()}};a("ie")||s.addOnWindowUnload(function(){t.forEach(dijit.findWidgets(n.body()),function(e){e instanceof h&&!e._destroyed&&e.destroyRecursive()})});var M=e("dojox.grid.enhanced.plugins.Cookie",d,{name:"cookie",_cookieEnabled:!0,constructor:function(e,a){this.grid=e,a=a&&i.isObject(a)?a:{},this.cookieProps=a.cookieProps,this._cookieHandlers=[],this._mixinGrid(),this.addCookieHandler({name:"columnWidth",onLoad:p,onSave:g}),this.addCookieHandler({name:"columnOrder",onLoad:y,onSave:v}),this.addCookieHandler({name:"sortOrder",onLoad:b,onSave:k}),t.forEach(this._cookieHandlers,function(e){a[e.name]===!1&&(e.enable=!1)},this)},destroy:function(){this._saveCookie(),this._cookieHandlers=null,this.inherited(arguments)},_mixinGrid:function(){var e=this.grid;e.addCookieHandler=i.hitch(this,"addCookieHandler"),e.removeCookie=i.hitch(this,"removeCookie"),e.setCookieEnabled=i.hitch(this,"setCookieEnabled"),e.getCookieEnabled=i.hitch(this,"getCookieEnabled")},_saveCookie:function(){if(this.getCookieEnabled()){for(var e={},t=this._cookieHandlers,a=this.cookieProps,o=m(this.grid),n=t.length-1;n>=0;--n)t[n].enabled&&(e[t[n].name]=t[n].onSave(this.grid));a=i.isObject(this.cookieProps)?this.cookieProps:{},l(o,r.toJson(e),a)}else this.removeCookie()},onPreInit:function(){var e=this.grid,t=this._cookieHandlers,i=m(e),a=l(i);if(a){a=r.fromJson(a);for(var o=0;o<t.length;++o)t[o].name in a&&t[o].enabled&&t[o].onLoad(a[t[o].name],e)}this._cookie=a||{},this._cookieStartedup=!0},addCookieHandler:function(e){if(e.name){var t=function(){};e.onLoad=e.onLoad||t,e.onSave=e.onSave||t,"enabled"in e||(e.enabled=!0);for(var i=this._cookieHandlers.length-1;i>=0;--i)this._cookieHandlers[i].name==e.name&&this._cookieHandlers.splice(i,1);this._cookieHandlers.push(e),this._cookieStartedup&&e.name in this._cookie&&e.onLoad(this._cookie[e.name],this.grid)}},removeCookie:function(){var e=m(this.grid);l(e,null,{expires:-1})},setCookieEnabled:function(e,t){if("string"==typeof e)for(var i=this._cookieHandlers,a=i.length-1;a>=0;--a)i[a].name===e&&(i[a].enabled=!!t);else this._cookieEnabled=!!e,this._cookieEnabled||this.removeCookie()},getCookieEnabled:function(e){if(i.isString(e)){for(var t=this._cookieHandlers,a=t.length-1;a>=0;--a)if(t[a].name==e)return t[a].enabled;return!1}return this._cookieEnabled}});return h.registerPlugin(M,{preInit:!0}),M});//# sourceMappingURL=Cookie.js.map