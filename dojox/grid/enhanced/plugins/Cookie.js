//>>built
define("dojox/grid/enhanced/plugins/Cookie",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/sniff","dojo/_base/html","dojo/_base/json","dojo/_base/window","dojo/_base/unload","dojo/cookie","../_Plugin","../../_RowSelector","../../EnhancedGrid","../../cells/_base"],function(e,t,a,i,r,n,o,s,l,d,u,m){var h=a.getObject("dojox.grid.cells"),c=function(e){return window.location+"/"+e.id},f=function(e){var i=[];return a.isArray(e)||(e=[e]),t.forEach(e,function(e){a.isArray(e)&&(e={cells:e});var r=e.rows||e.cells;a.isArray(r)&&(a.isArray(r[0])||(r=[r]),t.forEach(r,function(e){a.isArray(e)&&t.forEach(e,function(e){i.push(e)})}))}),i},g=function(e,t){if(a.isArray(e)){var i=t._setStructureAttr;t._setStructureAttr=function(a){if(!t._colWidthLoaded){t._colWidthLoaded=!0;for(var r=f(a),n=r.length-1;n>=0;--n)"number"==typeof e[n]?r[n].width=e[n]+"px":"hidden"==e[n]&&(r[n].hidden=!0)}i.call(t,a),t._setStructureAttr=i}}},p=function(e){return t.map(t.filter(e.layout.cells,function(e){return!(e.isRowSelector||e instanceof h.RowIndex)}),function(e){return e.hidden?"hidden":r[i("webkit")?"marginBox":"contentBox"](e.getHeaderNode()).w})},y=function(e,i){if(e&&t.every(e,function(e){return a.isArray(e)&&t.every(e,function(e){return a.isArray(e)&&e.length>0})})){var r=i._setStructureAttr,o=function(e){return"name"in e||"field"in e||"get"in e},s=function(e){return null!==e&&a.isObject(e)&&("cells"in e||"rows"in e||"type"in e&&!o(e))};i._setStructureAttr=function(o){if(!i._colOrderLoaded){i._colOrderLoaded=!0,i._setStructureAttr=r,o=a.clone(o),a.isArray(o)&&!t.some(o,s)?o=[{cells:o}]:s(o)&&(o=[o]);var l=f(o);t.forEach(a.isArray(o)?o:[o],function(i,r){var o=i;a.isArray(i)?i.splice(0,i.length):(delete i.rows,o=i.cells=[]),t.forEach(e[r],function(e){t.forEach(e,function(e){var t,a;for(t=0;t<l.length&&(a=l[t],n.toJson({name:a.name,field:a.field})!=n.toJson(e));++t);t<l.length&&o.push(a)})})})}r.call(i,o)}}},v=function(e){return t.map(t.filter(e.views.views,function(e){return!(e instanceof u)}),function(e){return t.map(e.structure.cells,function(e){return t.map(t.filter(e,function(e){return!(e.isRowSelector||e instanceof h.RowIndex)}),function(e){return{name:e.name,field:e.field}})})})},k=function(e,t){try{e&&a.isObject(e)&&t.setSortIndex(e.idx,e.asc)}catch(e){}},b=function(e){return{idx:e.getSortIndex(),asc:e.getSortAsc()}};i("ie")||s.addOnWindowUnload(function(){t.forEach(dijit.findWidgets(o.body()),function(e){e instanceof m&&!e._destroyed&&e.destroyRecursive()})});var M=e("dojox.grid.enhanced.plugins.Cookie",d,{name:"cookie",_cookieEnabled:!0,constructor:function(e,i){this.grid=e,i=i&&a.isObject(i)?i:{},this.cookieProps=i.cookieProps,this._cookieHandlers=[],this._mixinGrid(),this.addCookieHandler({name:"columnWidth",onLoad:g,onSave:p}),this.addCookieHandler({name:"columnOrder",onLoad:y,onSave:v}),this.addCookieHandler({name:"sortOrder",onLoad:k,onSave:b}),t.forEach(this._cookieHandlers,function(e){!1===i[e.name]&&(e.enable=!1)},this)},destroy:function(){this._saveCookie(),this._cookieHandlers=null,this.inherited(arguments)},_mixinGrid:function(){var e=this.grid;e.addCookieHandler=a.hitch(this,"addCookieHandler"),e.removeCookie=a.hitch(this,"removeCookie"),e.setCookieEnabled=a.hitch(this,"setCookieEnabled"),e.getCookieEnabled=a.hitch(this,"getCookieEnabled")},_saveCookie:function(){if(this.getCookieEnabled()){for(var e={},t=this._cookieHandlers,i=this.cookieProps,r=c(this.grid),o=t.length-1;o>=0;--o)t[o].enabled&&(e[t[o].name]=t[o].onSave(this.grid));i=a.isObject(this.cookieProps)?this.cookieProps:{},l(r,n.toJson(e),i)}else this.removeCookie()},onPreInit:function(){var e=this.grid,t=this._cookieHandlers,a=c(e),i=l(a);if(i){i=n.fromJson(i);for(var r=0;r<t.length;++r)t[r].name in i&&t[r].enabled&&t[r].onLoad(i[t[r].name],e)}this._cookie=i||{},this._cookieStartedup=!0},addCookieHandler:function(e){if(e.name){var t=function(){};e.onLoad=e.onLoad||t,e.onSave=e.onSave||t,"enabled"in e||(e.enabled=!0);for(var a=this._cookieHandlers.length-1;a>=0;--a)this._cookieHandlers[a].name==e.name&&this._cookieHandlers.splice(a,1);this._cookieHandlers.push(e),this._cookieStartedup&&e.name in this._cookie&&e.onLoad(this._cookie[e.name],this.grid)}},removeCookie:function(){var e=c(this.grid);l(e,null,{expires:-1})},setCookieEnabled:function(e,t){if("string"==typeof e)for(var a=this._cookieHandlers,i=a.length-1;i>=0;--i)a[i].name===e&&(a[i].enabled=!!t);else this._cookieEnabled=!!e,this._cookieEnabled||this.removeCookie()},getCookieEnabled:function(e){if(a.isString(e)){for(var t=this._cookieHandlers,i=t.length-1;i>=0;--i)if(t[i].name==e)return t[i].enabled;return!1}return this._cookieEnabled}});return m.registerPlugin(M,{preInit:!0}),M});//# sourceMappingURL=Cookie.js.map