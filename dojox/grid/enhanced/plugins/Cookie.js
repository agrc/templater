//>>built
define("dojox/grid/enhanced/plugins/Cookie",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/sniff","dojo/_base/html","dojo/_base/json","dojo/_base/window","dojo/_base/unload","dojo/cookie","../_Plugin","../../_RowSelector","../../EnhancedGrid","../../cells/_base"],function(e,t,i,a,n,o,r,s,l,d,c,u){var m=i.getObject("dojox.grid.cells"),h=function(e){return window.location+"/"+e.id},f=function(e){var a=[];return i.isArray(e)||(e=[e]),t.forEach(e,function(e){i.isArray(e)&&(e={cells:e});var n=e.rows||e.cells;i.isArray(n)&&(i.isArray(n[0])||(n=[n]),t.forEach(n,function(e){i.isArray(e)&&t.forEach(e,function(e){a.push(e)})}))}),a},p=function(e,t){if(i.isArray(e)){var a=t._setStructureAttr;t._setStructureAttr=function(i){if(!t._colWidthLoaded){t._colWidthLoaded=!0;for(var n=f(i),o=n.length-1;o>=0;--o)"number"==typeof e[o]?n[o].width=e[o]+"px":"hidden"==e[o]&&(n[o].hidden=!0)}a.call(t,i),t._setStructureAttr=a}}},g=function(e){return t.map(t.filter(e.layout.cells,function(e){return!(e.isRowSelector||e instanceof m.RowIndex)}),function(e){return e.hidden?"hidden":n[a("webkit")?"marginBox":"contentBox"](e.getHeaderNode()).w})},v=function(e,a){if(e&&t.every(e,function(e){return i.isArray(e)&&t.every(e,function(e){return i.isArray(e)&&e.length>0})})){var n=a._setStructureAttr,r=function(e){return"name"in e||"field"in e||"get"in e},s=function(e){return null!==e&&i.isObject(e)&&("cells"in e||"rows"in e||"type"in e&&!r(e))};a._setStructureAttr=function(r){if(!a._colOrderLoaded){a._colOrderLoaded=!0,a._setStructureAttr=n,r=i.clone(r),i.isArray(r)&&!t.some(r,s)?r=[{cells:r}]:s(r)&&(r=[r]);var l=f(r);t.forEach(i.isArray(r)?r:[r],function(a,n){var r=a;i.isArray(a)?a.splice(0,a.length):(delete a.rows,r=a.cells=[]),t.forEach(e[n],function(e){t.forEach(e,function(e){var t,i;for(t=0;t<l.length&&(i=l[t],o.toJson({name:i.name,field:i.field})!=o.toJson(e));++t);t<l.length&&r.push(i)})})})}n.call(a,r)}}},y=function(e){var i=t.map(t.filter(e.views.views,function(e){return!(e instanceof c)}),function(e){return t.map(e.structure.cells,function(e){return t.map(t.filter(e,function(e){return!(e.isRowSelector||e instanceof m.RowIndex)}),function(e){return{name:e.name,field:e.field}})})});return i},k=function(e,t){try{e&&i.isObject(e)&&t.setSortIndex(e.idx,e.asc)}catch(a){}},b=function(e){return{idx:e.getSortIndex(),asc:e.getSortAsc()}};a("ie")||s.addOnWindowUnload(function(){t.forEach(dijit.findWidgets(r.body()),function(e){e instanceof u&&!e._destroyed&&e.destroyRecursive()})});var _=e("dojox.grid.enhanced.plugins.Cookie",d,{name:"cookie",_cookieEnabled:!0,constructor:function(e,a){this.grid=e,a=a&&i.isObject(a)?a:{},this.cookieProps=a.cookieProps,this._cookieHandlers=[],this._mixinGrid(),this.addCookieHandler({name:"columnWidth",onLoad:p,onSave:g}),this.addCookieHandler({name:"columnOrder",onLoad:v,onSave:y}),this.addCookieHandler({name:"sortOrder",onLoad:k,onSave:b}),t.forEach(this._cookieHandlers,function(e){a[e.name]===!1&&(e.enable=!1)},this)},destroy:function(){this._saveCookie(),this._cookieHandlers=null,this.inherited(arguments)},_mixinGrid:function(){var e=this.grid;e.addCookieHandler=i.hitch(this,"addCookieHandler"),e.removeCookie=i.hitch(this,"removeCookie"),e.setCookieEnabled=i.hitch(this,"setCookieEnabled"),e.getCookieEnabled=i.hitch(this,"getCookieEnabled")},_saveCookie:function(){if(this.getCookieEnabled()){for(var e={},t=this._cookieHandlers,a=this.cookieProps,n=h(this.grid),r=t.length-1;r>=0;--r)t[r].enabled&&(e[t[r].name]=t[r].onSave(this.grid));a=i.isObject(this.cookieProps)?this.cookieProps:{},l(n,o.toJson(e),a)}else this.removeCookie()},onPreInit:function(){var e=this.grid,t=this._cookieHandlers,i=h(e),a=l(i);if(a){a=o.fromJson(a);for(var n=0;n<t.length;++n)t[n].name in a&&t[n].enabled&&t[n].onLoad(a[t[n].name],e)}this._cookie=a||{},this._cookieStartedup=!0},addCookieHandler:function(e){if(e.name){var t=function(){};e.onLoad=e.onLoad||t,e.onSave=e.onSave||t,"enabled"in e||(e.enabled=!0);for(var i=this._cookieHandlers.length-1;i>=0;--i)this._cookieHandlers[i].name==e.name&&this._cookieHandlers.splice(i,1);this._cookieHandlers.push(e),this._cookieStartedup&&e.name in this._cookie&&e.onLoad(this._cookie[e.name],this.grid)}},removeCookie:function(){var e=h(this.grid);l(e,null,{expires:-1})},setCookieEnabled:function(e,t){if("string"==typeof e)for(var i=this._cookieHandlers,a=i.length-1;a>=0;--a)i[a].name===e&&(i[a].enabled=!!t);else this._cookieEnabled=!!e,this._cookieEnabled||this.removeCookie()},getCookieEnabled:function(e){if(i.isString(e)){for(var t=this._cookieHandlers,a=t.length-1;a>=0;--a)if(t[a].name==e)return t[a].enabled;return!1}return this._cookieEnabled}});return u.registerPlugin(_,{preInit:!0}),_});//# sourceMappingURL=Cookie.js.map