//>>built
define("dojox/grid/enhanced/plugins/_RowMapLayer",["dojo/_base/array","dojo/_base/declare","dojo/_base/kernel","dojo/_base/lang","./_StoreLayer"],function(e,t,i,o,r){var a=function(e){e.sort(function(e,t){return e-t});for(var t=[[e[0]]],i=1,o=0;i<e.length;++i)e[i]==e[i-1]+1?t[o].push(e[i]):t[++o]=[e[i]];return t},n=function(e,t){return t?o.hitch(e||i.global,t):function(){}};return t("dojox.grid.enhanced.plugins._RowMapLayer",r._StoreLayer,{tags:["reorder"],constructor:function(e){this._map={},this._revMap={},this.grid=e,this._oldOnDelete=e._onDelete;var t=this;e._onDelete=function(i){t._onDelete(i),t._oldOnDelete.call(e,i)},this._oldSort=e.sort,e.sort=function(){t.clearMapping(),t._oldSort.apply(e,arguments)}},uninitialize:function(){this.grid._onDelete=this._oldOnDelete,this.grid.sort=this._oldSort},setMapping:function(e){this._store.forEachLayer(function(t){return"rowmap"===t.name()?!1:(t.onRowMappingChange&&t.onRowMappingChange(e),!0)},!1);var t,i,o,r={};for(t in e)t=parseInt(t,10),i=e[t],"number"==typeof i&&(t in this._revMap?(o=this._revMap[t],delete this._revMap[t]):o=t,o==i?(delete this._map[o],r[i]="eq"):(this._map[o]=i,r[i]=o));for(i in r)"eq"===r[i]?delete this._revMap[parseInt(i,10)]:this._revMap[parseInt(i,10)]=r[i]},clearMapping:function(){this._map={},this._revMap={}},_onDelete:function(e){var t=this.grid._getItemIndex(e,!0);if(t in this._revMap){var i,o,r=[],a=this._revMap[t];delete this._map[a],delete this._revMap[t];for(i in this._revMap)i=parseInt(i,10),this._revMap[i]>a&&--this._revMap[i];for(i in this._revMap)i=parseInt(i,10),i>t&&r.push(i);for(r.sort(function(e,t){return t-e}),o=r.length-1;o>=0;--o)i=r[o],this._revMap[i-1]=this._revMap[i],delete this._revMap[i];this._map={};for(i in this._revMap)this._map[this._revMap[i]]=i}},_fetch:function(e){var t,i=0,r=e.start||0;for(t in this._revMap)t=parseInt(t,10),t>=r&&++i;if(i>0){var a,n=[],s={},d=e.count>0?e.count:-1;if(d>0)for(a=0;d>a;++a)t=r+a,t=t in this._revMap?this._revMap[t]:t,s[t]=a,n.push(t);else for(a=0;t=r+a,t in this._revMap&&(--i,t=this._revMap[t]),s[t]=a,n.push(t),!(0>=i);++a);return this._subFetch(e,this._getRowArrays(n),0,[],s,e.onComplete,r,d),e}return o.hitch(this._store,this._originFetch)(e)},_getRowArrays:function(e){return a(e)},_subFetch:function(t,i,o,r,a,s,d,l){var u=i[o],c=this,h=t.start=u[0];t.count=u[u.length-1]-u[0]+1,t.onComplete=function(u){e.forEach(u,function(e,t){var i=h+t;i in a&&(r[a[i]]=e)}),++o==i.length?l>0?(t.start=d,t.count=l,t.onComplete=s,n(t.scope,s)(r,t)):(t.start=t.start+u.length,delete t.count,t.onComplete=function(e){r=r.concat(e),t.start=d,t.onComplete=s,n(t.scope,s)(r,t)},c.originFetch(t)):c._subFetch(t,i,o,r,a,s,d,l)},c.originFetch(t)}})});//# sourceMappingURL=_RowMapLayer.js.map