//>>built
define("dojox/grid/enhanced/plugins/NestedSorting",["dojo/_base/declare","dojo/_base/array","dojo/_base/connect","dojo/_base/lang","dojo/_base/html","dojo/_base/event","dojo/_base/window","dojo/keys","dojo/query","dojo/string","../_Plugin","../../EnhancedGrid"],function(e,t,a,i,r,n,o,s,l,d,u,m){var h=e("dojox.grid.enhanced.plugins.NestedSorting",u,{name:"nestedSorting",_currMainSort:"none",_currRegionIdx:-1,_a11yText:{dojoxGridDescending:"&#9662;",dojoxGridAscending:"&#9652;",dojoxGridAscendingTip:"&#1784;",dojoxGridDescendingTip:"&#1783;",dojoxGridUnsortedTip:"x"},constructor:function(){this._sortDef=[],this._sortData={},this._headerNodes={},this._excludedColIdx=[],this.nls=this.grid._nls,this.grid.setSortInfo=function(){},this.grid.setSortIndex=i.hitch(this,"_setGridSortIndex"),this.grid.getSortIndex=function(){},this.grid.getSortProps=i.hitch(this,"getSortProps"),this.grid.sortFields&&this._setGridSortIndex(this.grid.sortFields,null,!0),this.connect(this.grid.views,"render","_initSort"),this.initCookieHandler(),this.grid.plugin("rearrange")?this.subscribe("dojox/grid/rearrange/move/"+this.grid.id,i.hitch(this,"_onColumnDnD")):this.connect(this.grid.layout,"moveColumn","_onMoveColumn")},onStartUp:function(){this.inherited(arguments),this.connect(this.grid,"onHeaderCellClick","_onHeaderCellClick"),this.connect(this.grid,"onHeaderCellMouseOver","_onHeaderCellMouseOver"),this.connect(this.grid,"onHeaderCellMouseOut","_onHeaderCellMouseOut")},_onMoveColumn:function(e,a,i,r,n){var o,s,l=this._getCurrentRegion(),d=l&&this._getRegionHeader(l).getAttribute("idx"),u=this._headerNodes[d],m=this._sortData,h={};if(l&&(this._blurRegion(l),this._currRegionIdx=t.indexOf(this._getRegions(),u.firstChild)),r<i)for(o in m)o=parseInt(o,10),(s=m[o])&&(o>=r&&o<i?h[o+1]=s:o==i?h[r]=s:h[o]=s);else if(r>i+1){n||r++;for(o in m)o=parseInt(o,10),(s=m[o])&&(o>i&&o<r?h[o-1]=s:o==i?h[r-1]=s:h[o]=s)}this._sortData=h,this._initSort(!1)},_onColumnDnD:function(e,a){if("col"===e){var i,r=a,n={},o=this._sortData,s=this._getCurrentRegion();this._blurRegion(s);var l=this._getRegionHeader(s).getAttribute("idx");for(i in r)o[i]&&(n[r[i]]=o[i],delete o[i]),i===l&&(l=r[i]);for(i in n)o[i]=n[i];var d=this._headerNodes[l];this._currRegionIdx=t.indexOf(this._getRegions(),d.firstChild),this._initSort(!1)}},_setGridSortIndex:function(e,a,r){if(i.isArray(e)){var n,o,s;for(n=0;n<e.length;n++){if(o=e[n],!(s=this.grid.getCellByField(o.attribute)))return;if(s.nosort||!this.grid.canSort(s.index,s.field))return}this.clearSort(),t.forEach(e,function(e,t){s=this.grid.getCellByField(e.attribute),this.setSortData(s.index,"index",t),this.setSortData(s.index,"order",e.descending?"desc":"asc")},this)}else{if(isNaN(e))return;if(void 0===a)return;this.setSortData(e,"order",a?"asc":"desc")}this._updateSortDef(),r||this.grid.sort()},getSortProps:function(){return this._sortDef.length?this._sortDef:null},_initSort:function(e){var t=this.grid,a=t.domNode,i=this._sortDef.length;r.toggleClass(a,"dojoxGridSorted",!!i),r.toggleClass(a,"dojoxGridSingleSorted",1===i),r.toggleClass(a,"dojoxGridNestSorted",i>1),i>0&&(this._currMainSort=this._sortDef[0].descending?"desc":"asc");var n,o=this._excludedCoIdx=[];this._headerNodes=l("th",t.viewsHeaderNode).forEach(function(e){n=parseInt(e.getAttribute("idx"),10),("none"===r.style(e,"display")||t.layout.cells[n].nosort||t.canSort&&!t.canSort(n,t.layout.cells[n].field))&&o.push(n)}),this._headerNodes.forEach(this._initHeaderNode,this),this._initFocus(),e&&this._focusHeader()},_initHeaderNode:function(e){r.toggleClass(e,"dojoxGridSortNoWrap",!0);var i=l(".dojoxGridSortNode",e)[0];if(i&&r.toggleClass(i,"dojoxGridSortNoWrap",!0),t.indexOf(this._excludedCoIdx,e.getAttribute("idx"))>=0)return void r.addClass(e,"dojoxGridNoSort");if(l(".dojoxGridSortBtn",e).length){var o=l(".dojoxGridSortBtnSingle",e)[0],s=l(".dojoxGridSortBtnNested",e)[0];o.className="dojoxGridSortBtn dojoxGridSortBtnSingle",s.className="dojoxGridSortBtn dojoxGridSortBtnNested",s.innerHTML="1",r.removeClass(e,"dojoxGridCellShowIndex"),r.removeClass(e.firstChild,"dojoxGridSortNodeSorted"),r.removeClass(e.firstChild,"dojoxGridSortNodeAsc"),r.removeClass(e.firstChild,"dojoxGridSortNodeDesc"),r.removeClass(e.firstChild,"dojoxGridSortNodeMain"),r.removeClass(e.firstChild,"dojoxGridSortNodeSub")}else{this._connects=t.filter(this._connects,function(e){return!e._sort||(a.disconnect(e),!1)});var u=r.create("a",{className:"dojoxGridSortBtn dojoxGridSortBtnNested",title:d.substitute(this.nls.sortingState,[this.nls.nestedSort,this.nls.ascending]),innerHTML:"1"},e.firstChild,"last");u.onmousedown=n.stop,u=r.create("a",{className:"dojoxGridSortBtn dojoxGridSortBtnSingle",title:d.substitute(this.nls.sortingState,[this.nls.singleSort,this.nls.ascending])},e.firstChild,"last"),u.onmousedown=n.stop}this._updateHeaderNodeUI(e)},_onHeaderCellClick:function(e){this._focusRegion(e.target),r.hasClass(e.target,"dojoxGridSortBtn")&&(this._onSortBtnClick(e),n.stop(e),this._focusRegion(this._getCurrentRegion()))},_onHeaderCellMouseOver:function(e){if(e.cell&&!(this._sortDef.length>1||this._sortData[e.cellIndex]&&0===this._sortData[e.cellIndex].index)){var t;for(t in this._sortData)if(this._sortData[t]&&0===this._sortData[t].index){r.addClass(this._headerNodes[t],"dojoxGridCellShowIndex");break}if(r.hasClass(o.body(),"dijit_a11y")){var a=e.cell.index,i=e.cellNode,n=l(".dojoxGridSortBtnSingle",i)[0],s=l(".dojoxGridSortBtnNested",i)[0];r.hasClass(this.grid.domNode,"dojoxGridSingleSorted")?"single":r.hasClass(this.grid.domNode,"dojoxGridNestSorted")&&"nested";var d=s.getAttribute("orderIndex");null!==d&&void 0!==d||(s.setAttribute("orderIndex",s.innerHTML),d=s.innerHTML),this.isAsc(a)?s.innerHTML=d+this._a11yText.dojoxGridDescending:this.isDesc(a)?s.innerHTML=d+this._a11yText.dojoxGridUnsortedTip:s.innerHTML=d+this._a11yText.dojoxGridAscending,"none"===this._currMainSort?n.innerHTML=this._a11yText.dojoxGridAscending:"asc"===this._currMainSort?n.innerHTML=this._a11yText.dojoxGridDescending:"desc"===this._currMainSort&&(n.innerHTML=this._a11yText.dojoxGridUnsortedTip)}}},_onHeaderCellMouseOut:function(e){var t;for(t in this._sortData)if(this._sortData[t]&&0===this._sortData[t].index){r.removeClass(this._headerNodes[t],"dojoxGridCellShowIndex");break}},_onSortBtnClick:function(e){var t=e.cell.index;if(r.hasClass(e.target,"dojoxGridSortBtnSingle"))this._prepareSingleSort(t);else{if(!r.hasClass(e.target,"dojoxGridSortBtnNested"))return;this._prepareNestedSort(t)}n.stop(e),this._doSort(t)},_doSort:function(e){this._sortData[e]&&this._sortData[e].order?this.isAsc(e)?this.setSortData(e,"order","desc"):this.isDesc(e)&&this.removeSortData(e):this.setSortData(e,"order","asc"),this._updateSortDef(),this.grid.sort(),this._initSort(!0)},setSortData:function(e,t,a){var i=this._sortData[e];i||(i=this._sortData[e]={}),i[t]=a},removeSortData:function(e){var t,a=this._sortData,i=a[e].index;delete a[e];for(t in a)a[t].index>i&&a[t].index--},_prepareSingleSort:function(e){var t,a=this._sortData;for(t in a)delete a[t];this.setSortData(e,"index",0),this.setSortData(e,"order","none"===this._currMainSort?null:this._currMainSort),this._sortData[e]&&this._sortData[e].order?this.isAsc(e)?this._currMainSort="desc":this.isDesc(e)&&(this._currMainSort="none"):this._currMainSort="asc"},_prepareNestedSort:function(e){var t=this._sortData[e]?this._sortData[e].index:null;0===t||t||this.setSortData(e,"index",this._sortDef.length)},_updateSortDef:function(){this._sortDef.length=0;var e,t=this._sortData;for(e in t)this._sortDef[t[e].index]={attribute:this.grid.layout.cells[e].field,descending:"desc"===t[e].order}},_updateHeaderNodeUI:function(e){function a(){var e="Column "+(i.index+1)+" "+i.field,a="none",r="ascending";s&&(a="asc"===s.order?"ascending":"descending",r="asc"===s.order?"descending":"none");var n=e+" - is sorted by "+a,o=e+" - is nested sorted by "+a,l=e+" - choose to sort by "+r,d=e+" - choose to nested sort by "+r;m.setAttribute("aria-label",n),h.setAttribute("aria-label",o);var u=[c.connect(m,"onmouseover",function(){m.setAttribute("aria-label",l)}),c.connect(m,"onmouseout",function(){m.setAttribute("aria-label",n)}),c.connect(h,"onmouseover",function(){h.setAttribute("aria-label",d)}),c.connect(h,"onmouseout",function(){h.setAttribute("aria-label",o)})];t.forEach(u,function(e){e._sort=!0})}var i=this._getCellByNode(e),n=i.index,s=this._sortData[n],u=l(".dojoxGridSortNode",e)[0],m=l(".dojoxGridSortBtnSingle",e)[0],h=l(".dojoxGridSortBtnNested",e)[0];r.toggleClass(m,"dojoxGridSortBtnAsc","asc"===this._currMainSort),r.toggleClass(m,"dojoxGridSortBtnDesc","desc"===this._currMainSort),"asc"===this._currMainSort?m.title=d.substitute(this.nls.sortingState,[this.nls.singleSort,this.nls.descending]):"desc"===this._currMainSort?m.title=d.substitute(this.nls.sortingState,[this.nls.singleSort,this.nls.unsorted]):m.title=d.substitute(this.nls.sortingState,[this.nls.singleSort,this.nls.ascending]);var c=this;a();var f=r.hasClass(o.body(),"dijit_a11y");if(!s)return h.innerHTML=this._sortDef.length+1,h.title=d.substitute(this.nls.sortingState,[this.nls.nestedSort,this.nls.ascending]),void(f&&(u.innerHTML=this._a11yText.dojoxGridUnsortedTip));(s.index||0===s.index&&this._sortDef.length>1)&&(h.innerHTML=s.index+1),r.addClass(u,"dojoxGridSortNodeSorted"),this.isAsc(n)?(r.addClass(u,"dojoxGridSortNodeAsc"),h.title=d.substitute(this.nls.sortingState,[this.nls.nestedSort,this.nls.descending]),f&&(u.innerHTML=this._a11yText.dojoxGridAscendingTip)):this.isDesc(n)&&(r.addClass(u,"dojoxGridSortNodeDesc"),h.title=d.substitute(this.nls.sortingState,[this.nls.nestedSort,this.nls.unsorted]),f&&(u.innerHTML=this._a11yText.dojoxGridDescendingTip)),r.addClass(u,0===s.index?"dojoxGridSortNodeMain":"dojoxGridSortNodeSub")},isAsc:function(e){return"asc"===this._sortData[e].order},isDesc:function(e){return"desc"===this._sortData[e].order},_getCellByNode:function(e){var t;for(t=0;t<this._headerNodes.length;t++)if(this._headerNodes[t]===e)return this.grid.layout.cells[t];return null},clearSort:function(){this._sortData={},this._sortDef.length=0},initCookieHandler:function(){this.grid.addCookieHandler&&this.grid.addCookieHandler({name:"sortOrder",onLoad:i.hitch(this,"_loadNestedSortingProps"),onSave:i.hitch(this,"_saveNestedSortingProps")})},_loadNestedSortingProps:function(e,t){this._setGridSortIndex(e)},_saveNestedSortingProps:function(e){return this.getSortProps()},_initFocus:function(){var e=this.focus=this.grid.focus;if(this._focusRegions=this._getRegions(),!this._headerArea){var t=this._headerArea=e.getArea("header");t.onFocus=e.focusHeader=i.hitch(this,"_focusHeader"),t.onBlur=e.blurHeader=e._blurHeader=i.hitch(this,"_blurHeader"),t.onMove=i.hitch(this,"_onMove"),t.onKeyDown=i.hitch(this,"_onKeyDown"),t._regions=[],t.getRegions=null,this.connect(this.grid,"onBlur","_blurHeader")}},_focusHeader:function(e){if(-1===this._currRegionIdx)this._onMove(0,1,null);else{var t=this._getCurrentRegion();this._focusRegion(t);var a=this._getRegionView(t);a.scrollboxNode.scrollLeft=a.headerNode.scrollLeft}try{e&&n.stop(e)}catch(e){}return!0},_blurHeader:function(e){return this._blurRegion(this._getCurrentRegion()),!0},_onMove:function(e,t,a){var i=this._currRegionIdx||0,n=this._focusRegions,o=n[i+t];if(o){if("none"===r.style(o,"display")||"hidden"===r.style(o,"visibility"))return void this._onMove(e,t+(t>0?1:-1),a);this._focusRegion(o);var s=this._getRegionView(o);s.scrollboxNode.scrollLeft=s.headerNode.scrollLeft}},_onKeyDown:function(e,t){if(t)switch(e.keyCode){case s.ENTER:case s.SPACE:(r.hasClass(e.target,"dojoxGridSortBtnSingle")||r.hasClass(e.target,"dojoxGridSortBtnNested"))&&this._onSortBtnClick(e)}},_getRegionView:function(e){for(var a=e;a&&!r.hasClass(a,"dojoxGridHeader");)a=a.parentNode;return a?t.filter(this.grid.views.views,function(e){return e.headerNode===a})[0]||null:null},_getRegions:function(){var e=[],t=this.grid.layout.cells;return this._headerNodes.forEach(function(a,i){if("none"!==r.style(a,"display"))return t[i].isRowSelector?void e.push(a):void l(".dojoxGridSortNode,.dojoxGridSortBtnNested,.dojoxGridSortBtnSingle",a).forEach(function(t){t.setAttribute("tabindex",0),e.push(t)})},this),e},_focusRegion:function(e){if(e){var a=this._getCurrentRegion();a&&e!==a&&this._blurRegion(a);var i=this._getRegionHeader(e);r.addClass(i,"dojoxGridCellSortFocus"),r.hasClass(e,"dojoxGridSortNode")?r.addClass(e,"dojoxGridSortNodeFocus"):r.hasClass(e,"dojoxGridSortBtn")&&r.addClass(e,"dojoxGridSortBtnFocus");try{e.focus()}catch(e){}this.focus.currentArea("header"),this._currRegionIdx=t.indexOf(this._focusRegions,e)}},_blurRegion:function(e){if(e){var t=this._getRegionHeader(e);r.removeClass(t,"dojoxGridCellSortFocus"),r.hasClass(e,"dojoxGridSortNode")?r.removeClass(e,"dojoxGridSortNodeFocus"):r.hasClass(e,"dojoxGridSortBtn")&&r.removeClass(e,"dojoxGridSortBtnFocus"),e.blur()}},_getCurrentRegion:function(){return this._focusRegions?this._focusRegions[this._currRegionIdx]:null},_getRegionHeader:function(e){for(;e&&!r.hasClass(e,"dojoxGridCell");)e=e.parentNode;return e},destroy:function(){this._sortDef=this._sortData=null,this._headerNodes=this._focusRegions=null,this.inherited(arguments)}});return m.registerPlugin(h),h});//# sourceMappingURL=NestedSorting.js.map