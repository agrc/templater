//>>built
define("dojox/grid/enhanced/plugins/NestedSorting",["dojo/_base/declare","dojo/_base/array","dojo/_base/connect","dojo/_base/lang","dojo/_base/html","dojo/_base/event","dojo/_base/window","dojo/keys","dojo/query","dojo/string","../_Plugin","../../EnhancedGrid"],function(e,t,i,a,r,n,o,s,l,d,u,c){var m=e("dojox.grid.enhanced.plugins.NestedSorting",u,{name:"nestedSorting",_currMainSort:"none",_currRegionIdx:-1,_a11yText:{dojoxGridDescending:"&#9662;",dojoxGridAscending:"&#9652;",dojoxGridAscendingTip:"&#1784;",dojoxGridDescendingTip:"&#1783;",dojoxGridUnsortedTip:"x"},constructor:function(){this._sortDef=[],this._sortData={},this._headerNodes={},this._excludedColIdx=[],this.nls=this.grid._nls,this.grid.setSortInfo=function(){},this.grid.setSortIndex=a.hitch(this,"_setGridSortIndex"),this.grid.getSortIndex=function(){},this.grid.getSortProps=a.hitch(this,"getSortProps"),this.grid.sortFields&&this._setGridSortIndex(this.grid.sortFields,null,!0),this.connect(this.grid.views,"render","_initSort"),this.initCookieHandler(),this.grid.plugin("rearrange")?this.subscribe("dojox/grid/rearrange/move/"+this.grid.id,a.hitch(this,"_onColumnDnD")):this.connect(this.grid.layout,"moveColumn","_onMoveColumn")},onStartUp:function(){this.inherited(arguments),this.connect(this.grid,"onHeaderCellClick","_onHeaderCellClick"),this.connect(this.grid,"onHeaderCellMouseOver","_onHeaderCellMouseOver"),this.connect(this.grid,"onHeaderCellMouseOut","_onHeaderCellMouseOut")},_onMoveColumn:function(e,i,a,r,n){var o,s,l=this._getCurrentRegion(),d=l&&this._getRegionHeader(l).getAttribute("idx"),u=this._headerNodes[d],c=this._sortData,m={};if(l&&(this._blurRegion(l),this._currRegionIdx=t.indexOf(this._getRegions(),u.firstChild)),r<a)for(o in c)o=parseInt(o,10),(s=c[o])&&(o>=r&&o<a?m[o+1]=s:o==a?m[r]=s:m[o]=s);else if(r>a+1){n||r++;for(o in c)o=parseInt(o,10),(s=c[o])&&(o>a&&o<r?m[o-1]=s:o==a?m[r-1]=s:m[o]=s)}this._sortData=m,this._initSort(!1)},_onColumnDnD:function(e,i){if("col"===e){var a,r=i,n={},o=this._sortData,s=this._getCurrentRegion();this._blurRegion(s);var l=this._getRegionHeader(s).getAttribute("idx");for(a in r)o[a]&&(n[r[a]]=o[a],delete o[a]),a===l&&(l=r[a]);for(a in n)o[a]=n[a];var d=this._headerNodes[l];this._currRegionIdx=t.indexOf(this._getRegions(),d.firstChild),this._initSort(!1)}},_setGridSortIndex:function(e,i,r){if(a.isArray(e)){var n,o,s;for(n=0;n<e.length;n++){if(o=e[n],!(s=this.grid.getCellByField(o.attribute)))return;if(s.nosort||!this.grid.canSort(s.index,s.field))return}this.clearSort(),t.forEach(e,function(e,t){s=this.grid.getCellByField(e.attribute),this.setSortData(s.index,"index",t),this.setSortData(s.index,"order",e.descending?"desc":"asc")},this)}else{if(isNaN(e))return;if(void 0===i)return;this.setSortData(e,"order",i?"asc":"desc")}this._updateSortDef(),r||this.grid.sort()},getSortProps:function(){return this._sortDef.length?this._sortDef:null},_initSort:function(e){var t=this.grid,i=t.domNode,a=this._sortDef.length;r.toggleClass(i,"dojoxGridSorted",!!a),r.toggleClass(i,"dojoxGridSingleSorted",1===a),r.toggleClass(i,"dojoxGridNestSorted",a>1),a>0&&(this._currMainSort=this._sortDef[0].descending?"desc":"asc");var n,o=this._excludedCoIdx=[];this._headerNodes=l("th",t.viewsHeaderNode).forEach(function(e){n=parseInt(e.getAttribute("idx"),10),("none"===r.style(e,"display")||t.layout.cells[n].nosort||t.canSort&&!t.canSort(n,t.layout.cells[n].field))&&o.push(n)}),this._headerNodes.forEach(this._initHeaderNode,this),this._initFocus(),e&&this._focusHeader()},_initHeaderNode:function(e){r.toggleClass(e,"dojoxGridSortNoWrap",!0);var a=l(".dojoxGridSortNode",e)[0];if(a&&r.toggleClass(a,"dojoxGridSortNoWrap",!0),t.indexOf(this._excludedCoIdx,e.getAttribute("idx"))>=0)return void r.addClass(e,"dojoxGridNoSort");if(l(".dojoxGridSortBtn",e).length){var o=l(".dojoxGridSortBtnSingle",e)[0],s=l(".dojoxGridSortBtnNested",e)[0];o.className="dojoxGridSortBtn dojoxGridSortBtnSingle",s.className="dojoxGridSortBtn dojoxGridSortBtnNested",s.innerHTML="1",r.removeClass(e,"dojoxGridCellShowIndex"),r.removeClass(e.firstChild,"dojoxGridSortNodeSorted"),r.removeClass(e.firstChild,"dojoxGridSortNodeAsc"),r.removeClass(e.firstChild,"dojoxGridSortNodeDesc"),r.removeClass(e.firstChild,"dojoxGridSortNodeMain"),r.removeClass(e.firstChild,"dojoxGridSortNodeSub")}else{this._connects=t.filter(this._connects,function(e){return!e._sort||(i.disconnect(e),!1)});var u=r.create("a",{className:"dojoxGridSortBtn dojoxGridSortBtnNested",title:d.substitute(this.nls.sortingState,[this.nls.nestedSort,this.nls.ascending]),innerHTML:"1"},e.firstChild,"last");u.onmousedown=n.stop,u=r.create("a",{className:"dojoxGridSortBtn dojoxGridSortBtnSingle",title:d.substitute(this.nls.sortingState,[this.nls.singleSort,this.nls.ascending])},e.firstChild,"last"),u.onmousedown=n.stop}this._updateHeaderNodeUI(e)},_onHeaderCellClick:function(e){this._focusRegion(e.target),r.hasClass(e.target,"dojoxGridSortBtn")&&(this._onSortBtnClick(e),n.stop(e),this._focusRegion(this._getCurrentRegion()))},_onHeaderCellMouseOver:function(e){if(e.cell&&!(this._sortDef.length>1||this._sortData[e.cellIndex]&&0===this._sortData[e.cellIndex].index)){var t;for(t in this._sortData)if(this._sortData[t]&&0===this._sortData[t].index){r.addClass(this._headerNodes[t],"dojoxGridCellShowIndex");break}if(r.hasClass(o.body(),"dijit_a11y")){var i=e.cell.index,a=e.cellNode,n=l(".dojoxGridSortBtnSingle",a)[0],s=l(".dojoxGridSortBtnNested",a)[0];r.hasClass(this.grid.domNode,"dojoxGridSingleSorted")?"single":r.hasClass(this.grid.domNode,"dojoxGridNestSorted")&&"nested";var d=s.getAttribute("orderIndex");null!==d&&void 0!==d||(s.setAttribute("orderIndex",s.innerHTML),d=s.innerHTML),this.isAsc(i)?s.innerHTML=d+this._a11yText.dojoxGridDescending:this.isDesc(i)?s.innerHTML=d+this._a11yText.dojoxGridUnsortedTip:s.innerHTML=d+this._a11yText.dojoxGridAscending,"none"===this._currMainSort?n.innerHTML=this._a11yText.dojoxGridAscending:"asc"===this._currMainSort?n.innerHTML=this._a11yText.dojoxGridDescending:"desc"===this._currMainSort&&(n.innerHTML=this._a11yText.dojoxGridUnsortedTip)}}},_onHeaderCellMouseOut:function(e){var t;for(t in this._sortData)if(this._sortData[t]&&0===this._sortData[t].index){r.removeClass(this._headerNodes[t],"dojoxGridCellShowIndex");break}},_onSortBtnClick:function(e){var t=e.cell.index;if(r.hasClass(e.target,"dojoxGridSortBtnSingle"))this._prepareSingleSort(t);else{if(!r.hasClass(e.target,"dojoxGridSortBtnNested"))return;this._prepareNestedSort(t)}n.stop(e),this._doSort(t)},_doSort:function(e){this._sortData[e]&&this._sortData[e].order?this.isAsc(e)?this.setSortData(e,"order","desc"):this.isDesc(e)&&this.removeSortData(e):this.setSortData(e,"order","asc"),this._updateSortDef(),this.grid.sort(),this._initSort(!0)},setSortData:function(e,t,i){var a=this._sortData[e];a||(a=this._sortData[e]={}),a[t]=i},removeSortData:function(e){var t,i=this._sortData,a=i[e].index;delete i[e];for(t in i)i[t].index>a&&i[t].index--},_prepareSingleSort:function(e){var t,i=this._sortData;for(t in i)delete i[t];this.setSortData(e,"index",0),this.setSortData(e,"order","none"===this._currMainSort?null:this._currMainSort),this._sortData[e]&&this._sortData[e].order?this.isAsc(e)?this._currMainSort="desc":this.isDesc(e)&&(this._currMainSort="none"):this._currMainSort="asc"},_prepareNestedSort:function(e){var t=this._sortData[e]?this._sortData[e].index:null;0===t||t||this.setSortData(e,"index",this._sortDef.length)},_updateSortDef:function(){this._sortDef.length=0;var e,t=this._sortData;for(e in t)this._sortDef[t[e].index]={attribute:this.grid.layout.cells[e].field,descending:"desc"===t[e].order}},_updateHeaderNodeUI:function(e){function i(){var e="Column "+(a.index+1)+" "+a.field,i="none",r="ascending";s&&(i="asc"===s.order?"ascending":"descending",r="asc"===s.order?"descending":"none");var n=e+" - is sorted by "+i,o=e+" - is nested sorted by "+i,l=e+" - choose to sort by "+r,d=e+" - choose to nested sort by "+r;c.setAttribute("aria-label",n),m.setAttribute("aria-label",o);var u=[h.connect(c,"onmouseover",function(){c.setAttribute("aria-label",l)}),h.connect(c,"onmouseout",function(){c.setAttribute("aria-label",n)}),h.connect(m,"onmouseover",function(){m.setAttribute("aria-label",d)}),h.connect(m,"onmouseout",function(){m.setAttribute("aria-label",o)})];t.forEach(u,function(e){e._sort=!0})}var a=this._getCellByNode(e),n=a.index,s=this._sortData[n],u=l(".dojoxGridSortNode",e)[0],c=l(".dojoxGridSortBtnSingle",e)[0],m=l(".dojoxGridSortBtnNested",e)[0];r.toggleClass(c,"dojoxGridSortBtnAsc","asc"===this._currMainSort),r.toggleClass(c,"dojoxGridSortBtnDesc","desc"===this._currMainSort),"asc"===this._currMainSort?c.title=d.substitute(this.nls.sortingState,[this.nls.singleSort,this.nls.descending]):"desc"===this._currMainSort?c.title=d.substitute(this.nls.sortingState,[this.nls.singleSort,this.nls.unsorted]):c.title=d.substitute(this.nls.sortingState,[this.nls.singleSort,this.nls.ascending]);var h=this;i();var f=r.hasClass(o.body(),"dijit_a11y");if(!s)return m.innerHTML=this._sortDef.length+1,m.title=d.substitute(this.nls.sortingState,[this.nls.nestedSort,this.nls.ascending]),void(f&&(u.innerHTML=this._a11yText.dojoxGridUnsortedTip));(s.index||0===s.index&&this._sortDef.length>1)&&(m.innerHTML=s.index+1),r.addClass(u,"dojoxGridSortNodeSorted"),this.isAsc(n)?(r.addClass(u,"dojoxGridSortNodeAsc"),m.title=d.substitute(this.nls.sortingState,[this.nls.nestedSort,this.nls.descending]),f&&(u.innerHTML=this._a11yText.dojoxGridAscendingTip)):this.isDesc(n)&&(r.addClass(u,"dojoxGridSortNodeDesc"),m.title=d.substitute(this.nls.sortingState,[this.nls.nestedSort,this.nls.unsorted]),f&&(u.innerHTML=this._a11yText.dojoxGridDescendingTip)),r.addClass(u,0===s.index?"dojoxGridSortNodeMain":"dojoxGridSortNodeSub")},isAsc:function(e){return"asc"===this._sortData[e].order},isDesc:function(e){return"desc"===this._sortData[e].order},_getCellByNode:function(e){var t;for(t=0;t<this._headerNodes.length;t++)if(this._headerNodes[t]===e)return this.grid.layout.cells[t];return null},clearSort:function(){this._sortData={},this._sortDef.length=0},initCookieHandler:function(){this.grid.addCookieHandler&&this.grid.addCookieHandler({name:"sortOrder",onLoad:a.hitch(this,"_loadNestedSortingProps"),onSave:a.hitch(this,"_saveNestedSortingProps")})},_loadNestedSortingProps:function(e,t){this._setGridSortIndex(e)},_saveNestedSortingProps:function(e){return this.getSortProps()},_initFocus:function(){var e=this.focus=this.grid.focus;if(this._focusRegions=this._getRegions(),!this._headerArea){var t=this._headerArea=e.getArea("header");t.onFocus=e.focusHeader=a.hitch(this,"_focusHeader"),t.onBlur=e.blurHeader=e._blurHeader=a.hitch(this,"_blurHeader"),t.onMove=a.hitch(this,"_onMove"),t.onKeyDown=a.hitch(this,"_onKeyDown"),t._regions=[],t.getRegions=null,this.connect(this.grid,"onBlur","_blurHeader")}},_focusHeader:function(e){if(-1===this._currRegionIdx)this._onMove(0,1,null);else{var t=this._getCurrentRegion();this._focusRegion(t);var i=this._getRegionView(t);i.scrollboxNode.scrollLeft=i.headerNode.scrollLeft}try{e&&n.stop(e)}catch(e){}return!0},_blurHeader:function(e){return this._blurRegion(this._getCurrentRegion()),!0},_onMove:function(e,t,i){var a=this._currRegionIdx||0,n=this._focusRegions,o=n[a+t];if(o){if("none"===r.style(o,"display")||"hidden"===r.style(o,"visibility"))return void this._onMove(e,t+(t>0?1:-1),i);this._focusRegion(o);var s=this._getRegionView(o);s.scrollboxNode.scrollLeft=s.headerNode.scrollLeft}},_onKeyDown:function(e,t){if(t)switch(e.keyCode){case s.ENTER:case s.SPACE:(r.hasClass(e.target,"dojoxGridSortBtnSingle")||r.hasClass(e.target,"dojoxGridSortBtnNested"))&&this._onSortBtnClick(e)}},_getRegionView:function(e){for(var i=e;i&&!r.hasClass(i,"dojoxGridHeader");)i=i.parentNode;return i?t.filter(this.grid.views.views,function(e){return e.headerNode===i})[0]||null:null},_getRegions:function(){var e=[],t=this.grid.layout.cells;return this._headerNodes.forEach(function(i,a){if("none"!==r.style(i,"display"))return t[a].isRowSelector?void e.push(i):void l(".dojoxGridSortNode,.dojoxGridSortBtnNested,.dojoxGridSortBtnSingle",i).forEach(function(t){t.setAttribute("tabindex",0),e.push(t)})},this),e},_focusRegion:function(e){if(e){var i=this._getCurrentRegion();i&&e!==i&&this._blurRegion(i);var a=this._getRegionHeader(e);r.addClass(a,"dojoxGridCellSortFocus"),r.hasClass(e,"dojoxGridSortNode")?r.addClass(e,"dojoxGridSortNodeFocus"):r.hasClass(e,"dojoxGridSortBtn")&&r.addClass(e,"dojoxGridSortBtnFocus");try{e.focus()}catch(e){}this.focus.currentArea("header"),this._currRegionIdx=t.indexOf(this._focusRegions,e)}},_blurRegion:function(e){if(e){var t=this._getRegionHeader(e);r.removeClass(t,"dojoxGridCellSortFocus"),r.hasClass(e,"dojoxGridSortNode")?r.removeClass(e,"dojoxGridSortNodeFocus"):r.hasClass(e,"dojoxGridSortBtn")&&r.removeClass(e,"dojoxGridSortBtnFocus"),e.blur()}},_getCurrentRegion:function(){return this._focusRegions?this._focusRegions[this._currRegionIdx]:null},_getRegionHeader:function(e){for(;e&&!r.hasClass(e,"dojoxGridCell");)e=e.parentNode;return e},destroy:function(){this._sortDef=this._sortData=null,this._headerNodes=this._focusRegions=null,this.inherited(arguments)}});return c.registerPlugin(m),m});//# sourceMappingURL=NestedSorting.js.map