//>>built
define("dojox/grid/enhanced/plugins/CellMerge",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/html","../_Plugin","../../EnhancedGrid"],function(e,t,i,a,n,r){var o=e("dojox.grid.enhanced.plugins.CellMerge",n,{name:"cellMerge",constructor:function(e,t){this.grid=e,this._records=[],this._merged={},t&&i.isObject(t)&&this._setupConfig(t.mergedCells),this._initEvents(),this._mixinGrid()},mergeCells:function(e,t,i,a){var n=this._createRecord({row:e,start:t,end:i,major:a});return n&&this._updateRows(n),n},unmergeCells:function(e){var i;e&&(i=t.indexOf(this._records,e))>=0&&(this._records.splice(i,1),this._updateRows(e))},getMergedCells:function(){var e=[];for(var t in this._merged)e=e.concat(this._merged[t]);return e},getMergedCellsByRow:function(e){return this._merged[e]||[]},_setupConfig:function(e){t.forEach(e,this._createRecord,this)},_initEvents:function(){t.forEach(this.grid.views.views,function(e){this.connect(e,"onAfterRow",i.hitch(this,"_onAfterRow",e.index))},this)},_mixinGrid:function(){var e=this.grid;e.mergeCells=i.hitch(this,"mergeCells"),e.unmergeCells=i.hitch(this,"unmergeCells"),e.getMergedCells=i.hitch(this,"getMergedCells"),e.getMergedCellsByRow=i.hitch(this,"getMergedCellsByRow")},_getWidth:function(e){var t=this.grid.layout.cells[e].getHeaderNode();return a.position(t).w},_onAfterRow:function(e,i,n){try{if(0>i)return;var r,o,s=[],l=this._records.length,d=this.grid.layout.cells;for(r=0;l>r;++r){var u=this._records[r],c=this.grid._by_idx[i];if(u.view==e&&u.row(i,c&&c.item,this.grid.store)){var m={record:u,hiddenCells:[],totalWidth:0,majorNode:d[u.major].getNode(i),majorHeaderNode:d[u.major].getHeaderNode()};for(o=u.start;o<=u.end;++o){var h=this._getWidth(o,i);m.totalWidth+=h,o!=u.major&&m.hiddenCells.push(d[o].getNode(i))}if(1!=n.length||m.totalWidth>0){for(o=s.length-1;o>=0;--o){var f=s[o].record;(f.start>=u.start&&f.start<=u.end||f.end>=u.start&&f.end<=u.end)&&s.splice(o,1)}s.push(m)}}}this._merged[i]=[],t.forEach(s,function(e){t.forEach(e.hiddenCells,function(e){a.style(e,"display","none")});var n=a.marginBox(e.majorHeaderNode).w-a.contentBox(e.majorHeaderNode).w,r=e.totalWidth;a.isWebKit||(r-=n),a.style(e.majorNode,"width",r+"px"),e.majorNode.setAttribute("colspan",e.hiddenCells.length+1),this._merged[i].push({row:i,start:e.record.start,end:e.record.end,major:e.record.major,handle:e.record})},this)}catch(p){}},_createRecord:function(e){if(this._isValid(e)){e={row:e.row,start:e.start,end:e.end,major:e.major};var t=this.grid.layout.cells;if(e.view=t[e.start].view.index,e.major="number"!=typeof e.major||isNaN(e.major)?e.start:e.major,"number"==typeof e.row){var a=e.row;e.row=function(e){return e===a}}else if("string"==typeof e.row){var n=e.row;e.row=function(e,t,i){try{if(i&&t&&i.getFeatures()["dojo.data.api.Identity"])return i.getIdentity(t)==n}catch(a){}return!1}}if(i.isFunction(e.row))return this._records.push(e),e}return null},_isValid:function(e){var t=this.grid.layout.cells,a=t.length;return i.isObject(e)&&"row"in e&&"start"in e&&"end"in e&&e.start>=0&&e.start<a&&e.end>e.start&&e.end<a&&t[e.start].view.index==t[e.end].view.index&&t[e.start].subrow==t[e.end].subrow&&!("number"==typeof e.major&&(e.major<e.start||e.major>e.end))},_updateRows:function(e){for(var t=null,i=0,a=this.grid.rowCount;a>i;++i){var n=this.grid._by_idx[i];n&&e.row(i,n&&n.item,this.grid.store)&&(this.grid.views.updateRow(i),null===t&&(t=i))}t>=0&&this.grid.scroller.rowHeightChanged(t)}});return r.registerPlugin(o),o});//# sourceMappingURL=CellMerge.js.map