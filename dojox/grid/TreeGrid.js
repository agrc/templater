//>>built
define("dojox/grid/TreeGrid",["dojo/_base/kernel","../main","dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/event","dojo/dom-attr","dojo/dom-class","dojo/query","dojo/keys","dijit/tree/ForestStoreModel","./DataGrid","./_Layout","./_FocusManager","./_RowManager","./_EditManager","./TreeSelection","./cells/tree","./_TreeView"],function(e,t,i,a,r,o,n,s,d,l,u,h,m,c,f,g,p,y){e.experimental("dojox.grid.TreeGrid");var v=i("dojox.grid._TreeAggregator",null,{cells:[],grid:null,childFields:[],constructor:function(e){this.cells=e.cells||[],this.childFields=e.childFields||[],this.grid=e.grid,this.store=this.grid.store},_cacheValue:function(e,t,i){return e[t]=i,i},clearSubtotalCache:function(){this.store&&delete this.store._cachedAggregates},cnt:function(e,t,i){var r=0,o=this.store,n=this.childFields;if(n[t]){var s=o.getValues(i,n[t]);e.index<=t+1?r=s.length:a.forEach(s,function(i){r+=this.getForCell(e,t+1,i,"cnt")},this)}else r=1;return r},sum:function(e,t,i){var r=0,o=this.store,n=this.childFields;return n[t]?a.forEach(o.getValues(i,n[t]),function(i){r+=this.getForCell(e,t+1,i,"sum")},this):r+=o.getValue(i,e.field),r},value:function(e,t,i){},getForCell:function(e,t,i,a){var r=this.store;if(!r||!i||!r.isItem(i))return"";var o=r._cachedAggregates=r._cachedAggregates||{},n=r.getIdentity(i),s=o[n]=o[n]||[];e.getOpenState||(e=this.grid.getCell(e.layoutIndex+t+1));var d=e.index,l=s[d]=s[d]||{};a=a||(e.parentCell?e.parentCell.aggregate:"sum")||"sum";var u=e.field;u==r.getLabelAttributes()[0]&&(a="cnt");var h=l[a]=l[a]||[];if(void 0!=h[t])return h[t];var m=(e.parentCell&&e.parentCell.itemAggregates?e.parentCell.itemAggregates[e.idxInParent]:"")||"";return m&&r.hasAttribute(i,m)?this._cacheValue(h,t,r.getValue(i,m)):m?this._cacheValue(h,t,0):this._cacheValue(h,t,this[a](e,t,i))}}),b=i("dojox.grid._TreeLayout",m,{_isCollapsable:!1,_getInternalStructure:function(e){var t=this.grid,i=e,o=i[0].cells[0],n={type:"dojox.grid._TreeView",cells:[[]]},s=[],d=0,l=function(e,t){var i=e.children,o=function(i,a){var o,n={};for(o in i)n[o]=i[o];return n=r.mixin(n,{level:t,idxInParent:t>0?a:-1,parentCell:t>0?e:null})},n=[];return a.forEach(i,function(e,i){if("children"in e){s.push(e.field);var a=n[n.length-1];a.isCollapsable=!0,e.level=t,n=n.concat(l(e,t+1))}else n.push(o(e,i))}),d=Math.max(d,t),n},u={children:o,itemAggregates:[]};return n.cells[0]=l(u,0),t.aggregator=new v({cells:n.cells[0],grid:t,childFields:s}),t.scroller&&t.defaultOpen&&(t.scroller.defaultRowHeight=t.scroller._origDefaultRowHeight*(2*d+1)),[n]},setStructure:function(e){var t=e,i=this.grid;if(i&&i.treeModel&&!a.every(t,function(e){return"cells"in e})&&(t=arguments[0]=[{cells:[t]}]),1==t.length&&1==t[0].cells.length)if(i&&i.treeModel)t[0].type="dojox.grid._TreeView",this._isCollapsable=!0,t[0].cells[0][this.grid.treeModel?this.grid.expandoCell:0].isCollapsable=!0;else{var r=a.filter(t[0].cells[0],function(e){return"children"in e});1===r.length&&(this._isCollapsable=!0)}!this._isCollapsable||i&&i.treeModel||(arguments[0]=this._getInternalStructure(t)),this.inherited(arguments)},addCellDef:function(e,t,i){var a=this.inherited(arguments);return r.mixin(a,y)}}),k=i("dojox.grid.TreePath",null,{level:0,_str:"",_arr:null,grid:null,store:null,cell:null,item:null,constructor:function(e,t){r.isString(e)?(this._str=e,this._arr=a.map(e.split("/"),function(e){return parseInt(e,10)})):r.isArray(e)?(this._str=e.join("/"),this._arr=e.slice(0)):"number"==typeof e?(this._str=String(e),this._arr=[e]):(this._str=e._str,this._arr=e._arr.slice(0)),this.level=this._arr.length-1,this.grid=t,this.store=this.grid.store,t.treeModel?this.cell=t.layout.cells[t.expandoCell]:this.cell=t.layout.cells[this.level]},item:function(){return this._item||(this._item=this.grid.getItem(this._arr)),this._item},compare:function(e){if(r.isString(e)||r.isArray(e)){if(this._str==e)return 0;if(e.join&&this._str==e.join("/"))return 0;e=new k(e,this.grid)}else if(e instanceof k&&this._str==e._str)return 0;for(var t=0,i=this._arr.length<e._arr.length?this._arr.length:e._arr.length;i>t;t++){if(this._arr[t]<e._arr[t])return-1;if(this._arr[t]>e._arr[t])return 1}return this._arr.length<e._arr.length?-1:this._arr.length>e._arr.length?1:0},isOpen:function(){return this.cell.openStates&&this.cell.getOpenState(this.item())},previous:function(){var e=this._arr.slice(0);if("0"==this._str)return null;var t=e.length-1;if(0===e[t])return e.pop(),new k(e,this.grid);e[t]--;var i=new k(e,this.grid);return i.lastChild(!0)},next:function(){var e=this._arr.slice(0);if(this.isOpen())e.push(0);else{e[e.length-1]++;for(var t=this.level;t>=0;t--){var i=this.grid.getItem(e.slice(0,t+1));if(t>0)i||(e.pop(),e[t-1]++);else if(!i)return null}}return new k(e,this.grid)},children:function(e){if(!this.isOpen()&&!e)return null;var t=[],i=this.grid.treeModel;if(i){var r=this.item(),o=i.store;if(!i.mayHaveChildren(r))return null;a.forEach(i.childrenAttrs,function(e){t=t.concat(o.getValues(r,e))})}else if(t=this.store.getValues(this.item(),this.grid.layout.cells[this.cell.level+1].parentCell.field),t.length>1&&this.grid.sortChildItems){var n=this.grid.getSortProps();if(n&&n.length){var s=n[0].attribute,d=this.grid;if(s&&t[0][s]){var l=!!n[0].descending;t=t.slice(0),t.sort(function(e,t){return d._childItemSorter(e,t,s,l)})}}}return t},childPaths:function(){var e=this.children();return e?a.map(e,function(e,t){return new k(this._str+"/"+t,this.grid)},this):[]},parent:function(){return 0===this.level?null:new k(this._arr.slice(0,this.level),this.grid)},lastChild:function(e){var t=this.children();if(!t||!t.length)return this;var i=new k(this._str+"/"+String(t.length-1),this.grid);return e?i.lastChild(!0):i},toString:function(){return this._str}}),M=i("dojox.grid._TreeFocusManager",c,{setFocusCell:function(e,t){e&&e.getNode(t)&&this.inherited(arguments)},isLastFocusCell:function(){if(this.cell&&this.cell.index==this.grid.layout.cellCount-1){var e=new k(this.grid.rowCount-1,this.grid);return e=e.lastChild(!0),this.rowIndex==e._str}return!1},next:function(){if(this.cell){var e=(this.rowIndex,this.cell.index+1),t=this.grid.layout.cellCount-1,i=new k(this.rowIndex,this.grid);if(e>t){var a=i.next();a?(e=0,i=a):e--}if(this.grid.edit.isEditing()){var r=this.grid.getCell(e);if(!this.isLastFocusCell()&&!r.editable)return this._focusifyCellNode(!1),this.cell=r,this.rowIndex=i._str,void this.next()}this.setFocusIndex(i._str,e)}},previous:function(){if(this.cell){var e=this.rowIndex||0,t=(this.cell.index||0)-1,i=new k(e,this.grid);if(0>t){var a=i.previous();a?(t=this.grid.layout.cellCount-1,i=a):t=0}if(this.grid.edit.isEditing()){var r=this.grid.getCell(t);if(!this.isFirstFocusCell()&&!r.editable)return this._focusifyCellNode(!1),this.cell=r,this.rowIndex=i._str,void this.previous()}this.setFocusIndex(i._str,t)}},move:function(e,t){if(this.isNavHeader())return void this.inherited(arguments);if(this.cell){var i=this.grid.scroller,a=this.rowIndex,r=(this.grid.rowCount-1,new k(this.rowIndex,this.grid));if(e){var o;e>0?(r=r.next(),o=r._arr[0],o>i.getLastPageRow(i.page)&&this.grid.setScrollTop(this.grid.scrollTop+i.findScrollTop(o)-i.findScrollTop(a))):0>e&&(r=r.previous(),o=r._arr[0],o<=i.getPageRow(i.page)&&this.grid.setScrollTop(this.grid.scrollTop-i.findScrollTop(a)-i.findScrollTop(o)))}for(var n=this.grid.layout.cellCount-1,s=this.cell.index,d=Math.min(n,Math.max(0,s+t)),l=this.grid.getCell(d),u=0>t?-1:1;d>=0&&n>d&&l&&l.hidden===!0;)d+=u,l=this.grid.getCell(d);l&&l.hidden!==!0||(d=s),e&&this.grid.updateRow(a),this.setFocusIndex(r._str,d)}}}),_=i("dojox.grid.TreeGrid",h,{defaultOpen:!0,sortChildItems:!1,openAtLevels:[],treeModel:null,expandoCell:0,aggregator:null,_layoutClass:b,createSelection:function(){this.selection=new p(this)},_childItemSorter:function(e,t,i,a){var r=this.store.getValue(e,i),o=this.store.getValue(t,i);return r!=o?o>r==a?1:-1:0},_onNew:function(e,t){if(t&&t.item){var i=this.getItemIndex(t.item);"string"==typeof i?this.updateRow(i.split("/")[0]):i>-1&&this.updateRow(i)}else this.inherited(arguments)},_onSet:function(e,t,i,a){this._checkUpdateStatus(),this.aggregator&&this.aggregator.clearSubtotalCache();var r=this.getItemIndex(e);"string"==typeof r?this.updateRow(r.split("/")[0]):r>-1&&this.updateRow(r)},_onDelete:function(e){this._cleanupExpandoCache(this._getItemIndex(e,!0),this.store.getIdentity(e),e),this.inherited(arguments)},_clearData:function(){this.inherited(arguments),this._by_idty_paths={}},_cleanupExpandoCache:function(e,t,i){},_addItem:function(e,t,i,r){!r&&this.model&&-1==a.indexOf(this.model.root.children,e)&&(this.model.root.children[t]=e),this.inherited(arguments)},getItem:function(e){var t=r.isArray(e);if(r.isString(e)&&e.indexOf("/")&&(e=e.split("/"),t=!0),t&&1==e.length&&(e=e[0],t=!1),!t)return h.prototype.getItem.call(this,e);var i,a,o,n=this.store,s=h.prototype.getItem.call(this,e[0]);if(this.aggregator){if(i=this.aggregator.childFields||[])for(a=0;a<e.length-1&&s;a++)s=i[a]?(n.getValues(s,i[a])||[])[e[a+1]]:null}else if(this.treeModel&&(i=this.treeModel.childrenAttrs||[],i&&s))for(a=1,il=e.length;a<il&&s;a++)for(o=0,jl=i.length;o<jl&&!(s=i[o]?(n.getValues(s,i[o])||[])[e[a]]:null);o++);return s||null},_getItemIndex:function(e,t){if(!t&&!this.store.isItem(e))return-1;var i=this.inherited(arguments);if(-1==i){var a=this.store.getIdentity(e);return this._by_idty_paths[a]||-1}return i},postMixInProperties:function(){!this.treeModel||"defaultOpen"in this.params||(this.defaultOpen=!1);var e=this.defaultOpen;this.openAtLevels=a.map(this.openAtLevels,function(t){if("string"==typeof t)switch(t.toLowerCase()){case"true":return!0;case"false":return!1;default:var i=parseInt(t,10);return isNaN(i)?e:i}return t}),this._by_idty_paths={},this.inherited(arguments)},postCreate:function(){this.inherited(arguments),this.treeModel&&this._setModel(this.treeModel)},setModel:function(e){this._setModel(e),this._refresh(!0)},_setModel:function(e){if(e&&(!u||!(e instanceof u)))throw new Error("dojox.grid.TreeGrid: treeModel must be an instance of dijit.tree.ForestStoreModel");this.treeModel=e,s.toggle(this.domNode,"dojoxGridTreeModel",!!this.treeModel),this._setQuery(e?e.query:null),this._setStore(e?e.store:null)},createScroller:function(){this.inherited(arguments),this.scroller._origDefaultRowHeight=this.scroller.defaultRowHeight},createManagers:function(){this.rows=new f(this),this.focus=new M(this),this.edit=new g(this)},_setStore:function(e){this.inherited(arguments),this.treeModel&&!this.treeModel.root.children&&(this.treeModel.root.children=[]),this.aggregator&&(this.aggregator.store=e)},getDefaultOpenState:function(e,t){var i,a=this.store;if(this.treeModel)return this.defaultOpen;if(!(e&&a&&a.isItem(t)&&(i=this.aggregator.childFields[e.level])))return this.defaultOpen;if(this.openAtLevels.length>e.level){var r=this.openAtLevels[e.level];if("boolean"==typeof r)return r;if("number"==typeof r)return a.getValues(t,i).length<=r}return this.defaultOpen},onStyleRow:function(e){if(!this.layout._isCollapsable)return void this.inherited(arguments);var t=n.get(e.node,"dojoxTreeGridBaseClasses");t&&(e.customClasses=t);var i=e,a=i.node.tagName.toLowerCase();i.customClasses+=(i.odd?" dojoxGridRowOdd":"")+(i.selected&&"tr"==a?" dojoxGridRowSelected":"")+(i.over&&"tr"==a?" dojoxGridRowOver":""),this.focus.styleRow(i),this.edit.styleRow(i)},styleRowNode:function(e,t){t&&("div"==t.tagName.toLowerCase()&&this.aggregator&&d("tr[dojoxTreeGridPath]",t).forEach(function(e){this.rows.styleRowNode(n.get(e,"dojoxTreeGridPath"),e)},this),this.rows.styleRowNode(e,t))},onCanSelect:function(e){var t=d("tr[dojoxTreeGridPath='"+e+"']",this.domNode);return t.length&&s.contains(t[0],"dojoxGridSummaryRow")?!1:this.inherited(arguments)},onKeyDown:function(e){if(!e.altKey&&!e.metaKey)switch(e.keyCode){case l.UP_ARROW:this.edit.isEditing()||"0"==this.focus.rowIndex||(o.stop(e),this.focus.move(-1,0));break;case l.DOWN_ARROW:var t=new k(this.focus.rowIndex,this),i=new k(this.rowCount-1,this);i=i.lastChild(!0),this.edit.isEditing()||t.toString()==i.toString()||(o.stop(e),this.focus.move(1,0));break;default:this.inherited(arguments)}},canEdit:function(e,t){var i=e.getNode(t);return i&&this._canEdit},doApplyCellEdit:function(e,t,i){var a=this.getItem(t),r=this.store.getValue(a,i);if("number"==typeof r)e=isNaN(e)?e:parseFloat(e);else if("boolean"==typeof r)e="true"==e?!0:"false"==e?!1:e;else if(r instanceof Date){var o=new Date(e);e=isNaN(o.getTime())?e:o}this.store.setValue(a,i,e),this.onApplyCellEdit(e,t,i)}});return _.markupFactory=function(e,i,o,s){var l=function(e){var t=n.get(e,"width")||"auto";return"auto"!=t&&"em"!=t.slice(-2)&&"%"!=t.slice(-1)&&(t=parseInt(t,10)+"px"),t},u=function(e){var i;if("table"==e.nodeName.toLowerCase()&&0===d("> colgroup",e).length&&1==(i=d("> thead > tr",e)).length){i[0];return d("> th",i[0]).map(function(e){var i={type:r.trim(n.get(e,"cellType")||""),field:r.trim(n.get(e,"field")||"")};i.type&&(i.type=r.getObject(i.type));var o=d("> table",e)[0];return o?(i.name="",i.children=u(o),n.has(e,"itemAggregates")?i.itemAggregates=a.map(n.get(e,"itemAggregates").split(","),function(e){return r.trim(e)}):i.itemAggregates=[],n.has(e,"aggregate")&&(i.aggregate=n.get(e,"aggregate")),i.type=i.type||t.grid.cells.SubtableCell):(i.name=r.trim(n.get(e,"name")||e.innerHTML),n.has(e,"width")&&(i.width=l(e)),n.has(e,"relWidth")&&(i.relWidth=window.parseInt(n.get(e,"relWidth"),10)),n.has(e,"hidden")&&(i.hidden="true"==n.get(e,"hidden")),i.field=i.field||i.name,h.cell_markupFactory(s,e,i),i.type=i.type||t.grid.cells.Cell),i.type&&i.type.markupFactory&&i.type.markupFactory(e,i),i})}return[]};if(!e.structure){var m=u(i);m.length&&(e.structure=[{__span:1/0,cells:[m]}])}return h.markupFactory(e,i,o,s)},_});//# sourceMappingURL=TreeGrid.js.map