//>>built
define("dojox/grid/TreeGrid",["dojo/_base/kernel","../main","dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/event","dojo/dom-attr","dojo/dom-class","dojo/query","dojo/keys","dijit/tree/ForestStoreModel","./DataGrid","./_Layout","./_FocusManager","./_RowManager","./_EditManager","./TreeSelection","./cells/tree","./_TreeView"],function(e,t,i,a,n,r,o,s,l,d,u,c,m,h,f,p,g,v){e.experimental("dojox.grid.TreeGrid");var y=i("dojox.grid._TreeAggregator",null,{cells:[],grid:null,childFields:[],constructor:function(e){this.cells=e.cells||[],this.childFields=e.childFields||[],this.grid=e.grid,this.store=this.grid.store},_cacheValue:function(e,t,i){return e[t]=i,i},clearSubtotalCache:function(){this.store&&delete this.store._cachedAggregates},cnt:function(e,t,i){var n=0,r=this.store,o=this.childFields;if(o[t]){var s=r.getValues(i,o[t]);e.index<=t+1?n=s.length:a.forEach(s,function(i){n+=this.getForCell(e,t+1,i,"cnt")},this)}else n=1;return n},sum:function(e,t,i){var n=0,r=this.store,o=this.childFields;return o[t]?a.forEach(r.getValues(i,o[t]),function(i){n+=this.getForCell(e,t+1,i,"sum")},this):n+=r.getValue(i,e.field),n},value:function(e,t,i){},getForCell:function(e,t,i,a){var n=this.store;if(!n||!i||!n.isItem(i))return"";var r=n._cachedAggregates=n._cachedAggregates||{},o=n.getIdentity(i),s=r[o]=r[o]||[];e.getOpenState||(e=this.grid.getCell(e.layoutIndex+t+1));var l=e.index,d=s[l]=s[l]||{};a=a||(e.parentCell?e.parentCell.aggregate:"sum")||"sum";var u=e.field;u==n.getLabelAttributes()[0]&&(a="cnt");var c=d[a]=d[a]||[];if(void 0!=c[t])return c[t];var m=(e.parentCell&&e.parentCell.itemAggregates?e.parentCell.itemAggregates[e.idxInParent]:"")||"";return m&&n.hasAttribute(i,m)?this._cacheValue(c,t,n.getValue(i,m)):m?this._cacheValue(c,t,0):this._cacheValue(c,t,this[a](e,t,i))}}),b=i("dojox.grid._TreeLayout",m,{_isCollapsable:!1,_getInternalStructure:function(e){var t=this.grid,i=e,r=i[0].cells[0],o={type:"dojox.grid._TreeView",cells:[[]]},s=[],l=0,d=function(e,t){var i=e.children,r=function(i,a){var r,o={};for(r in i)o[r]=i[r];return o=n.mixin(o,{level:t,idxInParent:t>0?a:-1,parentCell:t>0?e:null})},o=[];return a.forEach(i,function(e,i){if("children"in e){s.push(e.field);var a=o[o.length-1];a.isCollapsable=!0,e.level=t,o=o.concat(d(e,t+1))}else o.push(r(e,i))}),l=Math.max(l,t),o},u={children:r,itemAggregates:[]};return o.cells[0]=d(u,0),t.aggregator=new y({cells:o.cells[0],grid:t,childFields:s}),t.scroller&&t.defaultOpen&&(t.scroller.defaultRowHeight=t.scroller._origDefaultRowHeight*(2*l+1)),[o]},setStructure:function(e){var t=e,i=this.grid;if(i&&i.treeModel&&!a.every(t,function(e){return"cells"in e})&&(t=arguments[0]=[{cells:[t]}]),1==t.length&&1==t[0].cells.length)if(i&&i.treeModel)t[0].type="dojox.grid._TreeView",this._isCollapsable=!0,t[0].cells[0][this.grid.treeModel?this.grid.expandoCell:0].isCollapsable=!0;else{var n=a.filter(t[0].cells[0],function(e){return"children"in e});1===n.length&&(this._isCollapsable=!0)}!this._isCollapsable||i&&i.treeModel||(arguments[0]=this._getInternalStructure(t)),this.inherited(arguments)},addCellDef:function(e,t,i){var a=this.inherited(arguments);return n.mixin(a,v)}}),k=i("dojox.grid.TreePath",null,{level:0,_str:"",_arr:null,grid:null,store:null,cell:null,item:null,constructor:function(e,t){n.isString(e)?(this._str=e,this._arr=a.map(e.split("/"),function(e){return parseInt(e,10)})):n.isArray(e)?(this._str=e.join("/"),this._arr=e.slice(0)):"number"==typeof e?(this._str=String(e),this._arr=[e]):(this._str=e._str,this._arr=e._arr.slice(0)),this.level=this._arr.length-1,this.grid=t,this.store=this.grid.store,t.treeModel?this.cell=t.layout.cells[t.expandoCell]:this.cell=t.layout.cells[this.level]},item:function(){return this._item||(this._item=this.grid.getItem(this._arr)),this._item},compare:function(e){if(n.isString(e)||n.isArray(e)){if(this._str==e)return 0;if(e.join&&this._str==e.join("/"))return 0;e=new k(e,this.grid)}else if(e instanceof k&&this._str==e._str)return 0;for(var t=0,i=this._arr.length<e._arr.length?this._arr.length:e._arr.length;i>t;t++){if(this._arr[t]<e._arr[t])return-1;if(this._arr[t]>e._arr[t])return 1}return this._arr.length<e._arr.length?-1:this._arr.length>e._arr.length?1:0},isOpen:function(){return this.cell.openStates&&this.cell.getOpenState(this.item())},previous:function(){var e=this._arr.slice(0);if("0"==this._str)return null;var t=e.length-1;if(0===e[t])return e.pop(),new k(e,this.grid);e[t]--;var i=new k(e,this.grid);return i.lastChild(!0)},next:function(){var e=this._arr.slice(0);if(this.isOpen())e.push(0);else{e[e.length-1]++;for(var t=this.level;t>=0;t--){var i=this.grid.getItem(e.slice(0,t+1));if(t>0)i||(e.pop(),e[t-1]++);else if(!i)return null}}return new k(e,this.grid)},children:function(e){if(!this.isOpen()&&!e)return null;var t=[],i=this.grid.treeModel;if(i){var n=this.item(),r=i.store;if(!i.mayHaveChildren(n))return null;a.forEach(i.childrenAttrs,function(e){t=t.concat(r.getValues(n,e))})}else if(t=this.store.getValues(this.item(),this.grid.layout.cells[this.cell.level+1].parentCell.field),t.length>1&&this.grid.sortChildItems){var o=this.grid.getSortProps();if(o&&o.length){var s=o[0].attribute,l=this.grid;if(s&&t[0][s]){var d=!!o[0].descending;t=t.slice(0),t.sort(function(e,t){return l._childItemSorter(e,t,s,d)})}}}return t},childPaths:function(){var e=this.children();return e?a.map(e,function(e,t){return new k(this._str+"/"+t,this.grid)},this):[]},parent:function(){return 0===this.level?null:new k(this._arr.slice(0,this.level),this.grid)},lastChild:function(e){var t=this.children();if(!t||!t.length)return this;var i=new k(this._str+"/"+String(t.length-1),this.grid);return e?i.lastChild(!0):i},toString:function(){return this._str}}),_=i("dojox.grid._TreeFocusManager",h,{setFocusCell:function(e,t){e&&e.getNode(t)&&this.inherited(arguments)},isLastFocusCell:function(){if(this.cell&&this.cell.index==this.grid.layout.cellCount-1){var e=new k(this.grid.rowCount-1,this.grid);return e=e.lastChild(!0),this.rowIndex==e._str}return!1},next:function(){if(this.cell){var e=(this.rowIndex,this.cell.index+1),t=this.grid.layout.cellCount-1,i=new k(this.rowIndex,this.grid);if(e>t){var a=i.next();a?(e=0,i=a):e--}if(this.grid.edit.isEditing()){var n=this.grid.getCell(e);if(!this.isLastFocusCell()&&!n.editable)return this._focusifyCellNode(!1),this.cell=n,this.rowIndex=i._str,void this.next()}this.setFocusIndex(i._str,e)}},previous:function(){if(this.cell){var e=this.rowIndex||0,t=(this.cell.index||0)-1,i=new k(e,this.grid);if(0>t){var a=i.previous();a?(t=this.grid.layout.cellCount-1,i=a):t=0}if(this.grid.edit.isEditing()){var n=this.grid.getCell(t);if(!this.isFirstFocusCell()&&!n.editable)return this._focusifyCellNode(!1),this.cell=n,this.rowIndex=i._str,void this.previous()}this.setFocusIndex(i._str,t)}},move:function(e,t){if(this.isNavHeader())return void this.inherited(arguments);if(this.cell){var i=this.grid.scroller,a=this.rowIndex,n=(this.grid.rowCount-1,new k(this.rowIndex,this.grid));if(e){var r;e>0?(n=n.next(),r=n._arr[0],r>i.getLastPageRow(i.page)&&this.grid.setScrollTop(this.grid.scrollTop+i.findScrollTop(r)-i.findScrollTop(a))):0>e&&(n=n.previous(),r=n._arr[0],r<=i.getPageRow(i.page)&&this.grid.setScrollTop(this.grid.scrollTop-i.findScrollTop(a)-i.findScrollTop(r)))}for(var o=this.grid.layout.cellCount-1,s=this.cell.index,l=Math.min(o,Math.max(0,s+t)),d=this.grid.getCell(l),u=0>t?-1:1;l>=0&&o>l&&d&&d.hidden===!0;)l+=u,d=this.grid.getCell(l);d&&d.hidden!==!0||(l=s),e&&this.grid.updateRow(a),this.setFocusIndex(n._str,l)}}}),M=i("dojox.grid.TreeGrid",c,{defaultOpen:!0,sortChildItems:!1,openAtLevels:[],treeModel:null,expandoCell:0,aggregator:null,_layoutClass:b,createSelection:function(){this.selection=new g(this)},_childItemSorter:function(e,t,i,a){var n=this.store.getValue(e,i),r=this.store.getValue(t,i);return n!=r?r>n==a?1:-1:0},_onNew:function(e,t){if(t&&t.item){var i=this.getItemIndex(t.item);"string"==typeof i?this.updateRow(i.split("/")[0]):i>-1&&this.updateRow(i)}else this.inherited(arguments)},_onSet:function(e,t,i,a){this._checkUpdateStatus(),this.aggregator&&this.aggregator.clearSubtotalCache();var n=this.getItemIndex(e);"string"==typeof n?this.updateRow(n.split("/")[0]):n>-1&&this.updateRow(n)},_onDelete:function(e){this._cleanupExpandoCache(this._getItemIndex(e,!0),this.store.getIdentity(e),e),this.inherited(arguments)},_clearData:function(){this.inherited(arguments),this._by_idty_paths={}},_cleanupExpandoCache:function(e,t,i){},_addItem:function(e,t,i,n){!n&&this.model&&-1==a.indexOf(this.model.root.children,e)&&(this.model.root.children[t]=e),this.inherited(arguments)},getItem:function(e){var t=n.isArray(e);if(n.isString(e)&&e.indexOf("/")&&(e=e.split("/"),t=!0),t&&1==e.length&&(e=e[0],t=!1),!t)return c.prototype.getItem.call(this,e);var i,a,r,o=this.store,s=c.prototype.getItem.call(this,e[0]);if(this.aggregator){if(i=this.aggregator.childFields||[])for(a=0;a<e.length-1&&s;a++)s=i[a]?(o.getValues(s,i[a])||[])[e[a+1]]:null}else if(this.treeModel&&(i=this.treeModel.childrenAttrs||[],i&&s))for(a=1,il=e.length;a<il&&s;a++)for(r=0,jl=i.length;r<jl&&!(s=i[r]?(o.getValues(s,i[r])||[])[e[a]]:null);r++);return s||null},_getItemIndex:function(e,t){if(!t&&!this.store.isItem(e))return-1;var i=this.inherited(arguments);if(-1==i){var a=this.store.getIdentity(e);return this._by_idty_paths[a]||-1}return i},postMixInProperties:function(){!this.treeModel||"defaultOpen"in this.params||(this.defaultOpen=!1);var e=this.defaultOpen;this.openAtLevels=a.map(this.openAtLevels,function(t){if("string"==typeof t)switch(t.toLowerCase()){case"true":return!0;case"false":return!1;default:var i=parseInt(t,10);return isNaN(i)?e:i}return t}),this._by_idty_paths={},this.inherited(arguments)},postCreate:function(){this.inherited(arguments),this.treeModel&&this._setModel(this.treeModel)},setModel:function(e){this._setModel(e),this._refresh(!0)},_setModel:function(e){if(e&&(!u||!(e instanceof u)))throw new Error("dojox.grid.TreeGrid: treeModel must be an instance of dijit.tree.ForestStoreModel");this.treeModel=e,s.toggle(this.domNode,"dojoxGridTreeModel",!!this.treeModel),this._setQuery(e?e.query:null),this._setStore(e?e.store:null)},createScroller:function(){this.inherited(arguments),this.scroller._origDefaultRowHeight=this.scroller.defaultRowHeight},createManagers:function(){this.rows=new f(this),this.focus=new _(this),this.edit=new p(this)},_setStore:function(e){this.inherited(arguments),this.treeModel&&!this.treeModel.root.children&&(this.treeModel.root.children=[]),this.aggregator&&(this.aggregator.store=e)},getDefaultOpenState:function(e,t){var i,a=this.store;if(this.treeModel)return this.defaultOpen;if(!(e&&a&&a.isItem(t)&&(i=this.aggregator.childFields[e.level])))return this.defaultOpen;if(this.openAtLevels.length>e.level){var n=this.openAtLevels[e.level];if("boolean"==typeof n)return n;if("number"==typeof n)return a.getValues(t,i).length<=n}return this.defaultOpen},onStyleRow:function(e){if(!this.layout._isCollapsable)return void this.inherited(arguments);var t=o.get(e.node,"dojoxTreeGridBaseClasses");t&&(e.customClasses=t);var i=e,a=i.node.tagName.toLowerCase();i.customClasses+=(i.odd?" dojoxGridRowOdd":"")+(i.selected&&"tr"==a?" dojoxGridRowSelected":"")+(i.over&&"tr"==a?" dojoxGridRowOver":""),this.focus.styleRow(i),this.edit.styleRow(i)},styleRowNode:function(e,t){t&&("div"==t.tagName.toLowerCase()&&this.aggregator&&l("tr[dojoxTreeGridPath]",t).forEach(function(e){this.rows.styleRowNode(o.get(e,"dojoxTreeGridPath"),e)},this),this.rows.styleRowNode(e,t))},onCanSelect:function(e){var t=l("tr[dojoxTreeGridPath='"+e+"']",this.domNode);return t.length&&s.contains(t[0],"dojoxGridSummaryRow")?!1:this.inherited(arguments)},onKeyDown:function(e){if(!e.altKey&&!e.metaKey)switch(e.keyCode){case d.UP_ARROW:this.edit.isEditing()||"0"==this.focus.rowIndex||(r.stop(e),this.focus.move(-1,0));break;case d.DOWN_ARROW:var t=new k(this.focus.rowIndex,this),i=new k(this.rowCount-1,this);i=i.lastChild(!0),this.edit.isEditing()||t.toString()==i.toString()||(r.stop(e),this.focus.move(1,0));break;default:this.inherited(arguments)}},canEdit:function(e,t){var i=e.getNode(t);return i&&this._canEdit},doApplyCellEdit:function(e,t,i){var a=this.getItem(t),n=this.store.getValue(a,i);if("number"==typeof n)e=isNaN(e)?e:parseFloat(e);else if("boolean"==typeof n)e="true"==e?!0:"false"==e?!1:e;else if(n instanceof Date){var r=new Date(e);e=isNaN(r.getTime())?e:r}this.store.setValue(a,i,e),this.onApplyCellEdit(e,t,i)}});return M.markupFactory=function(e,i,r,s){var d=function(e){var t=o.get(e,"width")||"auto";return"auto"!=t&&"em"!=t.slice(-2)&&"%"!=t.slice(-1)&&(t=parseInt(t,10)+"px"),t},u=function(e){var i;if("table"==e.nodeName.toLowerCase()&&0===l("> colgroup",e).length&&1==(i=l("> thead > tr",e)).length){i[0];return l("> th",i[0]).map(function(e){var i={type:n.trim(o.get(e,"cellType")||""),field:n.trim(o.get(e,"field")||"")};i.type&&(i.type=n.getObject(i.type));var r=l("> table",e)[0];return r?(i.name="",i.children=u(r),o.has(e,"itemAggregates")?i.itemAggregates=a.map(o.get(e,"itemAggregates").split(","),function(e){return n.trim(e)}):i.itemAggregates=[],o.has(e,"aggregate")&&(i.aggregate=o.get(e,"aggregate")),i.type=i.type||t.grid.cells.SubtableCell):(i.name=n.trim(o.get(e,"name")||e.innerHTML),o.has(e,"width")&&(i.width=d(e)),o.has(e,"relWidth")&&(i.relWidth=window.parseInt(o.get(e,"relWidth"),10)),o.has(e,"hidden")&&(i.hidden="true"==o.get(e,"hidden")),i.field=i.field||i.name,c.cell_markupFactory(s,e,i),i.type=i.type||t.grid.cells.Cell),i.type&&i.type.markupFactory&&i.type.markupFactory(e,i),i})}return[]};if(!e.structure){var m=u(i);m.length&&(e.structure=[{__span:1/0,cells:[m]}])}return c.markupFactory(e,i,r,s)},M});//# sourceMappingURL=TreeGrid.js.map