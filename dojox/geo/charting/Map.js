//>>built
define("dojox/geo/charting/Map",["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","dojo/_base/html","dojo/dom","dojo/dom-geometry","dojo/dom-class","dojo/_base/xhr","dojo/_base/connect","dojo/_base/window","dojox/gfx","./_base","./Feature","./_Marker","dojo/number","dojo/_base/sniff"],function(e,t,a,i,r,o,n,s,l,d,u,m,h,c,f,p){return a("dojox.geo.charting.Map",null,{defaultColor:"#B7B7B7",highlightColor:"#D5D5D5",series:[],dataBindingAttribute:null,dataBindingValueFunction:null,dataStore:null,showTooltips:!0,enableFeatureZoom:!0,colorAnimationDuration:0,_idAttributes:null,_onSetListener:null,_onNewListener:null,_onDeleteListener:null,constructor:function(t,a){i.style(t,"display","block"),this.container=t;var r=this._getContainerBounds();this.surface=u.createSurface(t,r.w,r.h),this._createZoomingCursor(),this.mapBackground=this.surface.createRect({x:0,y:0,width:r.w,height:r.w}).setFill("rgba(0,0,0,0)"),this.mapObj=this.surface.createGroup(),this.mapObj.features={},"object"==typeof a?this._init(a):"string"==typeof a&&a.length>0&&s.get({url:a,handleAs:"json",sync:!0,load:e.hitch(this,"_init")})},_getContainerBounds:function(){var e=o.position(this.container,!0),t=(o.getMarginBox(this.container),o.getContentBox(this.container));return this._storedContainerBounds={x:e.x,y:e.y,w:t.w||100,h:t.h||100},this._storedContainerBounds},resize:function(e,t,a){var i=this._storedContainerBounds,r=this._getContainerBounds();if((i.w!=r.w||i.h!=r.h)&&(this.mapBackground.setShape({width:r.w,height:r.h}),this.surface.setDimensions(r.w,r.h),this.mapObj.marker.hide(),this.mapObj.marker._needTooltipRefresh=!0,e)){var o=this.getMapScale(),n=o;if(t){var s=(this.mapObj.boundBox,r.w/i.w),l=r.h/i.h;n=o*Math.sqrt(s*l)}var d=this.screenCoordsToMapCoords(i.w/2,i.h/2);this.setMapCenterAndScale(d.x,d.y,n,a)}},_isMobileDevice:function(){return p("safari")&&(navigator.userAgent.indexOf("iPhone")>-1||navigator.userAgent.indexOf("iPod")>-1||navigator.userAgent.indexOf("iPad")>-1)||navigator.userAgent.toLowerCase().indexOf("android")>-1},setMarkerData:function(t){s.get({url:t,handleAs:"json",handle:e.hitch(this,"_appendMarker")})},setDataBindingAttribute:function(e){this.dataBindingAttribute=e,this.dataStore&&this._queryDataStore()},setDataBindingValueFunction:function(e){this.dataBindingValueFunction=e,this.dataStore&&this._queryDataStore()},_queryDataStore:function(){if(this.dataBindingAttribute&&0!=this.dataBindingAttribute.length){var e=this;this.dataStore.fetch({scope:this,onComplete:function(a){this._idAttributes=e.dataStore.getIdentityAttributes({}),t.forEach(a,function(t){var a=e.dataStore.getValue(t,this._idAttributes[0]);if(e.mapObj.features[a]){var i=null,r=e.dataStore.getValue(t,e.dataBindingAttribute);r&&(i=this.dataBindingValueFunction?this.dataBindingValueFunction(r):isNaN(i)?f.parse(r):r),i&&e.mapObj.features[a].setValue(i)}},this)}})}},_onSet:function(e,t,a,i){var r=this.dataStore.getValue(e,this._idAttributes[0]),o=this.mapObj.features[r];o&&t==this.dataBindingAttribute&&(i?o.setValue(i):o.unsetValue())},_onNew:function(e,t){var a=this.dataStore.getValue(item,this._idAttributes[0]),i=this.mapObj.features[a];i&&attribute==this.dataBindingAttribute&&i.setValue(newValue)},_onDelete:function(e){var t=e[this._idAttributes[0]],a=this.mapObj.features[t];a&&a.unsetValue()},setDataStore:function(e,t){this.dataStore!=e&&(this._onSetListener&&(l.disconnect(this._onSetListener),l.disconnect(this._onNewListener),l.disconnect(this._onDeleteListener)),this.dataStore=e,e&&(_onSetListener=l.connect(this.dataStore,"onSet",this,this._onSet),_onNewListener=l.connect(this.dataStore,"onNew",this,this._onNew),_onDeleteListener=l.connect(this.dataStore,"onDelete",this,this._onDelete))),t&&this.setDataBindingAttribute(t)},addSeries:function(t){"object"==typeof t?this._addSeriesImpl(t):"string"==typeof t&&t.length>0&&s.get({url:t,handleAs:"json",sync:!0,load:e.hitch(this,function(e){this._addSeriesImpl(e.series)})})},_addSeriesImpl:function(e){this.series=e;for(var t in this.mapObj.features){var a=this.mapObj.features[t];a.setValue(a.value)}},fitToMapArea:function(e,t,a,i){t||(t=0);var r=e.w,o=e.h,n=this._getContainerBounds(),s=Math.min((n.w-2*t)/r,(n.h-2*t)/o);this.setMapCenterAndScale(e.x+e.w/2,e.y+e.h/2,s,a,i)},fitToMapContents:function(e,t,a){var i=this.mapObj.boundBox;this.fitToMapArea(i,e,t,a)},setMapCenter:function(e,t,a,i){var r=this.getMapScale();this.setMapCenterAndScale(e,t,r,a,i)},_createAnimation:function(e,t,a,i){var r=t.dx?t.dx:0,o=t.dy?t.dy:0,n=a.dx?a.dx:0,s=a.dy?a.dy:0,d=t.xx?t.xx:1,m=a.xx?a.xx:1,h=u.fx.animateTransform({duration:1e3,shape:e,transform:[{name:"translate",start:[r,o],end:[n,s]},{name:"scale",start:[d],end:[m]}]});if(i)var c=l.connect(h,"onEnd",this,function(e){i(e),l.disconnect(c)});return h},setMapCenterAndScale:function(e,t,a,i,r){var o=this.mapObj.boundBox,n=this._getContainerBounds(),s=n.w/2-a*(e-o.x),l=n.h/2-a*(t-o.y),d=new u.matrix.Matrix2D({xx:a,yy:a,dx:s,dy:l}),m=this.mapObj.getTransform();if(i&&m){var h=this._createAnimation(this.mapObj,m,d,r);h.play()}else this.mapObj.setTransform(d)},getMapCenter:function(){var e=this._getContainerBounds();return this.screenCoordsToMapCoords(e.w/2,e.h/2)},setMapScale:function(e,t,a){var i=this._getContainerBounds(),r=this.screenCoordsToMapCoords(i.w/2,i.h/2);this.setMapScaleAt(e,r.x,r.y,t,a)},setMapScaleAt:function(e,t,a,i,r){var o=null,n=null;o={x:t,y:a},n=this.mapCoordsToScreenCoords(o.x,o.y);var s=this.mapObj.boundBox,l=n.x-e*(o.x-s.x),d=n.y-e*(o.y-s.y),m=new u.matrix.Matrix2D({xx:e,yy:e,dx:l,dy:d}),h=this.mapObj.getTransform();if(i&&h){var c=this._createAnimation(this.mapObj,h,m,r);c.play()}else this.mapObj.setTransform(m)},getMapScale:function(){var e=this.mapObj.getTransform(),t=e?e.xx:1;return t},mapCoordsToScreenCoords:function(e,t){var a=this.mapObj.getTransform(),i=u.matrix.multiplyPoint(a,e,t);return i},screenCoordsToMapCoords:function(e,t){var a=u.matrix.invert(this.mapObj.getTransform()),i=u.matrix.multiplyPoint(a,e,t);return i},deselectAll:function(){for(var e in this.mapObj.features)this.mapObj.features[e].select(!1);this.selectedFeature=null,this.focused=!1},_init:function(e){this.mapObj.boundBox={x:e.layerExtent[0],y:e.layerExtent[1],w:e.layerExtent[2]-e.layerExtent[0],h:e.layerExtent[3]-e.layerExtent[1]},this.fitToMapContents(3),t.forEach(e.featureNames,function(t){var a=e.features[t];a.bbox.x=a.bbox[0],a.bbox.y=a.bbox[1],a.bbox.w=a.bbox[2],a.bbox.h=a.bbox[3];var i=new h(this,t,a);i.init(),this.mapObj.features[t]=i},this),this.mapObj.marker=new c({},this)},_appendMarker:function(e){this.mapObj.marker=new c(e,this)},_createZoomingCursor:function(){if(!r.byId("mapZoomCursor")){var e=d.doc.createElement("div");i.attr(e,"id","mapZoomCursor"),n.add(e,"mapZoomIn"),i.style(e,"display","none"),d.body().appendChild(e)}},onFeatureClick:function(e){},onFeatureOver:function(e){},onZoomEnd:function(e){}})});//# sourceMappingURL=Map.js.map