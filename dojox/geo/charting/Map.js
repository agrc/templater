//>>built
define("dojox/geo/charting/Map",["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","dojo/_base/html","dojo/dom","dojo/dom-geometry","dojo/dom-class","dojo/_base/xhr","dojo/_base/connect","dojo/_base/window","dojox/gfx","./_base","./Feature","./_Marker","dojo/number","dojo/_base/sniff"],function(e,t,i,a,o,r,n,s,l,d,h,u,c,m,f,p){return i("dojox.geo.charting.Map",null,{defaultColor:"#B7B7B7",highlightColor:"#D5D5D5",series:[],dataBindingAttribute:null,dataBindingValueFunction:null,dataStore:null,showTooltips:!0,enableFeatureZoom:!0,colorAnimationDuration:0,_idAttributes:null,_onSetListener:null,_onNewListener:null,_onDeleteListener:null,constructor:function(t,i){a.style(t,"display","block"),this.container=t;var o=this._getContainerBounds();this.surface=h.createSurface(t,o.w,o.h),this._createZoomingCursor(),this.mapBackground=this.surface.createRect({x:0,y:0,width:o.w,height:o.w}).setFill("rgba(0,0,0,0)"),this.mapObj=this.surface.createGroup(),this.mapObj.features={},"object"==typeof i?this._init(i):"string"==typeof i&&i.length>0&&s.get({url:i,handleAs:"json",sync:!0,load:e.hitch(this,"_init")})},_getContainerBounds:function(){var e=r.position(this.container,!0),t=(r.getMarginBox(this.container),r.getContentBox(this.container));return this._storedContainerBounds={x:e.x,y:e.y,w:t.w||100,h:t.h||100},this._storedContainerBounds},resize:function(e,t,i){var a=this._storedContainerBounds,o=this._getContainerBounds();if((a.w!=o.w||a.h!=o.h)&&(this.mapBackground.setShape({width:o.w,height:o.h}),this.surface.setDimensions(o.w,o.h),this.mapObj.marker.hide(),this.mapObj.marker._needTooltipRefresh=!0,e)){var r=this.getMapScale(),n=r;if(t){var s=(this.mapObj.boundBox,o.w/a.w),l=o.h/a.h;n=r*Math.sqrt(s*l)}var d=this.screenCoordsToMapCoords(a.w/2,a.h/2);this.setMapCenterAndScale(d.x,d.y,n,i)}},_isMobileDevice:function(){return p("safari")&&(navigator.userAgent.indexOf("iPhone")>-1||navigator.userAgent.indexOf("iPod")>-1||navigator.userAgent.indexOf("iPad")>-1)||navigator.userAgent.toLowerCase().indexOf("android")>-1},setMarkerData:function(t){s.get({url:t,handleAs:"json",handle:e.hitch(this,"_appendMarker")})},setDataBindingAttribute:function(e){this.dataBindingAttribute=e,this.dataStore&&this._queryDataStore()},setDataBindingValueFunction:function(e){this.dataBindingValueFunction=e,this.dataStore&&this._queryDataStore()},_queryDataStore:function(){if(this.dataBindingAttribute&&0!=this.dataBindingAttribute.length){var e=this;this.dataStore.fetch({scope:this,onComplete:function(i){this._idAttributes=e.dataStore.getIdentityAttributes({}),t.forEach(i,function(t){var i=e.dataStore.getValue(t,this._idAttributes[0]);if(e.mapObj.features[i]){var a=null,o=e.dataStore.getValue(t,e.dataBindingAttribute);o&&(a=this.dataBindingValueFunction?this.dataBindingValueFunction(o):isNaN(a)?f.parse(o):o),a&&e.mapObj.features[i].setValue(a)}},this)}})}},_onSet:function(e,t,i,a){var o=this.dataStore.getValue(e,this._idAttributes[0]),r=this.mapObj.features[o];r&&t==this.dataBindingAttribute&&(a?r.setValue(a):r.unsetValue())},_onNew:function(e,t){var i=this.dataStore.getValue(item,this._idAttributes[0]),a=this.mapObj.features[i];a&&attribute==this.dataBindingAttribute&&a.setValue(newValue)},_onDelete:function(e){var t=e[this._idAttributes[0]],i=this.mapObj.features[t];i&&i.unsetValue()},setDataStore:function(e,t){this.dataStore!=e&&(this._onSetListener&&(l.disconnect(this._onSetListener),l.disconnect(this._onNewListener),l.disconnect(this._onDeleteListener)),this.dataStore=e,e&&(_onSetListener=l.connect(this.dataStore,"onSet",this,this._onSet),_onNewListener=l.connect(this.dataStore,"onNew",this,this._onNew),_onDeleteListener=l.connect(this.dataStore,"onDelete",this,this._onDelete))),t&&this.setDataBindingAttribute(t)},addSeries:function(t){"object"==typeof t?this._addSeriesImpl(t):"string"==typeof t&&t.length>0&&s.get({url:t,handleAs:"json",sync:!0,load:e.hitch(this,function(e){this._addSeriesImpl(e.series)})})},_addSeriesImpl:function(e){this.series=e;for(var t in this.mapObj.features){var i=this.mapObj.features[t];i.setValue(i.value)}},fitToMapArea:function(e,t,i,a){t||(t=0);var o=e.w,r=e.h,n=this._getContainerBounds(),s=Math.min((n.w-2*t)/o,(n.h-2*t)/r);this.setMapCenterAndScale(e.x+e.w/2,e.y+e.h/2,s,i,a)},fitToMapContents:function(e,t,i){var a=this.mapObj.boundBox;this.fitToMapArea(a,e,t,i)},setMapCenter:function(e,t,i,a){var o=this.getMapScale();this.setMapCenterAndScale(e,t,o,i,a)},_createAnimation:function(e,t,i,a){var o=t.dx?t.dx:0,r=t.dy?t.dy:0,n=i.dx?i.dx:0,s=i.dy?i.dy:0,d=t.xx?t.xx:1,u=i.xx?i.xx:1,c=h.fx.animateTransform({duration:1e3,shape:e,transform:[{name:"translate",start:[o,r],end:[n,s]},{name:"scale",start:[d],end:[u]}]});if(a)var m=l.connect(c,"onEnd",this,function(e){a(e),l.disconnect(m)});return c},setMapCenterAndScale:function(e,t,i,a,o){var r=this.mapObj.boundBox,n=this._getContainerBounds(),s=n.w/2-i*(e-r.x),l=n.h/2-i*(t-r.y),d=new h.matrix.Matrix2D({xx:i,yy:i,dx:s,dy:l}),u=this.mapObj.getTransform();if(a&&u){var c=this._createAnimation(this.mapObj,u,d,o);c.play()}else this.mapObj.setTransform(d)},getMapCenter:function(){var e=this._getContainerBounds();return this.screenCoordsToMapCoords(e.w/2,e.h/2)},setMapScale:function(e,t,i){var a=this._getContainerBounds(),o=this.screenCoordsToMapCoords(a.w/2,a.h/2);this.setMapScaleAt(e,o.x,o.y,t,i)},setMapScaleAt:function(e,t,i,a,o){var r=null,n=null;r={x:t,y:i},n=this.mapCoordsToScreenCoords(r.x,r.y);var s=this.mapObj.boundBox,l=n.x-e*(r.x-s.x),d=n.y-e*(r.y-s.y),u=new h.matrix.Matrix2D({xx:e,yy:e,dx:l,dy:d}),c=this.mapObj.getTransform();if(a&&c){var m=this._createAnimation(this.mapObj,c,u,o);m.play()}else this.mapObj.setTransform(u)},getMapScale:function(){var e=this.mapObj.getTransform(),t=e?e.xx:1;return t},mapCoordsToScreenCoords:function(e,t){var i=this.mapObj.getTransform(),a=h.matrix.multiplyPoint(i,e,t);return a},screenCoordsToMapCoords:function(e,t){var i=h.matrix.invert(this.mapObj.getTransform()),a=h.matrix.multiplyPoint(i,e,t);return a},deselectAll:function(){for(var e in this.mapObj.features)this.mapObj.features[e].select(!1);this.selectedFeature=null,this.focused=!1},_init:function(e){this.mapObj.boundBox={x:e.layerExtent[0],y:e.layerExtent[1],w:e.layerExtent[2]-e.layerExtent[0],h:e.layerExtent[3]-e.layerExtent[1]},this.fitToMapContents(3),t.forEach(e.featureNames,function(t){var i=e.features[t];i.bbox.x=i.bbox[0],i.bbox.y=i.bbox[1],i.bbox.w=i.bbox[2],i.bbox.h=i.bbox[3];var a=new c(this,t,i);a.init(),this.mapObj.features[t]=a},this),this.mapObj.marker=new m({},this)},_appendMarker:function(e){this.mapObj.marker=new m(e,this)},_createZoomingCursor:function(){if(!o.byId("mapZoomCursor")){var e=d.doc.createElement("div");a.attr(e,"id","mapZoomCursor"),n.add(e,"mapZoomIn"),a.style(e,"display","none"),d.body().appendChild(e)}},onFeatureClick:function(e){},onFeatureOver:function(e){},onZoomEnd:function(e){}})});//# sourceMappingURL=Map.js.map