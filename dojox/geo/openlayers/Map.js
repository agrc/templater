//>>built
define("dojox/geo/openlayers/Map",["dojo/_base/kernel","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/dom","dojo/dom-style","./_base","./TouchInteractionSupport","./Layer","./Patch"],function(e,t,i,a,o,r,n,s,l,d,u){return e.experimental("dojox.geo.openlayers.Map"),u.patchGFX(),t("dojox.geo.openlayers.Map",null,{olMap:null,_tp:null,constructor:function(e,t){t||(t={}),e=r.byId(e),this._tp={x:0,y:0};var i=t.openLayersMapOptions;if(i||(i={controls:[new OpenLayers.Control.ScaleLine({maxWidth:200}),new OpenLayers.Control.Navigation]}),t.accessible){var a=new OpenLayers.Control.KeyboardDefaults;i.controls||(i.controls=[]),i.controls.push(a)}var o=t.baseLayerType;o||(o=s.BaseLayerType.OSM);var n=new OpenLayers.Map(e,i);this.olMap=n,this._layerDictionary={olLayers:[],layers:[]},t.touchHandler&&(this._touchControl=new l(n));var d=this._createBaseLayer(t);this.addLayer(d),this.initialFit(t)},initialFit:function(e){var t=e.initialLocation;t||(t=[-160,70,160,-70]),this.fitTo(t)},setBaseLayerType:function(e){if(e==this.baseLayerType)return null;var t=null;"string"==typeof e?(t={baseLayerName:e,baseLayerType:e},this.baseLayerType=e):"object"==typeof e&&(t=e,this.baseLayerType=t.baseLayerType);var i=null;if(null!=t&&(i=this._createBaseLayer(t),null!=i)){var a=this.olMap,o=a.getZoom(),r=a.getCenter(),n=!!r&&!!a.baseLayer&&!!a.baseLayer.map;if(n){var l=a.getProjectionObject();null!=l&&(r=r.transform(l,s.EPSG4326))}var d=a.baseLayer;if(null!=d){var u=this._getLayer(d);this.removeLayer(u)}null!=i&&this.addLayer(i),n&&(l=a.getProjectionObject(),null!=l&&(r=r.transform(s.EPSG4326,l)),a.setCenter(r,o))}return i},getBaseLayerType:function(){return this.baseLayerType},getScale:function(e){var t=null,i=this.olMap;if(e){var a=i.getUnits();if(!a)return null;var o=OpenLayers.INCHES_PER_UNIT;t=(i.getGeodesicPixelSize().w||1e-6)*o.km*OpenLayers.DOTS_PER_INCH}else t=i.getScale();return t},getOLMap:function(){return this.olMap},_createBaseLayer:function(e){var t=null,i=e.baseLayerType,a=e.baseLayerUrl,o=e.baseLayerName,r=e.baseLayerOptions;switch(o||(o=i),r||(r={}),i){case s.BaseLayerType.OSM:r.transitionEffect="resize",t=new d(o,{olLayer:new OpenLayers.Layer.OSM(o,a,r)});break;case s.BaseLayerType.Transport:r.transitionEffect="resize",t=new d(o,{olLayer:new OpenLayers.Layer.OSM.TransportMap(o,a,r)});break;case s.BaseLayerType.WMS:a||(a="http://labs.metacarta.com/wms/vmap0",r.layers||(r.layers="basic")),t=new d(o,{olLayer:new OpenLayers.Layer.WMS(o,a,r,{transitionEffect:"resize"})});break;case s.BaseLayerType.GOOGLE:t=new d(o,{olLayer:new OpenLayers.Layer.Google(o,r)});break;case s.BaseLayerType.VIRTUAL_EARTH:t=new d(o,{olLayer:new OpenLayers.Layer.VirtualEarth(o,r)});break;case s.BaseLayerType.YAHOO:t=new d(o,{olLayer:new OpenLayers.Layer.Yahoo(o,r)});break;case s.BaseLayerType.ARCGIS:a||(a="http://server.arcgisonline.com/ArcGIS/rest/services/ESRI_StreetMap_World_2D/MapServer/export"),t=new d(o,{olLayer:new OpenLayers.Layer.ArcGIS93Rest(o,a,r,{})})}return null==t&&(i instanceof OpenLayers.Layer?t=i:(r.transitionEffect="resize",t=new d(o,{olLayer:new OpenLayers.Layer.OSM(o,a,r)}),this.baseLayerType=s.BaseLayerType.OSM)),t},removeLayer:function(e){var t=this.olMap,i=a.indexOf(this._layerDictionary.layers,e);i>0&&this._layerDictionary.layers.splice(i,1);var o=e.olLayer,r=a.indexOf(this._layerDictionary.olLayers,o);r>0&&this._layerDictionary.olLayers.splice(i,r),t.removeLayer(o,!1)},layerIndex:function(e,t){var i=this.olMap;return t?(i.setLayerIndex(e.olLayer,t),this._layerDictionary.layers.sort(function(e,t){return i.getLayerIndex(e.olLayer)-i.getLayerIndex(t.olLayer)}),this._layerDictionary.olLayers.sort(function(e,t){return i.getLayerIndex(e)-i.getLayerIndex(t)}),t):i.getLayerIndex(e.olLayer)},addLayer:function(e){e.dojoMap=this;var t=this.olMap,i=e.olLayer;this._layerDictionary.olLayers.push(i),this._layerDictionary.layers.push(e),t.addLayer(i),e.added()},_getLayer:function(e){var t=a.indexOf(this._layerDictionary.olLayers,e);return-1!=t?this._layerDictionary.layers[t]:null},getLayer:function(e,t){var i=this.olMap,o=i.getBy("layers",e,t),r=new Array;return a.forEach(o,function(e){r.push(this._getLayer(e))},this),r},getLayerCount:function(){var e=this.olMap;return null==e.layers?0:e.layers.length},fitTo:function(e){var t=this.olMap,i=s.EPSG4326;if(null==e){var a=this.transformXY(0,0,i);return void t.setCenter(new OpenLayers.LonLat(a.x,a.y))}var r=null;if("string"==typeof e)var n=o.fromJson(e);else n=e;var l,d;if(n.hasOwnProperty("bounds")){var u=n.bounds;r=new OpenLayers.Bounds,l=this.transformXY(u[0],u[1],i),r.left=l.x,r.top=l.y,d=this.transformXY(u[2],u[3],i),r.right=d.x,r.bottom=d.y}if(null==r&&n.hasOwnProperty("position")){var h=n.position,m=n.hasOwnProperty("extent")?n.extent:1;"string"==typeof m&&(m=parseFloat(m)),r=new OpenLayers.Bounds,l=this.transformXY(h[0]-m,h[1]+m,i),r.left=l.x,r.top=l.y,d=this.transformXY(h[0]+m,h[1]-m,i),r.right=d.x,r.bottom=d.y}null==r&&4==e.length&&(r=new OpenLayers.Bounds,l=this.transformXY(e[0],e[1],i),r.left=l.x,r.top=l.y,d=this.transformXY(e[2],e[3],i),r.right=d.x,r.bottom=d.y),null!=r&&t.zoomToExtent(r,!0)},transform:function(e,t,i){return this.transformXY(e.x,e.y,t,i)},transformXY:function(e,t,i,a){var o=this._tp;return o.x=e,o.y=t,i||(i=s.EPSG4326),a||(a=this.olMap.getProjectionObject()),o=OpenLayers.Projection.transform(o,i,a)}})});//# sourceMappingURL=Map.js.map