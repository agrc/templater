//>>built
define("dijit/_editor/plugins/ViewSource",["dojo/_base/array","dojo/aspect","dojo/_base/declare","dojo/dom-attr","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/i18n","dojo/keys","dojo/_base/lang","dojo/on","dojo/sniff","dojo/window","../../focus","../_Plugin","../../form/ToggleButton","../..","../../registry","dojo/i18n!../nls/commands"],function(e,t,i,o,r,n,s,a,d,l,c,u,h,f,p,g,m,_){var v=i("dijit._editor.plugins.ViewSource",p,{stripScripts:!0,stripComments:!0,stripIFrames:!0,readOnly:!1,_fsPlugin:null,toggle:function(){u("webkit")&&(this._vsFocused=!0),this.button.set("checked",!this.button.get("checked"))},_initButton:function(){var e=a.getLocalization("dijit._editor","commands"),t=this.editor;this.button=new g({label:e.viewSource,ownerDocument:t.ownerDocument,dir:t.dir,lang:t.lang,showLabel:!1,iconClass:this.iconClassPrefix+" "+this.iconClassPrefix+"ViewSource",tabIndex:"-1",onChange:l.hitch(this,"_showSource")}),7==u("ie")&&(this._ieFixNode=r.create("div",{style:{opacity:"0",zIndex:"-1000",position:"absolute",top:"-1000px"}},t.ownerDocumentBody)),this.button.set("readOnly",!1)},setEditor:function(e){this.editor=e,this._initButton(),this.editor.addKeyHandler(d.F12,!0,!0,l.hitch(this,function(e){this.button.focus(),this.toggle(),e.stopPropagation(),e.preventDefault(),setTimeout(l.hitch(this,function(){this.editor.focused&&this.editor.focus()}),100)}))},_showSource:function(i){var o,r=this.editor,n=r._plugins;this._sourceShown=i;var a=this;try{if(this.sourceArea||this._createSourceView(),i){r._sourceQueryCommandEnabled=r.queryCommandEnabled,r.queryCommandEnabled=function(e){return"viewsource"===e.toLowerCase()},this.editor.onDisplayChanged(),o=r.get("value"),o=this._filter(o),r.set("value",o),e.forEach(n,function(e){!e||e instanceof v||!e.isInstanceOf(p)||e.set("disabled",!0)}),this._fsPlugin&&(this._fsPlugin._getAltViewNode=function(){return a.sourceArea}),this.sourceArea.value=o,this.sourceArea.style.height=r.iframe.style.height,this.sourceArea.style.width=r.iframe.style.width,s.set(r.iframe,"display","none"),s.set(this.sourceArea,{display:"block"});var d=function(){var e=h.getBox(r.ownerDocument);if("_prevW"in this&&"_prevH"in this){if(e.w===this._prevW&&e.h===this._prevH)return;this._prevW=e.w,this._prevH=e.h}else this._prevW=e.w,this._prevH=e.h;this._resizer&&(clearTimeout(this._resizer),delete this._resizer),this._resizer=setTimeout(l.hitch(this,function(){delete this._resizer,this._resize()}),10)};this._resizeHandle=c(window,"resize",l.hitch(this,d)),setTimeout(l.hitch(this,this._resize),100),this.editor.onNormalizedDisplayChanged(),this.editor.__oldGetValue=this.editor.getValue,this.editor.getValue=l.hitch(this,function(){var e=this.sourceArea.value;return e=this._filter(e)}),this._setListener=t.after(this.editor,"setValue",l.hitch(this,function(e){e=e||"",e=this._filter(e),this.sourceArea.value=e}),!0)}else{if(!r._sourceQueryCommandEnabled)return;this._setListener.remove(),delete this._setListener,this._resizeHandle.remove(),delete this._resizeHandle,this.editor.__oldGetValue&&(this.editor.getValue=this.editor.__oldGetValue,delete this.editor.__oldGetValue),r.queryCommandEnabled=r._sourceQueryCommandEnabled,this._readOnly||(o=this.sourceArea.value,o=this._filter(o),r.beginEditing(),r.set("value",o),r.endEditing()),e.forEach(n,function(e){e&&e.isInstanceOf(p)&&e.set("disabled",!1)}),s.set(this.sourceArea,"display","none"),s.set(r.iframe,"display","block"),delete r._sourceQueryCommandEnabled,this.editor.onDisplayChanged()}setTimeout(l.hitch(this,function(){var e=r.domNode.parentNode;if(e){var t=_.getEnclosingWidget(e);t&&t.resize&&t.resize()}r.resize()}),300)}catch(u){}},updateState:function(){this.button.set("disabled",this.get("disabled"))},_resize:function(){var e=this.editor,t=e.getHeaderHeight(),i=e.getFooterHeight(),o=n.position(e.domNode),r=n.getPadBorderExtents(e.iframe.parentNode),s=n.getMarginExtents(e.iframe.parentNode),a=n.getPadBorderExtents(e.domNode),d={w:o.w-a.w,h:o.h-(t+a.h+i)};if(this._fsPlugin&&this._fsPlugin.isFullscreen){var l=h.getBox(e.ownerDocument);d.w=l.w-a.w,d.h=l.h-(t+a.h+i)}if(u("ie")&&(d.h-=2),this._ieFixNode){var c=-this._ieFixNode.offsetTop/1e3;d.w=Math.floor((d.w+.9)/c),d.h=Math.floor((d.h+.9)/c)}n.setMarginBox(this.sourceArea,{w:d.w-(r.w+s.w),h:d.h-(r.h+s.h)}),n.setMarginBox(e.iframe.parentNode,{h:d.h})},_createSourceView:function(){var e=this.editor,t=e._plugins;this.sourceArea=r.create("textarea"),this.readOnly&&(o.set(this.sourceArea,"readOnly",!0),this._readOnly=!0),s.set(this.sourceArea,{padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"}),o.set(this.sourceArea,"aria-label",this.editor.id),r.place(this.sourceArea,e.iframe,"before"),u("ie")&&e.iframe.parentNode.lastChild!==e.iframe&&s.set(e.iframe.parentNode.lastChild,{width:"0px",height:"0px",padding:"0px",margin:"0px",borderWidth:"0px",borderStyle:"none"}),e._viewsource_oldFocus=e.focus;var i=this;e.focus=function(){if(i._sourceShown)i.setSourceAreaCaret();else try{this._vsFocused?(delete this._vsFocused,f.focus(e.editNode)):e._viewsource_oldFocus()}catch(t){}};var n,a;for(n=0;n<t.length;n++)if(a=t[n],a&&("dijit._editor.plugins.FullScreen"===a.declaredClass||a.declaredClass===m._scopeName+"._editor.plugins.FullScreen")){this._fsPlugin=a;break}this._fsPlugin&&(this._fsPlugin._viewsource_getAltViewNode=this._fsPlugin._getAltViewNode,this._fsPlugin._getAltViewNode=function(){return i._sourceShown?i.sourceArea:this._viewsource_getAltViewNode()}),this.own(c(this.sourceArea,"keydown",l.hitch(this,function(t){this._sourceShown&&t.keyCode==d.F12&&t.ctrlKey&&t.shiftKey&&(this.button.focus(),this.button.set("checked",!1),setTimeout(l.hitch(this,function(){e.focus()}),100),t.stopPropagation(),t.preventDefault())})))},_stripScripts:function(e){return e&&(e=e.replace(/<\s*script[^>]*>((.|\s)*?)<\\?\/\s*script\s*>/gi,""),e=e.replace(/<\s*script\b([^<>]|\s)*>?/gi,""),e=e.replace(/<[^>]*=(\s|)*[("|')]javascript:[^$1][(\s|.)]*[$1][^>]*>/gi,"")),e},_stripComments:function(e){return e&&(e=e.replace(/<!--(.|\s){1,}?-->/g,"")),e},_stripIFrames:function(e){return e&&(e=e.replace(/<\s*iframe[^>]*>((.|\s)*?)<\\?\/\s*iframe\s*>/gi,"")),e},_filter:function(e){return e&&(this.stripScripts&&(e=this._stripScripts(e)),this.stripComments&&(e=this._stripComments(e)),this.stripIFrames&&(e=this._stripIFrames(e))),e},setSourceAreaCaret:function(){var e=this.sourceArea;if(f.focus(e),this._sourceShown&&!this.readOnly)if(e.setSelectionRange)e.setSelectionRange(0,0);else if(this.sourceArea.createTextRange){var t=e.createTextRange();t.collapse(!0),t.moveStart("character",-99999),t.moveStart("character",0),t.moveEnd("character",0),t.select()}},destroy:function(){this._ieFixNode&&r.destroy(this._ieFixNode),this._resizer&&(clearTimeout(this._resizer),delete this._resizer),this._resizeHandle&&(this._resizeHandle.remove(),delete this._resizeHandle),this._setListener&&(this._setListener.remove(),delete this._setListener),this.inherited(arguments)}});return p.registry.viewSource=p.registry.viewsource=function(e){return new v({readOnly:"readOnly"in e?e.readOnly:!1,stripComments:"stripComments"in e?e.stripComments:!0,stripScripts:"stripScripts"in e?e.stripScripts:!0,stripIFrames:"stripIFrames"in e?e.stripIFrames:!0})},v});//# sourceMappingURL=ViewSource.js.map