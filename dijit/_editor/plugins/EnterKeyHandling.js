//>>built
define("dijit/_editor/plugins/EnterKeyHandling",["dojo/_base/declare","dojo/dom-construct","dojo/keys","dojo/_base/lang","dojo/on","dojo/sniff","dojo/_base/window","dojo/window","../_Plugin","../RichText","../range"],function(e,t,o,n,i,a,r,s,d,l,c){return e("dijit._editor.plugins.EnterKeyHandling",d,{blockNodeForEnter:"BR",constructor:function(e){e&&("blockNodeForEnter"in e&&(e.blockNodeForEnter=e.blockNodeForEnter.toUpperCase()),n.mixin(this,e))},setEditor:function(e){if(this.editor!==e)if(this.editor=e,"BR"==this.blockNodeForEnter)this.editor.customUndo=!0,e.onLoadDeferred.then(n.hitch(this,function(t){return this.own(i(e.document,"keydown",n.hitch(this,function(e){if(e.keyCode==o.ENTER){var t=n.mixin({},e);t.shiftKey=!0,this.handleEnterKey(t)||(e.stopPropagation(),e.preventDefault())}}))),a("ie")>=9&&a("ie")<=10&&this.own(i(e.document,"paste",n.hitch(this,function(e){setTimeout(n.hitch(this,function(){var e=this.editor.document.selection.createRange();e.move("character",-1),e.select(),e.move("character",1),e.select()}),0)}))),t}));else if(this.blockNodeForEnter){var t=n.hitch(this,"handleEnterKey");e.addKeyHandler(13,0,0,t),e.addKeyHandler(13,0,1,t),this.own(this.editor.on("KeyPressed",n.hitch(this,"onKeyPressed")))}},onKeyPressed:function(){if(this._checkListLater){if(this.editor.selection.isCollapsed()){var e=this.editor.selection.getAncestorElement("LI");if(e){a("mozilla")&&"LI"==e.parentNode.parentNode.nodeName&&(e=e.parentNode.parentNode);var t=e.firstChild;if(t&&1==t.nodeType&&("UL"==t.nodeName||"OL"==t.nodeName)){e.insertBefore(t.ownerDocument.createTextNode(" "),t);var o=c.create(this.editor.window);o.setStart(e.firstChild,0);var n=c.getSelection(this.editor.window,!0);n.removeAllRanges(),n.addRange(o)}}else{l.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var i=this.editor.selection.getAncestorElement(this.blockNodeForEnter);if(i&&(i.innerHTML=this.bogusHtmlContent,a("ie")<=9)){var r=this.editor.document.selection.createRange();r.move("character",-1),r.select()}}}this._checkListLater=!1}this._pressedEnterInBlock&&(this._pressedEnterInBlock.previousSibling&&this.removeTrailingBr(this._pressedEnterInBlock.previousSibling),delete this._pressedEnterInBlock)},bogusHtmlContent:"&#160;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(e){var o,n,i,r,d,h,u,f,p,g=this.editor.document;if(e.shiftKey){var m=this.editor.selection.getParentElement(),v=c.getAncestor(m,this.blockNodes);if(v){if("LI"==v.tagName)return!0;if(o=c.getSelection(this.editor.window),n=o.getRangeAt(0),n.collapsed||(n.deleteContents(),o=c.getSelection(this.editor.window),n=o.getRangeAt(0)),c.atBeginningOfContainer(v,n.startContainer,n.startOffset))u=g.createElement("br"),i=c.create(this.editor.window),v.insertBefore(u,v.firstChild),i.setStartAfter(u),o.removeAllRanges(),o.addRange(i);else{if(!c.atEndOfContainer(v,n.startContainer,n.startOffset))return f=n.startContainer,f&&3==f.nodeType?(p=f.nodeValue,r=g.createTextNode(p.substring(0,n.startOffset)),d=g.createTextNode(p.substring(n.startOffset)),h=g.createElement("br"),""==d.nodeValue&&a("webkit")&&(d=g.createTextNode(" ")),t.place(r,f,"after"),t.place(h,r,"after"),t.place(d,h,"after"),t.destroy(f),i=c.create(this.editor.window),i.setStart(d,0),o.removeAllRanges(),o.addRange(i),!1):!0;i=c.create(this.editor.window),u=g.createElement("br"),v.appendChild(u),v.appendChild(g.createTextNode(" ")),i.setStart(v.lastChild,0),o.removeAllRanges(),o.addRange(i)}}else if(o=c.getSelection(this.editor.window),o.rangeCount){if(n=o.getRangeAt(0),n&&n.startContainer)if(n.collapsed||(n.deleteContents(),o=c.getSelection(this.editor.window),n=o.getRangeAt(0)),f=n.startContainer,f&&3==f.nodeType){var b=n.startOffset;f.length<b&&(x=this._adjustNodeAndOffset(f,b),f=x.node,b=x.offset),p=f.nodeValue,r=g.createTextNode(p.substring(0,b)),d=g.createTextNode(p.substring(b)),h=g.createElement("br"),d.length||(d=g.createTextNode(" ")),r.length?t.place(r,f,"after"):r=f,t.place(h,r,"after"),t.place(d,h,"after"),t.destroy(f),i=c.create(this.editor.window),i.setStart(d,0),i.setEnd(d,d.length),o.removeAllRanges(),o.addRange(i),this.editor.selection.collapse(!0)}else{var _;n.startOffset>=0&&(_=f.childNodes[n.startOffset]);var h=g.createElement("br"),d=g.createTextNode(" ");_?(t.place(h,_,"before"),t.place(d,h,"after")):(f.appendChild(h),f.appendChild(d)),i=c.create(this.editor.window),i.setStart(d,0),i.setEnd(d,d.length),o.removeAllRanges(),o.addRange(i),this.editor.selection.collapse(!0)}}else l.prototype.execCommand.call(this.editor,"inserthtml","<br>");return!1}var y=!0;o=c.getSelection(this.editor.window),n=o.getRangeAt(0),n.collapsed||(n.deleteContents(),o=c.getSelection(this.editor.window),n=o.getRangeAt(0));var C=c.getBlockAncestor(n.endContainer,null,this.editor.editNode),k=C.blockNode;if(this._checkListLater=k&&("LI"==k.nodeName||"LI"==k.parentNode.nodeName))return a("mozilla")&&(this._pressedEnterInBlock=k),/^(\s|&nbsp;|&#160;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|&#160;|\xA0)<\/span>)?(<br>)?$/.test(k.innerHTML)&&(k.innerHTML="",a("webkit")&&(i=c.create(this.editor.window),i.setStart(k,0),o.removeAllRanges(),o.addRange(i)),this._checkListLater=!1),!0;if(!C.blockNode||C.blockNode===this.editor.editNode){try{l.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter)}catch(j){}if(C={blockNode:this.editor.selection.getAncestorElement(this.blockNodeForEnter),blockContainer:this.editor.editNode},C.blockNode){if(C.blockNode!=this.editor.editNode&&!(C.blockNode.textContent||C.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)return this.removeTrailingBr(C.blockNode),!1}else C.blockNode=this.editor.editNode;o=c.getSelection(this.editor.window),n=o.getRangeAt(0)}var N=g.createElement(this.blockNodeForEnter);N.innerHTML=this.bogusHtmlContent,this.removeTrailingBr(C.blockNode);var w=n.endOffset,T=n.endContainer;if(T.length<w){var x=this._adjustNodeAndOffset(T,w);T=x.node,w=x.offset}if(c.atEndOfContainer(C.blockNode,T,w))C.blockNode===C.blockContainer?C.blockNode.appendChild(N):t.place(N,C.blockNode,"after"),y=!1,i=c.create(this.editor.window),i.setStart(N,0),o.removeAllRanges(),o.addRange(i),this.editor.height&&s.scrollIntoView(N);else if(c.atBeginningOfContainer(C.blockNode,n.startContainer,n.startOffset))t.place(N,C.blockNode,C.blockNode===C.blockContainer?"first":"before"),N.nextSibling&&this.editor.height&&(i=c.create(this.editor.window),i.setStart(N.nextSibling,0),o.removeAllRanges(),o.addRange(i),s.scrollIntoView(N.nextSibling)),y=!1;else{C.blockNode===C.blockContainer?C.blockNode.appendChild(N):t.place(N,C.blockNode,"after"),y=!1,C.blockNode.style&&N.style&&C.blockNode.style.cssText&&(N.style.cssText=C.blockNode.style.cssText),f=n.startContainer;var S;if(f&&3==f.nodeType){var E,D;w=n.endOffset,f.length<w&&(x=this._adjustNodeAndOffset(f,w),f=x.node,w=x.offset),p=f.nodeValue,r=g.createTextNode(p.substring(0,w)),d=g.createTextNode(p.substring(w,p.length)),t.place(r,f,"before"),t.place(d,f,"after"),t.destroy(f);for(var L=r.parentNode;L!==C.blockNode;){var M=L.tagName,A=g.createElement(M);for(L.style&&A.style&&L.style.cssText&&(A.style.cssText=L.style.cssText),"FONT"===L.tagName&&(L.color&&(A.color=L.color),L.face&&(A.face=L.face),L.size&&(A.size=L.size)),E=d;E;)D=E.nextSibling,A.appendChild(E),E=D;t.place(A,L,"after"),r=L,d=A,L=L.parentNode}for(E=d,(1==E.nodeType||3==E.nodeType&&E.nodeValue)&&(N.innerHTML=""),S=E;E;)D=E.nextSibling,N.appendChild(E),E=D}i=c.create(this.editor.window);var R,P=S;if("BR"!==this.blockNodeForEnter){for(;P;)R=P,D=P.firstChild,P=D;R&&R.parentNode?(N=R.parentNode,i.setStart(N,0),o.removeAllRanges(),o.addRange(i),this.editor.height&&s.scrollIntoView(N),a("mozilla")&&(this._pressedEnterInBlock=C.blockNode)):y=!0}else i.setStart(N,0),o.removeAllRanges(),o.addRange(i),this.editor.height&&s.scrollIntoView(N),a("mozilla")&&(this._pressedEnterInBlock=C.blockNode)}return y},_adjustNodeAndOffset:function(e,t){for(;e.length<t&&e.nextSibling&&3==e.nextSibling.nodeType;)t-=e.length,e=e.nextSibling;return{node:e,offset:t}},removeTrailingBr:function(e){var o=/P|DIV|LI/i.test(e.tagName)?e:this.editor.selection.getParentOfType(e,["P","DIV","LI"]);o&&(o.lastChild&&(o.childNodes.length>1&&3==o.lastChild.nodeType&&/^[\s\xAD]*$/.test(o.lastChild.nodeValue)||"BR"==o.lastChild.tagName)&&t.destroy(o.lastChild),o.childNodes.length||(o.innerHTML=this.bogusHtmlContent))}})});//# sourceMappingURL=EnterKeyHandling.js.map