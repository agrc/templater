//>>built
define("dijit/_editor/plugins/EnterKeyHandling",["dojo/_base/declare","dojo/dom-construct","dojo/keys","dojo/_base/lang","dojo/on","dojo/sniff","dojo/_base/window","dojo/window","../_Plugin","../RichText","../range"],function(e,t,n,i,o,r,a,s,d,l,c){return e("dijit._editor.plugins.EnterKeyHandling",d,{blockNodeForEnter:"BR",constructor:function(e){e&&("blockNodeForEnter"in e&&(e.blockNodeForEnter=e.blockNodeForEnter.toUpperCase()),i.mixin(this,e))},setEditor:function(e){if(this.editor!==e)if(this.editor=e,"BR"==this.blockNodeForEnter)this.editor.customUndo=!0,e.onLoadDeferred.then(i.hitch(this,function(t){return this.own(o(e.document,"keydown",i.hitch(this,function(e){if(e.keyCode==n.ENTER){var t=i.mixin({},e);t.shiftKey=!0,this.handleEnterKey(t)||(e.stopPropagation(),e.preventDefault())}}))),r("ie")>=9&&r("ie")<=10&&this.own(o(e.document,"paste",i.hitch(this,function(e){setTimeout(i.hitch(this,function(){var e=this.editor.document.selection.createRange();e.move("character",-1),e.select(),e.move("character",1),e.select()}),0)}))),t}));else if(this.blockNodeForEnter){var t=i.hitch(this,"handleEnterKey");e.addKeyHandler(13,0,0,t),e.addKeyHandler(13,0,1,t),this.own(this.editor.on("KeyPressed",i.hitch(this,"onKeyPressed")))}},onKeyPressed:function(){if(this._checkListLater){if(this.editor.selection.isCollapsed()){var e=this.editor.selection.getAncestorElement("LI");if(e){r("mozilla")&&"LI"==e.parentNode.parentNode.nodeName&&(e=e.parentNode.parentNode);var t=e.firstChild;if(t&&1==t.nodeType&&("UL"==t.nodeName||"OL"==t.nodeName)){e.insertBefore(t.ownerDocument.createTextNode(" "),t);var n=c.create(this.editor.window);n.setStart(e.firstChild,0);var i=c.getSelection(this.editor.window,!0);i.removeAllRanges(),i.addRange(n)}}else{l.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter);var o=this.editor.selection.getAncestorElement(this.blockNodeForEnter);if(o&&(o.innerHTML=this.bogusHtmlContent,r("ie")<=9)){var a=this.editor.document.selection.createRange();a.move("character",-1),a.select()}}}this._checkListLater=!1}this._pressedEnterInBlock&&(this._pressedEnterInBlock.previousSibling&&this.removeTrailingBr(this._pressedEnterInBlock.previousSibling),delete this._pressedEnterInBlock)},bogusHtmlContent:"&#160;",blockNodes:/^(?:P|H1|H2|H3|H4|H5|H6|LI)$/,handleEnterKey:function(e){var n,i,o,a,d,u,h,f,p,g=this.editor.document;if(e.shiftKey){var m=this.editor.selection.getParentElement(),v=c.getAncestor(m,this.blockNodes);if(v){if("LI"==v.tagName)return!0;if(n=c.getSelection(this.editor.window),i=n.getRangeAt(0),i.collapsed||(i.deleteContents(),n=c.getSelection(this.editor.window),i=n.getRangeAt(0)),c.atBeginningOfContainer(v,i.startContainer,i.startOffset))h=g.createElement("br"),o=c.create(this.editor.window),v.insertBefore(h,v.firstChild),o.setStartAfter(h),n.removeAllRanges(),n.addRange(o);else{if(!c.atEndOfContainer(v,i.startContainer,i.startOffset))return f=i.startContainer,f&&3==f.nodeType?(p=f.nodeValue,a=g.createTextNode(p.substring(0,i.startOffset)),d=g.createTextNode(p.substring(i.startOffset)),u=g.createElement("br"),""==d.nodeValue&&r("webkit")&&(d=g.createTextNode(" ")),t.place(a,f,"after"),t.place(u,a,"after"),t.place(d,u,"after"),t.destroy(f),o=c.create(this.editor.window),o.setStart(d,0),n.removeAllRanges(),n.addRange(o),!1):!0;o=c.create(this.editor.window),h=g.createElement("br"),v.appendChild(h),v.appendChild(g.createTextNode(" ")),o.setStart(v.lastChild,0),n.removeAllRanges(),n.addRange(o)}}else if(n=c.getSelection(this.editor.window),n.rangeCount){if(i=n.getRangeAt(0),i&&i.startContainer)if(i.collapsed||(i.deleteContents(),n=c.getSelection(this.editor.window),i=n.getRangeAt(0)),f=i.startContainer,f&&3==f.nodeType){var b=i.startOffset;f.length<b&&(S=this._adjustNodeAndOffset(f,b),f=S.node,b=S.offset),p=f.nodeValue,a=g.createTextNode(p.substring(0,b)),d=g.createTextNode(p.substring(b)),u=g.createElement("br"),d.length||(d=g.createTextNode(" ")),a.length?t.place(a,f,"after"):a=f,t.place(u,a,"after"),t.place(d,u,"after"),t.destroy(f),o=c.create(this.editor.window),o.setStart(d,0),o.setEnd(d,d.length),n.removeAllRanges(),n.addRange(o),this.editor.selection.collapse(!0)}else{var y;i.startOffset>=0&&(y=f.childNodes[i.startOffset]);var u=g.createElement("br"),d=g.createTextNode(" ");y?(t.place(u,y,"before"),t.place(d,u,"after")):(f.appendChild(u),f.appendChild(d)),o=c.create(this.editor.window),o.setStart(d,0),o.setEnd(d,d.length),n.removeAllRanges(),n.addRange(o),this.editor.selection.collapse(!0)}}else l.prototype.execCommand.call(this.editor,"inserthtml","<br>");return!1}var _=!0;n=c.getSelection(this.editor.window),i=n.getRangeAt(0),i.collapsed||(i.deleteContents(),n=c.getSelection(this.editor.window),i=n.getRangeAt(0));var k=c.getBlockAncestor(i.endContainer,null,this.editor.editNode),C=k.blockNode;if(this._checkListLater=C&&("LI"==C.nodeName||"LI"==C.parentNode.nodeName))return r("mozilla")&&(this._pressedEnterInBlock=C),/^(\s|&nbsp;|&#160;|\xA0|<span\b[^>]*\bclass=['"]Apple-style-span['"][^>]*>(\s|&nbsp;|&#160;|\xA0)<\/span>)?(<br>)?$/.test(C.innerHTML)&&(C.innerHTML="",r("webkit")&&(o=c.create(this.editor.window),o.setStart(C,0),n.removeAllRanges(),n.addRange(o)),this._checkListLater=!1),!0;if(!k.blockNode||k.blockNode===this.editor.editNode){try{l.prototype.execCommand.call(this.editor,"formatblock",this.blockNodeForEnter)}catch(T){}if(k={blockNode:this.editor.selection.getAncestorElement(this.blockNodeForEnter),blockContainer:this.editor.editNode},k.blockNode){if(k.blockNode!=this.editor.editNode&&!(k.blockNode.textContent||k.blockNode.innerHTML).replace(/^\s+|\s+$/g,"").length)return this.removeTrailingBr(k.blockNode),!1}else k.blockNode=this.editor.editNode;n=c.getSelection(this.editor.window),i=n.getRangeAt(0)}var j=g.createElement(this.blockNodeForEnter);j.innerHTML=this.bogusHtmlContent,this.removeTrailingBr(k.blockNode);var N=i.endOffset,w=i.endContainer;if(w.length<N){var S=this._adjustNodeAndOffset(w,N);w=S.node,N=S.offset}if(c.atEndOfContainer(k.blockNode,w,N))k.blockNode===k.blockContainer?k.blockNode.appendChild(j):t.place(j,k.blockNode,"after"),_=!1,o=c.create(this.editor.window),o.setStart(j,0),n.removeAllRanges(),n.addRange(o),this.editor.height&&s.scrollIntoView(j);else if(c.atBeginningOfContainer(k.blockNode,i.startContainer,i.startOffset))t.place(j,k.blockNode,k.blockNode===k.blockContainer?"first":"before"),j.nextSibling&&this.editor.height&&(o=c.create(this.editor.window),o.setStart(j.nextSibling,0),n.removeAllRanges(),n.addRange(o),s.scrollIntoView(j.nextSibling)),_=!1;else{k.blockNode===k.blockContainer?k.blockNode.appendChild(j):t.place(j,k.blockNode,"after"),_=!1,k.blockNode.style&&j.style&&k.blockNode.style.cssText&&(j.style.cssText=k.blockNode.style.cssText),f=i.startContainer;var x;if(f&&3==f.nodeType){var L,E;N=i.endOffset,f.length<N&&(S=this._adjustNodeAndOffset(f,N),f=S.node,N=S.offset),p=f.nodeValue,a=g.createTextNode(p.substring(0,N)),d=g.createTextNode(p.substring(N,p.length)),t.place(a,f,"before"),t.place(d,f,"after"),t.destroy(f);for(var R=a.parentNode;R!==k.blockNode;){var I=R.tagName,A=g.createElement(I);for(R.style&&A.style&&R.style.cssText&&(A.style.cssText=R.style.cssText),"FONT"===R.tagName&&(R.color&&(A.color=R.color),R.face&&(A.face=R.face),R.size&&(A.size=R.size)),L=d;L;)E=L.nextSibling,A.appendChild(L),L=E;t.place(A,R,"after"),a=R,d=A,R=R.parentNode}for(L=d,(1==L.nodeType||3==L.nodeType&&L.nodeValue)&&(j.innerHTML=""),x=L;L;)E=L.nextSibling,j.appendChild(L),L=E}o=c.create(this.editor.window);var P,D=x;if("BR"!==this.blockNodeForEnter){for(;D;)P=D,E=D.firstChild,D=E;P&&P.parentNode?(j=P.parentNode,o.setStart(j,0),n.removeAllRanges(),n.addRange(o),this.editor.height&&s.scrollIntoView(j),r("mozilla")&&(this._pressedEnterInBlock=k.blockNode)):_=!0}else o.setStart(j,0),n.removeAllRanges(),n.addRange(o),this.editor.height&&s.scrollIntoView(j),r("mozilla")&&(this._pressedEnterInBlock=k.blockNode)}return _},_adjustNodeAndOffset:function(e,t){for(;e.length<t&&e.nextSibling&&3==e.nextSibling.nodeType;)t-=e.length,e=e.nextSibling;return{node:e,offset:t}},removeTrailingBr:function(e){var n=/P|DIV|LI/i.test(e.tagName)?e:this.editor.selection.getParentOfType(e,["P","DIV","LI"]);n&&(n.lastChild&&(n.childNodes.length>1&&3==n.lastChild.nodeType&&/^[\s\xAD]*$/.test(n.lastChild.nodeValue)||"BR"==n.lastChild.tagName)&&t.destroy(n.lastChild),n.childNodes.length||(n.innerHTML=this.bogusHtmlContent))}})});//# sourceMappingURL=EnterKeyHandling.js.map