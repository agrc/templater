//>>built
define("dijit/form/_FormSelectWidget",["dojo/_base/array","dojo/_base/Deferred","dojo/aspect","dojo/data/util/sorter","dojo/_base/declare","dojo/dom","dojo/dom-class","dojo/_base/kernel","dojo/_base/lang","dojo/query","dojo/when","dojo/store/util/QueryResults","./_FormValueWidget"],function(t,e,i,o,n,a,s,r,d,l,u,h,c){return n("dijit.form._FormSelectWidget",c,{multiple:!1,options:null,store:null,_setStoreAttr:function(t){this._created&&this._deprecatedSetStore(t)},query:null,_setQueryAttr:function(t){this._created&&this._deprecatedSetStore(this.store,this.selectedValue,{query:t})},queryOptions:null,_setQueryOptionsAttr:function(t){this._created&&this._deprecatedSetStore(this.store,this.selectedValue,{queryOptions:t})},labelAttr:"",onFetch:null,sortByLabel:!0,loadChildrenOnOpen:!1,onLoadDeferred:null,getOptions:function(e){var i=this.options||[];return null==e?i:d.isArrayLike(e)?t.map(e,"return this.getOptions(item);",this):(d.isString(e)&&(e={value:e}),d.isObject(e)&&(t.some(i,function(t,i){for(var o in e)if(!(o in t)||t[o]!=e[o])return!1;return e=i,!0})||(e=-1)),e>=0&&e<i.length?i[e]:null)},addOption:function(e){t.forEach(d.isArrayLike(e)?e:[e],function(t){t&&d.isObject(t)&&this.options.push(t)},this),this._loadChildren()},removeOption:function(e){var i=this.getOptions(d.isArrayLike(e)?e:[e]);t.forEach(i,function(e){e&&(this.options=t.filter(this.options,function(t){return t.value!==e.value||t.label!==e.label}),this._removeOptionItem(e))},this),this._loadChildren()},updateOption:function(e){t.forEach(d.isArrayLike(e)?e:[e],function(t){var e,i=this.getOptions({value:t.value});if(i)for(e in t)i[e]=t[e]},this),this._loadChildren()},setStore:function(t,e,i){r.deprecated(this.declaredClass+"::setStore(store, selectedValue, fetchArgs) is deprecated. Use set('query', fetchArgs.query), set('queryOptions', fetchArgs.queryOptions), set('store', store), or set('value', selectedValue) instead.","","2.0"),this._deprecatedSetStore(t,e,i)},_deprecatedSetStore:function(n,a,s){var r=this.store;if(s=s||{},r!==n){for(var l;l=this._notifyConnections.pop();)l.remove();n.get||(d.mixin(n,{_oldAPI:!0,get:function(t){var i=new e;return this.fetchItemByIdentity({identity:t,onItem:function(t){i.resolve(t)},onError:function(t){i.reject(t)}}),i.promise},query:function(t,i){var o=new e(function(){n.abort&&n.abort()});o.total=new e;var n=this.fetch(d.mixin({query:t,onBegin:function(t){o.total.resolve(t)},onComplete:function(t){o.resolve(t)},onError:function(t){o.reject(t)}},i));return new h(o)}}),n.getFeatures()["dojo.data.api.Notification"]&&(this._notifyConnections=[i.after(n,"onNew",d.hitch(this,"_onNewItem"),!0),i.after(n,"onDelete",d.hitch(this,"_onDeleteItem"),!0),i.after(n,"onSet",d.hitch(this,"_onSetItem"),!0)])),this._set("store",n)}return this.options&&this.options.length&&this.removeOption(this.options),this._queryRes&&this._queryRes.close&&this._queryRes.close(),this._observeHandle&&this._observeHandle.remove&&(this._observeHandle.remove(),this._observeHandle=null),s.query&&this._set("query",s.query),s.queryOptions&&this._set("queryOptions",s.queryOptions),n&&n.query&&(this._loadingStore=!0,this.onLoadDeferred=new e,this._queryRes=n.query(this.query,this.queryOptions),u(this._queryRes,d.hitch(this,function(e){if(this.sortByLabel&&!s.sort&&e.length)if(n.getValue)e.sort(o.createSortFunction([{attribute:n.getLabelAttributes(e[0])[0]}],n));else{var i=this.labelAttr;e.sort(function(t,e){return t[i]>e[i]?1:e[i]>t[i]?-1:0})}s.onFetch&&(e=s.onFetch.call(this,e,s)),t.forEach(e,function(t){this._addOptionForItem(t)},this),this._queryRes.observe&&(this._observeHandle=this._queryRes.observe(d.hitch(this,function(t,e,i){e==i?this._onSetItem(t):(-1!=e&&this._onDeleteItem(t),-1!=i&&this._onNewItem(t))}),!0)),this._loadingStore=!1,this.set("value","_pendingValue"in this?this._pendingValue:a),delete this._pendingValue,this.loadChildrenOnOpen?this._pseudoLoadChildren(e):this._loadChildren(),this.onLoadDeferred.resolve(!0),this.onSetStore()}),d.hitch(this,function(t){this.onLoadDeferred.reject(t)}))),r},_setValueAttr:function(e,i){if(this._onChangeActive||(i=null),this._loadingStore)return void(this._pendingValue=e);if(null!=e){e=d.isArrayLike(e)?t.map(e,function(t){return d.isObject(t)?t:{value:t}}):d.isObject(e)?[e]:[{value:e}],e=t.filter(this.getOptions(e),function(t){return t&&t.value});var o=this.getOptions()||[];this.multiple||e[0]&&e[0].value||!o.length||(e[0]=o[0]),t.forEach(o,function(i){i.selected=t.some(e,function(t){return t.value===i.value})});var n=t.map(e,function(t){return t.value});if(void 0!==n&&void 0!==n[0]){var a=t.map(e,function(t){return t.label});this._setDisplay(this.multiple?a:a[0]),this.inherited(arguments,[this.multiple?n:n[0],i]),this._updateSelection()}}},_getDisplayedValueAttr:function(){var e=t.map([].concat(this.get("selectedOptions")),function(t){return t&&"label"in t?t.label:t?t.value:null},this);return this.multiple?e:e[0]},_setDisplayedValueAttr:function(t){this.set("value",this.getOptions("string"==typeof t?{label:t}:t))},_loadChildren:function(){this._loadingStore||(t.forEach(this._getChildren(),function(t){t.destroyRecursive()}),t.forEach(this.options,this._addOptionItem,this),this._updateSelection())},_updateSelection:function(){this.focusedChild=null,this._set("value",this._getValueFromOpts());var e=[].concat(this.value);if(e&&e[0]){var i=this;t.forEach(this._getChildren(),function(o){var n=t.some(e,function(t){return o.option&&t===o.option.value});n&&!i.multiple&&(i.focusedChild=o),s.toggle(o.domNode,this.baseClass.replace(/\s+|$/g,"SelectedOption "),n),o.domNode.setAttribute("aria-selected",n?"true":"false")},this)}},_getValueFromOpts:function(){var e=this.getOptions()||[];if(!this.multiple&&e.length){var i=t.filter(e,function(t){return t.selected})[0];return i&&i.value?i.value:(e[0].selected=!0,e[0].value)}return this.multiple?t.map(t.filter(e,function(t){return t.selected}),function(t){return t.value})||[]:""},_onNewItem:function(t,e){e&&e.parent||this._addOptionForItem(t)},_onDeleteItem:function(t){var e=this.store;this.removeOption({value:e.getIdentity(t)})},_onSetItem:function(t){this.updateOption(this._getOptionObjForItem(t))},_getOptionObjForItem:function(t){var e=this.store,i=this.labelAttr&&this.labelAttr in t?t[this.labelAttr]:e.getLabel(t);return{value:i?e.getIdentity(t):null,label:i,item:t}},_addOptionForItem:function(t){var e=this.store;if(e.isItemLoaded&&!e.isItemLoaded(t))return void e.loadItem({item:t,onItem:function(t){this._addOptionForItem(t)},scope:this});var i=this._getOptionObjForItem(t);this.addOption(i)},constructor:function(t){this._oValue=(t||{}).value||null,this._notifyConnections=[]},buildRendering:function(){this.inherited(arguments),a.setSelectable(this.focusNode,!1)},_fillContent:function(){this.options||(this.options=this.srcNodeRef?l("> *",this.srcNodeRef).map(function(t){return"separator"===t.getAttribute("type")?{value:"",label:"",selected:!1,disabled:!1}:{value:t.getAttribute("data-"+r._scopeName+"-value")||t.getAttribute("value"),label:String(t.innerHTML),selected:t.getAttribute("selected")||!1,disabled:t.getAttribute("disabled")||!1}},this):[]),this.value?this.multiple&&"string"==typeof this.value&&this._set("value",this.value.split(",")):this._set("value",this._getValueFromOpts())},postCreate:function(){this.inherited(arguments),i.after(this,"onChange",d.hitch(this,"_updateSelection"));var t=this.store;t&&(t.getIdentity||t.getFeatures()["dojo.data.api.Identity"])&&(this.store=null,this._deprecatedSetStore(t,this._oValue,{query:this.query,queryOptions:this.queryOptions})),this._storeInitialized=!0},startup:function(){this._loadChildren(),this.inherited(arguments)},destroy:function(){for(var t;t=this._notifyConnections.pop();)t.remove();this._queryRes&&this._queryRes.close&&this._queryRes.close(),this._observeHandle&&this._observeHandle.remove&&(this._observeHandle.remove(),this._observeHandle=null),this.inherited(arguments)},_addOptionItem:function(){},_removeOptionItem:function(){},_setDisplay:function(){},_getChildren:function(){return[]},_getSelectedOptionsAttr:function(){return this.getOptions({selected:!0})},_pseudoLoadChildren:function(){},onSetStore:function(){}})});//# sourceMappingURL=_FormSelectWidget.js.map