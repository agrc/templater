//>>built
define("dojo/_base/xhr",["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(e,t,i,o,n,r,s,a,l,d,c,u,h,f,p,g){e._xhrObj=p._create;var m=e.config;e.objectToQuery=o.objectToQuery,e.queryToObject=o.queryToObject,e.fieldToObject=r.fieldToObject,e.formToObject=r.toObject,e.formToQuery=r.toQuery,e.formToJson=r.toJson,e._blockAsync=!1;var v=e._contentHandlers=e.contentHandlers={text:function(e){return e.responseText},json:function(e){return l.fromJson(e.responseText||null)},"json-comment-filtered":function(e){a.useCommentedJson;var t=e.responseText,i=t.indexOf("/*"),o=t.lastIndexOf("*/");if(-1==i||-1==o)throw new Error("JSON was not comment filtered");return l.fromJson(t.substring(i+2,o))},javascript:function(t){return e.eval(t.responseText)},xml:function(e){var i=e.responseXML;if(i&&t("dom-qsa2.1")&&!i.querySelectorAll&&t("dom-parser")&&(i=(new DOMParser).parseFromString(e.responseText,"application/xml")),t("ie")&&(!i||!i.documentElement)){var o=function(e){return"MSXML"+e+".DOMDocument"},n=["Microsoft.XMLDOM",o(6),o(4),o(3),o(2)];c.some(n,function(t){try{var o=new ActiveXObject(t);o.async=!1,o.loadXML(e.responseText),i=o}catch(e){return!1}return!0})}return i},"json-comment-optional":function(e){return e.responseText&&/^[^{\[]*\/\*/.test(e.responseText)?v["json-comment-filtered"](e):v.json(e)}};e._ioSetArgs=function(t,i,a,l){var c={args:t,url:t.url},u=null;if(t.form){var h=n.byId(t.form),f=h.getAttributeNode("action");c.url=c.url||(f?f.value:e.doc?e.doc.URL:null),u=r.toObject(h)}var p=[{}];u&&p.push(u),t.content&&p.push(t.content),t.preventCache&&p.push({"dojo.preventCache":(new Date).valueOf()}),c.query=o.objectToQuery(d.mixin.apply(null,p)),c.handleAs=t.handleAs||"text";var g=new s(function(e){e.canceled=!0,i&&i(e);var t=e.ioArgs.error;return t||(t=new Error("request cancelled"),t.dojoType="cancel",e.ioArgs.error=t),t});g.addCallback(a);var v=t.load;v&&d.isFunction(v)&&g.addCallback(function(e){return v.call(t,e,c)});var b=t.error;b&&d.isFunction(b)&&g.addErrback(function(e){return b.call(t,e,c)});var _=t.handle;return _&&d.isFunction(_)&&g.addBoth(function(e){return _.call(t,e,c)}),g.addErrback(function(e){return l(e,g)}),m.ioPublish&&e.publish&&!1!==c.args.ioPublish&&(g.addCallbacks(function(t){return e.publish("/dojo/io/load",[g,t]),t},function(t){return e.publish("/dojo/io/error",[g,t]),t}),g.addBoth(function(t){return e.publish("/dojo/io/done",[g,t]),t})),g.ioArgs=c,g};var b=function(e){var t=v[e.ioArgs.handleAs](e.ioArgs.xhr);return void 0===t?null:t},_=function(e,t){return t.ioArgs.args.failOk,e},j=function(t){y<=0&&(y=0,m.ioPublish&&e.publish&&(!t||t&&!1!==t.ioArgs.args.ioPublish)&&e.publish("/dojo/io/stop"))},y=0;h.after(f,"_onAction",function(){y-=1}),h.after(f,"_onInFlight",j),e._ioCancelAll=f.cancelAll,e._ioNotifyStart=function(t){m.ioPublish&&e.publish&&!1!==t.ioArgs.args.ioPublish&&(y||e.publish("/dojo/io/start"),y+=1,e.publish("/dojo/io/send",[t]))},e._ioWatch=function(e,t,i,o){e.ioArgs.options=e.ioArgs.args;d.mixin(e,{response:e.ioArgs,isValid:function(i){return t(e)},isReady:function(t){return i(e)},handleResponse:function(t){return o(e)}}),f(e),j(e)};return e._ioAddQueryToUrl=function(e){e.query.length&&(e.url+=(-1==e.url.indexOf("?")?"?":"&")+e.query,e.query=null)},e.xhr=function(t,i,o){var n,r=e._ioSetArgs(i,function(e){n&&n.cancel()},b,_),s=r.ioArgs;"postData"in i?s.query=i.postData:"putData"in i?s.query=i.putData:"rawBody"in i?s.query=i.rawBody:(arguments.length>2&&!o||-1==="POST|PUT".indexOf(t.toUpperCase()))&&e._ioAddQueryToUrl(s);var a={method:t,handleAs:"text",timeout:i.timeout,withCredentials:i.withCredentials,ioArgs:s};void 0!==i.headers&&(a.headers=i.headers),void 0!==i.contentType&&(a.headers||(a.headers={}),a.headers["Content-Type"]=i.contentType),void 0!==s.query&&(a.data=s.query),void 0!==i.sync&&(a.sync=i.sync),e._ioNotifyStart(r);try{n=p(s.url,a,!0)}catch(e){return r.cancel(),r}return r.ioArgs.xhr=n.response.xhr,n.then(function(){r.resolve(r)}).otherwise(function(e){s.error=e,e.response&&(e.status=e.response.status,e.responseText=e.response.text,e.xhr=e.response.xhr),r.reject(e)}),r},e.xhrGet=function(t){return e.xhr("GET",t)},e.rawXhrPost=e.xhrPost=function(t){return e.xhr("POST",t,!0)},e.rawXhrPut=e.xhrPut=function(t){return e.xhr("PUT",t,!0)},e.xhrDelete=function(t){return e.xhr("DELETE",t)},e._isDocumentOk=function(e){return g.checkStatus(e.status)},e._getText=function(t){var i;return e.xhrGet({url:t,sync:!0,load:function(e){i=e}}),i},d.mixin(e.xhr,{_xhrObj:e._xhrObj,fieldToObject:r.fieldToObject,formToObject:r.toObject,objectToQuery:o.objectToQuery,formToQuery:r.toQuery,formToJson:r.toJson,queryToObject:o.queryToObject,contentHandlers:v,_ioSetArgs:e._ioSetArgs,_ioCancelAll:e._ioCancelAll,_ioNotifyStart:e._ioNotifyStart,_ioWatch:e._ioWatch,_ioAddQueryToUrl:e._ioAddQueryToUrl,_isDocumentOk:e._isDocumentOk,_getText:e._getText,get:e.xhrGet,post:e.xhrPost,put:e.xhrPut,del:e.xhrDelete}),e.xhr});//# sourceMappingURL=xhr.js.map