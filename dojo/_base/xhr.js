//>>built
define("dojo/_base/xhr",["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(t,e,i,n,o,a,r,s,d,l,c,u,h,p,f,m){t._xhrObj=f._create;var g=t.config;t.objectToQuery=n.objectToQuery,t.queryToObject=n.queryToObject,t.fieldToObject=a.fieldToObject,t.formToObject=a.toObject,t.formToQuery=a.toQuery,t.formToJson=a.toJson,t._blockAsync=!1;var b=t._contentHandlers=t.contentHandlers={text:function(t){return t.responseText},json:function(t){return d.fromJson(t.responseText||null)},"json-comment-filtered":function(t){!s.useCommentedJson;var e=t.responseText,i=e.indexOf("/*"),n=e.lastIndexOf("*/");if(-1==i||-1==n)throw new Error("JSON was not comment filtered");return d.fromJson(e.substring(i+2,n))},javascript:function(e){return t.eval(e.responseText)},xml:function(t){var i=t.responseXML;if(i&&e("dom-qsa2.1")&&!i.querySelectorAll&&e("dom-parser")&&(i=(new DOMParser).parseFromString(t.responseText,"application/xml")),e("ie")&&(!i||!i.documentElement)){var n=function(t){return"MSXML"+t+".DOMDocument"},o=["Microsoft.XMLDOM",n(6),n(4),n(3),n(2)];c.some(o,function(e){try{var n=new ActiveXObject(e);n.async=!1,n.loadXML(t.responseText),i=n}catch(o){return!1}return!0})}return i},"json-comment-optional":function(t){return t.responseText&&/^[^{\[]*\/\*/.test(t.responseText)?b["json-comment-filtered"](t):b.json(t)}};t._ioSetArgs=function(e,i,s,d){var c={args:e,url:e.url},u=null;if(e.form){var h=o.byId(e.form),p=h.getAttributeNode("action");c.url=c.url||(p?p.value:null),u=a.toObject(h)}var f=[{}];u&&f.push(u),e.content&&f.push(e.content),e.preventCache&&f.push({"dojo.preventCache":(new Date).valueOf()}),c.query=n.objectToQuery(l.mixin.apply(null,f)),c.handleAs=e.handleAs||"text";var m=new r(function(t){t.canceled=!0,i&&i(t);var e=t.ioArgs.error;return e||(e=new Error("request cancelled"),e.dojoType="cancel",t.ioArgs.error=e),e});m.addCallback(s);var b=e.load;b&&l.isFunction(b)&&m.addCallback(function(t){return b.call(e,t,c)});var _=e.error;_&&l.isFunction(_)&&m.addErrback(function(t){return _.call(e,t,c)});var j=e.handle;return j&&l.isFunction(j)&&m.addBoth(function(t){return j.call(e,t,c)}),m.addErrback(function(t){return d(t,m)}),g.ioPublish&&t.publish&&c.args.ioPublish!==!1&&(m.addCallbacks(function(e){return t.publish("/dojo/io/load",[m,e]),e},function(e){return t.publish("/dojo/io/error",[m,e]),e}),m.addBoth(function(e){return t.publish("/dojo/io/done",[m,e]),e})),m.ioArgs=c,m};var _=function(t){var e=b[t.ioArgs.handleAs](t.ioArgs.xhr);return void 0===e?null:e},j=function(t,e){return!e.ioArgs.args.failOk,t},v=function(e){0>=y&&(y=0,g.ioPublish&&t.publish&&(!e||e&&e.ioArgs.args.ioPublish!==!1)&&t.publish("/dojo/io/stop"))},y=0;h.after(p,"_onAction",function(){y-=1}),h.after(p,"_onInFlight",v),t._ioCancelAll=p.cancelAll,t._ioNotifyStart=function(e){g.ioPublish&&t.publish&&e.ioArgs.args.ioPublish!==!1&&(y||t.publish("/dojo/io/start"),y+=1,t.publish("/dojo/io/send",[e]))},t._ioWatch=function(t,e,i,n){t.ioArgs.options=t.ioArgs.args;l.mixin(t,{response:t.ioArgs,isValid:function(i){return e(t)},isReady:function(e){return i(t)},handleResponse:function(e){return n(t)}}),p(t),v(t)};return t._ioAddQueryToUrl=function(t){t.query.length&&(t.url+=(-1==t.url.indexOf("?")?"?":"&")+t.query,t.query=null)},t.xhr=function(e,i,n){var o,a=t._ioSetArgs(i,function(t){o&&o.cancel()},_,j),r=a.ioArgs;"postData"in i?r.query=i.postData:"putData"in i?r.query=i.putData:"rawBody"in i?r.query=i.rawBody:(arguments.length>2&&!n||-1==="POST|PUT".indexOf(e.toUpperCase()))&&t._ioAddQueryToUrl(r);var s={method:e,handleAs:"text",timeout:i.timeout,withCredentials:i.withCredentials,ioArgs:r};"undefined"!=typeof i.headers&&(s.headers=i.headers),"undefined"!=typeof i.contentType&&(s.headers||(s.headers={}),s.headers["Content-Type"]=i.contentType),"undefined"!=typeof r.query&&(s.data=r.query),"undefined"!=typeof i.sync&&(s.sync=i.sync),t._ioNotifyStart(a);try{o=f(r.url,s,!0)}catch(d){return a.cancel(),a}return a.ioArgs.xhr=o.response.xhr,o.then(function(){a.resolve(a)}).otherwise(function(t){r.error=t,t.response&&(t.status=t.response.status,t.responseText=t.response.text,t.xhr=t.response.xhr),a.reject(t)}),a},t.xhrGet=function(e){return t.xhr("GET",e)},t.rawXhrPost=t.xhrPost=function(e){return t.xhr("POST",e,!0)},t.rawXhrPut=t.xhrPut=function(e){return t.xhr("PUT",e,!0)},t.xhrDelete=function(e){return t.xhr("DELETE",e)},t._isDocumentOk=function(t){return m.checkStatus(t.status)},t._getText=function(e){var i;return t.xhrGet({url:e,sync:!0,load:function(t){i=t}}),i},l.mixin(t.xhr,{_xhrObj:t._xhrObj,fieldToObject:a.fieldToObject,formToObject:a.toObject,objectToQuery:n.objectToQuery,formToQuery:a.toQuery,formToJson:a.toJson,queryToObject:n.queryToObject,contentHandlers:b,_ioSetArgs:t._ioSetArgs,_ioCancelAll:t._ioCancelAll,_ioNotifyStart:t._ioNotifyStart,_ioWatch:t._ioWatch,_ioAddQueryToUrl:t._ioAddQueryToUrl,_isDocumentOk:t._isDocumentOk,_getText:t._getText,get:t.xhrGet,post:t.xhrPost,put:t.xhrPut,del:t.xhrDelete}),t.xhr});//# sourceMappingURL=xhr.js.map