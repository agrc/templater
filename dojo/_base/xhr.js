//>>built
define("dojo/_base/xhr",["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(e,t,i,o,n,r,a,s,d,l,u,c,h,p,f,m){e._xhrObj=f._create;var g=e.config;e.objectToQuery=o.objectToQuery,e.queryToObject=o.queryToObject,e.fieldToObject=r.fieldToObject,e.formToObject=r.toObject,e.formToQuery=r.toQuery,e.formToJson=r.toJson,e._blockAsync=!1;var _=e._contentHandlers=e.contentHandlers={text:function(e){return e.responseText},json:function(e){return d.fromJson(e.responseText||null)},"json-comment-filtered":function(e){!s.useCommentedJson;var t=e.responseText,i=t.indexOf("/*"),o=t.lastIndexOf("*/");if(-1==i||-1==o)throw new Error("JSON was not comment filtered");return d.fromJson(t.substring(i+2,o))},javascript:function(t){return e.eval(t.responseText)},xml:function(e){var i=e.responseXML;if(i&&t("dom-qsa2.1")&&!i.querySelectorAll&&t("dom-parser")&&(i=(new DOMParser).parseFromString(e.responseText,"application/xml")),t("ie")&&(!i||!i.documentElement)){var o=function(e){return"MSXML"+e+".DOMDocument"},n=["Microsoft.XMLDOM",o(6),o(4),o(3),o(2)];u.some(n,function(t){try{var o=new ActiveXObject(t);o.async=!1,o.loadXML(e.responseText),i=o}catch(n){return!1}return!0})}return i},"json-comment-optional":function(e){return e.responseText&&/^[^{\[]*\/\*/.test(e.responseText)?_["json-comment-filtered"](e):_.json(e)}};e._ioSetArgs=function(t,i,s,d){var u={args:t,url:t.url},c=null;if(t.form){var h=n.byId(t.form),p=h.getAttributeNode("action");u.url=u.url||(p?p.value:null),c=r.toObject(h)}var f=[{}];c&&f.push(c),t.content&&f.push(t.content),t.preventCache&&f.push({"dojo.preventCache":(new Date).valueOf()}),u.query=o.objectToQuery(l.mixin.apply(null,f)),u.handleAs=t.handleAs||"text";var m=new a(function(e){e.canceled=!0,i&&i(e);var t=e.ioArgs.error;return t||(t=new Error("request cancelled"),t.dojoType="cancel",e.ioArgs.error=t),t});m.addCallback(s);var _=t.load;_&&l.isFunction(_)&&m.addCallback(function(e){return _.call(t,e,u)});var b=t.error;b&&l.isFunction(b)&&m.addErrback(function(e){return b.call(t,e,u)});var v=t.handle;return v&&l.isFunction(v)&&m.addBoth(function(e){return v.call(t,e,u)}),m.addErrback(function(e){return d(e,m)}),g.ioPublish&&e.publish&&u.args.ioPublish!==!1&&(m.addCallbacks(function(t){return e.publish("/dojo/io/load",[m,t]),t},function(t){return e.publish("/dojo/io/error",[m,t]),t}),m.addBoth(function(t){return e.publish("/dojo/io/done",[m,t]),t})),m.ioArgs=u,m};var b=function(e){var t=_[e.ioArgs.handleAs](e.ioArgs.xhr);return void 0===t?null:t},v=function(e,t){return!t.ioArgs.args.failOk,e},y=function(t){0>=j&&(j=0,g.ioPublish&&e.publish&&(!t||t&&t.ioArgs.args.ioPublish!==!1)&&e.publish("/dojo/io/stop"))},j=0;h.after(p,"_onAction",function(){j-=1}),h.after(p,"_onInFlight",y),e._ioCancelAll=p.cancelAll,e._ioNotifyStart=function(t){g.ioPublish&&e.publish&&t.ioArgs.args.ioPublish!==!1&&(j||e.publish("/dojo/io/start"),j+=1,e.publish("/dojo/io/send",[t]))},e._ioWatch=function(e,t,i,o){e.ioArgs.options=e.ioArgs.args;l.mixin(e,{response:e.ioArgs,isValid:function(i){return t(e)},isReady:function(t){return i(e)},handleResponse:function(t){return o(e)}}),p(e),y(e)};return e._ioAddQueryToUrl=function(e){e.query.length&&(e.url+=(-1==e.url.indexOf("?")?"?":"&")+e.query,e.query=null)},e.xhr=function(t,i,o){var n,r=e._ioSetArgs(i,function(e){n&&n.cancel()},b,v),a=r.ioArgs;"postData"in i?a.query=i.postData:"putData"in i?a.query=i.putData:"rawBody"in i?a.query=i.rawBody:(arguments.length>2&&!o||-1==="POST|PUT".indexOf(t.toUpperCase()))&&e._ioAddQueryToUrl(a);var s={method:t,handleAs:"text",timeout:i.timeout,withCredentials:i.withCredentials,ioArgs:a};"undefined"!=typeof i.headers&&(s.headers=i.headers),"undefined"!=typeof i.contentType&&(s.headers||(s.headers={}),s.headers["Content-Type"]=i.contentType),"undefined"!=typeof a.query&&(s.data=a.query),"undefined"!=typeof i.sync&&(s.sync=i.sync),e._ioNotifyStart(r);try{n=f(a.url,s,!0)}catch(d){return r.cancel(),r}return r.ioArgs.xhr=n.response.xhr,n.then(function(){r.resolve(r)}).otherwise(function(e){a.error=e,e.response&&(e.status=e.response.status,e.responseText=e.response.text,e.xhr=e.response.xhr),r.reject(e)}),r},e.xhrGet=function(t){return e.xhr("GET",t)},e.rawXhrPost=e.xhrPost=function(t){return e.xhr("POST",t,!0)},e.rawXhrPut=e.xhrPut=function(t){return e.xhr("PUT",t,!0)},e.xhrDelete=function(t){return e.xhr("DELETE",t)},e._isDocumentOk=function(e){return m.checkStatus(e.status)},e._getText=function(t){var i;return e.xhrGet({url:t,sync:!0,load:function(e){i=e}}),i},l.mixin(e.xhr,{_xhrObj:e._xhrObj,fieldToObject:r.fieldToObject,formToObject:r.toObject,objectToQuery:o.objectToQuery,formToQuery:r.toQuery,formToJson:r.toJson,queryToObject:o.queryToObject,contentHandlers:_,_ioSetArgs:e._ioSetArgs,_ioCancelAll:e._ioCancelAll,_ioNotifyStart:e._ioNotifyStart,_ioWatch:e._ioWatch,_ioAddQueryToUrl:e._ioAddQueryToUrl,_isDocumentOk:e._isDocumentOk,_getText:e._getText,get:e.xhrGet,post:e.xhrPost,put:e.xhrPut,del:e.xhrDelete}),e.xhr});//# sourceMappingURL=xhr.js.map