//>>built
define("dojo/_base/xhr",["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(e,t,i,n,o,a,r,s,d,l,u,c,h,f,p,m){e._xhrObj=p._create;var g=e.config;e.objectToQuery=n.objectToQuery,e.queryToObject=n.queryToObject,e.fieldToObject=a.fieldToObject,e.formToObject=a.toObject,e.formToQuery=a.toQuery,e.formToJson=a.toJson,e._blockAsync=!1;var b=e._contentHandlers=e.contentHandlers={text:function(e){return e.responseText},json:function(e){return d.fromJson(e.responseText||null)},"json-comment-filtered":function(e){!s.useCommentedJson;var t=e.responseText,i=t.indexOf("/*"),n=t.lastIndexOf("*/");if(-1==i||-1==n)throw new Error("JSON was not comment filtered");return d.fromJson(t.substring(i+2,n))},javascript:function(t){return e.eval(t.responseText)},xml:function(e){var i=e.responseXML;if(i&&t("dom-qsa2.1")&&!i.querySelectorAll&&t("dom-parser")&&(i=(new DOMParser).parseFromString(e.responseText,"application/xml")),t("ie")&&(!i||!i.documentElement)){var n=function(e){return"MSXML"+e+".DOMDocument"},o=["Microsoft.XMLDOM",n(6),n(4),n(3),n(2)];u.some(o,function(t){try{var n=new ActiveXObject(t);n.async=!1,n.loadXML(e.responseText),i=n}catch(o){return!1}return!0})}return i},"json-comment-optional":function(e){return e.responseText&&/^[^{\[]*\/\*/.test(e.responseText)?b["json-comment-filtered"](e):b.json(e)}};e._ioSetArgs=function(t,i,s,d){var u={args:t,url:t.url},c=null;if(t.form){var h=o.byId(t.form),f=h.getAttributeNode("action");u.url=u.url||(f?f.value:null),c=a.toObject(h)}var p=[{}];c&&p.push(c),t.content&&p.push(t.content),t.preventCache&&p.push({"dojo.preventCache":(new Date).valueOf()}),u.query=n.objectToQuery(l.mixin.apply(null,p)),u.handleAs=t.handleAs||"text";var m=new r(function(e){e.canceled=!0,i&&i(e);var t=e.ioArgs.error;return t||(t=new Error("request cancelled"),t.dojoType="cancel",e.ioArgs.error=t),t});m.addCallback(s);var b=t.load;b&&l.isFunction(b)&&m.addCallback(function(e){return b.call(t,e,u)});var j=t.error;j&&l.isFunction(j)&&m.addErrback(function(e){return j.call(t,e,u)});var _=t.handle;return _&&l.isFunction(_)&&m.addBoth(function(e){return _.call(t,e,u)}),m.addErrback(function(e){return d(e,m)}),g.ioPublish&&e.publish&&u.args.ioPublish!==!1&&(m.addCallbacks(function(t){return e.publish("/dojo/io/load",[m,t]),t},function(t){return e.publish("/dojo/io/error",[m,t]),t}),m.addBoth(function(t){return e.publish("/dojo/io/done",[m,t]),t})),m.ioArgs=u,m};var j=function(e){var t=b[e.ioArgs.handleAs](e.ioArgs.xhr);return void 0===t?null:t},_=function(e,t){return!t.ioArgs.args.failOk,e},v=function(t){0>=y&&(y=0,g.ioPublish&&e.publish&&(!t||t&&t.ioArgs.args.ioPublish!==!1)&&e.publish("/dojo/io/stop"))},y=0;h.after(f,"_onAction",function(){y-=1}),h.after(f,"_onInFlight",v),e._ioCancelAll=f.cancelAll,e._ioNotifyStart=function(t){g.ioPublish&&e.publish&&t.ioArgs.args.ioPublish!==!1&&(y||e.publish("/dojo/io/start"),y+=1,e.publish("/dojo/io/send",[t]))},e._ioWatch=function(e,t,i,n){e.ioArgs.options=e.ioArgs.args;l.mixin(e,{response:e.ioArgs,isValid:function(i){return t(e)},isReady:function(t){return i(e)},handleResponse:function(t){return n(e)}}),f(e),v(e)};return e._ioAddQueryToUrl=function(e){e.query.length&&(e.url+=(-1==e.url.indexOf("?")?"?":"&")+e.query,e.query=null)},e.xhr=function(t,i,n){var o,a=e._ioSetArgs(i,function(e){o&&o.cancel()},j,_),r=a.ioArgs;"postData"in i?r.query=i.postData:"putData"in i?r.query=i.putData:"rawBody"in i?r.query=i.rawBody:(arguments.length>2&&!n||-1==="POST|PUT".indexOf(t.toUpperCase()))&&e._ioAddQueryToUrl(r);var s={method:t,handleAs:"text",timeout:i.timeout,withCredentials:i.withCredentials,ioArgs:r};"undefined"!=typeof i.headers&&(s.headers=i.headers),"undefined"!=typeof i.contentType&&(s.headers||(s.headers={}),s.headers["Content-Type"]=i.contentType),"undefined"!=typeof r.query&&(s.data=r.query),"undefined"!=typeof i.sync&&(s.sync=i.sync),e._ioNotifyStart(a);try{o=p(r.url,s,!0)}catch(d){return a.cancel(),a}return a.ioArgs.xhr=o.response.xhr,o.then(function(){a.resolve(a)}).otherwise(function(e){r.error=e,e.response&&(e.status=e.response.status,e.responseText=e.response.text,e.xhr=e.response.xhr),a.reject(e)}),a},e.xhrGet=function(t){return e.xhr("GET",t)},e.rawXhrPost=e.xhrPost=function(t){return e.xhr("POST",t,!0)},e.rawXhrPut=e.xhrPut=function(t){return e.xhr("PUT",t,!0)},e.xhrDelete=function(t){return e.xhr("DELETE",t)},e._isDocumentOk=function(e){return m.checkStatus(e.status)},e._getText=function(t){var i;return e.xhrGet({url:t,sync:!0,load:function(e){i=e}}),i},l.mixin(e.xhr,{_xhrObj:e._xhrObj,fieldToObject:a.fieldToObject,formToObject:a.toObject,objectToQuery:n.objectToQuery,formToQuery:a.toQuery,formToJson:a.toJson,queryToObject:n.queryToObject,contentHandlers:b,_ioSetArgs:e._ioSetArgs,_ioCancelAll:e._ioCancelAll,_ioNotifyStart:e._ioNotifyStart,_ioWatch:e._ioWatch,_ioAddQueryToUrl:e._ioAddQueryToUrl,_isDocumentOk:e._isDocumentOk,_getText:e._getText,get:e.xhrGet,post:e.xhrPost,put:e.xhrPut,del:e.xhrDelete}),e.xhr});//# sourceMappingURL=xhr.js.map