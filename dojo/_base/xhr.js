//>>built
define("dojo/_base/xhr",["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(e,t,i,n,o,r,a,s,d,l,c,u,h,f,p,m){e._xhrObj=p._create;var g=e.config;e.objectToQuery=n.objectToQuery,e.queryToObject=n.queryToObject,e.fieldToObject=r.fieldToObject,e.formToObject=r.toObject,e.formToQuery=r.toQuery,e.formToJson=r.toJson,e._blockAsync=!1;var v=e._contentHandlers=e.contentHandlers={text:function(e){return e.responseText},json:function(e){return d.fromJson(e.responseText||null)},"json-comment-filtered":function(e){!s.useCommentedJson;var t=e.responseText,i=t.indexOf("/*"),n=t.lastIndexOf("*/");if(-1==i||-1==n)throw new Error("JSON was not comment filtered");return d.fromJson(t.substring(i+2,n))},javascript:function(t){return e.eval(t.responseText)},xml:function(e){var i=e.responseXML;if(i&&t("dom-qsa2.1")&&!i.querySelectorAll&&t("dom-parser")&&(i=(new DOMParser).parseFromString(e.responseText,"application/xml")),t("ie")&&(!i||!i.documentElement)){var n=function(e){return"MSXML"+e+".DOMDocument"},o=["Microsoft.XMLDOM",n(6),n(4),n(3),n(2)];c.some(o,function(t){try{var n=new ActiveXObject(t);n.async=!1,n.loadXML(e.responseText),i=n}catch(o){return!1}return!0})}return i},"json-comment-optional":function(e){return e.responseText&&/^[^{\[]*\/\*/.test(e.responseText)?v["json-comment-filtered"](e):v.json(e)}};e._ioSetArgs=function(t,i,s,d){var c={args:t,url:t.url},u=null;if(t.form){var h=o.byId(t.form),f=h.getAttributeNode("action");c.url=c.url||(f?f.value:null),u=r.toObject(h)}var p=[{}];u&&p.push(u),t.content&&p.push(t.content),t.preventCache&&p.push({"dojo.preventCache":(new Date).valueOf()}),c.query=n.objectToQuery(l.mixin.apply(null,p)),c.handleAs=t.handleAs||"text";var m=new a(function(e){e.canceled=!0,i&&i(e);var t=e.ioArgs.error;return t||(t=new Error("request cancelled"),t.dojoType="cancel",e.ioArgs.error=t),t});m.addCallback(s);var v=t.load;v&&l.isFunction(v)&&m.addCallback(function(e){return v.call(t,e,c)});var _=t.error;_&&l.isFunction(_)&&m.addErrback(function(e){return _.call(t,e,c)});var b=t.handle;return b&&l.isFunction(b)&&m.addBoth(function(e){return b.call(t,e,c)}),m.addErrback(function(e){return d(e,m)}),g.ioPublish&&e.publish&&c.args.ioPublish!==!1&&(m.addCallbacks(function(t){return e.publish("/dojo/io/load",[m,t]),t},function(t){return e.publish("/dojo/io/error",[m,t]),t}),m.addBoth(function(t){return e.publish("/dojo/io/done",[m,t]),t})),m.ioArgs=c,m};var _=function(e){var t=v[e.ioArgs.handleAs](e.ioArgs.xhr);return void 0===t?null:t},b=function(e,t){return!t.ioArgs.args.failOk,e},y=function(t){0>=C&&(C=0,g.ioPublish&&e.publish&&(!t||t&&t.ioArgs.args.ioPublish!==!1)&&e.publish("/dojo/io/stop"))},C=0;h.after(f,"_onAction",function(){C-=1}),h.after(f,"_onInFlight",y),e._ioCancelAll=f.cancelAll,e._ioNotifyStart=function(t){g.ioPublish&&e.publish&&t.ioArgs.args.ioPublish!==!1&&(C||e.publish("/dojo/io/start"),C+=1,e.publish("/dojo/io/send",[t]))},e._ioWatch=function(e,t,i,n){e.ioArgs.options=e.ioArgs.args;l.mixin(e,{response:e.ioArgs,isValid:function(i){return t(e)},isReady:function(t){return i(e)},handleResponse:function(t){return n(e)}}),f(e),y(e)};return e._ioAddQueryToUrl=function(e){e.query.length&&(e.url+=(-1==e.url.indexOf("?")?"?":"&")+e.query,e.query=null)},e.xhr=function(t,i,n){var o,r=e._ioSetArgs(i,function(e){o&&o.cancel()},_,b),a=r.ioArgs;"postData"in i?a.query=i.postData:"putData"in i?a.query=i.putData:"rawBody"in i?a.query=i.rawBody:(arguments.length>2&&!n||-1==="POST|PUT".indexOf(t.toUpperCase()))&&e._ioAddQueryToUrl(a);var s={method:t,handleAs:"text",timeout:i.timeout,withCredentials:i.withCredentials,ioArgs:a};"undefined"!=typeof i.headers&&(s.headers=i.headers),"undefined"!=typeof i.contentType&&(s.headers||(s.headers={}),s.headers["Content-Type"]=i.contentType),"undefined"!=typeof a.query&&(s.data=a.query),"undefined"!=typeof i.sync&&(s.sync=i.sync),e._ioNotifyStart(r);try{o=p(a.url,s,!0)}catch(d){return r.cancel(),r}return r.ioArgs.xhr=o.response.xhr,o.then(function(){r.resolve(r)}).otherwise(function(e){a.error=e,e.response&&(e.status=e.response.status,e.responseText=e.response.text,e.xhr=e.response.xhr),r.reject(e)}),r},e.xhrGet=function(t){return e.xhr("GET",t)},e.rawXhrPost=e.xhrPost=function(t){return e.xhr("POST",t,!0)},e.rawXhrPut=e.xhrPut=function(t){return e.xhr("PUT",t,!0)},e.xhrDelete=function(t){return e.xhr("DELETE",t)},e._isDocumentOk=function(e){return m.checkStatus(e.status)},e._getText=function(t){var i;return e.xhrGet({url:t,sync:!0,load:function(e){i=e}}),i},l.mixin(e.xhr,{_xhrObj:e._xhrObj,fieldToObject:r.fieldToObject,formToObject:r.toObject,objectToQuery:n.objectToQuery,formToQuery:r.toQuery,formToJson:r.toJson,queryToObject:n.queryToObject,contentHandlers:v,_ioSetArgs:e._ioSetArgs,_ioCancelAll:e._ioCancelAll,_ioNotifyStart:e._ioNotifyStart,_ioWatch:e._ioWatch,_ioAddQueryToUrl:e._ioAddQueryToUrl,_isDocumentOk:e._isDocumentOk,_getText:e._getText,get:e.xhrGet,post:e.xhrPost,put:e.xhrPut,del:e.xhrDelete}),e.xhr});//# sourceMappingURL=xhr.js.map