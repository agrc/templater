//>>built
define("dojo/_base/xhr",["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(t,e,i,o,n,a,s,r,d,l,u,c,h,p,f,g){t._xhrObj=f._create;var m=t.config;t.objectToQuery=o.objectToQuery,t.queryToObject=o.queryToObject,t.fieldToObject=a.fieldToObject,t.formToObject=a.toObject,t.formToQuery=a.toQuery,t.formToJson=a.toJson,t._blockAsync=!1;var _=t._contentHandlers=t.contentHandlers={text:function(t){return t.responseText},json:function(t){return d.fromJson(t.responseText||null)},"json-comment-filtered":function(t){!r.useCommentedJson;var e=t.responseText,i=e.indexOf("/*"),o=e.lastIndexOf("*/");if(-1==i||-1==o)throw new Error("JSON was not comment filtered");return d.fromJson(e.substring(i+2,o))},javascript:function(e){return t.eval(e.responseText)},xml:function(t){var i=t.responseXML;if(i&&e("dom-qsa2.1")&&!i.querySelectorAll&&e("dom-parser")&&(i=(new DOMParser).parseFromString(t.responseText,"application/xml")),e("ie")&&(!i||!i.documentElement)){var o=function(t){return"MSXML"+t+".DOMDocument"},n=["Microsoft.XMLDOM",o(6),o(4),o(3),o(2)];u.some(n,function(e){try{var o=new ActiveXObject(e);o.async=!1,o.loadXML(t.responseText),i=o}catch(n){return!1}return!0})}return i},"json-comment-optional":function(t){return t.responseText&&/^[^{\[]*\/\*/.test(t.responseText)?_["json-comment-filtered"](t):_.json(t)}};t._ioSetArgs=function(e,i,r,d){var u={args:e,url:e.url},c=null;if(e.form){var h=n.byId(e.form),p=h.getAttributeNode("action");u.url=u.url||(p?p.value:null),c=a.toObject(h)}var f=[{}];c&&f.push(c),e.content&&f.push(e.content),e.preventCache&&f.push({"dojo.preventCache":(new Date).valueOf()}),u.query=o.objectToQuery(l.mixin.apply(null,f)),u.handleAs=e.handleAs||"text";var g=new s(function(t){t.canceled=!0,i&&i(t);var e=t.ioArgs.error;return e||(e=new Error("request cancelled"),e.dojoType="cancel",t.ioArgs.error=e),e});g.addCallback(r);var _=e.load;_&&l.isFunction(_)&&g.addCallback(function(t){return _.call(e,t,u)});var b=e.error;b&&l.isFunction(b)&&g.addErrback(function(t){return b.call(e,t,u)});var j=e.handle;return j&&l.isFunction(j)&&g.addBoth(function(t){return j.call(e,t,u)}),g.addErrback(function(t){return d(t,g)}),m.ioPublish&&t.publish&&u.args.ioPublish!==!1&&(g.addCallbacks(function(e){return t.publish("/dojo/io/load",[g,e]),e},function(e){return t.publish("/dojo/io/error",[g,e]),e}),g.addBoth(function(e){return t.publish("/dojo/io/done",[g,e]),e})),g.ioArgs=u,g};var b=function(t){var e=_[t.ioArgs.handleAs](t.ioArgs.xhr);return void 0===e?null:e},j=function(t,e){return!e.ioArgs.args.failOk,t},v=function(e){0>=y&&(y=0,m.ioPublish&&t.publish&&(!e||e&&e.ioArgs.args.ioPublish!==!1)&&t.publish("/dojo/io/stop"))},y=0;h.after(p,"_onAction",function(){y-=1}),h.after(p,"_onInFlight",v),t._ioCancelAll=p.cancelAll,t._ioNotifyStart=function(e){m.ioPublish&&t.publish&&e.ioArgs.args.ioPublish!==!1&&(y||t.publish("/dojo/io/start"),y+=1,t.publish("/dojo/io/send",[e]))},t._ioWatch=function(t,e,i,o){t.ioArgs.options=t.ioArgs.args;l.mixin(t,{response:t.ioArgs,isValid:function(i){return e(t)},isReady:function(e){return i(t)},handleResponse:function(e){return o(t)}}),p(t),v(t)};return t._ioAddQueryToUrl=function(t){t.query.length&&(t.url+=(-1==t.url.indexOf("?")?"?":"&")+t.query,t.query=null)},t.xhr=function(e,i,o){var n,a=t._ioSetArgs(i,function(t){n&&n.cancel()},b,j),s=a.ioArgs;"postData"in i?s.query=i.postData:"putData"in i?s.query=i.putData:"rawBody"in i?s.query=i.rawBody:(arguments.length>2&&!o||-1==="POST|PUT".indexOf(e.toUpperCase()))&&t._ioAddQueryToUrl(s);var r={method:e,handleAs:"text",timeout:i.timeout,withCredentials:i.withCredentials,ioArgs:s};"undefined"!=typeof i.headers&&(r.headers=i.headers),"undefined"!=typeof i.contentType&&(r.headers||(r.headers={}),r.headers["Content-Type"]=i.contentType),"undefined"!=typeof s.query&&(r.data=s.query),"undefined"!=typeof i.sync&&(r.sync=i.sync),t._ioNotifyStart(a);try{n=f(s.url,r,!0)}catch(d){return a.cancel(),a}return a.ioArgs.xhr=n.response.xhr,n.then(function(){a.resolve(a)}).otherwise(function(t){s.error=t,t.response&&(t.status=t.response.status,t.responseText=t.response.text,t.xhr=t.response.xhr),a.reject(t)}),a},t.xhrGet=function(e){return t.xhr("GET",e)},t.rawXhrPost=t.xhrPost=function(e){return t.xhr("POST",e,!0)},t.rawXhrPut=t.xhrPut=function(e){return t.xhr("PUT",e,!0)},t.xhrDelete=function(e){return t.xhr("DELETE",e)},t._isDocumentOk=function(t){return g.checkStatus(t.status)},t._getText=function(e){var i;return t.xhrGet({url:e,sync:!0,load:function(t){i=t}}),i},l.mixin(t.xhr,{_xhrObj:t._xhrObj,fieldToObject:a.fieldToObject,formToObject:a.toObject,objectToQuery:o.objectToQuery,formToQuery:a.toQuery,formToJson:a.toJson,queryToObject:o.queryToObject,contentHandlers:_,_ioSetArgs:t._ioSetArgs,_ioCancelAll:t._ioCancelAll,_ioNotifyStart:t._ioNotifyStart,_ioWatch:t._ioWatch,_ioAddQueryToUrl:t._ioAddQueryToUrl,_isDocumentOk:t._isDocumentOk,_getText:t._getText,get:t.xhrGet,post:t.xhrPost,put:t.xhrPut,del:t.xhrDelete}),t.xhr});//# sourceMappingURL=xhr.js.map