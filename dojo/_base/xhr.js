//>>built
define("dojo/_base/xhr",["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(e,t,i,o,n,r,s,a,d,c,l,u,h,f,m,p){e._xhrObj=m._create;var g=e.config;e.objectToQuery=o.objectToQuery,e.queryToObject=o.queryToObject,e.fieldToObject=r.fieldToObject,e.formToObject=r.toObject,e.formToQuery=r.toQuery,e.formToJson=r.toJson,e._blockAsync=!1;var b=e._contentHandlers=e.contentHandlers={text:function(e){return e.responseText},json:function(e){return d.fromJson(e.responseText||null)},"json-comment-filtered":function(e){a.useCommentedJson;var t=e.responseText,i=t.indexOf("/*"),o=t.lastIndexOf("*/");if(-1==i||-1==o)throw new Error("JSON was not comment filtered");return d.fromJson(t.substring(i+2,o))},javascript:function(t){return e.eval(t.responseText)},xml:function(e){var i=e.responseXML;if(i&&t("dom-qsa2.1")&&!i.querySelectorAll&&t("dom-parser")&&(i=(new DOMParser).parseFromString(e.responseText,"application/xml")),t("ie")&&(!i||!i.documentElement)){var o=function(e){return"MSXML"+e+".DOMDocument"},n=["Microsoft.XMLDOM",o(6),o(4),o(3),o(2)];l.some(n,function(t){try{var o=new ActiveXObject(t);o.async=!1,o.loadXML(e.responseText),i=o}catch(e){return!1}return!0})}return i},"json-comment-optional":function(e){return e.responseText&&/^[^{\[]*\/\*/.test(e.responseText)?b["json-comment-filtered"](e):b.json(e)}};e._ioSetArgs=function(t,i,a,d){var l={args:t,url:t.url},u=null;if(t.form){var h=n.byId(t.form),f=h.getAttributeNode("action");l.url=l.url||(f?f.value:e.doc?e.doc.URL:null),u=r.toObject(h)}var m=[{}];u&&m.push(u),t.content&&m.push(t.content),t.preventCache&&m.push({"dojo.preventCache":(new Date).valueOf()}),l.query=o.objectToQuery(c.mixin.apply(null,m)),l.handleAs=t.handleAs||"text";var p=new s(function(e){e.canceled=!0,i&&i(e);var t=e.ioArgs.error;return t||(t=new Error("request cancelled"),t.dojoType="cancel",e.ioArgs.error=t),t});p.addCallback(a);var b=t.load;b&&c.isFunction(b)&&p.addCallback(function(e){return b.call(t,e,l)});var v=t.error;v&&c.isFunction(v)&&p.addErrback(function(e){return v.call(t,e,l)});var j=t.handle;return j&&c.isFunction(j)&&p.addBoth(function(e){return j.call(t,e,l)}),p.addErrback(function(e){return d(e,p)}),g.ioPublish&&e.publish&&!1!==l.args.ioPublish&&(p.addCallbacks(function(t){return e.publish("/dojo/io/load",[p,t]),t},function(t){return e.publish("/dojo/io/error",[p,t]),t}),p.addBoth(function(t){return e.publish("/dojo/io/done",[p,t]),t})),p.ioArgs=l,p};var v=function(e){var t=b[e.ioArgs.handleAs](e.ioArgs.xhr);return void 0===t?null:t},j=function(e,t){return t.ioArgs.args.failOk,e},_=function(t){y<=0&&(y=0,g.ioPublish&&e.publish&&(!t||t&&!1!==t.ioArgs.args.ioPublish)&&e.publish("/dojo/io/stop"))},y=0;h.after(f,"_onAction",function(){y-=1}),h.after(f,"_onInFlight",_),e._ioCancelAll=f.cancelAll,e._ioNotifyStart=function(t){g.ioPublish&&e.publish&&!1!==t.ioArgs.args.ioPublish&&(y||e.publish("/dojo/io/start"),y+=1,e.publish("/dojo/io/send",[t]))},e._ioWatch=function(e,t,i,o){e.ioArgs.options=e.ioArgs.args;c.mixin(e,{response:e.ioArgs,isValid:function(i){return t(e)},isReady:function(t){return i(e)},handleResponse:function(t){return o(e)}}),f(e),_(e)};return e._ioAddQueryToUrl=function(e){e.query.length&&(e.url+=(-1==e.url.indexOf("?")?"?":"&")+e.query,e.query=null)},e.xhr=function(t,i,o){var n,r=e._ioSetArgs(i,function(e){n&&n.cancel()},v,j),s=r.ioArgs;"postData"in i?s.query=i.postData:"putData"in i?s.query=i.putData:"rawBody"in i?s.query=i.rawBody:(arguments.length>2&&!o||-1==="POST|PUT".indexOf(t.toUpperCase()))&&e._ioAddQueryToUrl(s);var a={method:t,handleAs:"text",timeout:i.timeout,withCredentials:i.withCredentials,ioArgs:s};void 0!==i.headers&&(a.headers=i.headers),void 0!==i.contentType&&(a.headers||(a.headers={}),a.headers["Content-Type"]=i.contentType),void 0!==s.query&&(a.data=s.query),void 0!==i.sync&&(a.sync=i.sync),e._ioNotifyStart(r);try{n=m(s.url,a,!0)}catch(e){return r.cancel(),r}return r.ioArgs.xhr=n.response.xhr,n.then(function(){r.resolve(r)}).otherwise(function(e){s.error=e,e.response&&(e.status=e.response.status,e.responseText=e.response.text,e.xhr=e.response.xhr),r.reject(e)}),r},e.xhrGet=function(t){return e.xhr("GET",t)},e.rawXhrPost=e.xhrPost=function(t){return e.xhr("POST",t,!0)},e.rawXhrPut=e.xhrPut=function(t){return e.xhr("PUT",t,!0)},e.xhrDelete=function(t){return e.xhr("DELETE",t)},e._isDocumentOk=function(e){return p.checkStatus(e.status)},e._getText=function(t){var i;return e.xhrGet({url:t,sync:!0,load:function(e){i=e}}),i},c.mixin(e.xhr,{_xhrObj:e._xhrObj,fieldToObject:r.fieldToObject,formToObject:r.toObject,objectToQuery:o.objectToQuery,formToQuery:r.toQuery,formToJson:r.toJson,queryToObject:o.queryToObject,contentHandlers:b,_ioSetArgs:e._ioSetArgs,_ioCancelAll:e._ioCancelAll,_ioNotifyStart:e._ioNotifyStart,_ioWatch:e._ioWatch,_ioAddQueryToUrl:e._ioAddQueryToUrl,_isDocumentOk:e._isDocumentOk,_getText:e._getText,get:e.xhrGet,post:e.xhrPost,put:e.xhrPut,del:e.xhrDelete}),e.xhr});//# sourceMappingURL=xhr.js.map