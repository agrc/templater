//>>built
define("dojo/store/DataStore",["../_base/lang","../_base/declare","../Deferred","../_base/array","./util/QueryResults","./util/SimpleQueryEngine"],function(e,t,i,r,a,n){var o=null;return t("dojo.store.DataStore",o,{target:"",constructor:function(t){if(e.mixin(this,t),!("idProperty"in t)){var i;try{i=this.store.getIdentityAttributes()}catch(r){}this.idProperty=(e.isArray(i)?i[0]:i)||this.idProperty}var a=this.store.getFeatures();a["dojo.data.api.Read"]||(this.get=null),a["dojo.data.api.Identity"]||(this.getIdentity=null),a["dojo.data.api.Write"]||(this.put=this.add=null)},idProperty:"id",store:null,queryEngine:n,_objectConverter:function(e){function t(e){for(var a={},n=i.getAttributes(e),o=0;o<n.length;o++){var d=n[o],l=i.getValues(e,d);if(l.length>1){for(var s=0;s<l.length;s++){var u=l[s];"object"==typeof u&&i.isItem(u)&&(l[s]=t(u))}u=l}else{var u=i.getValue(e,d);"object"==typeof u&&i.isItem(u)&&(u=t(u))}a[n[o]]=u}return r in a||!i.getIdentity||(a[r]=i.getIdentity(e)),a}var i=this.store,r=this.idProperty;return function(i){return e(i&&t(i))}},get:function(e,t){var r,a,n=new i;if(this.store.fetchItemByIdentity({identity:e,onItem:this._objectConverter(function(e){n.resolve(r=e)}),onError:function(e){n.reject(a=e)}}),void 0!==r)return null==r?void 0:r;if(a)throw a;return n.promise},put:function(e,t){t=t||{};var r="undefined"!=typeof t.id?t.id:this.getIdentity(e),a=this.store,n=this.idProperty,o=new i;if("undefined"==typeof r){var d=a.newItem(e);a.save({onComplete:function(){o.resolve(d)},onError:function(e){o.reject(e)}})}else a.fetchItemByIdentity({identity:r,onItem:function(i){if(i){if(t.overwrite===!1)return o.reject(new Error("Overwriting existing object not allowed"));for(var r in e)r!=n&&e.hasOwnProperty(r)&&a.getValue(i,r)!=e[r]&&a.setValue(i,r,e[r])}else{if(t.overwrite===!0)return o.reject(new Error("Creating new object not allowed"));var i=a.newItem(e)}a.save({onComplete:function(){o.resolve(i)},onError:function(e){o.reject(e)}})},onError:function(e){o.reject(e)}});return o.promise},add:function(e,t){return(t=t||{}).overwrite=!1,this.put(e,t)},remove:function(e){var t=this.store,r=new i;return this.store.fetchItemByIdentity({identity:e,onItem:function(e){try{null==e?r.resolve(!1):(t.deleteItem(e),t.save(),r.resolve(!0))}catch(i){r.reject(i)}},onError:function(e){r.reject(e)}}),r.promise},query:function(t,n){var o,d=new i(function(){o.abort&&o.abort()});d.total=new i;var l=this._objectConverter(function(e){return e});return o=this.store.fetch(e.mixin({query:t,onBegin:function(e){d.total.resolve(e)},onComplete:function(e){d.resolve(r.map(e,l))},onError:function(e){d.reject(e)}},n)),a(d)},getIdentity:function(e){return e[this.idProperty]}})});//# sourceMappingURL=DataStore.js.map