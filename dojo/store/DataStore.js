//>>built
define("dojo/store/DataStore",["../_base/lang","../_base/declare","../Deferred","../_base/array","./util/QueryResults","./util/SimpleQueryEngine"],function(e,t,i,a,r,n){return t("dojo.store.DataStore",null,{target:"",constructor:function(t){if(e.mixin(this,t),!("idProperty"in t)){var i;try{i=this.store.getIdentityAttributes()}catch(e){}this.idProperty=(e.isArray(i)?i[0]:i)||this.idProperty}var a=this.store.getFeatures();a["dojo.data.api.Read"]||(this.get=null),a["dojo.data.api.Identity"]||(this.getIdentity=null),a["dojo.data.api.Write"]||(this.put=this.add=null)},idProperty:"id",store:null,queryEngine:n,_objectConverter:function(e){function t(e){for(var r={},n=i.getAttributes(e),o=0;o<n.length;o++){var s=n[o],d=i.getValues(e,s);if(d.length>1){for(var l=0;l<d.length;l++){var u=d[l];"object"==typeof u&&i.isItem(u)&&(d[l]=t(u))}u=d}else{var u=i.getValue(e,s);"object"==typeof u&&i.isItem(u)&&(u=t(u))}r[n[o]]=u}return a in r||!i.getIdentity||(r[a]=i.getIdentity(e)),r}var i=this.store,a=this.idProperty;return function(i){return e(i&&t(i))}},get:function(e,t){var a,r,n=new i;if(this.store.fetchItemByIdentity({identity:e,onItem:this._objectConverter(function(e){n.resolve(a=e)}),onError:function(e){n.reject(r=e)}}),void 0!==a)return null==a?void 0:a;if(r)throw r;return n.promise},put:function(e,t){t=t||{};var a=void 0!==t.id?t.id:this.getIdentity(e),r=this.store,n=this.idProperty,o=new i;if(void 0===a){var s=r.newItem(e);r.save({onComplete:function(){o.resolve(s)},onError:function(e){o.reject(e)}})}else r.fetchItemByIdentity({identity:a,onItem:function(i){if(i){if(!1===t.overwrite)return o.reject(new Error("Overwriting existing object not allowed"));for(var a in e)a!=n&&e.hasOwnProperty(a)&&r.getValue(i,a)!=e[a]&&r.setValue(i,a,e[a])}else{if(!0===t.overwrite)return o.reject(new Error("Creating new object not allowed"));var i=r.newItem(e)}r.save({onComplete:function(){o.resolve(i)},onError:function(e){o.reject(e)}})},onError:function(e){o.reject(e)}});return o.promise},add:function(e,t){return(t=t||{}).overwrite=!1,this.put(e,t)},remove:function(e){var t=this.store,a=new i;return this.store.fetchItemByIdentity({identity:e,onItem:function(e){try{null==e?a.resolve(!1):(t.deleteItem(e),t.save(),a.resolve(!0))}catch(e){a.reject(e)}},onError:function(e){a.reject(e)}}),a.promise},query:function(t,n){var o,s=new i(function(){o.abort&&o.abort()});s.total=new i;var d=this._objectConverter(function(e){return e});return o=this.store.fetch(e.mixin({query:t,onBegin:function(e){s.total.resolve(e)},onComplete:function(e){s.resolve(a.map(e,d))},onError:function(e){s.reject(e)}},n)),r(s)},getIdentity:function(e){return e[this.idProperty]}})});//# sourceMappingURL=DataStore.js.map