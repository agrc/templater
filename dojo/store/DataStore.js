//>>built
define("dojo/store/DataStore",["../_base/lang","../_base/declare","../Deferred","../_base/array","./util/QueryResults","./util/SimpleQueryEngine"],function(e,t,a,i,r,o){var n=null;return t("dojo.store.DataStore",n,{target:"",constructor:function(t){if(e.mixin(this,t),!("idProperty"in t)){var a;try{a=this.store.getIdentityAttributes()}catch(i){}this.idProperty=(e.isArray(a)?a[0]:a)||this.idProperty}var r=this.store.getFeatures();r["dojo.data.api.Read"]||(this.get=null),r["dojo.data.api.Identity"]||(this.getIdentity=null),r["dojo.data.api.Write"]||(this.put=this.add=null)},idProperty:"id",store:null,queryEngine:o,_objectConverter:function(e){function t(e){for(var r={},o=a.getAttributes(e),n=0;n<o.length;n++){var d=o[n],s=a.getValues(e,d);if(s.length>1){for(var l=0;l<s.length;l++){var m=s[l];"object"==typeof m&&a.isItem(m)&&(s[l]=t(m))}m=s}else{var m=a.getValue(e,d);"object"==typeof m&&a.isItem(m)&&(m=t(m))}r[o[n]]=m}return i in r||!a.getIdentity||(r[i]=a.getIdentity(e)),r}var a=this.store,i=this.idProperty;return function(a){return e(a&&t(a))}},get:function(e,t){var i,r,o=new a;if(this.store.fetchItemByIdentity({identity:e,onItem:this._objectConverter(function(e){o.resolve(i=e)}),onError:function(e){o.reject(r=e)}}),void 0!==i)return null==i?void 0:i;if(r)throw r;return o.promise},put:function(e,t){t=t||{};var i="undefined"!=typeof t.id?t.id:this.getIdentity(e),r=this.store,o=this.idProperty,n=new a;if("undefined"==typeof i){var d=r.newItem(e);r.save({onComplete:function(){n.resolve(d)},onError:function(e){n.reject(e)}})}else r.fetchItemByIdentity({identity:i,onItem:function(a){if(a){if(t.overwrite===!1)return n.reject(new Error("Overwriting existing object not allowed"));for(var i in e)i!=o&&e.hasOwnProperty(i)&&r.getValue(a,i)!=e[i]&&r.setValue(a,i,e[i])}else{if(t.overwrite===!0)return n.reject(new Error("Creating new object not allowed"));var a=r.newItem(e)}r.save({onComplete:function(){n.resolve(a)},onError:function(e){n.reject(e)}})},onError:function(e){n.reject(e)}});return n.promise},add:function(e,t){return(t=t||{}).overwrite=!1,this.put(e,t)},remove:function(e){var t=this.store,i=new a;return this.store.fetchItemByIdentity({identity:e,onItem:function(e){try{null==e?i.resolve(!1):(t.deleteItem(e),t.save(),i.resolve(!0))}catch(a){i.reject(a)}},onError:function(e){i.reject(e)}}),i.promise},query:function(t,o){var n,d=new a(function(){n.abort&&n.abort()});d.total=new a;var s=this._objectConverter(function(e){return e});return n=this.store.fetch(e.mixin({query:t,onBegin:function(e){d.total.resolve(e)},onComplete:function(e){d.resolve(i.map(e,s))},onError:function(e){d.reject(e)}},o)),r(d)},getIdentity:function(e){return e[this.idProperty]}})});//# sourceMappingURL=DataStore.js.map