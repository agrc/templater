//>>built
define("dojo/dnd/Source",["../_base/array","../_base/declare","../_base/kernel","../_base/lang","../dom-class","../dom-geometry","../mouse","../ready","../topic","./common","./Selector","./Manager"],function(e,t,a,i,r,d,o,n,s,l,m,f){a.isAsync||n(0,function(){var e=["dojo/dnd/AutoSource","dojo/dnd/Target"];require(e)});var h=t("dojo.dnd.Source",m,{isSource:!0,horizontal:!1,copyOnly:!1,selfCopy:!1,selfAccept:!0,skipForm:!1,withHandles:!1,autoSync:!1,delay:0,accept:["text"],generateText:!0,constructor:function(e,t){i.mixin(this,i.mixin({},t));var a=this.accept;if(a.length){this.accept={};for(var d=0;d<a.length;++d)this.accept[a[d]]=1}this.isDragging=!1,this.mouseDown=!1,this.targetAnchor=null,this.targetBox=null,this.before=!0,this._lastX=0,this._lastY=0,this.sourceState="",this.isSource&&r.add(this.node,"dojoDndSource"),this.targetState="",this.accept&&r.add(this.node,"dojoDndTarget"),this.horizontal&&r.add(this.node,"dojoDndHorizontal"),this.topics=[s.subscribe("/dnd/source/over",i.hitch(this,"onDndSourceOver")),s.subscribe("/dnd/start",i.hitch(this,"onDndStart")),s.subscribe("/dnd/drop",i.hitch(this,"onDndDrop")),s.subscribe("/dnd/cancel",i.hitch(this,"onDndCancel"))]},checkAcceptance:function(e,t){if(this==e)return!this.copyOnly||this.selfAccept;for(var a=0;a<t.length;++a){for(var i=e.getItem(t[a].id).type,r=!1,d=0;d<i.length;++d)if(i[d]in this.accept){r=!0;break}if(!r)return!1}return!0},copyState:function(e,t){return e?!0:(arguments.length<2&&(t=this==f.manager().target),t?this.copyOnly?this.selfCopy:!1:this.copyOnly)},destroy:function(){h.superclass.destroy.call(this),e.forEach(this.topics,function(e){e.remove()}),this.targetAnchor=null},onMouseMove:function(e){if(!this.isDragging||"Disabled"!=this.targetState){h.superclass.onMouseMove.call(this,e);var t=f.manager();if(!this.isDragging&&this.mouseDown&&this.isSource&&(Math.abs(e.pageX-this._lastX)>this.delay||Math.abs(e.pageY-this._lastY)>this.delay)){var a=this.getSelectedNodes();a.length&&t.startDrag(this,a,this.copyState(l.getCopyKeyState(e),!0))}if(this.isDragging){var i=!1;this.current&&(this.targetBox&&this.targetAnchor==this.current||(this.targetBox=d.position(this.current,!0)),i=this.horizontal?e.pageX-this.targetBox.x<this.targetBox.w/2==d.isBodyLtr(this.current.ownerDocument):e.pageY-this.targetBox.y<this.targetBox.h/2),this.current==this.targetAnchor&&i==this.before||(this._markTargetAnchor(i),t.canDrop(!(this.current&&t.source==this&&this.current.id in this.selection)))}}},onMouseDown:function(e){this.mouseDown||!this._legalMouseDown(e)||this.skipForm&&l.isFormElement(e)||(this.mouseDown=!0,this._lastX=e.pageX,this._lastY=e.pageY,h.superclass.onMouseDown.call(this,e))},onMouseUp:function(e){this.mouseDown&&(this.mouseDown=!1,h.superclass.onMouseUp.call(this,e))},onDndSourceOver:function(e){if(this!==e)this.mouseDown=!1,this.targetAnchor&&this._unmarkTargetAnchor();else if(this.isDragging){var t=f.manager();t.canDrop(!("Disabled"==this.targetState||this.current&&t.source==this&&this.current.id in this.selection))}},onDndStart:function(e,t,a){this.autoSync&&this.sync(),this.isSource&&this._changeState("Source",this==e?a?"Copied":"Moved":"");var i=this.accept&&this.checkAcceptance(e,t);this._changeState("Target",i?"":"Disabled"),this==e&&f.manager().overSource(this),this.isDragging=!0},onDndDrop:function(e,t,a,i){this==i&&this.onDrop(e,t,a),this.onDndCancel()},onDndCancel:function(){this.targetAnchor&&(this._unmarkTargetAnchor(),this.targetAnchor=null),this.before=!0,this.isDragging=!1,this.mouseDown=!1,this._changeState("Source",""),this._changeState("Target","")},onDrop:function(e,t,a){this!=e?this.onDropExternal(e,t,a):this.onDropInternal(t,a)},onDropExternal:function(e,t,a){var i=this._normalizedCreator;this.creator?this._normalizedCreator=function(t,a){return i.call(this,e.getItem(t.id).data,a)}:a?this._normalizedCreator=function(t){var a=e.getItem(t.id),i=t.cloneNode(!0);return i.id=l.getUniqueId(),{node:i,data:a.data,type:a.type}}:this._normalizedCreator=function(t){var a=e.getItem(t.id);return e.delItem(t.id),{node:t,data:a.data,type:a.type}},this.selectNone(),a||this.creator||e.selectNone(),this.insertNodes(!0,t,this.before,this.current),!a&&this.creator&&e.deleteSelectedNodes(),this._normalizedCreator=i},onDropInternal:function(e,t){var a=this._normalizedCreator;if(!(this.current&&this.current.id in this.selection)){if(t)this.creator?this._normalizedCreator=function(e,t){return a.call(this,this.getItem(e.id).data,t)}:this._normalizedCreator=function(e){var t=this.getItem(e.id),a=e.cloneNode(!0);return a.id=l.getUniqueId(),{node:a,data:t.data,type:t.type}};else{if(!this.current)return;this._normalizedCreator=function(e){var t=this.getItem(e.id);return{node:e,data:t.data,type:t.type}}}this._removeSelection(),this.insertNodes(!0,e,this.before,this.current),this._normalizedCreator=a}},onDraggingOver:function(){},onDraggingOut:function(){},onOverEvent:function(){h.superclass.onOverEvent.call(this),f.manager().overSource(this),this.isDragging&&"Disabled"!=this.targetState&&this.onDraggingOver()},onOutEvent:function(){h.superclass.onOutEvent.call(this),f.manager().outSource(this),this.isDragging&&"Disabled"!=this.targetState&&this.onDraggingOut()},_markTargetAnchor:function(e){this.current==this.targetAnchor&&this.before==e||(this.targetAnchor&&this._removeItemClass(this.targetAnchor,this.before?"Before":"After"),this.targetAnchor=this.current,this.targetBox=null,this.before=e,this.targetAnchor&&this._addItemClass(this.targetAnchor,this.before?"Before":"After"))},_unmarkTargetAnchor:function(){this.targetAnchor&&(this._removeItemClass(this.targetAnchor,this.before?"Before":"After"),this.targetAnchor=null,this.targetBox=null,this.before=!0)},_markDndStatus:function(e){this._changeState("Source",e?"Copied":"Moved")},_legalMouseDown:function(e){if("touchstart"!=e.type&&!o.isLeft(e))return!1;if(!this.withHandles)return!0;for(var t=e.target;t&&t!==this.node;t=t.parentNode){if(r.contains(t,"dojoDndHandle"))return!0;if(r.contains(t,"dojoDndItem")||r.contains(t,"dojoDndIgnore"))break}return!1}});return h});//# sourceMappingURL=Source.js.map