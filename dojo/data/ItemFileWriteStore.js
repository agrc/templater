//>>built
define("dojo/data/ItemFileWriteStore",["../_base/lang","../_base/declare","../_base/array","../_base/json","../_base/kernel","./ItemFileReadStore","../date/stamp"],function(e,t,i,a,r,n,o){return t("dojo.data.ItemFileWriteStore",n,{constructor:function(e){this._features["dojo.data.api.Write"]=!0,this._features["dojo.data.api.Notification"]=!0,this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},this._datatypeMap.Date.serialize||(this._datatypeMap.Date.serialize=function(e){return o.toISOString(e,{zulu:!0})}),e&&e.referenceIntegrity===!1&&(this.referenceIntegrity=!1),this._saveInProgress=!1},referenceIntegrity:!0,_assert:function(e){if(!e)throw new Error("assertion failed in ItemFileWriteStore")},_getIdentifierAttribute:function(){return this.getFeatures()["dojo.data.api.Identity"]},newItem:function(t,i){if(this._assert(!this._saveInProgress),this._loadFinished||this._forceLoad(),"object"!=typeof t&&"undefined"!=typeof t)throw new Error("newItem() was passed something other than an object");var a=null,r=this._getIdentifierAttribute();if(r===Number)a=this._arrayOfAllItems.length;else{if(a=t[r],"undefined"==typeof a)throw new Error("newItem() was not passed an identity for the new item");if(e.isArray(a))throw new Error("newItem() was not passed an single-valued identity")}this._itemsByIdentity&&this._assert("undefined"==typeof this._itemsByIdentity[a]),this._assert("undefined"==typeof this._pending._newItems[a]),this._assert("undefined"==typeof this._pending._deletedItems[a]);var n={};n[this._storeRefPropName]=this,n[this._itemNumPropName]=this._arrayOfAllItems.length,this._itemsByIdentity&&(this._itemsByIdentity[a]=n,n[r]=[a]),this._arrayOfAllItems.push(n);var o=null;if(i&&i.parent&&i.attribute){o={item:i.parent,attribute:i.attribute,oldValue:void 0};var d=this.getValues(i.parent,i.attribute);if(d&&d.length>0){var s=d.slice(0,d.length);1===d.length?o.oldValue=d[0]:o.oldValue=d.slice(0,d.length),s.push(n),this._setValueOrValues(i.parent,i.attribute,s,!1),o.newValue=this.getValues(i.parent,i.attribute)}else this._setValueOrValues(i.parent,i.attribute,n,!1),o.newValue=n}else n[this._rootItemPropName]=!0,this._arrayOfTopLevelItems.push(n);this._pending._newItems[a]=n;for(var l in t){if(l===this._storeRefPropName||l===this._itemNumPropName)throw new Error("encountered bug in ItemFileWriteStore.newItem");var u=t[l];if(e.isArray(u)||(u=[u]),n[l]=u,this.referenceIntegrity)for(var f=0;f<u.length;f++){var c=u[f];this.isItem(c)&&this._addReferenceToMap(c,n,l)}}return this.onNew(n,o),n},_removeArrayElement:function(e,t){var a=i.indexOf(e,t);return-1!=a?(e.splice(a,1),!0):!1},deleteItem:function(t){this._assert(!this._saveInProgress),this._assertIsItem(t);var a=t[this._itemNumPropName],r=this.getIdentity(t);if(this.referenceIntegrity){var n=this.getAttributes(t);t[this._reverseRefMap]&&(t["backup_"+this._reverseRefMap]=e.clone(t[this._reverseRefMap])),i.forEach(n,function(e){i.forEach(this.getValues(t,e),function(i){this.isItem(i)&&(t["backupRefs_"+this._reverseRefMap]||(t["backupRefs_"+this._reverseRefMap]=[]),t["backupRefs_"+this._reverseRefMap].push({id:this.getIdentity(i),attr:e}),this._removeReferenceFromMap(i,t,e))},this)},this);var o=t[this._reverseRefMap];if(o)for(var d in o){var s=null;if(s=this._itemsByIdentity?this._itemsByIdentity[d]:this._arrayOfAllItems[d])for(var l in o[d]){var u=this.getValues(s,l)||[],f=i.filter(u,function(e){return!(this.isItem(e)&&this.getIdentity(e)==r)},this);this._removeReferenceFromMap(t,s,l),f.length<u.length&&this._setValueOrValues(s,l,f,!0)}}}return this._arrayOfAllItems[a]=null,t[this._storeRefPropName]=null,this._itemsByIdentity&&delete this._itemsByIdentity[r],this._pending._deletedItems[r]=t,t[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,t),this.onDelete(t),!0},setValue:function(e,t,i){return this._setValueOrValues(e,t,i,!0)},setValues:function(e,t,i){return this._setValueOrValues(e,t,i,!0)},unsetAttribute:function(e,t){return this._setValueOrValues(e,t,[],!0)},_setValueOrValues:function(t,a,r,n){this._assert(!this._saveInProgress),this._assertIsItem(t),this._assert(e.isString(a)),this._assert("undefined"!=typeof r);var o=this._getIdentifierAttribute();if(a==o)throw new Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");var d=this._getValueOrValues(t,a),s=this.getIdentity(t);if(!this._pending._modifiedItems[s]){var l={};for(var u in t)u===this._storeRefPropName||u===this._itemNumPropName||u===this._rootItemPropName?l[u]=t[u]:u===this._reverseRefMap?l[u]=e.clone(t[u]):l[u]=t[u].slice(0,t[u].length);this._pending._modifiedItems[s]=l}var f=!1;if(e.isArray(r)&&0===r.length){if(f=delete t[a],r=void 0,this.referenceIntegrity&&d){var c=d;e.isArray(c)||(c=[c]);for(var m=0;m<c.length;m++){var h=c[m];this.isItem(h)&&this._removeReferenceFromMap(h,t,a)}}}else{var y;if(y=e.isArray(r)?r.slice(0,r.length):[r],this.referenceIntegrity)if(d){var c=d;e.isArray(c)||(c=[c]);var v={};i.forEach(c,function(e){if(this.isItem(e)){var t=this.getIdentity(e);v[t.toString()]=!0}},this),i.forEach(y,function(e){if(this.isItem(e)){var i=this.getIdentity(e);v[i.toString()]?delete v[i.toString()]:this._addReferenceToMap(e,t,a)}},this);for(var p in v){var g;g=this._itemsByIdentity?this._itemsByIdentity[p]:this._arrayOfAllItems[p],this._removeReferenceFromMap(g,t,a)}}else for(var m=0;m<y.length;m++){var h=y[m];this.isItem(h)&&this._addReferenceToMap(h,t,a)}t[a]=y,f=!0}return n&&this.onSet(t,a,d,r),f},_addReferenceToMap:function(e,t,i){var a=this.getIdentity(t),r=e[this._reverseRefMap];r||(r=e[this._reverseRefMap]={});var n=r[a];n||(n=r[a]={}),n[i]=!0},_removeReferenceFromMap:function(e,t,i){var a,r=this.getIdentity(t),n=e[this._reverseRefMap];if(n){for(a in n)a==r&&(delete n[a][i],this._isEmpty(n[a])&&delete n[a]);this._isEmpty(n)&&delete e[this._reverseRefMap]}},_dumpReferenceMap:function(){var e;for(e=0;e<this._arrayOfAllItems.length;e++){var t=this._arrayOfAllItems[e];t&&t[this._reverseRefMap]}},_getValueOrValues:function(e,t){var i=void 0;if(this.hasAttribute(e,t)){var a=this.getValues(e,t);i=1==a.length?a[0]:a}return i},_flatten:function(t){if(this.isItem(t))return{_reference:this.getIdentity(t)};if("object"==typeof t)for(var i in this._datatypeMap){var a=this._datatypeMap[i];if(e.isObject(a)&&!e.isFunction(a)){if(t instanceof a.type){if(!a.serialize)throw new Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+i+"]");return{_type:i,_value:a.serialize(t)}}}else if(t instanceof a)return{_type:i,_value:t.toString()}}return t},_getNewFileContentString:function(){var e={},t=this._getIdentifierAttribute();t!==Number&&(e.identifier=t),this._labelAttr&&(e.label=this._labelAttr),e.items=[];for(var i=0;i<this._arrayOfAllItems.length;++i){var r=this._arrayOfAllItems[i];if(null!==r){var n={};for(var o in r)if(o!==this._storeRefPropName&&o!==this._itemNumPropName&&o!==this._reverseRefMap&&o!==this._rootItemPropName){var d=this.getValues(r,o);if(1==d.length)n[o]=this._flatten(d[0]);else for(var s=[],l=0;l<d.length;++l)s.push(this._flatten(d[l])),n[o]=s}e.items.push(n)}}var u=!0;return a.toJson(e,u)},_isEmpty:function(t){var i=!0;if(e.isObject(t)){var a;for(a in t){i=!1;break}}else e.isArray(t)&&t.length>0&&(i=!1);return i},save:function(e){this._assert(!this._saveInProgress),this._saveInProgress=!0;var t=this,i=function(){if(t._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},t._saveInProgress=!1,e&&e.onComplete){var i=e.scope||r.global;e.onComplete.call(i)}},a=function(i){if(t._saveInProgress=!1,e&&e.onError){var a=e.scope||r.global;e.onError.call(a,i)}};if(this._saveEverything){var n=this._getNewFileContentString();this._saveEverything(i,a,n)}this._saveCustom&&this._saveCustom(i,a),this._saveEverything||this._saveCustom||i()},revert:function(){this._assert(!this._saveInProgress);var t;for(t in this._pending._modifiedItems){var a=this._pending._modifiedItems[t],r=null;r=this._itemsByIdentity?this._itemsByIdentity[t]:this._arrayOfAllItems[t],a[this._storeRefPropName]=this;for(var n in r)delete r[n];e.mixin(r,a)}var o;for(t in this._pending._deletedItems){o=this._pending._deletedItems[t],o[this._storeRefPropName]=this;var d=o[this._itemNumPropName];o["backup_"+this._reverseRefMap]&&(o[this._reverseRefMap]=o["backup_"+this._reverseRefMap],delete o["backup_"+this._reverseRefMap]),this._arrayOfAllItems[d]=o,this._itemsByIdentity&&(this._itemsByIdentity[t]=o),o[this._rootItemPropName]&&this._arrayOfTopLevelItems.push(o)}for(t in this._pending._deletedItems)o=this._pending._deletedItems[t],o["backupRefs_"+this._reverseRefMap]&&(i.forEach(o["backupRefs_"+this._reverseRefMap],function(e){var t;t=this._itemsByIdentity?this._itemsByIdentity[e.id]:this._arrayOfAllItems[e.id],this._addReferenceToMap(t,o,e.attr)},this),delete o["backupRefs_"+this._reverseRefMap]);for(t in this._pending._newItems){var s=this._pending._newItems[t];s[this._storeRefPropName]=null,this._arrayOfAllItems[s[this._itemNumPropName]]=null,s[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,s),this._itemsByIdentity&&delete this._itemsByIdentity[t]}return this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},!0},isDirty:function(e){if(e){var t=this.getIdentity(e);return new Boolean(this._pending._newItems[t]||this._pending._modifiedItems[t]||this._pending._deletedItems[t]).valueOf()}return!this._isEmpty(this._pending._newItems)||!this._isEmpty(this._pending._modifiedItems)||!this._isEmpty(this._pending._deletedItems)},onSet:function(e,t,i,a){},onNew:function(e,t){},onDelete:function(e){},close:function(e){if(this.clearOnClose){if(this.isDirty())throw new Error("dojo.data.ItemFileWriteStore: There are unsaved changes present in the store.  Please save or revert the changes before invoking close.");this.inherited(arguments)}}})});//# sourceMappingURL=ItemFileWriteStore.js.map