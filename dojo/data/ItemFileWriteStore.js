//>>built
define("dojo/data/ItemFileWriteStore",["../_base/lang","../_base/declare","../_base/array","../_base/json","../_base/kernel","./ItemFileReadStore","../date/stamp"],function(e,t,a,i,r,d,o){return t("dojo.data.ItemFileWriteStore",d,{constructor:function(e){this._features["dojo.data.api.Write"]=!0,this._features["dojo.data.api.Notification"]=!0,this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},this._datatypeMap.Date.serialize||(this._datatypeMap.Date.serialize=function(e){return o.toISOString(e,{zulu:!0})}),e&&e.referenceIntegrity===!1&&(this.referenceIntegrity=!1),this._saveInProgress=!1},referenceIntegrity:!0,_assert:function(e){if(!e)throw new Error("assertion failed in ItemFileWriteStore")},_getIdentifierAttribute:function(){return this.getFeatures()["dojo.data.api.Identity"]},newItem:function(t,a){if(this._assert(!this._saveInProgress),this._loadFinished||this._forceLoad(),"object"!=typeof t&&"undefined"!=typeof t)throw new Error("newItem() was passed something other than an object");var i=null,r=this._getIdentifierAttribute();if(r===Number)i=this._arrayOfAllItems.length;else{if(i=t[r],"undefined"==typeof i)throw new Error("newItem() was not passed an identity for the new item");if(e.isArray(i))throw new Error("newItem() was not passed an single-valued identity")}this._itemsByIdentity&&this._assert("undefined"==typeof this._itemsByIdentity[i]),this._assert("undefined"==typeof this._pending._newItems[i]),this._assert("undefined"==typeof this._pending._deletedItems[i]);var d={};d[this._storeRefPropName]=this,d[this._itemNumPropName]=this._arrayOfAllItems.length,this._itemsByIdentity&&(this._itemsByIdentity[i]=d,d[r]=[i]),this._arrayOfAllItems.push(d);var o=null;if(a&&a.parent&&a.attribute){o={item:a.parent,attribute:a.attribute,oldValue:void 0};var n=this.getValues(a.parent,a.attribute);if(n&&n.length>0){var l=n.slice(0,n.length);1===n.length?o.oldValue=n[0]:o.oldValue=n.slice(0,n.length),l.push(d),this._setValueOrValues(a.parent,a.attribute,l,!1),o.newValue=this.getValues(a.parent,a.attribute)}else this._setValueOrValues(a.parent,a.attribute,d,!1),o.newValue=d}else d[this._rootItemPropName]=!0,this._arrayOfTopLevelItems.push(d);this._pending._newItems[i]=d;for(var s in t){if(s===this._storeRefPropName||s===this._itemNumPropName)throw new Error("encountered bug in ItemFileWriteStore.newItem");var m=t[s];if(e.isArray(m)||(m=[m]),d[s]=m,this.referenceIntegrity)for(var f=0;f<m.length;f++){var u=m[f];this.isItem(u)&&this._addReferenceToMap(u,d,s)}}return this.onNew(d,o),d},_removeArrayElement:function(e,t){var i=a.indexOf(e,t);return-1!=i?(e.splice(i,1),!0):!1},deleteItem:function(t){this._assert(!this._saveInProgress),this._assertIsItem(t);var i=t[this._itemNumPropName],r=this.getIdentity(t);if(this.referenceIntegrity){var d=this.getAttributes(t);t[this._reverseRefMap]&&(t["backup_"+this._reverseRefMap]=e.clone(t[this._reverseRefMap])),a.forEach(d,function(e){a.forEach(this.getValues(t,e),function(a){this.isItem(a)&&(t["backupRefs_"+this._reverseRefMap]||(t["backupRefs_"+this._reverseRefMap]=[]),t["backupRefs_"+this._reverseRefMap].push({id:this.getIdentity(a),attr:e}),this._removeReferenceFromMap(a,t,e))},this)},this);var o=t[this._reverseRefMap];if(o)for(var n in o){var l=null;if(l=this._itemsByIdentity?this._itemsByIdentity[n]:this._arrayOfAllItems[n])for(var s in o[n]){var m=this.getValues(l,s)||[],f=a.filter(m,function(e){return!(this.isItem(e)&&this.getIdentity(e)==r)},this);this._removeReferenceFromMap(t,l,s),f.length<m.length&&this._setValueOrValues(l,s,f,!0)}}}return this._arrayOfAllItems[i]=null,t[this._storeRefPropName]=null,this._itemsByIdentity&&delete this._itemsByIdentity[r],this._pending._deletedItems[r]=t,t[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,t),this.onDelete(t),!0},setValue:function(e,t,a){return this._setValueOrValues(e,t,a,!0)},setValues:function(e,t,a){return this._setValueOrValues(e,t,a,!0)},unsetAttribute:function(e,t){return this._setValueOrValues(e,t,[],!0)},_setValueOrValues:function(t,i,r,d){this._assert(!this._saveInProgress),this._assertIsItem(t),this._assert(e.isString(i)),this._assert("undefined"!=typeof r);var o=this._getIdentifierAttribute();if(i==o)throw new Error("ItemFileWriteStore does not have support for changing the value of an item's identifier.");var n=this._getValueOrValues(t,i),l=this.getIdentity(t);if(!this._pending._modifiedItems[l]){var s={};for(var m in t)m===this._storeRefPropName||m===this._itemNumPropName||m===this._rootItemPropName?s[m]=t[m]:m===this._reverseRefMap?s[m]=e.clone(t[m]):s[m]=t[m].slice(0,t[m].length);this._pending._modifiedItems[l]=s}var f=!1;if(e.isArray(r)&&0===r.length){if(f=delete t[i],r=void 0,this.referenceIntegrity&&n){var u=n;e.isArray(u)||(u=[u]);for(var h=0;h<u.length;h++){var y=u[h];this.isItem(y)&&this._removeReferenceFromMap(y,t,i)}}}else{var c;if(c=e.isArray(r)?r.slice(0,r.length):[r],this.referenceIntegrity)if(n){var u=n;e.isArray(u)||(u=[u]);var M={};a.forEach(u,function(e){if(this.isItem(e)){var t=this.getIdentity(e);M[t.toString()]=!0}},this),a.forEach(c,function(e){if(this.isItem(e)){var a=this.getIdentity(e);M[a.toString()]?delete M[a.toString()]:this._addReferenceToMap(e,t,i)}},this);for(var v in M){var p;p=this._itemsByIdentity?this._itemsByIdentity[v]:this._arrayOfAllItems[v],this._removeReferenceFromMap(p,t,i)}}else for(var h=0;h<c.length;h++){var y=c[h];this.isItem(y)&&this._addReferenceToMap(y,t,i)}t[i]=c,f=!0}return d&&this.onSet(t,i,n,r),f},_addReferenceToMap:function(e,t,a){var i=this.getIdentity(t),r=e[this._reverseRefMap];r||(r=e[this._reverseRefMap]={});var d=r[i];d||(d=r[i]={}),d[a]=!0},_removeReferenceFromMap:function(e,t,a){var i,r=this.getIdentity(t),d=e[this._reverseRefMap];if(d){for(i in d)i==r&&(delete d[i][a],this._isEmpty(d[i])&&delete d[i]);this._isEmpty(d)&&delete e[this._reverseRefMap]}},_dumpReferenceMap:function(){var e;for(e=0;e<this._arrayOfAllItems.length;e++){var t=this._arrayOfAllItems[e];t&&t[this._reverseRefMap]}},_getValueOrValues:function(e,t){var a=void 0;if(this.hasAttribute(e,t)){var i=this.getValues(e,t);a=1==i.length?i[0]:i}return a},_flatten:function(t){if(this.isItem(t))return{_reference:this.getIdentity(t)};if("object"==typeof t)for(var a in this._datatypeMap){var i=this._datatypeMap[a];if(e.isObject(i)&&!e.isFunction(i)){if(t instanceof i.type){if(!i.serialize)throw new Error("ItemFileWriteStore:  No serializer defined for type mapping: ["+a+"]");return{_type:a,_value:i.serialize(t)}}}else if(t instanceof i)return{_type:a,_value:t.toString()}}return t},_getNewFileContentString:function(){var e={},t=this._getIdentifierAttribute();t!==Number&&(e.identifier=t),this._labelAttr&&(e.label=this._labelAttr),e.items=[];for(var a=0;a<this._arrayOfAllItems.length;++a){var r=this._arrayOfAllItems[a];if(null!==r){var d={};for(var o in r)if(o!==this._storeRefPropName&&o!==this._itemNumPropName&&o!==this._reverseRefMap&&o!==this._rootItemPropName){var n=this.getValues(r,o);if(1==n.length)d[o]=this._flatten(n[0]);else for(var l=[],s=0;s<n.length;++s)l.push(this._flatten(n[s])),d[o]=l}e.items.push(d)}}var m=!0;return i.toJson(e,m)},_isEmpty:function(t){var a=!0;if(e.isObject(t)){var i;for(i in t){a=!1;break}}else e.isArray(t)&&t.length>0&&(a=!1);return a},save:function(e){this._assert(!this._saveInProgress),this._saveInProgress=!0;var t=this,a=function(){if(t._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},t._saveInProgress=!1,e&&e.onComplete){var a=e.scope||r.global;e.onComplete.call(a)}},i=function(a){if(t._saveInProgress=!1,e&&e.onError){var i=e.scope||r.global;e.onError.call(i,a)}};if(this._saveEverything){var d=this._getNewFileContentString();this._saveEverything(a,i,d)}this._saveCustom&&this._saveCustom(a,i),this._saveEverything||this._saveCustom||a()},revert:function(){this._assert(!this._saveInProgress);var t;for(t in this._pending._modifiedItems){var i=this._pending._modifiedItems[t],r=null;r=this._itemsByIdentity?this._itemsByIdentity[t]:this._arrayOfAllItems[t],i[this._storeRefPropName]=this;for(var d in r)delete r[d];e.mixin(r,i)}var o;for(t in this._pending._deletedItems){o=this._pending._deletedItems[t],o[this._storeRefPropName]=this;var n=o[this._itemNumPropName];o["backup_"+this._reverseRefMap]&&(o[this._reverseRefMap]=o["backup_"+this._reverseRefMap],delete o["backup_"+this._reverseRefMap]),this._arrayOfAllItems[n]=o,this._itemsByIdentity&&(this._itemsByIdentity[t]=o),o[this._rootItemPropName]&&this._arrayOfTopLevelItems.push(o)}for(t in this._pending._deletedItems)o=this._pending._deletedItems[t],o["backupRefs_"+this._reverseRefMap]&&(a.forEach(o["backupRefs_"+this._reverseRefMap],function(e){var t;t=this._itemsByIdentity?this._itemsByIdentity[e.id]:this._arrayOfAllItems[e.id],this._addReferenceToMap(t,o,e.attr)},this),delete o["backupRefs_"+this._reverseRefMap]);for(t in this._pending._newItems){var l=this._pending._newItems[t];l[this._storeRefPropName]=null,this._arrayOfAllItems[l[this._itemNumPropName]]=null,l[this._rootItemPropName]&&this._removeArrayElement(this._arrayOfTopLevelItems,l),this._itemsByIdentity&&delete this._itemsByIdentity[t]}return this._pending={_newItems:{},_modifiedItems:{},_deletedItems:{}},!0},isDirty:function(e){if(e){var t=this.getIdentity(e);return new Boolean(this._pending._newItems[t]||this._pending._modifiedItems[t]||this._pending._deletedItems[t]).valueOf()}return!this._isEmpty(this._pending._newItems)||!this._isEmpty(this._pending._modifiedItems)||!this._isEmpty(this._pending._deletedItems)},onSet:function(e,t,a,i){},onNew:function(e,t){},onDelete:function(e){},close:function(e){if(this.clearOnClose){if(this.isDirty())throw new Error("dojo.data.ItemFileWriteStore: There are unsaved changes present in the store.  Please save or revert the changes before invoking close.");this.inherited(arguments)}}})});//# sourceMappingURL=ItemFileWriteStore.js.map