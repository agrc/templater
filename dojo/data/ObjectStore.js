//>>built
define("dojo/data/ObjectStore",["../_base/lang","../Evented","../_base/declare","../_base/Deferred","../_base/array","../_base/connect","../regexp"],function(e,t,a,i,r,o,n){function d(e){return"*"==e?".*":"?"==e?".":e}return a("dojo.data.ObjectStore",[t],{objectStore:null,constructor:function(t){this._dirtyObjects=[],t.labelAttribute&&(t.labelProperty=t.labelAttribute),e.mixin(this,t)},labelProperty:"label",getValue:function(e,t,a){return"function"==typeof e.get?e.get(t):t in e?e[t]:a},getValues:function(e,t){var a=this.getValue(e,t);return a instanceof Array?a:void 0===a?[]:[a]},getAttributes:function(e){var t=[];for(var a in e)!e.hasOwnProperty(a)||"_"==a.charAt(0)&&"_"==a.charAt(1)||t.push(a);return t},hasAttribute:function(e,t){return t in e},containsValue:function(e,t,a){return r.indexOf(this.getValues(e,t),a)>-1},isItem:function(e){return"object"==typeof e&&e&&!(e instanceof Date)},isItemLoaded:function(e){return e&&"function"!=typeof e.load},loadItem:function(e){var t;return"function"==typeof e.item.load?i.when(e.item.load(),function(a){t=a;var i=a instanceof Error?e.onError:e.onItem;i&&i.call(e.scope,a)}):e.onItem&&e.onItem.call(e.scope,e.item),t},close:function(e){return e&&e.abort&&e.abort()},fetch:function(t){function a(e){t.onError&&t.onError.call(s,e,t)}t=e.delegate(t,t&&t.queryOptions);var o=this,s=t.scope||o,l=t.query;if("object"==typeof l){l=e.delegate(l);for(var u in l){var m=l[u];"string"==typeof m&&(l[u]=RegExp("^"+n.escapeString(m,"*?\\").replace(/\\.|\*|\?/g,d)+"$",t.ignoreCase?"mi":"m"),l[u].toString=function(e){return function(){return e}}(m))}}var f=this.objectStore.query(l,t);return i.when(f.total,function(e){i.when(f,function(a){if(t.onBegin&&t.onBegin.call(s,e||a.length,t),t.onItem)for(var i=0;i<a.length;i++)t.onItem.call(s,a[i],t);return t.onComplete&&t.onComplete.call(s,t.onItem?null:a,t),a},a)},a),t.abort=function(){f.cancel&&f.cancel()},f.observe&&(this.observing&&this.observing.cancel(),this.observing=f.observe(function(e,t,a){if(-1==r.indexOf(o._dirtyObjects,e))if(-1==t)o.onNew(e);else if(-1==a)o.onDelete(e);else for(var i in e)i!=o.objectStore.idProperty&&o.onSet(e,i,null,e[i])},!0)),this.onFetch(f),t.store=this,t},getFeatures:function(){return{"dojo.data.api.Read":!!this.objectStore.get,"dojo.data.api.Identity":!0,"dojo.data.api.Write":!!this.objectStore.put,"dojo.data.api.Notification":!0}},getLabel:function(e){return this.isItem(e)?this.getValue(e,this.labelProperty):void 0},getLabelAttributes:function(e){return[this.labelProperty]},getIdentity:function(e){return this.objectStore.getIdentity?this.objectStore.getIdentity(e):e[this.objectStore.idProperty||"id"]},getIdentityAttributes:function(e){return[this.objectStore.idProperty]},fetchItemByIdentity:function(e){var t;return i.when(this.objectStore.get(e.identity),function(a){t=a,e.onItem.call(e.scope,a)},function(t){e.onError.call(e.scope,t)}),t},newItem:function(e,t){if(t){var a=this.getValue(t.parent,t.attribute,[]);a=a.concat([e]),e.__parent=a,this.setValue(t.parent,t.attribute,a)}return this._dirtyObjects.push({object:e,save:!0}),this.onNew(e),e},deleteItem:function(e){this.changing(e,!0),this.onDelete(e)},setValue:function(e,t,a){var i=e[t];this.changing(e),e[t]=a,this.onSet(e,t,i,a)},setValues:function(t,a,i){if(!e.isArray(i))throw new Error("setValues expects to be passed an Array object as its value");this.setValue(t,a,i)},unsetAttribute:function(e,t){this.changing(e);var a=e[t];delete e[t],this.onSet(e,t,a,void 0)},changing:function(e,t){e.__isDirty=!0;for(var a=0;a<this._dirtyObjects.length;a++){var i=this._dirtyObjects[a];if(e==i.object)return void(t&&(i.object=!1,this._saveNotNeeded||(i.save=!0)))}var r=e instanceof Array?[]:{};for(a in e)e.hasOwnProperty(a)&&(r[a]=e[a]);this._dirtyObjects.push({object:!t&&e,old:r,save:!this._saveNotNeeded})},save:function(e){e=e||{};var t,a=[],r=[],n=this,d=this._dirtyObjects,s=d.length;try{if(o.connect(e,"onError",function(){if(e.revertOnError!==!1){var t=d;d=r,n.revert(),n._dirtyObjects=t}else n._dirtyObjects=d.concat(r)}),this.objectStore.transaction)var l=this.objectStore.transaction();for(var u=0;u<d.length;u++){var m=d[u],f=m.object,c=m.old;delete f.__isDirty,f?t=this.objectStore.put(f,{overwrite:!!c}):"undefined"!=typeof c&&(t=this.objectStore.remove(this.getIdentity(c))),r.push(m),d.splice(u--,1),i.when(t,function(t){--s||e.onComplete&&e.onComplete.call(e.scope,a)},function(t){s=-1,e.onError.call(e.scope,t)})}l&&l.commit()}catch(h){e.onError.call(e.scope,value)}},revert:function(){for(var e=this._dirtyObjects,t=e.length;t>0;){t--;var a=e[t],i=a.object,r=a.old;if(i&&r){for(var o in r)r.hasOwnProperty(o)&&i[o]!==r[o]&&(this.onSet(i,o,i[o],r[o]),i[o]=r[o]);for(o in i)r.hasOwnProperty(o)||(this.onSet(i,o,i[o]),delete i[o])}else r?this.onNew(r):this.onDelete(i);delete(i||r).__isDirty,e.splice(t,1)}},isDirty:function(e){return e?e.__isDirty:!!this._dirtyObjects.length},onSet:function(){},onNew:function(){},onDelete:function(){},onFetch:function(e){}})});//# sourceMappingURL=ObjectStore.js.map