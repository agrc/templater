//>>built
define("dojo/data/ObjectStore",["../_base/lang","../Evented","../_base/declare","../_base/Deferred","../_base/array","../_base/connect","../regexp"],function(e,t,i,a,r,o,n){function d(e){return"*"==e?".*":"?"==e?".":e}return i("dojo.data.ObjectStore",[t],{objectStore:null,constructor:function(t){this._dirtyObjects=[],t.labelAttribute&&(t.labelProperty=t.labelAttribute),e.mixin(this,t)},labelProperty:"label",getValue:function(e,t,i){return"function"==typeof e.get?e.get(t):t in e?e[t]:i},getValues:function(e,t){var i=this.getValue(e,t);return i instanceof Array?i:void 0===i?[]:[i]},getAttributes:function(e){var t=[];for(var i in e)!e.hasOwnProperty(i)||"_"==i.charAt(0)&&"_"==i.charAt(1)||t.push(i);return t},hasAttribute:function(e,t){return t in e},containsValue:function(e,t,i){return r.indexOf(this.getValues(e,t),i)>-1},isItem:function(e){return"object"==typeof e&&e&&!(e instanceof Date)},isItemLoaded:function(e){return e&&"function"!=typeof e.load},loadItem:function(e){var t;return"function"==typeof e.item.load?a.when(e.item.load(),function(i){t=i;var a=i instanceof Error?e.onError:e.onItem;a&&a.call(e.scope,i)}):e.onItem&&e.onItem.call(e.scope,e.item),t},close:function(e){return e&&e.abort&&e.abort()},fetch:function(t){function i(e){t.onError&&t.onError.call(s,e,t)}t=e.delegate(t,t&&t.queryOptions);var o=this,s=t.scope||o,l=t.query;if("object"==typeof l){l=e.delegate(l);for(var u in l){var f=l[u];"string"==typeof f&&(l[u]=RegExp("^"+n.escapeString(f,"*?\\").replace(/\\.|\*|\?/g,d)+"$",t.ignoreCase?"mi":"m"),l[u].toString=function(e){return function(){return e}}(f))}}var c=this.objectStore.query(l,t);return a.when(c.total,function(e){a.when(c,function(i){if(t.onBegin&&t.onBegin.call(s,e||i.length,t),t.onItem)for(var a=0;a<i.length;a++)t.onItem.call(s,i[a],t);return t.onComplete&&t.onComplete.call(s,t.onItem?null:i,t),i},i)},i),t.abort=function(){c.cancel&&c.cancel()},c.observe&&(this.observing&&this.observing.cancel(),this.observing=c.observe(function(e,t,i){if(-1==r.indexOf(o._dirtyObjects,e))if(-1==t)o.onNew(e);else if(-1==i)o.onDelete(e);else for(var a in e)a!=o.objectStore.idProperty&&o.onSet(e,a,null,e[a])},!0)),this.onFetch(c),t.store=this,t},getFeatures:function(){return{"dojo.data.api.Read":!!this.objectStore.get,"dojo.data.api.Identity":!0,"dojo.data.api.Write":!!this.objectStore.put,"dojo.data.api.Notification":!0}},getLabel:function(e){return this.isItem(e)?this.getValue(e,this.labelProperty):void 0},getLabelAttributes:function(e){return[this.labelProperty]},getIdentity:function(e){return this.objectStore.getIdentity?this.objectStore.getIdentity(e):e[this.objectStore.idProperty||"id"]},getIdentityAttributes:function(e){return[this.objectStore.idProperty]},fetchItemByIdentity:function(e){var t;return a.when(this.objectStore.get(e.identity),function(i){t=i,e.onItem.call(e.scope,i)},function(t){e.onError.call(e.scope,t)}),t},newItem:function(e,t){if(t){var i=this.getValue(t.parent,t.attribute,[]);i=i.concat([e]),e.__parent=i,this.setValue(t.parent,t.attribute,i)}return this._dirtyObjects.push({object:e,save:!0}),this.onNew(e),e},deleteItem:function(e){this.changing(e,!0),this.onDelete(e)},setValue:function(e,t,i){var a=e[t];this.changing(e),e[t]=i,this.onSet(e,t,a,i)},setValues:function(t,i,a){if(!e.isArray(a))throw new Error("setValues expects to be passed an Array object as its value");this.setValue(t,i,a)},unsetAttribute:function(e,t){this.changing(e);var i=e[t];delete e[t],this.onSet(e,t,i,void 0)},changing:function(e,t){e.__isDirty=!0;for(var i=0;i<this._dirtyObjects.length;i++){var a=this._dirtyObjects[i];if(e==a.object)return void(t&&(a.object=!1,this._saveNotNeeded||(a.save=!0)))}var r=e instanceof Array?[]:{};for(i in e)e.hasOwnProperty(i)&&(r[i]=e[i]);this._dirtyObjects.push({object:!t&&e,old:r,save:!this._saveNotNeeded})},save:function(e){e=e||{};var t,i=[],r=[],n=this,d=this._dirtyObjects,s=d.length;try{if(o.connect(e,"onError",function(){if(e.revertOnError!==!1){var t=d;d=r,n.revert(),n._dirtyObjects=t}else n._dirtyObjects=d.concat(r)}),this.objectStore.transaction)var l=this.objectStore.transaction();for(var u=0;u<d.length;u++){var f=d[u],c=f.object,m=f.old;delete c.__isDirty,c?t=this.objectStore.put(c,{overwrite:!!m}):"undefined"!=typeof m&&(t=this.objectStore.remove(this.getIdentity(m))),r.push(f),d.splice(u--,1),a.when(t,function(t){--s||e.onComplete&&e.onComplete.call(e.scope,i)},function(t){s=-1,e.onError.call(e.scope,t)})}l&&l.commit()}catch(h){e.onError.call(e.scope,value)}},revert:function(){for(var e=this._dirtyObjects,t=e.length;t>0;){t--;var i=e[t],a=i.object,r=i.old;if(a&&r){for(var o in r)r.hasOwnProperty(o)&&a[o]!==r[o]&&(this.onSet(a,o,a[o],r[o]),a[o]=r[o]);for(o in a)r.hasOwnProperty(o)||(this.onSet(a,o,a[o]),delete a[o])}else r?this.onNew(r):this.onDelete(a);delete(a||r).__isDirty,e.splice(t,1)}},isDirty:function(e){return e?e.__isDirty:!!this._dirtyObjects.length},onSet:function(){},onNew:function(){},onDelete:function(){},onFetch:function(e){}})});//# sourceMappingURL=ObjectStore.js.map