//>>built
define("dojo/data/ObjectStore",["../_base/lang","../Evented","../_base/declare","../_base/Deferred","../_base/array","../_base/connect","../regexp"],function(e,t,a,i,d,r,o){function n(e){return"*"==e?".*":"?"==e?".":e}return a("dojo.data.ObjectStore",[t],{objectStore:null,constructor:function(t){this._dirtyObjects=[],t.labelAttribute&&(t.labelProperty=t.labelAttribute),e.mixin(this,t)},labelProperty:"label",getValue:function(e,t,a){return"function"==typeof e.get?e.get(t):t in e?e[t]:a},getValues:function(e,t){var a=this.getValue(e,t);return a instanceof Array?a:void 0===a?[]:[a]},getAttributes:function(e){var t=[];for(var a in e)!e.hasOwnProperty(a)||"_"==a.charAt(0)&&"_"==a.charAt(1)||t.push(a);return t},hasAttribute:function(e,t){return t in e},containsValue:function(e,t,a){return d.indexOf(this.getValues(e,t),a)>-1},isItem:function(e){return"object"==typeof e&&e&&!(e instanceof Date)},isItemLoaded:function(e){return e&&"function"!=typeof e.load},loadItem:function(e){var t;return"function"==typeof e.item.load?i.when(e.item.load(),function(a){t=a;var i=a instanceof Error?e.onError:e.onItem;i&&i.call(e.scope,a)}):e.onItem&&e.onItem.call(e.scope,e.item),t},close:function(e){return e&&e.abort&&e.abort()},fetch:function(t){function a(e){t.onError&&t.onError.call(l,e,t)}t=e.delegate(t,t&&t.queryOptions);var r=this,l=t.scope||r,s=t.query;if("object"==typeof s){s=e.delegate(s);for(var m in s){var f=s[m];"string"==typeof f&&(s[m]=RegExp("^"+o.escapeString(f,"*?\\").replace(/\\.|\*|\?/g,n)+"$",t.ignoreCase?"mi":"m"),s[m].toString=function(e){return function(){return e}}(f))}}var u=this.objectStore.query(s,t);return i.when(u.total,function(e){i.when(u,function(a){if(t.onBegin&&t.onBegin.call(l,e||a.length,t),t.onItem)for(var i=0;i<a.length;i++)t.onItem.call(l,a[i],t);return t.onComplete&&t.onComplete.call(l,t.onItem?null:a,t),a},a)},a),t.abort=function(){u.cancel&&u.cancel()},u.observe&&(this.observing&&this.observing.cancel(),this.observing=u.observe(function(e,t,a){if(-1==d.indexOf(r._dirtyObjects,e))if(-1==t)r.onNew(e);else if(-1==a)r.onDelete(e);else for(var i in e)i!=r.objectStore.idProperty&&r.onSet(e,i,null,e[i])},!0)),this.onFetch(u),t.store=this,t},getFeatures:function(){return{"dojo.data.api.Read":!!this.objectStore.get,"dojo.data.api.Identity":!0,"dojo.data.api.Write":!!this.objectStore.put,"dojo.data.api.Notification":!0}},getLabel:function(e){return this.isItem(e)?this.getValue(e,this.labelProperty):void 0},getLabelAttributes:function(e){return[this.labelProperty]},getIdentity:function(e){return this.objectStore.getIdentity?this.objectStore.getIdentity(e):e[this.objectStore.idProperty||"id"]},getIdentityAttributes:function(e){return[this.objectStore.idProperty]},fetchItemByIdentity:function(e){var t;return i.when(this.objectStore.get(e.identity),function(a){t=a,e.onItem.call(e.scope,a)},function(t){e.onError.call(e.scope,t)}),t},newItem:function(e,t){if(t){var a=this.getValue(t.parent,t.attribute,[]);a=a.concat([e]),e.__parent=a,this.setValue(t.parent,t.attribute,a)}return this._dirtyObjects.push({object:e,save:!0}),this.onNew(e),e},deleteItem:function(e){this.changing(e,!0),this.onDelete(e)},setValue:function(e,t,a){var i=e[t];this.changing(e),e[t]=a,this.onSet(e,t,i,a)},setValues:function(t,a,i){if(!e.isArray(i))throw new Error("setValues expects to be passed an Array object as its value");this.setValue(t,a,i)},unsetAttribute:function(e,t){this.changing(e);var a=e[t];delete e[t],this.onSet(e,t,a,void 0)},changing:function(e,t){e.__isDirty=!0;for(var a=0;a<this._dirtyObjects.length;a++){var i=this._dirtyObjects[a];if(e==i.object)return void(t&&(i.object=!1,this._saveNotNeeded||(i.save=!0)))}var d=e instanceof Array?[]:{};for(a in e)e.hasOwnProperty(a)&&(d[a]=e[a]);this._dirtyObjects.push({object:!t&&e,old:d,save:!this._saveNotNeeded})},save:function(e){e=e||{};var t,a=[],d=[],o=this,n=this._dirtyObjects,l=n.length;try{if(r.connect(e,"onError",function(){if(e.revertOnError!==!1){var t=n;n=d,o.revert(),o._dirtyObjects=t}else o._dirtyObjects=n.concat(d)}),this.objectStore.transaction)var s=this.objectStore.transaction();for(var m=0;m<n.length;m++){var f=n[m],u=f.object,y=f.old;delete u.__isDirty,u?t=this.objectStore.put(u,{overwrite:!!y}):"undefined"!=typeof y&&(t=this.objectStore.remove(this.getIdentity(y))),d.push(f),n.splice(m--,1),i.when(t,function(t){--l||e.onComplete&&e.onComplete.call(e.scope,a)},function(t){l=-1,e.onError.call(e.scope,t)})}s&&s.commit()}catch(h){e.onError.call(e.scope,value)}},revert:function(){for(var e=this._dirtyObjects,t=e.length;t>0;){t--;var a=e[t],i=a.object,d=a.old;if(i&&d){for(var r in d)d.hasOwnProperty(r)&&i[r]!==d[r]&&(this.onSet(i,r,i[r],d[r]),i[r]=d[r]);for(r in i)d.hasOwnProperty(r)||(this.onSet(i,r,i[r]),delete i[r])}else d?this.onNew(d):this.onDelete(i);delete(i||d).__isDirty,e.splice(t,1)}},isDirty:function(e){return e?e.__isDirty:!!this._dirtyObjects.length},onSet:function(){},onNew:function(){},onDelete:function(){},onFetch:function(e){}})});//# sourceMappingURL=ObjectStore.js.map